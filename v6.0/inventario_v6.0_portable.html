<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E📦%3C/text%3E%3C/svg%3E">
  <title>Inventario Visual PRO v6.0 - Portable</title>
  
  <style>
    /* ======================================
       ESTILOS ESPECÍFICOS v6.0
       Mantiene compatibilidad con v5.4.0
       ====================================== */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         🎨 OPCIÓN B: CORPORATIVO MODERNO (70% serio, 30% amigable)
         Inspirado en: GitHub Enterprise, Stripe Dashboard, Figma
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
      
      /* 🌑 FONDOS - Escala oscura equilibrada (del mockup Figma ajustado) */
      --bg-app: #1c1f26;           /* Fondo aplicación (ligeramente más claro) */
      --bg-primary: #222630;       /* Fondo principal contenido */
      --bg-secondary: #2a2f3a;     /* Tarjetas (inspirado en Figma #363d47 pero -20% saturación) */
      --bg-tertiary: #323844;      /* Hover states */
      --bg-elevated: #3a404c;      /* Modales y dropdowns */
      --bg-input: #262b36;         /* Inputs */
      
      /* 🎨 ACENTOS PRINCIPALES - Desaturados pero NO grises (Figma ajustado) */
      --primary: #5a7a94;          /* Azul corporativo desaturado (Figma #5a8bb4 -15% sat) */
      --primary-light: #6a8aa4;    /* Hover más claro */
      --primary-dark: #4a6a84;     /* Estados activos */
      
      --success: #527a65;          /* Verde oliva corporativo (Figma #4a9d7a -20% sat) */
      --success-light: #628a75;
      --success-dark: #426a55;
      
      --warning: #9a8260;          /* Ámbar mate (Figma ajustado) */
      --warning-light: #aa9270;
      --warning-dark: #8a7250;
      
      --danger: #945a5a;           /* Rojo ladrillo (Figma ajustado) */
      --danger-light: #a46a6a;
      --danger-dark: #844a4a;
      
      --info: #5a7a8a;             /* Azul-gris info */
      --info-light: #6a8a9a;
      --info-dark: #4a6a7a;
      
      /* 🔲 BORDES - Un solo color sutil */
      --border-primary: #3a404a;   /* Borde principal (sutil pero visible) */
      --border-secondary: #2d333d; /* Borde muy sutil (separadores) */
      --border-accent: #4a5565;    /* Borde con énfasis (focus, hover) */
      
      /* 📝 TEXTO - Jerarquía clara (del mockup Figma) */
      --text-primary: #e8ebf0;     /* Títulos (contraste máximo) */
      --text-secondary: #b5bac3;   /* Texto normal */
      --text-tertiary: #868b96;    /* Subtítulos y metadata */
      --text-disabled: #5a5f6a;    /* Deshabilitados */
      
      /* 🎭 SOMBRAS - Sutiles pero presentes (corporativo moderno) */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.15);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2),
                   0 1px 2px rgba(0, 0, 0, 0.12);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.25),
                   0 2px 4px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.3),
                   0 4px 8px rgba(0, 0, 0, 0.2);
      --shadow-xl: 0 16px 32px rgba(0, 0, 0, 0.35),
                   0 8px 16px rgba(0, 0, 0, 0.25);
      
      /* Sombras especiales */
      --shadow-inset: inset 0 2px 4px rgba(0, 0, 0, 0.15);
      --shadow-glow: 0 0 0 3px rgba(90, 122, 148, 0.15);
      
      /* 📐 GEOMETRÍA - Border radius 6px (corporativo moderno) */
      --radius-sm: 4px;            /* Badges pequeños */
      --radius-md: 6px;            /* 🎯 DEFAULT - Botones, inputs, cards */
      --radius-lg: 8px;            /* Modales */
      --radius-xl: 12px;           /* Imágenes */
      --radius-full: 9999px;       /* Avatares */
      
      /* 📏 ESPACIADO - Sistema de 8px */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      
      /* 🔤 TIPOGRAFÍA - Mejorada para legibilidad corporativa */
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
      --font-mono: 'SF Mono', 'Consolas', 'Monaco', monospace;
      
      /* Tamaños de fuente */
      --font-xs: 10px;
      --font-sm: 12px;
      --font-base: 14px;           /* DEFAULT - Texto normal */
      --font-lg: 16px;             /* Títulos pequeños */
      --font-xl: 18px;             /* Títulos medianos */
      --font-2xl: 24px;            /* Títulos grandes */
      
      /* Pesos de fuente */
      --font-normal: 400;
      --font-medium: 500;
      --font-semibold: 600;
      --font-bold: 700;
      
      /* Altura de línea para legibilidad */
      --line-height-tight: 1.25;
      --line-height-normal: 1.5;
      --line-height-relaxed: 1.75;
      
      /* Espaciado de letras */
      --letter-spacing-tight: -0.01em;
      --letter-spacing-normal: 0;
      --letter-spacing-wide: 0.025em;
      --letter-spacing-wider: 0.05em;
      
      /* 🎬 TRANSICIONES */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      
      /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         🔄 ALIASES PARA COMPATIBILIDAD (mantener código existente)
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
      --primary-light: var(--primary-light);
      --primary-dark: var(--primary-dark);
      --secondary: #7a7a7a;
      --success-dark: var(--success-dark);
      --warning-dark: var(--warning-dark);
      --danger-dark: var(--danger-dark);
      --info-dark: var(--info-dark);
      
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      --neomorph-shadow: var(--shadow-sm);
      --neomorph-shadow-sm: var(--shadow-xs);
      --neomorph-shadow-inset: var(--shadow-inset);
      --border-color: var(--border-primary);
      --border-color-light: var(--border-secondary);
      --bg-elevated: var(--bg-elevated);
      --text-muted: var(--text-tertiary);
      --text-disabled: var(--text-disabled);
      --card-bg: var(--bg-secondary);
      --accent-color: var(--primary);
      --accent-hover: var(--primary-light);
    }

    body {
      font-family: var(--font-family);
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-size: var(--font-base);
      line-height: var(--line-height-normal);
      letter-spacing: var(--letter-spacing-normal);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      padding: 0;
    }

    /* Mejora de legibilidad en títulos y headings */
    h1, h2, h3, h4, h5, h6 {
      color: var(--text-primary);
      font-weight: var(--font-semibold);
      line-height: var(--line-height-tight);
      letter-spacing: var(--letter-spacing-tight);
      margin: 0;
    }

    h1 { font-size: var(--font-2xl); }
    h2 { font-size: var(--font-xl); }
    h3 { font-size: var(--font-lg); }

    /* Mejor contraste en texto importante */
    strong, b {
      color: var(--text-primary);
      font-weight: var(--font-semibold);
    }

    /* Labels y metadata más legibles */
    label {
      color: var(--text-secondary);
      font-size: var(--font-sm);
      font-weight: var(--font-medium);
      line-height: var(--line-height-normal);
    }

    /* ━━━━━━━━━━━━━━━ BOTONES CORPORATIVOS MODERNOS ━━━━━━━━━━━━━━━ */
    .btn {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md); /* 🎯 6px consistente */
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-base);
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      text-transform: none; /* Menos "gritón" */
      letter-spacing: 0.3px;
      box-shadow: var(--shadow-xs);
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-xs);
    }

    .btn-success {
      background: var(--success);
      color: white;
      border: none;
    }

    .btn-success:hover {
      background: var(--success-light);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
    }

    .btn-primary:hover {
      background: var(--primary-light);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      border: none;
    }

    .btn-danger:hover {
      background: var(--danger-light);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--border-accent);
    }

    .btn-info {
      background: var(--info);
      color: white;
      border: none;
    }

    .btn-info:hover {
      background: var(--info-light);
    }

    /* Utilities */
    .hidden { display: none !important; }
    .text-muted { color: var(--text-muted); }
    .mt-10 { margin-top: 10px; }
    .mb-20 { margin-bottom: 20px; }

    /* View buttons - Corporativo moderno */
    .view-btns {
      display: flex;
      gap: var(--spacing-xs);
    }

    .view-btn {
      padding: var(--spacing-xs) 12px;
      background: transparent;
      color: var(--text-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-size: 12px;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.3px;
    }

    .view-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--border-accent);
    }

    .view-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Cards grid - 6 columnas ancho completo */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 16px;
      padding: 0;
      width: 100%;
    }

    /* Responsive - Mantener 6 columnas en pantallas grandes */
    @media (min-width: 1920px) {
      .cards-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    @media (max-width: 1919px) {
      .cards-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    @media (max-width: 1600px) {
      .cards-grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    @media (max-width: 1280px) {
      .cards-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 1024px) {
      .cards-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .cards-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      .cards-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Card Hover Effects - Corporativo mate */
    .repuesto-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
      border-color: var(--accent-color);
    }

    .repuesto-card .card-image img:hover {
      transform: scale(1.02);
      transition: transform 0.2s ease;
    }

    /* ━━━━━━━━━━━━━━━ BOTONES DE TARJETA ━━━━━━━━━━━━━━━ */
    .card-btn {
      transition: all var(--transition-fast);
    }

    .card-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .card-btn:active {
      transform: scale(0.98);
    }

    /* Hover específico para botón Editar */
    .card-btn[data-action="edit"]:hover {
      background: var(--bg-tertiary);
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Hover específico para botón Contar */
    .card-btn[data-action="contar"]:hover {
      background: var(--success-light);
      box-shadow: var(--shadow-md);
    }

    /* Hover específico para botón Eliminar */
    .card-btn[data-action="delete"]:hover {
      background: var(--danger);
      color: white;
    }


    /* ━━━━━━━━━━━━━━━ DATOS TÉCNICOS COLAPSABLES ━━━━━━━━━━━━━━━ */
    details[open] summary {
      background: var(--bg-tertiary);
    }

    details[open] summary span:last-child {
      transform: rotate(180deg);
    }

    details summary {
      list-style: none;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    details summary span:last-child {
      transition: transform var(--transition-fast);
    }

    details summary:hover {
      background: var(--bg-tertiary);
    }

    /* LIGHTBOX - Tema Oscuro */
    .lightbox {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .lightbox.active {
      display: flex;
    }

    .lightbox-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    .lightbox-content img,
    .lightbox-content video {
      max-width: 100%;
      max-height: 90vh;
      border-radius: 2px;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 2px;
      font-size: 30px;
      cursor: pointer;
      z-index: 3001;
      transition: all 0.2s;
      font-weight: 300;
      line-height: 1;
    }

    .lightbox-close:hover {
      background: #b91c1c;
      transform: rotate(90deg);
    }

    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      padding: 20px;
      font-size: 30px;
      cursor: pointer;
      border-radius: 2px;
      transition: background 0.2s;
      z-index: 3001;
    }

    .lightbox-nav:hover {
      background: rgba(255,255,255,0.3);
    }

    .lightbox-prev {
      left: 20px;
    }

    .lightbox-next {
      right: 20px;
    }

    .lightbox-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      z-index: 3001;
    }

    /* PAGINACIÓN - Tema Oscuro con controles de vista integrados */
    .pagination-container {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 16px;
      padding: 12px 20px;
      margin: 10px 0;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-primary);
    }

    .pagination-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pagination-center {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    .pagination-right {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
    }

    #paginationTop {
      margin-top: 0;
      margin-bottom: 16px;
    }

    #paginationBottom {
      margin-top: 16px;
      margin-bottom: 0;
    }

    .pagination-btn {
      background: #2d2d2d;
      border: 1px solid #3e3e3e;
      color: #cccccc;
      padding: 8px 16px;
      border-radius: 2px;
      cursor: pointer;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.15s;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--bg-tertiary);
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .pagination-btn.active {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
    }

    .pagination-info {
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 12px;
    }

    .view-label {
      font-size: var(--font-xs);
      font-weight: var(--font-semibold);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: var(--letter-spacing-wider);
      white-space: nowrap;
    }

    /* ESTADÍSTICAS - Gráficos Donut */
    .donut-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 12px;
    }

    .donut-chart {
      position: relative;
      width: 100px;
      height: 100px;
    }

    .donut-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .donut-bg {
      fill: none;
      stroke: var(--bg-tertiary);
      stroke-width: 8;
    }

    .donut-value {
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.8s ease;
    }

    .donut-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .donut-caption {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
    }

    .donut-detail {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
    }

    /* Stats Flow */
    .stats-flow {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin: 20px 0;
    }

    .flow-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .flow-header-icon {
      font-size: 24px;
    }

    .flow-layout {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .flow-node {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      min-width: 150px;
    }

    .flow-node-title {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .flow-node-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .flow-node-sub {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .flow-arrow {
      flex-shrink: 0;
    }

    .flow-branches {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      flex: 1;
    }

    .flow-branch {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      flex: 1;
      min-width: 200px;
    }

    .flow-branch-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .flow-branch-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .flow-branch-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .flow-branch-value {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Toolbar */
    .toolbar {
      background: var(--bg-secondary);
      padding: 16px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: var(--neomorph-shadow);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
      font-size: 1.2rem;
    }

    .search-input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: none;
      border-radius: 12px;
      font-size: var(--font-base);
      font-weight: var(--font-normal);
      line-height: var(--line-height-normal);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-primary);
      color: var(--text-primary);
      box-shadow: var(--neomorph-shadow-inset);
    }

    .search-input:focus {
      outline: none;
      background: var(--bg-secondary);
      box-shadow: var(--neomorph-shadow-inset), 0 0 0 3px rgba(91, 124, 153, 0.3);
    }

    .search-input::placeholder {
      color: var(--text-tertiary);
      font-size: var(--font-sm);
    }

    /* Filters */
    .filters-selects {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 0 20px 10px;
    }

    .filter-select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: var(--font-sm);
      font-weight: var(--font-medium);
      line-height: var(--line-height-normal);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-select:hover {
      border-color: var(--border-color-light);
      background: var(--bg-tertiary);
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 124, 153, 0.2);
    }

    .filter-select option {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: var(--font-sm);
      padding: 8px;
    }

    /* Toggle */
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-primary);
      cursor: pointer;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      display: inline-block;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-tertiary);
      transition: 0.3s;
      border-radius: 24px;
      border: 2px solid var(--border-color);
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: var(--text-secondary);
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--success);
      border-color: var(--success);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(20px);
      background-color: white;
    }

    /* Map canvas */
    #mapCanvas {
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-secondary);
      max-width: 100%;
      width: 100%;
      height: 600px;
    }

    .map-container h2 {
      color: var(--primary);
    }

    /* Barra de progreso backup */
    #backupProgressBar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 9999;
      display: none;
    }

    #backupProgressBar.active {
      display: block;
    }

    .backup-progress-container {
      background: var(--bg-secondary);
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .backup-progress-content {
      max-width: 1200px;
      margin: 0 auto;
    }

    .backup-progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .backup-progress-text {
      font-weight: 600;
      color: var(--primary);
    }

    .backup-progress-percent {
      font-weight: 700;
      color: var(--success);
    }

    .backup-progress-bar-bg {
      height: 6px;
      background: var(--bg-primary);
      border-radius: 3px;
      overflow: hidden;
    }

    .backup-progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Header sticky */
    .sticky-header-container {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: var(--bg-secondary);
      box-shadow: var(--neomorph-shadow-sm);
      margin-bottom: 20px;
    }

    /* Navegación tabs */
    .nav-tabs {
      display: flex;
      gap: 0;
      padding: 0;
      overflow-x: auto;
      background: var(--bg-tertiary);
      border-bottom: 2px solid var(--bg-tertiary);
    }

    .nav-tab {
      flex: 1;
      padding: 14px 20px;
      background: var(--bg-secondary);
      border: none;
      border-radius: 0;
      border-right: 1px solid var(--bg-tertiary);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .nav-tab:last-child {
      border-right: none;
    }

    .nav-tab:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .nav-tab.active {
      background: var(--accent-color);
      color: white;
      border-bottom: 3px solid var(--accent-hover);
    }

    /* Container - Ancho completo */
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0;
      padding: 20px 30px;
    }

    /* Tabs content - Ancho completo */
    .tab-content {
      display: none;
      width: 100%;
      max-width: 100%;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* Botones */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: var(--success-dark);
      transform: translateY(-2px);
      box-shadow: var(--neomorph-shadow-sm);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: var(--gray-400);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-dark);
    }

    /* Toggle switch */
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      display: inline-block;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--gray-300);
      transition: 0.4s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--success);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* View buttons */
    .view-btns {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }

    .view-btn {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s;
    }

    .view-btn.active {
      background: var(--primary);
      color: white;
    }

    .view-btn:hover {
      background: var(--primary-light);
      color: white;
    }

    /* Search box */
    .search-box {
      display: flex;
      align-items: center;
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 8px 12px;
      gap: 8px;
      min-width: 250px;
    }

    .search-icon {
      color: var(--text-muted);
      font-size: 1.2rem;
    }

    .search-input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary);
      outline: none;
      font-size: 0.95rem;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    /* Filtros */
    .filters-selects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .filter-select {
      padding: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Grid de tarjetas */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .cards-grid .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--neomorph-shadow-hover);
    }

    /* Paginación */
    .pagination-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 30px 0;
      flex-wrap: wrap;
    }

    .pagination-controls.hidden {
      display: none;
    }

    /* Lista vacía */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.9);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 30px;
      max-width: 900px;
      width: 100%;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      position: relative;
      border: 1px solid var(--border-color);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border: none;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      z-index: 10;
    }

    .modal-close:hover {
      background: var(--danger-dark);
      transform: rotate(90deg);
    }

    .modal-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 24px;
      padding-right: 50px;
    }

    .modal-form {
      display: grid;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    .form-group label small {
      color: var(--text-muted);
      font-weight: 400;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 124, 153, 0.2);
      background: var(--bg-secondary);
    }

    .form-control::placeholder {
      color: var(--text-muted);
    }

    .form-row-triple {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .form-row-quad {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 80px;
    }

    /* Inputs de archivo - asegurar visibilidad */
    input[type="file"].form-control {
      padding: 8px 12px;
      cursor: pointer;
      background: var(--bg-secondary);
      border: 2px dashed var(--border-color);
      min-height: 44px;
      display: block !important;
      width: 100%;
      font-size: 14px;
      color: var(--text-primary);
    }

    input[type="file"].form-control:hover {
      border-color: var(--primary);
      background: var(--bg-hover);
    }

    input[type="file"].form-control:focus {
      border-style: solid;
    }

    /* Asegurar que el file input tenga el texto visible */
    input[type="file"].form-control::file-selector-button {
      padding: 6px 12px;
      margin-right: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }

    input[type="file"].form-control::file-selector-button:hover {
      background: #6a8fb5;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .form-actions .btn {
      flex: 1;
    }

    /* Estilos responsive */
    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .view-btns {
        margin-left: 0;
        justify-content: center;
      }

      .search-box {
        min-width: 100%;
      }

      .filters-selects {
        grid-template-columns: 1fr;
      }

      .cards-grid {
        grid-template-columns: 1fr;
      }

      .form-row-triple,
      .form-row-quad {
        grid-template-columns: 1fr;
      }

      .modal-content {
        padding: 20px;
      }
    }

    /* =====================================
       ESTILOS JERARQUÍA
       ===================================== */
    .tree-container {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }

    .tree-header-custom {
      padding: 16px;
      background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 1rem;
      line-height: 1.6;
    }

    .tree-header-title {
      font-size: 1.1rem;
      display: block;
      margin-bottom: 8px;
    }

    .jerarquia-search-container {
      margin: 20px 0;
    }

    .jerarquia-search-wrapper {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .jerarquia-search-input {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1rem;
    }

    .jerarquia-search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 124, 153, 0.2);
    }

    .jerarquia-search-clear {
      padding: 12px 20px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .jerarquia-search-clear:hover {
      background: var(--danger-dark);
      transform: translateY(-2px);
    }

    .jerarquia-search-results {
      background: var(--bg-primary);
      border-radius: 8px;
      margin-top: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .jerarquia-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin: 20px 0;
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .toggle-tree-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      white-space: nowrap;
    }

    .filtros-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      flex: 1;
    }

    .filtros-label {
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
    }

    .filtro-select,
    .filtro-select-hidden {
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 180px;
    }

    .filtro-select:focus,
    .filtro-select-hidden:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 124, 153, 0.2);
    }

    .filtro-select-hidden {
      display: none;
    }

    .btn-limpiar-filtros {
      padding: 10px 20px;
      margin-left: auto;
    }

    .jerarquia-counter {
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      white-space: nowrap;
    }

    .filtros-breadcrumb {
      padding: 12px 16px;
      background: var(--bg-primary);
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid var(--primary);
      display: none;
    }

    .filtros-breadcrumb.active {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .breadcrumb-label {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .breadcrumb-path {
      color: var(--primary);
      font-weight: 600;
    }

    #treeContainer {
      margin-top: 20px;
    }

    .tree-node {
      margin: 8px 0;
      transition: all 0.3s;
    }

    .tree-item {
      padding: 10px 12px;
      background: var(--bg-primary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      border: 1px solid var(--border-color);
      margin-bottom: 4px;
    }

    .tree-item:hover {
      background: var(--bg-tertiary);
      border-color: var(--primary);
      transform: translateX(4px);
    }

    .tree-toggle {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-muted);
      border-radius: 4px;
      font-weight: 700;
      transition: transform 0.3s;
      flex-shrink: 0;
    }

    .tree-toggle.expanded {
      transform: rotate(90deg);
      background: var(--primary);
      color: white;
    }

    .tree-children {
      margin-left: 24px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .tree-children.expanded {
      max-height: 5000px;
    }

    .tree-area .tree-item {
      background: linear-gradient(135deg, rgba(91, 124, 153, 0.15) 0%, rgba(122, 154, 184, 0.15) 100%);
      color: var(--primary-light);
      font-size: 1.05rem;
      border-left: 4px solid var(--primary);
    }

    .tree-equipo .tree-item {
      background: var(--bg-primary);
      color: var(--text-secondary);
      border-left: 3px solid var(--border-color);
    }

    .tree-repuesto .tree-item {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      font-weight: 500;
    }

    .tree-repuesto .tree-item:hover {
      background: var(--bg-primary);
      border-color: var(--success);
    }

    /* ====================================
       BOTÓN DE ESTADO DE CONEXIÓN - Corporativo
    ==================================== */
    #connectionBtn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      cursor: default;
      transition: all var(--transition-fast);
    }

    #connectionBtn:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-accent);
    }

    #connectionIcon {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
      transition: all var(--transition-fast);
      box-shadow: 0 0 0 2px rgba(148, 90, 90, 0.2);
    }

    #connectionBtn.connected #connectionIcon {
      background: var(--success);
      box-shadow: 0 0 0 2px rgba(82, 122, 101, 0.2);
    }

    #connectionText {
      font-size: var(--font-sm);
      font-weight: var(--font-semibold);
      color: var(--text-secondary);
      letter-spacing: var(--letter-spacing-wide);
      text-transform: uppercase;
    }

    #connectionBtn.connected #connectionText {
      color: var(--text-primary);
    }

    /* ====================================
       TAB CONFIGURACIÓN - ESTILOS
    ==================================== */
    .config-title {
      font-size: 18px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-primary);
      margin-bottom: 20px;
    }

    .config-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .config-section-title {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-primary);
      margin-bottom: 16px;
    }

    .connection-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 16px;
    }

    .connection-icon {
      width: 40px;
      height: 40px;
      background: #8a5a5a;
      color: white;
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .connection-info {
      flex: 1;
    }

    .connection-text {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .connection-subtext {
      font-size: 9px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .btn-filesystem {
      background: #5a6b7a;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 2px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      width: 100%;
      transition: background 0.2s;
    }

    .btn-filesystem:hover {
      background: #6a7b8a;
    }

    .config-help-text {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 12px;
      line-height: 1.6;
    }

    .config-buttons-grid {
      display: grid;
      gap: 10px;
    }

    .btn-config {
      background: #2d2d30;
      border: 1px solid #5a6b7a;
      color: #d4d4d4;
      padding: 10px 16px;
      border-radius: 2px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-config:hover {
      background: #3d3d40;
      border-color: #6a7b8a;
    }

    /* ====================================
       ACORDEONES Y TARJETAS CONFIG
    ==================================== */
    .config-grid {
      display: grid;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .config-card {
      background: var(--bg-secondary);
      padding: 16px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    .config-section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      margin-bottom: 16px;
      transition: background 0.2s;
      -webkit-user-select: none;
      user-select: none;
    }

    .config-section-header:hover {
      background: rgba(99, 102, 241, 0.1);
    }

    .config-section-header span:first-child {
      font-size: 12px;
      transition: transform 0.3s;
    }

    .config-section-content {
      display: none;
      padding: 12px;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .config-buttons-container {
      display: grid;
      gap: 10px;
      margin-top: 12px;
    }

    .config-btn-mobile,
    .config-btn-full,
    .config-btn-pdf {
      padding: 12px 16px;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .config-btn-mobile {
      background: #4a5568;
      color: white;
    }

    .config-btn-mobile:hover {
      background: #5a6578;
      transform: translateY(-1px);
    }

    .config-btn-full {
      background: var(--primary);
      color: white;
    }

    .config-btn-full:hover {
      background: #5558dd;
      transform: translateY(-1px);
    }

    .config-btn-pdf {
      background: #dc2626;
      color: white;
    }

    .config-btn-pdf:hover {
      background: #ef4444;
      transform: translateY(-1px);
    }

    .backup-structure {
      background: var(--bg-primary);
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
    }

    .backup-structure-title {
      color: var(--text-primary);
      font-size: 14px;
    }

    .backup-structure-path {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.8;
      color: var(--text-secondary);
      margin-top: 8px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .backup-file-name {
      color: #60a5fa;
    }

    /* Clases para estilos dinámicos */
    .stock-badge {
      background: var(--bg-color, #666);
      opacity: 0.95;
      color: #ffffff;
      padding: 3px 8px;
      border-radius: 2px;
      font-size: 10px;
      font-weight: 700;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .stock-cantidad {
      font-size: 28px;
      color: var(--text-color, #fff);
      opacity: 0.95;
      font-weight: 700;
      line-height: 1;
    }

    .dynamic-border {
      border-left: 3px solid var(--border-color, #666);
    }

    .dynamic-bg {
      background: var(--bg-color, transparent);
    }

    .dynamic-color {
      color: var(--text-color, inherit);
    }

    .progress-bar-segment {
      height: 100%;
      transition: width 0.3s ease;
    }

    .marker-line {
      position: absolute;
      top: -2px;
      width: 2px;
      height: 12px;
      z-index: 2;
    }


    .backup-file-hint {
      color: #94a3b8;
      font-size: 11px;
    }

    .backup-file-hint-special {
      color: #fbbf24;
      font-weight: 600;
    }

    .backup-manual-guide {
      margin-top: 12px;
      padding: 12px;
      background: rgba(99, 102, 241, 0.1);
      border-left: 3px solid var(--primary);
      border-radius: 4px;
    }

    .backup-manual-title {
      color: var(--primary);
      font-size: 13px;
    }

    .backup-guide-text {
      color: var(--text-secondary);
      font-size: 11px;
      line-height: 1.6;
    }

    .config-divider {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .config-small-text {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .config-small-text-line-height {
      line-height: 1.7;
    }

    .config-inline-code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 11px;
      color: #60a5fa;
    }

    .config-success-note {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 4px;
      padding: 12px;
      margin-top: 16px;
    }

    .config-btn-warning {
      background: #f59e0b;
      color: white;
    }

    .config-btn-warning:hover {
      background: #fbbf24;
    }

    .config-btn-info {
      background: #3b82f6;
      color: white;
    }

    .config-btn-info:hover {
      background: #60a5fa;
    }

    .config-btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .config-btn-gradient:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      transform: translateY(-1px);
    }

    /* ====================================
       OPTIMIZACIÓN DE IMÁGENES
    ==================================== */
    .optimization-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .optimization-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .optimization-label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .optimization-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .optimization-title {
      font-weight: 600;
      font-size: 13px;
    }

    .optimization-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-left: 26px;
    }

    .optimization-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .optimization-row-label {
      font-size: 12px;
      font-weight: 600;
      min-width: 80px;
    }

    .optimization-select {
      flex: 1;
      font-size: 12px;
    }

    .optimization-hint {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .hidden-file-input {
      display: none;
    }

    /* TAB MAPA - Título */
    .map-title {
      font-size: 18px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-primary);
    }

    /* =====================================
       MULTIMEDIA PREVIEW
       ===================================== */
    .multimedia-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }

    .multimedia-preview-margin {
      margin-top: 12px;
    }

    .multimedia-preview-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid var(--border-color);
      background: var(--bg-secondary);
      aspect-ratio: 1;
    }

    .multimedia-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .multimedia-remove-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(220, 60, 60, 0.95);
      color: white;
      border-radius: 50%;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-weight: 700;
    }

    .multimedia-remove-btn:hover {
      background: rgba(255, 70, 70, 1);
      transform: scale(1.1);
    }

    /* Info debajo de la imagen con tamaños */
    .multimedia-preview-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .multimedia-preview-name {
      color: white;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .multimedia-preview-size {
      display: flex;
      align-items: center;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.9);
    }

    /* Documentos */
    .documents-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .document-list-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      transition: all 0.2s;
    }

    .document-list-item:hover {
      background: var(--bg-hover);
      border-color: var(--primary);
    }

    .document-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .document-name {
      flex: 1;
      font-size: 14px;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .document-size {
      font-size: 12px;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .document-remove-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: rgba(220, 60, 60, 0.9);
      color: white;
      border-radius: 4px;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-weight: 700;
      flex-shrink: 0;
    }

    .document-remove-btn:hover {
      background: rgba(255, 70, 70, 1);
    }

    .form-upload-mode {
      font-size: 11px;
      color: var(--text-secondary);
      background: rgba(59, 130, 246, 0.15);
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .btn-vincular-mapa {
      margin-top: 8px;
    }

    /* Grid para multimedia (imágenes y documentos lado a lado) */
    .form-multimedia-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    @media (max-width: 768px) {
      .form-multimedia-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- Barra de progreso de backup -->
  <div id="backupProgressBar">
    <div class="backup-progress-container">
      <div class="backup-progress-content">
        <div class="backup-progress-header">
          <span class="backup-progress-text">🔄 Procesando...</span>
          <span id="backupProgressPercent" class="backup-progress-percent">0%</span>
        </div>
        <div class="backup-progress-bar-bg">
          <div id="backupProgressFill" class="backup-progress-bar-fill"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Header sticky con navegación -->
  <div class="sticky-header-container">
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="inventario">INVENTARIO</button>
      <button class="nav-tab" data-tab="jerarquia">JERARQUÍA</button>
      <button class="nav-tab" data-tab="mapa">MAPA</button>
      <button class="nav-tab" data-tab="analitica">ESTADÍSTICAS</button>
      <button class="nav-tab" data-tab="valores">VALORES</button>
      <button class="nav-tab" data-tab="configuracion">CONFIGURACIÓN</button>
    </div>
  </div>

  <!-- Contenedor principal -->
  <div class="container">
    
    <!-- TAB INVENTARIO -->
    <div id="inventario" class="tab-content active">
      <div class="toolbar">
        <button class="btn btn-success btn-add-main" onclick="app.openModal('add')">
          <span class="btn-icon">+</span>
          <span class="btn-text">Agregar Repuesto</span>
        </button>
        
        <label class="toggle-label">
          Precio
          <label class="toggle-switch">
            <input type="checkbox" id="togglePrecio" onchange="app.togglePrecio()" title="Mostrar u ocultar columna de precio" aria-label="Alternar visibilidad de precios">
            <span class="toggle-slider"></span>
          </label>
        </label>
        
        <button class="btn btn-secondary hidden" id="btnQuitarFiltros">
          ✖ Quitar Filtros
        </button>
        
        <div id="connectionBtn" class="disconnected" title="Estado de conexión con carpeta de datos">
          <div id="connectionIcon"></div>
          <span id="connectionText">Desconectado</span>
        </div>
        
        <div class="search-box">
          <span class="search-icon">🔍</span>
          <input type="text" class="search-input" id="searchInput" placeholder="Buscar repuestos..." aria-label="Buscar repuestos">
        </div>
      </div>

      <!-- Filtros por dropdowns -->
      <div class="filters-selects">
        <select class="filter-select" id="filterArea" title="Filtrar por área" aria-label="Filtrar por área">
          <option value="">Todas las Áreas</option>
        </select>
        <select class="filter-select" id="filterEquipo" title="Filtrar por equipo" aria-label="Filtrar por equipo">
          <option value="">Todos los Equipos</option>
        </select>
        <select class="filter-select" id="filterTipo" title="Filtrar por tipo" aria-label="Filtrar por tipo">
          <option value="">Todos los Tipos</option>
        </select>
        <select class="filter-select" id="filterStock" title="Filtrar por nivel de stock" aria-label="Filtrar por nivel de stock">
          <option value="">🔍 Ver Todos</option>
          <option value="agotado">🔴 Agotados</option>
          <option value="critico">⚠️ Críticos</option>
          <option value="adecuado">✓ Adecuados</option>
          <option value="optimo">✓✓ Óptimos</option>
        </select>
      </div>

      <!-- Paginación superior (con controles de vista integrados) -->
      <div id="paginationTop" class="pagination-controls hidden"></div>

      <!-- Grid de tarjetas -->
      <div id="cardsGrid" class="cards-grid"></div>

      <!-- Vista de lista (oculta por defecto) -->
      <div id="listView" class="hidden"></div>

      <!-- Paginación inferior -->
      <div id="paginationBottom" class="pagination-controls hidden"></div>
    </div>

    <!-- TAB JERARQUÍA -->
    <div id="jerarquia" class="tab-content">
      <div class="tree-container">
        <div class="tree-header tree-header-custom">
          <strong class="tree-header-title">Estructura Jerárquica:</strong><br>
          � <strong>Planta</strong> (Ej: Aquachile) → 
          📁 <strong>Área</strong> (Ej: Producción) → 
          📁 <strong>Sub-Área</strong> (Ej: Sistema Agua) → 
          📁 <strong>Sistema</strong> (Ej: Bomba BP-01) → 
          📁 <strong>Sub-Sistema</strong> (Ej: Hidráulico) → 
          📁 <strong>Sección</strong> (Ej: Sellado) → 
          📁 <strong>Detalle</strong> (Ej: Fijación) → 
          🔍 <strong>Repuesto</strong>
        </div>
        
        <!-- BUSCADOR RÁPIDO -->
        <div class="jerarquia-search-container">
          <div class="jerarquia-search-wrapper">
            <input 
              type="text" 
              id="searchJerarquia" 
              placeholder="🔍 Buscar niveles o repuestos..." 
              oninput="app.buscarEnJerarquia(this.value)"
              class="form-control jerarquia-search-input"
            />
            <button 
              onclick="document.getElementById('searchJerarquia').value = ''; app.buscarEnJerarquia('');" 
              class="jerarquia-search-clear"
              title="Limpiar búsqueda"
            >✖</button>
          </div>
          <div id="searchResultsJerarquia" class="jerarquia-search-results"></div>
        </div>
        
        <!-- Controles de jerarquía -->
        <div class="jerarquia-controls">
          
          <!-- Botón Expandir/Contraer Todo -->
          <button onclick="app.toggleAllTree()" class="btn btn-secondary toggle-tree-btn">
            <span id="toggleAllIcon">📂</span>
            <span id="toggleAllText">Expandir Todo</span>
          </button>
          
          <!-- Filtros Escalonados -->
          <div class="filtros-wrapper">
            <label class="filtros-label">
              🔍 Filtrar:
            </label>
            
            <!-- Nivel 1: Planta -->
            <select id="filtro_planta" onchange="app.filtrarEscalonado(1, this.value)" class="form-control filtro-select" aria-label="Filtrar por planta" title="Filtrar por planta">
              <option value="">🏭 Todas las plantas</option>
            </select>
            
            <!-- Nivel 2: Área -->
            <select id="filtro_area" onchange="app.filtrarEscalonado(2, this.value)" class="form-control filtro-select-hidden" aria-label="Filtrar por área" title="Filtrar por área">
              <option value="">📁 Todas las áreas</option>
            </select>
            
            <!-- Nivel 3: Sub-Área -->
            <select id="filtro_subarea" onchange="app.filtrarEscalonado(3, this.value)" class="form-control filtro-select-hidden" aria-label="Filtrar por sub-área" title="Filtrar por sub-área">
              <option value="">📁 Todas las sub-áreas</option>
            </select>
            
            <!-- Nivel 4: Sistema -->
            <select id="filtro_sistema" onchange="app.filtrarEscalonado(4, this.value)" class="form-control filtro-select-hidden" aria-label="Filtrar por sistema" title="Filtrar por sistema">
              <option value="">📁 Todos los sistemas</option>
            </select>
            
            <!-- Nivel 5: Sub-Sistema -->
            <select id="filtro_subsistema" onchange="app.filtrarEscalonado(5, this.value)" class="form-control filtro-select-hidden" aria-label="Filtrar por sub-sistema" title="Filtrar por sub-sistema">
              <option value="">📁 Todos los sub-sistemas</option>
            </select>
            
            <!-- Nivel 6: Sección -->
            <select id="filtro_seccion" onchange="app.filtrarEscalonado(6, this.value)" class="form-control filtro-select-hidden" aria-label="Filtrar por sección" title="Filtrar por sección">
              <option value="">📁 Todas las secciones</option>
            </select>
            
            <!-- Nivel 7: Detalle -->
            <select id="filtro_detalle" onchange="app.filtrarEscalonado(7, this.value)" class="form-control filtro-select-hidden" aria-label="Filtrar por detalle" title="Filtrar por detalle">
              <option value="">📁 Todos los detalles</option>
            </select>
            
            <!-- Botón Limpiar Filtros -->
            <button onclick="app.limpiarFiltrosJerarquia()" class="btn btn-secondary btn-limpiar-filtros" id="btnLimpiarFiltros">
              ✖ Limpiar
            </button>
          </div>
          
          <!-- Contador de repuestos visibles -->
          <div id="jerarquiaCounter" class="jerarquia-counter">
            <span id="repuestosVisibles">0</span> repuestos
          </div>
        </div>
        
        <!-- Breadcrumb de Filtros Activos -->
        <div id="filtrosBreadcrumb" class="filtros-breadcrumb">
          <span class="breadcrumb-label">📍 Filtro activo:</span>
          <span id="breadcrumbPath" class="breadcrumb-path"></span>
        </div>
        
        <div id="treeContainer"></div>
      </div>
    </div>

    <!-- TAB MAPA -->
    <div id="mapa" class="tab-content">
      <div class="map-container">
        <h2 class="mb-20 map-title">MAPA DE UBICACIONES</h2>
        
        <!-- Controles del mapa (gestionados por mapController) -->
        <div class="map-controls" id="mapControls">
          <!-- Los botones se generan dinámicamente por mapController -->
        </div>
        
        <!-- Canvas del mapa -->
        <canvas id="mapCanvas"></canvas>
      </div>
    </div>

    <!-- TAB ESTADÍSTICAS (ANALÍTICA) -->
    <div id="analitica" class="tab-content">
      <h2>📊 Estadísticas</h2>
      
      <!-- Grid de estadísticas (generado por core.js) -->
      <div id="statsGrid"></div>
      
      <!-- Detalles adicionales (generado por core.js) -->
      <div id="statsDetails"></div>
    </div>

    <!-- TAB VALORES -->
    <div id="valores" class="tab-content">
      <!-- Contenido generado dinámicamente por renderValores() -->
    </div>

    <!-- TAB CONFIGURACIÓN -->
    <div id="configuracion" class="tab-content">
      <h2 class="config-title">Configuración</h2>
      
      <div class="config-grid">
        <!-- ALMACENAMIENTO -->
        <div id="storage-config-container" class="config-card">
          <div id="storage-config-content"></div>
        </div>

        <!-- EXPORTACIÓN Y REPORTES -->
        <div class="config-card">
          <h3 onclick="toggleConfigSection('export-config')" class="config-section-header">
            <span id="export-config-icon">▶</span>
            <span>📊 Exportación y Reportes</span>
          </h3>
          
          <div id="export-config-content" class="config-section-content">
            <div class="config-buttons-container">
              <button onclick="app.exportJSON()" class="btn config-btn-mobile">
                📱 Exportar JSON
              </button>

              <button onclick="document.getElementById('importFileInput').click()" class="btn btn-primary config-btn-full">
                📥 Importar JSON
              </button>
              <input type="file" id="importFileInput" accept=".json" class="hidden-file-input" onchange="app.importJSON(event)">
            </div>
          </div>
        </div>

        <!-- SISTEMA DE BACKUPS Y RESPALDOS -->
        <div class="config-card">
          <h3 onclick="toggleConfigSection('backup-config')" class="config-section-header">
            <span id="backup-config-icon">▶</span>
            <span>🔄 Sistema de Backups y Respaldos</span>
          </h3>
          
          <div id="backup-config-content" class="config-section-content">
            <!-- Estructura de carpetas -->
            <div class="backup-structure">
              <strong class="backup-structure-title">� Estructura de Backups:</strong><br>
              <div class="backup-structure-path">
                INVENTARIO_STORAGE/<br>
                ├── <strong class="backup-file-name">inventario.json</strong> <span class="backup-file-hint">← Datos principales</span><br>
                ├── <strong class="backup-file-name">mapas.json</strong> <span class="backup-file-hint">← Mapas interactivos</span><br>
                ├── <strong class="backup-file-name">zonas.json</strong> <span class="backup-file-hint">← Áreas del mapa</span><br>
                ├── imagenes/ <span class="backup-file-hint backup-file-hint-special">← Carpeta de imágenes</span><br>
                └── backups/<br>
                &nbsp;&nbsp;&nbsp;&nbsp;└── automaticos/ <span class="backup-file-name">← Backups automáticos (5 últimos)</span>
              </div>
              <div class="backup-manual-guide">
                <strong class="backup-manual-title">💡 Para actualizar manualmente:</strong><br>
                <small class="backup-guide-text">
                  1. Pega el JSON en el archivo correspondiente<br>
                  2. Copia las imágenes a la carpeta imagenes/<br>
                  3. Recarga la app (F5) para ver los cambios<br>
                  4. La app creará un backup automático al guardar
                </small>
              </div>
            </div>
            
            <div class="config-buttons-container">
              <button onclick="app.createBackup?.()" class="btn btn-success config-btn-full">
                💾 Crear Backup Manual Ahora
              </button>
              
              <div class="config-divider">
                <small class="config-small-text">
                  <strong>💡 Respaldo Completo:</strong> Incluye datos + imágenes. Ideal para migrar entre versiones.
                </small>
              </div>
            </div>
            
            <div class="config-success-note">
              <small class="config-small-text config-small-text-line-height">
                <strong>✅ Sistema de Backups con FileSystem:</strong><br>
                • Se crean en la carpeta backups/automaticos/<br>
                • <strong>Incluyen JSON + TODAS las imágenes</strong><br>
                • Se mantienen los últimos 5 backups completos<br>
                • <strong>Restauración:</strong> Datos + Imágenes en un solo paso<br>
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- MODAL AGREGAR/EDITAR REPUESTO (Estructura completa compatible con core.js) -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="app.closeModal()">×</button>
      <div class="modal-title" id="modalTitle">Agregar Repuesto</div>
      
      <form id="repuestoForm" onsubmit="app.saveRepuesto(event)" class="modal-form">
        <input type="hidden" id="repuestoId">
        
        <!-- Fila 1: Códigos (3 columnas) -->
        <div class="form-row-triple">
          <div class="form-group">
            <label>Código SAP: *</label>
            <input type="text" class="form-control" id="codSAP" list="codSAPDatalist" required placeholder="Ej: SAP12345">
            <datalist id="codSAPDatalist">
              <option value="Pendiente">Pendiente</option>
            </datalist>
          </div>
          
          <div class="form-group autocomplete-container">
            <label>Cód. Proveedor:</label>
            <input type="text" class="form-control" id="codProv" autocomplete="off" placeholder="Ej: PROV-001">
            <div class="autocomplete-list" id="autocomplete-codProv"></div>
          </div>
          
          <div class="form-group autocomplete-container">
            <label>Tipo:</label>
            <input type="text" class="form-control" id="tipo" autocomplete="off" placeholder="Ej: Filtro">
            <div class="autocomplete-list" id="autocomplete-tipo"></div>
          </div>
        </div>
        
        <!-- Categoría -->
        <div class="form-group">
          <label>Categoría: *</label>
          <select class="form-control form-categoria-select" id="categoria" required onchange="app.mostrarEjemplosCategoria(this.value)" title="Seleccionar categoría del elemento">
            <option value="">Seleccionar categoría...</option>
            <option value="Repuesto">REPUESTO</option>
            <option value="Insumo">INSUMO</option>
            <option value="Herramienta">HERRAMIENTA</option>
            <option value="EPP">EPP</option>
            <option value="Químico">QUÍMICO</option>
          </select>
          <small id="ejemplosCategoria" class="form-ejemplos-small">
            Selecciona una categoría para ver ejemplos
          </small>
        </div>
        
        <!-- Descripción -->
        <div class="form-group">
          <label>Nombre/Descripción: *</label>
          <input type="text" class="form-control" id="nombre" required placeholder="Descripción detallada del repuesto">
        </div>
        
        <!-- JERARQUÍA/UBICACIÓN (8 Niveles con Cascada) -->
        <div class="ubicaciones-section">
          <div class="ubicaciones-header">
            <h4 class="ubicaciones-title">📍 Jerarquía y Ubicación</h4>
          </div>
          
          <div class="ubicaciones-hint">
            💡 <strong>Sistema jerárquico:</strong> Selecciona desde el nivel más general hasta el más específico.
          </div>
          
          <!-- Grid de 8 niveles jerárquicos -->
          <div class="form-row-quad">
            <div class="form-group">
              <label>N1: Empresa *</label>
              <select class="form-control" id="nivel1" required onchange="app.cargarNivel(2)">
                <option value="">Seleccionar...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>N2: Área *</label>
              <select class="form-control" id="nivel2" required onchange="app.cargarNivel(3)" disabled>
                <option value="">Seleccionar...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>N3: Sub-área</label>
              <select class="form-control" id="nivel3" onchange="app.cargarNivel(4)" disabled>
                <option value="">Seleccionar...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>N4: Sistema/Equipo</label>
              <select class="form-control" id="nivel4" onchange="app.cargarNivel(5)" disabled>
                <option value="">Seleccionar...</option>
              </select>
            </div>
          </div>
          
          <div class="form-row-quad">
            <div class="form-group">
              <label>N5: Sub-sistema</label>
              <select class="form-control" id="nivel5" onchange="app.cargarNivel(6)" disabled>
                <option value="">Seleccionar...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>N6: Sección</label>
              <select class="form-control" id="nivel6" onchange="app.cargarNivel(7)" disabled>
                <option value="">Seleccionar...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>N7: Sub-sección</label>
              <select class="form-control" id="nivel7" onchange="app.cargarNivel(8)" disabled>
                <option value="">Seleccionar...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>N8: Detalles</label>
              <input type="text" class="form-control" id="nivel8" placeholder="Detalles descriptivos específicos..." disabled>
            </div>
          </div>
          
          <button type="button" onclick="app.vincularConMapa()" class="btn btn-secondary btn-vincular-mapa">
            🗺️ Vincular con Área del Mapa
          </button>
        </div>
        
        <!-- Stock y Precio (5 columnas) -->
        <div class="form-stock-grid">
          <div class="form-group">
            <label>Stock Actual: *</label>
            <input type="number" class="form-control" id="cantidad" min="0" required placeholder="0">
          </div>
          
          <div class="form-group">
            <label>Instalados:</label>
            <input type="number" class="form-control" id="cantidadInstalada" min="0" value="0" placeholder="0">
          </div>
          
          <div class="form-group">
            <label>Mínimo: *</label>
            <input type="number" class="form-control" id="minimo" min="0" value="5" required placeholder="5">
          </div>
          
          <div class="form-group">
            <label>Óptimo:</label>
            <input type="number" class="form-control" id="optimo" min="0" value="10" placeholder="10">
          </div>
          
          <div class="form-group precio-info">
            <label>Precio ($):</label>
            <input type="number" class="form-control" id="precio" min="0" step="0.01" value="0" placeholder="0.00">
          </div>
        </div>
        
        <small class="form-hint-small">
          💡 <strong>Instalados:</strong> Cantidad actualmente en uso. <strong>Óptimo:</strong> Cantidad ideal recomendada.
        </small>
        
        <!-- Datos Técnicos -->
        <div class="form-group">
          <label class="form-label-row">
            <span>⚙️ Datos Técnicos Específicos:</span>
            <small class="form-label-optional">(Opcional)</small>
          </label>
          <textarea class="form-control form-textarea-tech" id="datosTecnicos" rows="3" placeholder="Ej: Motor 0.75 kW, 380V, 1400 RPM"></textarea>
        </div>
        
        <!-- Multimedia (Imágenes + Documentos) -->
        <div class="form-multimedia-grid">
          <div class="form-group">
            <label class="form-label-margin">📸 Imágenes</label>
            
            <!-- Opciones de Optimización -->
            <div class="optimization-container">
              <div class="optimization-header">
                <label class="optimization-label">
                  <input type="checkbox" id="optimizarImagenes" checked class="optimization-checkbox">
                  <span class="optimization-title">🔧 Optimizar imágenes (WebP)</span>
                </label>
              </div>
              
              <div id="opcionesOptimizacion" class="optimization-options">
                <div class="optimization-row">
                  <label class="optimization-row-label">Calidad:</label>
                  <select id="calidadOptimizacion" class="form-control optimization-select">
                    <option value="0.95">Máxima (95%) - ~200KB</option>
                    <option value="0.85" selected>Alta (85%) - ~150KB</option>
                    <option value="0.75">Media (75%) - ~100KB</option>
                    <option value="0.65">Baja (65%) - ~70KB</option>
                    <option value="0.50">Mínima (50%) - ~50KB</option>
                  </select>
                </div>
                
                <div class="optimization-row">
                  <label class="optimization-row-label">Ancho máx:</label>
                  <select id="anchoMaximo" class="form-control optimization-select">
                    <option value="1920">1920px (Full HD)</option>
                    <option value="1280">1280px (HD)</option>
                    <option value="800" selected>800px (Óptimo)</option>
                    <option value="640">640px (Compacto)</option>
                  </select>
                </div>
                
                <small class="optimization-hint">
                  💡 La optimización reduce el peso sin pérdida visible de calidad
                </small>
              </div>
            </div>
            
            <input type="file" class="form-control" id="imagenFile" accept="image/*" multiple onchange="app.handleMultimedia(event, 'image')" title="Seleccionar imágenes del repuesto">
            <div id="imagePreview" class="multimedia-preview multimedia-preview-margin"></div>
          </div>
          
          <div class="form-group">
            <label class="form-label-margin">📎 Documentos</label>
            <input type="file" class="form-control" id="documentos" accept=".pdf,.doc,.docx,.xls,.xlsx,video/*" multiple onchange="app.handleMultimedia(event, 'document')" title="Seleccionar documentos y videos">
            <div id="documentsList" class="documents-list"></div>
          </div>
        </div>
        
        <!-- Botones -->
        <div class="form-actions">
          <button type="submit" id="btnGuardarRepuesto" class="btn btn-success btn-save-main">
            <span class="btn-text">💾 Guardar</span>
          </button>
          <button type="button" class="btn btn-secondary btn-cancel-modal" onclick="app.closeModal()">❌ Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- LIGHTBOX para visualizar imágenes -->
  <div class="lightbox" id="lightbox">
    <button class="lightbox-close" onclick="app.closeLightbox()">×</button>
    <button class="lightbox-nav lightbox-prev" onclick="app.lightboxPrev()">‹</button>
    <button class="lightbox-nav lightbox-next" onclick="app.lightboxNext()">›</button>
    <div class="lightbox-content" id="lightboxContent"></div>
    <div class="lightbox-counter" id="lightboxCounter"></div>
  </div>

  <!-- SCRIPTS MODULARES -->
    <script>
// ========================================
// VERSION PORTABLE v6.0
// Generado automaticamente por build-portable.ps1
// ========================================

(function() {
  'use strict';

  // ========================================
  // MODULO STORAGE (storage.js)
  // ========================================
  // ========================================
// MÓDULO DE ALMACENAMIENTO
// FileSystemManager + MapStorageService
// ========================================

class FileSystemManager {
  constructor() {
    this.directoryHandle = null;
    this.imagesFolder = null;
    this.isFileSystemMode = false;
    this.folderPath = '';
    this.dbName = 'InventarioFS';
    this.dbVersion = 1;
  }

  get storageHandle() {
    return this.directoryHandle;
  }

  get isConnected() {
    return this.isFileSystemMode && !!this.directoryHandle;
  }

  async saveDirectoryHandle(handle) {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.dbVersion);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        const db = request.result;
        const transaction = db.transaction(['directories'], 'readwrite');
        const store = transaction.objectStore('directories');
        store.put({ id: 'main', handle: handle, timestamp: Date.now() });
        transaction.oncomplete = () => resolve(true);
        transaction.onerror = () => reject(transaction.error);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('directories')) {
          db.createObjectStore('directories', { keyPath: 'id' });
        }
      };
    });
  }

  async loadDirectoryHandle() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.dbVersion);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        const db = request.result;
        const transaction = db.transaction(['directories'], 'readonly');
        const store = transaction.objectStore('directories');
        const getRequest = store.get('main');
        
        getRequest.onsuccess = () => {
          resolve(getRequest.result?.handle || null);
        };
        getRequest.onerror = () => reject(getRequest.error);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('directories')) {
          db.createObjectStore('directories', { keyPath: 'id' });
        }
      };
    });
  }

  async restoreFromPreviousSession() {
    try {
      const savedHandle = await this.loadDirectoryHandle();
      if (!savedHandle) {
        console.log('No hay carpeta guardada previamente');
        return false;
      }

      const permission = await savedHandle.queryPermission({ mode: 'readwrite' });
      
      if (permission === 'granted') {
        this.directoryHandle = savedHandle;
        await this.ensureImageFolder();
        this.folderPath = this.directoryHandle.name;
        this.isFileSystemMode = true;
        this.updateStatusIndicator(true, this.folderPath);
        console.log('- Sesin FileSystem restaurada automticamente:', this.folderPath);
        return true;
      } else if (permission === 'prompt') {
        const newPermission = await savedHandle.requestPermission({ mode: 'readwrite' });
        if (newPermission === 'granted') {
          this.directoryHandle = savedHandle;
          await this.ensureImageFolder();
          this.folderPath = this.directoryHandle.name;
          this.isFileSystemMode = true;
          this.updateStatusIndicator(true, this.folderPath);
          console.log('- Permisos re-otorgados, sesin restaurada:', this.folderPath);
          return true;
        }
      }
      
      console.log('  Permisos denegados, necesita reactivar manualmente');
      return false;
    } catch (error) {
      console.error('Error restaurando sesin:', error);
      return false;
    }
  }

  updateStatusIndicator(connected, path = '') {
    const indicator = document.getElementById('connectionIndicator');
    const btn = document.getElementById('connectionBtn');
    const icon = document.getElementById('connectionIcon');
    const text = document.getElementById('connectionText');

    if (connected) {
      // Actualizar indicador del panel de configuración
      if (indicator) {
        indicator.classList.remove('disconnected');
        indicator.classList.add('connected');
      }
      if (indicator?.querySelector('.connection-icon')) {
        indicator.querySelector('.connection-icon').textContent = 'ON';
      }
      if (indicator?.querySelector('.connection-text')) {
        indicator.querySelector('.connection-text').textContent = path ? `INVENTARIO_PORTABLE conectado (${path})` : 'INVENTARIO_PORTABLE conectado';
      }
      
      // Actualizar botón de estado en toolbar (nuevo diseño corporativo)
      if (btn) {
        btn.classList.remove('disconnected');
        btn.classList.add('connected');
      }
      if (text) {
        text.textContent = 'Conectado';
      }
    } else {
      // Actualizar indicador del panel de configuración
      if (indicator) {
        indicator.classList.remove('connected');
        indicator.classList.add('disconnected');
      }
      if (indicator?.querySelector('.connection-icon')) {
        indicator.querySelector('.connection-icon').textContent = 'OFF';
      }
      if (indicator?.querySelector('.connection-text')) {
        indicator.querySelector('.connection-text').textContent = 'INVENTARIO_STORAGE NO CONECTADO';
      }
      
      // Actualizar botón de estado en toolbar (nuevo diseño corporativo)
      if (btn) {
        btn.classList.remove('connected');
        btn.classList.add('disconnected');
      }
      if (text) {
        text.textContent = 'Desconectado';
      }
    }
  }

  disconnect() {
    console.log('🔌 Desconectando FileSystem...');
    this.directoryHandle = null;
    this.imagesFolder = null;
    this.isFileSystemMode = false;
    this.folderPath = '';
    this.updateStatusIndicator(false);
    console.log('✅ FileSystem desconectado');
  }

  async selectFolder() {
    try {
      const selectedFolder = await window.showDirectoryPicker({ mode: 'readwrite' });
      console.log('  Carpeta seleccionada por usuario:', selectedFolder.name);
      
      let workingFolder = selectedFolder;
      let detectedPath = selectedFolder.name;
      
      if (selectedFolder.name === 'INVENTARIO_PORTABLE') {
        console.log('  Detectado INVENTARIO_PORTABLE, buscando INVENTARIO_STORAGE dentro...');
        try {
          const storageFolder = await selectedFolder.getDirectoryHandle('INVENTARIO_STORAGE', { create: false });
          workingFolder = storageFolder;
          detectedPath = 'INVENTARIO_STORAGE';
          console.log('- INVENTARIO_STORAGE encontrado automticamente!');
        } catch (e) {
          console.warn('  INVENTARIO_STORAGE no encontrada, crendola...');
          const storageFolder = await selectedFolder.getDirectoryHandle('INVENTARIO_STORAGE', { create: true });
          workingFolder = storageFolder;
          detectedPath = 'INVENTARIO_STORAGE';
          console.log('- INVENTARIO_STORAGE creada automticamente!');
        }
      } else if (selectedFolder.name === 'INVENTARIO_STORAGE') {
        console.log('- INVENTARIO_STORAGE seleccionada directamente');
        detectedPath = 'INVENTARIO_STORAGE';
      } else {
        console.log('  Buscando INVENTARIO_STORAGE dentro de', selectedFolder.name);
        try {
          const storageFolder = await selectedFolder.getDirectoryHandle('INVENTARIO_STORAGE', { create: false });
          workingFolder = storageFolder;
          detectedPath = `${selectedFolder.name}/${storageFolder.name}`;
          console.log('- INVENTARIO_STORAGE encontrado dentro de', selectedFolder.name);
        } catch (e) {
          console.log('  INVENTARIO_STORAGE no encontrada, usando carpeta seleccionada como est');
        }
      }
      
      this.directoryHandle = workingFolder;
      await this.ensureImageFolder();
      
      await this.saveDirectoryHandle(this.directoryHandle);
      localStorage.setItem('fsDirectory', 'enabled');
      
      this.folderPath = detectedPath;
      localStorage.setItem('fsFolderName', this.folderPath);
      
      this.isFileSystemMode = true;
      console.log('- Sistema configurado con carpeta:', detectedPath);
      this.updateStatusIndicator(true, detectedPath);
      if (typeof mapStorage !== 'undefined' && mapStorage) {
        try {
          await mapStorage.init({ autoReconnect: false });
        } catch (error) {
          console.warn('No se pudo inicializar MapStorage tras seleccionar carpeta:', error);
        }
      }

      return true;
    } catch (error) {
      console.error('Error seleccionando carpeta:', error);
      this.updateStatusIndicator(false);
      return false;
    }
  }

  async ensureImageFolder() {
    try {
      this.imagesFolder = await this.directoryHandle.getDirectoryHandle('imagenes', { create: true });
      console.log('- Carpeta "imagenes" accesible:', this.imagesFolder);
      
      let count = 0;
      for await (const entry of this.imagesFolder.values()) {
        count++;
        if (count <= 3) {
          console.log(`     Encontrado: ${entry.name}`);
        }
      }
      console.log(`     Total de archivos en carpeta imagenes: ${count}`);
    } catch (error) {
      console.error('- Error accediendo a carpeta imagenes:', error);
      this.imagesFolder = null;
    }
  }

  async saveJSON(data) {
    if (!this.isFileSystemMode) {
      return false; // No est en modo FileSystem
    }
    try {
      const fileHandle = await this.directoryHandle.getFileHandle('inventario.json', { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(JSON.stringify(data, null, 2));
      await writable.close();
      console.log('- JSON guardado en archivo: inventario.json');
      return true;
    } catch (error) {
      console.error('- Error guardando JSON en FileSystem:', error);
      return false;
    }
  }

  async saveImage(blob, filename) {
    if (!this.isFileSystemMode) return null;
    try {
      const fileHandle = await this.imagesFolder.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      console.log('- Imagen guardada:', filename);
      return './imagenes/' + filename;
    } catch (error) {
      console.error('Error guardando imagen:', error);
      return null;
    }
  }

  /**
   * Carga una imagen desde FileSystem y retorna Blob URL
   */
  async loadImage(filename) {
    if (!this.isFileSystemMode) return null;
    try {
      const fileHandle = await this.imagesFolder.getFileHandle(filename);
      const file = await fileHandle.getFile();
      const blobUrl = URL.createObjectURL(file);
      console.log('✅ Imagen cargada desde FileSystem:', filename);
      return blobUrl;
    } catch (error) {
      console.warn(`⚠️ No se pudo cargar imagen ${filename}:`, error.message);
      return null;
    }
  }

  /**
   * Guarda imagen en carpeta jerrquica segn ubicacin
   */
  async saveImageJerarquica(blob, filename, carpetaDestino) {
    if (!this.isFileSystemMode) return null;
    try {
      const fileHandle = await carpetaDestino.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      console.log('- Imagen guardada en carpeta jerrquica:', filename);
      return filename;
    } catch (error) {
      console.error('Error guardando imagen en carpeta jerrquica:', error);
      return null;
    }
  }

  /**
   * Refresca el handle de la carpeta imagenes para asegurar sincronizacin
   */
  async refreshImagesFolder() {
    if (this.isFileSystemMode && this.directoryHandle) {
      try {
        this.imagesFolder = await this.directoryHandle.getDirectoryHandle('imagenes', { create: true });
        console.log('- Handle de carpeta imagenes refrescado');
      } catch (error) {
        console.error('- Error refrescando handle de carpeta imagenes:', error);
      }
    }
  }

  /**
   * Elimina una imagen del FileSystem, soporta rutas jerrquicas
   */
  async deleteImage(imagePath) {
    if (!this.isFileSystemMode) return false;
    try {
      const relativePath = imagePath.replace('./imagenes/', '').replace('imagenes/', '');
      if (!relativePath) {
        console.warn('  Nombre de archivo invlido:', imagePath);
        return false;
      }
      // Si la ruta tiene subcarpetas (ej: TEST/archivo.webp)
      if (relativePath.includes('/')) {
        const parts = relativePath.split('/');
        const filename = parts.pop(); // ltimo elemento es el archivo
        let currentFolder = this.imagesFolder;
        // Navegar por las subcarpetas
        for (const folderName of parts) {
          try {
            currentFolder = await currentFolder.getDirectoryHandle(folderName);
          } catch (error) {
            console.warn(`  Carpeta no encontrada: ${folderName}`);
            return true; // Considerar xito si no existe
          }
        }
        // Eliminar archivo de la carpeta final
        await currentFolder.removeEntry(filename);
        console.log(`- Archivo eliminado: ${relativePath}`);
        return true;
      } else {
        // Archivo en la raz de imagenes/
        await this.imagesFolder.removeEntry(relativePath);
        console.log(`- Archivo eliminado: ${relativePath}`);
        return true;
      }
    } catch (error) {
      if (error.name === 'NotFoundError') {
        console.warn(`  Archivo no encontrado (ya estaba eliminado): ${imagePath}`);
        return true; // Considerar como xito si ya no existe
      }
      console.error('- Error eliminando imagen:', error);
      console.error('   Ruta:', imagePath);
      return false;
    }
  }

  async deleteMultipleImages(imagePaths) {
    if (!this.isFileSystemMode) return { deleted: 0, failed: 0 };
    
    let deleted = 0;
    let failed = 0;
    
    console.log(` - Eliminando ${imagePaths.length} imgenes del FileSystem...`);
    
    for (const imagePath of imagePaths) {
      const success = await this.deleteImage(imagePath);
      if (success) {
        deleted++;
      } else {
        failed++;
      }
    }
    
    console.log(`- Eliminadas: ${deleted} | - Fallidas: ${failed}`);
    return { deleted, failed };
  }

  async getAllImagesInFolder() {
    if (!this.isFileSystemMode) return [];
    
    try {
      const images = [];
      for await (const entry of this.imagesFolder.values()) {
        if (entry.kind === 'file') {
          images.push(entry.name);
        }
      }
      return images;
    } catch (error) {
      console.error('Error listando imgenes:', error);
      return [];
    }
  }

  async cleanOrphanImages(repuestos) {
    if (!this.isFileSystemMode) return { orphans: 0, deleted: 0, failed: 0, size: 0 };
    
    console.log('  Buscando imgenes hurfanas...');
    
    const allImages = await this.getAllImagesInFolder();
    console.log(`  Total de imgenes en carpeta: ${allImages.length}`);
    
    const referencedImages = new Set();
    repuestos.forEach(r => {
      if (r.multimedia) {
        r.multimedia
          .filter(m => m.type === 'image' && m.isFileSystem && m.url)
          .forEach(m => {
            const filename = m.url.replace('./imagenes/', '').replace('imagenes/', '');
            referencedImages.add(filename);
          });
      }
    });
    console.log(`  Imgenes referenciadas: ${referencedImages.size}`);
    
    const orphanImages = allImages.filter(img => !referencedImages.has(img));
    console.log(` - Imgenes hurfanas encontradas: ${orphanImages.length}`);
    
    if (orphanImages.length === 0) {
      return { orphans: 0, deleted: 0, failed: 0, size: 0 };
    }
    
    let totalSize = 0;
    for (const filename of orphanImages) {
      try {
        const fileHandle = await this.imagesFolder.getFileHandle(filename);
        const file = await fileHandle.getFile();
        totalSize += file.size;
      } catch (error) {
        console.warn(`  No se pudo leer tamao de: ${filename}`);
      }
    }
    
    let deleted = 0;
    let failed = 0;
    
    for (const filename of orphanImages) {
      try {
        await this.imagesFolder.removeEntry(filename);
        deleted++;
        console.log(`- Eliminada hurfana: ${filename}`);
      } catch (error) {
        failed++;
        console.error(`- Error eliminando: ${filename}`, error);
      }
    }
    
    console.log(`- Limpieza completada: ${deleted} eliminadas, ${failed} fallidas`);
    console.log(`  Espacio liberado: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
    
    return { 
      orphans: orphanImages.length, 
      deleted, 
      failed, 
      size: totalSize 
    };
  }
}

class MapStorageService {
  constructor(fsManager) {
    this.fsManager = fsManager;
    this.maps = [];
    this.zones = [];
    this.maxBackups = 5;
    this.mapsFileName = 'mapas.json';
    this.zonesFileName = 'zonas.json';
    this.logsDirName = 'logs';
    this.logFileName = 'mapas-history.log';
    this.mapImagesPath = ['imagenes', 'mapas'];
    this.backupMapPath = ['backups', 'mapas'];
    this.backupZonePath = ['backups', 'zonas'];
    this.initialized = false;
    this.logsDirHandle = null;
    this.backupMapsDir = null;
    this.backupZonesDir = null;
    this.mapImagesDir = null;
  }

  get rootHandle() {
    return this.fsManager ? this.fsManager.storageHandle : null;
  }

  setMaxBackups(value) {
    if (typeof value === 'number' && value >= 1) {
      this.maxBackups = Math.floor(value);
    }
  }

  async init(options = {}) {
    const { autoReconnect = true } = options;
    if (!this.fsManager) {
      return false;
    }

    if (!this.fsManager.isConnected && autoReconnect && typeof this.fsManager.restoreFromPreviousSession === 'function') {
      try {
        await this.fsManager.restoreFromPreviousSession();
      } catch (error) {
        console.warn('No se pudo restaurar la carpeta de FileSystem:', error);
      }
    }

    if (!this.fsManager.isConnected) {
      return false;
    }

    await this.ensureStructure();
    await Promise.all([this.loadMaps(), this.loadZones()]);
    this.initialized = true;
    return true;
  }

  async ensureStructure() {
    const root = this.rootHandle;
    if (!root) {
      return;
    }

    this.mapImagesDir = await this.ensureDirectory(this.mapImagesPath);
    this.backupMapsDir = await this.ensureDirectory(this.backupMapPath);
    this.backupZonesDir = await this.ensureDirectory(this.backupZonePath);
    this.logsDirHandle = await this.ensureDirectory([this.logsDirName]);

    await this.ensureJSONFile(this.mapsFileName, '[]');
    await this.ensureJSONFile(this.zonesFileName, '[]');
    await this.ensureLogFile();
  }

  async ensureDirectory(pathSegments) {
    let current = this.rootHandle;
    if (!current) {
      return null;
    }

    for (const segment of pathSegments) {
      if (!segment) {
        continue;
      }
      current = await current.getDirectoryHandle(segment, { create: true });
    }

    return current;
  }

  async ensureJSONFile(fileName, defaultContent) {
    const root = this.rootHandle;
    if (!root) {
      return;
    }

    try {
      await root.getFileHandle(fileName);
    } catch (error) {
      if (error.name === 'NotFoundError') {
        const handle = await root.getFileHandle(fileName, { create: true });
        const writable = await handle.createWritable();
        await writable.write(defaultContent);
        await writable.close();
      } else {
        console.warn(`No se pudo asegurar ${fileName}:`, error);
      }
    }
  }

  async ensureLogFile() {
    if (!this.logsDirHandle) {
      return;
    }

    try {
      await this.logsDirHandle.getFileHandle(this.logFileName);
    } catch (error) {
      if (error.name === 'NotFoundError') {
        const handle = await this.logsDirHandle.getFileHandle(this.logFileName, { create: true });
        const writable = await handle.createWritable();
        await writable.write('');
        await writable.close();
      } else {
        console.warn('No se pudo asegurar el archivo de log:', error);
      }
    }
  }

  async loadMaps() {
    if (!this.fsManager || !this.fsManager.isConnected) {
      this.maps = [];
      return this.maps;
    }

    try {
      const fileHandle = await this.rootHandle.getFileHandle(this.mapsFileName, { create: true });
      const file = await fileHandle.getFile();
      const raw = (await file.text()).trim();
      let parsed = [];
      if (raw) {
        parsed = JSON.parse(raw);
      }
      this.maps = Array.isArray(parsed) ? parsed : [];
    } catch (error) {
      console.warn('No se pudieron cargar los mapas:', error);
      this.maps = [];
    }

    return this.maps;
  }

  async loadZones() {
    if (!this.fsManager || !this.fsManager.isConnected) {
      this.zones = [];
      return this.zones;
    }

    try {
      const fileHandle = await this.rootHandle.getFileHandle(this.zonesFileName, { create: true });
      const file = await fileHandle.getFile();
      const raw = (await file.text()).trim();
      let parsed = [];
      if (raw) {
        parsed = JSON.parse(raw);
      }
      this.zones = Array.isArray(parsed) ? parsed : [];
    } catch (error) {
      console.warn('No se pudieron cargar las zonas:', error);
      this.zones = [];
    }

    return this.zones;
  }

  async writeJSON(fileName, data) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return false;
    }

    try {
      const handle = await this.rootHandle.getFileHandle(fileName, { create: true });
      const writable = await handle.createWritable();
      await writable.write(JSON.stringify(data, null, 2));
      await writable.close();
      return true;
    } catch (error) {
      console.warn(`No se pudo escribir ${fileName}:`, error);
      return false;
    }
  }

  async saveMaps(maps, meta = {}) {
    const normalized = Array.isArray(maps) ? maps : [];

    if (!this.fsManager || !this.fsManager.isConnected) {
      this.maps = [...normalized];
      return false;
    }

    await this.createBackup(this.mapsFileName, 'maps');
    await this.writeJSON(this.mapsFileName, normalized);
    this.maps = [...normalized];

    await this.appendLog({ scope: 'maps', action: meta.action || 'save', mapId: meta.mapId || null, detail: meta.detail || null });
    return true;
  }

  async saveZones(zones, meta = {}) {
    const normalized = Array.isArray(zones) ? zones : [];

    if (!this.fsManager || !this.fsManager.isConnected) {
      this.zones = [...normalized];
      return false;
    }

    await this.createBackup(this.zonesFileName, 'zones');
    await this.writeJSON(this.zonesFileName, normalized);
    this.zones = [...normalized];

    await this.appendLog({ scope: 'zones', action: meta.action || 'save', mapId: meta.mapId || null, zoneId: meta.zoneId || null, detail: meta.detail || null });
    return true;
  }

  async createBackup(fileName, namespace) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return;
    }

    const dirHandle = namespace === 'zones' ? this.backupZonesDir : this.backupMapsDir;
    if (!dirHandle) {
      return;
    }

    try {
      const fileHandle = await this.rootHandle.getFileHandle(fileName);
      const file = await fileHandle.getFile();
      const content = await file.text();
      if (!content || !content.trim()) {
        return;
      }

      const timestamp = this.formatTimestamp(new Date());
      const baseName = fileName.replace('.json', '');
      const backupHandle = await dirHandle.getFileHandle(`${baseName}-${timestamp}.json`, { create: true });
      const writable = await backupHandle.createWritable();
      await writable.write(content);
      await writable.close();

      await this.rotateBackups(dirHandle);
    } catch (error) {
      if (error.name !== 'NotFoundError') {
        console.warn(`No se pudo crear backup para ${fileName}:`, error);
      }
    }
  }

  async rotateBackups(dirHandle) {
    if (!dirHandle) {
      return;
    }

    const files = [];
    try {
      for await (const entry of dirHandle.values()) {
        if (entry.kind === 'file') {
          files.push(entry.name);
        }
      }
    } catch (error) {
      console.warn('No se pudo enumerar los backups:', error);
      return;
    }

    files.sort();

    while (files.length > this.maxBackups) {
      const oldest = files.shift();
      try {
        await dirHandle.removeEntry(oldest);
      } catch (error) {
        console.warn('No se pudo eliminar backup antiguo:', oldest, error);
        break;
      }
    }
  }

  async appendLog(event) {
    if (!event || typeof event !== 'object') {
      return;
    }

    if (!this.logsDirHandle) {
      return;
    }

    try {
      const payload = {
        scope: event.scope || 'maps',
        action: event.action || 'update',
        mapId: event.mapId || null,
        zoneId: event.zoneId || null,
        detail: event.detail || null,
        timestamp: new Date().toISOString()
      };
      const handle = await this.logsDirHandle.getFileHandle(this.logFileName, { create: true });
      const file = await handle.getFile();
      const writable = await handle.createWritable({ keepExistingData: true });
      await writable.seek(file.size);
      await writable.write(JSON.stringify(payload) + '\n');
      await writable.close();
    } catch (error) {
      console.warn('No se pudo registrar el evento de mapa:', error);
    }
  }

  async readLog(limit = null) {
    if (!this.logsDirHandle) {
      return [];
    }

    try {
      const handle = await this.logsDirHandle.getFileHandle(this.logFileName, { create: true });
      const file = await handle.getFile();
      const text = await file.text();
      if (!text) {
        return [];
      }

      const lines = text.split('\n').filter(line => line.trim().length > 0);
      const events = [];
      for (const line of lines) {
        try {
          events.push(JSON.parse(line));
        } catch (error) {
          console.warn('Entrada de log invalida:', line);
        }
      }

      if (typeof limit === 'number' && limit > 0) {
        return events.slice(-limit);
      }

      return events;
    } catch (error) {
      console.warn('No se pudo leer el log de mapas:', error);
      return [];
    }
  }

  async getFileHandleFromPath(path) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return null;
    }

    const segments = Array.isArray(path) ? path : String(path || '').split('/').filter(Boolean);
    if (!segments.length) {
      return null;
    }

    let currentDir = this.rootHandle;
    try {
      for (let i = 0; i < segments.length; i++) {
        const segment = segments[i];
        const isLast = i === segments.length - 1;
        if (isLast) {
          return await currentDir.getFileHandle(segment, { create: false });
        }
        currentDir = await currentDir.getDirectoryHandle(segment, { create: false });
      }
    } catch (error) {
      console.warn('No se pudo resolver ruta de archivo:', path, error);
      return null;
    }

    return null;
  }

  async getMapImage(map) {
    if (!map || !map.imagePath) {
      return null;
    }

    try {
      const handle = await this.getFileHandleFromPath(map.imagePath);
      if (!handle) {
        return null;
      }
      return await handle.getFile();
    } catch (error) {
      console.warn('No se pudo obtener imagen del mapa:', error);
      return null;
    }
  }
  getMapById(mapId) {
    return this.maps.find(map => map.id === mapId) || null;
  }

  getZonesByMap(mapId) {
    return this.zones.filter(zone => zone.mapId === mapId);
  }

  formatTimestamp(date = new Date()) {
    const pad = (value) => String(value).padStart(2, '0');
    const year = date.getFullYear();
    const month = pad(date.getMonth() + 1);
    const day = pad(date.getDate());
    const hours = pad(date.getHours());
    const minutes = pad(date.getMinutes());
    const seconds = pad(date.getSeconds());
    return `${year}${month}${day}-${hours}${minutes}${seconds}`;
  }
}

// Instancias globales
const fsManager = new FileSystemManager();
const mapStorage = new MapStorageService(fsManager);



  // ========================================
  // MODULO MAPA (mapa.js)
  // ========================================
  // ========================================
// MÓDULO DE MAPA
// mapController - Gestión de mapas y zonas
// ========================================

// [REMOVED IMPORT]

const mapController = {
  elements: {},
  state: {
    currentMapId: null,
    currentMap: null,
    currentImage: null,
    currentImageUrl: null,
    scale: 1,
    minScale: 0.05,
    maxScale: 20,
    offsetX: 0,
    offsetY: 0,
    isPanning: false,
    panStartX: 0,
    panStartY: 0,
    drawing: false,
    tempPoints: [],
    previewPoint: null,
    highlightZoneId: null,
    showGrid: false,
    zones: []
  },

  init() {
    this.elements = {
      shell: document.querySelector('.map-shell'),
      connectBtn: document.getElementById('mapConnectBtn'),
      newBtn: document.getElementById('mapNewBtn'),
      drawBtn: document.getElementById('mapDrawZoneBtn'),
      saveBtn: document.getElementById('mapSaveZonesBtn'),
      mapList: document.getElementById('mapList'),
      zoneList: document.getElementById('zoneList'),
      logList: document.getElementById('mapLogList'),
      logRefreshBtn: document.getElementById('mapLogRefreshBtn'),
      connectionBadge: document.getElementById('mapConnectionBadge'),
      status: document.getElementById('mapStatus'),
      zoomBadge: document.getElementById('mapZoomBadge'),
      metaBadge: document.getElementById('mapMetaBadge'),
      toolbar: document.getElementById('mapToolbar'),
      canvasStage: document.querySelector('.map-canvas-stage'),
      canvas: document.getElementById('mapCanvas'),
      hint: document.getElementById('mapHint'),
      modal: document.getElementById('mapModalOverlay'),
      modalBody: document.getElementById('mapModalBody'),
      modalTitle: document.getElementById('mapModalTitle'),
      modalClose: document.getElementById('mapModalClose')
    };

    if (!this.elements.canvas) {
      console.warn('mapController: canvas no disponible');
      return;
    }

    this.ctx = this.elements.canvas.getContext('2d', { alpha: false, desynchronized: true });
    this.bindEvents();
    this.updateConnectionBadge();
    this.resizeCanvas();

    if (mapStorage.initialized) {
      this.loadData();
    } else if (fsManager.isConnected) {
      mapStorage.init({ autoReconnect: false }).then(() => this.loadData()).catch((error) => {
        console.warn('mapController: no se pudo inicializar mapStorage de inmediato', error);
      });
    } else {
      this.drawMessage('Conecta la carpeta INVENTARIO_STORAGE para comenzar.');
      this.renderMapList([]);
      this.renderZoneList([]);
    }
  },

  bindEvents() {
    const { connectBtn, newBtn, drawBtn, toolbar, logRefreshBtn, modalClose, modal } = this.elements;

    if (connectBtn) connectBtn.addEventListener('click', () => this.handleConnect());
    if (newBtn) newBtn.addEventListener('click', () => this.openNewMapModal());
    if (drawBtn) drawBtn.addEventListener('click', () => this.toggleDrawingMode());
    if (toolbar) {
      toolbar.addEventListener('click', (event) => {
        const target = event.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        event.preventDefault();
        this.handleToolbarAction(action);
      });
    }
    if (logRefreshBtn) logRefreshBtn.addEventListener('click', () => this.refreshLog());
    if (modalClose) modalClose.addEventListener('click', () => this.closeModal());
    if (modal) modal.addEventListener('click', (event) => {
      if (event.target === modal) this.closeModal();
    });

    this.registerCanvasEvents();
    window.addEventListener('resize', () => this.handleResize());
  },

  async handleConnect() {
    if (typeof fsManager?.checkFileSystemAPI === 'function' && !fsManager.checkFileSystemAPI()) {
      this.showToast('Tu navegador no soporta File System Access API. Usa Microsoft Edge o Chrome.', 'warning');
      return;
    }

    try {
      const connected = await fsManager.selectFolder();
      if (connected) {
        await mapStorage.init({ autoReconnect: false });
        this.showToast('Carpeta conectada correctamente.', 'success');
        this.updateConnectionBadge();
        await this.loadData({ force: true });
      }
    } catch (error) {
      console.error('Error conectando carpeta:', error);
      this.showToast('No se pudo conectar la carpeta: ' + (error?.message || error), 'error');
    }
  },

  updateConnectionBadge() {
    const { connectionBadge, status } = this.elements;
    if (!connectionBadge) return;

    if (mapStorage.initialized && fsManager.isConnected) {
      connectionBadge.textContent = fsManager.folderPath || 'INVENTARIO_STORAGE';
      connectionBadge.classList.remove('map-status-badge--off');
      connectionBadge.classList.add('map-status-badge--on');
      if (status) {
        status.textContent = 'Selecciona un mapa o crea uno nuevo para comenzar a trabajar.';
      }
    } else {
      connectionBadge.textContent = 'Sin carpeta';
      connectionBadge.classList.remove('map-status-badge--on');
      connectionBadge.classList.add('map-status-badge--off');
      if (status) {
        status.textContent = 'Conecta la carpeta INVENTARIO_STORAGE para habilitar el editor de mapas.';
      }
    }
  },

  async loadData(options = {}) {
    if (!mapStorage.initialized) {
      this.renderMapList([]);
      this.renderZoneList([]);
      this.drawMessage('Conecta la carpeta INVENTARIO_STORAGE para comenzar.');
      return;
    }

    try {
      if (options.force) {
        await mapStorage.ensureStructure();
        await Promise.all([mapStorage.loadMaps(), mapStorage.loadZones()]);
      }

      const maps = mapStorage.maps || [];
      this.renderMapList(maps);

      if (!maps.length) {
        this.state.currentMapId = null;
        this.state.currentMap = null;
        this.cleanupImage();
        this.renderZoneList([]);
        this.drawMessage('Crea un mapa para comenzar a dibujar zonas.');
        return;
      }

      if (!this.state.currentMapId || !maps.some(m => m.id === this.state.currentMapId)) {
        await this.selectMap(maps[0].id);
      } else {
        await this.selectMap(this.state.currentMapId, { keepViewport: true });
      }

      await this.refreshLog();
    } catch (error) {
      console.error('mapController.loadData error:', error);
      this.showToast('No se pudieron cargar los mapas. Revisa la consola.', 'error');
    }
  },

  renderMapList(maps) {
    const { mapList } = this.elements;
    if (!mapList) return;

    if (!Array.isArray(maps) || !maps.length) {
      mapList.innerHTML = `<div style="padding: 16px; border: 1px dashed var(--border-color); border-radius: 10px; color: var(--text-secondary); font-size: 0.85rem;">Aún no hay mapas registrados.</div>`;
      return;
    }

    const activeId = this.state.currentMapId;
    mapList.innerHTML = maps.map(map => {
      const isActive = activeId === map.id;
      const createdAt = map.createdAt ? new Date(map.createdAt).toLocaleDateString('es-CL') : '';
      const dimensions = map.width && map.height ? `${map.width} × ${map.height}px` : 'Dimensiones pendientes';
      const zonesCount = (mapStorage.zones || []).filter(z => z.mapId === map.id).length;
      return `
        <article class="map-card ${isActive ? 'map-card--active' : ''}" data-map-id="${map.id}">
          <div class="map-card-title">${this.escapeHtml(map.name || 'Mapa sin nombre')}</div>
          <div class="map-card-meta">${dimensions}</div>
          <div class="map-card-meta">${zonesCount} zona(s) registradas</div>
          ${createdAt ? `<div class="map-card-meta">Creado: ${createdAt}</div>` : ''}
        </article>
      `;
    }).join('');

    Array.from(mapList.querySelectorAll('.map-card')).forEach(card => {
      card.addEventListener('click', async () => {
        const mapId = card.getAttribute('data-map-id');
        if (!mapId) return;
        await this.selectMap(mapId);
      });
    });
  },

  renderZoneList(zones) {
    const { zoneList } = this.elements;
    if (!zoneList) return;

    if (!Array.isArray(zones) || !zones.length) {
      zoneList.innerHTML = `<div style="padding: 12px; border: 1px dashed var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 0.8rem;">No hay zonas registradas para este mapa.</div>`;
      return;
    }

    zoneList.innerHTML = zones.map(zone => {
      const color = zone.color || '#5a6b7a';
      const jerarquia = zone.jerarquia ? Object.values(zone.jerarquia).filter(Boolean).join(' > ') : '';
      const equipos = Array.isArray(zone.equipos) ? zone.equipos.length : 0;
      
      const activeClass = zone.id === this.state.highlightZoneId ? 'map-zone-item--active' : '';
      const borderStyle = 'border-left-color:' + color + ';';
      
      return `
        <div class="map-zone-item ${activeClass}" data-zone-id="${zone.id}" style="${borderStyle}">
          <div class="map-zone-title">${this.escapeHtml(zone.name || 'Zona sin nombre')}</div>
          ${jerarquia ? `<div class="map-zone-subtitle">${this.escapeHtml(jerarquia)}</div>` : ''}
          <div class="map-zone-subtitle">${equipos} equipos asociados</div>
        </div>
      `;
    }).join('');

    Array.from(zoneList.querySelectorAll('.map-zone-item')).forEach(item => {
      item.addEventListener('click', () => {
        const zoneId = item.getAttribute('data-zone-id');
        this.focusZone(zoneId);
      });
    });
  },

  async selectMap(mapId, options = {}) {
    if (!mapId) return;
    if (!mapStorage.initialized) {
      this.showToast('Conecta la carpeta primero.', 'warning');
      return;
    }

    const numericId = typeof mapId === 'string' ? parseInt(mapId, 10) : mapId;
    const map = mapStorage.getMapById(numericId);

    if (!map) {
      this.showToast('Mapa no encontrado.', 'warning');
      return;
    }

    this.state.currentMapId = map.id;
    this.state.currentMap = map;
    this.state.zones = mapStorage.getZonesByMap(map.id);
    this.state.highlightZoneId = null;

    if (!options.keepViewport) {
      this.state.scale = 1;
      this.state.offsetX = 0;
      this.state.offsetY = 0;
    }

    await this.loadMapImage(map, options);
    this.renderMapList(mapStorage.maps);
    this.renderZoneList(this.state.zones);
    this.updateMetaBadge();
  },

  async loadMapImage(map, options = {}) {
    this.cleanupImage();

    if (!map.imagePath) {
      this.drawMessage('El mapa seleccionado no tiene imagen asociada.');
      return;
    }

    try {
      const file = await mapStorage.getMapImage(map);
      if (!file) {
        this.drawMessage('No se encontr la imagen del mapa.');
        return;
      }

      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        this.state.currentImage = img;
        this.state.currentImageUrl = url;
        this.configureCanvasForImage(img, options);
        this.draw();
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        this.drawMessage('Error cargando la imagen del mapa.');
      };
      img.src = url;
    } catch (error) {
      console.error('Error cargando imagen del mapa:', error);
      this.drawMessage('No se pudo cargar la imagen del mapa.');
    }
  },

  configureCanvasForImage(img, options = {}) {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    canvas.width = img.width;
    canvas.height = img.height;

    const container = this.elements.canvasStage || canvas.parentElement;
    if (container) {
      const containerWidth = Math.max(container.clientWidth - 48, 320);
      const containerHeight = Math.max(container.clientHeight - 48, 240);
      const initialCssScale = Math.min(containerWidth / img.width, containerHeight / img.height, 1);
      canvas.style.width = `${img.width * initialCssScale}px`;
      canvas.style.height = `${img.height * initialCssScale}px`;
    }

    if (!options.keepViewport) {
      this.state.scale = 1;
      this.state.offsetX = 0;
      this.state.offsetY = 0;
    }

    this.updateZoomBadge();
  },

  cleanupImage() {
    if (this.state.currentImageUrl) {
      try {
        URL.revokeObjectURL(this.state.currentImageUrl);
      } catch (error) {
        console.debug('cleanupImage revoke fall:', error);
      }
    }
    this.state.currentImageUrl = null;
    this.state.currentImage = null;
  },

  handleResize() {
    if (!this.elements.canvas) return;
    if (!this.state.currentImage) {
      this.resizeCanvas();
      return;
    }

    const container = this.elements.canvasStage || this.elements.canvas.parentElement;
    if (container) {
      const containerWidth = Math.max(container.clientWidth - 48, 320);
      const containerHeight = Math.max(container.clientHeight - 48, 240);
      const img = this.state.currentImage;
      const cssScale = Math.min(containerWidth / img.width, containerHeight / img.height, 1);
      this.elements.canvas.style.width = `${img.width * cssScale}px`;
      this.elements.canvas.style.height = `${img.height * cssScale}px`;
    }

    this.draw();
  },

  resizeCanvas() {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    if (!this.state.currentImage) {
      const container = this.elements.canvasStage || canvas.parentElement;
      const rectWidth = container ? container.clientWidth : 640;
      const rectHeight = container ? container.clientHeight : 480;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.max(1, Math.round(rectWidth * dpr));
      canvas.height = Math.max(1, Math.round(rectHeight * dpr));
      this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      this.drawMessage('Conecta la carpeta INVENTARIO_STORAGE para comenzar.');
    } else {
      this.handleResize();
    }
  },

  drawMessage(message) {
    const canvas = this.elements.canvas;
    if (!canvas || !this.ctx) return;
    const ctx = this.ctx;
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = '#1e1e1e';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'rgba(212, 212, 212, 0.9)';
    ctx.font = '16px "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(message, canvas.width / 2, canvas.height / 2);
    ctx.restore();
  },

  draw() {
    const canvas = this.elements.canvas;
    if (!canvas || !this.ctx) return;

    const ctx = this.ctx;
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = '#1e1e1e';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.translate(this.state.offsetX, this.state.offsetY);
    ctx.scale(this.state.scale, this.state.scale);

    if (this.state.currentImage) {
      ctx.drawImage(this.state.currentImage, 0, 0);
    }

    if (this.state.showGrid) {
      this.drawGrid(ctx);
    }

    this.drawZones(ctx);
    this.drawTempShape(ctx);

    ctx.restore();
    this.updateZoomBadge();
  },

  drawGrid(ctx) {
    if (!this.state.currentImage) return;
    const step = 100;
    const width = this.state.currentImage.width;
    const height = this.state.currentImage.height;
    ctx.save();
    ctx.strokeStyle = 'rgba(148, 163, 184, 0.25)';
    ctx.lineWidth = 1 / this.state.scale;

    for (let x = step; x < width; x += step) {
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, height);
      ctx.stroke();
    }
    for (let y = step; y < height; y += step) {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(width, y);
      ctx.stroke();
    }

    ctx.restore();
  },

  drawZones(ctx) {
    if (!Array.isArray(this.state.zones) || !this.state.zones.length) return;

    ctx.save();
    this.state.zones.forEach(zone => {
      if (!Array.isArray(zone.points) || zone.points.length < 3) return;
      const color = zone.color || '#5a6b7a';
      const opacity = typeof zone.opacity === 'number' ? zone.opacity : 0.35;
      ctx.beginPath();
      zone.points.forEach((point, index) => {
        if (index === 0) ctx.moveTo(point.x, point.y);
        else ctx.lineTo(point.x, point.y);
      });
      ctx.closePath();
      ctx.fillStyle = this.hexToRgba(color, opacity);
      ctx.strokeStyle = zone.id === this.state.highlightZoneId ? '#8a7a5a' : color;
      ctx.lineWidth = zone.id === this.state.highlightZoneId ? 3 / this.state.scale : 2 / this.state.scale;
      ctx.fill();
      ctx.stroke();

      const centroid = this.calculateCentroid(zone.points);
      if (centroid) {
        ctx.save();
        ctx.fillStyle = zone.id === this.state.highlightZoneId ? '#8a7a5a' : '#d4d4d4';
        ctx.font = `${Math.max(12, 24 / this.state.scale)}px "Segoe UI", sans-serif`;
        ctx.textAlign = 'center';
        ctx.fillText(zone.name || 'Zona', centroid.x, centroid.y);
        ctx.restore();
      }
    });
    ctx.restore();
  },

  drawTempShape(ctx) {
    if (!this.state.drawing || this.state.tempPoints.length === 0) return;

    ctx.save();
    ctx.strokeStyle = 'rgba(59, 130, 246, 0.9)';
    ctx.fillStyle = 'rgba(59, 130, 246, 0.15)';
    ctx.lineWidth = 2 / this.state.scale;

    ctx.beginPath();
    this.state.tempPoints.forEach((point, index) => {
      if (index === 0) ctx.moveTo(point.x, point.y);
      else ctx.lineTo(point.x, point.y);
    });

    if (this.state.previewPoint) {
      ctx.lineTo(this.state.previewPoint.x, this.state.previewPoint.y);
    }

    if (this.state.tempPoints.length >= 2) {
      ctx.fill();
    }
    ctx.stroke();

    ctx.fillStyle = '#5a6b7a';
    this.state.tempPoints.forEach(point => {
      ctx.beginPath();
      ctx.arc(point.x, point.y, 4 / this.state.scale, 0, Math.PI * 2);
      ctx.fill();
    });
    ctx.restore();
  },

  registerCanvasEvents() {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    canvas.addEventListener('mousedown', (event) => {
      if (event.button === 0) {
        if (this.state.drawing) {
          this.addPoint(event);
        } else {
          this.beginPan(event);
        }
      }
    });

    canvas.addEventListener('mousemove', (event) => {
      if (this.state.drawing) {
        this.updatePreviewPoint(event);
      } else if (this.state.isPanning) {
        this.pan(event);
      }
    });

    ['mouseup', 'mouseleave'].forEach(type => {
      canvas.addEventListener(type, () => this.endPan());
    });

    canvas.addEventListener('wheel', (event) => this.handleWheel(event));

    canvas.addEventListener('dblclick', (event) => {
      if (this.state.drawing) {
        event.preventDefault();
        this.finishDrawing();
      }
    });

    canvas.addEventListener('contextmenu', (event) => {
      if (this.state.drawing) {
        event.preventDefault();
        this.finishDrawing();
      }
    });
  },

  beginPan(event) {
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    this.state.isPanning = true;
    this.state.panStartX = canvasX - this.state.offsetX;
    this.state.panStartY = canvasY - this.state.offsetY;
    this.elements.canvas.style.cursor = 'grabbing';
  },

  pan(event) {
    if (!this.state.isPanning) return;
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    this.state.offsetX = canvasX - this.state.panStartX;
    this.state.offsetY = canvasY - this.state.panStartY;
    this.draw();
  },

  endPan() {
    if (this.state.isPanning) {
      this.state.isPanning = false;
      this.elements.canvas.style.cursor = this.state.drawing ? 'crosshair' : 'grab';
    }
  },

  handleWheel(event) {
    if (!this.state.currentImage) return;
    event.preventDefault();
    const delta = event.deltaY > 0 ? 0.85 : 1.15;
    const coords = this.getCanvasCoordinates(event);
    this.zoomAt(coords.canvasX, coords.canvasY, delta);
  },

  zoomAt(canvasX, canvasY, factor) {
    const newScale = Math.max(this.state.minScale, Math.min(this.state.maxScale, this.state.scale * factor));
    if (newScale === this.state.scale) return;

    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;

    this.state.scale = newScale;
    this.state.offsetX = canvasX - worldX * newScale;
    this.state.offsetY = canvasY - worldY * newScale;
    this.draw();
  },

  handleToolbarAction(action) {
    switch (action) {
      case 'zoom-in':
        this.zoomCentered(1.2);
        break;
      case 'zoom-out':
        this.zoomCentered(1 / 1.2);
        break;
      case 'reset-view':
        this.resetView();
        break;
      case 'toggle-grid':
        this.toggleGrid();
        break;
      case 'recenter':
        this.recenter();
        break;
      default:
        console.debug('Accin de toolbar no implementada:', action);
    }
  },

  zoomCentered(factor) {
    if (!this.state.currentImage) return;
    const canvas = this.elements.canvas;
    const canvasX = canvas.width / 2;
    const canvasY = canvas.height / 2;
    this.zoomAt(canvasX, canvasY, factor);
  },

  resetView() {
    this.state.scale = 1;
    this.state.offsetX = 0;
    this.state.offsetY = 0;
    this.draw();
  },

  recenter() {
    if (!this.state.currentImage) return;
    const canvas = this.elements.canvas;
    const centerX = (this.state.currentImage.width / 2) * this.state.scale;
    const centerY = (this.state.currentImage.height / 2) * this.state.scale;
    this.state.offsetX = canvas.width / 2 - centerX;
    this.state.offsetY = canvas.height / 2 - centerY;
    this.draw();
  },

  toggleGrid() {
    this.state.showGrid = !this.state.showGrid;
    this.draw();
    this.showToast(this.state.showGrid ? 'Rejilla activada.' : 'Rejilla desactivada.', 'info');
  },

  getCanvasCoordinates(event) {
    const canvas = this.elements.canvas;
    const rect = canvas.getBoundingClientRect();
    const cssScaleX = canvas.width / rect.width;
    const cssScaleY = canvas.height / rect.height;
    const canvasX = (event.clientX - rect.left) * cssScaleX;
    const canvasY = (event.clientY - rect.top) * cssScaleY;
    return { canvasX, canvasY };
  },

  getMapPoint(event) {
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const mapX = (canvasX - this.state.offsetX) / this.state.scale;
    const mapY = (canvasY - this.state.offsetY) / this.state.scale;
    return { mapX, mapY, canvasX, canvasY };
  },

  addPoint(event) {
    const { mapX, mapY } = this.getMapPoint(event);
    if (!Number.isFinite(mapX) || !Number.isFinite(mapY)) return;

    if (this.state.tempPoints.length >= 3) {
      const firstPoint = this.state.tempPoints[0];
      const distance = Math.hypot(firstPoint.x - mapX, firstPoint.y - mapY);
      if (distance <= 15) {
        this.finishDrawing();
        return;
      }
    }

    this.state.tempPoints.push({ x: mapX, y: mapY });
    this.draw();
  },

  updatePreviewPoint(event) {
    const { mapX, mapY } = this.getMapPoint(event);
    this.state.previewPoint = { x: mapX, y: mapY };
    this.draw();
  },

  finishDrawing() {
    if (this.state.tempPoints.length < 3) {
      this.showToast('Necesitas al menos 3 puntos para crear una zona.', 'warning');
      return;
    }

    this.openZoneModal();
  },

  toggleDrawingMode() {
    if (!mapStorage.initialized || !this.state.currentMapId) {
      this.showToast('Selecciona un mapa antes de dibujar una zona.', 'info');
      return;
    }

    if (this.state.drawing) {
      this.cancelDrawing();
    } else {
      this.state.drawing = true;
      this.state.tempPoints = [];
      this.state.previewPoint = null;
      this.state.highlightZoneId = null;
      if (this.elements.drawBtn) {
        this.elements.drawBtn.textContent = 'Finalizar zona';
        this.elements.drawBtn.classList.add('map-btn--primary');
      }
      this.showHint('Modo dibujo activo: haz clic para agregar puntos. Doble clic o clic derecho para cerrar.');
      this.elements.canvas.style.cursor = 'crosshair';
    }
  },

  cancelDrawing() {
    this.state.drawing = false;
    this.state.tempPoints = [];
    this.state.previewPoint = null;
    if (this.elements.drawBtn) {
      this.elements.drawBtn.textContent = 'Dibujar zona';
      this.elements.drawBtn.classList.remove('map-btn--primary');
    }
    this.hideHint();
    this.elements.canvas.style.cursor = 'grab';
    this.draw();
  },

  openZoneModal() {
    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) return;

    this.elements.modalTitle.textContent = 'Definir nueva zona';

    const jerarquia = app?.opcionesJerarquia || {};
    const buildDatalist = (id, values) => {
      if (!Array.isArray(values) || !values.length) return '';
      return `<datalist id="${id}">${values.map(v => `<option value="${this.escapeHtml(v)}"></option>`).join('')}</datalist>`;
    };

    body.innerHTML = `
      <form id="mapZoneForm" class="map-zone-form">
        <div class="form-group">
          <label>Nombre de la zona</label>
          <input type="text" name="zoneName" required placeholder="Ej: Planta Principal" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Color</label>
            <input type="color" name="zoneColor" value="#5a6b7a" />
          </div>
          <div class="form-group">
            <label>Opacidad</label>
            <input type="range" name="zoneOpacity" min="10" max="90" value="35" />
          </div>
        </div>
        <div class="form-group">
          <label>Nivel 1  rea general</label>
          <input type="text" name="nivel1" list="nivel1List" placeholder="Ej: Planta Principal" />
          ${buildDatalist('nivel1List', jerarquia.areaGeneral)}
        </div>
        <div class="form-group">
          <label>Nivel 2  Sub-rea</label>
          <input type="text" name="nivel2" list="nivel2List" placeholder="Ej: Lnea de Eviscerado" />
          ${buildDatalist('nivel2List', jerarquia.subArea)}
        </div>
        <div class="form-group">
          <label>Nivel 3  Sistema / Equipo</label>
          <input type="text" name="nivel3" list="nivel3List" placeholder="Ej: Grader Baader" />
          ${buildDatalist('nivel3List', jerarquia.sistemaEquipo)}
        </div>
        <div class="form-group">
          <label>Nivel 4  Sub-sistema</label>
          <input type="text" name="nivel4" list="nivel4List" placeholder="Ej: Cinta Zeta" />
          ${buildDatalist('nivel4List', jerarquia.subSistema)}
        </div>
        <div class="form-group">
          <label>Nivel 5  Seccin</label>
          <input type="text" name="nivel5" list="nivel5List" placeholder="Ej: Mdulo 1" />
          ${buildDatalist('nivel5List', jerarquia.seccion)}
        </div>
        <div class="form-group">
          <label>Equipos / mquinas (uno por lnea)</label>
          <textarea name="equipos" rows="4" placeholder="Ej:\nMotor principal\nBanda transportadora"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>
          <button type="submit" class="map-btn map-btn--primary">Guardar zona</button>
        </div>
      </form>
    `;

    modal.classList.remove('hidden');

    const form = body.querySelector('#mapZoneForm');
    const cancelBtn = body.querySelector('[data-action="cancel"]');
    if (cancelBtn) cancelBtn.addEventListener('click', () => {
      this.closeModal();
      this.cancelDrawing();
    });

    if (form) {
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        this.saveZoneFromModal(new FormData(form));
      });
    }
  },

  closeModal() {
    const modal = this.elements.modal;
    if (modal) {
      modal.classList.add('hidden');
    }
    this.elements.modalBody.innerHTML = '';
    this.elements.modalTitle.textContent = '';
  },

  async saveZoneFromModal(formData) {
    const name = (formData.get('zoneName') || '').toString().trim();
    if (!name) {
      this.showToast('Asigna un nombre a la zona.', 'warning');
      return;
    }

    const color = (formData.get('zoneColor') || '#5a6b7a').toString();
    const opacityValue = parseInt(formData.get('zoneOpacity'), 10);
    const opacity = Number.isFinite(opacityValue) ? opacityValue / 100 : 0.35;

    const jerarquia = {
      nivel1: (formData.get('nivel1') || '').toString().trim() || null,
      nivel2: (formData.get('nivel2') || '').toString().trim() || null,
      nivel3: (formData.get('nivel3') || '').toString().trim() || null,
      nivel4: (formData.get('nivel4') || '').toString().trim() || null,
      nivel5: (formData.get('nivel5') || '').toString().trim() || null
    };

    const equiposRaw = (formData.get('equipos') || '').toString();
    const equipos = equiposRaw
      .split(/\r?\n/)
      .map(line => line.trim())
      .filter(Boolean);

    const zone = {
      id: Date.now(),
      mapId: this.state.currentMapId,
      name,
      color,
      opacity,
      points: [...this.state.tempPoints],
      jerarquia,
      equipos,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    try {
      const zones = [...(mapStorage.zones || []), zone];
      await mapStorage.saveZones(zones, { action: 'create', mapId: zone.mapId, zoneId: zone.id, detail: zone.name });
      this.state.zones = mapStorage.getZonesByMap(zone.mapId);
      this.renderZoneList(this.state.zones);
      this.state.highlightZoneId = zone.id;
      this.closeModal();
      this.cancelDrawing();
      this.draw();
      this.showToast('Zona guardada correctamente.', 'success');
      this.updateMetaBadge();

      if (typeof app?.aprenderNuevaOpcion === 'function') {
        Object.entries(jerarquia).forEach(([nivel, valor]) => {
          if (valor) {
            app.aprenderNuevaOpcion(nivel, valor);
          }
        });
      }
    } catch (error) {
      console.error('Error guardando la zona:', error);
      this.showToast('No se pudo guardar la zona. Revisa la consola.', 'error');
    }
  },

  focusZone(zoneId) {
    const zone = this.state.zones.find(z => z.id == zoneId);
    if (!zone || !Array.isArray(zone.points) || zone.points.length < 1) return;

    this.state.highlightZoneId = zone.id;

    const xs = zone.points.map(p => p.x);
    const ys = zone.points.map(p => p.y);
    const minX = Math.min(...xs);
    const maxX = Math.max(...xs);
    const minY = Math.min(...ys);
    const maxY = Math.max(...ys);

    const zoneWidth = Math.max(1, maxX - minX);
    const zoneHeight = Math.max(1, maxY - minY);
    const canvas = this.elements.canvas;

    const scaleX = (canvas.width * 0.6) / zoneWidth;
    const scaleY = (canvas.height * 0.6) / zoneHeight;
    const targetScale = Math.min(scaleX, scaleY, this.state.maxScale);

    this.state.scale = Math.max(this.state.minScale, targetScale);
    const centerX = (minX + maxX) / 2;
    const centerY = (minY + maxY) / 2;
    this.state.offsetX = canvas.width / 2 - centerX * this.state.scale;
    this.state.offsetY = canvas.height / 2 - centerY * this.state.scale;

    this.draw();
  },

  updateMetaBadge() {
    const badge = this.elements.metaBadge;
    if (!badge) return;
    if (!this.state.currentMap) {
      badge.textContent = 'Sin mapa';
      return;
    }
    const map = this.state.currentMap;
    const zonesCount = this.state.zones.length;
    const dimensions = map.width && map.height ? `${map.width} × ${map.height}px` : 'Dimensiones pendientes';
    badge.textContent = `${map.name} × ${dimensions}  ${zonesCount} zona(s)`;
  },

  updateZoomBadge() {
    const badge = this.elements.zoomBadge;
    if (!badge) return;
    badge.textContent = `${Math.round(this.state.scale * 100)}%`;
  },

  calculateCentroid(points) {
    if (!Array.isArray(points) || points.length === 0) return null;
    const sum = points.reduce((acc, point) => {
      acc.x += point.x;
      acc.y += point.y;
      return acc;
    }, { x: 0, y: 0 });
    return {
      x: sum.x / points.length,
      y: sum.y / points.length
    };
  },

  openNewMapModal() {
    if (!mapStorage.initialized) {
      this.showToast('Conecta la carpeta antes de crear un mapa.', 'info');
      return;
    }

    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) return;

    this.elements.modalTitle.textContent = 'Nuevo mapa';
    body.innerHTML = `
      <form id="mapCreateForm" class="map-zone-form">
        <div class="form-group">
          <label>Nombre del mapa</label>
          <input type="text" name="mapName" required placeholder="Ej: Planta principal" />
        </div>
        <div class="form-group">
          <label>Imagen del mapa</label>
          <input type="file" name="mapImage" accept="image/*" required />
          <small style="color: var(--text-secondary); font-size: 0.75rem;">Se recomienda usar imgenes en alta resolucin (PNG, JPG o WEBP).</small>
        </div>
        <div class="form-actions">
          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>
          <button type="submit" class="map-btn map-btn--primary">Guardar mapa</button>
        </div>
      </form>
    `;

    modal.classList.remove('hidden');

    const form = body.querySelector('#mapCreateForm');
    const cancelBtn = body.querySelector('[data-action="cancel"]');

    if (cancelBtn) cancelBtn.addEventListener('click', () => this.closeModal());
    if (form) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        await this.createMapFromForm(formData);
      });
    }
  },

  async createMapFromForm(formData) {
    const name = (formData.get('mapName') || '').toString().trim();
    const file = formData.get('mapImage');
    if (!name) {
      this.showToast('Asigna un nombre al mapa.', 'warning');
      return;
    }
    if (!(file instanceof File)) {
      this.showToast('Selecciona una imagen para el mapa.', 'warning');
      return;
    }

    try {
      await mapStorage.ensureStructure();
      const timestamp = Date.now();
      const extension = (file.name.split('.').pop() || 'png').toLowerCase();
      const safeExtension = extension.length <= 5 ? extension : 'png';
      const fileName = `map_${timestamp}.${safeExtension}`;
      let mapDir = mapStorage.mapImagesDir;
      if (!mapDir) {
        mapDir = await mapStorage.rootHandle.getDirectoryHandle('imagenes', { create: true });
        mapDir = await mapDir.getDirectoryHandle('mapas', { create: true });
        mapStorage.mapImagesDir = mapDir;
      }

      const fileHandle = await mapDir.getFileHandle(fileName, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(file);
      await writable.close();

      const dimensions = await this.getImageDimensions(file);

      const mapRecord = {
        id: timestamp,
        name,
        imagePath: `${mapStorage.mapImagesPath.join('/')}/${fileName}`,
        width: dimensions.width,
        height: dimensions.height,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      const updatedMaps = [...(mapStorage.maps || []), mapRecord];
      await mapStorage.saveMaps(updatedMaps, { action: 'create', mapId: mapRecord.id, detail: mapRecord.name });

      this.closeModal();
      await this.loadData();
      await this.selectMap(mapRecord.id);
      this.showToast('Mapa creado correctamente.', 'success');
    } catch (error) {
      console.error('Error creando mapa:', error);
      this.showToast('No se pudo crear el mapa. Revisa la consola.', 'error');
    }
  },

  async getImageDimensions(file) {
    return new Promise((resolve) => {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        resolve({ width: img.width, height: img.height });
        URL.revokeObjectURL(url);
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        resolve({ width: 0, height: 0 });
      };
      img.src = url;
    });
  },

  async refreshLog() {
    const events = mapStorage.initialized ? await mapStorage.readLog(30) : [];
    this.renderLog(events);
  },

  renderLog(events) {
    const { logList } = this.elements;
    if (!logList) return;

    if (!Array.isArray(events) || !events.length) {
      logList.innerHTML = `<div style="color: var(--text-secondary);">Sin eventos registrados.</div>`;
      return;
    }

    logList.innerHTML = events.map(event => {
      const timestamp = event.timestamp ? new Date(event.timestamp).toLocaleString('es-CL') : '';
      const scope = event.scope || 'maps';
      const action = event.action || 'update';
      const detail = event.detail ? `  ${this.escapeHtml(event.detail)}` : '';
      return `<div class="map-log-entry"><time>${timestamp}</time><span>${scope} × ${action}${detail}</span></div>`;
    }).join('');
  },

  showHint(text) {
    const hint = this.elements.hint;
    if (!hint) return;
    hint.textContent = text;
    hint.classList.remove('hidden');
  },

  hideHint() {
    const hint = this.elements.hint;
    if (!hint) return;
    hint.classList.add('hidden');
  },

  escapeHtml(text) {
    return text
      .toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  },

  hexToRgba(hex, alpha = 0.35) {
    let normalized = hex.replace('#', '').trim();
    if (normalized.length === 3) {
      normalized = normalized.split('').map(char => char + char).join('');
    }
    const bigint = parseInt(normalized, 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  },

  showToast(message, type = 'info') {
    if (typeof app?.showToast === 'function') {
      app.showToast(message, type);
    } else {
      console.log(`[${type}] ${message}`);
    }
  }
};

// IndexedDB Manager comentado temporalmente (no implementado en v6.0)
// const indexedDBManager = new IndexedDBImageManager();

// if (!('showDirectoryPicker' in window)) {
//   indexedDBManager.init().then(() => {
//     console.log('  IndexedDB Manager inicializado para modo mvil');
//   }).catch(err => {
//     console.error('- Error al inicializar IndexedDB:', err);
//   });
// }

const globalBlobCache = new Map();

// Funcin para obtener o crear Blob URL con cach global
async function getCachedBlobUrl(filename, loadFunction) {
  if (globalBlobCache.has(filename)) {
    const cached = globalBlobCache.get(filename);
    console.log(`  [CACH GLOBAL] Reutilizando: ${filename}`);
    return cached.url;
  }
  
  const url = await loadFunction();
  if (url) {
    // Guardar con referencia fuerte
    globalBlobCache.set(filename, {
      url: url,
      timestamp: Date.now(),
      filename: filename
    });
    console.log(`- [CACH GLOBAL] Guardado: ${filename} (Total: ${globalBlobCache.size})`);
  }
  return url;
}

function activarModoFileSystem() {
  if (!('showDirectoryPicker' in window)) {
    alert('Tu navegador no soporta FileSystem Access API.\n\nPor favor usa:\n Google Chrome 86+\n Microsoft Edge 86+');
    return;
  }
  fsManager.selectFolder().then(ok => {
    if (ok) {
      document.getElementById('fsBadge').style.display = 'inline';
      alert('Almacenamiento Ilimitado activado!\n\nAhora puedes agregar INFINITAS imgenes.\nCarpeta: ' + fsManager.folderPath);
    }
  });
}

// FUNCIN TOGGLE PARA ACTIVAR/DESACTIVAR ALMACENAMIENTO ILIMITADO
function toggleModoFileSystem() {
  if (fsManager.isFileSystemMode) {
    // Si est activo, mostrar confirmacin para desactivar
    const confirmar = confirm(
      'Almacenamiento Ilimitado ACTIVO\n\n' +
      'Deseas DESACTIVAR el almacenamiento ilimitado?\n\n' +
      'Se volver al modo localStorage (lmite 10MB)\n' +
      'Los datos guardados en la carpeta NO se perdern'
    );
    if (confirmar) {
      desactivarModoFileSystem();
    }
  } else {
    // Si est inactivo, activar
    activarModoFileSystem();
  }
}

//   FUNCIN PARA DESACTIVAR MODO FILESYSTEM
function desactivarModoFileSystem() {
  console.log('  Desactivando modo FileSystem...');
  
  // Limpiar estado del FileSystemManager
  fsManager.isFileSystemMode = false;
  fsManager.directoryHandle = null;
  fsManager.imagesFolder = null;
  fsManager.folderPath = null;
  
  // Limpiar localStorage
  localStorage.removeItem('fsDirectory');
  localStorage.removeItem('fsFolderName');
  
  // Eliminar base de datos IndexedDB
  const deleteRequest = indexedDB.deleteDatabase(fsManager.dbName);
  deleteRequest.onsuccess = () => {
    console.log('- Base de datos IndexedDB eliminada');
  };
  deleteRequest.onerror = () => {
    console.warn('  No se pudo eliminar la base de datos IndexedDB');
  };
  
  // Actualizar indicador visual
  fsManager.updateStatusIndicator(false);
  document.getElementById('fsBadge').style.display = 'none';
  
  // Mostrar notificacin
  if (typeof app !== 'undefined' && app.showToast) {
    app.showToast('  Modo Carpeta DESACTIVADO - Volviendo a localStorage (lmite 10MB)', 'error', 4000);
  } else {
    alert('  Modo Carpeta DESACTIVADO\n\nAhora usars localStorage con lmite de 10MB');
  }
  
  console.log('- Modo FileSystem desactivado completamente');
}


window.mapController = mapController;


  // ========================================
  // MODULO CORE (core.js)
  // ========================================
  // ========================================
// MÓDULO CORE
// Clase principal InventarioCompleto
// ========================================

// [REMOVED IMPORT]
// [REMOVED IMPORT]

// ===================================================================
// CACHÉ GLOBAL DE BLOB URLs (Prevenir Garbage Collection)
// ===================================================================
// NOTA: globalBlobCache ya está declarado anteriormente en línea 5088

// Función para obtener o crear Blob URL con caché global
async function getCachedBlobUrl(filename, loadFunction) {
  if (globalBlobCache.has(filename)) {
    const cached = globalBlobCache.get(filename);
    console.log(`  [CACHÉ GLOBAL] Reutilizando: ${filename}`);
    return cached.url;
  }
  
  const url = await loadFunction();
  if (url) {
    // Guardar con referencia fuerte
    globalBlobCache.set(filename, {
      url: url,
      timestamp: Date.now(),
      filename: filename
    });
    console.log(`✅ [CACHÉ GLOBAL] Guardado: ${filename} (Total: ${globalBlobCache.size})`);
  }
  return url;
}

class InventarioCompleto {
  constructor() {
    this.repuestos = [];
    this.conteoData = {};
    this.conteoActivo = false;
    this.currentView = 'cards';
    this.currentTab = 'inventario';
    this.mapTool = 'pan'; // Herramienta por defecto para mover el mapa
    this.mapObjects = []; // {type, x, y, w, h, r, name, color, locked, id, cuadrante}
    this.selectedObject = null; // Objeto seleccionado para editar
    this.showGrid = true; // Mostrar rejilla
    this.showCuadrantes = true; // Mostrar cuadrantes
    this.cuadrantesConfig = { filas: 8, columnas: 8 }; // 8x8 por defecto (como ajedrez)
    this.mapImage = null;
    this.currentMultimedia = [];
    this.currentDocuments = [];
    this.currentEditingId = null;
    this.currentPage = 1;
    this.itemsPerPage = 'auto'; // Modo automtico responsive por defecto
    this.itemsPerPageManual = 21; // Valor manual cuando no es auto
    this.viewMode = localStorage.getItem('viewMode') || 'auto'; // 'auto', 'mobile', 'desktop'
    this.isEdge = this.detectEdge(); // Detectar si es Microsoft Edge
    this.isEdgeIOS = false; // Se setea en detectEdge() si es Edge iOS
    this.filteredRepuestos = [];
    this.showPrecio = false;
    this.autocompleteData = { codProv: [], tipo: [], area: [], equipo: [] };
    this.lightboxMedias = [];
    this.lightboxIndex = 0;
    this.canvas = null;
    this.ctx = null;
    this.listSortField = 'codSAP';
    this.listSortOrder = 'asc';
    this.columnWidths = ['50px', '0.9fr', '1.5fr', '160px', '220px'];
    
    // Sistema de Mapa Avanzado
    this.mapViewMode = 'embedded'; // 'embedded', 'floating', 'fullscreen'
    this.mapLayers = []; // Array de capas [{id, name, image, visible, opacity, locked}]
    this.selectedLayer = null; // Capa seleccionada actualmente
    this.mapZoom = 1.0;
    this.mapPanX = 0;
    this.mapPanY = 0;
    this.mapIsPanning = false;
    this.mapLastPanX = 0;
    this.mapLastPanY = 0;
    this.floatingWindowPos = { x: 100, y: 100, width: 800, height: 600 };
    this.isResizing = false;
    this.resizeEdge = null;
    
    // Variables para edicin de objetos con handles
    this.isDraggingObject = false;
    this.isResizingObject = false;
    this.resizeHandle = null; // 'tl', 'tc', 'tr', 'rc', 'br', 'bc', 'bl', 'lc', 'radius'
    this.dragStartX = 0;
    this.dragStartY = 0;
    this.objectStartState = null;
    
    // Sistema de Zonas del Mapa (Vinculadas a Jerarqua)
    this.mapZones = []; // [{id, nombre, jerarquia: {planta, areaGeneral, subArea, sistemaEquipo...}, shape, coords, color}]
    this.mapProgramMode = false; // Modo programacin para crear zonas
    this.selectedZone = null; // Zona seleccionada
    this.highlightedZones = []; // Zonas resaltadas por filtro
    this.editingZoneId = null; // ID de zona en edicin
    this.selectedZoneColor = '#3b82f6'; // Color seleccionado para zona
    this.inventoryFocusId = null;
    this.jerarquiaFilter = '';
    this.jerarquiaCriticalOnly = false;
    
    this.sistemaPorEquipo = {
      'Grader': [
        'Pocket 1', 'Pocket 2', 'Pocket 3', 'Pocket 4',
        'Cinta Z', 'Cinta Aceleracin 1', 'Cinta Aceleracin 2', 'Cinta Larga',
        'Sistema Hidrulico', 'Sistema Neumtico', 'Panel Elctrico Principal',
        'Tablero Control', 'Motor Principal', 'Otro'
      ],
      'Compresor': [
        'Motor Principal', 'Tanque Almacenamiento', 'Vlvulas Control',
        'Sistema Refrigeracin', 'Panel Control', 'Filtros Aire', 'Otro'
      ],
      'Bomba': [
        'Motor Elctrico', 'Impulsor', 'Carcasa', 'Sellos Mecnicos',
        'Rodamientos', 'Base y Acople', 'Vlvulas', 'Otro'
      ],
      'Transportador': [
        'Banda/Cadena', 'Motor Traccin', 'Rodillos', 'Tensor',
        'Estructura Soporte', 'Sistema Guas', 'Otro'
      ],
      'default': [
        'Motor', 'Transmisin', 'Sistema Elctrico', 'Sistema Hidrulico',
        'Sistema Neumtico', 'Estructura', 'Controles', 'Otro'
      ]
    };
    
    this.customSistemas = this.loadCustomSistemas();
    
    this.plantaBase = 'Aquachile Antarfood Chonchi';
    
    // ===============================================
    // CONFIGURACIN DE ORGANIZACIN DE IMGENES
    // ===============================================
    this.nivelJerarquiaImagenes = parseInt(localStorage.getItem('nivelJerarquiaImagenes')) || 3;
    // 1 = Solo rea General
    // 2 = rea + Sistema/Equipo
    // 3 = Jerarqua Completa (rea > Subrea > Sistema)
    
    this.renombrarImagenesAutomaticamente = localStorage.getItem('renombrarImagenesAuto') !== 'false'; // true por defecto
    this.eliminarImagenAntiguaAlMover = localStorage.getItem('eliminarImagenAntigua') !== 'false'; // true por defecto
    this.longitudMaximaNombreArchivo = 100; // Mximo caracteres para nombres de archivo
    
    // Opciones predefinidas por defecto (solo se usan si no hay nada guardado)
    this.opcionesJerarquiaPredefinidas = {
      'areaGeneral': [
        'Planta Principal',
        'Acopio',
        'Planta Yal',
        'Estanques Agua',
        'Estanque Inox',
        'Entretecho',
        'Bodega General',
        'Zona Externa',
        'rea de Mantencin',
        'GENERAL'
      ],
      'subArea': [
        'Zona Norte',
        'Zona Sur',
        'Piso 1',
        'Piso 2',
        'Sector A',
        'Sector B',
        'Pasillo Central',
        'Lnea 1',
        'Lnea 2'
      ],
      'sistemaEquipo': [
        'Grader Marel',
        'Compresor Atlas Copco',
        'Cinta Transportadora 1',
        'Cinta Transportadora 2',
        'Bomba Principal',
        'Sistema Hidrulico',
        'Panel Elctrico Central',
        'Grader',
        'Compresor 01',
        'Compresor 02'
      ],
      'subSistema': [
        'Motor Principal',
        'Sistema de Lubricacin',
        'Tablero de Control',
        'Pocket 1',
        'Pocket 2',
        'Pocket 3',
        'Pocket 4',
        'Cinta Z',
        'Cinta Aceleracin 1',
        'Cinta Aceleracin 2',
        'Panel Elctrico'
      ],
      'seccion': [
        'Panel Elctrico',
        'Controles',
        'Sistema Hidrulico',
        'Sistema Neumtico',
        'Zona de Corte',
        'Sistema de Refrigeracin',
        'Vlvulas Control'
      ]
      // Nota: 'detalle' no tiene opciones predefinidas porque es texto libre
    };
    
    // Cargar opciones desde localStorage (o inicializar con predefinidas)
    this.opcionesJerarquia = {};
    this.loadOpcionesPersonalizadas();
    
    this.jerarquiaNiveles = [
      { id: 'planta', nombre: 'Empresa', requerido: true, visible: true },
      { id: 'areaGeneral', nombre: 'rea General', requerido: true, visible: true },
      { id: 'subArea', nombre: 'Sub-rea', requerido: false, visible: false },
      { id: 'sistemaEquipo', nombre: 'Sistema/Equipo', requerido: false, visible: true },
      { id: 'subSistema', nombre: 'Sub-Sistema', requerido: false, visible: false },
      { id: 'seccion', nombre: 'Seccin', requerido: false, visible: false },
      { id: 'detalle', nombre: 'Detalle/Ubicacin', requerido: false, visible: false }
    ];
    
    this.isMobile = this.detectMobile();
    this.hasFileSystemAPI = this.checkFileSystemAPI();
    this.storageMode = this.hasFileSystemAPI ? 'filesystem' : 'indexeddb';
    
    console.log(`  Dispositivo: ${this.isMobile ? 'Mvil' : 'PC'}`);
    console.log(`  Modo de almacenamiento: ${this.storageMode.toUpperCase()}`);
    console.log(`  File System API: ${this.hasFileSystemAPI ? '- Disponible' : '- No disponible'}`);
  }
  
  // NUEVO: Detectar si es dispositivo mvil
  detectMobile() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isMobileUA = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    const isSmallScreen = window.innerWidth < 768;
    
    return isMobileUA || (isTouchDevice && isSmallScreen);
  }
  
  // NUEVO: Verificar disponibilidad de File System Access API
  checkFileSystemAPI() {
    return 'showDirectoryPicker' in window;
  }

  // Detectar si el navegador es Microsoft Edge
  detectEdge() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isEdgeChromium = userAgent.includes('edg/'); // Edge Chromium (PC y mvil)
    const isEdgeLegacy = userAgent.includes('edge/'); // Edge Legacy (ya no se usa)
    const isIOS = /iphone|ipad|ipod/.test(userAgent);
    
    // - ACEPTAR Edge iOS tambin (aunque use WebKit)
    // El usuario ya est usando Edge, no tiene sentido pedirle que lo descargue
    if (isEdgeChromium && isIOS) {
      console.log('  Edge en iOS detectado - Modo mvil con IndexedDB');
      this.isEdgeIOS = true; // Flag especial para Edge iOS
      return true; // - S es Edge (aunque limitado)
    }
    
    this.isEdgeIOS = false;
    return isEdgeChromium || isEdgeLegacy;
  }

  // Mostrar advertencia si no es Edge
  showBrowserWarning() {
    // PRIORIDAD 1: Mostrar banner de mvil simplificado si no hay FileSystem
    if (this.isMobile && !this.hasFileSystemAPI) {
      console.log('  Modo Mvil Simplificado detectado');
      this.showMobileSimplifiedBanner();
      return;
    }
    
    if (this.isEdge) {
      // Si es Edge iOS, mostrar mensaje informativo suave
      if (this.isEdgeIOS) {
        console.log('  Microsoft Edge iOS detectado - Modo mvil activo');
        this.showEdgeIOSInfo();
        return;
      }
      
      console.log('- Microsoft Edge detectado - Experiencia optimizada');
      return;
    }

    const browserName = this.getBrowserName();
    const userAgent = navigator.userAgent.toLowerCase();
    const isIOS = /iphone|ipad|ipod/.test(userAgent);
    const isEdgeIOS = userAgent.includes('edg/') && isIOS;
    const isMobile = this.isMobile;
    const storageMode = this.storageMode;
    
    console.warn('  Navegador no optimizado:', browserName);

    // Mensaje especfico segn plataforma y navegador
    let warningMessage = '';
    
    if (isEdgeIOS) {
      warningMessage = 'Edge en iOS usa WebKit (motor de Safari) por restricciones de Apple. La app funciona en <strong>modo mvil con IndexedDB</strong> (lmite ~50-100MB). Para almacenamiento ilimitado, usa Edge en <strong>Windows</strong> o <strong>Android</strong>.';
    } else if (isMobile && storageMode === 'indexeddb') {
      warningMessage = 'Ests usando <strong>modo mvil con IndexedDB</strong> (lmite ~50-100MB para imgenes). Para almacenamiento ilimitado con File System API, usa <strong>Microsoft Edge en Windows/Android</strong>.';
    } else {
      warningMessage = 'Esta aplicacin est optimizada exclusivamente para <strong>Microsoft Edge</strong> en <strong>Windows</strong> y <strong>Android</strong>. Algunas funciones pueden no funcionar correctamente.';
    }

    // Crear banner de advertencia
    const banner = document.createElement('div');
    banner.id = 'browser-warning-banner';
    banner.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 99999;
        background: linear-gradient(135deg, var(--danger), #b91c1c);
        color: white;
        padding: 16px 20px;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        animation: slideDown 0.5s ease-out;
        flex-wrap: wrap;
      ">
        <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 250px;">
          <span style="font-size: 2rem;"> </span>
          <div>
            <div style="font-weight: 700; font-size: 1rem; margin-bottom: 4px;">
              Navegador No Optimizado: ${browserName}
            </div>
            <div style="font-size: 0.85rem; opacity: 0.95; line-height: 1.4;">
              ${warningMessage}
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <a href="https://www.microsoft.com/edge" target="_blank" 
             style="
               padding: 10px 20px;
               background: var(--primary);
               color: white;
               border-radius: 6px;
               text-decoration: none;
               font-weight: 600;
               white-space: nowrap;
               box-shadow: var(--shadow-md);
               transition: all 0.3s ease;
             "
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-lg)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-md)'">
              Descargar Edge
          </a>
          <button onclick="document.getElementById('browser-warning-banner').style.display='none'" 
                  style="
                    padding: 10px 16px;
                    background: rgba(255,255,255,0.2);
                    color: white;
                    border: 1px solid rgba(255,255,255,0.4);
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    white-space: nowrap;
                    transition: all 0.2s ease;
                  "
                  onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                  onmouseout="this.style.background='rgba(255,255,255,0.2)'">
            - Cerrar
          </button>
        </div>
      </div>
      <style>
        @keyframes slideDown {
          from {
            transform: translateY(-100%);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }
        @media (max-width: 768px) {
          #browser-warning-banner > div {
            flex-direction: column !important;
            text-align: center;
          }
          #browser-warning-banner a,
          #browser-warning-banner button {
            width: 100%;
          }
        }
      </style>
    `;

    document.body.insertBefore(banner, document.body.firstChild);

    // Ajustar padding del body para que no se solape el contenido
    document.body.style.paddingTop = '120px';
  }
  
  // Mostrar info amigable para Edge iOS (sin alarmar al usuario)
  showEdgeIOSInfo() {
    // Crear banner informativo SUAVE (azul, no rojo)
    const banner = document.createElement('div');
    banner.id = 'edge-ios-info-banner';
    banner.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 99999;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
        color: white;
        padding: 12px 16px;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        animation: slideDown 0.5s ease-out;
        font-size: 0.9rem;
      ">
        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
          <span style="font-size: 1.5rem;"> </span>
          <div>
            <strong>Edge Mvil Detectado</strong>  
              Cmara +  - Galera/iCloud disponibles
          </div>
        </div>
        <button onclick="document.getElementById('edge-ios-info-banner').style.display='none'" 
                style="
                  padding: 6px 12px;
                  background: rgba(255,255,255,0.2);
                  color: white;
                  border: 1px solid rgba(255,255,255,0.3);
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.85rem;
                  font-weight: 600;
                "
                onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                onmouseout="this.style.background='rgba(255,255,255,0.2)'">
          - Entendido
        </button>
      </div>
      <style>
        @keyframes slideDown {
          from { transform: translateY(-100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        @media (max-width: 768px) {
          #edge-ios-info-banner > div {
            font-size: 0.85rem;
          }
        }
      </style>
    `;

    document.body.insertBefore(banner, document.body.firstChild);
    
    // Auto-cerrar despus de 5 segundos
    setTimeout(() => {
      const bannerEl = document.getElementById('edge-ios-info-banner');
      if (bannerEl) {
        bannerEl.style.transition = 'opacity 0.5s ease-out';
        bannerEl.style.opacity = '0';
        setTimeout(() => bannerEl.remove(), 500);
      }
    }, 5000);
  }

  // Mostrar banner de modo mvil simplificado (sin FileSystem)
  showMobileSimplifiedBanner() {
    const banner = document.createElement('div');
    banner.id = 'mobile-simplified-banner';
    banner.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 99999;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.95), rgba(124, 58, 237, 0.95));
        color: white;
        padding: 14px 16px;
        box-shadow: var(--shadow-lg);
        animation: slideDown 0.5s ease-out;
        font-size: 0.85rem;
      ">
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
              <span style="font-size: 1.8rem;"> </span>
              <div>
                <strong style="font-size: 1rem; display: block; margin-bottom: 3px;">
                  Modo Mvil Simplificado
                </strong>
                <span style="opacity: 0.95; font-size: 0.8rem;">
                  Solo datos  Sin fotos
                </span>
              </div>
            </div>
            <button onclick="document.getElementById('mobile-simplified-banner').style.display='none'" 
                    style="
                      padding: 6px 12px;
                      background: rgba(255,255,255,0.2);
                      color: white;
                      border: 1px solid rgba(255,255,255,0.3);
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 0.8rem;
                      font-weight: 600;
                      white-space: nowrap;
                    ">
              - Entendido
            </button>
          </div>
          
          <div style="
            background: rgba(255,255,255,0.15);
            padding: 10px 12px;
            border-radius: 6px;
            line-height: 1.5;
            font-size: 0.8rem;
          ">
            <strong style="display: block; margin-bottom: 6px;">- Funciones activas:</strong>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.75rem;">
              <span> Ver inventario</span>
              <span> Conteo rpido</span>
              <span> Agregar repuestos</span>
              <span> Buscar/Filtrar</span>
              <span> Editar datos</span>
              <span> Eliminar items</span>
            </div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.75rem;">
                <strong>Para fotos:</strong> Usa la versin de PC
            </div>
          </div>
        </div>
      </div>
      <style>
        @keyframes slideDown {
          from { transform: translateY(-100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
      </style>
    `;
    
    document.body.insertBefore(banner, document.body.firstChild);
    
    // Auto-cerrar despus de 8 segundos (ms tiempo para leer todo)
    setTimeout(() => {
      const bannerEl = document.getElementById('mobile-simplified-banner');
      if (bannerEl) {
        bannerEl.style.transition = 'opacity 0.5s ease-out';
        bannerEl.style.opacity = '0';
        setTimeout(() => bannerEl.remove(), 500);
      }
    }, 8000);
    
    console.log('  Banner de Modo Mvil Simplificado mostrado');
  }

  // Obtener nombre del navegador actual
  getBrowserName() {
    const userAgent = navigator.userAgent.toLowerCase();
    
    if (userAgent.includes('firefox')) return 'Mozilla Firefox';
    if (userAgent.includes('chrome') && !userAgent.includes('edg')) return 'Google Chrome';
    if (userAgent.includes('safari') && !userAgent.includes('chrome')) return 'Safari';
    if (userAgent.includes('opera') || userAgent.includes('opr')) return 'Opera';
    
    return 'Navegador Desconocido';
  }

  // Helper para obtener URL de imagen (soporta base64 Y rutas externas)
  async getImageUrl(media) {
    if (!media) return null;
    
    const fs = window.fsManager || fsManager;
    
    // Si es objeto con tipo: 'image' y url
    if ((media.tipo === 'image' || media.type === 'image') && media.url) {
      // Cargar desde FileSystem
      if (fs && fs.isConnected && (media.url.startsWith('./imagenes/') || media.url.startsWith('imagenes/'))) {
        try {
          const filename = media.url.replace('./imagenes/', '').replace('imagenes/', '');
          const blobUrl = await fs.loadImage(filename);
          if (blobUrl) return blobUrl;
        } catch (error) {
          console.warn(`⚠️ No se pudo cargar desde FileSystem: ${media.url}`);
        }
      }
      
      // Fallback a data si existe (base64)
      if (media.data && media.data.startsWith('data:image')) {
        return media.data;
      }
    }
    
    // Si es string simple
    if (typeof media === 'string') {
      // Base64 inline
      if (media.startsWith('data:image')) {
        return media;
      }
      // Ruta FileSystem
      if (media.startsWith('./imagenes/') || media.startsWith('imagenes/')) {
        if (fs && fs.isConnected) {
          try {
            const filename = media.replace('./imagenes/', '').replace('imagenes/', '');
            const blobUrl = await fs.loadImage(filename);
            if (blobUrl) return blobUrl;
          } catch (error) {
            console.warn(`⚠️ No se pudo cargar: ${media}`);
          }
        }
      }
    }
    
    return null;
  }

  async loadImageFromFileSystem(path) {
    // ===================================================================
    // CARGA UNIVERSAL DE IMGENES (FileSystem, IndexedDB o base64)
    // ===================================================================
    
    // CASO 1: Base64 inline (LocalStorage mode) - Retornar directamente
    if (path.startsWith('data:image')) {
      return path;
    }
    
    // CASO 2: IndexedDB ID (Mobile mode)
    if (path.startsWith('img_') && this.storageMode === 'indexeddb') {
      try {
        const imageData = await indexedDBManager.getImage(path);
        if (imageData && imageData.url) {
          console.log(`- IndexedDB: ${path} cargada`);
          return imageData.url;
        }
      } catch (error) {
        console.error(`- Error cargando desde IndexedDB: ${path}`, error);
        return null;
      }
    }
    
    // CASO 3: FileSystem path (PC mode con Edge)
    if (!fsManager.isFileSystemMode || !fsManager.imagesFolder) {
      console.warn('  No est en modo FileSystem o no hay carpeta imagenes configurada');
      console.warn('   isFileSystemMode:', fsManager.isFileSystemMode);
      console.warn('   imagesFolder:', fsManager.imagesFolder);
      console.warn('   Ruta solicitada:', path);
      return null;
    }

    try {
      // Extraer ruta relativa desde imagenes/
      const originalPath = path.replace('./imagenes/', '').replace('imagenes/', '');
      
      // Usar cach global con referencias fuertes (previene Garbage Collection)
      return await getCachedBlobUrl(originalPath, async () => {
        console.log(`  Cargando imagen desde FileSystem: ${originalPath}`);
        console.log(`   Desde carpeta: ${fsManager.folderPath}/imagenes/`);
        
        // Usar el handle de imgenes ya inicializado (mejor sincronizacin)
        const imagesFolder = fsManager.imagesFolder;
        if (!imagesFolder) {
          console.error('- No hay handle de carpeta imagenes inicializado');
          return null;
        }
        
        let fileHandle;
        let file;
        
        // ESTRATEGIA 1: Intentar buscar el archivo con su nombre original (codificado)
        try {
          fileHandle = await imagesFolder.getFileHandle(originalPath);
          file = await fileHandle.getFile();
          const blobUrl = URL.createObjectURL(file);
          console.log(`- Imagen cargada (codificada): ${originalPath} (${file.size} bytes)`);
          return blobUrl;
        } catch (error) {
          console.log(`     Archivo no encontrado en raz con nombre codificado`);
        }
        
        // ESTRATEGIA 2: Si tiene __, intentar decodificar y buscar en carpetas jerrquicas
        if (originalPath.includes('__')) {
          try {
            const decodedPath = this.decodificarRutaJerarquica(originalPath);
            console.log(`     Intentando ruta decodificada: ${decodedPath}`);
            
            if (decodedPath.includes('/')) {
              const parts = decodedPath.split('/');
              const filename = parts.pop();
              let currentFolder = imagesFolder;
              
              // Navegar por subcarpetas
              for (const folderName of parts) {
                currentFolder = await currentFolder.getDirectoryHandle(folderName);
              }
              
              fileHandle = await currentFolder.getFileHandle(filename);
              file = await fileHandle.getFile();
              const blobUrl = URL.createObjectURL(file);
              console.log(`- Imagen cargada (jerrquica): ${decodedPath} (${file.size} bytes)`);
              return blobUrl;
            }
          } catch (error) {
            console.log(`     Archivo no encontrado en carpetas jerrquicas`);
          }
        }
        
        // Si llegamos aqu, no se encontr el archivo
        throw new Error(`Archivo no encontrado: ${originalPath}`);
      });
    } catch (error) {
      console.error(`- Error cargando imagen desde FileSystem: ${path}`);
      console.error(`   Ruta original: ${path.replace('./imagenes/', '').replace('imagenes/', '')}`);
      console.error(`   Error: ${error.name} - ${error.message}`);
      return null;
    }
  }

  // Obtener primera imagen de multimedia array
  async getFirstImage(multimedia) {
    if (!multimedia || !Array.isArray(multimedia) || multimedia.length === 0) {
      return null;
    }

    // Filtrar multimedia válida (con URL)
    const multimediaValido = multimedia.filter(media =>
      media && (media.tipo === 'image' || media.type === 'image') && media.url && media.url.trim() !== ''
    );

    for (let i = 0; i < multimediaValido.length; i++) {
      const media = multimediaValido[i];
      try {
        const url = await this.getImageUrl(media);
        if (url) return url;
      } catch (error) {
        console.log(`⚠️ Imagen inválida detectada: ${media.url}`);
      }
    }

    return null;
  }

  // ===================================================================
  async renderZonaBadge(zonaMapaId) {
    if (!zonaMapaId) return '';

    try {
      const [mapIdRaw, zonaIdRaw] = zonaMapaId.split('|');
      const mapId = parseInt(mapIdRaw, 10);
      const zonaId = parseInt(zonaIdRaw, 10);

      let zona = null;
      let mapaNombre = `Mapa ${mapId}`;

      if (mapStorage?.initialized) {
        zona = (mapStorage.zones || []).find(z => z.mapId === mapId && z.id === zonaId);
        const mapa = mapStorage.getMapById(mapId);
        if (mapa) {
          mapaNombre = mapa.name || mapaNombre;
        }
      }

      if (!zona && fsManager?.isConnected && fsManager.storageHandle) {
        try {
          const zonasHandle = await fsManager.storageHandle.getFileHandle('zonas.json');
          const zonasFile = await zonasHandle.getFile();
          const zonasText = await zonasFile.text();
          const zonas = JSON.parse(zonasText);
          zona = zonas.find(z => z.mapId === mapId && z.id === zonaId) || null;

          const mapasHandle = await fsManager.storageHandle.getFileHandle('mapas.json');
          const mapasFile = await mapasHandle.getFile();
          const mapasText = await mapasFile.text();
          const mapas = JSON.parse(mapasText);
          const mapa = mapas.find(m => m.id === mapId);
          if (mapa) {
            mapaNombre = mapa.name || mapaNombre;
          }
        } catch (error) {
          console.warn('No se pudo cargar mapas/zona desde FileSystem:', error);
        }
      }

      if (!zona) {
        return '';
      }

      return `
        <div onclick="app.filterByZona('${zonaMapaId}')" style="
          background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
          color: white;
          padding: 8px 12px;
          border-radius: 8px;
          font-size: 0.75rem;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
          transition: all 0.2s ease;
          box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
          margin-top: 4px;
        "
        data-map-id="${mapId}"
        data-zone-id="${zonaId}"
        title="Click para filtrar por esta zona">
          <span style="font-size: 1rem;">&#128205;</span>
          <div style="display: flex; flex-direction: column; align-items: flex-start; line-height: 1.2;">
            <span style="font-size: 0.65rem; opacity: 0.9;">${mapaNombre}</span>
            <span style="font-weight: 700;">${zona.name}</span>
          </div>
        </div>
      `;
    } catch (error) {
      console.warn('Error renderizando badge de zona:', error.message);
    }

    return '';
  }

  filterByZona(zonaMapaId) {
    const filterSelect = document.getElementById('filterZonaMapa');
    if (filterSelect) {
      filterSelect.value = zonaMapaId;
      this.applyFilters();
      window.scrollTo({ top: 0, behavior: 'smooth' });
      this.showToast('Filtrando por zona seleccionada', 'success');
    }

    if (typeof this.switchTab === 'function') {
      this.switchTab('mapa');
    }

    if (typeof mapController?.selectMap === 'function') {
      const [mapIdRaw, zonaIdRaw] = zonaMapaId.split('|');
      const mapId = parseInt(mapIdRaw, 10);
      const zonaId = parseInt(zonaIdRaw, 10);

      mapController.selectMap(mapId, { keepViewport: false })
        .then(() => {
          if (typeof mapController.focusZone === 'function') {
            mapController.focusZone(zonaId);
          }
        })
        .catch(error => console.warn('No se pudo resaltar la zona en el mapa:', error));
    }
  }
  // LIMPIEZA DE REFERENCIAS INVLIDAS DE IMGENES
  // ===================================================================
  async sanitizeImageReferences() {
    const statusDiv = document.getElementById('sanitize-status');
    if (!statusDiv) {
      console.warn('Elemento sanitize-status no encontrado');
      return;
    }
    
    // Mostrar progreso inicial
    statusDiv.innerHTML = '  Iniciando limpieza...';
    statusDiv.style.color = '#ffa500';
    
    console.log('  Iniciando sanitizacin de referencias de imgenes...');
    
    let totalReferences = 0;
    let invalidReferences = 0;
    let repuestosModificados = 0;
    
    try {
      for (const repuesto of this.repuestos) {
        if (!repuesto.multimedia || !Array.isArray(repuesto.multimedia)) {
          continue;
        }
        
        const originalLength = repuesto.multimedia.length;
        totalReferences += originalLength;
        
        // Actualizar progreso
        statusDiv.innerHTML = `  Revisando ${totalReferences} referencias...`;
        
        // Filtrar referencias vlidas
        const validMultimedia = [];
        
        for (const media of repuesto.multimedia) {
          try {
            const imageUrl = await this.getImageUrl(media);
            if (imageUrl !== null) {
              // Imagen vlida, mantener referencia
              validMultimedia.push(media);
            } else {
              // Imagen invlida, eliminar
              invalidReferences++;
              console.log(` ? Referencia invlida eliminada: ${typeof media === 'string' ? media : media.url || 'sin URL'}`);
            }
          } catch (error) {
            // Error al verificar, considerar invlida
            invalidReferences++;
            console.log(`- Error verificando imagen, eliminada: ${error.message}`);
          }
        }
        
        // Actualizar array multimedia si cambi
        if (validMultimedia.length !== originalLength) {
          repuesto.multimedia = validMultimedia;
          repuestosModificados++;
        }
      }
      
      console.log(`- Sanitizacin completada:`);
      console.log(`     Total referencias revisadas: ${totalReferences}`);
      console.log(`    - Referencias invlidas eliminadas: ${invalidReferences}`);
      console.log(`     Repuestos modificados: ${repuestosModificados}`);
      
      // Mostrar resultados
      statusDiv.innerHTML = `
        - Limpieza completada<br>
          ${totalReferences} referencias revisadas<br>
         - ${invalidReferences} eliminadas<br>
          ${repuestosModificados} repuestos actualizados
      `;
      statusDiv.style.color = '#28a745';
      
      // Guardar datos sanitizados si se hicieron cambios
      if (invalidReferences > 0) {
        console.log('  Guardando datos sanitizados...');
        statusDiv.innerHTML += '<br>  Guardando cambios...';
        await this.saveData();
        statusDiv.innerHTML += '<br>- Datos guardados';
      }
      
      return { totalReferences, invalidReferences, repuestosModificados };
      
    } catch (error) {
      console.error('- Error durante la sanitizacin:', error);
      statusDiv.innerHTML = `- Error: ${error.message}`;
      statusDiv.style.color = '#dc3545';
      throw error;
    }
  }

  // ===================================================================
  // MOSTRAR ESTADSTICAS DEL SISTEMA
  // ===================================================================
  // ===================================================================
  // CREAR CARPETAS JERRQUICAS PARA REPUESTOS EXISTENTES
  // ===================================================================
  async crearCarpetasDesdeRepuestosExistentes() {
    console.log('  Iniciando creacin de carpetas jerrquicas desde repuestos existentes...');
    
    if (!fsManager.isFileSystemMode) {
      console.warn('  No est en modo FileSystem');
      return { success: false, message: 'No est en modo FileSystem' };
    }
    
    const statusDiv = document.getElementById('sanitize-status');
    if (statusDiv) {
      statusDiv.innerHTML = '  Creando carpetas jerrquicas...';
      statusDiv.style.color = '#007bff';
    }
    
    let carpetasCreadas = 0;
    let repuestosConUbicacion = 0;
    let errores = 0;
    
    try {
      for (const repuesto of this.repuestos) {
        // Verificar si el repuesto tiene ubicaciones
        if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones) && repuesto.ubicaciones.length > 0) {
          repuestosConUbicacion++;
          
          for (const ubicacion of repuesto.ubicaciones) {
            if (ubicacion.areaGeneral && ubicacion.areaGeneral.trim() !== '') {
              try {
                // Crear carpetas jerrquicas para esta ubicacin
                const carpetaDestino = await this.crearCarpetasJerarquicas(ubicacion);
                if (carpetaDestino) {
                  carpetasCreadas++;
                  console.log(`- Carpetas creadas para: ${repuesto.nombre} - ${ubicacion.areaGeneral}`);
                }
              } catch (error) {
                console.error(`- Error creando carpetas para ${repuesto.nombre}:`, error);
                errores++;
              }
            }
          }
        }
      }
      
      const resultado = {
        success: true,
        repuestosConUbicacion,
        carpetasCreadas,
        errores,
        message: `- Proceso completado: ${carpetasCreadas} carpetas creadas para ${repuestosConUbicacion} repuestos`
      };
      
      console.log('  Creacin de carpetas completada:', resultado);
      
      if (statusDiv) {
        statusDiv.innerHTML = `
          - Carpetas creadas<br>
            Repuestos con ubicacin: ${repuestosConUbicacion}<br>
            Carpetas creadas: ${carpetasCreadas}<br>
          ${errores > 0 ? `- Errores: ${errores}` : ''}
        `;
        statusDiv.style.color = errores > 0 ? '#ffc107' : '#28a745';
      }
      
      return resultado;
      
    } catch (error) {
      console.error('- Error general creando carpetas:', error);
      
      if (statusDiv) {
        statusDiv.innerHTML = `- Error: ${error.message}`;
        statusDiv.style.color = '#dc3545';
      }
      
      return { 
        success: false, 
        error: error.message,
        repuestosConUbicacion,
        carpetasCreadas,
        errores 
      };
    }
  }

  // ===================================================================
  // CORREGIR REFERENCIAS DE IMGENES MAL FORMADAS
  // ===================================================================
  async corregirReferenciasImagenes() {
    console.log('  Iniciando correccin de referencias de imgenes...');
    
    // Mostrar feedback en UI
    this.showToast('  Corrigiendo referencias de imgenes...', 'info');
    
    let referenciasCorregidas = 0;
    let repuestosModificados = 0;
    
    for (const repuesto of this.repuestos) {
      if (!repuesto.multimedia || !Array.isArray(repuesto.multimedia)) {
        continue;
      }
      
      let multimediaModificado = false;
      
      for (const media of repuesto.multimedia) {
        if (media.type === 'image' && media.url) {
          let urlOriginal = media.url;
          let urlCorregida = urlOriginal;
          
          // Caso 1: Referencia jerrquica sin prefijo ./imagenes/
          if (urlOriginal.includes('/') && !urlOriginal.startsWith('./imagenes/') && !urlOriginal.startsWith('imagenes/') && !urlOriginal.startsWith('data:') && !urlOriginal.startsWith('blob:')) {
            // Si es una ruta jerrquica sin prefijo, codificarla con __
            const nombreCodificado = this.codificarRutaJerarquica(urlOriginal);
            urlCorregida = `./imagenes/${nombreCodificado}`;
            
            console.log(`  Corrigiendo referencia: ${urlOriginal} - ${urlCorregida}`);
            referenciasCorregidas++;
            multimediaModificado = true;
          }
          
          // Caso 2: Referencia con prefijo pero ruta jerrquica sin codificar
          else if (urlOriginal.startsWith('./imagenes/') && urlOriginal.split('/').length > 2 && !urlOriginal.includes('__')) {
            // Es una ruta jerrquica sin codificar (ej: ./imagenes/PLANTA/archivo.webp)
            const rutaRelativa = urlOriginal.replace('./imagenes/', '');
            const nombreCodificado = this.codificarRutaJerarquica(rutaRelativa);
            urlCorregida = `./imagenes/${nombreCodificado}`;
            
            console.log(`  Codificando referencia: ${urlOriginal} - ${urlCorregida}`);
            referenciasCorregidas++;
            multimediaModificado = true;
          }
          
          // Actualizar la referencia si cambi
          if (urlCorregida !== urlOriginal) {
            media.url = urlCorregida;
          }
        }
      }
      
      if (multimediaModificado) {
        repuestosModificados++;
      }
    }
    
    // Guardar cambios si se hicieron correcciones
    if (referenciasCorregidas > 0) {
      console.log(`  Guardando ${referenciasCorregidas} referencias corregidas en ${repuestosModificados} repuestos...`);
      await this.saveData();
      this.showToast(`- ${referenciasCorregidas} referencias corregidas en ${repuestosModificados} repuestos`, 'success');
      
      // Refrescar vista para mostrar imgenes corregidas
      await this.render();
    } else {
      console.log('- No se encontraron referencias que corregir');
      this.showToast('- Todas las referencias estn correctas', 'success');
    }
    
    console.log(`- Correccin completada: ${referenciasCorregidas} referencias corregidas, ${repuestosModificados} repuestos modificados`);
    return { referenciasCorregidas, repuestosModificados };
  }
  async migrarImagenesACarpetasJerarquicas() {
    console.log('  Iniciando migracin de imgenes a carpetas jerrquicas...');
    
    if (!fsManager.isFileSystemMode) {
      console.warn('  No est en modo FileSystem');
      return { success: false, message: 'No est en modo FileSystem' };
    }
    
    const statusDiv = document.getElementById('sanitize-status');
    if (statusDiv) {
      statusDiv.innerHTML = '  Migrando imgenes a carpetas...';
      statusDiv.style.color = '#007bff';
    }
    
    let imagenesMigradas = 0;
    let imagenesSaltadas = 0;
    let errores = 0;
    
    try {
      for (const repuesto of this.repuestos) {
        // Verificar si el repuesto tiene multimedia y ubicaciones
        if (repuesto.multimedia && Array.isArray(repuesto.multimedia) && repuesto.multimedia.length > 0 &&
            repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones) && repuesto.ubicaciones.length > 0) {
          
          const ubicacion = repuesto.ubicaciones[0]; // Usar primera ubicacin
          
          if (ubicacion.areaGeneral && ubicacion.areaGeneral.trim() !== '') {
            // Crear carpetas jerrquicas
            const carpetaDestino = await this.crearCarpetasJerarquicas(ubicacion);
            
            if (carpetaDestino) {
              for (const media of repuesto.multimedia) {
                if (media.type === 'image' && media.url) {
                  try {
                    // Extraer nombre del archivo de la URL
                    const urlParts = media.url.split('/');
                    const filename = urlParts[urlParts.length - 1];
                    
                    // Si el archivo est en la raz (no tiene __ en el nombre), intentar migrarlo
                    if (filename && !filename.includes('__')) {
                      console.log(`  Migrando: ${filename} - carpeta jerrquica`);
                      
                      // Leer archivo desde raz
                      const imagesFolder = fsManager.imagesFolder;
                      if (!imagesFolder) {
                        console.error('- No hay handle de carpeta imagenes inicializado');
                        errores++;
                        continue;
                      }
                      const fileHandle = await imagesFolder.getFileHandle(filename);
                      const file = await fileHandle.getFile();
                      
                      // Guardar directamente en la carpeta jerrquica con el nombre original
                      await fsManager.saveImageJerarquica(await file.arrayBuffer(), filename, carpetaDestino);
                      
                      // Actualizar referencia en el repuesto para usar ruta jerrquica
                      const rutaJerarquica = this.generarRutaImagen(ubicacion).replace('./imagenes/', '') + '/' + filename;
                      media.url = `./imagenes/${rutaJerarquica}`;
                      
                      // Eliminar archivo antiguo
                      await imagesFolder.removeEntry(filename);
                      
                      imagenesMigradas++;
                      console.log(`- Migrada: ${filename} - ${rutaJerarquica}`);
                    } else {
                      imagenesSaltadas++;
                    }
                  } catch (error) {
                    console.error(`- Error migrando imagen ${media.url}:`, error);
                    errores++;
                  }
                }
              }
            }
          }
        }
      }
      
      // Guardar cambios si hubo migraciones
      if (imagenesMigradas > 0) {
        console.log('  Guardando cambios despus de migracin...');
        await this.saveData();
      }
      
      const resultado = {
        success: true,
        imagenesMigradas,
        imagenesSaltadas,
        errores,
        message: `- Migracin completada: ${imagenesMigradas} imgenes migradas, ${imagenesSaltadas} saltadas`
      };
      
      console.log('  Migracin completada:', resultado);
      
      if (statusDiv) {
        statusDiv.innerHTML = `
          - Migracin completada<br>
            Imgenes migradas: ${imagenesMigradas}<br>
            Imgenes saltadas: ${imagenesSaltadas}<br>
          ${errores > 0 ? `- Errores: ${errores}` : ''}
        `;
        statusDiv.style.color = errores > 0 ? '#ffc107' : '#28a745';
      }
      
      return resultado;
      
    } catch (error) {
      console.error('- Error general en migracin:', error);
      
      if (statusDiv) {
        statusDiv.innerHTML = `- Error: ${error.message}`;
        statusDiv.style.color = '#dc3545';
      }
      
      return { 
        success: false, 
        error: error.message,
        imagenesMigradas,
        imagenesSaltadas,
        errores 
      };
    }
  }

  showSystemStats() {
    const totalRepuestos = this.repuestos.length;
    const repuestosConImagenes = this.repuestos.filter(r => r.multimedia && r.multimedia.length > 0).length;
    const repuestosSinImagenes = totalRepuestos - repuestosConImagenes;
    
    let totalImagenes = 0;
    let imagenesPorTipo = { filesystem: 0, indexeddb: 0, base64: 0, externas: 0 };
    for(const repuesto of this.repuestos) {
      if (repuesto.multimedia && Array.isArray(repuesto.multimedia)) {
        totalImagenes += repuesto.multimedia.length;
        
        for (const media of repuesto.multimedia) {
          if (typeof media === 'string') {
            if (media.startsWith('data:image')) {
              imagenesPorTipo.base64++;
            } else if (media.startsWith('img_')) {
              imagenesPorTipo.indexeddb++;
            } else if (media.startsWith('./imagenes/') || media.startsWith('imagenes/')) {
              imagenesPorTipo.filesystem++;
            } else {
              imagenesPorTipo.externas++;
            }
          } else if (media.type === 'image' && media.url) {
            if (media.isFileSystem) {
              imagenesPorTipo.filesystem++;
            } else if (media.isIndexedDB) {
              imagenesPorTipo.indexeddb++;
            } else if (media.esArchivoExterno) {
              imagenesPorTipo.externas++;
            } else {
              imagenesPorTipo.base64++;
            }
          }
        }
      }
    }
    
    // Informacin de almacenamiento
    const storageMode = this.storageMode.toUpperCase();
    const hasFileSystem = this.hasFileSystemAPI ? 'SI' : 'NO';
    const isFileSystemMode = fsManager.isFileSystemMode ? 'ACTIVO' : 'INACTIVO';
    
    // Mostrar estadsticas
    statsDiv.innerHTML = `
      <div style="display: grid; gap: 8px; font-size: 0.8rem;">
        <div><strong>  Repuestos:</strong> ${totalRepuestos}</div>
        <div style="margin-left: 12px;"> Con imgenes: ${repuestosConImagenes}</div>
        <div style="margin-left: 12px;"> Sin imgenes: ${repuestosSinImagenes}</div>
        
        <div><strong> - Imgenes totales:</strong> ${totalImagenes}</div>
        <div style="margin-left: 12px;"> FileSystem: ${imagenesPorTipo.filesystem}</div>
        <div style="margin-left: 12px;"> IndexedDB: ${imagenesPorTipo.indexeddb}</div>
        <div style="margin-left: 12px;"> Base64: ${imagenesPorTipo.base64}</div>
        <div style="margin-left: 12px;"> Externas: ${imagenesPorTipo.externas}</div>
        
        <div><strong>  Almacenamiento:</strong> ${storageMode}</div>
        <div style="margin-left: 12px;"> FileSystem API: ${hasFileSystem}</div>
        <div style="margin-left: 12px;"> Modo FileSystem: ${isFileSystemMode}</div>
        
        <div><strong>  Plataforma:</strong> ${this.isMobile ? 'Mvil' : 'PC'}</div>
      </div>
    `;
  }

  loadCustomSistemas() {
    try {
      const stored = localStorage.getItem('inventarioCustomSistemas');
      return stored ? JSON.parse(stored) : {};
    } catch (error) {
      console.error('- Error cargando sistemas personalizados:', error);
      return {};
    }
  }
  
  saveCustomSistemas() {
    try {
      localStorage.setItem('inventarioCustomSistemas', JSON.stringify(this.customSistemas));
      console.log('- Sistemas personalizados guardados:', this.customSistemas);
    } catch (error) {
      console.error('- Error guardando sistemas personalizados:', error);
      this.showAlert('Error al guardar sistemas personalizados', 'error');
    }
  }
  
  addCustomSistema(equipo, sistema) {
    if (!equipo || !sistema || sistema.trim() === '') return;
    
    if (!this.customSistemas[equipo]) {
      this.customSistemas[equipo] = [];
    }
    
    const sistemaTrimmed = sistema.trim();
    const predefinidos = this.sistemaPorEquipo[equipo] || this.sistemaPorEquipo['default'];
    
    if (predefinidos.includes(sistemaTrimmed) || this.customSistemas[equipo].includes(sistemaTrimmed)) {
      return false;
    }
    
    this.customSistemas[equipo].push(sistemaTrimmed);
    this.saveCustomSistemas();
    console.log(`- Sistema personalizado agregado: ${sistemaTrimmed} (${equipo})`);
    return true;
  }
  
  deleteCustomSistema(equipo, sistema) {
    if (!this.customSistemas[equipo]) return false;
    
    const index = this.customSistemas[equipo].indexOf(sistema);
    if (index > -1) {
      this.customSistemas[equipo].splice(index, 1);
      
      if (this.customSistemas[equipo].length === 0) {
        delete this.customSistemas[equipo];
      }
      
      this.saveCustomSistemas();
      console.log(`- Sistema personalizado eliminado: ${sistema} (${equipo})`);
      return true;
    }
    return false;
  }
  
  editCustomSistema(equipo, oldSistema, newSistema) {
    if (!this.customSistemas[equipo] || !newSistema || newSistema.trim() === '') return false;
    
    const index = this.customSistemas[equipo].indexOf(oldSistema);
    if (index > -1) {
      const newSistemaTrimmed = newSistema.trim();
      
      const predefinidos = this.sistemaPorEquipo[equipo] || this.sistemaPorEquipo['default'];
      if (predefinidos.includes(newSistemaTrimmed) || this.customSistemas[equipo].includes(newSistemaTrimmed)) {
        this.showAlert('Este sistema ya existe', 'warning');
        return false;
      }
      
      this.customSistemas[equipo][index] = newSistemaTrimmed;
      this.saveCustomSistemas();
      console.log(`- Sistema personalizado editado: ${oldSistema} - ${newSistemaTrimmed} (${equipo})`);
      return true;
    }
    return false;
  }
  
  // ============================================
  // GESTIN DE OPCIONES PERSONALIZADAS DE JERARQUA
  // ============================================
  
  loadOpcionesPersonalizadas() {
    try {
      const stored = localStorage.getItem('inventarioOpcionesJerarquia');
      if (stored) {
        // Si existe en localStorage, usar ESO (respeta eliminaciones)
        this.opcionesJerarquia = JSON.parse(stored);
        console.log('- Opciones cargadas desde localStorage');
      } else {
        // Primera vez: usar valores predefinidos y guardarlos
        this.opcionesJerarquia = JSON.parse(JSON.stringify(this.opcionesJerarquiaPredefinidas));
        this.saveOpcionesPersonalizadas();
        console.log('- Opciones inicializadas con valores predefinidos');
      }
    } catch (error) {
      console.error('- Error cargando opciones personalizadas:', error);
      // En caso de error, usar predefinidas
      this.opcionesJerarquia = JSON.parse(JSON.stringify(this.opcionesJerarquiaPredefinidas));
    }
  }
  
  saveOpcionesPersonalizadas() {
    try {
      // Guardar todas las opciones actuales
      const toSave = {};
      Object.keys(this.opcionesJerarquia).forEach(nivel => {
        toSave[nivel] = [...this.opcionesJerarquia[nivel]];
      });
      localStorage.setItem('inventarioOpcionesJerarquia', JSON.stringify(toSave));
      console.log('- Opciones personalizadas guardadas');
    } catch (error) {
      console.error('- Error guardando opciones personalizadas:', error);
    }
  }
  
  aprenderNuevaOpcion(nivel, valor) {
    if (!nivel || !valor || valor.trim() === '') return false;
    if (!this.opcionesJerarquia[nivel]) return false;
    
    const valorTrimmed = valor.trim();
    
    // Si ya existe, no hacer nada
    if (this.opcionesJerarquia[nivel].includes(valorTrimmed)) {
      return false;
    }
    
    // Agregar nueva opcin
    this.opcionesJerarquia[nivel].push(valorTrimmed);
    this.saveOpcionesPersonalizadas();
    console.log(`- Nueva opcin aprendida: ${valorTrimmed} en ${nivel}`);
    return true;
  }
  
  eliminarOpcionJerarquia(nivel, valor) {
    if (!this.opcionesJerarquia[nivel]) return false;
    
    const index = this.opcionesJerarquia[nivel].indexOf(valor);
    if (index > -1) {
      this.opcionesJerarquia[nivel].splice(index, 1);
      this.saveOpcionesPersonalizadas();
      
      // Limpiar esta opcin de todos los repuestos que la usen
      this.limpiarOpcionDeRepuestos(nivel, valor);
      
      console.log(`- Opcin eliminada: ${valor} de ${nivel}`);
      return true;
    }
    return false;
  }
  
  limpiarOpcionDeRepuestos(nivel, valor) {
    let modificados = 0;
    
    this.repuestos.forEach(repuesto => {
      if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones)) {
        repuesto.ubicaciones.forEach(ubicacion => {
          if (ubicacion[nivel] === valor) {
            ubicacion[nivel] = '';
            modificados++;
          }
        });
      }
    });
    
    if (modificados > 0) {
      this.guardarDatos();
      console.log(`- Limpiado "${valor}" de ${modificados} ubicacin(es)`);
      this.showAlert(`Se elimin "${valor}" de ${modificados} ubicacin(es)`, 'success');
    }
  }
  
  agregarOpcionJerarquia(nivel, valor) {
    if (!nivel || !valor || valor.trim() === '') {
      this.showToast('- Debes ingresar un valor', 'warning');
      return false;
    }
    
    // Inicializar array si no existe
    if (!this.opcionesJerarquia[nivel]) {
      this.opcionesJerarquia[nivel] = [];
    }
    
    const valorTrimmed = valor.trim();
    
    if (this.opcionesJerarquia[nivel].includes(valorTrimmed)) {
      this.showToast('  Esta opcin ya existe', 'warning');
      return false;
    }
    
    this.opcionesJerarquia[nivel].push(valorTrimmed);
    this.opcionesJerarquia[nivel].sort();
    this.saveOpcionesPersonalizadas();
    console.log(`- Opcin agregada: ${valorTrimmed} a ${nivel}`);
    this.showToast(`- "${valorTrimmed}" agregado correctamente`, 'success');
    return true;
  }


  toggleNivelesConfig() {
    const panel = document.getElementById('nivelesConfigPanel');
    if (panel.style.display === 'none') {
      panel.style.display = 'block';
      this.renderNivelesConfig();
    } else {
      panel.style.display = 'none';
    }
  }

  renderNivelesConfig() {
    const container = document.getElementById('nivelesCheckboxes');
    if (!container) return;
    
    let html = '';
    this.jerarquiaNiveles.forEach((nivel, index) => {
      if (nivel.id === 'planta' || nivel.id === 'areaGeneral') return;
      
      const borderColor = nivel.visible ? 'var(--success)' : 'var(--border-color)';
      const borderStyle = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-primary); border-radius: 6px; cursor: pointer; border: 2px solid ' + borderColor + ';';
      
      html += `
        <label style="${borderStyle}">
          <input type="checkbox" 
                 ${nivel.visible ? 'checked' : ''}
                 onchange="app.toggleNivelVisibilidad('${nivel.id}', this.checked)"
                 style="cursor: pointer;">
          <span style="font-weight: 600; font-size: 0.85rem;">${index + 1}. ${nivel.nombre}</span>
        </label>
      `;
    });
    
    container.innerHTML = html;
  }

  toggleNivelVisibilidad(nivelId, visible) {
    const nivel = this.jerarquiaNiveles.find(n => n.id === nivelId);
    if (nivel) {
      nivel.visible = visible;
      this.renderNivelesDinamicos();
      this.updateJerarquiaPreview();
    }
  }

  renderNivelesDinamicos() {
    const container = document.getElementById('nivelesDinamicosContainer');
    if (!container) return;
    
    let html = '';
    let numeroNivel = 3;
    
    this.jerarquiaNiveles.forEach(nivel => {
      if (nivel.id === 'planta' || nivel.id === 'areaGeneral') return;
      
      const opacityValue = nivel.visible ? '1' : '0.5';
      const opacityStyle = 'opacity: ' + opacityValue + ';';
      
      html += `
        <div class="form-group" style="${opacityStyle}">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" 
                   ${nivel.visible ? 'checked' : ''}
                   onchange="app.toggleNivelVisibilidad('${nivel.id}', this.checked)"
                   style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-weight: 700; color: var(--primary); min-width: 20px;">${numeroNivel}.</span>
            <span style="flex: 1;">${nivel.nombre}:</span>
            ${nivel.requerido ? '<span style="background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700;">OBLIGATORIO</span>' : '<span style="background: var(--text-secondary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem;">Opcional</span>'}
          </label>
          <input type="text" 
                 class="form-control nivel-input" 
                 id="nivel_${nivel.id}" 
                 data-nivel="${nivel.id}"
                 ${nivel.requerido ? 'required' : ''}
                 ${nivel.visible ? '' : 'disabled'}
                 placeholder="Ej: ${this.getPlaceholderParaNivel(nivel.id)}"
                 onchange="app.updateJerarquiaPreview()"
                 style="margin-left: 26px;">
        </div>
      `;
      
      numeroNivel++;
    });
    
    container.innerHTML = html;
  }

  getPlaceholderParaNivel(nivelId) {
    const placeholders = {
      'subArea': 'Zona Norte, Piso 1, Sector A',
      'sistemaEquipo': 'Grader, Compresor 01, Bomba Principal',
      'subSistema': 'Pocket 1, Motor Principal, Cinta Z',
      'seccion': 'Sistema Hidrulico, Panel Elctrico, Controles',
      'detalle': 'Lado Izquierdo, Bastidor Superior, Vlvula V3'
    };
    return placeholders[nivelId] || 'Ingrese valor';
  }

  updateJerarquiaPreview() {
    const previewText = document.getElementById('jerarquiaPreviewText');
    if (!previewText) return;
    
    const partes = [];
    
    partes.push(this.plantaBase);
    
    this.jerarquiaNiveles.forEach(nivel => {
      if (nivel.id === 'planta') return;
      
      const input = document.getElementById(`nivel_${nivel.id}`);
      if (input && input.value.trim() !== '') {
        partes.push(input.value.trim());
      }
    });
    
    if (partes.length > 0) {
      previewText.innerHTML = partes.map(parte => 
        `<span style="font-weight: 600;">${parte}</span>`
      ).join(' <span style="color: var(--success); font-weight: bold;"></span> ');
    } else {
      previewText.innerHTML = '<span style="color: var(--text-secondary); font-style: italic;">Complete los campos para ver la ruta</span>';
    }
  }

  generarUbicacionResumida(repuesto) {
    // Si tiene mltiples ubicaciones
    if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones) && repuesto.ubicaciones.length > 0) {
      return repuesto.ubicaciones.map(ub => {
        const partes = [];
        if (ub.areaGeneral) partes.push(ub.areaGeneral);
        if (ub.sistemaEquipo) partes.push(ub.sistemaEquipo);
        if (ub.subSistema) partes.push(ub.subSistema);
        return partes.length > 0 ? partes.join('  ') : 'Sin detalles';
      }).join(' <span style="color: var(--warning);">|</span> ');
    }
    
    // Compatibilidad con formato antiguo
    const partes = [];
    const areaGeneral = repuesto.areaGeneral || repuesto.area || '';
    if (areaGeneral) partes.push(areaGeneral);
    
    const sistemaEquipo = repuesto.sistemaEquipo || repuesto.equipo || '';
    if (sistemaEquipo) partes.push(sistemaEquipo);
    
    const subSistema = repuesto.subSistema || repuesto.sistema || '';
    if (subSistema) partes.push(subSistema);
    
    if (partes.length === 0) return '<em style="color: var(--text-secondary);">Sin ubicacin</em>';
    
    return partes.join('  ');
  }

  // ===== GESTIN DE MLTIPLES UBICACIONES =====
  
  ubicacionesActuales = [];
  
  agregarUbicacion() {
    const nuevaUbicacion = {
      id: Date.now(),
      areaGeneral: '',
      subArea: '',
      sistemaEquipo: '',
      subSistema: '',
      seccion: '',
      detalle: ''
    };
    
    this.ubicacionesActuales.push(nuevaUbicacion);
    this.renderUbicaciones();
  }
  
  eliminarUbicacion(id) {
    this.ubicacionesActuales = this.ubicacionesActuales.filter(ub => ub.id !== id);
    this.renderUbicaciones();
  }
  
  renderUbicaciones() {
    const container = document.getElementById('ubicacionesContainer');
    if (!container) return;
    
    if (this.ubicacionesActuales.length === 0) {
      this.agregarUbicacion(); // Agregar al menos una ubicacin
      return;
    }
    
    // Layout horizontal adaptativo segn cantidad de ubicaciones
    const numUbicaciones = this.ubicacionesActuales.length;
    const minWidth = numUbicaciones <= 2 ? '350px' : '320px';
    let html = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(${minWidth}, 1fr)); gap: 16px;">`;
    
    this.ubicacionesActuales.forEach((ubicacion, index) => {
      html += `
        <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; border: 2px solid var(--border-color);">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <h5 style="margin: 0; color: var(--text-primary); font-size: 0.95rem; font-weight: 600;">
              Ubicacin ${index + 1}
            </h5>
            ${this.ubicacionesActuales.length > 1 ? `
              <button type="button" onclick="app.eliminarUbicacion(${ubicacion.id})" class="btn btn-danger" style="padding: 4px 10px; font-size: 0.75rem;">
                Eliminar
              </button>
            ` : ''}
          </div>
          
          <!-- Nivel 1: Empresa (fijo) -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">1.</span>
              <span>Empresa:</span>
            </label>
            <input type="text" class="form-control" value="Aquachile Antarfood Chonchi" readonly style="background: var(--bg-secondary); cursor: not-allowed; font-size: 0.85rem;">
          </div>
          
          <!-- Nivel 2: rea General -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">2.</span>
              <span>rea General: *</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="areaGeneral"
                   value="${ubicacion.areaGeneral}"
                   list="areaGeneralList-${ubicacion.id}"
                   placeholder="Ej: Planta Principal, Acopio"
                   style="font-size: 0.85rem;">
            <datalist id="areaGeneralList-${ubicacion.id}">
              ${this.opcionesJerarquia.areaGeneral.map(opt => `<option value="${opt}">`).join('')}
            </datalist>
          </div>
          
          <!-- Nivel 3: Sub-rea -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">3.</span>
              <span>Sub-rea:</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="subArea"
                   value="${ubicacion.subArea}"
                   list="subAreaList-${ubicacion.id}"
                   placeholder="Ej: Zona Norte, Piso 1"
                   style="font-size: 0.85rem;">
            <datalist id="subAreaList-${ubicacion.id}">
              ${this.opcionesJerarquia.subArea.map(opt => `<option value="${opt}">`).join('')}
            </datalist>
          </div>
          
          <!-- Nivel 4: Sistema/Equipo -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">4.</span>
              <span>Sistema/Equipo:</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="sistemaEquipo"
                   value="${ubicacion.sistemaEquipo}"
                   list="sistemaEquipoList-${ubicacion.id}"
                   placeholder="Ej: Grader Marel, Compresor 01"
                   style="font-size: 0.85rem;">
            <datalist id="sistemaEquipoList-${ubicacion.id}">
              ${this.opcionesJerarquia.sistemaEquipo.map(opt => `<option value="${opt}">`).join('')}
            </datalist>
          </div>
          
          <!-- Nivel 5: Sub-Sistema -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">5.</span>
              <span>Sub-Sistema:</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="subSistema"
                   value="${ubicacion.subSistema}"
                   list="subSistemaList-${ubicacion.id}"
                   placeholder="Ej: Pocket 1, Motor Principal"
                   style="font-size: 0.85rem;">
            <datalist id="subSistemaList-${ubicacion.id}">
              ${this.opcionesJerarquia.subSistema.map(opt => `<option value="${opt}">`).join('')}
            </datalist>
          </div>
          
          <!-- Nivel 6: Seccin -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">6.</span>
              <span>Seccin:</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="seccion"
                   value="${ubicacion.seccion}"
                   list="seccionList-${ubicacion.id}"
                   placeholder="Ej: Sistema Hidrulico, Panel Elctrico"
                   style="font-size: 0.85rem;">
            <datalist id="seccionList-${ubicacion.id}">
              ${this.opcionesJerarquia.seccion.map(opt => `<option value="${opt}">`).join('')}
            </datalist>
          </div>
          
          <!-- Nivel 7: Detalle -->
          <div class="form-group" style="margin-bottom: 0;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">7.</span>
              <span>Detalle / Ubicacin Especfica:</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="detalle"
                   value="${ubicacion.detalle}"
                   placeholder="Ej: Lado Izquierdo, Estante 2 Nivel 3, Bastidor Superior"
                   style="font-size: 0.85rem;">
            <small style="color: var(--text-secondary); font-size: 0.7rem; display: block; margin-top: 4px;">
                Campo de texto libre para referencia exacta de ubicacin
            </small>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Agregar listeners para actualizar datos
    document.querySelectorAll('.ubicacion-input').forEach(input => {
      input.addEventListener('input', (e) => {
        const ubicacionId = parseInt(e.target.dataset.ubicacionId);
        const field = e.target.dataset.field;
        const ubicacion = this.ubicacionesActuales.find(ub => ub.id === ubicacionId);
        if (ubicacion) {
          ubicacion[field] = e.target.value;
          console.log(`  Actualizado ${field} =`, e.target.value, 'en ubicacin', ubicacionId);
        }
      });
    });
    
    // DEBUG: Mostrar estado actual
    console.log('  Ubicaciones actuales:', JSON.stringify(this.ubicacionesActuales, null, 2));
    
    // Ajustar ancho del modal segn cantidad de ubicaciones
    this.ajustarAnchoModal();
  }
  
  ajustarAnchoModal() {
    const modalContent = document.querySelector('.modal-content');
    if (!modalContent) return;
    
    const numUbicaciones = this.ubicacionesActuales.length;
    const screenWidth = window.innerWidth;
    
    // En mviles, siempre full width
    if (screenWidth <= 480) {
      modalContent.style.width = 'calc(100vw - 20px)';
      return;
    }
    
    // Calcular ancho ptimo segn nmero de ubicaciones
    let optimalWidth;
    if (numUbicaciones === 1) {
      optimalWidth = '800px';
    } else if (numUbicaciones === 2) {
      optimalWidth = '1100px';
    } else if (numUbicaciones === 3) {
      optimalWidth = '1400px';
    } else if (numUbicaciones === 4) {
      optimalWidth = '1700px';
    } else {
      optimalWidth = 'calc(100vw - 20px)'; // 5 o ms = full width
    }
    
    // Aplicar el ancho, pero no exceder el ancho de pantalla
    modalContent.style.width = optimalWidth;
    modalContent.style.maxWidth = 'calc(100vw - 20px)';
  }

  mostrarEjemplosCategoria(categoria) {
    const ejemplosElement = document.getElementById('ejemplosCategoria');
    if (!ejemplosElement) return;
    
    const ejemplos = {
      'Repuesto': 'Ejemplos: filtros, rodamientos, vlvulas, correas, motores',
      'Insumo': 'Ejemplos: brochas, guantes, grasas, pinturas, cintas adhesivas',
      'Herramienta': 'Ejemplos: taladros, llaves, destornilladores, martillos',
      'EPP': 'Ejemplos: cascos, lentes, arneses, guantes de seguridad',
      'Qumico': 'Ejemplos: desengrasantes, cidos, solventes, desinfectantes'
    };
    if(categoria && ejemplos[categoria]) {
      ejemplosElement.textContent = ejemplos[categoria];
      ejemplosElement.style.color = '#7A9AB8'; // Azul claro
    } else {
      ejemplosElement.textContent = 'Selecciona una categora para ver ejemplos';
      ejemplosElement.style.color = '#94a3b8'; // Gris
    }
  }

  mostrarJerarquia(id) {
    const repuesto = this.repuestos.find(r => r.id === id);
    if (!repuesto) return;
    
    // Obtener ubicaciones (nuevo formato o antiguo)
    let ubicaciones = [];
    if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones) && repuesto.ubicaciones.length > 0) {
      ubicaciones = repuesto.ubicaciones;
    } else {
      // Formato antiguo: crear array con una ubicacin
      ubicaciones = [{
        areaGeneral: repuesto.areaGeneral || repuesto.area,
        subArea: repuesto.subArea,
        sistemaEquipo: repuesto.sistemaEquipo || repuesto.equipo,
        subSistema: repuesto.subSistema || repuesto.sistema,
        seccion: repuesto.seccion,
        detalle: repuesto.detalle || repuesto.detalleUbicacion
      }];
    }
    
    const planta = repuesto.planta || this.plantaBase;
    
    // CONSTRUIR RBOL RAMIFICADO (con nombre del repuesto)
    const arbolHTML = this.construirArbolJerarquia(ubicaciones, planta, repuesto.nombre);
    
    const html = `
      <div class="jerarquia-modal-content" style="width: fit-content; min-width: 600px; max-width: 95vw; max-height: 90vh; background: var(--card-bg); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        
        <!-- Header -->
        <div class="jerarquia-header" style="padding: 20px 24px; background: var(--primary); border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <h3 class="jerarquia-title" style="margin: 0; color: #ffffff; font-size: 1.3rem; font-weight: 600;">
                Ubicacin del Repuesto
            </h3>
            <button onclick="app.closeCustomModal()" 
                    style="background: rgba(255,255,255,0.15); border: none; color: white; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 18px; transition: all 0.2s; flex-shrink: 0;"
                    onmouseover="this.style.background='rgba(255,255,255,0.25)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.15)'">?</button>
          </div>
          <div class="jerarquia-info" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <div style="font-size: 0.9rem; font-weight: 600; color: #ffffff; word-break: break-word; flex: 1; min-width: 0;">${repuesto.nombre}</div>
            ${repuesto.codSAP ? `<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px; white-space: nowrap;">SAP: ${repuesto.codSAP}</div>` : ''}
            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.75); background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 12px; font-weight: 500; white-space: nowrap;">
              ${ubicaciones.length} ${ubicaciones.length === 1 ? 'Ubicacin' : 'Ubicaciones'}
            </div>
          </div>
        </div>
        
        <!-- rea del rbol con scroll vertical automtico -->
        <div class="jerarquia-body" style="flex: 1; background: var(--bg-secondary); padding: 20px; overflow-y: auto; overflow-x: visible; max-height: calc(90vh - 200px);">
          ${arbolHTML}
        </div>
        
        <!-- Footer -->
        <div style="padding: 14px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border); flex-shrink: 0; display: flex; justify-content: center;">
          <button onclick="app.closeCustomModal()" 
                  style="padding: 12px 48px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.2s;"
                  onmouseover="this.style.opacity='0.9'"
                  onmouseout="this.style.opacity='1'">
            Cerrar
          </button>
        </div>
        
      </div>
    `;
    
    this.showCustomModal(html);
  }
  
  construirArbolJerarquia(ubicaciones, planta, nombreRepuesto) {
    console.log('  Construyendo rbol tipo dendrograma VERTICAL...', ubicaciones);
    if (ubicaciones.length === 0) return '<div style="text-align: center; color: var(--text-secondary); padding: 40px; font-size: 0.95rem;">Sin ubicaciones registradas</div>';
    
    // Estructura de rbol: agrupar ubicaciones por jerarqua comn (CON nombre del repuesto antes del detalle)
    const niveles = ['areaGeneral', 'subArea', 'sistemaEquipo', 'subSistema', 'seccion', 'nombreRepuesto', 'detalle'];
    const nodos = this.construirNodosArbol(ubicaciones, planta, niveles, nombreRepuesto);
    console.log('  Nodos construidos:', nodos);
    
    // Calcular posiciones VERTICALES (hacia abajo)
    let posicionX = 0;
    const nodosConPosicion = [];
    const nivelY = 90; // Espacio vertical entre niveles (reducido de 110 a 90)
    const anchoNodo = 200; // Ancho de nodos (reducido de 240 a 200)
    const altoNodo = 56; // Alto de nodos (reducido de 70 a 56)
    
    const calcularPosiciones = (nodo, nivel = 0) => {
      const y = nivel * nivelY + 50;
      
      if (!nodo.hijos || nodo.hijos.length === 0) {
        // Nodo hoja
        const x = posicionX * (anchoNodo + 30) + 50;
        nodosConPosicion.push({ ...nodo, x, y, nivel });
        posicionX++;
        return x;
      } else {
        // Nodo con hijos
        const posicionesHijos = nodo.hijos.map(hijo => 
          calcularPosiciones(hijo, nivel + 1)
        );
        const xPromedio = (Math.min(...posicionesHijos) + Math.max(...posicionesHijos)) / 2;
        nodosConPosicion.push({ ...nodo, x: xPromedio, y, nivel, posicionesHijos });
        return xPromedio;
      }
    };
    
    // Calcular posiciones de todos los nodos
    nodos.forEach(nodo => calcularPosiciones(nodo));
    
    // Calcular dimensiones del SVG
    const maxX = Math.max(...nodosConPosicion.map(n => n.x)) + anchoNodo + 100;
    const maxY = Math.max(...nodosConPosicion.map(n => n.y)) + altoNodo + 60;
    
    // Generar SVG con lneas y nodos (VERTICAL)
    let svg = `<svg width="${maxX}" height="${maxY}" style="font-family: var(--font-family); display: block; min-width: 100%;">`;
    
    // Definir gradientes y filtros SUAVES
    svg += `
      <defs>
        <filter id="sombra" x="-30%" y="-30%" width="160%" height="160%">
          <feGaussianBlur in="SourceAlpha" stdDeviation="2.5"/>
          <feOffset dx="0" dy="2" result="offsetblur"/>
          <feComponentTransfer>
            <feFuncA type="linear" slope="0.1"/>
          </feComponentTransfer>
          <feMerge>
            <feMergeNode/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
    `;
    
    // Dibujar lneas de conexin
    nodosConPosicion.forEach(nodo => {
      if (nodo.hijos && nodo.hijos.length > 0) {
        const nodoCentroX = nodo.x + anchoNodo / 2;
        const nodoCentroYAbajo = nodo.y + altoNodo;
        
        nodo.hijos.forEach((hijo, idx) => {
          const hijoNodo = nodosConPosicion.find(n => n.valor === hijo.valor && n.nivel === nodo.nivel + 1);
          if (hijoNodo) {
            const hijoCentroX = hijoNodo.x + anchoNodo / 2;
            const hijoCentroYArriba = hijoNodo.y;
            
            // Lnea vertical desde el padre
            const yMedio = nodoCentroYAbajo + 20;
            svg += `<line x1="${nodoCentroX}" y1="${nodoCentroYAbajo}" x2="${nodoCentroX}" y2="${yMedio}" stroke="#94a3b8" stroke-width="1.5" opacity="0.5"/>`;
            
            // Lnea horizontal (si hay mltiples hijos)
            if (nodo.hijos.length > 1) {
              if (idx === 0) {
                const ultimoHijo = nodosConPosicion.find(n => n.valor === nodo.hijos[nodo.hijos.length - 1].valor && n.nivel === nodo.nivel + 1);
                if (ultimoHijo) {
                  const ultimoHijoCentroX = ultimoHijo.x + anchoNodo / 2;
                  svg += `<line x1="${hijoCentroX}" y1="${yMedio}" x2="${ultimoHijoCentroX}" y2="${yMedio}" stroke="#94a3b8" stroke-width="1.5" opacity="0.5"/>`;
                }
              }
            }
            
            // Lnea vertical hasta el hijo
            svg += `<line x1="${hijoCentroX}" y1="${yMedio}" x2="${hijoCentroX}" y2="${hijoCentroYArriba}" stroke="#94a3b8" stroke-width="1.5" opacity="0.5"/>`;
          }
        });
      }
    });
    
    // Colores CORPORATIVOS MATE del proyecto (los originales que pediste)
    const coloresPorNivel = [
      { fondo: '#C4A882', borde: '#A68F6D', texto: '#ffffff' }, // Nivel 0 - Empresa (beige/caf mate)
      { fondo: '#6B8499', borde: '#5A7188', texto: '#ffffff' }, // Nivel 1 - rea (azul gris mate)
      { fondo: '#7D8A97', borde: '#6A7784', texto: '#ffffff' }, // Nivel 2 - Sub-rea (gris azulado mate)
      { fondo: '#8897A8', borde: '#7586a7', texto: '#ffffff' }, // Nivel 3 - Sistema (azul acero mate)
      { fondo: '#939FAB', borde: '#808C98', texto: '#ffffff' }, // Nivel 4 - Sub-sistema (gris perla mate)
      { fondo: '#A1B0BC', borde: '#8E9DA9', texto: '#ffffff' }, // Nivel 5 - Seccin (azul claro mate)
      { fondo: '#7FA396', borde: '#6C9083', texto: '#ffffff' }, // Nivel 6 - Repuesto (verde gris mate)
      { fondo: '#6D9488', borde: '#5A8175', texto: '#ffffff' }  // Nivel 7 - Detalle (verde azulado mate)
    ];
    
    // Dibujar nodos SIN INTERACTIVIDAD (solo visualizacin)
    nodosConPosicion.forEach(nodo => {
      const tieneUbicaciones = nodo.ubicaciones && nodo.ubicaciones.length > 0;
      const colores = coloresPorNivel[nodo.nivel] || coloresPorNivel[coloresPorNivel.length - 1];
      
      // Grupo del nodo (sin eventos)
      svg += `<g>`;
      
      // Fondo del nodo
      if (tieneUbicaciones) {
        // Nodo final con ubicacin - Verde corporativo destacado
        svg += `<rect x="${nodo.x}" y="${nodo.y}" width="${anchoNodo}" height="${altoNodo}" rx="6" 
                  fill="#6D9488" 
                  stroke="#5A8175" 
                  stroke-width="2"
                  filter="url(#sombra)"/>`;
      } else {
        // Nodo normal con colores corporativos
        svg += `<rect x="${nodo.x}" y="${nodo.y}" width="${anchoNodo}" height="${altoNodo}" rx="6" 
                  fill="${colores.fondo}" 
                  stroke="${colores.borde}" 
                  stroke-width="1.5"
                  filter="url(#sombra)"/>`;
      }
      
      // Etiqueta del nivel (ms pequea y sutil)
      if (nodo.etiqueta) {
        svg += `<text x="${nodo.x + anchoNodo/2}" y="${nodo.y + 12}" 
                  text-anchor="middle" 
                  fill="rgba(255,255,255,0.5)" 
                  font-size="8" 
                  font-weight="500"
                  letter-spacing="0.5"
                  pointer-events="none">${nodo.etiqueta.toUpperCase()}</text>`;
      }
      
      // Texto del nodo (ms compacto)
      const lineas = this.dividirTextoEnLineas(nodo.valor, 28);
      const yInicial = nodo.y + (lineas.length === 1 ? altoNodo/2 + 4 : altoNodo/2 - 1);
      
      lineas.forEach((linea, idx) => {
        svg += `<text x="${nodo.x + anchoNodo/2}" y="${yInicial + (idx * 14)}" 
                  text-anchor="middle" 
                  dominant-baseline="middle" 
                  fill="#ffffff" 
                  font-size="11.5" 
                  font-weight="600"
                  pointer-events="none">${linea}</text>`;
      });
      
      // Badge de ubicacin (sin icono para no tapar texto)
      if (tieneUbicaciones) {
        svg += `<text x="${nodo.x + anchoNodo/2}" y="${nodo.y + altoNodo - 8}" 
                  text-anchor="middle" 
                  fill="rgba(255,255,255,0.85)" 
                  font-size="7.5" 
                  font-weight="600"
                  letter-spacing="0.3"
                  pointer-events="none">${nodo.ubicaciones.join(', ')}</text>`;
      }
      
      svg += `</g>`;
    });
    
    svg += '</svg>';
    
    return `<div style="width: 100%; height: 100%; overflow: auto; display: flex; align-items: flex-start; justify-content: flex-start; padding: 20px;">
      <div style="min-width: min-content;">${svg}</div>
    </div>`;
  }
  
  // Funcin auxiliar para dividir texto en lneas
  dividirTextoEnLineas(texto, maxCaracteres) {
    if (texto.length <= maxCaracteres) return [texto];
    
    const palabras = texto.split(' ');
    const lineas = [];
    let lineaActual = '';
    
    palabras.forEach(palabra => {
      if ((lineaActual + palabra).length <= maxCaracteres) {
        lineaActual += (lineaActual ? ' ' : '') + palabra;
      } else {
        if (lineaActual) lineas.push(lineaActual);
        lineaActual = palabra;
      }
    });
    
    if (lineaActual) lineas.push(lineaActual);
    return lineas.slice(0, 3); // Mximo 3 lneas
  }

  // Filtrar repuestos por nivel de jerarqua
  filtrarPorJerarquia(campo, valor) {
    console.log(`  Filtrando por ${campo}: "${valor}"`);
    
    // Mapeo de campos del rbol a campos de ubicacin
    const mapaCampos = {
      'planta': 'planta',
      'areaGeneral': 'areaGeneral',
      'subArea': 'subArea',
      'sistemaEquipo': 'sistemaEquipo',
      'subSistema': 'subSistema',
      'seccion': 'seccion',
      'detalle': 'detalle'
    };
    
    const campoReal = mapaCampos[campo] || campo;
    
    // Buscar repuestos que tengan este valor en cualquiera de sus ubicaciones
    const repuestosFiltrados = this.repuestos.filter(repuesto => {
      if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones)) {
        return repuesto.ubicaciones.some(ub => ub[campoReal] === valor);
      } else {
        // Formato antiguo
        return repuesto[campoReal] === valor;
      }
    });
    
    console.log(`- Encontrados ${repuestosFiltrados.length} repuestos`);
    
    // Mostrar resultados en modal ampliado
    this.mostrarResultadosFiltro(campo, valor, repuestosFiltrados);
  }

  // Mostrar resultados del filtro en modal ampliado
  mostrarResultadosFiltro(campo, valor, repuestos) {
    const nombreCampo = {
      'planta': 'Empresa',
      'areaGeneral': 'rea General',
      'subArea': 'Sub-rea',
      'sistemaEquipo': 'Sistema/Equipo',
      'subSistema': 'Sub-Sistema',
      'seccion': 'Seccin',
      'detalle': 'Detalle'
    }[campo] || campo;
    
    let html = `
      <div style="padding: clamp(20px, 3vw, 32px); background: var(--card-bg); border-radius: 16px; width: 95vw; max-width: 1800px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 16px; flex-shrink: 0; flex-wrap: wrap; gap: 12px;">
          <div>
            <h3 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: clamp(1.1rem, 2vw, 1.4rem); font-weight: 600;">
              Repuestos en ${nombreCampo}
            </h3>
            <div style="font-size: clamp(0.8rem, 1.5vw, 0.9rem); color: var(--text-secondary); font-weight: 500;">
              "${valor}"
            </div>
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <div style="font-size: 0.75rem; color: var(--text-secondary); background: var(--bg-secondary); padding: 6px 14px; border-radius: 20px; font-weight: 600;">
              ${repuestos.length} Repuesto${repuestos.length !== 1 ? 's' : ''}
            </div>
            <button onclick="app.closeCustomModal()" style="background: var(--bg-secondary); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; color: var(--text-primary); font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='var(--bg-secondary)'">
              Cerrar
            </button>
          </div>
        </div>
        
        <div style="flex: 1; overflow-y: auto; padding-right: 8px;">
    `;
    
    if (repuestos.length === 0) {
      html += `
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
          <div style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"> </div>
          <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">No hay repuestos</div>
          <div style="font-size: 0.9rem;">No se encontraron repuestos en esta ubicacin</div>
        </div>
      `;
    } else {
      // Grid de repuestos (responsivo)
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(min(300px, 100%), 1fr)); gap: 16px;">';
      
      repuestos.forEach(repuesto => {
        // Obtener imagen principal (buscar formatos FileSystem primero)
        let imagenPrincipal = null;
        if (repuesto.multimedia && repuesto.multimedia.length > 0) {
          const imagenFS = repuesto.multimedia.find(m => m.isFileSystem && m.url);
          imagenPrincipal = imagenFS ? imagenFS.url : repuesto.multimedia[0].url;
        }
        
        html += `
          <div style="background: var(--bg-primary); border: 2px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; cursor: pointer;" 
               onclick="app.editRepuesto('${repuesto.id}')"
               onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            
            ${imagenPrincipal ? `
              <div style="height: 180px; background: var(--bg-secondary); position: relative; overflow: hidden;">
                <img src="${imagenPrincipal}" 
                     style="width: 100%; height: 100%; object-fit: cover;" 
                     onerror="this.parentElement.innerHTML='<div style=\\'height: 180px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 3rem; opacity: 0.3;\\'> </div>'">
              </div>
            ` : `
              <div style="height: 180px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 3rem; opacity: 0.3;">
                 
              </div>
            `}
            
            <div style="padding: 16px;">
              <div style="font-weight: 600; font-size: 1rem; color: var(--text-primary); margin-bottom: 8px; line-height: 1.3;">
                ${repuesto.nombre}
              </div>
              
              ${repuesto.codSAP ? `
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">
                  <span style="font-weight: 600;">SAP:</span> ${repuesto.codSAP}
                </div>
              ` : ''}
              
              <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                ${repuesto.tipo ? `<span style="font-size: 0.7rem; background: var(--bg-secondary); padding: 4px 8px; border-radius: 6px; color: var(--text-secondary); font-weight: 600;">${repuesto.tipo}</span>` : ''}
                <span style="font-size: 0.7rem; background: ${repuesto.cantidad > repuesto.minimo ? '#d1fae5' : '#fee2e2'}; color: ${repuesto.cantidad > repuesto.minimo ? '#065f46' : '#991b1b'}; padding: 4px 8px; border-radius: 6px; font-weight: 600;">Stock: ${repuesto.cantidad}</span>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
    }
    
    html += `
        </div>
      </div>
    `;
    
    this.showCustomModal(html);
  }
  
  construirNodosArbol(ubicaciones, planta, niveles, nombreRepuesto) {
    // Crear nodo raz (empresa/planta)
    const raiz = {
      nivel: -1,
      campo: 'planta',
      valor: planta || 'Aquachile Antarfood Chonchi',
      etiqueta: 'Empresa',
      hijos: [],
      ubicaciones: []
    };
    
    const etiquetasNiveles = {
      'areaGeneral': 'rea General',
      'subArea': 'Sub-rea',
      'sistemaEquipo': 'Sistema/Equipo',
      'subSistema': 'Sub-Sistema',
      'seccion': 'Seccin',
      'nombreRepuesto': 'Repuesto',
      'detalle': 'Detalle Ubicacin'
    };
    
    // Procesar cada ubicacin
    ubicaciones.forEach((ubicacion, index) => {
      let nodoActual = raiz;
      let ultimoNodoConValor = null;
      
      // Recorrer cada nivel de jerarqua
      niveles.forEach((campo, nivelIdx) => {
        let valor = ubicacion[campo];
        
        // Si es nombreRepuesto, usar el valor pasado como parmetro
        if (campo === 'nombreRepuesto') {
          valor = nombreRepuesto;
        }
        
        if (!valor || valor.trim() === '') return; // Saltar niveles vacos
        
        // Buscar si ya existe un hijo con este valor
        let hijo = nodoActual.hijos.find(h => h.campo === campo && h.valor === valor);
        
        if (!hijo) {
          // Crear nuevo nodo
          hijo = {
            nivel: nivelIdx,
            campo: campo,
            valor: valor,
            etiqueta: etiquetasNiveles[campo] || campo,
            hijos: [],
            ubicaciones: []
          };
          nodoActual.hijos.push(hijo);
        }
        
        ultimoNodoConValor = hijo;
        nodoActual = hijo;
      });
      
      // Marcar la ubicacin en el ltimo nodo con valor
      if (ultimoNodoConValor) {
        ultimoNodoConValor.ubicaciones.push(index + 1);
      }
    });
    
    return [raiz];
  }

  showCustomModal(content) {
    let modal = document.getElementById('customModalOverlay');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'customModalOverlay';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
        overflow: auto;
      `;
      modal.onclick = (e) => {
        if (e.target === modal) this.closeCustomModal();
      };
      document.body.appendChild(modal);
    }
    modal.innerHTML = content;
    modal.style.display = 'flex';
    
    // Agregar listener para ESC
    this.addEscapeListener();
  }

  closeCustomModal() {
    const modal = document.getElementById('customModalOverlay');
    if (modal) modal.style.display = 'none';
    this.removeEscapeListener();
  }

  // ===============================================
  // CONTEO INDIVIDUAL DE REPUESTOS
  // ===============================================

  abrirModalConteoIndividual(id) {
    const repuesto = this.repuestos.find(r => r.id === id);
    if (!repuesto) {
      this.showToast('⚠️ Repuesto no encontrado', 'error');
      return;
    }

    const minimo = repuesto.minimo || 5;
    const optimo = repuesto.optimo || minimo * 2;
    const cantidadActual = repuesto.cantidad || 0;
    const estadoStock = cantidadActual === 0 ? 'AGOTADO' : cantidadActual <= minimo ? 'BAJO' : 'OK';
    const colorEstado = cantidadActual === 0 ? '#7a6b6b' : cantidadActual <= minimo ? '#8a7a5a' : '#6b7280';
    const iconoEstado = cantidadActual === 0 ? '❌' : cantidadActual <= minimo ? '⚠️' : '✅';
    
    const ultimoConteo = repuesto.ultimoConteo ? new Date(repuesto.ultimoConteo) : null;
    const fechaFormateada = ultimoConteo ? ultimoConteo.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' }) : '';
    const horaFormateada = ultimoConteo ? ultimoConteo.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';

    const modalHTML = `
      <div class="modal-backdrop-custom" id="modalConteoIndividual" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div class="modal-dialog-custom" style="max-width: 480px; width: 90%; animation: slideUp 0.2s ease-out;">
          <div class="modal-content-custom" style="border-radius: 2px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.8); background: #252526; border: 1px solid #3e3e42;">
            
            <!-- HEADER CORPORATIVO -->
            <div class="modal-header-custom" style="background: #2d2d30; padding: 16px 20px; border-bottom: 2px solid #3e3e42;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <h3 style="margin: 0; font-size: 16px; font-weight: 700; color: #d4d4d4; text-transform: uppercase; letter-spacing: 0.5px;">Conteo de Stock</h3>
                  <p style="margin: 4px 0 0 0; font-size: 11px; color: #969696; font-weight: 500;">Actualizar cantidad física</p>
                </div>
                <button onclick="window.app.cerrarModalConteoIndividual()" style="background: transparent; border: none; color: #969696; font-size: 24px; cursor: pointer; padding: 0; line-height: 1; transition: color 0.15s; font-weight: 300;" onmouseover="this.style.color='#d4d4d4'" onmouseout="this.style.color='#969696'">×</button>
              </div>
            </div>
            
            <div class="modal-body-custom" style="padding: 20px;">
              
              <!-- INFORMACIÓN DEL PRODUCTO -->
              <div style="background: #1e1e1e; border: 1px solid #3e3e42; padding: 14px; border-radius: 2px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                  <h4 style="margin: 0; font-size: 14px; color: #d4d4d4; font-weight: 600; line-height: 1.4;">${repuesto.nombre}</h4>
                  <span class="stock-badge" data-color="${colorEstado}">${estadoStock}</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 11px; color: #969696;">
                  <div><strong style="color: #d4d4d4; font-weight: 600;">Área:</strong> ${repuesto.area || repuesto.areaGeneral || 'N/A'}</div>
                  <div><strong style="color: #d4d4d4; font-weight: 600;">Equipo:</strong> ${repuesto.equipo || repuesto.sistemaEquipo || 'N/A'}</div>
                  ${repuesto.codSAP ? `<div style="grid-column: 1 / -1;"><strong style="color: #d4d4d4; font-weight: 600;">SAP:</strong> <span style="font-family: var(--font-mono);">${repuesto.codSAP}</span></div>` : ''}
                </div>
              </div>

              <!-- CANTIDAD ACTUAL Y MÍNIMO -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                <div style="background: #1e1e1e; border: 2px solid #3e3e42; padding: 14px; border-radius: 2px; text-align: center;">
                  <div style="font-size: 9px; color: #969696; font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Stock Actual</div>
                  <div class="stock-cantidad" data-color="${colorEstado}">${cantidadActual}</div>
                  <div style="font-size: 9px; color: #6e7681; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.3px;">unidades</div>
                </div>
                
                <div style="background: #1e1e1e; border: 2px solid #3e3e42; padding: 14px; border-radius: 2px; text-align: center;">
                  <div style="font-size: 9px; color: #969696; font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Mínimo</div>
                  <div style="font-size: 28px; color: #969696; opacity: 0.95; font-weight: 700; line-height: 1;">${minimo}</div>
                  <div style="font-size: 9px; color: #6e7681; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.3px;">requerido</div>
                </div>
              </div>

              <!-- INFORMACIÓN DE ÚLTIMO CONTEO -->
              ${ultimoConteo ? `
                <div style="background: #1e1e1e; border-left: 3px solid #969696; padding: 10px; border-radius: 0; margin-bottom: 16px;">
                  <div style="font-size: 9px; color: #969696; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Último conteo</div>
                  <div style="font-size: 11px; color: #d4d4d4; font-weight: 600;">${fechaFormateada} • ${horaFormateada}</div>
                </div>
              ` : `
                <div style="background: #332b00; border-left: 3px solid #f59e0b; padding: 10px; border-radius: 0; margin-bottom: 16px;">
                  <div style="font-size: 11px; color: #fbbf24; font-weight: 600;">Sin conteo previo registrado</div>
                </div>
              `}

              <!-- INPUT NUEVA CANTIDAD -->
              <div style="background: #1e1e1e; padding: 16px; border-radius: 2px; border: 1px solid #3e3e42;">
                <label for="cantidadConteoInput" style="display: block; font-size: 10px; font-weight: 700; color: #d4d4d4; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">
                  Nueva cantidad física
                </label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <button onclick="document.getElementById('cantidadConteoInput').value = Math.max(0, parseInt(document.getElementById('cantidadConteoInput').value || 0) - 1)" style="background: #2d2d30; border: 1px solid #555555; color: #d4d4d4; width: 40px; height: 40px; border-radius: 2px; cursor: pointer; font-size: 18px; font-weight: 700; transition: all 0.15s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#3e3e42'" onmouseout="this.style.background='#2d2d30'">−</button>
                  <input type="number" 
                         id="cantidadConteoInput" 
                         value="${cantidadActual}" 
                         min="0" 
                         style="flex: 1; padding: 10px; font-size: 24px; font-weight: 700; text-align: center; border: 2px solid #555555; border-radius: 2px; background: #0d0d0d; color: #d4d4d4; transition: border-color 0.15s;"
                         onfocus="this.select(); this.style.borderColor='#5a6b7a'"
                         onblur="this.style.borderColor='#555555'"
                         onkeydown="if(event.key==='Enter'){window.app.guardarConteoIndividual('${id}')}"
                  />
                  <button onclick="document.getElementById('cantidadConteoInput').value = parseInt(document.getElementById('cantidadConteoInput').value || 0) + 1" style="background: #2d2d30; border: 1px solid #555555; color: #d4d4d4; width: 40px; height: 40px; border-radius: 2px; cursor: pointer; font-size: 18px; font-weight: 700; transition: all 0.15s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#3e3e42'" onmouseout="this.style.background='#2d2d30'">+</button>
                </div>
              </div>

              <!-- BOTONES DE ACCIÓN -->
              <div style="display: flex; gap: 8px; margin-top: 20px;">
                <button onclick="window.app.cerrarModalConteoIndividual()" style="flex: 1; background: #2d2d30; border: 1px solid #555555; color: #d4d4d4; padding: 11px; border-radius: 2px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.15s; text-transform: uppercase; letter-spacing: 0.3px;" onmouseover="this.style.background='#3e3e42'" onmouseout="this.style.background='#2d2d30'">
                  Cancelar
                </button>
                <button onclick="window.app.guardarConteoIndividual('${id}')" style="flex: 2; background: #5a6b7a; border: none; color: #ffffff; padding: 11px; border-radius: 2px; cursor: pointer; font-weight: 700; font-size: 12px; transition: all 0.15s; text-transform: uppercase; letter-spacing: 0.3px;" onmouseover="this.style.background='#6a7b8a'" onmouseout="this.style.background='#5a6b7a'">
                  Guardar Conteo
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Aplicar estilos dinámicos
    this.applyDynamicStyles({
      '.stock-badge': { '--bg-color': colorEstado },
      '.stock-cantidad': { '--text-color': colorEstado }
    });
    
    // Focus en el input
    setTimeout(() => {
      const input = document.getElementById('cantidadConteoInput');
      if (input) {
        input.focus();
        input.select();
      }
    }, 100);
  }

  // Helper para aplicar estilos dinámicos a elementos con data-attributes
  applyDynamicStyles(styles) {
    Object.entries(styles).forEach(([selector, cssVars]) => {
      const elements = document.querySelectorAll(selector);
      elements.forEach(el => {
        Object.entries(cssVars).forEach(([varName, value]) => {
          el.style.setProperty(varName, value);
        });
      });
    });
  }

  cerrarModalConteoIndividual() {
    const modal = document.getElementById('modalConteoIndividual');
    if (modal) modal.remove();
  }

  async guardarConteoIndividual(id) {
    const input = document.getElementById('cantidadConteoInput');
    if (!input) return;

    const nuevaCantidad = parseInt(input.value) || 0;
    const repuesto = this.repuestos.find(r => r.id === id);
    
    if (!repuesto) {
      this.showToast('⚠️ Error: Repuesto no encontrado', 'error');
      return;
    }

    const cantidadAnterior = repuesto.cantidad || 0;
    const diferencia = nuevaCantidad - cantidadAnterior;
    const signo = diferencia > 0 ? '+' : '';

    // Actualizar datos
    repuesto.cantidad = nuevaCantidad;
    repuesto.ultimoConteo = new Date().toISOString();

    // Guardar en storage
    await this.saveData();
    
    // Cerrar modal
    this.cerrarModalConteoIndividual();

    // Actualizar vista
    await this.renderInventario();

    // Mostrar toast con información
    this.showToast(
      `✅ Conteo guardado: ${nuevaCantidad} unid. (${signo}${diferencia})`,
      'success',
      4000
    );
  }

  addEscapeListener() {
    if (!this.escapeHandler) {
      this.escapeHandler = (e) => {
        if (e.key === 'Escape') {
          // Cerrar lightbox si está activo
          const lightbox = document.getElementById('lightbox');
          if (lightbox && lightbox.classList.contains('active')) {
            this.closeLightbox();
            return;
          }
          
          // Cerrar modal personalizado si está abierto
          const customModal = document.getElementById('customModalOverlay');
          if (customModal && customModal.style.display === 'flex') {
            this.closeCustomModal();
            return;
          }
          
          // Cerrar modal principal si está abierto
          const mainModal = document.getElementById('modal');
          if (mainModal && mainModal.classList.contains('active')) {
            this.closeModal();
            return;
          }
        }
      };
    }
    document.addEventListener('keydown', this.escapeHandler);
  }

  removeEscapeListener() {
    if (this.escapeHandler) {
      document.removeEventListener('keydown', this.escapeHandler);
    }
  }

  // ========================================
  // LIGHTBOX COMPLETO - Con zoom y navegación
  // ========================================
  
  async openLightbox(id) {
    console.log('🖼️ openLightbox llamado con ID:', id);
    
    const repuesto = this.repuestos.find(r => r.id === id);
    console.log('📦 Repuesto encontrado:', repuesto ? repuesto.nombre : 'NO ENCONTRADO');
    
    if (!repuesto) {
      console.error('❌ No se encontró el repuesto con ID:', id);
      return;
    }
    
    if (!repuesto.multimedia || repuesto.multimedia.length === 0) {
      console.warn('⚠️ El repuesto no tiene multimedia');
      this.showToast('⚠️ Este repuesto no tiene imágenes', 'warning');
      return;
    }
    
    // Filtrar imágenes (tanto tipo como type por compatibilidad)
    this.lightboxMedias = repuesto.multimedia.filter(m => 
      m.tipo === 'image' || m.type === 'image' || m.tipo === 'video' || m.type === 'video'
    );
    console.log('🖼️ Medios encontrados:', this.lightboxMedias.length);
    
    if (this.lightboxMedias.length === 0) {
      console.warn('⚠️ No hay imágenes o videos para mostrar');
      this.showToast('⚠️ No hay imágenes disponibles', 'warning');
      return;
    }
    
    this.lightboxIndex = 0;
    
    // Mostrar lightbox primero
    const lightbox = document.getElementById('lightbox');
    console.log('🎬 Activando lightbox...');
    lightbox.classList.add('active');
    
    // Luego cargar la imagen
    console.log('⏳ Cargando imagen...');
    await this.showLightbox();
    console.log('✅ Lightbox mostrado');
  }

  async showLightbox() {
    const media = this.lightboxMedias[this.lightboxIndex];
    const content = document.getElementById('lightboxContent');
    
    // Mostrar loading mientras se carga
    content.innerHTML = '<div style="color: white; text-align: center; padding: 40px; font-size: 16px;">Cargando imagen...</div>';
    
    if (media.tipo === 'video' || media.type === 'video') {
      content.innerHTML = `<video src="${media.url}" controls autoplay style="max-width: 100%; max-height: 90vh; border-radius: 2px;"></video>`;
    } else {
      // Usar getImageUrl para cargar correctamente desde FileSystem o base64
      const imageUrl = await this.getImageUrl(media);
      
      if (!imageUrl) {
        console.error('❌ No se pudo obtener URL de imagen');
        content.innerHTML = `
          <div style="color: white; text-align: center; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
            <div style="font-size: 16px; margin-bottom: 8px;">No se pudo cargar la imagen</div>
            <div style="font-size: 12px; opacity: 0.7;">${media.filename || 'Sin nombre'}</div>
          </div>
        `;
        return;
      }
      
      console.log('🖼️ URL de imagen:', imageUrl);
      
      // Crear imagen con manejo de errores
      const img = new Image();
      img.onload = () => {
        console.log('✅ Imagen cargada correctamente');
        content.innerHTML = `
          <div id="imageContainer" style="position: relative; display: flex; align-items: center; justify-content: center; width: 100%; height: 90vh; overflow: hidden;">
            <img id="lightboxImage" 
                 src="${imageUrl}" 
                 style="max-width: 100%; max-height: 90vh; transition: transform 0.2s ease; cursor: grab; border-radius: 2px; object-fit: contain;" 
                 alt="Imagen ampliada">
          </div>
        `;
        
        // Inicializar zoom con scroll
        this.initLightboxZoom();
      };
      
      img.onerror = () => {
        console.error('❌ Error al cargar imagen:', imageUrl);
        content.innerHTML = `
          <div style="color: white; text-align: center; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
            <div style="font-size: 16px; margin-bottom: 8px;">No se pudo cargar la imagen</div>
            <div style="font-size: 12px; opacity: 0.7;">${imageUrl}</div>
          </div>
        `;
      };
      
      img.src = imageUrl;
    }
    
    // Actualizar contador
    const counter = document.getElementById('lightboxCounter');
    if (counter) {
      counter.textContent = `${this.lightboxIndex + 1} / ${this.lightboxMedias.length}`;
    }
  }
  
  initLightboxZoom() {
    const container = document.getElementById('imageContainer');
    const img = document.getElementById('lightboxImage');
    
    if (!img || !container) return;
    
    let scale = 1;
    let isDragging = false;
    let startX = 0, startY = 0;
    let translateX = 0, translateY = 0;
    
    // Zoom con rueda del mouse - CENTRADO
    container.addEventListener('wheel', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // Incremento más suave
      const delta = e.deltaY > 0 ? -0.2 : 0.2;
      const newScale = Math.max(0.5, Math.min(5, scale + delta));
      
      if (newScale === scale) return; // No cambió, salir
      
      // Obtener el centro del contenedor
      const containerRect = container.getBoundingClientRect();
      const containerCenterX = containerRect.width / 2;
      const containerCenterY = containerRect.height / 2;
      
      // Calcular nuevo translate para mantener centrado
      const scaleRatio = newScale / scale;
      translateX = containerCenterX + (translateX - containerCenterX) * scaleRatio;
      translateY = containerCenterY + (translateY - containerCenterY) * scaleRatio;
      
      scale = newScale;
      
      // Resetear si volvemos a escala 1
      if (scale === 1) {
        translateX = 0;
        translateY = 0;
        img.style.cursor = 'grab';
        img.style.transform = `scale(1)`;
        img.style.transformOrigin = 'center center';
      } else {
        img.style.cursor = 'grab';
        img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        img.style.transformOrigin = '0 0';
      }
    }, { passive: false });
    
    // Arrastre de imagen (solo si está con zoom)
    img.addEventListener('mousedown', (e) => {
      if (scale > 1) {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        img.style.cursor = 'grabbing';
      }
    });
    
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
      }
    });
    
    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        img.style.cursor = scale > 1 ? 'grab' : 'grab';
      }
    });
    
    // Doble click para resetear zoom
    img.addEventListener('dblclick', (e) => {
      e.preventDefault();
      scale = 1;
      translateX = 0;
      translateY = 0;
      img.style.cursor = 'grab';
      img.style.transform = `scale(1)`;
      img.style.transformOrigin = 'center center';
    });
    
    // Indicador de zoom
    const indicator = document.createElement('div');
    indicator.id = 'zoomIndicator';
    indicator.style.cssText = `
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    `;
    container.appendChild(indicator);
    
    // Actualizar indicador en zoom
    let indicatorTimeout;
    const updateIndicator = () => {
      indicator.textContent = `${Math.round(scale * 100)}%`;
      indicator.style.opacity = '1';
      clearTimeout(indicatorTimeout);
      indicatorTimeout = setTimeout(() => {
        indicator.style.opacity = '0';
      }, 1500);
    };
    
    container.addEventListener('wheel', updateIndicator);
  }

  closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    lightbox.classList.remove('active');
    
    // Limpiar contenido para liberar memoria
    const content = document.getElementById('lightboxContent');
    if (content) {
      content.innerHTML = '';
    }
  }

  async lightboxPrev() {
    this.lightboxIndex = (this.lightboxIndex - 1 + this.lightboxMedias.length) % this.lightboxMedias.length;
    await this.showLightbox();
  }

  async lightboxNext() {
    this.lightboxIndex = (this.lightboxIndex + 1) % this.lightboxMedias.length;
    await this.showLightbox();
  }

  // ===============================================
  // MODAL AGREGAR/EDITAR REPUESTO
  // ===============================================
  
  async openModal(mode, id = null) {
    console.log(`\n📝 ========== ABRIENDO MODAL ==========`);
    console.log(`Modo: ${mode}`);
    console.log(`ID: ${id}`);
    
    this.currentEditingId = id;
    this.currentMultimedia = [];
    this.currentDocuments = [];
    this.multimediaToRemove = []; // Limpiar lista de eliminaciones
    
    // Configurar título
    document.getElementById('modalTitle').textContent = mode === 'edit' ? 'Editar Repuesto' : 'Agregar Repuesto';
    
    // Resetear formulario
    document.getElementById('repuestoForm').reset();
    document.getElementById('imagePreview').innerHTML = '';
    document.getElementById('documentsList').innerHTML = '';
    
    // Limpiar inputs de archivo
    const imagenFile = document.getElementById('imagenFile');
    const documentos = document.getElementById('documentos');
    if (imagenFile) imagenFile.value = '';
    if (documentos) documentos.value = '';
    
    console.log('🧹 Arrays y previews limpiados');
    
    // Poblar select de Tipo
    this.poblarSelectTipo();
    
    // Poblar Nivel 1 (Planta) - siempre habilitado
    this.cargarNivel(1);
    
    // Deshabilitar niveles 2-8 inicialmente
    for (let i = 2; i <= 8; i++) {
      const select = document.getElementById(`nivel${i}`);
      if (select) {
        if (i < 8) {
          select.innerHTML = '<option value="">Seleccionar...</option>';
        } else {
          select.value = '';
        }
        select.disabled = true;
      }
    }
    
    // Inicializar ubicaciones
    this.ubicacionesActuales = [];
    
    if (mode === 'edit' && id) {
      console.log(`Buscando repuesto con ID: "${id}"`);
      
      const repuesto = this.repuestos.find(r => r.id === id || String(r.id) === String(id));
      
      if (repuesto) {
        console.log(`✅ Repuesto encontrado: ${repuesto.nombre}`);
        
        // Llenar campos básicos
        document.getElementById('repuestoId').value = repuesto.id;
        document.getElementById('codSAP').value = repuesto.codSAP || repuesto.codigo_sap || '';
        document.getElementById('codProv').value = repuesto.codProv || repuesto.codigo_prov || '';
        document.getElementById('tipo').value = repuesto.tipo || '';
        document.getElementById('categoria').value = repuesto.categoria || 'Repuesto';
        document.getElementById('nombre').value = repuesto.nombre || '';
        
        // Campos de stock
        document.getElementById('cantidad').value = repuesto.cantidad || 0;
        document.getElementById('cantidadInstalada').value = repuesto.cantidadInstalada || 0;
        document.getElementById('minimo').value = repuesto.minimo || 5;
        document.getElementById('optimo').value = repuesto.optimo || 10;
        document.getElementById('precio').value = repuesto.precio || 0;
        
        // Datos técnicos
        document.getElementById('datosTecnicos').value = repuesto.datosTecnicos || '';
        
        // Cargar ubicaciones (primera ubicación si existe)
        if (repuesto.ubicaciones && repuesto.ubicaciones.length > 0) {
          await this.cargarUbicacionEnFormulario(repuesto.ubicaciones[0]);
        }
        
        // Cargar multimedia existente
        if (repuesto.multimedia && repuesto.multimedia.length > 0) {
          await this.cargarMultimediaEnPreview(repuesto.multimedia);
        }
        
      } else {
        console.error(`❌ Repuesto no encontrado con ID: "${id}"`);
        this.showToast('❌ Error: Repuesto no encontrado', 'error');
        return;
      }
    } else {
      console.log('🆕 Modo AGREGAR nuevo repuesto');
      // Seleccionar valores por defecto
      document.getElementById('categoria').value = 'Repuesto';
      document.getElementById('minimo').value = 5;
      document.getElementById('optimo').value = 10;
    }
    
    // Mostrar modal
    document.getElementById('modal').classList.add('active');
    
    console.log('========== MODAL ABIERTO ==========\n');
  }
  
  // Poblar select de Tipo con opciones existentes
  poblarSelectTipo() {
    const selectTipo = document.getElementById('tipo');
    if (!selectTipo) return;
    
    // Opciones predefinidas
    const tiposPredefinidos = [
      'Mecánico',
      'Eléctrico',
      'Electrónico',
      'Neumático',
      'Hidráulico',
      'Estructural',
      'Consumible',
      'Filtro',
      'Rodamiento',
      'Sello',
      'Válvula',
      'Sensor',
      'Motor',
      'Correa',
      'Cadena',
      'Engranaje'
    ];
    
    // Obtener tipos únicos de repuestos existentes
    const tiposExistentes = [...new Set(this.repuestos
      .map(r => r.tipo)
      .filter(t => t && t.trim())
    )];
    
    // Combinar y ordenar
    const todosLosTipos = [...new Set([...tiposPredefinidos, ...tiposExistentes])].sort();
    
    // Poblar select
    selectTipo.innerHTML = '<option value="">Seleccionar tipo...</option>';
    todosLosTipos.forEach(tipo => {
      const opt = document.createElement('option');
      opt.value = tipo;
      opt.textContent = tipo;
      selectTipo.appendChild(opt);
    });
  }
  
  // Cargar multimedia existente en preview (modo edición)
  async cargarMultimediaEnPreview(multimedia) {
    if (!multimedia || multimedia.length === 0) return;
    
    console.log(`📸 Cargando ${multimedia.length} imagen(es) existente(s)...`);
    
    const previewContainer = document.getElementById('imagePreview');
    const fs = window.fsManager || fsManager;
    
    for (const media of multimedia) {
      try {
        let imageUrl = null;
        
        // SOLO cargar desde FileSystem
        if (media.url && fs && fs.isConnected) {
          const filename = media.url.replace('./imagenes/', '');
          imageUrl = await fs.loadImage(filename);
        }
        
        if (!imageUrl) {
          console.warn(`⚠️ No se pudo cargar: ${media.filename}`);
          continue;
        }
        
        // Calcular tamaños
        const compressedSizeKB = (media.size / 1024).toFixed(1);
        const originalSizeKB = media.originalSize ? (media.originalSize / 1024).toFixed(1) : compressedSizeKB;
        const reduction = media.originalSize ? ((1 - media.size / media.originalSize) * 100).toFixed(0) : '0';
        
        // Crear preview con atributo especial para identificar imágenes existentes
        const previewItem = document.createElement('div');
        previewItem.className = 'multimedia-preview-item';
        previewItem.setAttribute('data-existing-media', 'true'); // Marcar como existente
        previewItem.innerHTML = `
          <img src="${imageUrl}" alt="${media.originalName}">
          <button type="button" class="multimedia-remove-btn" onclick="app.removeMultimedia('${media.filename}', 'image', true)" title="Eliminar imagen">
            ×
          </button>
          <div class="multimedia-preview-info">
            <div class="multimedia-preview-name" title="${media.originalName}">${media.filename}</div>
            <div class="multimedia-preview-size">
              <span class="size-original" style="text-decoration: line-through; opacity: 0.6;">${originalSizeKB}KB</span>
              <span class="size-arrow" style="margin: 0 4px;">→</span>
              <span class="size-compressed" style="color: #4ade80; font-weight: 600;">${compressedSizeKB}KB</span>
              <span class="size-reduction" style="margin-left: 6px; background: rgba(74, 222, 128, 0.2); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700;">-${reduction}%</span>
            </div>
          </div>
        `;
        
        previewContainer.appendChild(previewItem);
        console.log(`  ✅ Cargada: ${media.filename}`);
        
      } catch (error) {
        console.error(`❌ Error cargando ${media.filename}:`, error);
      }
    }
  }
  
  // Cargar ubicación en formulario (cascada jerárquica)
  async cargarUbicacionEnFormulario(ubicacion) {
    if (!ubicacion) return;
    
    console.log('📍 Cargando ubicación en formulario:', ubicacion);
    
    // Cargar nivel 1 (Planta)
    const nivel1Select = document.getElementById('nivel1');
    if (nivel1Select && ubicacion.planta) {
      nivel1Select.value = ubicacion.planta;
    }
    
    // Cargar nivel 2 (Área General) si existe
    if (ubicacion.areaGeneral) {
      await this.cargarNivel(2);
      const nivel2Select = document.getElementById('nivel2');
      if (nivel2Select) {
        // Esperar un momento para que se carguen las opciones
        setTimeout(() => {
          nivel2Select.value = ubicacion.areaGeneral;
          
          // Cargar nivel 3 (Sub-área) si existe
          if (ubicacion.subArea) {
            this.cargarNivel(3);
            setTimeout(() => {
              const nivel3Select = document.getElementById('nivel3');
              if (nivel3Select) {
                nivel3Select.value = ubicacion.subArea;
                
                // Continuar con los demás niveles...
                if (ubicacion.sistemaEquipo) {
                  this.cargarNivel(4);
                  setTimeout(() => {
                    document.getElementById('nivel4').value = ubicacion.sistemaEquipo;
                    
                    if (ubicacion.subSistema) {
                      this.cargarNivel(5);
                      setTimeout(() => {
                        document.getElementById('nivel5').value = ubicacion.subSistema;
                        
                        if (ubicacion.seccion) {
                          this.cargarNivel(6);
                          setTimeout(() => {
                            document.getElementById('nivel6').value = ubicacion.seccion;
                            
                            if (ubicacion.subSeccion) {
                              this.cargarNivel(7);
                              setTimeout(() => {
                                document.getElementById('nivel7').value = ubicacion.subSeccion;
                                
                                if (ubicacion.detalles) {
                                  this.cargarNivel(8);
                                  setTimeout(() => {
                                    document.getElementById('nivel8').value = ubicacion.detalles;
                                  }, 50);
                                }
                              }, 50);
                            }
                          }, 50);
                        }
                      }, 50);
                    }
                  }, 50);
                }
              }
            }, 50);
          }
        }, 50);
      }
    }
  }

  closeModal() {
    document.getElementById('modal').classList.remove('active');
  }

  // Cargar opciones del siguiente nivel (cascada)
  cargarNivel(nivel) {
    console.log(`🔄 Cargando nivel ${nivel}...`);
    
    const selectActual = document.getElementById(`nivel${nivel}`);
    if (!selectActual) {
      console.warn(`⚠️ No se encontró select para nivel ${nivel}`);
      return;
    }
    
    // Obtener el valor del nivel anterior para filtrar opciones
    let valorNivelAnterior = null;
    if (nivel > 1) {
      const selectAnterior = document.getElementById(`nivel${nivel - 1}`);
      valorNivelAnterior = selectAnterior?.value;
      
      if (!valorNivelAnterior) {
        console.warn(`⚠️ Nivel anterior (${nivel - 1}) no tiene valor seleccionado`);
        return;
      }
    }
    
    // Cargar opciones según el nivel
    const opciones = this.getOpcionesNivel(nivel, valorNivelAnterior);
    
    // Poblar el select
    if (nivel < 8) {
      selectActual.innerHTML = '<option value="">Seleccionar...</option>';
      opciones.forEach(opcion => {
        const opt = document.createElement('option');
        opt.value = opcion;
        opt.textContent = opcion;
        selectActual.appendChild(opt);
      });
      selectActual.disabled = false;
    } else {
      // Nivel 8 es input text, no select
      selectActual.disabled = false;
      selectActual.placeholder = 'Ej: Pocket 3, Zona A, etc.';
    }
    
    // Limpiar y deshabilitar niveles posteriores
    for (let i = nivel + 1; i <= 8; i++) {
      const selectPosterior = document.getElementById(`nivel${i}`);
      if (selectPosterior) {
        if (i < 8) {
          selectPosterior.innerHTML = '<option value="">Seleccionar...</option>';
          selectPosterior.disabled = true;
        } else {
          selectPosterior.value = '';
          selectPosterior.disabled = true;
        }
      }
    }
    
    console.log(`✅ Nivel ${nivel} cargado con ${opciones.length} opciones`);
  }
  
  // Obtener opciones para un nivel específico (con filtrado por nivel anterior)
  getOpcionesNivel(nivel, valorNivelAnterior = null) {
    // Mapeo de niveles a keys de configuración
    const nivelMap = {
      1: 'planta',        // N1: Empresa/Planta
      2: 'areaGeneral',   // N2: Área
      3: 'subArea',       // N3: Sub-área
      4: 'sistemaEquipo', // N4: Sistema/Equipo
      5: 'subSistema',    // N5: Sub-sistema
      6: 'seccion',       // N6: Sección
      7: 'subSeccion'     // N7: Sub-sección
    };
    
    const key = nivelMap[nivel];
    if (!key) {
      console.warn(`⚠️ Nivel ${nivel} no tiene mapeo de configuración`);
      return [];
    }
    
    // Para nivel 1 (Planta), siempre retornar la planta base
    if (nivel === 1) {
      return [this.plantaBase];
    }
    
    // Obtener opciones desde la configuración predefinida
    let opciones = this.opcionesJerarquiaPredefinidas[key] || [];
    
    // TODO: En el futuro, aquí se puede implementar filtrado basado en valorNivelAnterior
    // Por ejemplo: si nivel=5 (subSistema) y valorNivelAnterior='Grader Marel',
    // solo mostrar subsistemas relevantes a Grader
    
    // Agregar opciones únicas de repuestos existentes
    const opcionesExistentes = this.getOpcionesExistentes(key);
    opciones = [...new Set([...opciones, ...opcionesExistentes])].sort();
    
    return opciones;
  }
  
  // Obtener opciones únicas de repuestos existentes
  getOpcionesExistentes(campo) {
    const valores = new Set();
    
    this.repuestos.forEach(rep => {
      if (rep.ubicaciones && Array.isArray(rep.ubicaciones)) {
        rep.ubicaciones.forEach(ub => {
          if (ub[campo] && ub[campo].trim()) {
            valores.add(ub[campo].trim());
          }
        });
      }
    });
    
    return Array.from(valores);
  }

  // Vincular con área del mapa
  vincularConMapa() {
    console.log('🗺️ Vincular con mapa...');
    // TODO: Implementar vinculación con áreas del mapa
    this.showToast('🚧 Función en desarrollo', 'info');
  }

  // ===============================================
  // GUARDAR REPUESTO (AGREGAR/EDITAR)
  // ===============================================
  
  async saveRepuesto(event) {
    event.preventDefault();
    
    console.log('\n💾 ========== GUARDANDO REPUESTO ==========');
    
    // Obtener valores del formulario
    const formData = {
      codSAP: document.getElementById('codSAP').value.trim(),
      codProv: document.getElementById('codProv').value.trim(),
      tipo: document.getElementById('tipo').value.trim(),
      categoria: document.getElementById('categoria').value.trim(),
      nombre: document.getElementById('nombre').value.trim(),
      cantidad: parseInt(document.getElementById('cantidad').value) || 0,
      cantidadInstalada: parseInt(document.getElementById('cantidadInstalada').value) || 0,
      minimo: parseInt(document.getElementById('minimo').value) || 5,
      optimo: parseInt(document.getElementById('optimo').value) || 10,
      precio: parseFloat(document.getElementById('precio').value) || 0,
      datosTecnicos: document.getElementById('datosTecnicos').value.trim()
    };
    
    // Validaciones básicas
    if (!formData.nombre) {
      this.showToast('❌ El nombre es obligatorio', 'error');
      document.getElementById('nombre').focus();
      return;
    }
    
    if (!formData.categoria) {
      this.showToast('❌ La categoría es obligatoria', 'error');
      document.getElementById('categoria').focus();
      return;
    }
    
    // Validar que al menos nivel 1 y 2 estén seleccionados
    const nivel1 = document.getElementById('nivel1').value.trim();
    const nivel2 = document.getElementById('nivel2').value.trim();
    
    if (!nivel1) {
      this.showToast('❌ Debes seleccionar N1: Empresa/Planta', 'error');
      return;
    }
    
    if (!nivel2) {
      this.showToast('❌ Debes seleccionar N2: Área', 'error');
      return;
    }
    
    // Construir objeto de ubicación jerárquica
    const ubicacion = {
      planta: nivel1,
      areaGeneral: nivel2,
      subArea: document.getElementById('nivel3').value.trim() || '',
      sistemaEquipo: document.getElementById('nivel4').value.trim() || '',
      subSistema: document.getElementById('nivel5').value.trim() || '',
      seccion: document.getElementById('nivel6').value.trim() || '',
      subSeccion: document.getElementById('nivel7').value.trim() || '',
      detalles: document.getElementById('nivel8').value.trim() || ''
    };
    
    console.log('📋 Datos del formulario:', formData);
    console.log('📍 Ubicación jerárquica:', ubicacion);
    
    // Determinar si es edición o nuevo repuesto
    const repuestoId = document.getElementById('repuestoId').value;
    const isEdit = !!repuestoId;
    
    if (isEdit) {
      // MODO EDICIÓN
      console.log(`✏️ Editando repuesto ID: ${repuestoId}`);
      
      const repuesto = this.repuestos.find(r => String(r.id) === String(repuestoId));
      
      if (!repuesto) {
        this.showToast('❌ Error: Repuesto no encontrado', 'error');
        return;
      }
      
      // Actualizar campos
      Object.assign(repuesto, formData);
      
      // Actualizar ubicaciones (usar la primera o crear nueva)
      if (!repuesto.ubicaciones) {
        repuesto.ubicaciones = [];
      }
      
      if (repuesto.ubicaciones.length > 0) {
        Object.assign(repuesto.ubicaciones[0], ubicacion);
      } else {
        repuesto.ubicaciones.push(ubicacion);
      }
      
      // 1. Aplicar eliminaciones de multimedia marcadas
      if (this.multimediaToRemove && this.multimediaToRemove.length > 0) {
        console.log(`🗑️ Eliminando ${this.multimediaToRemove.length} imagen(es) existente(s)`);
        repuesto.multimedia = (repuesto.multimedia || []).filter(
          m => !this.multimediaToRemove.includes(m.filename)
        );
      }
      
      // 2. Procesar SOLO multimedia NUEVA (currentMultimedia)
      if (this.currentMultimedia && this.currentMultimedia.length > 0) {
        console.log(`📸 Procesando ${this.currentMultimedia.length} imagen(es) NUEVA(S)`);
        
        const fs = window.fsManager || fsManager;
        
        // VERIFICAR FileSystem conectado
        if (!fs || !fs.isConnected) {
          this.showToast('❌ Debes conectar FileSystem para guardar imágenes', 'error', 5000);
          console.error('❌ FileSystem NO conectado - imágenes NO guardadas');
          return; // NO guardar sin FileSystem
        }
        
        // Guardar en FileSystem
        const imagesSaved = await this.saveImagesToFileSystem(this.currentMultimedia, repuesto);
        
        if (imagesSaved) {
          // Guardar solo referencias (NO base64)
          const multimediaRefs = this.currentMultimedia.map(img => ({
            tipo: 'image',
            filename: img.filename,
            originalName: img.originalName,
            size: img.size,
            mimeType: img.mimeType,
            uploadDate: img.uploadDate,
            compressed: img.compressed,
            originalSize: img.originalSize,
            url: `./imagenes/${img.filename}`
            // NO incluir data
          }));
          
          const multimediaExistente = repuesto.multimedia || [];
          repuesto.multimedia = [...multimediaExistente, ...multimediaRefs];
          console.log(`✅ Imágenes guardadas en FileSystem: ${repuesto.multimedia.length} total`);
        } else {
          this.showToast('❌ Error guardando imágenes en FileSystem', 'error');
          return; // NO continuar si falla
        }
      }
      
      if (this.currentDocuments && this.currentDocuments.length > 0) {
        // Combinar documentos existentes con nuevos
        const documentosExistentes = repuesto.documentos || [];
        repuesto.documentos = [...documentosExistentes, ...this.currentDocuments];
        console.log(`📎 Agregados ${this.currentDocuments.length} nuevos documentos (total: ${repuesto.documentos.length})`);
      }
      
      // Actualizar fecha de modificación
      repuesto.fechaModificacion = new Date().toISOString();
      
      console.log('✅ Repuesto actualizado:', repuesto.nombre);
      
    } else {
      // MODO AGREGAR NUEVO
      console.log('🆕 Creando nuevo repuesto');
      
      // Verificar código SAP duplicado (si se proporciona)
      if (formData.codSAP) {
        const duplicado = this.repuestos.find(r => 
          r.codSAP === formData.codSAP || r.codigo_sap === formData.codSAP
        );
        
        if (duplicado) {
          const confirmar = confirm(
            `⚠️ CÓDIGO SAP DUPLICADO\n\n` +
            `Ya existe un repuesto con código SAP "${formData.codSAP}":\n` +
            `"${duplicado.nombre}"\n\n` +
            `¿Deseas crear el repuesto de todas formas?`
          );
          
          if (!confirmar) {
            return;
          }
        }
      }
      
      // Generar nuevo ID
      const maxId = this.repuestos.length > 0 
        ? Math.max(...this.repuestos.map(r => parseInt(r.id) || 0))
        : 0;
      const nuevoId = maxId + 1;
      
      // Preparar multimedia - SOLO FileSystem
      let multimediaFinal = [];
      if (this.currentMultimedia && this.currentMultimedia.length > 0) {
        const fs = window.fsManager || fsManager;
        
        if (!fs || !fs.isConnected) {
          this.showToast('❌ Debes conectar FileSystem para guardar imágenes', 'error', 5000);
          return; // NO crear repuesto sin FileSystem para imágenes
        }
        
        const tempRepuesto = { id: nuevoId, ...formData, ubicaciones: [ubicacion] };
        const imagesSaved = await this.saveImagesToFileSystem(this.currentMultimedia, tempRepuesto);
        
        if (imagesSaved) {
          // Solo referencias
          multimediaFinal = this.currentMultimedia.map(img => ({
            tipo: 'image',
            filename: img.filename,
            originalName: img.originalName,
            size: img.size,
            mimeType: img.mimeType,
            uploadDate: img.uploadDate,
            compressed: img.compressed,
            originalSize: img.originalSize,
            url: `./imagenes/${img.filename}`
          }));
        } else {
          this.showToast('❌ Error guardando imágenes', 'error');
          return;
        }
      }
      
      // Crear nuevo repuesto
      const nuevoRepuesto = {
        id: nuevoId,
        ...formData,
        ubicaciones: [ubicacion],
        multimedia: multimediaFinal,
        documentos: this.currentDocuments || [],
        fechaCreacion: new Date().toISOString(),
        fechaModificacion: new Date().toISOString()
      };
      
      // Agregar a la lista
      this.repuestos.push(nuevoRepuesto);
      
      console.log('✅ Nuevo repuesto creado:', nuevoRepuesto.nombre, '- ID:', nuevoId);
    }
    
    // Guardar datos
    try {
      const saveSuccess = await this.saveData();
      
      if (saveSuccess !== false) {
        this.showToast(`✅ Repuesto ${isEdit ? 'actualizado' : 'creado'} exitosamente`, 'success');
        
        // Cerrar modal
        this.closeModal();
        
        // Actualizar vista
        this.applyFiltersAndRender();
        
        console.log('========== GUARDADO COMPLETO ==========\n');
      } else {
        this.showToast('⚠️ Repuesto creado pero no guardado (excede límite)', 'warning', 5000);
      }
    } catch (error) {
      console.error('❌ Error al guardar:', error);
      this.showToast('❌ Error al guardar: ' + error.message, 'error');
    }
  }

  // ===============================================
  // MANEJO DE MULTIMEDIA (IMÁGENES Y DOCUMENTOS)
  // ===============================================
  
  async handleMultimedia(event, type) {
    const files = Array.from(event.target.files);
    
    if (files.length === 0) return;
    
    console.log(`📎 Procesando ${files.length} archivo(s) de tipo: ${type}`);
    
    if (type === 'image') {
      await this.handleImageUpload(files, event);
    } else if (type === 'document') {
      await this.handleDocumentUpload(files, event);
    }
  }
  
  async handleImageUpload(files, event) {
    const previewContainer = document.getElementById('imagePreview');
    
    // =========================================
    // LEER OPCIONES DE OPTIMIZACIÓN DEL USUARIO
    // =========================================
    const optimizarCheckbox = document.getElementById('optimizarImagenes');
    const calidadSelect = document.getElementById('calidadOptimizacion');
    const anchoMaximoSelect = document.getElementById('anchoMaximo');
    
    const debeOptimizar = optimizarCheckbox ? optimizarCheckbox.checked : true;
    const calidadUsuario = calidadSelect ? parseFloat(calidadSelect.value) : 0.85;
    const anchoMaximoUsuario = anchoMaximoSelect ? parseInt(anchoMaximoSelect.value) : 800;
    
    console.log(`🔧 Opciones de optimización: ${debeOptimizar ? 'SÍ' : 'NO'} | Calidad: ${(calidadUsuario * 100).toFixed(0)}% | Ancho máx: ${anchoMaximoUsuario}px`);
    
    for (const file of files) {
      // Validar que sea imagen
      if (!file.type.startsWith('image/')) {
        this.showToast(`❌ ${file.name} no es una imagen válida`, 'error');
        continue;
      }
      
      // Validar tamaño original (máximo 10MB antes de comprimir)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        this.showToast(`❌ ${file.name} excede 10MB (${(file.size / (1024 * 1024)).toFixed(1)}MB)`, 'error');
        continue;
      }
      
      try {
        console.log(`📸 Procesando: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
        
        // Comprimir imagen a WebP (o no, según configuración)
        const compressedBase64 = debeOptimizar 
          ? await this.compressImageToWebP(file, anchoMaximoUsuario, calidadUsuario)
          : await this.fileToBase64(file); // Guardar original sin optimizar
        
        if (!compressedBase64) {
          this.showToast(`❌ Error al procesar ${file.name}`, 'error');
          continue;
        }
        
        // Calcular tamaño final
        const finalSize = (compressedBase64.length * 0.75) / 1024; // Aproximado en KB
        const reduction = ((1 - finalSize / (file.size / 1024)) * 100).toFixed(0);
        
        if (debeOptimizar) {
          console.log(`✅ Optimizada: ${file.name} → ${finalSize.toFixed(1)}KB (${reduction}% reducción)`);
        } else {
          console.log(`✅ Original: ${file.name} → ${finalSize.toFixed(1)}KB (sin optimizar)`);
        }
        
        // Generar nombre único con extensión .webp
        const timestamp = Date.now();
        const baseName = file.name.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');
        const filename = `${timestamp}_${baseName}.webp`;
        
        // Agregar a multimedia actual
        if (!this.currentMultimedia) {
          this.currentMultimedia = [];
        }
        
        this.currentMultimedia.push({
          tipo: 'image',
          filename: filename,
          originalName: file.name,
          data: compressedBase64,
          size: Math.round(finalSize * 1024), // Tamaño en bytes
          mimeType: 'image/webp',
          uploadDate: new Date().toISOString(),
          compressed: debeOptimizar,
          originalSize: file.size
        });
        
        // Crear preview
        const previewItem = document.createElement('div');
        previewItem.className = 'multimedia-preview-item';
        
        // Calcular tamaño original en formato legible
        const originalSizeKB = (file.size / 1024).toFixed(1);
        
        previewItem.innerHTML = `
          <img src="${compressedBase64}" alt="${file.name}">
          <button type="button" class="multimedia-remove-btn" onclick="app.removeMultimedia('${filename}', 'image')" title="Eliminar imagen">
            ×
          </button>
          <div class="multimedia-preview-info">
            <div class="multimedia-preview-name" title="${file.name}">${baseName}.webp</div>
            <div class="multimedia-preview-size">
              ${debeOptimizar 
                ? `<span class="size-original" style="text-decoration: line-through; opacity: 0.6;">${originalSizeKB}KB</span>
                   <span class="size-arrow" style="margin: 0 4px;">→</span>
                   <span class="size-compressed" style="color: #4ade80; font-weight: 600;">${finalSize.toFixed(1)}KB</span>
                   <span class="size-reduction" style="margin-left: 6px; background: rgba(74, 222, 128, 0.2); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700;">-${reduction}%</span>`
                : `<span class="size-compressed" style="color: #60a5fa; font-weight: 600;">${finalSize.toFixed(1)}KB</span>
                   <span class="size-reduction" style="margin-left: 6px; background: rgba(96, 165, 250, 0.2); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700;">Original</span>`
              }
            </div>
          </div>
        `;
        
        previewContainer.appendChild(previewItem);
        
      } catch (error) {
        console.error(`❌ Error procesando ${file.name}:`, error);
        this.showToast(`❌ Error al procesar ${file.name}`, 'error');
      }
    }
    
    // Limpiar input
    event.target.value = '';
    
    const mensajeToast = debeOptimizar 
      ? `✅ ${files.length} imagen(es) optimizada(s) a WebP`
      : `✅ ${files.length} imagen(es) cargada(s) sin optimizar`;
    this.showToast(mensajeToast, 'success', 2000);
  }
  
  // Comprimir imagen a WebP con optimización adaptativa
  async compressImageToWebP(file, maxWidth = 800, quality = 0.85) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          // Redimensionar manteniendo aspecto
          if (width > maxWidth || height > maxWidth) {
            if (width > height) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            } else {
              width = (width * maxWidth) / height;
              height = maxWidth;
            }
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          
          // Optimización de renderizado
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          
          // Fondo blanco para transparencias
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, width, height);
          
          // Dibujar imagen con suavizado
          ctx.drawImage(img, 0, 0, width, height);

          // Intentar WebP primero (mejor compresión)
          let compressedUrl = null;
          let format = 'webp';
          
          try {
            compressedUrl = canvas.toDataURL('image/webp', quality);
            
            // Si WebP no funciona o es muy grande, probar JPEG
            if (!compressedUrl.startsWith('data:image/webp') || compressedUrl.length > 200000) {
              format = 'jpeg';
              compressedUrl = canvas.toDataURL('image/jpeg', quality);
            }
          } catch (e) {
            // Fallback a JPEG si WebP no está soportado
            format = 'jpeg';
            compressedUrl = canvas.toDataURL('image/jpeg', quality);
          }

          // Optimización adaptativa de calidad
          let currentQuality = quality;
          let iterations = 0;
          
          // Tamaño objetivo basado en la calidad inicial del usuario
          // Calidad alta (>0.8) → ~150KB, Media (0.7-0.8) → ~100KB, Baja (<0.7) → ~70KB
          let targetSize = 150000; // Por defecto ~150KB
          if (quality >= 0.80) {
            targetSize = 200000; // ~200KB para calidad máxima
          } else if (quality >= 0.70) {
            targetSize = 150000; // ~150KB para calidad alta/media
          } else if (quality >= 0.60) {
            targetSize = 100000; // ~100KB para calidad media-baja
          } else {
            targetSize = 70000;  // ~70KB para calidad baja
          }
          
          // Intentar reducir tamaño sin bajar demasiado la calidad
          while (compressedUrl.length > targetSize && currentQuality > 0.5 && iterations < 5) {
            currentQuality -= 0.08;
            compressedUrl = canvas.toDataURL(`image/${format}`, currentQuality);
            iterations++;
          }
          
          const finalSizeKB = (compressedUrl.length * 0.75 / 1024).toFixed(1);
          console.log(`  → Formato: ${format.toUpperCase()}, ${finalSizeKB}KB, calidad: ${(currentQuality * 100).toFixed(0)}%`);

          resolve(compressedUrl);
        };
        img.onerror = () => {
          console.error('❌ Error cargando imagen para comprimir');
          resolve(null);
        };
        img.src = e.target.result;
      };
      reader.onerror = () => {
        console.error('❌ Error leyendo archivo');
        resolve(null);
      };
      reader.readAsDataURL(file);
    });
  }
  
  async handleDocumentUpload(files, event) {
    const documentsContainer = document.getElementById('documentsList');
    
    for (const file of files) {
      // Validar tamaño (máximo 10MB por documento)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        this.showToast(`❌ ${file.name} excede 10MB (${(file.size / (1024 * 1024)).toFixed(1)}MB)`, 'error');
        continue;
      }
      
      try {
        // Leer archivo como base64
        const base64 = await this.fileToBase64(file);
        
        // Generar nombre único
        const timestamp = Date.now();
        const filename = `${timestamp}_${file.name}`;
        
        // Agregar a documentos actuales
        if (!this.currentDocuments) {
          this.currentDocuments = [];
        }
        
        this.currentDocuments.push({
          tipo: 'document',
          filename: filename,
          originalName: file.name,
          data: base64,
          size: file.size,
          mimeType: file.type,
          uploadDate: new Date().toISOString()
        });
        
        // Determinar icono según tipo
        let icon = '📄';
        if (file.type.includes('pdf')) icon = '📕';
        else if (file.type.includes('excel') || file.type.includes('spreadsheet')) icon = '📊';
        else if (file.type.includes('word') || file.type.includes('document')) icon = '📝';
        else if (file.type.includes('video')) icon = '🎥';
        
        // Crear item en lista
        const documentItem = document.createElement('div');
        documentItem.className = 'document-list-item';
        documentItem.innerHTML = `
          <span class="document-icon">${icon}</span>
          <span class="document-name">${file.name}</span>
          <span class="document-size">(${(file.size / 1024).toFixed(1)}KB)</span>
          <button type="button" class="document-remove-btn" onclick="app.removeMultimedia('${filename}', 'document')" title="Eliminar documento">
            ×
          </button>
        `;
        
        documentsContainer.appendChild(documentItem);
        
        console.log(`✅ Documento agregado: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
        
      } catch (error) {
        console.error(`❌ Error procesando ${file.name}:`, error);
        this.showToast(`❌ Error al procesar ${file.name}`, 'error');
      }
    }
    
    // Limpiar input
    event.target.value = '';
    
    this.showToast(`✅ ${files.length} documento(s) agregado(s)`, 'success', 2000);
  }
  
  // Convertir archivo a base64
  fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
      reader.readAsDataURL(file);
    });
  }
  
  // Eliminar multimedia del preview
  removeMultimedia(filename, type, isExisting = false) {
    console.log(`🗑️ Eliminando ${type}: ${filename} (existente: ${isExisting})`);
    
    if (type === 'image') {
      // Solo eliminar de currentMultimedia si NO es una imagen existente
      if (!isExisting) {
        this.currentMultimedia = this.currentMultimedia.filter(m => m.filename !== filename);
      } else {
        // Si es existente, marcarla para eliminación del repuesto
        if (!this.multimediaToRemove) {
          this.multimediaToRemove = [];
        }
        this.multimediaToRemove.push(filename);
        console.log(`📌 Marcada para eliminación: ${filename}`);
      }
      
      // Eliminar del preview
      const previewContainer = document.getElementById('imagePreview');
      const items = previewContainer.querySelectorAll('.multimedia-preview-item');
      items.forEach(item => {
        const btn = item.querySelector('.multimedia-remove-btn');
        if (btn && btn.getAttribute('onclick').includes(filename)) {
          item.remove();
        }
      });
      
      this.showToast('🗑️ Imagen eliminada', 'info', 2000);
      
    } else if (type === 'document') {
      // Eliminar de currentDocuments
      this.currentDocuments = this.currentDocuments.filter(d => d.filename !== filename);
      
      // Eliminar de la lista
      const documentsContainer = document.getElementById('documentsList');
      const items = documentsContainer.querySelectorAll('.document-list-item');
      items.forEach(item => {
        const btn = item.querySelector('.document-remove-btn');
        if (btn && btn.getAttribute('onclick').includes(filename)) {
          item.remove();
        }
      });
      
      this.showToast('🗑️ Documento eliminado', 'info', 2000);
    }
  }

  // ===============================================
  // GUARDAR IMÁGENES EN FILESYSTEM
  // ===============================================
  
  async saveImagesToFileSystem(multimedia, repuesto) {
    // Verificar si FileSystem está disponible
    const fs = window.fsManager || fsManager;
    if (!fs || !fs.isConnected) {
      console.log('⚠️ FileSystem no disponible, guardando en JSON');
      return false;
    }
    
    try {
      console.log(`💾 Guardando ${multimedia.length} imagen(es) en FileSystem...`);
      
      for (const media of multimedia) {
        if (!media.data || !media.filename) continue;
        
        // Convertir base64 a Blob
        const base64Data = media.data.split(',')[1];
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: media.mimeType });
        
        // Guardar en carpeta imagenes/
        const success = await fs.saveImage(blob, media.filename);
        
        if (success) {
          console.log(`  ✅ ${media.filename} guardada (${(blob.size / 1024).toFixed(1)}KB)`);
        } else {
          console.error(`  ❌ Error guardando ${media.filename}`);
        }
      }
      
      return true;
    } catch (error) {
      console.error('❌ Error guardando imágenes en FileSystem:', error);
      return false;
    }
  }

  // ===============================================
  // SINCRONIZACIÓN DE UBICACIONES DESDE EL DOM
  // ===============================================
  
  /**
   * Sincroniza ubicacionesActuales con los valores del DOM
   * Se llama antes de guardar imgenes o el repuesto
   */
  sincronizarUbicacionesDesdeDOM() {
    if (!this.ubicacionesActuales || this.ubicacionesActuales.length === 0) {
      console.warn('  No hay ubicacionesActuales para sincronizar');
      return;
    }
    
    console.log('  Sincronizando ubicaciones desde DOM...');
    this.ubicacionesActuales.forEach((ub, idx) => {
      const inputs = document.querySelectorAll(`[data-ubicacion-id="${ub.id}"]`);
      inputs.forEach(input => {
        const field = input.dataset.field;
        const value = input.value;
        if (ub[field] !== value) {
          console.log(`    Ubicacin ${idx + 1} - ${field}: "${ub[field]}" - "${value}"`);
          ub[field] = value;
        }
      });
    });
    
    // Log del estado actualizado
    console.log('- Ubicaciones sincronizadas:');
    this.ubicacionesActuales.forEach((ub, idx) => {
      console.log(`  ${idx + 1}. rea: "${ub.areaGeneral || '(vaco)'}"`);
    });
  }

  // ===============================================
  // SISTEMA DE ORGANIZACIN AUTOMTICA DE IMGENES
  // ===============================================

  /**
   * Normaliza un nombre para usarlo como nombre de carpeta
   * Elimina caracteres especiales, acentos y espacios
   */
  normalizarNombreCarpeta(texto) {
    if (!texto || texto.trim() === '') return '_SIN_NOMBRE';
    
    return texto
      .trim()
      .toUpperCase()
      // Reemplazar acentos
      .replace(/[]/gi, 'A')
      .replace(/[]/gi, 'E')
      .replace(/[]/gi, 'I')
      .replace(/[]/gi, 'O')
      .replace(/[]/gi, 'U')
      .replace(/[]/gi, 'N')
      // Solo alfanumricos, espacios, guiones y guiones bajos
      .replace(/[^A-Z0-9\s_-]/g, '')
      // Espacios a guiones bajos
      .replace(/\s+/g, '_')
      // Mltiples guiones bajos a uno solo
      .replace(/_+/g, '_')
      // Mximo 50 caracteres
      .substring(0, 50);
  }

  /**
   * Codifica una ruta jerrquica en un nombre de archivo plano
   * Ej: "PLANTA_YAL/EMPARILLADO/archivo.webp" - "PLANTA_YAL__EMPARILLADO__archivo.webp"
   */
  codificarRutaJerarquica(rutaJerarquica) {
    return rutaJerarquica.replace(/\//g, '__');
  }

  /**
   * Decodifica un nombre de archivo plano a ruta jerrquica
   * Ej: "PLANTA_YAL__EMPARILLADO__archivo.webp" - "PLANTA_YAL/EMPARILLADO/archivo.webp"
   */
  decodificarRutaJerarquica(nombreArchivo) {
    return nombreArchivo.replace(/__/g, '/');
  }

  /**
   * Genera un nombre de archivo descriptivo automticamente
   * Formato: SAP_NOMBRE_TIMESTAMP_INDEX.webp
   */
  generarNombreArchivo(repuesto, imageIndex = 0) {
    // 1. Cdigo SAP (mx 20 caracteres)
    const codigoSAP = (repuesto.codSAP || 'SAP_PENDIENTE')
      .replace(/[^a-zA-Z0-9_-]/g, '')
      .substring(0, 20);
    
    // 2. Nombre del repuesto (mx 40 caracteres)
    const nombreNormalizado = repuesto.nombre
      .toUpperCase()
      .trim()
      .replace(/[]/gi, 'A')
      .replace(/[]/gi, 'E')
      .replace(/[]/gi, 'I')
      .replace(/[]/gi, 'O')
      .replace(/[]/gi, 'U')
      .replace(/[]/gi, 'N')
      .replace(/[^A-Z0-9\s]/g, '') // Solo letras, nmeros y espacios
      .replace(/\s+/g, '_')        // Espacios - guiones bajos
      .substring(0, 40);
    
    // 3. Timestamp nico
    const timestamp = Date.now();
    
    // 4. ndice (si hay mltiples imgenes)
    const suffix = imageIndex > 0 ? `_${imageIndex + 1}` : '';
    
    // Resultado: SAP_NOMBRE_TIMESTAMP_INDEX.webp
    return `${codigoSAP}_${nombreNormalizado}_${timestamp}${suffix}.webp`;
  }

  /**
   * Genera la ruta jerrquica segn la ubicacin del repuesto
   */
  generarRutaImagen(ubicacion) {
    const partes = ['imagenes']; // Siempre empieza con /imagenes/
    
    // Nivel 1: rea General (OBLIGATORIO)
    if (ubicacion.areaGeneral && ubicacion.areaGeneral.trim() !== '') {
      partes.push(this.normalizarNombreCarpeta(ubicacion.areaGeneral));
    } else {
      partes.push('_SIN_UBICACION');
    }
    
    // Nivel 2: Sistema/Equipo (OPCIONAL - solo si nivelJerarquiaImagenes >= 2)
    if (this.nivelJerarquiaImagenes >= 2 && ubicacion.sistemaEquipo && ubicacion.sistemaEquipo.trim() !== '') {
      partes.push(this.normalizarNombreCarpeta(ubicacion.sistemaEquipo));
    }
    
    // Nivel 3: Sub-Sistema (OPCIONAL - solo si nivelJerarquiaImagenes >= 3)
    if (this.nivelJerarquiaImagenes >= 3 && ubicacion.subSistema && ubicacion.subSistema.trim() !== '') {
      partes.push(this.normalizarNombreCarpeta(ubicacion.subSistema));
    }
    
    return './' + partes.join('/');
  }

  /**
   * Crea las carpetas jerrquicas automticamente si no existen
   */
  async crearCarpetasJerarquicas(ubicacion) {
    console.log('  Creando carpetas jerrquicas...', ubicacion);
    
    try {
      // Verificar que tenemos acceso al FileSystem
      if (!fsManager.isFileSystemMode || !fsManager.directoryHandle) {
        console.error('- No hay acceso al FileSystem');
        console.error('   isFileSystemMode:', fsManager.isFileSystemMode);
        console.error('   directoryHandle:', fsManager.directoryHandle);
        return null;
      }
      
      // Obtener o crear carpeta base de imgenes
      let carpetaActual;
      try {
        carpetaActual = await fsManager.directoryHandle.getDirectoryHandle('imagenes', { create: true });
        console.log('  - Carpeta base imagenes/ accesible');
      } catch (error) {
        console.error('- Error accediendo a carpeta imagenes:', error);
        return null;
      }
      
      // Nivel 1: rea General (obligatorio)
      const areaGeneral = ubicacion.areaGeneral && ubicacion.areaGeneral.trim() !== ''
        ? this.normalizarNombreCarpeta(ubicacion.areaGeneral)
        : '_SIN_UBICACION';

      carpetaActual = await carpetaActual.getDirectoryHandle(areaGeneral, { create: true });
      console.log(`  - Nivel 1 - rea General: ${areaGeneral}`);

      // Nivel 2: Sub-rea (opcional)
      if (this.nivelJerarquiaImagenes >= 2 && ubicacion.subArea && ubicacion.subArea.trim() !== '') {
        const subArea = this.normalizarNombreCarpeta(ubicacion.subArea);
        carpetaActual = await carpetaActual.getDirectoryHandle(subArea, { create: true });
        console.log(`  - Nivel 2 - Sub-rea: ${subArea}`);
      }

      // Nivel 3: Sistema/Equipo (opcional)
      if (this.nivelJerarquiaImagenes >= 3 && ubicacion.sistemaEquipo && ubicacion.sistemaEquipo.trim() !== '') {
        const sistema = this.normalizarNombreCarpeta(ubicacion.sistemaEquipo);
        carpetaActual = await carpetaActual.getDirectoryHandle(sistema, { create: true });
        console.log(`  - Nivel 3 - Sistema/Equipo: ${sistema}`);
      }

      // Nivel 4: Sub-Sistema (opcional)
      if (this.nivelJerarquiaImagenes >= 4 && ubicacion.subSistema && ubicacion.subSistema.trim() !== '') {
        const subSistema = this.normalizarNombreCarpeta(ubicacion.subSistema);
        carpetaActual = await carpetaActual.getDirectoryHandle(subSistema, { create: true });
        console.log(`  - Nivel 4 - Sub-Sistema: ${subSistema}`);
      }

      // Nivel 5: Seccin (opcional)
      if (this.nivelJerarquiaImagenes >= 5 && ubicacion.seccion && ubicacion.seccion.trim() !== '') {
        const seccion = this.normalizarNombreCarpeta(ubicacion.seccion);
        carpetaActual = await carpetaActual.getDirectoryHandle(seccion, { create: true });
        console.log(`  - Nivel 5 - Seccin: ${seccion}`);
      }

      // NOTA: El campo "detalle" es texto libre y NO se usa para crear carpetas
      // Las carpetas jerrquicas terminan en el Nivel 5 (Seccin)

      // Nivel 7: Ubicacin Especfica (opcional - futuro)
      if (this.nivelJerarquiaImagenes >= 7 && ubicacion.ubicacionEspecifica && ubicacion.ubicacionEspecifica.trim() !== '') {
        const ubicacionEspecifica = this.normalizarNombreCarpeta(ubicacion.ubicacionEspecifica);
        carpetaActual = await carpetaActual.getDirectoryHandle(ubicacionEspecifica, { create: true });
        console.log(`  - Nivel 7 - Ubicacin Especfica: ${ubicacionEspecifica}`);
      }
      
      return carpetaActual;
      
    } catch (error) {
      console.error('- Error creando carpetas:', error);
      console.error('   Detalles:', error.message);
      // Si falla, devolver carpeta raz de imgenes como fallback
      try {
        return await fsManager.directoryHandle.getDirectoryHandle('imagenes', { create: true });
      } catch (fallbackError) {
        console.error('- Error en fallback tambin:', fallbackError);
        return null;
      }
    }
  }

  /**
   * Navega a una carpeta por su ruta completa
   */
  async navegarACarpeta(ruta) {
    const partes = ruta.replace('./', '').split('/');
    let carpeta = fsManager.directoryHandle;
    
    for (const parte of partes) {
      carpeta = await carpeta.getDirectoryHandle(parte);
    }
    
    return carpeta;
  }

  /**
   * Limpia carpetas vacas (sin archivos)
   */
  async limpiarCarpetasVacias() {
    console.log('  Limpiando carpetas vacas...');
    
    try {
      if (!fsManager.isFileSystemMode || !fsManager.directoryHandle) {
        console.warn('  No hay acceso al FileSystem para limpiar carpetas');
        return;
      }
      
      const carpetaImagenes = await fsManager.directoryHandle.getDirectoryHandle('imagenes');
      
      // Obtener todas las subcarpetas (reas)
      for await (const [nombre, handle] of carpetaImagenes.entries()) {
        if (handle.kind !== 'directory') continue;
        
        // Contar archivos en la carpeta
        let tieneArchivos = false;
        const carpeta = await carpetaImagenes.getDirectoryHandle(nombre);
        
        for await (const entry of carpeta.values()) {
          if (entry.kind === 'file') {
            tieneArchivos = true;
            break;
          }
        }
        
        // Si est vaca, eliminarla
        if (!tieneArchivos) {
          await carpetaImagenes.removeEntry(nombre, { recursive: true });
          console.log(`   - Carpeta vaca eliminada: ${nombre}`);
        }
      }
      
      console.log('- Limpieza completada');
    } catch (error) {
      console.error('- Error limpiando carpetas:', error);
    }
  }

  /**
   * Mueve imgenes a nueva carpeta si cambi la ubicacin del repuesto
   */
  async moverImagenSiCambiaUbicacion(repuesto, ubicacionesAntiguas, ubicacionesNuevas) {
    if (!fsManager || !fsManager.isFileSystemMode) return;
    if (!ubicacionesAntiguas || !ubicacionesNuevas) return;
    if (ubicacionesAntiguas.length === 0 || ubicacionesNuevas.length === 0) return;
    
    console.log('  Verificando si hay que mover imgenes...');
    
    // Comparar primera ubicacin (la principal)
    const ubicacionAntigua = ubicacionesAntiguas[0];
    const ubicacionNueva = ubicacionesNuevas[0];
    
    // Verificar si cambi el rea general
    const areaAntiguaNorm = this.normalizarNombreCarpeta(ubicacionAntigua.areaGeneral || '');
    const areaNuevaNorm = this.normalizarNombreCarpeta(ubicacionNueva.areaGeneral || '');
    
    if (areaAntiguaNorm === areaNuevaNorm) {
      console.log('    rea no cambi, no es necesario mover imgenes');
      return; // No cambi, no hacer nada
    }
    
    console.log(`    rea cambi: ${areaAntiguaNorm} - ${areaNuevaNorm}`);
    
    // Mover cada imagen
    let imagenesMovidas = 0;
    for (const media of repuesto.multimedia || []) {
      if (media.type !== 'image' || !media.isFileSystem) continue;
      
      try {
        // 1. Obtener nombre del archivo de la URL
        const nombreArchivo = media.url.split('/').pop();
        
        // 2. Buscar archivo en mltiples ubicaciones posibles
        let fileHandle;
        let carpetaAntigua;
        
        // Lista de ubicaciones donde buscar (orden de prioridad)
        const ubicacionesBuscar = [
          { tipo: 'raz', carpeta: fsManager.imagesFolder, descripcion: 'raz de imgenes' },
          { tipo: 'jerarquia_antigua', carpeta: null, descripcion: 'jerarqua antigua', ruta: this.generarRutaImagen(ubicacionAntigua) },
          { tipo: 'jerarquia_nueva', carpeta: null, descripcion: 'jerarqua nueva', ruta: this.generarRutaImagen(ubicacionNueva) }
        ];
        
        for (const ubicacion of ubicacionesBuscar) {
          try {
            if (ubicacion.tipo === 'raz') {
              fileHandle = await ubicacion.carpeta.getFileHandle(nombreArchivo);
              carpetaAntigua = ubicacion.carpeta;
              console.log(`    Archivo encontrado en ${ubicacion.descripcion}`);
              break;
            } else {
              // Para jerarquas, intentar navegar a la carpeta
              try {
                const carpetaJerarquia = await this.navegarACarpeta(ubicacion.ruta);
                fileHandle = await carpetaJerarquia.getFileHandle(nombreArchivo);
                carpetaAntigua = carpetaJerarquia;
                console.log(`    Archivo encontrado en ${ubicacion.descripcion}: ${ubicacion.ruta}`);
                break;
              } catch (navError) {
                // Si no puede navegar a la carpeta, significa que no existe
                console.log(`    Carpeta ${ubicacion.ruta} no existe, omitiendo bsqueda aqu`);
                continue;
              }
            }
          } catch (searchError) {
            console.log(`    Archivo no encontrado en ${ubicacion.descripcion}, continuando bsqueda...`);
            continue;
          }
        }
        
        // Si no se encontr en ninguna ubicacin, continuar con la siguiente imagen
        if (!fileHandle) {
          console.log(`    Archivo ${nombreArchivo} no encontrado en ninguna ubicacin, omitiendo`);
          continue;
        }
        const file = await fileHandle.getFile();
        
        // 3. Crear carpeta nueva (si no existe)
        const carpetaNueva = await this.crearCarpetasJerarquicas(ubicacionNueva);
        
        // 4. Copiar archivo a nueva ubicacin
        const result = await fsManager.saveImageJerarquica(file, nombreArchivo, carpetaNueva);
        
        if (result) {
        // 5. Actualizar TODAS las rutas en el objeto multimedia que coincidan con este archivo
        const rutaNueva = this.generarRutaImagen(ubicacionNueva);
        const nuevaUrl = `${rutaNueva}/${nombreArchivo}`;

        // Buscar y actualizar todas las referencias a este archivo en el repuesto
        let referenciasActualizadas = 0;
        for (const media of repuesto.multimedia || []) {
          if (media.type === 'image' && media.isFileSystem) {
            const mediaFileName = media.url.split('/').pop();
            if (mediaFileName === nombreArchivo) {
              media.url = nuevaUrl;
              referenciasActualizadas++;
              console.log(`    URL actualizada: ${media.url}`);
            }
          }
        }

        console.log(`    Referencias actualizadas: ${referenciasActualizadas}`);          // 6. (Opcional) Eliminar archivo antiguo
          console.log(`    Verificando eliminacin: eliminarImagenAntiguaAlMover = ${this.eliminarImagenAntiguaAlMover}`);
          if (this.eliminarImagenAntiguaAlMover && carpetaAntigua) {
            console.log(`   - Intentando eliminar archivo antiguo: ${nombreArchivo} de carpeta antigua`);
            try {
              await carpetaAntigua.removeEntry(nombreArchivo);
              console.log(`  - Archivo antiguo eliminado: ${nombreArchivo}`);
            } catch (removeError) {
              console.error(`  - Error eliminando archivo antiguo:`, removeError);
            }
          } else {
            console.log(`    Eliminacin desactivada o carpeta antigua no disponible, archivo permanece en ubicacin antigua`);
          }
          
          imagenesMovidas++;
          console.log(`  - Imagen movida: ${nombreArchivo}`);
        }
        
      } catch (error) {
        console.error(`  - Error moviendo imagen:`, error);
        
        // Si el archivo no existe, podra ser que ya fue movido anteriormente
        // o que la referencia est corrupta. Limpiar referencias invlidas
        if (error.name === 'NotFoundError') {
          console.log(`    Archivo ${nombreArchivo} no encontrado, eliminando referencia invlida`);
          
          // Remover la referencia invlida del array multimedia
          const index = repuesto.multimedia.indexOf(media);
          if (index > -1) {
            repuesto.multimedia.splice(index, 1);
            console.log(`  - Referencia invlida eliminada del repuesto`);
          }
        }
        
        // Continuar con las dems imgenes
      }
    }
    
    if (imagenesMovidas > 0) {
      console.log(`- Total de imgenes movidas: ${imagenesMovidas}`);
      this.showToast(`- ${imagenesMovidas} imagen(es) movida(s) a nueva ubicacin`, 'success');
      
      // Limpiar carpetas vacas
      await this.limpiarCarpetasVacias();
    }
  }

  async init() {
    this.showBrowserWarning();
    
    // Renderizar UI de almacenamiento según plataforma (PC o móvil)
    // TODO: Implementar módulo de configuración en v6.0
    /*
    if (typeof configuracion !== 'undefined') {
      setTimeout(() => {
        configuracion.renderStorageUI();
        configuracion.loadICloudPathConfig(); // Cargar ruta iCloud guardada
      }, 100);
    }
    */
    
    await this.loadData();
    this.setupEvents();
    this.setupDelegatedEvents(); // Event delegation para botones con data-attributes
    this.setupPhotoInputs(); // NUEVO: Configurar inputs de foto según plataforma
    this.applyViewModeStyles(); // Aplicar modo de visualización guardado
    this.updateViewModeInfo(); // Actualizar info del modo
    await this.render();
    this.renderFilters();
    
    // Cargar datos de autocompletado guardados o generar desde repuestos
    const savedAutocomplete = localStorage.getItem('autocompleteData');
    if (savedAutocomplete) {
      try {
        this.autocompleteData = JSON.parse(savedAutocomplete);
      } catch (e) {
        console.warn('Error cargando autocomplete guardado, regenerando...', e);
        this.updateAutocompleteData();
      }
    } else {
      this.updateAutocompleteData();
    }
    
    this.setupAutocomplete();
    
    // Setup listener para cambio de equipo (cargar sistemas)
    const equipoInput = document.getElementById('equipo');
    if (equipoInput) {
      equipoInput.addEventListener('blur', () => {
        const equipo = equipoInput.value.trim();
        if (equipo) {
          this.cargarSistemasPorEquipo(equipo);
        }
      });
    }
    
    // Log de plataforma y optimizaciones
    console.log(`\n${'='.repeat(60)}`);
    console.log(`  PLATAFORMA: ${this.isMobile ? 'MVIL' : 'PC'}`);
    console.log(`  ALMACENAMIENTO: ${this.storageMode.toUpperCase()}`);
    console.log(`  File System API: ${this.hasFileSystemAPI ? '- Disponible' : '- No disponible'}`);
    
    if (this.isEdge) {
      if (this.isEdgeIOS) {
        console.log(`  NAVEGADOR: Microsoft Edge iOS (Modo Mvil)`);
        console.log('  Caractersticas activas:');
        console.log('  - IndexedDB para imgenes (~50-100MB)');
        console.log('    Captura de cmara directa');
        console.log('   - Seleccin de galera/iCloud Photos');
        console.log('  - Sincronizacin va JSON');
        console.log('    WebKit (limitado por Apple, no Chromium)');
      } else {
        console.log(`  NAVEGADOR: Microsoft Edge (Optimizado)`);
        console.log('  Optimizaciones activadas:');
        console.log('  - CSS Grid avanzado');
        console.log('  - Backdrop filters');
        console.log('  - Container queries');
        console.log('  - Scroll snap');
        if (this.hasFileSystemAPI) {
          console.log('  - File System Access API completa');
        }
      }
    } else {
      console.log(`  NAVEGADOR: ${this.getBrowserName()} (No optimizado)`);
    }
    console.log(`${'='.repeat(60)}\n`);
  }

  // NUEVO: Configurar inputs de fotos segn plataforma (mvil o PC)
  setupPhotoInputs() {
    const mobileButtons = document.getElementById('mobile-photo-buttons');
    const galleryInput = document.getElementById('galleryInput');
    const oldInput = document.getElementById('imagenFile');
    const multimediaSection = document.querySelector('.multimedia-section');
    
    // MVIL SIN FILESYSTEM: Ocultar toda la seccin de multimedia
    if (this.isMobile && !this.hasFileSystemAPI) {
      console.log('  Modo Mvil Simplificado - Multimedia DESACTIVADA');
      
      // Ocultar toda la seccin de multimedia
      if (multimediaSection) {
        multimediaSection.style.display = 'none';
      }
      
      // Crear mensaje informativo
      const multimediaParent = multimediaSection ? multimediaSection.parentElement : null;
      if (multimediaParent) {
        const existingMessage = document.getElementById('mobile-no-photos-message');
        if (!existingMessage) {
          const messageDiv = document.createElement('div');
          messageDiv.id = 'mobile-no-photos-message';
          messageDiv.style.cssText = `
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1));
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid var(--info);
            margin: 16px 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
          `;
          messageDiv.innerHTML = `
            <strong style="color: var(--info); display: block; margin-bottom: 6px;">  Modo Mvil Simplificado</strong>
            Las fotos no estn disponibles en dispositivos mviles.<br>
            <strong>Funciones activas:</strong> Ver, Agregar, Editar, Eliminar, Conteo.
            <br><br>
              <strong>Para fotos:</strong> Usa la versin de PC con todas las funcionalidades.
          `;
          multimediaSection.parentNode.insertBefore(messageDiv, multimediaSection);
        }
      }
      
      return; // Salir - no configurar inputs de fotos
    }
    
    // MVIL CON FILESYSTEM (no debera pasar, pero por si acaso)
    if (this.isMobile && this.hasFileSystemAPI) {
      // MVIL: Mostrar botones cmara + galera
      if (mobileButtons) {
        mobileButtons.style.display = 'flex';
      }
      if (galleryInput) {
        galleryInput.style.display = 'none'; // Ocultar input directo
      }
      if (oldInput) {
        oldInput.style.display = 'none';
      }
      if (multimediaSection) {
        multimediaSection.style.display = 'block';
      }
      console.log('  Inputs de foto configurados para MVIL (Cmara + Galera)');
    } 
    // PC: Mostrar todo normalmente
    else {
      // PC: Mostrar solo input de galera (sin botones)
      if (mobileButtons) {
        mobileButtons.style.display = 'none';
      }
      if (galleryInput) {
        galleryInput.style.display = 'block'; // Mostrar input directo
      }
      if (oldInput) {
        oldInput.style.display = 'none';
      }
      if (multimediaSection) {
        multimediaSection.style.display = 'block';
      }
      console.log('  Inputs de foto configurados para PC (Galera)');
    }
  }

  // Event delegation para manejar todos los clicks en botones con data-action
  setupDelegatedEvents() {
    // Clicks en botones
    document.addEventListener('click', (e) => {
      const target = e.target.closest('[data-action]');
      if (!target) return;
      
      const action = target.dataset.action;
      const id = target.dataset.id;
      
      if (action === 'edit') {
        this.openModal('edit', id);
      } else if (action === 'delete') {
        if (confirm('Eliminar este repuesto?')) {
          this.deleteRepuesto(id);
        }
      } else if (action === 'lightbox') {
        console.log(' - Abriendo lightbox para ID:', id);
        this.openLightbox(id);
      } else if (action === 'contar') {
        this.abrirModalConteoIndividual(id);
      } else if (action === 'goto-card') {
        this.irATarjeta(id);
      } else if (action === 'goto-map') {
        e.preventDefault();
        e.stopPropagation();
        const codigo = target.dataset.codigo;
        if (codigo) {
          this.locateRepuestoInMap(codigo);
        }
      }
    });

    // Change events en inputs (conteo)
    document.addEventListener('change', (e) => {
      const target = e.target;
      if (!target.dataset || !target.dataset.action) return;
      
      const action = target.dataset.action;
      const id = target.dataset.id;
      
      if (action === 'update-conteo') {
        this.updateConteo(id, target.value);
      }
    });

    // Listener para teclado - controles del lightbox
    document.addEventListener('keydown', (e) => {
      const lightbox = document.getElementById('lightbox');
      const isLightboxActive = lightbox && lightbox.classList.contains('active');
      
      if (!isLightboxActive) return;
      
      // ESC - Cerrar lightbox
      if (e.key === 'Escape' || e.key === 'Esc') {
        console.log('  ESC presionado - cerrando lightbox');
        this.closeLightbox();
        return;
      }
      
      // Flecha IZQUIERDA - Imagen anterior
      if (e.key === 'ArrowLeft' || e.key === 'Left') {
        console.log('  - Flecha izquierda - imagen anterior');
        e.preventDefault(); // Evitar scroll de pgina
        this.lightboxPrev();
        return;
      }
      
      // Flecha DERECHA - Imagen siguiente
      if (e.key === 'ArrowRight' || e.key === 'Right') {
        console.log('  - Flecha derecha - imagen siguiente');
        e.preventDefault(); // Evitar scroll de pgina
        this.lightboxNext();
        return;
      }
    });
  }

  async cleanBase64ImagesFromLocalStorage() {
    // Limpiar imgenes base64 del localStorage cuando estamos en modo FileSystem
    if (!fsManager.isFileSystemMode) return;
    
    try {
      const localData = localStorage.getItem('inventarioData');
      if (!localData) return;
      
      const data = JSON.parse(localData);
      let limpiadas = 0;
      let tamaoAntes = new Blob([localData]).size;
      
      // Eliminar todas las imgenes base64
      data.forEach(item => {
        if (item.multimedia && item.multimedia.length > 0) {
          const multimediaLimpia = item.multimedia.filter(media => {
            const esBase64 = media.url && media.url.startsWith('data:image');
            if (esBase64) {
              limpiadas++;
              console.log(`  Limpiando base64 de: ${item.nombre}`);
            }
            return !esBase64; // Mantener solo rutas de FileSystem
          });
          item.multimedia = multimediaLimpia;
        }
      });
      
      if (limpiadas > 0) {
        const datosLimpios = JSON.stringify(data);
        localStorage.setItem('inventarioData', datosLimpios);
        
        const tamaoDespues = new Blob([datosLimpios]).size;
        const liberado = ((tamaoAntes - tamaoDespues) / 1024).toFixed(2);
        
        console.log(`  Limpiadas ${limpiadas} imgenes base64 del localStorage (${liberado} KB liberados)`);
      } else {
        console.log('- localStorage ya est limpio (no hay imgenes base64)');
      }
    } catch (error) {
      console.warn('  Error limpiando localStorage:', error);
    }
  }

  async loadData() {
    // PRIORIDAD 1: Intentar cargar desde FileSystem si est activo
    if (fsManager.isFileSystemMode) {
      console.log('- Modo FileSystem activo, intentando cargar desde archivo...');
      try {
        const fileHandle = await fsManager.directoryHandle.getFileHandle('inventario.json');
        const file = await fileHandle.getFile();
        const content = await file.text();
        const rawData = JSON.parse(content);
        
        console.log(`- Cargados ${rawData.length} repuestos desde FileSystem`);
        this.repuestos = rawData.map((item, index) => {
          if (!item.id || item.id === 'undefined' || item.id === 'null') {
            item.id = `repuesto-${Date.now()}-${index}`;
          } else {
            item.id = String(item.id);
          }
          if (!item.multimedia || !Array.isArray(item.multimedia)) {
            item.multimedia = [];
          }
          return item;
        });
        
        //   DIAGNSTICO: Contar repuestos con/sin imgenes
        const conImagenes = this.repuestos.filter(r => r.multimedia && r.multimedia.length > 0).length;
        const sinImagenes = this.repuestos.length - conImagenes;
        console.log(`  [DIAGNSTICO] Repuestos CON imgenes: ${conImagenes}`);
        console.log(`  [DIAGNSTICO] Repuestos SIN imgenes: ${sinImagenes}`);
        
        //   SANITIZAR REFERENCIAS INVLIDAS ANTES DE RENDERIZAR
        await this.sanitizeImageReferences();
        

        return; // Salir, ya cargamos desde FileSystem
      } catch (error) {
        console.warn('  No se pudo cargar desde FileSystem:', error.message);
        console.log('Intentando cargar desde localStorage como fallback...');
      }
    }
    
    // PRIORIDAD 2: MVIL SIN FILESYSTEM - Cargar desde datos embebidos
    if (this.isMobile && !this.hasFileSystemAPI) {
      console.log('  Modo Mvil detectado - Cargando desde datos embebidos...');
      
      // Verificar si hay datos embebidos
      if (typeof EMBEDDED_DATA !== 'undefined' && EMBEDDED_DATA.repuestos && EMBEDDED_DATA.repuestos.length > 0) {
        console.log(`- Cargados ${EMBEDDED_DATA.repuestos.length} repuestos desde datos embebidos`);
        
        this.repuestos = EMBEDDED_DATA.repuestos.map((item, index) => {
          if (!item.id || item.id === 'undefined' || item.id === 'null') {
            item.id = `repuesto-${Date.now()}-${index}`;
          } else {
            item.id = String(item.id);
          }
          //   IMPORTANTE: Forzar multimedia vaco en mvil
          item.multimedia = [];
          return item;
        });
        
        console.log(`  Modo Mvil Simplificado: ${this.repuestos.length} repuestos sin multimedia`);
        console.log(`  ltima actualizacin: ${EMBEDDED_DATA.lastUpdate || 'Desconocida'}`);
        
        // Guardar en localStorage para ediciones locales
        localStorage.setItem('inventarioData', JSON.stringify(this.repuestos));
        
        //   SANITIZAR REFERENCIAS INVLIDAS ANTES DE RENDERIZAR
        await this.sanitizeImageReferences();
        

        return; // Salir, ya cargamos desde datos embebidos
      } else {
        console.warn('  No hay datos embebidos, intentando localStorage...');
      }
    }
    
    // FALLBACK: Cargar desde localStorage
    const saved = localStorage.getItem('inventarioData');
    if (saved) {
      try {
        const rawData = JSON.parse(saved);
        console.log(`Cargando ${rawData.length} repuestos desde localStorage`);
        
        // NORMALIZAR IDs: Asegurar que todos los repuestos tengan IDs vlidos
        this.repuestos = rawData.map((item, index) => {
          // Si no tiene ID o es invlido, generar uno nuevo
          if (!item.id || item.id === 'undefined' || item.id === 'null') {
            item.id = `repuesto-${Date.now()}-${index}`;
            console.log(`  ID generado para "${item.nombre}": ${item.id}`);
          } else {
            // Convertir ID a string para consistencia
            item.id = String(item.id);
          }
          
          // Asegurar que multimedia existe como array
          if (!item.multimedia || !Array.isArray(item.multimedia)) {
            item.multimedia = [];
          }
          
          return item;
        });
        
        console.log(`- ${this.repuestos.length} repuestos cargados correctamente`);
        
        // Verificar IDs nicos
        const idsSet = new Set(this.repuestos.map(r => r.id));
        if (idsSet.size !== this.repuestos.length) {
          console.warn('  Se detectaron IDs duplicados, regenerando...');
          this.repuestos = this.repuestos.map((r, i) => {
            r.id = `repuesto-${Date.now()}-${i}`;
            return r;
          });
          this.saveData(); // Guardar con IDs corregidos
        }
        
        //   SANITIZAR REFERENCIAS INVLIDAS ANTES DE RENDERIZAR
        await this.sanitizeImageReferences();
        
      } catch (e) {
        console.error('- Error al cargar datos:', e);
        this.loadDefaultData();
      }
    } else {
      console.log('  Sin datos guardados, iniciando vaco');
      this.loadDefaultData();
    }
    
  }

  // ===================================================================
  // ACTIVAR FILESYSTEM MANUAL
  // ===================================================================
  async activarFileSystem() {
    try {
      console.log('🗂️ Activando FileSystem Access API...');
      this.showToast('Selecciona la carpeta INVENTARIO_STORAGE', 'info');
      
      // Llamar al método selectFolder de fsManager
      const success = await fsManager.selectFolder();
      
      if (success) {
        this.showToast('✅ FileSystem activado correctamente', 'success');
        console.log('✅ FileSystem conectado:', fsManager.folderPath);
        
        // Actualizar UI de configuración si está visible
        if (window.configuracion && window.configuracion.renderStorageUI) {
          configuracion.renderStorageUI();
        }
        
        // Recargar datos desde FileSystem
        console.log('🔄 Recargando datos desde FileSystem...');
        await this.loadData();
        await this.render();
        
        this.showToast('✅ Datos recargados desde carpeta', 'success');
      } else {
        this.showToast('❌ No se pudo activar FileSystem', 'error');
      }
    } catch (error) {
      console.error('❌ Error activando FileSystem:', error);
      this.showToast('Error: ' + error.message, 'error');
    }
  }

  desconectarFileSystem() {
    try {
      console.log('🔌 Desconectando FileSystem...');
      
      const fs = window.fsManager || fsManager;
      if (fs && fs.disconnect) {
        fs.disconnect();
      }
      
      // Actualizar UI de configuración si está visible
      if (window.configuracion && window.configuracion.renderStorageUI) {
        configuracion.renderStorageUI();
      }
      
      this.showToast('✅ FileSystem desconectado. Los datos quedan en la carpeta.', 'info', 4000);
      console.log('✅ FileSystem desconectado');
    } catch (error) {
      console.error('❌ Error desconectando FileSystem:', error);
      this.showToast('Error: ' + error.message, 'error');
    }
  }

  async saveData() {
    try {
      const fs = window.fsManager || fsManager;
      
      //   MÓVIL: Actualizar EMBEDDED_DATA automáticamente
      if (this.isMobile && !this.hasFileSystemAPI && typeof EMBEDDED_DATA !== 'undefined') {
        console.log('  Actualizando EMBEDDED_DATA en memoria...');
        EMBEDDED_DATA.repuestos = this.repuestos.map(r => {
          const { multimedia, ...sinMultimedia } = r;
          return sinMultimedia;
        });
        EMBEDDED_DATA.lastUpdate = new Date().toISOString();
        console.log('✅ EMBEDDED_DATA actualizado:', EMBEDDED_DATA.repuestos.length, 'repuestos');
      }

      // MODO FILESYSTEM: Guardar en archivo
      if (fs && fs.isFileSystemMode) {
        console.log('💾 Guardando en FileSystem...');
        const success = await fs.saveJSON(this.repuestos);
        if (success !== false) {
          this.showToast('✅ Guardado en carpeta (sin límites)', 'success', 2000);
          console.log('✅ Datos guardados en FileSystem');
          return true;
        }
        // Si falla FileSystem, continuar con localStorage como fallback
        console.warn('⚠️ FileSystem falló, usando localStorage como fallback');
      }
      
      // MODO LOCALSTORAGE: Guardar en navegador
      const dataString = JSON.stringify(this.repuestos);
      const sizeInMB = (dataString.length / (1024 * 1024)).toFixed(2);
      
      console.log('Intentando guardar en localStorage:', sizeInMB, 'MB');
      
      // Verificar si excede lmite ANTES de intentar guardar
      if (sizeInMB > 9) {
        console.error(`- Archivo demasiado grande: ${sizeInMB}MB (lmite: ~10MB)`);
        this.showToast(`- DATOS NO GUARDADOS: ${sizeInMB}MB excede lmite de navegador (10MB)`, 'error', 8000);
        
        // Mostrar dilogo con opciones
        const opciones = confirm(
          `  PROBLEMA CRTICO\n\n` +
          ` Tamao: ${sizeInMB}MB\n` +
          ` Lmite navegador: ~10MB\n` +
          ` Repuestos: ${this.repuestos.length}\n\n` +
          `- TUS CAMBIOS SE PERDERN AL REFRESCAR\n\n` +
          `SOLUCIONES:\n` +
          `1. Activar "  Modo Carpeta" (capacidad ilimitada)\n` +
          `2. Exportar JSON sin imgenes\n` +
          `3. Reducir cantidad de repuestos\n\n` +
          `Exportar AHORA los datos actuales (sin imgenes)?`
        );
        
        if (opciones) {
          this.exportJSONSinImagenes();
        }
        return false; // Indicar que NO se guard
      }
      
      localStorage.setItem('inventarioData', dataString);
      
      // Advertencias por tamao
      if (sizeInMB > 7) {
        this.showToast(`  ADVERTENCIA: ${sizeInMB}MB/10MB - Activa "  Modo Carpeta" para sin lmites`, 'warning', 6000);
      } else if (sizeInMB > 4) {
        this.showToast(`Guardado: ${sizeInMB}MB`, 'info', 3000);
      }
      
      console.log('- Datos guardados en localStorage');
      return true; // Indicar xito
    } catch (error) {
      if (error.name === 'QuotaExceededError') {
        const sizeInMB = (JSON.stringify(this.repuestos).length / (1024 * 1024)).toFixed(2);
        this.showToast(`- LMITE EXCEDIDO (${sizeInMB}MB). Activa "  Modo Carpeta"!`, 'error', 10000);
        console.error('- LocalStorage lleno. Tamao:', sizeInMB, 'MB');
      } else {
        this.showToast('- Error al guardar: ' + error.message, 'error');
        console.error('Error guardando:', error);
      }
      return false;
    }
  }

  setupEvents() {
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
    });

    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => this.switchView(btn.dataset.view));
    });

    document.getElementById('searchInput')?.addEventListener('input', () => {
      this.inventoryFocusId = null;
      this.currentPage = 1;
      this.renderInventario();
    });

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('filter-chip')) {
        document.querySelectorAll('.filter-chip').forEach(f => f.classList.remove('active'));
        e.target.classList.add('active');
        this.currentPage = 1;
        this.renderInventario();
      }
    });

    document.getElementById('btnIniciarConteo')?.addEventListener('click', () => this.iniciarConteo());
    document.getElementById('btnFinalizarConteo')?.addEventListener('click', () => this.finalizarConteo());

    // Listener para resize - Recalcular paginacin en modo auto
    let resizeTimeout;
    window.addEventListener('resize', () => {
      // Solo recalcular si estamos en modo auto (tanto viewMode como itemsPerPage)
      if (this.viewMode === 'auto' && this.itemsPerPage === 'auto') {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          console.log('  Recalculando paginacin responsive...');
          this.updateViewModeInfo(); // Actualizar info de dispositivo detectado
          this.currentPage = 1; // Resetear a primera pgina
          this.renderInventario();
        }, 500); // Debounce de 500ms
      }
    });
  }

  switchTab(tabName) {
    // Remover active de todas las pesta?as
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // Activar la pesta?a seleccionada
    const selectedTab = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
    const selectedContent = document.getElementById(tabName);
    
    if (selectedTab) selectedTab.classList.add('active');
    if (selectedContent) selectedContent.classList.add('active');
    
    this.currentTab = tabName;
    
    // Acciones espec?ficas seg?n la pesta?a
    if (tabName === 'inventario') {
      this.renderInventario();
    } else if (tabName === 'conteo') {
      this.renderConteo();
    } else if (tabName === 'jerarquia') {
      this.renderJerarquia();
    } else if (tabName === 'mapa') {
      setTimeout(() => {
        if (mapController && mapController.currentMap) {
          mapController.render();
        }
      }, 100);
    } else if (tabName === 'analitica') {
      this.renderStats();
    } else if (tabName === 'valores') {
      this.renderValores();
    } else if (tabName === 'configuracion') {
      // TODO: Implementar módulo configuracion completo
      // if (typeof configuracion !== 'undefined') {
      //   configuracion.renderStorageUI();
      // }
      console.log('📋 TAB Configuración cargado (modo básico)');
    }
  }

  switchView(view) {
    this.currentView = view;
    
    // Actualizar botones
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`.view-btn[data-view="${view}"]`);
    if (activeBtn) activeBtn.classList.add('active');
    
    this.renderInventario();
  }

  async renderStats() {
    const statsGridEl = document.getElementById('statsGrid');
    const statsDetailsEl = document.getElementById('statsDetails');
    if (!statsGridEl || !statsDetailsEl) {
      return;
    }

    const formatNumber = (value, options = {}) => {
      const number = Number(value);
      return Number.isFinite(number) ? number.toLocaleString('es-ES', options) : '0';
    };

    const formatCurrency = (value) => {
      const amount = Number(value) || 0;
      return formatNumber(amount, { 
        style: 'currency', 
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    };

    const stats = this.calcularEstadisticas();
    
    // Renderizar tarjetas principales
    statsGridEl.innerHTML = `
      <div class="stat-card">
        <div class="stat-icon">📦</div>
        <div class="stat-value">${formatNumber(stats.total)}</div>
        <div class="stat-label">Total Repuestos</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">💰</div>
        <div class="stat-value">${formatCurrency(stats.valorTotal)}</div>
        <div class="stat-label">Valor Total</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">⚠️</div>
        <div class="stat-value">${formatNumber(stats.bajoStock)}</div>
        <div class="stat-label">Bajo Stock</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">📍</div>
        <div class="stat-value">${formatNumber(stats.ubicaciones)}</div>
        <div class="stat-label">Ubicaciones</div>
      </div>
    `;
  }

  calcularEstadisticas() {
    const total = this.inventario.length;
    const valorTotal = this.inventario.reduce((sum, item) => 
      sum + ((Number(item.precio) || 0) * (Number(item.stock) || 0)), 0
    );
    const bajoStock = this.inventario.filter(item => 
      (Number(item.stock) || 0) < (Number(item.stockMinimo) || 0)
    ).length;
    const ubicaciones = new Set(
      this.inventario.map(item => item.ubicacion).filter(Boolean)
    ).size;
    
    return { total, valorTotal, bajoStock, ubicaciones };
  }
}

// Inicialización
(async function() {
  try {
    if (typeof window === 'undefined') {
      throw new Error('Debe ejecutarse en un navegador');
    }
    
    window.app = new InventarioCompleto();
    await window.app.init();
    
    console.log('Aplicacion portable lista');
  } catch (error) {
    console.error('Error al inicializar:', error);
  }
})();
  </script>

  <!-- LIGHTBOX -->
  <div class="lightbox" id="lightbox">
    <button class="lightbox-close" onclick="app.closeLightbox()">×</button>
    <button class="lightbox-nav lightbox-prev" onclick="app.lightboxPrev()">‹</button>
    <button class="lightbox-nav lightbox-next" onclick="app.lightboxNext()">›</button>
    <div class="lightbox-content" id="lightboxContent"></div>
    <div class="lightbox-counter" id="lightboxCounter"></div>
  </div>

</body>
</html>
