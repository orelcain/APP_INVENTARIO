rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function para verificar si el usuario estÃ¡ autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function para obtener el rol del usuario desde Firestore
    function getUserRole() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.role;
    }
    
    // Helper function para verificar si es admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Helper function para verificar si es usuario regular
    function isUsuario() {
      return isAuthenticated() && getUserRole() == 'usuario';
    }
    
    // Helper function para verificar si tiene al menos rol de lectura
    function hasReadAccess() {
      return isAuthenticated() && getUserRole() in ['admin', 'usuario', 'lectura'];
    }
    
    // ðŸ†• v6.045 - Helper para verificar si es el mismo usuario
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ðŸ†• v6.045 - Helper para verificar si solo se actualizan campos de presencia
    function isPresenceUpdate() {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['presence', 'lastLogin']);
    }
    
    // ColecciÃ³n de usuarios (admin puede todo, usuarios pueden actualizar su presencia)
    match /usuarios/{userId} {
      allow read: if isAuthenticated();
      // ðŸ†• v6.045 - Permitir que usuarios actualicen su propia presencia
      allow update: if isAdmin() || (isOwner(userId) && isPresenceUpdate());
      allow create, delete: if isAdmin();
    }
    
    // Usuarios personalizados (custom_users)
    match /custom_users/{username} {
      allow read: if true; // PÃºblico para login
      // ðŸ†• v6.045 - Permitir que usuarios actualicen su propia presencia
      allow update: if isAdmin() || (isAuthenticated() && isPresenceUpdate());
      allow create, delete: if isAdmin();
    }
    
    // Historial de acciones de usuarios
    match /user_actions/{actionId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // Solo usuarios autenticados pueden crear registros
      allow update, delete: if isAdmin();
    }
    
    // Repuestos
    match /repuestos/{repuestoId} {
      allow read: if hasReadAccess();
      allow create: if isAuthenticated() && (isAdmin() || isUsuario());
      allow update: if isAuthenticated() && (isAdmin() || isUsuario());
      allow delete: if isAdmin();
    }
    
    // Mapas
    match /mapas/{mapaId} {
      allow read: if hasReadAccess();
      allow create: if isAuthenticated() && (isAdmin() || isUsuario());
      allow update: if isAuthenticated() && (isAdmin() || isUsuario());
      allow delete: if isAdmin();
    }
    
    // Zonas
    match /zonas/{zonaId} {
      allow read: if hasReadAccess();
      allow create: if isAuthenticated() && (isAdmin() || isUsuario());
      allow update: if isAuthenticated() && (isAdmin() || isUsuario());
      allow delete: if isAdmin();
    }
    
    // Presupuestos
    match /presupuestos/{presupuestoId} {
      allow read: if hasReadAccess();
      allow create: if isAuthenticated() && (isAdmin() || isUsuario());
      allow update: if isAuthenticated() && (isAdmin() || isUsuario());
      allow delete: if isAdmin();
    }
    
    // JerarquÃ­a
    match /jerarquia/{jerarquiaId} {
      allow read: if hasReadAccess();
      allow write: if isAdmin(); // Solo admin puede modificar estructura
    }
    
    // Metadata
    match /metadata/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Historial de actividad (Activity Log) - Solo admin puede leer, todos pueden crear
    match /activityLog/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
  }
}
