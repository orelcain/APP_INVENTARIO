<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>APP Inventario v6.0</title>
  
  <!-- Base URL para GitHub Pages -->
  <base href="./">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1a1a2e">
  <meta name="description" content="Sistema de inventario con mapas interactivos, multimedia y sincronización en la nube">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Inventario">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#1a1a2e">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json">
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
  <link rel="apple-touch-icon" href="icons/icon-192x192.svg">

  <!-- 🔧 SISTEMA DE DEBUG UNIVERSAL - Funciona en móvil Y en configuración -->
  <script>
    // 🔧 SISTEMA DE DEBUG UNIVERSAL - Funciona en móvil Y en configuración
    (function() {
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const isDebug = location.search.includes('debug');
      
      // Almacén global de logs
      window.debugLogs = window.debugLogs || [];
      const maxLogs = 150;
      
      // Interceptar console desde el inicio
      const originalLog = console.log;
      const originalWarn = console.warn;
      const originalError = console.error;
      
      function addLogEntry(type, args) {
        const msg = Array.from(args).map(a => 
          typeof a === 'object' ? JSON.stringify(a, null, 2).substring(0, 300) : String(a)
        ).join(' ');
        
        const entry = { 
          type, 
          msg, 
          time: new Date().toLocaleTimeString(),
          timestamp: Date.now()
        };
        
        window.debugLogs.push(entry);
        if (window.debugLogs.length > maxLogs) window.debugLogs.shift();
        
        // Actualizar panel flotante si existe
        if (window.updateFloatingDebug) window.updateFloatingDebug(entry);
        // Actualizar panel de config si existe
        if (window.updateConfigDebug) window.updateConfigDebug(entry);
      }
      
      console.log = function() { originalLog.apply(console, arguments); addLogEntry('info', arguments); };
      console.warn = function() { originalWarn.apply(console, arguments); addLogEntry('warn', arguments); };
      console.error = function() { originalError.apply(console, arguments); addLogEntry('error', arguments); };
      
      // 🛡️ PROTECTOR DE TECLADO PARA INPUTS
      // Evita que otros manejadores globales interfieran con la escritura
      document.addEventListener('keydown', function(e) {
        const isInput = e.target.tagName === 'INPUT' || 
                        e.target.tagName === 'TEXTAREA' || 
                        e.target.isContentEditable;
        
        // Si estamos en un campo de texto, evitar que otros listeners interfieran
        if (isInput) {
          e.stopPropagation();
        }
      }, true); // true = fase de captura (se ejecuta primero)
      
      // 🖥️ FUNCIONES PARA PANEL DE CONFIGURACIÓN
      window.toggleDebugConsole = function() {
        const panel = document.getElementById('debugConsoleConfig');
        if (panel) {
          panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          if (panel.style.display === 'block') {
            window.renderConfigDebugLogs();
          }
        }
      };
      
      window.clearDebugLogs = function() {
        window.debugLogs = [];
        const configLogs = document.getElementById('debugLogsConfig');
        if (configLogs) configLogs.innerHTML = '<div style="color: #888;">Logs limpiados</div>';
      };
      
      window.testDebugLog = function() {
        console.log('🧪 Test LOG - ' + new Date().toLocaleString());
        console.warn('⚠️ Test WARNING - Esto es una advertencia de prueba');
        console.error('❌ Test ERROR - Esto es un error de prueba');
      };
      
      // 🆕 v6.049 - MOSTRAR INFO DE RED EN TIEMPO REAL
      window.showNetworkInfo = function() {
        const display = document.getElementById('networkInfoDisplay');
        if (!display) return;
        
        display.style.display = display.style.display === 'none' ? 'block' : 'none';
        if (display.style.display === 'none') return;
        
        const updateNetInfo = () => {
          const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
          const isOnline = navigator.onLine;
          
          let html = `<div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; color: rgba(255,255,255,0.85);">`;
          html += `<span style="color: #67e8f9;">Estado:</span><span>${isOnline ? '🟢 Online' : '🔴 Offline'}</span>`;
          
          if (conn) {
            html += `<span style="color: #67e8f9;">Tipo efectivo:</span><span>📶 ${(conn.effectiveType || 'desconocido').toUpperCase()}</span>`;
            if (conn.downlink) html += `<span style="color: #67e8f9;">Velocidad:</span><span>⬇️ ${conn.downlink} Mbps</span>`;
            if (conn.rtt) html += `<span style="color: #67e8f9;">Latencia:</span><span>⏱️ ${conn.rtt} ms</span>`;
            if (conn.saveData) html += `<span style="color: #67e8f9;">Ahorro datos:</span><span>⚠️ Activado</span>`;
            if (conn.type) html += `<span style="color: #67e8f9;">Tipo conexión:</span><span>🔌 ${conn.type}</span>`;
          } else {
            html += `<span style="color: #fca5a5;" colspan="2">⚠️ Network Information API no disponible</span>`;
          }
          
          html += `</div>`;
          html += `<div style="margin-top: 8px; font-size: 0.75rem; color: rgba(255,255,255,0.5);">`;
          html += `Actualizado: ${new Date().toLocaleTimeString()}`;
          html += `</div>`;
          
          display.innerHTML = html;
        };
        
        updateNetInfo();
        
        // Escuchar cambios de red
        if (navigator.connection) {
          navigator.connection.addEventListener('change', updateNetInfo);
        }
        window.addEventListener('online', updateNetInfo);
        window.addEventListener('offline', updateNetInfo);
      };
      
      // 📋 COPIAR LOGS AL PORTAPAPELES
      window.copyDebugLogs = function() {
        if (window.debugLogs.length === 0) {
          alert('No hay logs para copiar');
          return;
        }
        
        const header = `═══════════════════════════════════════════════════
🔧 DEBUG LOGS - APP INVENTARIO
📅 ${new Date().toLocaleString()}
📱 ${navigator.userAgent}
🖥️ Pantalla: ${window.innerWidth}x${window.innerHeight}
═══════════════════════════════════════════════════\n\n`;
        
        const logsText = window.debugLogs.map(entry => {
          const icon = entry.type === 'error' ? '❌' : entry.type === 'warn' ? '⚠️' : 'ℹ️';
          return `[${entry.time}] ${icon} ${entry.msg}`;
        }).join('\n');
        
        const fullText = header + logsText;
        
        // Intentar copiar al portapapeles
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(fullText).then(() => {
            alert('✅ Logs copiados al portapapeles!\n\nPuedes pegarlos en WhatsApp, Email, etc.');
          }).catch(err => {
            // Fallback para iOS
            window.fallbackCopyLogs(fullText);
          });
        } else {
          window.fallbackCopyLogs(fullText);
        }
      };
      
      // Fallback para copiar (iOS Safari)
      window.fallbackCopyLogs = function(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.cssText = 'position: fixed; top: 50%; left: 10%; width: 80%; height: 40%; z-index: 999999; font-size: 10px;';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        
        try {
          document.execCommand('copy');
          alert('✅ Logs copiados! (Selecciona todo y copia si no funcionó automáticamente)');
        } catch (err) {
          alert('📋 Selecciona todo el texto y cópialo manualmente');
        }
        
        setTimeout(() => textarea.remove(), 100);
      };
      
      // 📤 DESCARGAR LOGS COMO ARCHIVO TXT
      window.shareDebugLogs = function() {
        if (window.debugLogs.length === 0) {
          alert('No hay logs para descargar');
          return;
        }
        
        const fecha = new Date();
        const fechaStr = fecha.toISOString().split('T')[0]; // 2025-12-05
        const horaStr = fecha.toTimeString().split(' ')[0].replace(/:/g, '-'); // 15-30-45
        
        // Detectar plataforma
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const platform = isMobile ? 'MOBILE' : 'PC';
        const browser = navigator.userAgent.includes('Edg/') ? 'Edge' : 
                       navigator.userAgent.includes('Chrome') ? 'Chrome' :
                       navigator.userAgent.includes('Safari') ? 'Safari' : 'Otro';
        
        const header = `════════════════════════════════════════════════════════════════
🔧 DEBUG LOGS - APP INVENTARIO
════════════════════════════════════════════════════════════════
📅 Fecha: ${fecha.toLocaleString()}
🖥️ Plataforma: ${platform}
🌐 Navegador: ${browser}
📱 User Agent: ${navigator.userAgent}
📐 Pantalla: ${window.innerWidth}x${window.innerHeight}
🔗 URL: ${window.location.href}
☁️ Firebase Storage: ${window.firebaseImageStorage ? 'Activo' : 'No disponible'}
🔄 Sync activada: ${localStorage.getItem('firebaseSyncEnabled') === 'true' ? 'Sí' : 'No'}
📦 Repuestos en memoria: ${window.app?.repuestos?.length || 0}
════════════════════════════════════════════════════════════════

`;
        
        const logsText = window.debugLogs.map(entry => {
          const icon = entry.type === 'error' ? '[ERROR]' : entry.type === 'warn' ? '[WARN]' : '[INFO]';
          return `[${entry.time}] ${icon} ${entry.msg}`;
        }).join('\n');
        
        const fullText = header + logsText;
        const filename = `log_${platform}_${fechaStr}_${horaStr}.txt`;
        
        // Crear blob y descargar
        const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        
        alert(`✅ Archivo descargado:\n${filename}\n\n📂 Búscalo en tu carpeta de Descargas`);
      };
      
      window.renderConfigDebugLogs = function() {
        const logsDiv = document.getElementById('debugLogsConfig');
        if (!logsDiv) return;
        
        if (window.debugLogs.length === 0) {
          logsDiv.innerHTML = '<div style="color: #888;">No hay logs todavía...</div>';
          return;
        }
        
        logsDiv.innerHTML = window.debugLogs.map(entry => {
          const colors = { error: '#f66', warn: '#fa0', info: '#6af' };
          return `<div style="color: ${colors[entry.type] || '#0f0'}; padding: 3px 0; border-bottom: 1px solid #333;">${entry.time} ${entry.msg}</div>`;
        }).join('');
        logsDiv.scrollTop = logsDiv.scrollHeight;
      };
      
      window.updateConfigDebug = function(entry) {
        const logsDiv = document.getElementById('debugLogsConfig');
        const panel = document.getElementById('debugConsoleConfig');
        if (logsDiv && panel && panel.style.display === 'block') {
          const colors = { error: '#f66', warn: '#fa0', info: '#6af' };
          const div = document.createElement('div');
          div.style.cssText = `color: ${colors[entry.type] || '#0f0'}; padding: 3px 0; border-bottom: 1px solid #333;`;
          div.textContent = entry.time + ' ' + entry.msg;
          logsDiv.appendChild(div);
          logsDiv.scrollTop = logsDiv.scrollHeight;
        }
      };
      
      // Actualizar info del sistema cuando DOM esté listo
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
          const infoDiv = document.getElementById('debugSystemInfo');
          if (infoDiv) {
            const ua = navigator.userAgent;
            const isMobileDevice = /Android|iPhone|iPad|iPod/i.test(ua);
            const browser = ua.includes('Chrome') ? 'Chrome' : ua.includes('Safari') ? 'Safari' : ua.includes('Firefox') ? 'Firefox' : 'Otro';
            
            // 🆕 v6.049 - Info de conexión de red
            const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            const netType = conn?.effectiveType?.toUpperCase() || 'Desconocido';
            const netSpeed = conn?.downlink ? `${conn.downlink} Mbps` : '';
            const netRtt = conn?.rtt ? `${conn.rtt}ms` : '';
            const saveData = conn?.saveData ? '⚠️ Ahorro datos' : '';
            const isOnline = navigator.onLine ? '🟢 Online' : '🔴 Offline';
            
            infoDiv.innerHTML = `
              <strong>Dispositivo:</strong> ${isMobileDevice ? '📱 Móvil' : '🖥️ PC'}<br>
              <strong>Navegador:</strong> ${browser}<br>
              <strong>Pantalla:</strong> ${window.innerWidth}x${window.innerHeight}<br>
              <strong>📶 Red:</strong> ${isOnline} | ${netType} ${netSpeed} ${netRtt} ${saveData}<br>
              <strong>Firebase Storage:</strong> ${window.firebaseImageStorage ? '✅ Activo' : '❌ No disponible'}<br>
              <strong>Service Worker:</strong> ${navigator.serviceWorker ? '✅ Soportado' : '❌ No soportado'}<br>
              <strong>Logs capturados:</strong> ${window.debugLogs.length}
            `;
          }
        }, 3000);
      });
      
      // 🔍 BUSCAR REPUESTO EN TODAS LAS FUENTES (diagnóstico)
      window.buscarRepuestoEn = async function(termino) {
        console.log(`\n🔍 BUSCANDO "${termino}" EN TODAS LAS FUENTES...\n`);
        
        const terminoLower = termino.toLowerCase();
        let encontrados = { memoria: [], firebase: [], localStorage: [] };
        
        // 1. Buscar en memoria (window.app.repuestos)
        const enMemoria = (window.app?.repuestos || []).filter(r => 
          r.nombre?.toLowerCase().includes(terminoLower) ||
          r.codSAP?.toLowerCase().includes(terminoLower)
        );
        encontrados.memoria = enMemoria;
        console.log(`📦 EN MEMORIA: ${enMemoria.length} encontrados`);
        enMemoria.forEach(r => console.log(`   - ${r.nombre} (${r.codSAP}) - ID: ${r.id}`));
        
        // 2. Buscar en Firebase directamente
        try {
          if (window.firebaseService && window.firebaseService.isAuthenticated()) {
            const result = await window.firebaseService.readAll('repuestos');
            if (result.success) {
              const enFirebase = result.data.filter(r => 
                r.nombre?.toLowerCase().includes(terminoLower) ||
                r.codSAP?.toLowerCase().includes(terminoLower)
              );
              encontrados.firebase = enFirebase;
              console.log(`☁️ EN FIREBASE: ${enFirebase.length} encontrados (de ${result.data.length} total)`);
              enFirebase.forEach(r => console.log(`   - ${r.nombre} (${r.codSAP}) - ID: ${r.id}`));
            }
          } else {
            console.log('☁️ FIREBASE: No autenticado');
          }
        } catch (e) {
          console.error('❌ Error buscando en Firebase:', e);
        }
        
        // 3. Buscar en localStorage
        try {
          const local = JSON.parse(localStorage.getItem('inventarioData') || '[]');
          const enLocal = local.filter(r => 
            r.nombre?.toLowerCase().includes(terminoLower) ||
            r.codSAP?.toLowerCase().includes(terminoLower)
          );
          encontrados.localStorage = enLocal;
          console.log(`💾 EN LOCALSTORAGE: ${enLocal.length} encontrados (de ${local.length} total)`);
          enLocal.forEach(r => console.log(`   - ${r.nombre} (${r.codSAP}) - ID: ${r.id}`));
        } catch (e) {
          console.error('❌ Error buscando en localStorage:', e);
        }
        
        // Resumen
        console.log(`\n📊 RESUMEN:`);
        console.log(`   Memoria: ${encontrados.memoria.length}`);
        console.log(`   Firebase: ${encontrados.firebase.length}`);
        console.log(`   localStorage: ${encontrados.localStorage.length}`);
        console.log(`   Sync activa: ${window.syncActive ? '✅' : '❌'}`);
        
        // Alertar si hay discrepancia
        if (encontrados.firebase.length > 0 && encontrados.memoria.length === 0) {
          console.warn('⚠️ PROBLEMA: El repuesto EXISTE en Firebase pero NO en memoria');
          console.log('💡 Solución: Recarga la página o ejecuta window.app.loadData()');
        }
        
        return encontrados;
      };
      console.log('💡 Usa: window.buscarRepuestoEn("perno") para diagnosticar');
      
      // 🗑️ LIMPIAR REPUESTOS LOCALES (localStorage)
      window.limpiarRepuestosLocales = function() {
        const repuestosLocales = JSON.parse(localStorage.getItem('inventarioData') || '[]');
        const cantidadLocal = repuestosLocales.length;
        
        if (cantidadLocal === 0) {
          alert('✅ No hay repuestos en localStorage para limpiar');
          return;
        }
        
        const repuestosFirebase = window.app?.repuestos?.length || 0;
        const firebaseActivo = window.firebaseService?.isAuthenticated?.();
        
        const confirmar = confirm(
          `🗑️ LIMPIAR CACHE LOCAL\n\n` +
          `📦 Repuestos en localStorage: ${cantidadLocal}\n` +
          `☁️ Repuestos en Firebase: ${repuestosFirebase}\n` +
          `🔥 Firebase activo: ${firebaseActivo ? 'Sí' : 'No'}\n\n` +
          `${firebaseActivo ? '✅ Es seguro limpiar - Firebase tiene tus datos' : '⚠️ Firebase NO activo - asegúrate de no perder datos'}\n\n` +
          `¿Limpiar localStorage?`
        );
        
        if (confirmar) {
          localStorage.removeItem('inventarioData');
          const sizeBefore = (JSON.stringify(repuestosLocales).length / 1024).toFixed(1);
          console.log(`🗑️ Eliminados ${cantidadLocal} repuestos de localStorage (${sizeBefore}KB liberados)`);
          alert(`✅ localStorage limpiado\n\n• ${cantidadLocal} repuestos eliminados\n• ${sizeBefore}KB liberados\n\n${firebaseActivo ? '🔥 Tus datos siguen en Firebase' : '⚠️ Recarga para verificar'}`);
        }
      };
      
      // 📊 VER ESTADO DE DATOS
      window.verEstadoDatos = async function() {
        const repuestosLocal = JSON.parse(localStorage.getItem('inventarioData') || '[]');
        const repuestosMemoria = window.app?.repuestos || [];
        const jerarquiaLocal = JSON.parse(localStorage.getItem('jerarquiaAnidada') || '[]');
        const syncEnabled = localStorage.getItem('firebaseSyncEnabled') === 'true';
        const fsConnected = window.fsManager?.rootFolder ? true : false;
        
        // Contar imágenes FileSystem vs Firebase
        let imagenesFileSystem = 0;
        let imagenesFirebase = 0;
        let imagenesSinImagen = 0;
        
        repuestosMemoria.forEach(r => {
          if (r.multimedia && r.multimedia.length > 0) {
            r.multimedia.forEach(m => {
              if (m.isFirebaseStorage) imagenesFirebase++;
              else if (m.isFileSystem) imagenesFileSystem++;
            });
          } else {
            imagenesSinImagen++;
          }
        });
        
        // 🔥 Consultar Firebase directamente
        let repuestosFirebase = 0;
        let syncActiva = false;
        try {
          if (window.firebaseService && window.firebaseService.isAuthenticated()) {
            const result = await window.firebaseService.readAll('repuestos');
            repuestosFirebase = result.success ? result.data.length : 0;
            syncActiva = window.syncActive || false;
          }
        } catch (e) {
          console.error('Error consultando Firebase:', e);
        }
        
        const info = `
📊 ESTADO DE DATOS
═══════════════════════════════

📦 REPUESTOS:
   • localStorage: ${repuestosLocal.length}
   • En memoria (app): ${repuestosMemoria.length}
   • En Firebase: ${repuestosFirebase}
   • Sync listener activo: ${syncActiva ? '✅ Sí' : '❌ No'}

🖼️ IMÁGENES:
   • En FileSystem (local): ${imagenesFileSystem}
   • En Firebase Storage: ${imagenesFirebase}
   • Sin imagen: ${imagenesSinImagen}

🗂️ JERARQUÍA:
   • Áreas locales: ${jerarquiaLocal.length}
   • En app: ${window.app?.jerarquiaAnidada?.length || 0}

💾 ALMACENAMIENTO:
   • FileSystem conectado: ${fsConnected ? '✅ Sí' : '❌ No'}
   • Firebase Storage: ${window.firebaseImageStorage ? '✅ Activo' : '❌ No'}

🔄 SINCRONIZACIÓN:
   • Tiempo real habilitada: ${syncEnabled ? '✅ Sí' : '❌ No'}
   • Listener activo: ${syncActiva ? '✅ Sí' : '❌ No'}
`;
        
        console.log(info);
        alert(info);
        
        // Si hay diferencia entre localStorage y Firebase, ofrecer sincronizar
        if (repuestosLocal.length > repuestosMemoria.length) {
          const diferencia = repuestosLocal.length - repuestosMemoria.length;
          const syncMsg = `\n\n⚠️ HAY ${diferencia} REPUESTO(S) EN LOCALSTORAGE QUE NO ESTÁN EN FIREBASE\n\n¿Deseas sincronizar ahora?`;
          
          if (confirm(info + syncMsg)) {
            await window.sincronizarLocalAFirebase();
            return;
          }
        }
        
        alert(info);
      };
      
      // 🔄 SINCRONIZAR LOCALSTORAGE A FIREBASE
      window.sincronizarLocalAFirebase = async function() {
        const repuestosLocal = JSON.parse(localStorage.getItem('inventarioData') || '[]');
        
        if (repuestosLocal.length === 0) {
          alert('❌ No hay repuestos en localStorage');
          return;
        }
        
        if (!window.firebaseStorageAdapter) {
          alert('❌ Firebase no está disponible');
          return;
        }
        
        if (!window.firebaseService?.isAuthenticated?.()) {
          alert('❌ Debes iniciar sesión primero');
          return;
        }
        
        const confirmar = confirm(
          `🔄 SINCRONIZAR A FIREBASE\n\n` +
          `Se subirán ${repuestosLocal.length} repuestos desde localStorage a Firebase.\n\n` +
          `Esto sobrescribirá los datos en Firebase.\n\n` +
          `¿Continuar?`
        );
        
        if (!confirmar) return;
        
        try {
          alert('🔄 Sincronizando... espera un momento');
          
          // Subir todos los repuestos de localStorage a Firebase
          await window.firebaseStorageAdapter.guardarRepuestos(repuestosLocal);
          
          // Recargar desde Firebase para verificar
          const repuestosFirebase = await window.firebaseStorageAdapter.cargarRepuestos();
          
          alert(
            `✅ SINCRONIZACIÓN COMPLETADA\n\n` +
            `• Subidos: ${repuestosLocal.length} repuestos\n` +
            `• En Firebase: ${repuestosFirebase.length} repuestos\n\n` +
            `🔄 Recargando página...`
          );
          
          location.reload();
        } catch (error) {
          console.error('❌ Error sincronizando:', error);
          alert('❌ Error al sincronizar: ' + error.message);
        }
      };
      
      // 🖼️ MIGRAR IMÁGENES DE FILESYSTEM A FIREBASE STORAGE
      window.migrarImagenesAFirebase = async function() {
        // Obtener fsManager desde app (es donde está asignado correctamente)
        const fsManager = window.app?.fsManager;
        
        console.log('🔍 Verificando requisitos para migración...');
        console.log('  - firebaseImageStorage:', !!window.firebaseImageStorage);
        console.log('  - isReady:', window.firebaseImageStorage?.isReady?.());
        console.log('  - isAuthenticated:', window.firebaseImageStorage?.isAuthenticated?.());
        console.log('  - fsManager (from app):', !!fsManager);
        console.log('  - fsManager.rootFolder:', !!fsManager?.rootFolder);
        console.log('  - fsManager.isFileSystemMode:', fsManager?.isFileSystemMode);
        console.log('  - fsManager.imagesFolder:', !!fsManager?.imagesFolder);
        
        // Verificar Firebase Storage disponible
        if (!window.firebaseImageStorage) {
          alert('❌ Firebase Storage no está inicializado.\n\nRecarga la página.');
          return;
        }
        
        if (!window.firebaseImageStorage.isReady || !window.firebaseImageStorage.isReady()) {
          alert('❌ Firebase Storage no está listo.\n\nEspera un momento y vuelve a intentar.');
          return;
        }
        
        if (!window.firebaseImageStorage.isAuthenticated || !window.firebaseImageStorage.isAuthenticated()) {
          alert('❌ No estás autenticado en Firebase.\n\nInicia sesión primero.');
          return;
        }
        
        // 🔥 FIREBASE-ONLY: Ya no se requiere FileSystem conectado
        // Las imágenes ya deberían estar en Firebase Storage
        
        const repuestos = window.app?.repuestos || [];
        let imagenesAMigrar = [];
        
        // Buscar imágenes FileSystem (legacy - para migración)
        repuestos.forEach(r => {
          if (r.multimedia && r.multimedia.length > 0) {
            r.multimedia.forEach((m, idx) => {
              if (m.isFileSystem && !m.isFirebaseStorage) {
                imagenesAMigrar.push({
                  repuestoId: r.id,
                  repuestoNombre: r.descripcion || r.codSAP,
                  mediaIndex: idx,
                  media: m
                });
              }
            });
          }
        });
        
        if (imagenesAMigrar.length === 0) {
          alert('✅ No hay imágenes FileSystem para migrar.\n\nTodas las imágenes ya están en Firebase Storage o no hay imágenes.');
          return;
        }
        
        const confirmar = confirm(
          `🖼️ MIGRAR IMÁGENES A FIREBASE STORAGE\n\n` +
          `Se encontraron ${imagenesAMigrar.length} imágenes en FileSystem local.\n\n` +
          `⚠️ IMPORTANTE:\n` +
          `• Debes estar en tu PC donde están las imágenes\n` +
          `• La carpeta INVENTARIO_STORAGE debe estar conectada\n` +
          `• Este proceso puede tardar varios minutos\n\n` +
          `¿Deseas continuar?`
        );
        
        if (!confirmar) return;
        
        console.log(`🖼️ Iniciando migración de ${imagenesAMigrar.length} imágenes...`);
        
        let exitosas = 0;
        let fallidas = 0;
        const errores = [];
        
        for (let i = 0; i < imagenesAMigrar.length; i++) {
          const item = imagenesAMigrar[i];
          console.log(`🔄 [${i+1}/${imagenesAMigrar.length}] Migrando: ${item.repuestoNombre}`);
          
          try {
            // Extraer nombre de archivo limpio
            let imageName = item.media.name || item.media.url || '';
            // Limpiar la ruta (quitar ./imagenes/ si existe)
            imageName = imageName.replace(/^\.?\/?imagenes\/?/, '');
            
            if (!imageName) {
              throw new Error('Nombre de imagen no válido');
            }
            
            console.log(`   📁 Cargando: ${imageName}`);
            
            // Cargar imagen desde FileSystem usando readFile (método correcto)
            // La imagen está en la carpeta imagesFolder (plana)
            const fileHandle = await fsManager.imagesFolder.getFileHandle(imageName, { create: false });
            const imageFile = await fileHandle.getFile();
            
            if (!imageFile) {
              throw new Error('No se pudo cargar la imagen desde FileSystem');
            }
            
            // El archivo ya es un Blob/File
            const blob = imageFile;
            
            // Subir a Firebase Storage
            const filename = item.media.name || `migrated_${Date.now()}.webp`;
            const result = await window.firebaseImageStorage.uploadRepuestoImage(
              blob,
              item.repuestoId,
              filename,
              (progress) => {
                if (progress % 25 === 0) console.log(`   ↳ Progreso: ${progress.toFixed(0)}%`);
              }
            );
            
            if (result.success) {
              // Actualizar multimedia del repuesto
              const repuesto = window.app.repuestos.find(r => r.id === item.repuestoId);
              if (repuesto && repuesto.multimedia && repuesto.multimedia[item.mediaIndex]) {
                repuesto.multimedia[item.mediaIndex] = {
                  ...repuesto.multimedia[item.mediaIndex],
                  url: result.url,
                  path: result.path,
                  isFirebaseStorage: true,
                  isFileSystem: false,
                  migratedAt: new Date().toISOString()
                };
                
                // Guardar cambios en Firebase (usar guardarRepuestos con array)
                if (window.firebaseStorageAdapter && window.firebaseStorageAdapter.guardarRepuestos) {
                  await window.firebaseStorageAdapter.guardarRepuestos([repuesto]);
                  console.log(`   💾 Repuesto actualizado en Firebase: ${repuesto.nombre}`);
                }
              }
              
              exitosas++;
              console.log(`   ✅ Migrada: ${filename}`);
            } else {
              throw new Error(result.error || 'Error desconocido');
            }
            
          } catch (error) {
            fallidas++;
            errores.push(`${item.repuestoNombre}: ${error.message}`);
            console.error(`   ❌ Error: ${error.message}`);
          }
          
          // Pequeña pausa para no saturar
          await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        // Resultado final
        const resumen = `
🖼️ MIGRACIÓN COMPLETADA
═══════════════════════════════

✅ Exitosas: ${exitosas}
❌ Fallidas: ${fallidas}
📊 Total: ${imagenesAMigrar.length}

${errores.length > 0 ? '⚠️ Errores:\n' + errores.slice(0, 5).join('\n') + (errores.length > 5 ? `\n...y ${errores.length - 5} más` : '') : ''}

${exitosas > 0 ? '🔄 Recarga la página para ver los cambios' : ''}
`;
        
        console.log(resumen);
        alert(resumen);
        
        // Re-renderizar grid si hubo cambios
        if (exitosas > 0 && window.app) {
          window.app.renderInventario();
        }
      };
      
      console.log('🔧 Sistema de Debug Universal inicializado');
    })();
    
    // 🆕 v6.071 - Función global showToast (wrapper para app.showToast)
    window.showToast = function(message, type = 'info', duration = 3200) {
      if (typeof app !== 'undefined' && typeof app.showToast === 'function') {
        app.showToast(message, type, duration);
      } else {
        // Fallback: mostrar en consola si app no está disponible
        const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
        console.log(`${icons[type] || 'ℹ️'} [Toast] ${message}`);
      }
    };
  </script>

  <!-- CSS Modular para Jerarquía de Mapas -->
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/prototype-mapas.css">
  <link rel="stylesheet" href="styles/mapas-hierarchy.css">

  <style>
    /* CACHE-BUST: 2025-11-19-v50-CORRELATIVOS-GLOBALES-EN-MAPAS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /*  PALETA v6.0 - EQUILIBRADA (80% Grises, 20% Acentos) */
      --primary: #5b8bb4;           /* Azul corporativo desaturado */
      --primary-light: #7ba5c8;     /* Azul claro */
      --primary-dark: #4a7090;      /* Azul oscuro */
      --secondary: #6a7581;         /* Gris medio neutro */
      --success: #5b9b7a;           /* Verde esmeralda desaturado */
      --success-dark: #4a7d62;      /* Verde oscuro */
      --warning: #b8925a;           /* mbar desaturado */
      --warning-dark: #9a7848;      /* mbar oscuro */
      --danger: #b86b6b;            /* Rojo coral desaturado */
      --danger-dark: #985555;       /* Rojo oscuro */
      --info: #5b8bb4;              /* Azul info (igual a primary) */
      --info-dark: #4a7090;         /* Azul oscuro */

      /*  Fondos oscuros pero no extremos */
      --gray-50: #1a1d23;           /* Fondo app (ligeramente ms claro) */
      --gray-100: #1e2229;          /* Base principal */
      --gray-200: #252a33;          /* Tarjetas (+10% luminosidad) */
      --gray-300: #2d333d;          /* Hover states */
      --gray-400: #3a4049;          /* Elevado */
      --gray-500: #4a5059;          /* Separadores */
      --gray-600: #6a7078;          /* Texto terciario */
      --gray-700: #8a9098;          /* Texto secundario */
      --gray-800: #b8bec8;          /* Texto normal */
      --gray-900: #e6e9ef;          /* Texto primario */

      /*  Sombras equilibradas (ni planas ni dramticas) */
      --shadow-sm:
        0 2px 4px rgba(0, 0, 0, 0.25),
        0 1px 2px rgba(0, 0, 0, 0.15);
      --shadow-md:
        0 4px 8px rgba(0, 0, 0, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.2);
      --shadow-lg:
        0 8px 16px rgba(0, 0, 0, 0.35),
        0 4px 8px rgba(0, 0, 0, 0.25);
      --shadow-xl:
        0 12px 24px rgba(0, 0, 0, 0.4),
        0 6px 12px rgba(0, 0, 0, 0.3);

      /* Atajos para compatibilidad */
      --card-shadow: var(--shadow-sm);
      --card-shadow-hover: var(--shadow-md);
      --neomorph-shadow: var(--shadow-md);
      --neomorph-shadow-sm: var(--shadow-sm);
      --neomorph-shadow-hover: var(--shadow-lg);
      --neomorph-shadow-inset: inset 0 2px 4px rgba(0, 0, 0, 0.2);

      /*  Geometra consistente - Border Radius estandarizado */
      --radius-sm: 6px;            /* Badges pequeos */
      --radius-md: 8px;            /*  DEFAULT - Botones, inputs, cards */
      --radius-lg: 12px;           /* Modales grandes */
      --radius-xl: 16px;           /* Imgenes */

      /* Bordes y lneas sutiles */
      --border-color: #2d333d;
      --border-color-light: #3a4049;
      --border-accent: #4a5059;

      /*  Fondos con profundidad sutil */
      --bg-primary: #1e2229;        /* Base principal */
      --bg-secondary: #252a33;      /* Tarjetas */
      --bg-tertiary: #2d333d;       /* Hover states */
      --bg-elevated: #3a4049;       /* Elementos elevados */
      --bg-app: #1a1d23;            /* Fondo general app */

      /*  Texto con jerarqua clara (4 niveles) */
      --text-primary: #ffffff;      /* Ttulos (BLANCO PURO) */
      --text-secondary: #ffffff;    /* Texto normal (BLANCO PURO) */
      --text-muted: #e2e8f0;        /* Metadata (gris muy claro) */
      --text-disabled: #94a3b8;     /* Deshabilitados (gris medio) */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-app);
      color: var(--text-primary);
      margin: 0;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    #listView,
    #conteoGrid {
      will-change: scroll-position;
      /* -webkit-overflow-scrolling obsoleto en navegadores modernos */
    }

    /* CSS Containment para mejor rendimiento (Edge Chromium) */
    .repuesto-card {
      contain: layout style paint;
    }

    /* Aspect Ratio nativo (Edge 88+) */
    .card-image {
      aspect-ratio: 16 / 9;
      object-fit: cover;
    }

    /* Logical Properties para mejor RTL/LTR (Edge Chromium) */
    .card-content {
      padding-inline: 12px;
      padding-block: 10px;
      margin-block-end: 6px;
    }

    /* Color Scheme para dark mode nativo (Edge) */
    :root {
      color-scheme: dark light;
    }

    /* Cascade Layers para mejor especificidad (Edge 99+) */
    @layer base, components, utilities;

    @layer base {
      * {
        box-sizing: border-box;
      }
    }

    /* Subgrid para layouts complejos (Edge 117+) */
    @supports (grid-template-rows: subgrid) {
      .list-view {
        display: grid;
        grid-template-rows: auto subgrid;
      }
    }

    /* Has() Selector para interactividad sin JS (Edge 105+) */
    .repuesto-card:has(input:focus) {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    .palette-visual .node-name {
      font-size: 0.85em;
      font-weight: 600;
      flex: 0 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }
    }

    body.force-mobile .repuesto-card {
      max-width: 600px !important;
      margin: 0 auto !important;
    }

    body.force-mobile .card-image {
      height: 250px !important;
    }

    body.force-mobile .card-btn {
      min-height: 48px !important;
      font-size: 1rem !important;
      padding: 12px 16px !important;
    }

    body.force-mobile .btn {
      min-height: 48px !important;
      font-size: 1rem !important;
      padding: 12px 20px !important;
    }

    body.force-mobile .container {
      padding: 16px !important;
    }

    body.force-mobile #pagination {
      flex-direction: column !important;
      gap: 12px !important;
    }

    body.force-mobile #pagination > div:first-child {
      width: 100% !important;
    }

    body.force-mobile #pagination > div:first-child select,
    body.force-mobile #pagination > div:first-child button {
      width: 100% !important;
      margin: 4px 0 !important;
    }

    body.force-mobile #pagination > div:last-child {
      width: 100% !important;
      justify-content: center !important;
    }

    /* Modo Desktop Forzado - Aplica estilo desktop incluso en pantallas pequeas */
    body.force-desktop .cards-grid {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
      gap: 24px !important;
      padding: 24px !important;
    }

    body.force-desktop .repuesto-card {
      max-width: none !important;
    }

    body.force-desktop .card-image {
      height: 200px !important;
    }

    body.force-desktop .card-btn,
    body.force-desktop .btn {
      min-height: 40px !important;
      font-size: 0.95rem !important;
      padding: 10px 16px !important;
    }

    body.force-desktop .container {
      padding: 24px !important;
    }

    body.force-desktop #pagination {
      flex-direction: row !important;
      gap: 16px !important;
    }

    body.force-desktop #pagination > div:first-child,
    body.force-desktop #pagination > div:last-child {
      width: auto !important;
    }

    /* MODOS DE VISUALIZACIN - UTILIDADES */
    .hidden {
      display: none !important;
    }

    .scroll-hidden {
      overflow: hidden !important;
    }

    .hidden-file-input {
      display: none !important;
    }

    .mapa-legacy-title {
      margin-bottom: 20px;
      color: var(--primary);
    }

    /* RESPONSIVE BREAKPOINTS CLAVE */
    @media (max-width: 1024px) {
      .layout-grid {
        display: flex;
        flex-direction: column;
      }

      .layout-sidebar {
        width: 100%;
        margin-bottom: 20px;
      }

      .layout-content {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .jerarquia-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      .jerarquia-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .jerarquia-actions .btn {
        width: 100%;
      }
    }

    @media (max-width: 640px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .header-actions {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .header-actions .btn {
        width: 100%;
      }

      .search-container {
        flex-direction: column;
        gap: 10px;
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
      min-height: 36px;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-danger:hover {
      background: var(--danger-dark);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      box-shadow: var(--shadow-md);
    }

    .toggle-precio {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s;
      font-weight: 600;
      min-height: 48px;
    }

    .toggle-precio.active {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }

    /* NAVEGACIN PROFESIONAL - DESTACADA */
    .nav-tabs {
      background: var(--bg-secondary);
      display: flex;
      border-bottom: 3px solid var(--border-color);
      overflow-x: auto;
      /* -webkit-overflow-scrolling obsoleto en navegadores modernos */
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      /* No necesita position: sticky porque est dentro de sticky-header-container */
      padding: 0 8px;
      gap: 0;
      width: 100%;
    }

    .nav-tab {
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9rem;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      color: var(--text-muted);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      border-bottom: 4px solid transparent;
      border-right: 1px solid var(--border-color);
      touch-action: manipulation;
      position: relative;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      flex: 1 1 0;
      justify-content: center;
      min-width: 140px;
      text-align: center;
    }

    .nav-tab:last-child {
      border-right: none;
    }

    .nav-tab::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 4px;
      background: var(--primary);
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .nav-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      transform: translateY(-2px);
    }

    .nav-tab:hover::before {
      width: 100%;
    }

    .nav-tab.active {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.18) 0%, rgba(59, 130, 246, 0.05) 100%);
      color: var(--primary-light);
      border-bottom-color: var(--primary);
      box-shadow: inset 0 -4px 0 0 var(--primary);
    }

    .nav-tab.active::before {
      width: 100%;
    }

    /* CSS WarmupProgress removido - Firebase carga instantáneamente */

    .container {
      max-width: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }

    .tab-content {
      display: none;
      min-height: calc(100vh - 50px);
      overflow: auto;
      padding: 10px;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    /*  REGLA ESPECFICA PARA TAB MAPA */
    #mapa.tab-content {
      padding: 0; /* Sin padding solo para MAPA */
      overflow: hidden; /* Sin scroll solo para MAPA */
      position: fixed; /*  Posicin fija para ignorar contenedores */
      top: 45px; /*  Justo debajo de las pestaas */
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: calc(100vh - 45px);
      z-index: 1;
    }
    
    #mapa.tab-content.active {
      display: flex; /* Flex solo para MAPA cuando est activo */
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* TOOLBAR - Neumorfismo */
    /* ==========================================
       OPCIÓN 2: GRUPOS DEFINIDOS (RECOMENDADA)
       ========================================== */
    
    /* Toolbar - Contenedor principal */
    .toolbar {
      background: transparent;
      padding: 12px 0;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    /* Grupos visuales dentro del toolbar */
    .toolbar-group {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 0 12px;
      border-left: 2px solid var(--border-color);
    }
    
    .toolbar-group:first-child {
      border-left: none;
      padding-left: 0;
    }
    
    /* Grupo de búsqueda - alineado a la derecha */
    .toolbar-group-search {
      flex: 1;
      justify-content: flex-end;
      border-left: none;
    }
    
    /* Separador sutil entre grupos */
    .toolbar-separator {
      width: 1px;
      height: 24px;
      background: var(--border-color);
      opacity: 0.5;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
      font-size: 1.2rem;
    }

    .search-input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 1rem;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-tertiary);
      box-shadow: var(--shadow-sm);
      color: var(--text-primary);
    }

    .search-input:focus {
      outline: none;
      background: var(--bg-tertiary);
      border-color: var(--primary);
      box-shadow: var(--shadow-sm), 0 0 0 3px rgba(91, 139, 180, 0.2);
    }

    .view-btns {
      display: flex;
      gap: 8px;
    }

    /* Botones de vista - Minimalista */
    .view-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: transparent;
      border-radius: var(--radius-sm);
      border-left: 2px solid transparent;
      border-top: none;
      border-right: none;
      border-bottom: none;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.8rem;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .view-btn:hover {
      color: var(--text-primary);
      background: var(--bg-primary);
      border-left-color: var(--gray-600);
    }

    .view-btn.active {
      background: var(--bg-primary);
      border-left-color: var(--primary);
      color: var(--text-primary);
    }

    /*  BOTN DE CONEXIN - DESHABILITADO (Firebase-only mode) */
    #connectionBtn {
      display: none !important; /* Firebase-only: No se necesita FileSystem */
      position: relative;
      border: none !important;
      cursor: default !important;
      padding: 10px 14px !important;
      border-radius: var(--radius-md) !important;
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    #connectionBtn:hover {
      transform: translateY(-1px);
      box-shadow: 
        0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    #connectionBtn #connectionIcon {
      font-weight: 700;
      font-size: 1.1rem;
      display: inline-block;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* FILTROS */
    .filters-selects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .filter-select {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 48px;
      appearance: none;
      box-shadow: var(--shadow-sm);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238a909a' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    .filter-select:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-color-light);
    }

    .filter-select:focus {
      outline: none;
      background: var(--bg-tertiary);
      border-color: var(--primary);
      box-shadow: var(--shadow-sm), 0 0 0 3px rgba(91, 139, 180, 0.2);
    }

    .filter-chip {
      padding: 8px 16px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      transition: all 0.3s;
      touch-action: manipulation;
      min-height: 40px;
      display: inline-flex;
      align-items: center;
    }

    .filter-chip:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--bg-primary);
    }

    .filter-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* GRID DE TARJETAS */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 18px;
      margin-bottom: 20px;
      min-height: calc(100vh - 300px);
      align-content: start;
    }

    #inventario {
      min-height: calc(100vh - 50px);
    }

    #inventarioContent {
      min-height: calc(100vh - 250px);
    }

    .repuesto-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .repuesto-card:hover {
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      border-color: rgba(91, 139, 180, 0.3);
    }

    .card-image {
      height: 200px;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      border-bottom: 1px solid var(--border-color);
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card-image .no-image {
      font-size: 4rem;
      color: var(--gray-400);
    }

    .card-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.75rem;
      background: rgba(0, 0, 0, 0.7);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      letter-spacing: 0.5px;
    }

    .badge-ok {
      background: rgba(91, 155, 122, 0.95);
      color: #fff;
      border-color: rgba(91, 155, 122, 0.3);
    }

    .badge-bajo {
      background: rgba(184, 146, 90, 0.95);
      color: #fff;
      border-color: rgba(184, 146, 90, 0.3);
    }

    .badge-cero {
      background: rgba(184, 107, 107, 0.95);
      color: #fff;
      border-color: rgba(184, 107, 107, 0.3);
    }

    .card-content {
      padding: 10px 12px;
    }

    .card-content h3 {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-primary);
      background: transparent;
      padding: 0;
      border-left: 3px solid var(--primary);
      padding-left: 8px;
      margin-bottom: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.3;
    }

    .card-content h4 {
      font-size: 0.95rem;
      color: var(--text-primary);
      margin-bottom: 12px;
      font-weight: 500;
    }

    .card-info {
      display: grid;
      gap: 3px;
      margin-bottom: 6px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
      line-height: 1.3;
      margin-bottom: 2px;
      padding: 3px 4px;
      background: transparent;
      border-bottom: 1px solid rgba(91, 139, 180, 0.1);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.65rem;
    }

    .info-value {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .card-footer {
      display: flex;
      gap: 6px;
      padding: 0 12px 10px;
    }

    .card-btn {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      font-size: 0.7rem;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      min-height: 32px;
    }

    .card-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--border-color-light);
      transform: none;
    }

    .btn-edit {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-edit:hover {
      background: var(--primary);
      color: white;
    }

    .btn-delete {
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn-delete:hover {
      background: var(--danger);
      color: white;
    }

    /* Datos Tcnicos - Estilo Corporativo */
    .datos-tecnicos-box {
      background: rgba(91, 139, 180, 0.08);
      border-left: 3px solid var(--primary);
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      margin: 8px 0;
    }

    .datos-tecnicos-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .datos-tecnicos-content {
      font-size: 0.75rem;
      color: var(--text-secondary);
      line-height: 1.5;
      font-family: 'Courier New', monospace;
      white-space: pre-line;
      word-break: break-word;
    }

    /* Contador de Stock - Estilo Corporativo */
    .stock-counter-box {
      background: var(--bg-tertiary);
      padding: 6px 8px;
      border-radius: var(--radius-sm);
      margin-top: 6px;
      border-left: 3px solid currentColor;
    }

    /* Botones de Ubicacin/Mapa - Estilo Corporativo */
    .btn-add-location,
    .btn-view-map {
      flex: 1;
      padding: 6px 10px;
      font-size: 0.75rem;
      font-weight: 500;
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .btn-add-location {
      background: rgba(91, 155, 122, 0.85);
      border: 1px solid rgba(91, 155, 122, 0.3);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .btn-add-location:hover {
      background: rgba(91, 155, 122, 1);
      box-shadow: var(--shadow-sm);
    }

    .btn-view-map {
      background: rgba(91, 139, 180, 0.85);
      border: 1px solid rgba(91, 139, 180, 0.3);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .btn-view-map:hover {
      background: rgba(91, 139, 180, 1);
      box-shadow: var(--shadow-sm);
    }

    /* VISTA LISTA - Compactada con Estilo Corporativo */
    .list-view {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }

    .list-header {
      display: grid;
      grid-template-columns: 50px 0.9fr 1.5fr 160px 220px;
      gap: 6px;
      padding: 6px 10px;
      background: #4A5568;
      font-weight: 700;
      font-size: 0.75rem;
      color: var(--text-primary);
      border-bottom: 2px solid var(--primary);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .list-header-cell {
      display: flex;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      padding: 2px 4px;
      border-radius: 3px;
      transition: all 0.2s;
      position: relative;
    }
    
    .list-header-cell:hover {
      background: rgba(91, 124, 153, 0.3);
      color: #5B7C99;
    }
    
    .list-header-cell.active {
      background: rgba(91, 124, 153, 0.4);
      color: #5B7C99;
    }

    /* Resize handle para columnas */
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      -webkit-user-select: none;
      user-select: none;
      background: transparent;
      z-index: 20;
    }

    .resize-handle:hover {
      background: var(--primary);
      box-shadow: 0 0 4px var(--primary);
    }

    .resize-handle.resizing {
      background: var(--primary);
      box-shadow: 0 0 8px var(--primary);
    }

    .list-header.resizing {
      -webkit-user-select: none;
      user-select: none;
    }

    .list-header.resizing .list-header-cell {
      pointer-events: none;
    }

    .list-header.resizing .resize-handle {
      pointer-events: auto;
    }
    
    .sort-icon {
      font-size: 0.65rem;
      opacity: 0.6;
      transition: all 0.2s;
    }
    
    .list-header-cell.active .sort-icon {
      opacity: 1;
      transform: scale(1.1);
    }

    .list-row {
      display: grid;
      grid-template-columns: 50px 0.9fr 1.5fr 160px 220px;
      gap: 6px;
      padding: 6px 0px 6px 10px;
      border-bottom: 1px solid var(--border-color);
      align-items: center;
      transition: all 0.2s;
      font-size: 0.8rem;
      min-height: 36px;
    }
    
    .list-row > div:last-child,
    .list-row .list-actions {
      justify-self: end !important;
      padding-right: 10px !important;
    }
    
    .list-row > div {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      min-height: 100%;
    }
    
    .list-row .list-actions {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      align-self: stretch !important;
      justify-content: flex-end !important;
      gap: 4px !important;
      padding: 0 !important;
      width: 100% !important;
      margin: 0 !important;
    }
    
    .stock-visual {
      display: flex;
      flex-direction: column;
      gap: 1px;
      width: 100%;
      align-items: stretch !important;
    }
    
    .stock-numbers {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
    }
    
    .stock-bar-container {
      width: 100%;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      border-radius: 2px;
      overflow: hidden;
      position: relative;
    }
    
    .stock-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease, background 0.3s ease;
      box-shadow: 0 0 4px rgba(0,0,0,0.15);
    }

    .list-row:hover {
      background: var(--bg-primary);
    }

    .list-row:last-child {
      border-bottom: none;
    }

    .list-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
      width: 100%;
      align-items: center !important;
    }

    .list-actions button {
      padding: 5px 4px;
      font-size: 0.7rem;
      min-height: 28px;
      width: 100%;
      white-space: nowrap;
    }

    /* PAGINACIN */
    #pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin: 0 auto 16px auto;
      max-width: 100%;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      flex-wrap: wrap;
    }

    #pagination .btn {
      padding: 6px 12px;
      min-width: auto;
      min-height: 32px;
      font-size: 0.8rem;
    }

    #pageNumbers {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    #pageNumbers .btn {
      min-width: 42px;
      padding: 8px 12px;
      transition: all 0.3s ease;
    }

    #itemsPerPageSelect {
      transition: all 0.3s ease;
      font-weight: 500;
    }

    #itemsPerPageSelect:hover {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #itemsPerPageSelect:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }

    #pageNumbers .btn:not(:disabled):hover {
      opacity: 1 !important;
      transform: scale(1.05);
    }

    #pageNumbers .btn:disabled {
      opacity: 1 !important;
      transform: scale(1.1);
      cursor: default;
      font-weight: 700;
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.9);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      z-index: 2000;
  align-items: flex-start;
  justify-content: center;
  overflow-y: auto;
  padding: clamp(10px, 2vh, 28px) clamp(12px, 4vw, 48px);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 0;
      width: fit-content;
      min-width: min(1400px, 100%);
      max-width: 90vw;
      min-height: fit-content;
      max-height: 88vh;
      box-shadow: 0 26px 60px rgba(0, 0, 0, 0.55);
      position: relative;
      border: 1px solid var(--border-color);
      animation: slideUp 0.25s ease;
      display: flex;
      flex-direction: column;
      margin: clamp(10px, 2vh, 24px) auto clamp(20px, 4vh, 48px);
      overflow: hidden;
      transition: transform 0.3s ease, width 0.3s ease, height 0.3s ease;
    }

    /* Cuando el modal es resizable/draggable */
    .modal-content.is-resizable {
      position: fixed;
      margin: 0;
      width: auto;
      min-width: min(1200px, 100%);
      max-width: 95vw;
      height: 85vh;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* Estilos para handles de resize */
    .modal-resize-handle {
      position: absolute;
      z-index: 15;
      background: transparent;
      transition: background 0.2s ease, opacity 0.2s ease;
    }

    .modal-resize-handle:hover {
      background: rgba(91, 139, 180, 0.25);
      opacity: 1;
    }

    /* Indicadores visuales en handles de esquina */
    .modal-resize-handle.modal-resize-ne::after,
    .modal-resize-handle.modal-resize-nw::after,
    .modal-resize-handle.modal-resize-se::after,
    .modal-resize-handle.modal-resize-sw::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(91, 139, 180, 0.4);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-resize-handle.modal-resize-ne::after {
      top: 4px;
      right: 4px;
      border-left: none;
      border-bottom: none;
    }

    .modal-resize-handle.modal-resize-nw::after {
      top: 4px;
      left: 4px;
      border-right: none;
      border-bottom: none;
    }

    .modal-resize-handle.modal-resize-se::after {
      bottom: 4px;
      right: 4px;
      border-left: none;
      border-top: none;
    }

    .modal-resize-handle.modal-resize-sw::after {
      bottom: 4px;
      left: 4px;
      border-right: none;
      border-top: none;
    }

    .modal-resize-handle:hover::after {
      opacity: 1;
    }

    /* Líneas indicadoras en handles de bordes */
    .modal-resize-handle.modal-resize-n::before,
    .modal-resize-handle.modal-resize-s::before {
      content: '';
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 3px;
      background: rgba(91, 139, 180, 0.4);
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-resize-handle.modal-resize-n::before {
      top: 2px;
    }

    .modal-resize-handle.modal-resize-s::before {
      bottom: 2px;
    }

    .modal-resize-handle.modal-resize-e::before,
    .modal-resize-handle.modal-resize-w::before {
      content: '';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 30px;
      background: rgba(91, 139, 180, 0.4);
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-resize-handle.modal-resize-e::before {
      right: 2px;
    }

    .modal-resize-handle.modal-resize-w::before {
      left: 2px;
    }

    .modal-resize-handle:hover::before {
      opacity: 1;
    }

    .modal-drag-handle {
      position: absolute;
      z-index: 5;
      cursor: move;
      user-select: none;
      transition: background 0.2s ease;
    }

    .modal-drag-handle:hover {
      background: rgba(91, 139, 180, 0.08);
    }

    .modal-drag-handle:active {
      cursor: grabbing;
      background: rgba(91, 139, 180, 0.15);
    }

    /* Optimizacin de scroll suave */
    .modal-scroll::-webkit-scrollbar {
      width: 8px;
    }
    
    .modal-scroll::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 10px;
    }
    
    .modal-scroll::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }
    
    .modal-scroll::-webkit-scrollbar-thumb:hover {
      background: #4d92e6;
    }

    .wizard-timeline {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px; /* Reducido de 12px */
      margin-bottom: 19px; /* Reducido de 24px */
      padding: 16px 6px 13px; /* Reducido 20% */
      border-bottom: 2px solid var(--border-color);
      background: rgba(16, 23, 33, 0.4);
      border-radius: 10px; /* Reducido de 12px */
      flex-shrink: 0;
    }

    .wizard-step-indicator {
      display: flex;
      align-items: center;
      gap: 10px; /* Reducido de 12px */
      padding: 11px 13px; /* Reducido de 14px 16px */
      border-radius: 11px; /* Reducido de 14px */
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(16, 23, 33, 0.72);
      color: var(--text-secondary);
      cursor: pointer;
      transition: border 0.2s ease, background 0.2s ease, transform 0.2s ease;
    }

    .wizard-step-indicator:hover {
      border-color: rgba(82, 124, 166, 0.6);
      transform: translateY(-1px);
    }

    .wizard-step-indicator.is-active {
      border-color: var(--accent);
      background: rgba(82, 124, 166, 0.2);
      color: var(--text-primary);
    }

    .wizard-step-indicator.is-completed {
      border-color: rgba(91, 155, 122, 0.5);
      background: rgba(91, 155, 122, 0.18);
      color: var(--text-primary);
    }

    .wizard-step-number {
      display: none; /* Ocultar números */
    }

    .wizard-step-indicator.is-active .wizard-step-number {
      background: var(--accent);
    }

    .wizard-step-indicator.is-completed .wizard-step-number {
      background: var(--success);
    }

    .wizard-step-indicator.is-error {
      border-color: var(--danger);
      color: var(--danger);
      box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.15);
    }

    .wizard-step-indicator.is-error .wizard-step-number {
      background: var(--danger);
      color: #fff;
    }

    .wizard-step-indicator.is-disabled {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
    }

    .wizard-step-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .wizard-step-label {
      font-size: 0.74rem; /* Reducido de 0.92rem (20% menos) */
      font-weight: 600;
      color: inherit;
    }

    .wizard-step-helper {
      font-size: 0.60rem; /* Reducido de 0.75rem (20% menos) */
      color: var(--text-muted);
    }

    .wizard-step-container {
      width: 100%;
      flex: 0 1 auto;
      overflow-y: auto;
      padding: 0 4px;
      min-height: 0;
      max-height: calc(92vh - 360px);
    }

    .wizard-step {
      display: none;
      flex-direction: column;
      gap: 14px;
      width: 100%;
      padding: 8px 6px;
    }

    .wizard-step.wizard-step--active {
      display: flex;
    }

    .wizard-step.wizard-step--invalid {
      border-left: 3px solid var(--danger);
      padding-left: 19px;
      margin-left: -3px;
      transition: border-color 0.3s ease, background 0.3s ease;
      background: rgba(220, 38, 38, 0.04);
      animation: wizard-step-pulse 0.48s ease;
    }

    .wizard-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .wizard-actions .btn.is-hidden {
      display: none !important;
    }

    .wizard-actions .btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .wizard-actions__spacer {
      flex: 1 1 auto;
    }

    .wizard-actions .wizard-save-btn {
      display: none;
    }

    .wizard-actions .wizard-save-btn.is-visible {
      display: inline-flex;
    }

    @media (max-width: 1280px) {
      .wizard-timeline {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @keyframes wizard-step-pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.01);
      }
      100% {
        transform: scale(1);
      }
    }

    @media (max-width: 860px) {
      .wizard-timeline {
        grid-template-columns: 1fr;
      }

      .wizard-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .wizard-actions__spacer {
        display: none;
      }

      .wizard-actions .btn {
        width: 100%;
      }
    }

    /* Layout corporativo del modal principal */
    .sap-modal-header {
      padding: 10px 22px 8px 22px;
      background: rgba(21, 27, 36, 0.8);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sap-header-row {
      display: flex;
      align-items: center;
      gap: 12px;
      min-height: 32px;
    }

    .sap-header-leading {
      display: inline-flex;
      align-items: baseline;
      gap: 10px;
      min-width: 0;
    }

    .sap-header-eyebrow {
      font-size: 0.64rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-secondary);
      font-weight: 600;
      white-space: nowrap;
    }

    .sap-header-title {
      font-size: 1.04rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sap-header-subtitle {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin: 0;
      line-height: 1.3;
      opacity: 0.85;
    }

    .sap-header-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-left: auto;
    }

    .sap-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      flex: 0 0 auto;
      white-space: nowrap;
    }

    .sap-meta-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      font-weight: 700;
    }

    .sap-meta-value {
      font-size: 0.74rem;
      color: var(--text-primary);
      font-weight: 600;
    }

    .sap-meta-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--primary-light);
      background: rgba(91, 139, 180, 0.16);
      border: 1px solid rgba(91, 139, 180, 0.22);
      border-radius: 999px;
      padding: 3px 8px;
      line-height: 1;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    .sap-meta-chip--empty {
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .sap-header-meta .version-indicator {
      margin-left: 6px;
      font-size: 0.65rem;
      padding: 5px 10px;
    }

    .sap-modal-form {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .sap-form-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 0;
      flex: 1 1 auto;
      min-height: 0;
      overflow: hidden;
    }

    .modal-scroll {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 28px 32px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      column-gap: 28px;
      row-gap: 24px;
      background: rgba(16, 21, 29, 0.88);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0;
      box-shadow: none;
      max-height: calc(92vh - 280px);
    }

    .sap-empty {
      margin-left: 24px;
      padding: 6px 8px;
      font-size: 11px;
      color: var(--text-secondary);
      font-style: italic;
    }

    .sap-node-leaf .sap-node-content {
      padding-left: 24px;
    }

    .sap-node-spacer {
      display: inline-block;
      width: 16px;
    }

    /* Wizard dentro del grid */
    .modal-scroll .wizard-timeline {
      grid-column: 1 / -1;
      margin-bottom: 0;
    }

    .modal-scroll .wizard-step-container {
      grid-column: 1 / -1;
      display: contents;
    }

    .sap-form-actions {
      padding: 20px 32px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      background: rgba(12, 16, 24, 0.95);
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .sap-form-actions .btn-primary-cta {
      min-width: 260px;
      justify-content: center;
    }

    .sap-form-actions .btn-secondary {
      min-width: 180px;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: var(--radius-md);
    }

    .form-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 20px 24px;
      background: rgba(12, 16, 24, 0.82);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 14px;
      box-shadow: var(--shadow-xs, 0 6px 16px rgba(0, 0, 0, 0.28));
    }

    .form-section--half {
      grid-column: span 1;
      min-width: 760px;
    }

    .form-section--full {
      grid-column: 1 / -1;
      min-width: 900px; /* Ampliar de 760px a 900px para Step 3 */
    }

    /* Layouts internos de las secciones */
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(360px, 1fr));
      gap: 18px;
    }

    .form-row-triple {
      display: grid;
      grid-template-columns: repeat(3, minmax(240px, 1fr));
      gap: 18px;
    }

    .form-stock-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
    }

    .form-section-header {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .form-section-title {
      font-size: 0.86rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .form-section-description {
      font-size: 0.69rem;
      color: var(--text-secondary);
      margin: 0;
      max-width: 640px;
    }

    .form-section--half {
      width: 100%;
    }

    .form-section--full {
      width: 100%;
    }

    .version-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 11px;
      border-radius: 999px;
      font-size: 0.68rem;
      font-weight: 600;
      border: 1px solid transparent;
      background: rgba(91, 139, 180, 0.18);
      color: var(--primary-light);
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .version-indicator::before {
      content: '';
      font-size: 0.8rem;
    }

    .version-indicator-cascada {
      background: rgba(34, 197, 94, 0.16);
      border-color: rgba(34, 197, 94, 0.4);
      color: #4ade80;
    }

    .version-indicator-original {
      background: rgba(59, 130, 246, 0.16);
      border-color: rgba(59, 130, 246, 0.4);
      color: #60a5fa;
    }

    .ubicaciones-section {
      padding: 0;
      border: none;
      background: transparent;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ubicaciones-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .ubicaciones-title {
      margin: 0;
      color: var(--text-primary);
      font-size: 0.86rem;
      font-weight: 600;
    }

    .ubicaciones-subtitle {
      font-size: 0.68rem;
      color: var(--text-secondary);
      margin-top: 3px;
    }

    .ubicaciones-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-agregar-ubicacion {
      padding: 4px 10px;
      font-size: 0.74rem;
      background: rgba(91, 139, 180, 0.18);
      border: 1px solid rgba(91, 139, 180, 0.45);
      color: var(--primary-light);
      box-shadow: none;
    }

    .btn-agregar-ubicacion:hover {
      background: rgba(91, 139, 180, 0.28);
    }

    .ubicaciones-hint {
      background: rgba(91, 139, 180, 0.12);
      padding: 6px 10px;
      border-radius: 6px;
      border-left: 3px solid var(--primary);
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .sap-ubicaciones-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(900px, 1fr));
      gap: 18px;
    }

    .sap-ubicacion-card {
      border: 1px solid var(--border-color);
      border-radius: 0px;
      padding: 12px;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 11px;
      min-height: 100%;
      min-width: 900px;
      background: #1e2229;
    }

    .sap-ubicacion-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .sap-ubicacion-card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .sap-ubicacion-index {
      display: inline-flex;
      width: 26px;
      height: 26px;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(91, 139, 180, 0.22);
      color: var(--primary);
      font-size: 0.7rem;
      font-weight: 600;
    }

    .sap-btn-remove {
      background: transparent !important;
      color: var(--danger);
      border: 1px solid rgba(184, 107, 107, 0.6);
      box-shadow: none;
    }

    .sap-btn-remove:hover {
      background: rgba(184, 107, 107, 0.18) !important;
      color: #fca5a5;
      border-color: rgba(184, 107, 107, 0.75);
    }

    .sap-ubicacion-body {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .sap-field-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .sap-step-label {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 0.74rem;
      color: var(--text-primary);
      font-weight: 500;
      flex-direction: row;
    }

    .sap-step-number {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(91, 139, 180, 0.22);
      color: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.68rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    /* Controles compactos para ubicaciones en wizard */
    .wizard-step[data-step="3"] .form-control {
      padding: 5px 8px;
      font-size: 0.75rem;
      min-height: 32px;
    }

    .wizard-step[data-step="3"] .sap-ubicacion-card {
      max-width: 100%;
    }

    .wizard-step[data-step="3"] .ubicaciones-section {
      margin: 0;
    }

    .sap-step-hint {
      color: var(--text-muted);
      font-size: 0.62rem;
      display: block;
      margin-top: 4px;
    }

    /* ============================================ */
    /* SELECTOR VISUAL DE JERARQUÍA EN MODAL */
    /* ============================================ */
    .ubicaciones-section-visual {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 100%; /* Ampliar a todo el ancho disponible */
    }

    .ubicaciones-visual-header {
      text-align: center;
      padding: 16px;
      background: rgba(91, 139, 180, 0.08);
      border-radius: 6px;
      border-left: 3px solid var(--primary);
    }

    .ubicaciones-visual-title {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 0 0 8px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .ubicaciones-icon {
      font-size: 1.2rem;
    }

    /* Botón agregar área dentro del árbol */
    .tree-actions-internal {
      padding: 12px;
      background: rgba(76, 175, 80, 0.1);
      border: 1px dashed rgba(76, 175, 80, 0.3);
      border-radius: 6px;
      margin-bottom: 12px;
      text-align: center;
    }

    .tree-actions-internal .btn {
      width: 100%;
    }

    .ubicaciones-visual-description {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .ubicaciones-actions-top {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .ubicaciones-actions-top .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .ubicaciones-tree-selector {
      background: #1a1f26;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Estilos del árbol adaptados del Tab Jerarquía */
    .ubicaciones-tree-selector .jerarquia-tree-node {
      margin-bottom: 4px;
    }

    .ubicaciones-tree-selector .jerarquia-node-content {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ubicaciones-tree-selector .jerarquia-node-content:hover {
      background: rgba(91, 139, 180, 0.15);
      border-color: var(--primary);
    }

    .ubicaciones-tree-selector .jerarquia-node-content.is-selected {
      background: linear-gradient(135deg, rgba(91, 139, 180, 0.4), rgba(91, 139, 180, 0.25));
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(91, 139, 180, 0.3), inset 0 0 8px rgba(91, 139, 180, 0.2);
      font-weight: 600;
    }

    .ubicaciones-tree-selector .jerarquia-node-content.is-selected .jerarquia-node-name {
      color: var(--primary);
    }
    
    /* Nodo asignado (ubicación actual del repuesto) */
    .ubicaciones-tree-selector .jerarquia-node-content.is-assigned {
      background: linear-gradient(90deg, rgba(46, 204, 113, 0.2) 0%, rgba(46, 204, 113, 0.08) 100%);
      border-left: 4px solid #2ecc71;
      font-weight: 600;
    }
    
    .ubicaciones-tree-selector .jerarquia-node-content.is-assigned .jerarquia-node-name {
      color: #27ae60;
    }
    
    .ubicaciones-tree-selector .jerarquia-node-content.is-assigned .jerarquia-node-icon {
      filter: hue-rotate(90deg) saturate(1.5);
    }
    
    /* Nodo recién guardado (animación temporal 2s) */
    .jerarquia-node-content.node-just-saved {
      animation: pulseHighlight 2s ease-in-out;
      background: linear-gradient(90deg, rgba(255, 193, 7, 0.3) 0%, rgba(255, 193, 7, 0.1) 100%) !important;
      border-left: 4px solid #ffc107 !important;
      box-shadow: 0 0 12px rgba(255, 193, 7, 0.4) !important;
    }
    
    @keyframes pulseHighlight {
      0%, 100% { 
        box-shadow: 0 0 12px rgba(255, 193, 7, 0.4);
        transform: scale(1);
      }
      25% { 
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
        transform: scale(1.02);
      }
      50% {
        box-shadow: 0 0 16px rgba(255, 193, 7, 0.5);
        transform: scale(1.01);
      }
      75% {
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
        transform: scale(1.02);
      }
    }

    .ubicaciones-tree-selector .jerarquia-node-toggle {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
    }

    .ubicaciones-tree-selector .jerarquia-node-icon {
      font-size: 1rem;
    }

    .ubicaciones-tree-selector .jerarquia-node-name {
      flex: 1;
      font-size: 0.9rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .ubicaciones-tree-selector .jerarquia-node-count {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: rgba(91, 139, 180, 0.15);
      padding: 2px 8px;
      border-radius: 10px;
    }

    .ubicaciones-tree-selector .jerarquia-node-actions {
      display: none;
      gap: 4px;
      margin-left: 8px;
    }

    .ubicaciones-tree-selector .jerarquia-node-content:hover .jerarquia-node-actions {
      display: flex;
    }

    .ubicaciones-tree-selector .node-btn {
      padding: 2px 6px;
      font-size: 0.75rem;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s ease;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
    }

    .ubicaciones-tree-selector .node-btn-add {
      color: var(--success);
      border-color: var(--success);
      background: rgba(76, 175, 80, 0.1);
    }

    .ubicaciones-tree-selector .node-btn-add:hover {
      background: var(--success);
      color: white;
    }

    .ubicaciones-tree-selector .node-btn-edit {
      color: var(--warning);
      border-color: var(--warning);
      background: rgba(255, 193, 7, 0.1);
    }

    .ubicaciones-tree-selector .node-btn-edit:hover {
      background: var(--warning);
      color: white;
    }

    .ubicaciones-tree-selector .node-btn-delete {
      color: var(--danger);
      border-color: var(--danger);
      background: rgba(244, 67, 54, 0.1);
    }

    .ubicaciones-tree-selector .node-btn-delete:hover {
      background: var(--danger);
      color: white;
    }

    .ubicaciones-tree-selector .jerarquia-node-children {
      margin-left: 24px;
      margin-top: 4px;
      border-left: 1px solid rgba(91, 139, 180, 0.2);
      padding-left: 12px;
    }

    /* Panel de asignación de ubicación */
    .ubicaciones-assignment-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }

    .ubicacion-selected-info {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .selected-area-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(91, 139, 180, 0.15), rgba(91, 139, 180, 0.05));
      border: 1px solid rgba(91, 139, 180, 0.3);
      border-radius: 8px;
    }

    .selected-area-icon {
      font-size: 1.8rem;
      flex-shrink: 0;
    }

    .selected-area-details {
      flex: 1;
    }

    .selected-area-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .selected-area-path {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .path-level {
      background: rgba(91, 139, 180, 0.2);
      padding: 4px 10px;
      border-radius: 4px;
      font-weight: 500;
      white-space: nowrap;
    }

    .path-arrow {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .assignment-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .assignment-actions .btn-lg {
      min-width: 250px;
    }
    
    .assignment-actions .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border: 2px solid #27ae60;
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .assignment-actions .btn-success:hover {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }

    .ubicacion-no-selected {
      padding: 20px;
      text-align: center;
    }

    /* Repuestos en ubicación */
    .repuestos-en-ubicacion {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .repuestos-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .repuestos-icon {
      font-size: 1.2rem;
    }

    .repuestos-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .repuestos-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      background: rgba(255, 193, 7, 0.2);
      color: var(--warning);
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0 8px;
    }

    .repuestos-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .repuesto-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255, 193, 7, 0.08);
      border: 1px solid rgba(255, 193, 7, 0.2);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .repuesto-item:hover {
      background: rgba(255, 193, 7, 0.15);
      border-color: rgba(255, 193, 7, 0.4);
    }

    .repuesto-icon {
      font-size: 1.1rem;
      color: var(--warning);
    }

    .repuesto-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .repuesto-nombre {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .repuesto-codigo {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .btn-repuesto-edit {
      padding: 4px 8px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .btn-repuesto-edit:hover {
      background: var(--warning);
      border-color: var(--warning);
    }

    /* ============================================
       UBICACIONES ASIGNADAS - Panel Compacto
       ============================================ */
    .ubicaciones-asignadas-panel {
      margin-bottom: 20px;
      padding: 16px;
      background: rgba(33, 150, 243, 0.08);
      border: 1px solid rgba(33, 150, 243, 0.2);
      border-radius: 8px;
    }

    .ubicaciones-asignadas-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(33, 150, 243, 0.2);
    }

    .ubicaciones-icon {
      font-size: 1.2rem;
    }

    .ubicaciones-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .ubicaciones-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      background: rgba(33, 150, 243, 0.2);
      color: var(--primary);
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0 8px;
      margin-right: auto; /* Empujar el botón a la derecha */
    }

    .ubicaciones-asignadas-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .ubicacion-asignada-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(33, 150, 243, 0.2);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .ubicacion-asignada-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(33, 150, 243, 0.4);
    }

    .ubicacion-path-compact {
      flex: 1;
      font-size: 0.8rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .ubicacion-cantidad-control {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      border-radius: 4px;
    }

    .ubicacion-cantidad-control input[type="number"] {
      width: 50px !important;
      min-width: 50px;
    }

    .ubicacion-path-compact .path-separator {
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .ubicacion-path-compact .path-level {
      background: rgba(33, 150, 243, 0.15);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    .btn-ubicacion-delete {
      padding: 4px 10px;
      background: rgba(231, 76, 60, 0.1);
      border: 1px solid rgba(231, 76, 60, 0.3);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      color: var(--danger);
    }

    .btn-ubicacion-delete:hover {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    /* Chips legacy - mantener para compatibilidad */
    .ubicaciones-selected-chips {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 16px;
    }

    .selected-chips-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .selected-chips-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .selected-chips-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0 8px;
    }

    .selected-chips-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 40px;
    }

    .selected-chips-list:empty::after {
      content: "Ninguna ubicación seleccionada aún";
      color: var(--text-muted);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* Chips mejorados con rama jerárquica completa */
    .ubicacion-chip-enhanced {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .chip-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .chip-badge {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .chip-path-full {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .chip-level {
      background: rgba(91, 139, 180, 0.15);
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 500;
      white-space: nowrap;
    }

    .chip-separator {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }

    .chip-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }

    .chip-enumeration {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .chip-btn:hover:not(:disabled) {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .chip-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .chip-count {
      min-width: 30px;
      text-align: center;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--primary);
    }

    .chip-remove-btn {
      padding: 6px 12px;
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid rgba(244, 67, 54, 0.3);
      border-radius: 4px;
      color: var(--danger);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .chip-remove-btn:hover {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    /* Chips legacy - mantener para compatibilidad */
    .ubicacion-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(91, 139, 180, 0.2);
      border: 1px solid rgba(91, 139, 180, 0.4);
      border-radius: 16px;
      padding: 6px 12px;
      font-size: 0.8rem;
      color: var(--text-primary);
    }

    .ubicacion-chip-path {
      font-weight: 500;
    }

    .ubicacion-chip-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: rgba(184, 107, 107, 0.3);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #fca5a5;
      font-size: 0.85rem;
    }

    .ubicacion-chip-remove:hover {
      background: rgba(184, 107, 107, 0.6);
      color: white;
    }

    .ubicaciones-actions-bottom {
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    /* Botones de guardar en cada step */
    .step-actions-bottom {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .step-actions-bottom .btn-lg {
      min-width: 200px;
      font-size: 1rem;
      padding: 12px 24px;
    }

    @media (max-width: 1320px) {
      .sap-form-grid {
        padding: 0;
      }

      .modal-scroll {
        grid-template-columns: 1fr;
        padding: 20px 22px;
        gap: 18px;
      }

      .form-section,
      .form-section--half,
      .form-section--full {
        grid-column: 1 / -1;
        padding: 16px 18px;
      }

      .form-section {
        gap: 14px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .form-row-triple {
        grid-template-columns: 1fr;
      }

      .form-stock-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 900px) {
      .sap-header-meta {
        flex-direction: column;
        align-items: flex-start;
      }

      .sap-meta-item {
        width: auto;
      }

      .sap-header-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .sap-header-title {
        white-space: normal;
      }

      .modal-scroll {
        padding: 16px;
        gap: 14px;
      }

      .form-section {
        padding: 14px 16px;
        gap: 12px;
      }

      .sap-header-meta .version-indicator {
        margin-left: 0;
      }

      .sap-form-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .sap-form-actions .btn {
        width: 100%;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(184, 107, 107, 0.9);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .modal-close:hover {
      background: var(--danger);
      box-shadow: var(--shadow-sm);
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 20px;
      padding-right: 50px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 12px;
    }

    .form-group {
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 3px;
      font-size: 0.75rem;
    }

    .form-control {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.78rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      font-family: inherit;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
      background: var(--bg-secondary);
    }

    .form-control::placeholder {
      color: var(--text-secondary);
      opacity: 0.55;
    }

    /* ELIMINADO: Ahora se define arriba con mejor especificidad */
    
    /* Layout optimizado para 4 columnas en campos pequeños */
    .form-row-quad {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
    }
    
    /* Contenedor del formulario compactado */
    .modal-form {
      display: grid;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }
    
    /* Seccin de multimedia con altura flexible */
    .multimedia-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .multimedia-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 8px;
      max-height: 240px;
      overflow-y: auto;
      padding: 8px;
      background: var(--bg-primary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    
    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .preview-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .preview-delete:hover {
      background: #d63031;
    }
    
    .preview-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 0.62rem;
      padding: 3px;
      text-align: center;
    }
    
    .multimedia-preview::-webkit-scrollbar {
      width: 6px;
    }
    
    .multimedia-preview::-webkit-scrollbar-thumb {
      background: var(--gray-400);
      border-radius: 3px;
    }

    .autocomplete-container {
      position: relative;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 2px solid var(--primary);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
    }

    .autocomplete-list.active {
      display: block;
    }

    .autocomplete-item {
      padding: 12px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--gray-200);
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background: var(--bg-secondary);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    /* LIGHTBOX */
    .lightbox {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .lightbox.active {
      display: flex;
    }

    .lightbox-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    .lightbox-content img,
    .lightbox-content video {
      max-width: 100%;
      max-height: 90vh;
      border-radius: 8px;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 30px;
      cursor: pointer;
      z-index: 3001;
      transition: all 0.3s;
    }

    .lightbox-close:hover {
      background: #b91c1c;
      transform: rotate(90deg);
    }

    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 20px;
      font-size: 30px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.3s;
      z-index: 3001;
    }

    .lightbox-nav:hover {
      background: rgba(255,255,255,0.4);
    }

    .lightbox-prev {
      left: 20px;
    }

    .lightbox-next {
      right: 20px;
    }

    /* JERARQUA CASCADA - Estilo rbol visual */
    .hierarchy-tree {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hierarchy-level {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-primary);
      border-radius: 10px;
      border-left: 4px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      animation: slideInRight 0.3s ease-out forwards;
      opacity: 0;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(20px);
      }
    }

    /* ========================================
       ESTILO CORPORATIVO BASE - MINIMALISTA
       ======================================== */
    .corp-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: transparent;
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--border-color);
      border-top: none;
      border-right: none;
      border-bottom: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .corp-btn:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
      transform: translateX(3px);
    }

    .corp-btn:active {
      transform: translateX(1px);
    }

    /* Variantes de color para corp-btn - solo borde */
    .corp-btn-primary {
      border-left-color: var(--primary);
    }

    .corp-btn-primary:hover {
      color: var(--primary-light);
    }

    .corp-btn-success {
      border-left-color: var(--success);
    }

    .corp-btn-warning {
      border-left-color: var(--warning);
    }

    .corp-btn-danger {
      border-left-color: var(--danger);
    }

    .corp-btn-secondary {
      border-left-color: var(--gray-600);
      opacity: 0.7;
    }

    .corp-btn-secondary:hover {
      opacity: 1;
    }

    /* Toggle minimalista */
    .toggle-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: transparent;
      border-left: 3px solid var(--gray-600);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0.7;
    }

    .toggle-wrapper:hover {
      opacity: 1;
      transform: translateX(3px);
    }

    .toggle-wrapper.active {
      border-left-color: var(--primary);
      opacity: 1;
    }

    .toggle-track {
      width: 36px;
      height: 18px;
      background: var(--gray-600);
      border-radius: 9px;
      position: relative;
      transition: background 0.3s ease;
    }

    .toggle-wrapper.active .toggle-track {
      background: var(--primary);
    }

    .toggle-thumb {
      width: 14px;
      height: 14px;
      background: var(--text-primary);
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .toggle-wrapper.active .toggle-thumb {
      transform: translateX(18px);
    }

    .toggle-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* ============================================
       ESTILOS GLASSMORPHISM PARA TOOLBAR
       ============================================ */
    
    .glass-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .glass-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15),
                  inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .glass-btn-primary {
      background: rgba(91, 139, 180, 0.3);
      border-color: rgba(91, 139, 180, 0.5);
      color: var(--primary-light);
    }

    .glass-btn-primary:hover {
      background: rgba(91, 139, 180, 0.4);
    }

    /* Toggle de vista glassmorphism */
    .view-toggle {
      display: inline-flex;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 4px;
      gap: 4px;
    }

    .view-toggle-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.3s ease;
    }

    .view-toggle-btn.active {
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
    }

    .view-toggle-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.06);
    }

    /* Estado de conexión glassmorphism */
    .glass-btn.connection {
      position: relative;
      padding: 10px 14px;
    }

    .glass-btn.connection.connected {
      background: rgba(91, 155, 122, 0.25);
      border-color: rgba(91, 155, 122, 0.5);
      color: #7db99a;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(91, 155, 122, 0.2);
    }

    .glass-btn.connection.disconnected {
      background: rgba(184, 107, 107, 0.25);
      border-color: rgba(184, 107, 107, 0.5);
      color: #c88585;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(184, 107, 107, 0.2);
    }

    .glass-btn.connection:hover {
      transform: scale(1.05) translateY(-2px);
    }

    /* Búsqueda glassmorphism */
    .glass-search {
      flex: 1;
      max-width: 250px;
      position: relative;
    }

    .glass-search input {
      width: 100%;
      padding: 10px 18px 10px 40px;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      color: var(--text-primary);
      font-size: 0.85rem;
      transition: all 0.3s ease;
    }

    .glass-search input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .glass-search .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.5;
    }

    /* Botones de acción (limpiar, deshacer, rehacer) */
    .glass-action-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 1.1rem;
      transition: all 0.3s ease;
      margin-left: 8px;
    }

    .glass-action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      transform: scale(1.05);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .glass-action-btn:active {
      transform: scale(0.95);
    }

    /* Controles de zoom glassmorphism */
    .glass-zoom-controls {
      display: inline-flex;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 4px;
      gap: 4px;
      align-items: center;
    }

    .glass-zoom-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .glass-zoom-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .glass-zoom-display {
      padding: 0 12px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      min-width: 50px;
      text-align: center;
    }

    .hierarchy-level:nth-child(1) {
      border-left-color: var(--warning);
      animation-delay: 0.1s;
    }

    .hierarchy-level:nth-child(2) {
      border-left-color: var(--primary);
      margin-left: 24px;
      animation-delay: 0.2s;
    }

    .hierarchy-level:nth-child(3) {
      border-left-color: var(--info);
      margin-left: 48px;
      animation-delay: 0.3s;
    }

    .hierarchy-level:nth-child(4) {
      border-left-color: var(--success);
      margin-left: 72px;
      animation-delay: 0.4s;
    }

    .hierarchy-level:hover {
      background: var(--bg-tertiary);
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    .hierarchy-icon {
      font-size: 1.8rem;
      flex-shrink: 0;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .hierarchy-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hierarchy-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .hierarchy-value {
      font-size: 1.05rem;
      color: var(--text-primary);
      font-weight: 600;
    }

    .hierarchy-connector {
      position: absolute;
      left: -12px;
      top: -8px;
      bottom: -8px;
      width: 2px;
      background: linear-gradient(180deg, transparent 0%, var(--border-color) 20%, var(--border-color) 80%, transparent 100%);
    }

    .hierarchy-level:nth-child(1) .hierarchy-connector {
      display: none;
    }

    /* Botn icono de jerarqua en tarjetas */
    .btn-hierarchy {
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }

    .btn-hierarchy:hover {
      background: var(--primary-dark);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn-hierarchy:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    /* Modal Estadsticas - Responsive */
    @media (max-width: 768px) {
      #modalEstadisticas > div {
        width: 95% !important;
        height: 95vh !important;
        margin: 2.5vh auto !important;
      }
      
      #modalEstadisticas h2 {
        font-size: 1.3rem !important;
      }
      
      #estadisticasContent > div:nth-child(2) {
        grid-template-columns: 1fr !important;
      }
      
      #estadisticasContent > div:nth-child(3) > div {
        grid-template-columns: 1fr !important;
      }
    }

    #modalEstadisticas::-webkit-scrollbar,
    #estadisticasContent::-webkit-scrollbar {
      width: 8px;
    }

    #modalEstadisticas::-webkit-scrollbar-track,
    #estadisticasContent::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    #modalEstadisticas::-webkit-scrollbar-thumb,
    #estadisticasContent::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    #modalEstadisticas::-webkit-scrollbar-thumb:hover,
    #estadisticasContent::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }

    /* Modal Cascada - Estilos */
    #modalCascada::-webkit-scrollbar,
    #cascadaContent::-webkit-scrollbar {
      width: 8px;
    }

    #modalCascada::-webkit-scrollbar-track,
    #cascadaContent::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    #modalCascada::-webkit-scrollbar-thumb,
    #cascadaContent::-webkit-scrollbar-thumb {
      background: #6366f1;
      border-radius: 4px;
    }

    #modalCascada::-webkit-scrollbar-thumb:hover,
    #cascadaContent::-webkit-scrollbar-thumb:hover {
      background: #8b5cf6;
    }

    @media (max-width: 768px) {
      #modalCascada > div {
        width: 95% !important;
        height: 95vh !important;
        margin: 2.5vh auto !important;
      }
      
      #modalCascada h3 {
        font-size: 1rem !important;
      }
    }

    .lightbox-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: 700;
      z-index: 3001;
    }

    /* TOAST NOTIFICATIONS - VERSIN CORPORATIVA MEJORADA */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #334155;
      padding: 18px 24px;
      border-radius: 16px;
      box-shadow: 
        0 20px 60px rgba(0,0,0,0.15),
        0 8px 32px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
      animation: slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 4000;
      font-weight: 600;
      max-width: 420px;
      min-width: 280px;
      word-wrap: break-word;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      backdrop-filter: blur(20px) saturate(180%);
      cursor: pointer;
      overflow: hidden;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    /* Indicador de tipo con lnea lateral */
    .toast::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--toast-accent, #64748b);
      border-radius: 0 2px 2px 0;
    }

    /* Icono del tipo de notificacin */
    .toast::after {
      content: var(--toast-icon, '');
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      opacity: 0.7;
    }

    /* Efectos hover - mantener fijo */
    .toast:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 
        0 25px 80px rgba(0,0,0,0.2),
        0 12px 40px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.9);
      background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
      border-color: rgba(148, 163, 184, 0.4);
    }

    /* Estados por tipo - COLORES CORPORATIVOS SUTILES */
    .toast.toast-success {
      --toast-accent: #059669;
      --toast-icon: '';
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: #065f46;
      border-color: rgba(5, 150, 105, 0.2);
    }

    .toast.toast-success:hover {
      background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
    }

    .toast.toast-error {
      --toast-accent: #dc2626;
      --toast-icon: '';
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      color: #7f1d1d;
      border-color: rgba(220, 38, 38, 0.2);
    }

    .toast.toast-error:hover {
      background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
    }

    .toast.toast-warning {
      --toast-accent: #d97706;
      --toast-icon: '';
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      color: #92400e;
      border-color: rgba(217, 119, 6, 0.2);
    }

    .toast.toast-warning:hover {
      background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%);
    }

    .toast.toast-info {
      --toast-accent: #2563eb;
      --toast-icon: '';
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: #1e40af;
      border-color: rgba(37, 99, 235, 0.2);
    }

    .toast.toast-info:hover {
      background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
    }

    /* TOAST HUB - Ventana emergente consolidada */
    .toast-hub {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 20px;
      box-shadow: 
        0 25px 80px rgba(0,0,0,0.25),
        0 15px 50px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      width: 90vw;
      max-width: 500px;
      max-height: 80vh;
      z-index: 5000;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      backdrop-filter: blur(20px) saturate(180%);
      overflow: hidden;
    }

    .toast-hub.active {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .toast-hub-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toast-hub-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1e293b;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast-hub-counter {
      background: #64748b;
      color: white;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .toast-hub-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #64748b;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .toast-hub-close:hover {
      background: rgba(148, 163, 184, 0.1);
      color: #334155;
    }

    .toast-hub-content {
      padding: 12px;
      max-height: calc(80vh - 80px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast-hub-item {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 16px;
      position: relative;
      transition: all 0.2s;
      cursor: pointer;
    }

    .toast-hub-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border-color: rgba(148, 163, 184, 0.3);
    }

    .toast-hub-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--toast-accent, #64748b);
      border-radius: 0 2px 2px 0;
    }

    .toast-hub-item-content {
      padding-left: 16px;
      padding-right: 32px;
    }

    .toast-hub-item-icon {
      position: absolute;
      right: 12px;
      top: 12px;
      font-size: 1.1rem;
      opacity: 0.7;
    }

    .toast-hub-item-time {
      position: absolute;
      right: 12px;
      bottom: 12px;
      font-size: 0.75rem;
      color: #64748b;
      opacity: 0.8;
    }

    .toast-hub-item-delete {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(220, 38, 38, 0.1);
      color: #dc2626;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 0.8rem;
      opacity: 0;
      transition: all 0.2s;
    }

    .toast-hub-item:hover .toast-hub-item-delete {
      opacity: 1;
    }

    .toast-hub-item-delete:hover {
      background: rgba(220, 38, 38, 0.2);
    }

    /* Overlay para el toast hub */
    .toast-hub-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 4999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .toast-hub-overlay.active {
      opacity: 1;
    }

    /* Botn flotante para abrir el hub - DESACTIVADO (ahora usamos campana) */
    .toast-hub-trigger {
      display: none !important; /* Ocultar completamente el botn flotante */
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: 
        0 10px 30px rgba(59, 130, 246, 0.3),
        0 4px 15px rgba(59, 130, 246, 0.2);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 4001;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .toast-hub-trigger.active {
      display: flex;
    }

    .toast-hub-trigger:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 
        0 15px 40px rgba(59, 130, 246, 0.4),
        0 8px 20px rgba(59, 130, 246, 0.3);
    }

    /*  CAMPANA DE NOTIFICACIONES - MINIMALISTA */
    .notification-bell {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 56px;
      height: 56px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      color: var(--text-secondary);
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
      z-index: 4002;
    }

    .notification-bell:hover {
      transform: scale(1.05);
      color: var(--text-primary);
      box-shadow: var(--shadow-lg);
    }

    /* 🔄 BOTÓN DE REFRESH PWA - MÓVIL */
    .pwa-refresh-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      cursor: pointer;
      display: none; /* Oculto por defecto, solo visible en móvil */
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      color: #6b7280; /* Gris por defecto */
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      z-index: 4002;
    }

    /* Estados del botón refresh */
    .pwa-refresh-btn.state-default {
      color: #6b7280; /* Gris - sin actualización pendiente */
      border-color: #4b5563;
    }

    .pwa-refresh-btn.state-updated {
      color: #10b981; /* Verde - actualizado */
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    .pwa-refresh-btn.state-updating {
      color: #3b82f6; /* Azul - actualizando */
      border-color: #3b82f6;
      animation: pwa-spin 1s linear infinite;
    }

    .pwa-refresh-btn:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-lg);
    }

    .pwa-refresh-btn:active {
      transform: scale(0.95);
    }

    @keyframes pwa-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* 🆕 v6.073 - Botón PWA refresh flotante OCULTO - solo usamos el del header */
    @media (max-width: 768px) {
      .pwa-refresh-btn {
        display: none !important; /* Oculto - solo un botón de refresh en header */
      }
      
      /* Ajustar posición de la campana en móvil para no chocar */
      .notification-bell {
        width: 48px;
        height: 48px;
        font-size: 1.3rem;
      }
    }

    /* 🆕 BANNER DE ACTUALIZACIÓN PWA - VISIBLE EN TODA LA PANTALLA */
    .pwa-update-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 12px 20px;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 15px;
      z-index: 10000;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      animation: slideDown 0.5s ease-out;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .pwa-update-banner.visible {
      display: flex;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      }
      50% {
        box-shadow: 0 4px 30px rgba(59, 130, 246, 0.7), 0 0 40px rgba(59, 130, 246, 0.3);
      }
    }

    .pwa-update-banner.visible {
      animation: slideDown 0.5s ease-out, pulse-glow 2s ease-in-out infinite;
    }

    .pwa-update-banner-icon {
      font-size: 1.5rem;
      animation: pwa-spin 2s linear infinite;
    }

    .pwa-update-banner-text {
      flex: 1;
      text-align: center;
    }

    .pwa-update-banner-title {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 2px;
    }

    .pwa-update-banner-subtitle {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .pwa-update-banner-btn {
      background: white;
      color: #1d4ed8;
      border: none;
      padding: 8px 20px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .pwa-update-banner-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
    }

    .pwa-update-banner-btn:active {
      transform: scale(0.98);
    }

    .pwa-update-banner-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin-left: 5px;
    }

    .pwa-update-banner-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    /* Responsive para móvil */
    @media (max-width: 600px) {
      .pwa-update-banner {
        padding: 10px 15px;
        gap: 10px;
        flex-wrap: wrap;
      }

      .pwa-update-banner-text {
        order: 1;
        width: 100%;
        flex: none;
      }

      .pwa-update-banner-icon {
        order: 0;
        font-size: 1.2rem;
      }

      .pwa-update-banner-btn {
        order: 2;
        flex: 1;
        justify-content: center;
        padding: 10px 15px;
      }

      .pwa-update-banner-close {
        order: 3;
      }
    }