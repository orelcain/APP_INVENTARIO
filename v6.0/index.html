<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APP Inventario v6.0</title>

  <!-- CSS Modular para Jerarquía de Mapas -->
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/mapas-hierarchy.css">
  <link rel="stylesheet" href="styles/prototype-mapas.css">

  <style>
    /* CACHE-BUST: 2025-11-19-v50-CORRELATIVOS-GLOBALES-EN-MAPAS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /*  PALETA v6.0 - EQUILIBRADA (80% Grises, 20% Acentos) */
      --primary: #5b8bb4;           /* Azul corporativo desaturado */
      --primary-light: #7ba5c8;     /* Azul claro */
      --primary-dark: #4a7090;      /* Azul oscuro */
      --secondary: #6a7581;         /* Gris medio neutro */
      --success: #5b9b7a;           /* Verde esmeralda desaturado */
      --success-dark: #4a7d62;      /* Verde oscuro */
      --warning: #b8925a;           /* mbar desaturado */
      --warning-dark: #9a7848;      /* mbar oscuro */
      --danger: #b86b6b;            /* Rojo coral desaturado */
      --danger-dark: #985555;       /* Rojo oscuro */
      --info: #5b8bb4;              /* Azul info (igual a primary) */
      --info-dark: #4a7090;         /* Azul oscuro */

      /*  Fondos oscuros pero no extremos */
      --gray-50: #1a1d23;           /* Fondo app (ligeramente ms claro) */
      --gray-100: #1e2229;          /* Base principal */
      --gray-200: #252a33;          /* Tarjetas (+10% luminosidad) */
      --gray-300: #2d333d;          /* Hover states */
      --gray-400: #3a4049;          /* Elevado */
      --gray-500: #4a5059;          /* Separadores */
      --gray-600: #6a7078;          /* Texto terciario */
      --gray-700: #8a9098;          /* Texto secundario */
      --gray-800: #b8bec8;          /* Texto normal */
      --gray-900: #e6e9ef;          /* Texto primario */

      /*  Sombras equilibradas (ni planas ni dramticas) */
      --shadow-sm:
        0 2px 4px rgba(0, 0, 0, 0.25),
        0 1px 2px rgba(0, 0, 0, 0.15);
      --shadow-md:
        0 4px 8px rgba(0, 0, 0, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.2);
      --shadow-lg:
        0 8px 16px rgba(0, 0, 0, 0.35),
        0 4px 8px rgba(0, 0, 0, 0.25);
      --shadow-xl:
        0 12px 24px rgba(0, 0, 0, 0.4),
        0 6px 12px rgba(0, 0, 0, 0.3);

      /* Atajos para compatibilidad */
      --card-shadow: var(--shadow-sm);
      --card-shadow-hover: var(--shadow-md);
      --neomorph-shadow: var(--shadow-md);
      --neomorph-shadow-sm: var(--shadow-sm);
      --neomorph-shadow-hover: var(--shadow-lg);
      --neomorph-shadow-inset: inset 0 2px 4px rgba(0, 0, 0, 0.2);

      /*  Geometra consistente - Border Radius estandarizado */
      --radius-sm: 6px;            /* Badges pequeos */
      --radius-md: 8px;            /*  DEFAULT - Botones, inputs, cards */
      --radius-lg: 12px;           /* Modales grandes */
      --radius-xl: 16px;           /* Imgenes */

      /* Bordes y lneas sutiles */
      --border-color: #2d333d;
      --border-color-light: #3a4049;
      --border-accent: #4a5059;

      /*  Fondos con profundidad sutil */
      --bg-primary: #1e2229;        /* Base principal */
      --bg-secondary: #252a33;      /* Tarjetas */
      --bg-tertiary: #2d333d;       /* Hover states */
      --bg-elevated: #3a4049;       /* Elementos elevados */
      --bg-app: #1a1d23;            /* Fondo general app */

      /*  Texto con jerarqua clara (4 niveles) */
      --text-primary: #e6e9ef;      /* Ttulos (blanco casi puro) */
      --text-secondary: #b8bec8;    /* Texto normal (gris claro) */
      --text-muted: #8a909a;        /* Metadata (gris medio) */
      --text-disabled: #5a606a;     /* Deshabilitados (gris oscuro) */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-app);
      color: var(--text-primary);
      margin: 0;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    #listView,
    #conteoGrid {
      will-change: scroll-position;
      /* -webkit-overflow-scrolling obsoleto en navegadores modernos */
    }

    /* CSS Containment para mejor rendimiento (Edge Chromium) */
    .repuesto-card {
      contain: layout style paint;
    }

    /* Aspect Ratio nativo (Edge 88+) */
    .card-image {
      aspect-ratio: 16 / 9;
      object-fit: cover;
    }

    /* Logical Properties para mejor RTL/LTR (Edge Chromium) */
    .card-content {
      padding-inline: 12px;
      padding-block: 10px;
      margin-block-end: 6px;
    }

    /* Color Scheme para dark mode nativo (Edge) */
    :root {
      color-scheme: dark light;
    }

    /* Cascade Layers para mejor especificidad (Edge 99+) */
    @layer base, components, utilities;

    @layer base {
      * {
        box-sizing: border-box;
      }
    }

    /* Subgrid para layouts complejos (Edge 117+) */
    @supports (grid-template-rows: subgrid) {
      .list-view {
        display: grid;
        grid-template-rows: auto subgrid;
      }
    }

    /* Has() Selector para interactividad sin JS (Edge 105+) */
    .repuesto-card:has(input:focus) {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    .palette-visual .node-name {
      font-size: 0.85em;
      font-weight: 600;
      flex: 0 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }
    }

    body.force-mobile .repuesto-card {
      max-width: 600px !important;
      margin: 0 auto !important;
    }

    body.force-mobile .card-image {
      height: 250px !important;
    }

    body.force-mobile .card-btn {
      min-height: 48px !important;
      font-size: 1rem !important;
      padding: 12px 16px !important;
    }

    body.force-mobile .btn {
      min-height: 48px !important;
      font-size: 1rem !important;
      padding: 12px 20px !important;
    }

    body.force-mobile .container {
      padding: 16px !important;
    }

    body.force-mobile #pagination {
      flex-direction: column !important;
      gap: 12px !important;
    }

    body.force-mobile #pagination > div:first-child {
      width: 100% !important;
    }

    body.force-mobile #pagination > div:first-child select,
    body.force-mobile #pagination > div:first-child button {
      width: 100% !important;
      margin: 4px 0 !important;
    }

    body.force-mobile #pagination > div:last-child {
      width: 100% !important;
      justify-content: center !important;
    }

    /* Modo Desktop Forzado - Aplica estilo desktop incluso en pantallas pequeas */
    body.force-desktop .cards-grid {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
      gap: 24px !important;
      padding: 24px !important;
    }

    body.force-desktop .repuesto-card {
      max-width: none !important;
    }

    body.force-desktop .card-image {
      height: 200px !important;
    }

    body.force-desktop .card-btn,
    body.force-desktop .btn {
      min-height: 40px !important;
      font-size: 0.95rem !important;
      padding: 10px 16px !important;
    }

    body.force-desktop .container {
      padding: 24px !important;
    }

    body.force-desktop #pagination {
      flex-direction: row !important;
      gap: 16px !important;
    }

    body.force-desktop #pagination > div:first-child,
    body.force-desktop #pagination > div:last-child {
      width: auto !important;
    }

    /* MODOS DE VISUALIZACIN - UTILIDADES */
    .hidden {
      display: none !important;
    }

    .scroll-hidden {
      overflow: hidden !important;
    }

    .hidden-file-input {
      display: none !important;
    }

    .mapa-legacy-title {
      margin-bottom: 20px;
      color: var(--primary);
    }

    /* RESPONSIVE BREAKPOINTS CLAVE */
    @media (max-width: 1024px) {
      .layout-grid {
        display: flex;
        flex-direction: column;
      }

      .layout-sidebar {
        width: 100%;
        margin-bottom: 20px;
      }

      .layout-content {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .jerarquia-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      .jerarquia-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .jerarquia-actions .btn {
        width: 100%;
      }
    }

    @media (max-width: 640px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .header-actions {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .header-actions .btn {
        width: 100%;
      }

      .search-container {
        flex-direction: column;
        gap: 10px;
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
      min-height: 36px;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-danger:hover {
      background: var(--danger-dark);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      box-shadow: var(--shadow-md);
    }

    .toggle-precio {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s;
      font-weight: 600;
      min-height: 48px;
    }

    .toggle-precio.active {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }

    /* NAVEGACIN PROFESIONAL - DESTACADA */
    .nav-tabs {
      background: var(--bg-secondary);
      display: flex;
      border-bottom: 3px solid var(--border-color);
      overflow-x: auto;
      /* -webkit-overflow-scrolling obsoleto en navegadores modernos */
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      /* No necesita position: sticky porque est dentro de sticky-header-container */
      padding: 0 8px;
      gap: 0;
      width: 100%;
    }

    .nav-tab {
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9rem;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      color: var(--text-muted);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      border-bottom: 4px solid transparent;
      border-right: 1px solid var(--border-color);
      touch-action: manipulation;
      position: relative;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      flex: 1 1 0;
      justify-content: center;
      min-width: 140px;
      text-align: center;
    }

    .nav-tab:last-child {
      border-right: none;
    }

    .nav-tab::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 4px;
      background: var(--primary);
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .nav-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      transform: translateY(-2px);
    }

    .nav-tab:hover::before {
      width: 100%;
    }

    .nav-tab.active {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.18) 0%, rgba(59, 130, 246, 0.05) 100%);
      color: var(--primary-light);
      border-bottom-color: var(--primary);
      box-shadow: inset 0 -4px 0 0 var(--primary);
    }

    .nav-tab.active::before {
      width: 100%;
    }

    .app-warmup-progress {
      position: relative;
      width: 100%;
      padding: 0 18px;
      background: rgba(9, 17, 29, 0.25);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      gap: 4px;
      opacity: 0;
      pointer-events: none;
      max-height: 0;
      overflow: hidden;
      transition: opacity 0.35s ease, max-height 0.35s ease, padding 0.35s ease;
    }

    .app-warmup-progress.active {
      padding: 6px 18px 4px;
      opacity: 1;
      max-height: 48px;
    }

    .warmup-progress-label {
      font-size: 0.72rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.55);
    }

    .warmup-progress-track {
      position: relative;
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .warmup-progress-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #4f8fc7, #7bd5ff);
      box-shadow: 0 0 12px rgba(79, 143, 199, 0.4);
      transition: width 0.3s ease-out;
    }

    .container {
      max-width: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }

    .tab-content {
      display: none;
      min-height: calc(100vh - 50px);
      overflow: auto;
      padding: 10px;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    /*  REGLA ESPECFICA PARA TAB MAPA */
    #mapa.tab-content {
      padding: 0; /* Sin padding solo para MAPA */
      overflow: hidden; /* Sin scroll solo para MAPA */
      position: fixed; /*  Posicin fija para ignorar contenedores */
      top: 45px; /*  Justo debajo de las pestaas */
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: calc(100vh - 45px);
      z-index: 1;
    }
    
    #mapa.tab-content.active {
      display: flex; /* Flex solo para MAPA cuando est activo */
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* TOOLBAR - Neumorfismo */
    /* ==========================================
       OPCIÓN 2: GRUPOS DEFINIDOS (RECOMENDADA)
       ========================================== */
    
    /* Toolbar - Contenedor principal */
    .toolbar {
      background: transparent;
      padding: 12px 0;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    /* Grupos visuales dentro del toolbar */
    .toolbar-group {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 0 12px;
      border-left: 2px solid var(--border-color);
    }
    
    .toolbar-group:first-child {
      border-left: none;
      padding-left: 0;
    }
    
    /* Grupo de búsqueda - alineado a la derecha */
    .toolbar-group-search {
      flex: 1;
      justify-content: flex-end;
      border-left: none;
    }
    
    /* Separador sutil entre grupos */
    .toolbar-separator {
      width: 1px;
      height: 24px;
      background: var(--border-color);
      opacity: 0.5;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
      font-size: 1.2rem;
    }

    .search-input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 1rem;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-tertiary);
      box-shadow: var(--shadow-sm);
      color: var(--text-primary);
    }

    .search-input:focus {
      outline: none;
      background: var(--bg-tertiary);
      border-color: var(--primary);
      box-shadow: var(--shadow-sm), 0 0 0 3px rgba(91, 139, 180, 0.2);
    }

    .view-btns {
      display: flex;
      gap: 8px;
    }

    /* Botones de vista - Minimalista */
    .view-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: transparent;
      border-radius: var(--radius-sm);
      border-left: 2px solid transparent;
      border-top: none;
      border-right: none;
      border-bottom: none;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.8rem;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .view-btn:hover {
      color: var(--text-primary);
      background: var(--bg-primary);
      border-left-color: var(--gray-600);
    }

    .view-btn.active {
      background: var(--bg-primary);
      border-left-color: var(--primary);
      color: var(--text-primary);
    }

    /*  BOTN DE CONEXIN - Estilo Neomorphism/Soft UI */
    #connectionBtn {
      position: relative;
      border: none !important;
      cursor: default !important;
      padding: 10px 14px !important;
      border-radius: var(--radius-md) !important;
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    #connectionBtn:hover {
      transform: translateY(-1px);
      box-shadow: 
        0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    #connectionBtn #connectionIcon {
      font-weight: 700;
      font-size: 1.1rem;
      display: inline-block;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* FILTROS */
    .filters-selects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .filter-select {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 48px;
      appearance: none;
      box-shadow: var(--shadow-sm);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238a909a' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    .filter-select:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-color-light);
    }

    .filter-select:focus {
      outline: none;
      background: var(--bg-tertiary);
      border-color: var(--primary);
      box-shadow: var(--shadow-sm), 0 0 0 3px rgba(91, 139, 180, 0.2);
    }

    .filter-chip {
      padding: 8px 16px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      transition: all 0.3s;
      touch-action: manipulation;
      min-height: 40px;
      display: inline-flex;
      align-items: center;
    }

    .filter-chip:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--bg-primary);
    }

    .filter-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* GRID DE TARJETAS */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 18px;
      margin-bottom: 20px;
      min-height: calc(100vh - 300px);
      align-content: start;
    }

    #inventario {
      min-height: calc(100vh - 50px);
    }

    #inventarioContent {
      min-height: calc(100vh - 250px);
    }

    .repuesto-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .repuesto-card:hover {
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      border-color: rgba(91, 139, 180, 0.3);
    }

    .card-image {
      height: 200px;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      border-bottom: 1px solid var(--border-color);
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card-image .no-image {
      font-size: 4rem;
      color: var(--gray-400);
    }

    .card-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.75rem;
      background: rgba(0, 0, 0, 0.7);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      letter-spacing: 0.5px;
    }

    .badge-ok {
      background: rgba(91, 155, 122, 0.95);
      color: #fff;
      border-color: rgba(91, 155, 122, 0.3);
    }

    .badge-bajo {
      background: rgba(184, 146, 90, 0.95);
      color: #fff;
      border-color: rgba(184, 146, 90, 0.3);
    }

    .badge-cero {
      background: rgba(184, 107, 107, 0.95);
      color: #fff;
      border-color: rgba(184, 107, 107, 0.3);
    }

    .card-content {
      padding: 10px 12px;
    }

    .card-content h3 {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-primary);
      background: transparent;
      padding: 0;
      border-left: 3px solid var(--primary);
      padding-left: 8px;
      margin-bottom: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.3;
    }

    .card-content h4 {
      font-size: 0.95rem;
      color: var(--text-primary);
      margin-bottom: 12px;
      font-weight: 500;
    }

    .card-info {
      display: grid;
      gap: 3px;
      margin-bottom: 6px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
      line-height: 1.3;
      margin-bottom: 2px;
      padding: 3px 4px;
      background: transparent;
      border-bottom: 1px solid rgba(91, 139, 180, 0.1);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.65rem;
    }

    .info-value {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .card-footer {
      display: flex;
      gap: 6px;
      padding: 0 12px 10px;
    }

    .card-btn {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      font-size: 0.7rem;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      min-height: 32px;
    }

    .card-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--border-color-light);
      transform: none;
    }

    .btn-edit {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-edit:hover {
      background: var(--primary);
      color: white;
    }

    .btn-delete {
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn-delete:hover {
      background: var(--danger);
      color: white;
    }

    /* Datos Tcnicos - Estilo Corporativo */
    .datos-tecnicos-box {
      background: rgba(91, 139, 180, 0.08);
      border-left: 3px solid var(--primary);
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      margin: 8px 0;
    }

    .datos-tecnicos-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .datos-tecnicos-content {
      font-size: 0.75rem;
      color: var(--text-secondary);
      line-height: 1.5;
      font-family: 'Courier New', monospace;
      white-space: pre-line;
      word-break: break-word;
    }

    /* Contador de Stock - Estilo Corporativo */
    .stock-counter-box {
      background: var(--bg-tertiary);
      padding: 6px 8px;
      border-radius: var(--radius-sm);
      margin-top: 6px;
      border-left: 3px solid currentColor;
    }

    /* Botones de Ubicacin/Mapa - Estilo Corporativo */
    .btn-add-location,
    .btn-view-map {
      flex: 1;
      padding: 6px 10px;
      font-size: 0.75rem;
      font-weight: 500;
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .btn-add-location {
      background: rgba(91, 155, 122, 0.85);
      border: 1px solid rgba(91, 155, 122, 0.3);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .btn-add-location:hover {
      background: rgba(91, 155, 122, 1);
      box-shadow: var(--shadow-sm);
    }

    .btn-view-map {
      background: rgba(91, 139, 180, 0.85);
      border: 1px solid rgba(91, 139, 180, 0.3);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .btn-view-map:hover {
      background: rgba(91, 139, 180, 1);
      box-shadow: var(--shadow-sm);
    }

    /* VISTA LISTA - Compactada con Estilo Corporativo */
    .list-view {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }

    .list-header {
      display: grid;
      grid-template-columns: 50px 0.9fr 1.5fr 160px 220px;
      gap: 6px;
      padding: 6px 10px;
      background: #4A5568;
      font-weight: 700;
      font-size: 0.75rem;
      color: var(--text-primary);
      border-bottom: 2px solid var(--primary);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .list-header-cell {
      display: flex;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      padding: 2px 4px;
      border-radius: 3px;
      transition: all 0.2s;
      position: relative;
    }
    
    .list-header-cell:hover {
      background: rgba(91, 124, 153, 0.3);
      color: #5B7C99;
    }
    
    .list-header-cell.active {
      background: rgba(91, 124, 153, 0.4);
      color: #5B7C99;
    }

    /* Resize handle para columnas */
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      -webkit-user-select: none;
      user-select: none;
      background: transparent;
      z-index: 20;
    }

    .resize-handle:hover {
      background: var(--primary);
      box-shadow: 0 0 4px var(--primary);
    }

    .resize-handle.resizing {
      background: var(--primary);
      box-shadow: 0 0 8px var(--primary);
    }

    .list-header.resizing {
      -webkit-user-select: none;
      user-select: none;
    }

    .list-header.resizing .list-header-cell {
      pointer-events: none;
    }

    .list-header.resizing .resize-handle {
      pointer-events: auto;
    }
    
    .sort-icon {
      font-size: 0.65rem;
      opacity: 0.6;
      transition: all 0.2s;
    }
    
    .list-header-cell.active .sort-icon {
      opacity: 1;
      transform: scale(1.1);
    }

    .list-row {
      display: grid;
      grid-template-columns: 50px 0.9fr 1.5fr 160px 220px;
      gap: 6px;
      padding: 6px 0px 6px 10px;
      border-bottom: 1px solid var(--border-color);
      align-items: center;
      transition: all 0.2s;
      font-size: 0.8rem;
      min-height: 36px;
    }
    
    .list-row > div:last-child,
    .list-row .list-actions {
      justify-self: end !important;
      padding-right: 10px !important;
    }
    
    .list-row > div {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      min-height: 100%;
    }
    
    .list-row .list-actions {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      align-self: stretch !important;
      justify-content: flex-end !important;
      gap: 4px !important;
      padding: 0 !important;
      width: 100% !important;
      margin: 0 !important;
    }
    
    .stock-visual {
      display: flex;
      flex-direction: column;
      gap: 1px;
      width: 100%;
      align-items: stretch !important;
    }
    
    .stock-numbers {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
    }
    
    .stock-bar-container {
      width: 100%;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      border-radius: 2px;
      overflow: hidden;
      position: relative;
    }
    
    .stock-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease, background 0.3s ease;
      box-shadow: 0 0 4px rgba(0,0,0,0.15);
    }

    .list-row:hover {
      background: var(--bg-primary);
    }

    .list-row:last-child {
      border-bottom: none;
    }

    .list-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
      width: 100%;
      align-items: center !important;
    }

    .list-actions button {
      padding: 5px 4px;
      font-size: 0.7rem;
      min-height: 28px;
      width: 100%;
      white-space: nowrap;
    }

    /* PAGINACIN */
    #pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin: 0 auto 16px auto;
      max-width: 100%;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      flex-wrap: wrap;
    }

    #pagination .btn {
      padding: 6px 12px;
      min-width: auto;
      min-height: 32px;
      font-size: 0.8rem;
    }

    #pageNumbers {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    #pageNumbers .btn {
      min-width: 42px;
      padding: 8px 12px;
      transition: all 0.3s ease;
    }

    #itemsPerPageSelect {
      transition: all 0.3s ease;
      font-weight: 500;
    }

    #itemsPerPageSelect:hover {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #itemsPerPageSelect:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }

    #pageNumbers .btn:not(:disabled):hover {
      opacity: 1 !important;
      transform: scale(1.05);
    }

    #pageNumbers .btn:disabled {
      opacity: 1 !important;
      transform: scale(1.1);
      cursor: default;
      font-weight: 700;
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.9);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      z-index: 2000;
  align-items: flex-start;
  justify-content: center;
  overflow-y: auto;
  padding: clamp(10px, 2vh, 28px) clamp(12px, 4vw, 48px);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 0;
      width: fit-content;
      min-width: 1400px;
      max-width: 90vw;
      min-height: fit-content;
      max-height: 88vh;
      box-shadow: 0 26px 60px rgba(0, 0, 0, 0.55);
      position: relative;
      border: 1px solid var(--border-color);
      animation: slideUp 0.25s ease;
      display: flex;
      flex-direction: column;
      margin: clamp(10px, 2vh, 24px) auto clamp(20px, 4vh, 48px);
      overflow: hidden;
      transition: transform 0.3s ease, width 0.3s ease, height 0.3s ease;
    }

    /* Cuando el modal es resizable/draggable */
    .modal-content.is-resizable {
      position: fixed;
      margin: 0;
      width: auto;
      min-width: 1200px;
      max-width: 95vw;
      height: 85vh;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* Estilos para handles de resize */
    .modal-resize-handle {
      position: absolute;
      z-index: 15;
      background: transparent;
      transition: background 0.2s ease, opacity 0.2s ease;
    }

    .modal-resize-handle:hover {
      background: rgba(91, 139, 180, 0.25);
      opacity: 1;
    }

    /* Indicadores visuales en handles de esquina */
    .modal-resize-handle.modal-resize-ne::after,
    .modal-resize-handle.modal-resize-nw::after,
    .modal-resize-handle.modal-resize-se::after,
    .modal-resize-handle.modal-resize-sw::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(91, 139, 180, 0.4);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-resize-handle.modal-resize-ne::after {
      top: 4px;
      right: 4px;
      border-left: none;
      border-bottom: none;
    }

    .modal-resize-handle.modal-resize-nw::after {
      top: 4px;
      left: 4px;
      border-right: none;
      border-bottom: none;
    }

    .modal-resize-handle.modal-resize-se::after {
      bottom: 4px;
      right: 4px;
      border-left: none;
      border-top: none;
    }

    .modal-resize-handle.modal-resize-sw::after {
      bottom: 4px;
      left: 4px;
      border-right: none;
      border-top: none;
    }

    .modal-resize-handle:hover::after {
      opacity: 1;
    }

    /* Líneas indicadoras en handles de bordes */
    .modal-resize-handle.modal-resize-n::before,
    .modal-resize-handle.modal-resize-s::before {
      content: '';
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 3px;
      background: rgba(91, 139, 180, 0.4);
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-resize-handle.modal-resize-n::before {
      top: 2px;
    }

    .modal-resize-handle.modal-resize-s::before {
      bottom: 2px;
    }

    .modal-resize-handle.modal-resize-e::before,
    .modal-resize-handle.modal-resize-w::before {
      content: '';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 30px;
      background: rgba(91, 139, 180, 0.4);
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-resize-handle.modal-resize-e::before {
      right: 2px;
    }

    .modal-resize-handle.modal-resize-w::before {
      left: 2px;
    }

    .modal-resize-handle:hover::before {
      opacity: 1;
    }

    .modal-drag-handle {
      position: absolute;
      z-index: 5;
      cursor: move;
      user-select: none;
      transition: background 0.2s ease;
    }

    .modal-drag-handle:hover {
      background: rgba(91, 139, 180, 0.08);
    }

    .modal-drag-handle:active {
      cursor: grabbing;
      background: rgba(91, 139, 180, 0.15);
    }

    /* Optimizacin de scroll suave */
    .modal-scroll::-webkit-scrollbar {
      width: 8px;
    }
    
    .modal-scroll::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 10px;
    }
    
    .modal-scroll::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }
    
    .modal-scroll::-webkit-scrollbar-thumb:hover {
      background: #4d92e6;
    }

    .wizard-timeline {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px; /* Reducido de 12px */
      margin-bottom: 19px; /* Reducido de 24px */
      padding: 16px 6px 13px; /* Reducido 20% */
      border-bottom: 2px solid var(--border-color);
      background: rgba(16, 23, 33, 0.4);
      border-radius: 10px; /* Reducido de 12px */
      flex-shrink: 0;
    }

    .wizard-step-indicator {
      display: flex;
      align-items: center;
      gap: 10px; /* Reducido de 12px */
      padding: 11px 13px; /* Reducido de 14px 16px */
      border-radius: 11px; /* Reducido de 14px */
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(16, 23, 33, 0.72);
      color: var(--text-secondary);
      cursor: pointer;
      transition: border 0.2s ease, background 0.2s ease, transform 0.2s ease;
    }

    .wizard-step-indicator:hover {
      border-color: rgba(82, 124, 166, 0.6);
      transform: translateY(-1px);
    }

    .wizard-step-indicator.is-active {
      border-color: var(--accent);
      background: rgba(82, 124, 166, 0.2);
      color: var(--text-primary);
    }

    .wizard-step-indicator.is-completed {
      border-color: rgba(91, 155, 122, 0.5);
      background: rgba(91, 155, 122, 0.18);
      color: var(--text-primary);
    }

    .wizard-step-number {
      display: none; /* Ocultar números */
    }

    .wizard-step-indicator.is-active .wizard-step-number {
      background: var(--accent);
    }

    .wizard-step-indicator.is-completed .wizard-step-number {
      background: var(--success);
    }

    .wizard-step-indicator.is-error {
      border-color: var(--danger);
      color: var(--danger);
      box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.15);
    }

    .wizard-step-indicator.is-error .wizard-step-number {
      background: var(--danger);
      color: #fff;
    }

    .wizard-step-indicator.is-disabled {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
    }

    .wizard-step-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .wizard-step-label {
      font-size: 0.74rem; /* Reducido de 0.92rem (20% menos) */
      font-weight: 600;
      color: inherit;
    }

    .wizard-step-helper {
      font-size: 0.60rem; /* Reducido de 0.75rem (20% menos) */
      color: var(--text-muted);
    }

    .wizard-step-container {
      width: 100%;
      flex: 0 1 auto;
      overflow-y: auto;
      padding: 0 4px;
      min-height: 0;
      max-height: calc(92vh - 360px);
    }

    .wizard-step {
      display: none;
      flex-direction: column;
      gap: 14px;
      width: 100%;
      padding: 8px 6px;
    }

    .wizard-step.wizard-step--active {
      display: flex;
    }

    .wizard-step.wizard-step--invalid {
      border-left: 3px solid var(--danger);
      padding-left: 19px;
      margin-left: -3px;
      transition: border-color 0.3s ease, background 0.3s ease;
      background: rgba(220, 38, 38, 0.04);
      animation: wizard-step-pulse 0.48s ease;
    }

    .wizard-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .wizard-actions .btn.is-hidden {
      display: none !important;
    }

    .wizard-actions .btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .wizard-actions__spacer {
      flex: 1 1 auto;
    }

    .wizard-actions .wizard-save-btn {
      display: none;
    }

    .wizard-actions .wizard-save-btn.is-visible {
      display: inline-flex;
    }

    @media (max-width: 1280px) {
      .wizard-timeline {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @keyframes wizard-step-pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.01);
      }
      100% {
        transform: scale(1);
      }
    }

    @media (max-width: 860px) {
      .wizard-timeline {
        grid-template-columns: 1fr;
      }

      .wizard-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .wizard-actions__spacer {
        display: none;
      }

      .wizard-actions .btn {
        width: 100%;
      }
    }

    /* Layout corporativo del modal principal */
    .sap-modal-header {
      padding: 10px 22px 8px 22px;
      background: rgba(21, 27, 36, 0.8);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sap-header-row {
      display: flex;
      align-items: center;
      gap: 12px;
      min-height: 32px;
    }

    .sap-header-leading {
      display: inline-flex;
      align-items: baseline;
      gap: 10px;
      min-width: 0;
    }

    .sap-header-eyebrow {
      font-size: 0.64rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-secondary);
      font-weight: 600;
      white-space: nowrap;
    }

    .sap-header-title {
      font-size: 1.04rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sap-header-subtitle {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin: 0;
      line-height: 1.3;
      opacity: 0.85;
    }

    .sap-header-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-left: auto;
    }

    .sap-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      flex: 0 0 auto;
      white-space: nowrap;
    }

    .sap-meta-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      font-weight: 700;
    }

    .sap-meta-value {
      font-size: 0.74rem;
      color: var(--text-primary);
      font-weight: 600;
    }

    .sap-meta-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--primary-light);
      background: rgba(91, 139, 180, 0.16);
      border: 1px solid rgba(91, 139, 180, 0.22);
      border-radius: 999px;
      padding: 3px 8px;
      line-height: 1;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    .sap-meta-chip--empty {
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .sap-header-meta .version-indicator {
      margin-left: 6px;
      font-size: 0.65rem;
      padding: 5px 10px;
    }

    .sap-modal-form {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .sap-form-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 0;
      flex: 1 1 auto;
      min-height: 0;
      overflow: hidden;
    }

    .modal-scroll {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 28px 32px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      column-gap: 28px;
      row-gap: 24px;
      background: rgba(16, 21, 29, 0.88);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0;
      box-shadow: none;
      max-height: calc(92vh - 280px);
    }

    .sap-empty {
      margin-left: 24px;
      padding: 6px 8px;
      font-size: 11px;
      color: var(--text-secondary);
      font-style: italic;
    }

    .sap-node-leaf .sap-node-content {
      padding-left: 24px;
    }

    .sap-node-spacer {
      display: inline-block;
      width: 16px;
    }

    /* Wizard dentro del grid */
    .modal-scroll .wizard-timeline {
      grid-column: 1 / -1;
      margin-bottom: 0;
    }

    .modal-scroll .wizard-step-container {
      grid-column: 1 / -1;
      display: contents;
    }

    .sap-form-actions {
      padding: 20px 32px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      background: rgba(12, 16, 24, 0.95);
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .sap-form-actions .btn-primary-cta {
      min-width: 260px;
      justify-content: center;
    }

    .sap-form-actions .btn-secondary {
      min-width: 180px;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: var(--radius-md);
    }

    .form-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 20px 24px;
      background: rgba(12, 16, 24, 0.82);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 14px;
      box-shadow: var(--shadow-xs, 0 6px 16px rgba(0, 0, 0, 0.28));
    }

    .form-section--half {
      grid-column: span 1;
      min-width: 760px;
    }

    .form-section--full {
      grid-column: 1 / -1;
      min-width: 900px; /* Ampliar de 760px a 900px para Step 3 */
    }

    /* Layouts internos de las secciones */
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(360px, 1fr));
      gap: 18px;
    }

    .form-row-triple {
      display: grid;
      grid-template-columns: repeat(3, minmax(240px, 1fr));
      gap: 18px;
    }

    .form-stock-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
    }

    .form-section-header {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .form-section-title {
      font-size: 0.86rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .form-section-description {
      font-size: 0.69rem;
      color: var(--text-secondary);
      margin: 0;
      max-width: 640px;
    }

    .form-section--half {
      width: 100%;
    }

    .form-section--full {
      width: 100%;
    }

    .version-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 11px;
      border-radius: 999px;
      font-size: 0.68rem;
      font-weight: 600;
      border: 1px solid transparent;
      background: rgba(91, 139, 180, 0.18);
      color: var(--primary-light);
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .version-indicator::before {
      content: '';
      font-size: 0.8rem;
    }

    .version-indicator-cascada {
      background: rgba(34, 197, 94, 0.16);
      border-color: rgba(34, 197, 94, 0.4);
      color: #4ade80;
    }

    .version-indicator-original {
      background: rgba(59, 130, 246, 0.16);
      border-color: rgba(59, 130, 246, 0.4);
      color: #60a5fa;
    }

    .ubicaciones-section {
      padding: 0;
      border: none;
      background: transparent;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ubicaciones-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .ubicaciones-title {
      margin: 0;
      color: var(--text-primary);
      font-size: 0.86rem;
      font-weight: 600;
    }

    .ubicaciones-subtitle {
      font-size: 0.68rem;
      color: var(--text-secondary);
      margin-top: 3px;
    }

    .ubicaciones-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-agregar-ubicacion {
      padding: 4px 10px;
      font-size: 0.74rem;
      background: rgba(91, 139, 180, 0.18);
      border: 1px solid rgba(91, 139, 180, 0.45);
      color: var(--primary-light);
      box-shadow: none;
    }

    .btn-agregar-ubicacion:hover {
      background: rgba(91, 139, 180, 0.28);
    }

    .ubicaciones-hint {
      background: rgba(91, 139, 180, 0.12);
      padding: 6px 10px;
      border-radius: 6px;
      border-left: 3px solid var(--primary);
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .sap-ubicaciones-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(900px, 1fr));
      gap: 18px;
    }

    .sap-ubicacion-card {
      border: 1px solid var(--border-color);
      border-radius: 0px;
      padding: 12px;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 11px;
      min-height: 100%;
      min-width: 900px;
      background: #1e2229;
    }

    .sap-ubicacion-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .sap-ubicacion-card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .sap-ubicacion-index {
      display: inline-flex;
      width: 26px;
      height: 26px;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(91, 139, 180, 0.22);
      color: var(--primary);
      font-size: 0.7rem;
      font-weight: 600;
    }

    .sap-btn-remove {
      background: transparent !important;
      color: var(--danger);
      border: 1px solid rgba(184, 107, 107, 0.6);
      box-shadow: none;
    }

    .sap-btn-remove:hover {
      background: rgba(184, 107, 107, 0.18) !important;
      color: #fca5a5;
      border-color: rgba(184, 107, 107, 0.75);
    }

    .sap-ubicacion-body {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .sap-field-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .sap-step-label {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 0.74rem;
      color: var(--text-primary);
      font-weight: 500;
      flex-direction: row;
    }

    .sap-step-number {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(91, 139, 180, 0.22);
      color: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.68rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    /* Controles compactos para ubicaciones en wizard */
    .wizard-step[data-step="3"] .form-control {
      padding: 5px 8px;
      font-size: 0.75rem;
      min-height: 32px;
    }

    .wizard-step[data-step="3"] .sap-ubicacion-card {
      max-width: 100%;
    }

    .wizard-step[data-step="3"] .ubicaciones-section {
      margin: 0;
    }

    .sap-step-hint {
      color: var(--text-muted);
      font-size: 0.62rem;
      display: block;
      margin-top: 4px;
    }

    /* ============================================ */
    /* SELECTOR VISUAL DE JERARQUÍA EN MODAL */
    /* ============================================ */
    .ubicaciones-section-visual {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 100%; /* Ampliar a todo el ancho disponible */
    }

    .ubicaciones-visual-header {
      text-align: center;
      padding: 16px;
      background: rgba(91, 139, 180, 0.08);
      border-radius: 6px;
      border-left: 3px solid var(--primary);
    }

    .ubicaciones-visual-title {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 0 0 8px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .ubicaciones-icon {
      font-size: 1.2rem;
    }

    /* Botón agregar área dentro del árbol */
    .tree-actions-internal {
      padding: 12px;
      background: rgba(76, 175, 80, 0.1);
      border: 1px dashed rgba(76, 175, 80, 0.3);
      border-radius: 6px;
      margin-bottom: 12px;
      text-align: center;
    }

    .tree-actions-internal .btn {
      width: 100%;
    }

    .ubicaciones-visual-description {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .ubicaciones-actions-top {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .ubicaciones-actions-top .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .ubicaciones-tree-selector {
      background: #1a1f26;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Estilos del árbol adaptados del Tab Jerarquía */
    .ubicaciones-tree-selector .jerarquia-tree-node {
      margin-bottom: 4px;
    }

    .ubicaciones-tree-selector .jerarquia-node-content {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ubicaciones-tree-selector .jerarquia-node-content:hover {
      background: rgba(91, 139, 180, 0.15);
      border-color: var(--primary);
    }

    .ubicaciones-tree-selector .jerarquia-node-content.is-selected {
      background: linear-gradient(135deg, rgba(91, 139, 180, 0.4), rgba(91, 139, 180, 0.25));
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(91, 139, 180, 0.3), inset 0 0 8px rgba(91, 139, 180, 0.2);
      font-weight: 600;
    }

    .ubicaciones-tree-selector .jerarquia-node-content.is-selected .jerarquia-node-name {
      color: var(--primary);
    }
    
    /* Nodo asignado (ubicación actual del repuesto) */
    .ubicaciones-tree-selector .jerarquia-node-content.is-assigned {
      background: linear-gradient(90deg, rgba(46, 204, 113, 0.2) 0%, rgba(46, 204, 113, 0.08) 100%);
      border-left: 4px solid #2ecc71;
      font-weight: 600;
    }
    
    .ubicaciones-tree-selector .jerarquia-node-content.is-assigned .jerarquia-node-name {
      color: #27ae60;
    }
    
    .ubicaciones-tree-selector .jerarquia-node-content.is-assigned .jerarquia-node-icon {
      filter: hue-rotate(90deg) saturate(1.5);
    }
    
    /* Nodo recién guardado (animación temporal 2s) */
    .jerarquia-node-content.node-just-saved {
      animation: pulseHighlight 2s ease-in-out;
      background: linear-gradient(90deg, rgba(255, 193, 7, 0.3) 0%, rgba(255, 193, 7, 0.1) 100%) !important;
      border-left: 4px solid #ffc107 !important;
      box-shadow: 0 0 12px rgba(255, 193, 7, 0.4) !important;
    }
    
    @keyframes pulseHighlight {
      0%, 100% { 
        box-shadow: 0 0 12px rgba(255, 193, 7, 0.4);
        transform: scale(1);
      }
      25% { 
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
        transform: scale(1.02);
      }
      50% {
        box-shadow: 0 0 16px rgba(255, 193, 7, 0.5);
        transform: scale(1.01);
      }
      75% {
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
        transform: scale(1.02);
      }
    }

    .ubicaciones-tree-selector .jerarquia-node-toggle {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
    }

    .ubicaciones-tree-selector .jerarquia-node-icon {
      font-size: 1rem;
    }

    .ubicaciones-tree-selector .jerarquia-node-name {
      flex: 1;
      font-size: 0.9rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .ubicaciones-tree-selector .jerarquia-node-count {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: rgba(91, 139, 180, 0.15);
      padding: 2px 8px;
      border-radius: 10px;
    }

    .ubicaciones-tree-selector .jerarquia-node-actions {
      display: none;
      gap: 4px;
      margin-left: 8px;
    }

    .ubicaciones-tree-selector .jerarquia-node-content:hover .jerarquia-node-actions {
      display: flex;
    }

    .ubicaciones-tree-selector .node-btn {
      padding: 2px 6px;
      font-size: 0.75rem;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s ease;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
    }

    .ubicaciones-tree-selector .node-btn-add {
      color: var(--success);
      border-color: var(--success);
      background: rgba(76, 175, 80, 0.1);
    }

    .ubicaciones-tree-selector .node-btn-add:hover {
      background: var(--success);
      color: white;
    }

    .ubicaciones-tree-selector .node-btn-edit {
      color: var(--warning);
      border-color: var(--warning);
      background: rgba(255, 193, 7, 0.1);
    }

    .ubicaciones-tree-selector .node-btn-edit:hover {
      background: var(--warning);
      color: white;
    }

    .ubicaciones-tree-selector .node-btn-delete {
      color: var(--danger);
      border-color: var(--danger);
      background: rgba(244, 67, 54, 0.1);
    }

    .ubicaciones-tree-selector .node-btn-delete:hover {
      background: var(--danger);
      color: white;
    }

    .ubicaciones-tree-selector .jerarquia-node-children {
      margin-left: 24px;
      margin-top: 4px;
      border-left: 1px solid rgba(91, 139, 180, 0.2);
      padding-left: 12px;
    }

    /* Panel de asignación de ubicación */
    .ubicaciones-assignment-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }

    .ubicacion-selected-info {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .selected-area-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(91, 139, 180, 0.15), rgba(91, 139, 180, 0.05));
      border: 1px solid rgba(91, 139, 180, 0.3);
      border-radius: 8px;
    }

    .selected-area-icon {
      font-size: 1.8rem;
      flex-shrink: 0;
    }

    .selected-area-details {
      flex: 1;
    }

    .selected-area-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .selected-area-path {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .path-level {
      background: rgba(91, 139, 180, 0.2);
      padding: 4px 10px;
      border-radius: 4px;
      font-weight: 500;
      white-space: nowrap;
    }

    .path-arrow {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .assignment-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .assignment-actions .btn-lg {
      min-width: 250px;
    }
    
    .assignment-actions .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border: 2px solid #27ae60;
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .assignment-actions .btn-success:hover {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }

    .ubicacion-no-selected {
      padding: 20px;
      text-align: center;
    }

    /* Repuestos en ubicación */
    .repuestos-en-ubicacion {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .repuestos-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .repuestos-icon {
      font-size: 1.2rem;
    }

    .repuestos-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .repuestos-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      background: rgba(255, 193, 7, 0.2);
      color: var(--warning);
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0 8px;
    }

    .repuestos-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .repuesto-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255, 193, 7, 0.08);
      border: 1px solid rgba(255, 193, 7, 0.2);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .repuesto-item:hover {
      background: rgba(255, 193, 7, 0.15);
      border-color: rgba(255, 193, 7, 0.4);
    }

    .repuesto-icon {
      font-size: 1.1rem;
      color: var(--warning);
    }

    .repuesto-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .repuesto-nombre {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .repuesto-codigo {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .btn-repuesto-edit {
      padding: 4px 8px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .btn-repuesto-edit:hover {
      background: var(--warning);
      border-color: var(--warning);
    }

    /* ============================================
       UBICACIONES ASIGNADAS - Panel Compacto
       ============================================ */
    .ubicaciones-asignadas-panel {
      margin-bottom: 20px;
      padding: 16px;
      background: rgba(33, 150, 243, 0.08);
      border: 1px solid rgba(33, 150, 243, 0.2);
      border-radius: 8px;
    }

    .ubicaciones-asignadas-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(33, 150, 243, 0.2);
    }

    .ubicaciones-icon {
      font-size: 1.2rem;
    }

    .ubicaciones-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .ubicaciones-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      background: rgba(33, 150, 243, 0.2);
      color: var(--primary);
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0 8px;
      margin-right: auto; /* Empujar el botón a la derecha */
    }

    .ubicaciones-asignadas-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .ubicacion-asignada-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(33, 150, 243, 0.2);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .ubicacion-asignada-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(33, 150, 243, 0.4);
    }

    .ubicacion-path-compact {
      flex: 1;
      font-size: 0.8rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .ubicacion-cantidad-control {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      border-radius: 4px;
    }

    .ubicacion-cantidad-control input[type="number"] {
      width: 50px !important;
      min-width: 50px;
    }

    .ubicacion-path-compact .path-separator {
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .ubicacion-path-compact .path-level {
      background: rgba(33, 150, 243, 0.15);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    .btn-ubicacion-delete {
      padding: 4px 10px;
      background: rgba(231, 76, 60, 0.1);
      border: 1px solid rgba(231, 76, 60, 0.3);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      color: var(--danger);
    }

    .btn-ubicacion-delete:hover {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    /* Chips legacy - mantener para compatibilidad */
    .ubicaciones-selected-chips {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 16px;
    }

    .selected-chips-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .selected-chips-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .selected-chips-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0 8px;
    }

    .selected-chips-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 40px;
    }

    .selected-chips-list:empty::after {
      content: "Ninguna ubicación seleccionada aún";
      color: var(--text-muted);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* Chips mejorados con rama jerárquica completa */
    .ubicacion-chip-enhanced {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .chip-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .chip-badge {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .chip-path-full {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .chip-level {
      background: rgba(91, 139, 180, 0.15);
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 500;
      white-space: nowrap;
    }

    .chip-separator {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }

    .chip-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }

    .chip-enumeration {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .chip-btn:hover:not(:disabled) {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .chip-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .chip-count {
      min-width: 30px;
      text-align: center;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--primary);
    }

    .chip-remove-btn {
      padding: 6px 12px;
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid rgba(244, 67, 54, 0.3);
      border-radius: 4px;
      color: var(--danger);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .chip-remove-btn:hover {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    /* Chips legacy - mantener para compatibilidad */
    .ubicacion-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(91, 139, 180, 0.2);
      border: 1px solid rgba(91, 139, 180, 0.4);
      border-radius: 16px;
      padding: 6px 12px;
      font-size: 0.8rem;
      color: var(--text-primary);
    }

    .ubicacion-chip-path {
      font-weight: 500;
    }

    .ubicacion-chip-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: rgba(184, 107, 107, 0.3);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #fca5a5;
      font-size: 0.85rem;
    }

    .ubicacion-chip-remove:hover {
      background: rgba(184, 107, 107, 0.6);
      color: white;
    }

    .ubicaciones-actions-bottom {
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    /* Botones de guardar en cada step */
    .step-actions-bottom {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .step-actions-bottom .btn-lg {
      min-width: 200px;
      font-size: 1rem;
      padding: 12px 24px;
    }

    @media (max-width: 1320px) {
      .sap-form-grid {
        padding: 0;
      }

      .modal-scroll {
        grid-template-columns: 1fr;
        padding: 20px 22px;
        gap: 18px;
      }

      .form-section,
      .form-section--half,
      .form-section--full {
        grid-column: 1 / -1;
        padding: 16px 18px;
      }

      .form-section {
        gap: 14px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .form-row-triple {
        grid-template-columns: 1fr;
      }

      .form-stock-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 900px) {
      .sap-header-meta {
        flex-direction: column;
        align-items: flex-start;
      }

      .sap-meta-item {
        width: auto;
      }

      .sap-header-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .sap-header-title {
        white-space: normal;
      }

      .modal-scroll {
        padding: 16px;
        gap: 14px;
      }

      .form-section {
        padding: 14px 16px;
        gap: 12px;
      }

      .sap-header-meta .version-indicator {
        margin-left: 0;
      }

      .sap-form-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .sap-form-actions .btn {
        width: 100%;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(184, 107, 107, 0.9);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .modal-close:hover {
      background: var(--danger);
      box-shadow: var(--shadow-sm);
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 20px;
      padding-right: 50px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 12px;
    }

    .form-group {
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 3px;
      font-size: 0.75rem;
    }

    .form-control {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.78rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      font-family: inherit;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
      background: var(--bg-secondary);
    }

    .form-control::placeholder {
      color: var(--text-secondary);
      opacity: 0.55;
    }

    /* ELIMINADO: Ahora se define arriba con mejor especificidad */
    
    /* Layout optimizado para 4 columnas en campos pequeños */
    .form-row-quad {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
    }
    
    /* Contenedor del formulario compactado */
    .modal-form {
      display: grid;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }
    
    /* Seccin de multimedia con altura flexible */
    .multimedia-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .multimedia-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 8px;
      max-height: 240px;
      overflow-y: auto;
      padding: 8px;
      background: var(--bg-primary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    
    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .preview-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .preview-delete:hover {
      background: #d63031;
    }
    
    .preview-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 0.62rem;
      padding: 3px;
      text-align: center;
    }
    
    .multimedia-preview::-webkit-scrollbar {
      width: 6px;
    }
    
    .multimedia-preview::-webkit-scrollbar-thumb {
      background: var(--gray-400);
      border-radius: 3px;
    }

    .autocomplete-container {
      position: relative;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 2px solid var(--primary);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
    }

    .autocomplete-list.active {
      display: block;
    }

    .autocomplete-item {
      padding: 12px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--gray-200);
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background: var(--bg-secondary);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    /* LIGHTBOX */
    .lightbox {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .lightbox.active {
      display: flex;
    }

    .lightbox-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    .lightbox-content img,
    .lightbox-content video {
      max-width: 100%;
      max-height: 90vh;
      border-radius: 8px;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 30px;
      cursor: pointer;
      z-index: 3001;
      transition: all 0.3s;
    }

    .lightbox-close:hover {
      background: #b91c1c;
      transform: rotate(90deg);
    }

    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 20px;
      font-size: 30px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.3s;
      z-index: 3001;
    }

    .lightbox-nav:hover {
      background: rgba(255,255,255,0.4);
    }

    .lightbox-prev {
      left: 20px;
    }

    .lightbox-next {
      right: 20px;
    }

    /* JERARQUA CASCADA - Estilo rbol visual */
    .hierarchy-tree {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hierarchy-level {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-primary);
      border-radius: 10px;
      border-left: 4px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      animation: slideInRight 0.3s ease-out forwards;
      opacity: 0;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(20px);
      }
    }

    /* ========================================
       ESTILO CORPORATIVO BASE - MINIMALISTA
       ======================================== */
    .corp-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: transparent;
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--border-color);
      border-top: none;
      border-right: none;
      border-bottom: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .corp-btn:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
      transform: translateX(3px);
    }

    .corp-btn:active {
      transform: translateX(1px);
    }

    /* Variantes de color para corp-btn - solo borde */
    .corp-btn-primary {
      border-left-color: var(--primary);
    }

    .corp-btn-primary:hover {
      color: var(--primary-light);
    }

    .corp-btn-success {
      border-left-color: var(--success);
    }

    .corp-btn-warning {
      border-left-color: var(--warning);
    }

    .corp-btn-danger {
      border-left-color: var(--danger);
    }

    .corp-btn-secondary {
      border-left-color: var(--gray-600);
      opacity: 0.7;
    }

    .corp-btn-secondary:hover {
      opacity: 1;
    }

    /* Toggle minimalista */
    .toggle-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: transparent;
      border-left: 3px solid var(--gray-600);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0.7;
    }

    .toggle-wrapper:hover {
      opacity: 1;
      transform: translateX(3px);
    }

    .toggle-wrapper.active {
      border-left-color: var(--primary);
      opacity: 1;
    }

    .toggle-track {
      width: 36px;
      height: 18px;
      background: var(--gray-600);
      border-radius: 9px;
      position: relative;
      transition: background 0.3s ease;
    }

    .toggle-wrapper.active .toggle-track {
      background: var(--primary);
    }

    .toggle-thumb {
      width: 14px;
      height: 14px;
      background: var(--text-primary);
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .toggle-wrapper.active .toggle-thumb {
      transform: translateX(18px);
    }

    .toggle-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* ============================================
       ESTILOS GLASSMORPHISM PARA TOOLBAR
       ============================================ */
    
    .glass-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .glass-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15),
                  inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .glass-btn-primary {
      background: rgba(91, 139, 180, 0.3);
      border-color: rgba(91, 139, 180, 0.5);
      color: var(--primary-light);
    }

    .glass-btn-primary:hover {
      background: rgba(91, 139, 180, 0.4);
    }

    /* Toggle de vista glassmorphism */
    .view-toggle {
      display: inline-flex;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 4px;
      gap: 4px;
    }

    .view-toggle-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.3s ease;
    }

    .view-toggle-btn.active {
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
    }

    .view-toggle-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.06);
    }

    /* Estado de conexión glassmorphism */
    .glass-btn.connection {
      position: relative;
      padding: 10px 14px;
    }

    .glass-btn.connection.connected {
      background: rgba(91, 155, 122, 0.25);
      border-color: rgba(91, 155, 122, 0.5);
      color: #7db99a;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(91, 155, 122, 0.2);
    }

    .glass-btn.connection.disconnected {
      background: rgba(184, 107, 107, 0.25);
      border-color: rgba(184, 107, 107, 0.5);
      color: #c88585;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(184, 107, 107, 0.2);
    }

    .glass-btn.connection:hover {
      transform: scale(1.05) translateY(-2px);
    }

    /* Búsqueda glassmorphism */
    .glass-search {
      flex: 1;
      max-width: 250px;
      position: relative;
    }

    .glass-search input {
      width: 100%;
      padding: 10px 18px 10px 40px;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      color: var(--text-primary);
      font-size: 0.85rem;
      transition: all 0.3s ease;
    }

    .glass-search input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .glass-search .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.5;
    }

    /* Botones de acción (limpiar, deshacer, rehacer) */
    .glass-action-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 1.1rem;
      transition: all 0.3s ease;
      margin-left: 8px;
    }

    .glass-action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      transform: scale(1.05);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .glass-action-btn:active {
      transform: scale(0.95);
    }

    /* Controles de zoom glassmorphism */
    .glass-zoom-controls {
      display: inline-flex;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 4px;
      gap: 4px;
      align-items: center;
    }

    .glass-zoom-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .glass-zoom-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .glass-zoom-display {
      padding: 0 12px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      min-width: 50px;
      text-align: center;
    }

    .hierarchy-level:nth-child(1) {
      border-left-color: var(--warning);
      animation-delay: 0.1s;
    }

    .hierarchy-level:nth-child(2) {
      border-left-color: var(--primary);
      margin-left: 24px;
      animation-delay: 0.2s;
    }

    .hierarchy-level:nth-child(3) {
      border-left-color: var(--info);
      margin-left: 48px;
      animation-delay: 0.3s;
    }

    .hierarchy-level:nth-child(4) {
      border-left-color: var(--success);
      margin-left: 72px;
      animation-delay: 0.4s;
    }

    .hierarchy-level:hover {
      background: var(--bg-tertiary);
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    .hierarchy-icon {
      font-size: 1.8rem;
      flex-shrink: 0;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .hierarchy-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hierarchy-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .hierarchy-value {
      font-size: 1.05rem;
      color: var(--text-primary);
      font-weight: 600;
    }

    .hierarchy-connector {
      position: absolute;
      left: -12px;
      top: -8px;
      bottom: -8px;
      width: 2px;
      background: linear-gradient(180deg, transparent 0%, var(--border-color) 20%, var(--border-color) 80%, transparent 100%);
    }

    .hierarchy-level:nth-child(1) .hierarchy-connector {
      display: none;
    }

    /* Botn icono de jerarqua en tarjetas */
    .btn-hierarchy {
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }

    .btn-hierarchy:hover {
      background: var(--primary-dark);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn-hierarchy:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    /* Modal Estadsticas - Responsive */
    @media (max-width: 768px) {
      #modalEstadisticas > div {
        width: 95% !important;
        height: 95vh !important;
        margin: 2.5vh auto !important;
      }
      
      #modalEstadisticas h2 {
        font-size: 1.3rem !important;
      }
      
      #estadisticasContent > div:nth-child(2) {
        grid-template-columns: 1fr !important;
      }
      
      #estadisticasContent > div:nth-child(3) > div {
        grid-template-columns: 1fr !important;
      }
    }

    #modalEstadisticas::-webkit-scrollbar,
    #estadisticasContent::-webkit-scrollbar {
      width: 8px;
    }

    #modalEstadisticas::-webkit-scrollbar-track,
    #estadisticasContent::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    #modalEstadisticas::-webkit-scrollbar-thumb,
    #estadisticasContent::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    #modalEstadisticas::-webkit-scrollbar-thumb:hover,
    #estadisticasContent::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }

    /* Modal Cascada - Estilos */
    #modalCascada::-webkit-scrollbar,
    #cascadaContent::-webkit-scrollbar {
      width: 8px;
    }

    #modalCascada::-webkit-scrollbar-track,
    #cascadaContent::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    #modalCascada::-webkit-scrollbar-thumb,
    #cascadaContent::-webkit-scrollbar-thumb {
      background: #6366f1;
      border-radius: 4px;
    }

    #modalCascada::-webkit-scrollbar-thumb:hover,
    #cascadaContent::-webkit-scrollbar-thumb:hover {
      background: #8b5cf6;
    }

    @media (max-width: 768px) {
      #modalCascada > div {
        width: 95% !important;
        height: 95vh !important;
        margin: 2.5vh auto !important;
      }
      
      #modalCascada h3 {
        font-size: 1rem !important;
      }
    }

    .lightbox-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: 700;
      z-index: 3001;
    }

    /* TOAST NOTIFICATIONS - VERSIN CORPORATIVA MEJORADA */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #334155;
      padding: 18px 24px;
      border-radius: 16px;
      box-shadow: 
        0 20px 60px rgba(0,0,0,0.15),
        0 8px 32px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
      animation: slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 4000;
      font-weight: 600;
      max-width: 420px;
      min-width: 280px;
      word-wrap: break-word;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      backdrop-filter: blur(20px) saturate(180%);
      cursor: pointer;
      overflow: hidden;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    /* Indicador de tipo con lnea lateral */
    .toast::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--toast-accent, #64748b);
      border-radius: 0 2px 2px 0;
    }

    /* Icono del tipo de notificacin */
    .toast::after {
      content: var(--toast-icon, '');
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      opacity: 0.7;
    }

    /* Efectos hover - mantener fijo */
    .toast:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 
        0 25px 80px rgba(0,0,0,0.2),
        0 12px 40px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.9);
      background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
      border-color: rgba(148, 163, 184, 0.4);
    }

    /* Estados por tipo - COLORES CORPORATIVOS SUTILES */
    .toast.toast-success {
      --toast-accent: #059669;
      --toast-icon: '';
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: #065f46;
      border-color: rgba(5, 150, 105, 0.2);
    }

    .toast.toast-success:hover {
      background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
    }

    .toast.toast-error {
      --toast-accent: #dc2626;
      --toast-icon: '';
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      color: #7f1d1d;
      border-color: rgba(220, 38, 38, 0.2);
    }

    .toast.toast-error:hover {
      background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
    }

    .toast.toast-warning {
      --toast-accent: #d97706;
      --toast-icon: '';
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      color: #92400e;
      border-color: rgba(217, 119, 6, 0.2);
    }

    .toast.toast-warning:hover {
      background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%);
    }

    .toast.toast-info {
      --toast-accent: #2563eb;
      --toast-icon: '';
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: #1e40af;
      border-color: rgba(37, 99, 235, 0.2);
    }

    .toast.toast-info:hover {
      background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
    }

    /* TOAST HUB - Ventana emergente consolidada */
    .toast-hub {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 20px;
      box-shadow: 
        0 25px 80px rgba(0,0,0,0.25),
        0 15px 50px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      width: 90vw;
      max-width: 500px;
      max-height: 80vh;
      z-index: 5000;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      backdrop-filter: blur(20px) saturate(180%);
      overflow: hidden;
    }

    .toast-hub.active {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .toast-hub-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toast-hub-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1e293b;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast-hub-counter {
      background: #64748b;
      color: white;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .toast-hub-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #64748b;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .toast-hub-close:hover {
      background: rgba(148, 163, 184, 0.1);
      color: #334155;
    }

    .toast-hub-content {
      padding: 12px;
      max-height: calc(80vh - 80px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast-hub-item {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 16px;
      position: relative;
      transition: all 0.2s;
      cursor: pointer;
    }

    .toast-hub-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border-color: rgba(148, 163, 184, 0.3);
    }

    .toast-hub-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--toast-accent, #64748b);
      border-radius: 0 2px 2px 0;
    }

    .toast-hub-item-content {
      padding-left: 16px;
      padding-right: 32px;
    }

    .toast-hub-item-icon {
      position: absolute;
      right: 12px;
      top: 12px;
      font-size: 1.1rem;
      opacity: 0.7;
    }

    .toast-hub-item-time {
      position: absolute;
      right: 12px;
      bottom: 12px;
      font-size: 0.75rem;
      color: #64748b;
      opacity: 0.8;
    }

    .toast-hub-item-delete {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(220, 38, 38, 0.1);
      color: #dc2626;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 0.8rem;
      opacity: 0;
      transition: all 0.2s;
    }

    .toast-hub-item:hover .toast-hub-item-delete {
      opacity: 1;
    }

    .toast-hub-item-delete:hover {
      background: rgba(220, 38, 38, 0.2);
    }

    /* Overlay para el toast hub */
    .toast-hub-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 4999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .toast-hub-overlay.active {
      opacity: 1;
    }

    /* Botn flotante para abrir el hub - DESACTIVADO (ahora usamos campana) */
    .toast-hub-trigger {
      display: none !important; /* Ocultar completamente el botn flotante */
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: 
        0 10px 30px rgba(59, 130, 246, 0.3),
        0 4px 15px rgba(59, 130, 246, 0.2);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 4001;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .toast-hub-trigger.active {
      display: flex;
    }

    .toast-hub-trigger:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 
        0 15px 40px rgba(59, 130, 246, 0.4),
        0 8px 20px rgba(59, 130, 246, 0.3);
    }

    /*  CAMPANA DE NOTIFICACIONES - MINIMALISTA */
    .notification-bell {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 56px;
      height: 56px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      color: var(--text-secondary);
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
      z-index: 4002;
    }

    .notification-bell:hover {
      transform: scale(1.05);
      color: var(--text-primary);
      box-shadow: var(--shadow-lg);
    }

    /* Contador de notificaciones - minimalista */
    .notification-counter {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--primary);
      color: white;
      border-radius: 10px;
      min-width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      border: 2px solid var(--bg-app);
      box-shadow: var(--shadow-sm);
    }

    /* Panel de notificaciones - limpio y minimalista */
    .notification-panel {
      position: fixed;
      top: 90px;
      right: 20px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      width: 360px;
      max-height: 500px;
      z-index: 4001;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.25s ease;
      display: none;
      overflow: hidden;
    }

    .notification-panel.active {
      opacity: 1;
      transform: translateY(0);
      display: flex;
      flex-direction: column;
    }

    /* Encabezado del panel - minimalista limpio */
    .notification-panel-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
      flex-shrink: 0;
    }

    .notification-panel-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .notification-panel-title span:first-child {
      font-size: 1.1rem;
    }

    .notification-panel-actions {
      display: flex;
      gap: 6px;
    }

    .notification-panel-action {
      background: transparent;
      border: none;
      padding: 4px 10px;
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .notification-panel-action:hover {
      color: var(--text-primary);
    }

    .notification-panel-action:active {
      transform: scale(0.95);
    }

    /* Lista de notificaciones - minimalista */
    .notification-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .notification-list::-webkit-scrollbar {
      width: 4px;
    }

    .notification-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .notification-list::-webkit-scrollbar-thumb {
      background: var(--gray-500);
      border-radius: 2px;
    }

    .notification-list::-webkit-scrollbar-thumb:hover {
      background: var(--gray-600);
    }

    /* Notificación individual - limpio y minimalista */
    .notification-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      margin: 0 10px 6px 10px;
      background: transparent;
      border-left: 3px solid transparent;
      transition: all 0.2s ease;
      position: relative;
      cursor: pointer;
    }

    /* NOTIFICACIÓN NO LEÍDA - simple y limpia */
    .notification-item.unread {
      border-left-color: var(--primary);
    }

    .notification-item.unread:hover {
      background: var(--bg-primary);
      transform: translateX(2px);
    }

    /* NOTIFICACIÓN LEÍDA - muy discreta */
    .notification-item:not(.unread) {
      border-left-color: transparent;
      opacity: 0.5;
    }

    .notification-item:not(.unread):hover {
      opacity: 0.7;
    }

    /* Icono de notificación - más pequeño */
    .notification-item-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
      opacity: 0.7;
    }

    /* Contenido de notificación */
    .notification-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .notification-item-message {
      font-size: 0.85rem;
      color: var(--text-primary);
      font-weight: 400;
      line-height: 1.3;
    }

    .notification-item:not(.unread) .notification-item-message {
      color: var(--text-secondary);
    }

    /* Timestamp minimalista */
    .notification-item-time {
      font-size: 0.65rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 3px;
    }

    /* Badge de estado - pequeño y discreto */
    .notification-status-badge {
      position: absolute;
      top: 10px;
      right: 36px;
      font-size: 0.55rem;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--primary);
      color: white;
      opacity: 0.8;
    }

    .notification-item:not(.unread) .notification-status-badge {
      display: none;
    }

    /* Botón eliminar - minimalista */
    .notification-item-delete {
      opacity: 0;
      background: transparent;
      border: none;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .notification-item:hover .notification-item-delete {
      opacity: 1;
    }

    .notification-item-delete:hover {
      color: var(--danger);
      transform: scale(1.1);
    }

    .notification-item-delete:active {
      transform: scale(0.95);
    }

    /* Estado vacío */
    .notification-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
    }

    .notification-empty-icon {
      font-size: 3rem;
      margin-bottom: 10px;
      opacity: 0.4;
    }

    .toast-hub-trigger-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #dc2626;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
    }

    /* Animaciones mejoradas */
    @keyframes slideInLeft {
      from {
        transform: translateX(-100%) scale(0.8);
        opacity: 0;
      }
      to {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(-50%) scale(0.95);
      }
    }

    .toast.fade-out {
      animation: fadeOut 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* Progreso de tiempo restante */
    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 2px;
      background: var(--toast-accent, #3b82f6);
      border-radius: 0 0 16px 16px;
      transition: width linear;
      opacity: 0.6;
    }

    /* Contador de toasts cuando hay muchos */
    .toast-counter {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--toast-accent, #3b82f6);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      border: 2px solid #1e293b;
      opacity: 0.9;
    }

    /* Responsive - mvil */
    @media (max-width: 768px) {
      .toast {
        left: 12px;
        right: 12px;
        max-width: none;
        min-width: auto;
        border-radius: 12px;
        padding: 16px 20px;
        font-size: 0.9rem;
      }
    }

    /* Animacin de pulso para indicador de hover */
    @keyframes pulse {
      0%, 100% {
        opacity: 0.6;
        transform: scale(1);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    /* Efecto de resplandor sutil en hover prolongado */
    .toast:hover::before {
      box-shadow: 0 0 20px var(--toast-accent);
    }

    /* STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stats-card {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--card-shadow);
      text-align: center;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-left: 4px solid var(--primary);
      position: relative;
      overflow: hidden;
    }

    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        transparent 0%, 
        rgba(59, 130, 246, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.4s;
    }

    .stats-card:hover::before {
      opacity: 1;
    }

    .stats-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: var(--card-shadow-hover), 0 0 25px rgba(59, 130, 246, 0.3);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
      text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
      position: relative;
      z-index: 1;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      z-index: 1;
    }

    /* JERARQUA */
    .tree-container {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }

    .tree-header {
      padding: 16px;
      background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .tree-node {
      margin: 8px 0;
      transition: all 0.3s;
    }

    .tree-item {
      padding: 10px 12px;
      background: #3b4558;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.15s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 400;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      margin-bottom: 4px;
    }

    .tree-item:hover {
      background: #445062;
      transform: none;
    }

    .tree-toggle {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-muted);
      border-radius: 4px;
      font-weight: 700;
      transition: transform 0.3s;
    }

    .tree-toggle.expanded {
      transform: rotate(90deg);
      background: var(--primary);
      color: white;
    }

    .tree-children {
      margin-left: 24px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .tree-children.expanded {
      max-height: 5000px;
    }

    .tree-area .tree-item {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(96, 165, 250, 0.15) 100%);
      color: #60a5fa;
      font-size: 1.05rem;
      border-left: 4px solid var(--primary);
    }

    .tree-equipo .tree-item {
      background: var(--bg-primary);
      color: var(--text-secondary);
      border-left: 3px solid var(--border-color);
    }

    .tree-repuesto .tree-item {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      font-weight: 500;
    }

    /*  RBOL JERRQUICO ESTILO SAP PM - CORPORATIVO */
    
    /* Container principal estilo SAP */
    .sap-tree-container {
      background: linear-gradient(165deg, rgba(32, 36, 44, 0.95) 0%, rgba(25, 28, 35, 0.85) 100%);
      border: 1px solid rgba(128, 142, 162, 0.18);
      border-radius: 6px;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      box-shadow: 0 18px 36px rgba(4, 8, 14, 0.45);
    }

    .sap-tree-node {
      border-bottom: 1px solid rgba(99, 112, 134, 0.16);
      transition: background-color 0.2s ease;
    }

    .sap-tree-node:nth-child(odd) > .sap-tree-item {
      background: linear-gradient(90deg, rgba(41, 47, 57, 0.94) 0%, rgba(35, 41, 51, 0.9) 100%);
    }

    .sap-tree-node:nth-child(even) > .sap-tree-item {
      background: linear-gradient(90deg, rgba(38, 43, 52, 0.92) 0%, rgba(31, 36, 44, 0.9) 100%);
    }

    .sap-tree-item {
      display: flex;
      align-items: center;
      padding: 6px 12px 6px calc(var(--indent, 12px));
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      transition: background-color 0.18s ease, border-color 0.18s ease;
      position: relative;
      background: linear-gradient(90deg, rgba(45, 51, 61, 0.92) 0%, rgba(39, 45, 54, 0.88) 65%, rgba(33, 38, 47, 0.82) 100%);
      border-left: 2px solid transparent;
    }

    .sap-tree-item:hover {
      background: linear-gradient(90deg, rgba(58, 68, 82, 0.95) 0%, rgba(50, 59, 72, 0.9) 100%);
      border-left-color: rgba(99, 177, 217, 0.35);
    }

    .sap-tree-item.selected {
      background: linear-gradient(90deg, rgba(73, 114, 153, 0.28) 0%, rgba(67, 102, 140, 0.24) 100%);
      border-left: 3px solid var(--primary);
      font-weight: 600;
      box-shadow: inset 0 0 0 1px rgba(108, 156, 196, 0.25);
    }

    .sap-tree-item::before {
      content: '';
      position: absolute;
      left: calc(var(--indent, 12px) - 10px);
      top: 0;
      bottom: 50%;
      width: 1px;
      background: rgba(121, 134, 154, 0.28);
    }

    .sap-tree-item::after {
      content: '';
      position: absolute;
      left: calc(var(--indent, 12px) - 10px);
      top: 50%;
      width: 8px;
      height: 1px;
      background: rgba(121, 134, 154, 0.28);
    }

    .sap-tree-node[data-level="0"] .sap-tree-item::before,
    .sap-tree-node[data-level="0"] .sap-tree-item::after {
      display: none;
    }

    .sap-tree-node:last-child > .sap-tree-item::before {
      bottom: 16px;
    }

    .sap-tree-toggle {
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 4px;
      font-size: 11px;
      color: var(--gray-700);
      flex-shrink: 0;
      transition: transform 0.2s ease, color 0.2s ease;
      background: rgba(72, 82, 96, 0.28);
      border-radius: 3px;
    }

    .sap-tree-toggle.expanded {
      transform: rotate(90deg);
      color: var(--primary);
      background: rgba(91, 139, 180, 0.16);
    }

    .sap-tree-toggle.empty {
      opacity: 0;
      pointer-events: none;
    }

    .sap-tree-icon {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 6px;
      font-size: 14px;
      flex-shrink: 0;
      color: rgba(205, 213, 226, 0.78);
    }

    .sap-tree-code {
      font-family: 'Courier New', Courier, monospace;
      font-size: 11px;
      color: rgba(187, 198, 213, 0.9);
      margin-right: 12px;
      min-width: 126px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .sap-tree-label {
      font-size: 12px;
      color: var(--gray-900);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sap-tree-badge {
      background: rgba(86, 109, 130, 0.32);
      border: 1px solid rgba(108, 132, 156, 0.42);
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 11px;
      color: var(--gray-50);
      margin-left: 12px;
      box-shadow: inset 0 1px 0 rgba(136, 162, 188, 0.25);
    }


    /* Hijos colapsados */
    .sap-tree-children {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .sap-tree-children.expanded {
      max-height: 10000px;
    }

    /* Estados de iconos */
    .sap-icon-folder-closed::before { content: ''; }
    .sap-icon-folder-open::before { content: ''; }
    .sap-icon-document::before { content: ''; }
    .sap-icon-equipment::before { content: ''; }
    .sap-icon-component::before { content: ''; }
    
    /*  Clases auxiliares para estilos inline */
    .sap-tree-wrapper {
      margin-top: 20px;
    }
    
    .sap-tree-header-flex {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sap-tree-header-count {
      font-size: 11px;
      color: var(--gray-700); /* Texto secundario */
      font-weight: normal;
    }
    
    .sap-toolbar-separator {
      width: 1px;
      height: 20px;
      background: var(--gray-500); /* Separador corporativo */
      margin: 0 4px;
    }
    
    .sap-tree-scrollable {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .sap-tree-hidden {
      display: none;
    }

    /* Scrollbar corporativo */
    .sap-tree-container::-webkit-scrollbar {
      width: 12px;
    }

    .sap-tree-container::-webkit-scrollbar-track {
      background: var(--gray-200);
    }

    .sap-tree-container::-webkit-scrollbar-thumb {
      background: var(--gray-500);
      border: 2px solid var(--gray-200);
      border-radius: 6px;
    }

    .sap-tree-container::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    /* Header estilo corporativo */
    .sap-tree-header {
      background: linear-gradient(135deg, var(--gray-300) 0%, var(--gray-200) 100%);
      border-bottom: 2px solid var(--primary);
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 700;
      color: var(--gray-900); /* Texto primario */
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Barra de herramientas corporativa */
    .sap-toolbar {
      background: var(--gray-300);
      border-bottom: 1px solid var(--gray-500);
      padding: 6px 8px;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    /* Barra de bsqueda del rbol SAP */
    .sap-search-bar {
      background: var(--bg-secondary);
      padding: 12px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .sap-search-input {
      flex: 1;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .sap-search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
    }

    .sap-search-clear {
      padding: 8px 12px;
      background: var(--secondary);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .sap-search-clear:hover {
      background: var(--danger);
      transform: scale(1.05);
    }

    /* Resaltado de bsqueda */
    .sap-tree-item.search-highlight {
      background: rgba(91, 139, 180, 0.15);
      border-left: 3px solid var(--primary);
    }

    .sap-tree-item.search-highlight .sap-tree-label {
      color: var(--primary-light);
      font-weight: 600;
    }

    .sap-toolbar-btn {
      background: var(--gray-400);
      border: 1px solid var(--gray-500);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      color: var(--gray-800);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .sap-toolbar-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }

    .sap-toolbar-btn:active {
      background: var(--primary-dark);
      transform: scale(0.98);
    }

    .sap-toolbar-btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
      font-weight: 600;
    }

    .sap-toolbar-btn-primary:hover {
      background: var(--primary-light);
    }

    .sap-toolbar-separator {
      width: 1px;
      height: 20px;
      background: var(--gray-500);
      margin: 0 4px;
    }

    /* Indicador de carga */
    .sap-tree-loading {
      padding: 20px;
      text-align: center;
      color: var(--gray-700); /* Texto secundario */
      font-size: 12px;
    }

    /* Indicador vaco */
    .sap-tree-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--gray-600);
      font-size: 12px;
      line-height: 1.6;
    }

    .sap-tree-empty-child {
      padding: 8px 12px;
      margin: 4px 0;
      color: var(--text-muted);
      font-size: 11px;
      font-style: italic;
    }

    /* ============================================================
       NODOS DEL RBOL SAP (JERARQUA CONFIGURABLE)
       ============================================================ */
    .sap-tree {
      padding: 8px;
    }

    .sap-node {
      margin: 4px 0;
      border-left: 2px solid var(--border-color);
      padding-left: 12px;
    }

    .sap-node-level-1 {
      border-left-color: var(--primary);
    }

    .sap-node-level-2 {
      border-left-color: var(--info);
      margin-left: 20px;
    }

    .sap-node-level-3 {
      border-left-color: var(--success);
      margin-left: 40px;
    }

    .sap-node-level-4 {
      border-left-color: var(--warning);
      margin-left: 60px;
    }

    .sap-node-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sap-node-header:hover {
      background: var(--bg-elevated);
      transform: translateX(2px);
    }

    .sap-node-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .sap-node-label {
      flex: 1;
      font-weight: 500;
      color: var(--text-primary);
    }

    .sap-node-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .sap-node-toggle {
      font-size: 0.8rem;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }

    .sap-node-children {
      margin-top: 4px;
      display: block;
    }

    /* ============================================================
       MODAL GESTIN DE JERARQUA
       ============================================================ */
    .jerarquia-manager {
      background: var(--bg-secondary);
      border-radius: 12px;
      overflow: hidden;
      margin: 20px 0;
    }

    .jerarquia-tabs {
      display: flex;
      gap: 4px;
      padding: 8px;
      background: var(--bg-tertiary);
      overflow-x: auto;
      border-bottom: 2px solid var(--border-color);
    }

    .jerarquia-tab {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 100px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .jerarquia-tab:hover {
      background: var(--bg-elevated);
      border-color: var(--primary);
    }

    .jerarquia-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }

    .jerarquia-tab .tab-icon {
      font-size: 1.5rem;
    }

    .jerarquia-tab .tab-label {
      font-size: 0.85rem;
      font-weight: 600;
      line-height: 1.3;
    }

    .jerarquia-tab .tab-label small {
      font-size: 0.7rem;
      opacity: 0.8;
      font-weight: normal;
    }

    .jerarquia-content {
      padding: 20px;
    }

    .jerarquia-level-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-color);
    }

    .jerarquia-level-header h3 {
      font-size: 1.2rem;
      color: var(--primary);
      margin: 0;
    }

    .jerarquia-form {
      background: var(--bg-primary);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid var(--primary);
    }

    .jerarquia-form .form-group {
      margin-bottom: 16px;
    }

    .jerarquia-form .form-group:last-child {
      margin-bottom: 0;
    }

    .jerarquia-form label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .jerarquia-form .form-control {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .jerarquia-form .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .jerarquia-list {
      display: grid;
      gap: 12px;
    }

    .jerarquia-item {
      background: var(--bg-primary);
      padding: 16px;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      transition: all 0.2s ease;
    }

    .jerarquia-item:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
      background: rgba(0, 0, 0, 0.15);
    }

    .jerarquia-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .jerarquia-item-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .jerarquia-item-toggle {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
      line-height: 1;
    }

    .jerarquia-item-toggle:hover {
      background: rgba(52, 152, 219, 0.1);
      transform: scale(1.1);
    }

    .jerarquia-item-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .jerarquia-item-toggle.collapsed:hover {
      transform: rotate(-90deg) scale(1.1);
    }

    .jerarquia-item-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .jerarquia-item-name:hover {
      color: var(--primary);
    }

    .jerarquia-item-content {
      flex: 1;
    }

    .jerarquia-item-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .jerarquia-item-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .jerarquia-item-actions {
      display: flex;
      gap: 8px;
    }

    .jerarquia-item-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .jerarquia-item-btn-edit {
      background: var(--info);
      color: white;
    }

    .jerarquia-item-btn-edit:hover {
      background: var(--info-dark);
      transform: scale(1.05);
    }

    .jerarquia-item-btn-delete {
      background: var(--danger);
      color: white;
    }

    .jerarquia-item-btn-delete:hover {
      background: var(--danger-dark);
      transform: scale(1.05);
    }

    .jerarquia-item-btn-subnivel {
      background: var(--success);
      color: white;
    }

    .jerarquia-item-btn-subnivel:hover {
      background: var(--success-dark);
      transform: scale(1.05);
    }

    .jerarquia-subitems {
      margin-top: 12px;
      margin-left: 32px;
      padding-left: 16px;
      border-left: 3px solid var(--primary);
      display: none;
    }

    .jerarquia-subitems.expanded {
      display: block;
    }

    .jerarquia-subitem {
      background: rgba(52, 152, 219, 0.05);
      padding: 12px;
      border-radius: 6px;
      border: 2px solid rgba(52, 152, 219, 0.2);
      margin-bottom: 8px;
      transition: all 0.2s ease;
    }

    .jerarquia-subitem:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-sm);
      background: rgba(0, 0, 0, 0.1);
    }

    .jerarquia-subitem-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .jerarquia-subitem-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .jerarquia-item.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .jerarquia-item.drag-over {
      border-color: var(--success);
      border-style: dashed;
      background: rgba(46, 204, 113, 0.1);
    }

    /* MAPA */
    .map-container {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: var(--card-shadow);
    }

    .map-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tool-btn {
      padding: 10px 16px;
      border: 2px solid var(--border-color);
      background: var(--bg-primary);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      min-height: 48px;
    }

    .tool-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    #mapCanvas {
      width: 100%;
      height: 100%;
      border: 3px solid var(--border-color);
      border-radius: 16px;
      background: var(--bg-primary);
      cursor: crosshair;
    }

    /* CONTEO */
    .conteo-controls {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .conteo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .conteo-progress {
      width: 100%;
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      margin: 16px 0;
    }

    .conteo-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--success) 0%, #34d399 100%);
      transition: width 0.3s;
      border-radius: 4px;
    }

    .conteo-item {
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 8px;
      margin-bottom: 12px;
      border: 2px solid var(--border-color);
      transition: all 0.3s;
    }

    .conteo-item:hover {
      border-color: var(--primary);
      background: var(--bg-secondary);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
    }

    .conteo-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-300);
      border-radius: 8px;
      font-size: 1.2rem;
      text-align: center;
      font-weight: 700;
      margin-top: 12px;
    }

    /* RESPONSIVE */
    /* Optimizacin para pantallas grandes */
    @media (min-width: 1400px) {
      .container {
        padding: 30px 40px;
      }
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }

      .header-actions {
        justify-content: center;
        flex-wrap: wrap;
      }

      .logo h1 {
        font-size: 1.5rem;
      }

      .logo p {
        font-size: 0.8rem;
      }

      .cards-grid {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 16px;
      }

      .repuesto-card {
        max-width: 100%;
      }

      .card-image {
        height: 220px;
      }

      .stock-badge-new {
        min-width: 120px !important;
        padding: 6px 10px !important;
        font-size: 0.7rem !important;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .list-header,
      .list-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .list-header {
        grid-template-columns: 1fr;
        font-size: 0.8rem;
        padding: 12px;
      }
      
      .list-header-cell {
        padding: 8px;
        justify-content: center;
      }
      
      .list-header-cell:not(:first-child) {
        display: none;
      }

      .list-row {
        grid-template-columns: 1fr;
        padding: 16px 12px;
        gap: 12px;
      }
      
      .list-row > div {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .list-row > div::before {
        content: attr(data-label);
        font-weight: 700;
        color: var(--text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .list-actions {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 8px !important;
        width: 100% !important;
      }
      
      .list-actions::before {
        display: none;
      }
      
      .list-actions button {
        font-size: 0.75rem !important;
        padding: 10px 8px !important;
      }
      
      .stock-visual {
        padding: 8px;
        background: var(--bg-primary);
        border-radius: 6px;
      }

      .toolbar {
        flex-direction: column;
        gap: 12px;
      }

      .search-box {
        width: 100%;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      #pagination {
        flex-wrap: wrap;
        padding: 12px;
        gap: 8px;
        justify-content: center;
      }

      #pagination > div {
        flex-basis: 100%;
        justify-content: center;
        margin-bottom: 8px;
      }

      #itemsPerPageSelect {
        font-size: 0.85rem;
        padding: 6px 10px;
      }

      #pagination .btn {
        min-width: 70px;
        font-size: 0.8rem;
        padding: 8px 12px;
      }

      #pageNumbers .btn {
        min-width: 36px;
        padding: 8px;
        font-size: 0.85rem;
      }

      .nav-tab {
        font-size: 0.85rem;
        padding: 16px 12px;
      }

      .btn {
        min-height: 44px; /* iOS touch target mnimo */
        font-size: 0.9rem;
      }

      .fs-button {
        bottom: 20px;
        right: 20px;
        min-width: 150px;
        padding: 12px 20px;
        font-size: 0.85rem;
      }

      /* Lightbox en mvil */
      .lightbox-close {
        width: 44px;
        height: 44px;
        font-size: 24px;
        top: 10px;
        right: 10px;
      }

      .lightbox-nav {
        width: 50px;
        height: 50px;
        font-size: 28px;
      }

      .lightbox-counter {
        font-size: 0.9rem;
        padding: 8px 16px;
      }

      /* Modal en mvil */
      .modal-content {
        width: 95%;
        max-height: 90vh;
        padding: 20px;
      }
      
      /* Formulario en mvil: 1 columna */
      .form-row,
      .form-row-triple,
      .form-row-quad {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .multimedia-preview {
        max-height: 150px;
      }
    }

    /* ================================================================== */
    /* OPTIMIZACIN PARA PANTALLAS GRANDES - Modal ms compacto */
    /* ================================================================== */
    @media (min-width: 1400px) {
      .modal-content {
        width: clamp(700px, 80vw, 1000px) !important;
        max-width: 1000px !important;
      }
      
      .sap-form-content {
        transform: scale(0.95);
        transform-origin: top center;
      }
      
      .wizard-timeline {
        gap: 8px;
      }
      
      .wizard-step-indicator {
        padding: 8px 12px;
      }
      
      .form-section-header h3 {
        font-size: 1.05rem;
      }
      
      .form-section-description {
        font-size: 0.8rem;
      }
    }

    /* ================================================================== */
    /* OPTIMIZACIN ESPECFICA PARA IPHONE 16 PRO (393x852px) Y SIMILARES */
    /* Pantallas pequeas: max-width 430px (iPhone 16 Pro, 15 Pro, 14 Pro, etc.) */
    /* ================================================================== */
    @media (max-width: 430px) {
      /* Reducir padding global */
      .container {
        padding: 10px 6px !important;
      }

      /* Optimizar header */
      .logo h1 {
        font-size: 1.25rem !important;
        margin-bottom: 2px !important;
      }

      .logo p {
        font-size: 0.7rem !important;
      }

      /* Botones del header ms compactos */
      .header-actions {
        gap: 6px !important;
      }

      .header-actions button,
      .header-actions .btn {
        padding: 8px 10px !important;
        font-size: 0.75rem !important;
        min-width: auto !important;
        min-height: 38px !important;
      }

      /* Cards ultra optimizadas */
      .cards-grid {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
        padding: 6px !important;
      }

      .repuesto-card {
        border-radius: 10px !important;
        box-shadow: var(--shadow-md) !important;
      }

      .card-content {
        padding: 8px !important;
      }

      .card-content h3 {
        font-size: 0.9rem !important;
        line-height: 1.25 !important;
        margin-bottom: 4px !important;
      }

      .card-content h4 {
        font-size: 0.75rem !important;
        margin: 3px 0 !important;
      }

      .card-info {
        font-size: 0.7rem !important;
        gap: 4px !important;
        margin-top: 4px !important;
      }

      .card-image {
        height: 180px !important;
      }

      /* Badges ms compactos */
      .stock-badge-new {
        min-width: 90px !important;
        padding: 4px 6px !important;
        font-size: 0.6rem !important;
      }

      /* Botones de accin ms pequeos */
      .card-actions {
        gap: 4px !important;
        padding: 6px !important;
      }

      .card-actions button {
        padding: 7px 8px !important;
        font-size: 0.7rem !important;
        min-height: 36px !important;
      }

      /* Filtros compactos */
      .filtros-grupo {
        grid-template-columns: 1fr !important;
        gap: 6px !important;
        padding: 8px !important;
      }

      .filtros-grupo select,
      .filtros-grupo input {
        padding: 7px !important;
        font-size: 0.8rem !important;
      }

      /* Modal optimizado para pantalla pequea */
      #modalRepuesto > div {
        width: 98% !important;
        max-width: 98% !important;
        margin: 1% auto !important;
        padding: 12px !important;
        border-radius: 12px !important;
      }

      #modalRepuesto h2 {
        font-size: 1.1rem !important;
        margin-bottom: 12px !important;
      }

      #modalRepuesto .form-group {
        margin-bottom: 10px !important;
      }

      #modalRepuesto .form-group label {
        font-size: 0.8rem !important;
        margin-bottom: 4px !important;
      }

      #modalRepuesto input,
      #modalRepuesto select,
      #modalRepuesto textarea {
        padding: 8px !important;
        font-size: 0.85rem !important;
      }

      #modalRepuesto textarea {
        min-height: 60px !important;
      }

      /* Botones del modal */
      #modalRepuesto button {
        padding: 9px 14px !important;
        font-size: 0.8rem !important;
        min-height: 38px !important;
      }

      /* Lightbox optimizado */
      .lightbox-image {
        max-width: 95vw !important;
        max-height: 65vh !important;
      }

      .lightbox-prev,
      .lightbox-next {
        width: 38px !important;
        height: 38px !important;
        font-size: 1.1rem !important;
      }

      .lightbox-close {
        width: 34px !important;
        height: 34px !important;
        font-size: 1.4rem !important;
        top: 8px !important;
        right: 8px !important;
      }

      .lightbox-counter {
        bottom: 15px !important;
        padding: 6px 12px !important;
        font-size: 0.8rem !important;
      }

      /* Toast ms compacto */
      .toast {
        bottom: 8px !important;
        left: 8px !important;
        right: 8px !important;
        padding: 10px 12px !important;
        font-size: 0.8rem !important;
      }

      /* Preview de imgenes ms pequeo */
      .multimedia-preview {
        max-height: 120px !important;
      }

      .multimedia-preview img {
        max-width: 70px !important;
        max-height: 70px !important;
      }

      /* Botones de foto mvil optimizados */
      #mobile-photo-buttons {
        margin-bottom: 10px !important;
      }

      #mobile-photo-buttons button {
        padding: 9px !important;
        font-size: 0.8rem !important;
        gap: 4px !important;
      }

      /* Toolbar compacto */
      .toolbar {
        padding: 8px !important;
        gap: 8px !important;
      }

      .search-box input {
        padding: 8px !important;
        font-size: 0.85rem !important;
      }

      /* Paginacin ms compacta */
      #pagination {
        padding: 8px !important;
        gap: 6px !important;
      }

      #pagination .btn {
        min-width: 60px !important;
        font-size: 0.75rem !important;
        padding: 6px 10px !important;
        min-height: 36px !important;
      }

      #pageNumbers .btn {
        min-width: 32px !important;
        padding: 6px !important;
        font-size: 0.8rem !important;
      }

      /* Tabs ms compactas */
      .nav-tab {
        font-size: 0.8rem !important;
        padding: 12px 8px !important;
      }

      /* Stats grid en 1 columna */
      .stats-grid {
        grid-template-columns: 1fr !important;
        gap: 8px !important;
      }

      /* Botn flotante ms pequeo */
      .fs-button {
        bottom: 15px !important;
        right: 15px !important;
        min-width: 130px !important;
        padding: 10px 16px !important;
        font-size: 0.8rem !important;
      }
    }

    /* Tabletas y pantallas medianas (769px - 1024px) */
    @media (min-width: 769px) and (max-width: 1024px) {
      .form-row-triple {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .form-row-quad {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Pantallas grandes (> 1400px) - Aprovechar espacio */
    @media (min-width: 1400px) {
      .multimedia-preview {
        max-height: 200px;
      }
    }
    
    /* Pantallas ultra anchas (> 1920px) */
    @media (min-width: 1920px) {
    }

    /* iPhone y pantallas pequeas (< 480px) */
    @media (max-width: 480px) {
      .modal-content {
        min-width: calc(100vw - 20px);
        width: calc(100vw - 20px);
      }
      
      .header {
        padding: 12px;
      }

      .logo h1 {
        font-size: 1.3rem;
      }

      .cards-grid {
        padding: 12px;
        gap: 12px;
      }

      .card-footer {
        flex-wrap: wrap;
        gap: 8px;
      }

      .card-btn {
        flex: 1 1 100%;
        min-width: 100%;
      }

      #pagination .btn {
        min-width: 60px;
        padding: 6px 10px;
        font-size: 0.75rem;
      }

      #pageNumbers .btn {
        min-width: 32px;
        padding: 6px;
      }

      .nav-tab {
        font-size: 0.75rem;
        padding: 14px 8px;
        letter-spacing: 0;
      }
      
      .modal-title {
        font-size: 1.3rem;
      }
      
      .form-control {
        padding: 10px 12px;
        font-size: 0.95rem;
      }

      /*  OCULTAR ELEMENTOS INNECESARIOS EN MVIL */
      .pc-only-config,
      #icloud-config-section,
      .view-btns {
        display: none !important;
      }

      /* Optimizar toolbar mvil */
      .toolbar {
        flex-direction: column;
        gap: 10px;
      }

      .search-box {
        width: 100%;
      }

      /* Lista mvil optimizada */
      .list-view {
        padding: 12px;
      }

      /* Ocultar paginacin en mvil (vista completa sin paginar) */
      #pagination {
        display: none !important;
      }
    }

    /* UTILIDADES */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mt-2 {
      margin-top: 20px;
    }

    .mb-2 {
      margin-bottom: 20px;
    }

    .precio-info {
      transition: opacity 0.3s;
    }

    .precio-info.hidden {
      display: none;
    }

    /* CONTENEDOR FIJO SUPERIOR */
    .sticky-header-container {
      position: sticky;
      top: 0;
      z-index: 1000;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
      background: rgba(10, 13, 21, 0.92);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* INDICADOR DE CONEXIN SUTIL - PEQUEO */
    .connection-indicator {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      padding: 4px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .connection-icon {
      font-size: 0.9rem;
    }

    .connection-text {
      font-weight: 500;
    }

    .connection-indicator.connected {
      border-bottom-color: rgba(16, 185, 129, 0.3);
    }

    .connection-indicator.connected .connection-icon {
      filter: hue-rotate(100deg);
    }

    .connection-indicator.connected .connection-text {
      color: #10b981;
    }

    .connection-indicator.disconnected {
      border-bottom-color: rgba(239, 68, 68, 0.3);
    }

    .connection-indicator.disconnected .connection-icon {
      animation: pulse 2s infinite;
    }

    .connection-indicator.disconnected .connection-text {
      color: #ef4444;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    /* ANIMACIONES Y EFECTOS ADICIONALES - MODO OSCURO */
    
    /* Efecto de pulsacin para badges */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.05);
      }
    }

    .badge-cero {
      animation: pulse 2s infinite;
    }

    /* Efecto de gradiente animado para elementos premium */
    @keyframes gradientFlow {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    .header {
      background: linear-gradient(135deg, 
        #1e293b 0%, 
        #0f172a 25%, 
        #1e293b 50%, 
        #0f172a 75%, 
        #1e293b 100%);
      background-size: 200% 200%;
      animation: gradientFlow 15s ease infinite;
    }

    /* Resplandor suave en hover para interactivos */
    .nav-tab:hover,
    .btn:hover,
    .repuesto-card:hover {
      filter: brightness(1.1);
    }

    /* Transicin suave para todos los elementos */
    * {
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Efecto de reveal para cards */
    @keyframes cardReveal {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .repuesto-card {
      animation: cardReveal 0.4s ease forwards;
    }

    .repuesto-card:nth-child(1) { animation-delay: 0.05s; }
    .repuesto-card:nth-child(2) { animation-delay: 0.1s; }
    .repuesto-card:nth-child(3) { animation-delay: 0.15s; }
    .repuesto-card:nth-child(4) { animation-delay: 0.2s; }
    .repuesto-card:nth-child(5) { animation-delay: 0.25s; }
    .repuesto-card:nth-child(6) { animation-delay: 0.3s; }

    /* Efecto de brillo en imgenes al hover */
    .card-image img {
      transition: all 0.4s ease;
    }

    .card-image:hover img {
      transform: scale(1.05);
      filter: brightness(1.1) contrast(1.05);
    }

    /* Scrollbar con gradiente */
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #334155, #475569);
      border-radius: 6px;
      border: 2px solid #0f172a;
      box-shadow: inset 0 0 6px rgba(59, 130, 246, 0.3);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #475569, #64748b);
      box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.5);
    }

    /* Loading spinner mejorado */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(59, 130, 246, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      filter: drop-shadow(0 0 6px var(--primary));
    }

    /* Spinner pequeo para botones */
    .spinner-small {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    /* Efecto nen en ttulos */
    h1, h2 {
      text-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }

    /* Badge mejorado con efecto glow */
    .card-badge {
      box-shadow: 0 0 15px currentColor;
      border: 2px solid currentColor;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    /* Info cards con hover mejorado */
    .info-row:hover {
      background: rgba(59, 130, 246, 0.05);
      border-radius: 8px;
      padding: 8px;
      margin: -8px;
      transition: all 0.3s;
    }

    /* Botones con ripple effect */
    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    .btn.ripple::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      animation: ripple 0.6s;
    }

    /* Mejora visual para select y textarea */
    select.form-control,
    textarea.form-control {
      background-image: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    }

    /* Efecto de enfoque en navegacin activa */
    .nav-tab.active {
      animation: tabActivate 0.3s ease;
    }

    @keyframes tabActivate {
      0% {
        transform: scale(0.95);
      }
      50% {
        transform: scale(1.02);
      }
      100% {
        transform: scale(1);
      }
    }

    /* Efecto de partculas en el fondo (sutil) */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(59, 130, 246, 0.02) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    /* Mejora de contraste para accesibilidad */
    .btn:focus-visible,
    .form-control:focus-visible,
    .nav-tab:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    /* Estilos para el modal de conteo individual */
    .modal-backdrop-custom {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      -webkit-backdrop-filter: blur(5px);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    .modal-dialog-custom {
      animation: slideUpModal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-content-custom {
      background: #1e293b;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      border: 1px solid #334155;
    }

    .modal-header-custom {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header-custom h3 {
      margin: 0;
      font-size: 1.3em;
      font-weight: 600;
    }

    .modal-header-custom .close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      line-height: 1;
    }

    .modal-header-custom .close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .modal-body-custom {
      padding: 25px;
    }

    .modal-footer-custom {
      padding: 20px 25px;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes slideUpModal {
      from {
        transform: translateY(50px) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* Estilos responsive para el modal de conteo */
    @media (max-width: 600px) {
      .modal-dialog-custom {
        margin: 10px;
        max-width: calc(100% - 20px) !important;
      }

      .modal-body-custom {
        padding: 20px 15px;
      }

      .modal-footer-custom {
        padding: 15px;
      }
    }

    /* ======================================== */
    /* OKR VISUAL MANAGER */
    /* ======================================== */
    .okr-wrapper {
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding: 6px 0 32px;
    }

    .okr-hero {
      display: flex;
      gap: 24px;
      align-items: stretch;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 18px;
      padding: 28px;
      box-shadow: var(--shadow-md);
      flex-wrap: wrap;
    }

    .okr-hero-text {
      flex: 1 1 320px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .okr-hero-text h2 {
      font-size: 1.9rem;
      line-height: 1.3;
      color: var(--primary-light);
    }

    .okr-hero-text p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .okr-hero-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .okr-upload-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      border-radius: 12px;
      padding: 12px 22px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .okr-upload-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .okr-upload-btn input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .okr-secondary-btn {
      background: rgba(91, 124, 153, 0.12);
      color: var(--primary-light);
      border: 1px solid rgba(91, 124, 153, 0.35);
      border-radius: 10px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .okr-secondary-btn:hover {
      background: rgba(91, 124, 153, 0.2);
      color: var(--text-primary);
    }

    .okr-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .okr-dropzone {
      flex: 0 1 280px;
      border: 2px dashed rgba(122, 154, 184, 0.5);
      border-radius: 16px;
      background: rgba(45, 55, 72, 0.55);
      color: var(--text-secondary);
      display: grid;
      place-items: center;
      padding: 24px;
      text-align: center;
      gap: 8px;
      transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
    }

    .okr-dropzone:hover {
      border-color: var(--primary-light);
      background: rgba(74, 98, 120, 0.6);
      transform: translateY(-2px);
    }

    .okr-dropzone.is-dragover {
      border-color: var(--success);
      background: rgba(107, 142, 127, 0.25);
      color: var(--text-primary);
    }

    .okr-dropzone-icon {
      font-size: 2.4rem;
      line-height: 1;
    }

    .okr-summary {
      display: none;
    }

    .okr-summary.is-visible {
      display: block;
    }

    .okr-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .okr-summary-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .okr-summary-label {
      color: var(--text-muted);
      font-size: 0.85rem;
      letter-spacing: 0.02em;
    }

    .okr-summary-value {
      font-size: 1.9rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.01em;
    }

    .okr-summary-sub {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .okr-filters {
      display: none;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 18px;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      box-shadow: var(--shadow-sm);
    }

    .okr-filters.is-active {
      display: grid;
    }

    .okr-filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .okr-filter-group label {
      font-size: 0.78rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .okr-filter-group select,
    .okr-filter-group input[type="search"] {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .okr-filter-group select:focus,
    .okr-filter-group input[type="search"]:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 2px rgba(91, 124, 153, 0.2);
    }

    .okr-filter-actions {
      align-items: flex-end;
      justify-content: flex-end;
    }

    .okr-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: flex-start;
    }

    .okr-objectives-column {
      flex: 1 1 55%;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .okr-objectives-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .okr-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .okr-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(91, 124, 153, 0.22), transparent 55%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .okr-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }

    .okr-card:hover::after {
      opacity: 1;
    }

    .okr-card-header {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .okr-card-title h3 {
      font-size: 1.15rem;
      color: var(--text-primary);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .okr-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.8rem;
    }

    .okr-progress-ring {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: conic-gradient(var(--progress-color, var(--primary-light)) calc(var(--progress, 0) * 1deg), rgba(255, 255, 255, 0.08) 0deg);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: var(--text-primary);
      position: relative;
    }

    .okr-progress-ring::before {
      content: '';
      position: absolute;
      inset: 8px;
      background: var(--bg-secondary);
      border-radius: 50%;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.07);
    }

    .okr-progress-ring span {
      position: relative;
      font-size: 1rem;
      letter-spacing: 0.03em;
    }

    .okr-card-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .okr-card-notes {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .okr-metadata-line {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .okr-meta-item {
      background: rgba(91, 124, 153, 0.18);
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid rgba(91, 124, 153, 0.25);
    }

    .okr-kr-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .okr-kr-card {
      background: var(--bg-primary);
      border: 1px solid rgba(91, 124, 153, 0.25);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .okr-kr-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .okr-kr-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.92rem;
      line-height: 1.4;
    }

    .okr-kr-progress {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .okr-kr-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .okr-kr-footer {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .okr-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      background: rgba(91, 124, 153, 0.18);
      color: var(--text-secondary);
      border: 1px solid rgba(91, 124, 153, 0.25);
    }

    .okr-chip.muted {
      background: rgba(45, 55, 72, 0.6);
      color: var(--text-secondary);
      border-color: rgba(148, 163, 184, 0.18);
    }

    .okr-chip.tag {
      background: rgba(91, 124, 153, 0.12);
      color: var(--primary-light);
    }

    .okr-chip.mini {
      padding: 3px 8px;
      font-size: 0.7rem;
    }

    .okr-chip.status-on_track,
    .okr-chip.status.status-on_track {
      background: rgba(107, 142, 127, 0.2);
      border-color: rgba(107, 142, 127, 0.4);
      color: var(--success);
    }

    .okr-chip.status-at_risk,
    .okr-chip.status.status-at_risk {
      background: rgba(212, 151, 108, 0.18);
      border-color: rgba(212, 151, 108, 0.35);
      color: var(--warning);
    }

    .okr-chip.status-off_track,
    .okr-chip.status.status-off_track {
      background: rgba(199, 107, 107, 0.18);
      border-color: rgba(199, 107, 107, 0.35);
      color: var(--danger);
    }

    .okr-chip.status-completed,
    .okr-chip.status.status-completed {
      background: rgba(91, 124, 153, 0.2);
      border-color: rgba(91, 124, 153, 0.4);
      color: var(--primary-light);
    }

    .okr-chip.status-not_started,
    .okr-chip.status.status-not_started {
      background: rgba(113, 128, 150, 0.18);
      border-color: rgba(113, 128, 150, 0.3);
      color: var(--text-secondary);
    }

    .okr-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .okr-insights-column {
      flex: 1 1 300px;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .okr-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .okr-panel-header {
      padding: 16px 20px;
      font-weight: 600;
      letter-spacing: 0.03em;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      background: rgba(74, 98, 120, 0.35);
    }

    .okr-panel-body {
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .okr-kr-row,
    .okr-initiative-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px;
      border-radius: 12px;
      background: var(--bg-primary);
      border: 1px solid rgba(91, 124, 153, 0.25);
    }

    .okr-row-top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }

    .okr-row-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.88rem;
      line-height: 1.4;
    }

    .okr-row-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.76rem;
      color: var(--text-secondary);
    }

    .okr-empty,
    .okr-empty-panel {
      text-align: center;
      padding: 40px 24px;
      border-radius: 16px;
      border: 1px dashed rgba(91, 124, 153, 0.3);
      background: rgba(45, 55, 72, 0.6);
      color: var(--text-secondary);
      display: grid;
      gap: 12px;
    }

    .okr-empty h3 {
      font-size: 1.2rem;
      color: var(--primary-light);
    }

    .okr-empty ul {
      list-style: disc;
      margin: 0 auto;
      padding: 0 20px;
      text-align: left;
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: grid;
      gap: 4px;
    }

    .okr-hidden {
      display: none !important;
    }

    @media (max-width: 1024px) {
      .okr-layout {
        flex-direction: column;
      }

      .okr-objectives-column,
      .okr-insights-column {
        flex: 1 1 100%;
      }
    }

    @media (max-width: 720px) {
      .okr-hero {
        padding: 22px;
      }

      .okr-hero-text h2 {
        font-size: 1.6rem;
      }

      .okr-summary-grid {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .okr-objectives-grid {
        grid-template-columns: 1fr;
      }
    }

    /* MAPA - SECCION INTEGRADA */
    .map-shell {
      display: grid;
      grid-template-columns: 450px minmax(0, 1fr); /*  Panel izquierdo: 450px (aumentado para botones completos) */
      gap: 12px;
      align-items: stretch;
      width: 100%;
      height: 100%;
      max-height: 100%;
      padding: 2px;
      box-sizing: border-box;
      margin: 0;
    }

    .map-panel {
      background: var(--bg-secondary);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-md);
      min-height: 500px;
      height: 100%; /*  NUEVO: Tomar altura completa del grid */
      overflow: hidden;
      margin: 0; /*  NUEVO: Sin mrgenes para aprovechar espacio */
    }

    .map-panel-header {
      padding: 6px 10px;
      border-bottom: 1px solid var(--border-color-light);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.12));
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 5px;
      flex-shrink: 0;
    }

    .map-panel-header h2 {
      font-size: 0.9rem;
      margin: 0;
      color: var(--text-primary);
      font-weight: 700;
      line-height: 1.2;
    }

    .map-panel-header p {
      font-size: 0.6rem;
      color: var(--text-secondary);
      margin-top: 1px;
      line-height: 1.2;
    }

    .map-connection {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
    }

    .map-storage-banner {
      display: none; /* Oculto - funcionalidad FileSystem no utilizada */
    }

    .map-storage-status {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Modal de Carga con Barra de Progreso */
    .loading-modal {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top, rgba(102, 126, 234, 0.15), rgba(0, 0, 0, 0.85));
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    body.loading-modal-active {
      overflow: hidden;
    }

    body.loading-modal-active > *:not(.loading-modal) {
      filter: blur(1px) saturate(0.9);
      transition: filter 0.3s ease;
      pointer-events: none;
    }

    .loading-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .loading-modal::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at bottom right, rgba(118, 75, 162, 0.25), transparent 45%);
      animation: modalGlow 6s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes modalGlow {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 0.4; }
    }

    .loading-modal-content {
      background: linear-gradient(145deg, rgba(26, 27, 61, 0.95), rgba(33, 44, 85, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 26px;
      padding: 48px 52px;
      text-align: center;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.45);
      max-width: 480px;
      width: min(90%, 500px);
      position: relative;
      overflow: hidden;
    }

    .loading-modal-content::before {
      content: '';
      position: absolute;
      inset: 10px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      pointer-events: none;
    }

    @keyframes modalSlideIn {
      from {
        transform: scale(0.8) translateY(-30px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .loading-modal-icon {
      font-size: 68px;
      margin-bottom: 24px;
      animation: iconPulse 2.4s ease-in-out infinite;
      filter: drop-shadow(0 8px 18px rgba(0, 0, 0, 0.35));
    }

    @keyframes iconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .loading-modal-title {
      font-size: 30px;
      font-weight: 700;
      color: white;
      margin-bottom: 12px;
      text-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
      letter-spacing: 0.4px;
    }

    .loading-modal-text {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 22px;
    }

    .loading-progress-container {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 50px;
      height: 12px;
      overflow: hidden;
      margin-bottom: 16px;
      box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.35);
      position: relative;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 45%, #a6ffcb 100%);
      border-radius: 50px;
      transition: width 0.25s ease;
      box-shadow: 0 0 20px rgba(79, 172, 254, 0.6);
      position: relative;
      overflow: hidden;
    }

    .loading-progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .loading-progress-text {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .loading-modal-status {
      font-size: 13px;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.7);
      letter-spacing: 2px;
      margin-bottom: 12px;
    }

    .loading-modal-tip {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.75);
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 12px 16px;
      margin-top: 20px;
      line-height: 1.4;
    }

    .map-storage-clean-btn {
      font-size: 0.7rem;
      padding: 6px 10px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
    }

    .map-storage-clean-btn:hover {
      border-color: rgba(59, 130, 246, 0.7);
      color: var(--text-primary);
    }

    .map-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--text-secondary);
    }

    .map-status-badge--off {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(239, 68, 68, 0.4);
      color: rgba(239, 68, 68, 0.9);
    }

    .map-status-badge--on {
      background: rgba(16, 185, 129, 0.12);
      border-color: rgba(16, 185, 129, 0.4);
      color: rgba(16, 185, 129, 0.9);
    }

    .map-panel-scroll {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 6px 8px;
      display: grid;
      gap: 6px;
      min-height: 0;
    }

    .map-section {
      background: var(--bg-primary);
      border-radius: 6px;
      padding: 5px 6px;
      box-shadow: var(--shadow-sm);
    }

    .map-section-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      padding: 0;
      min-height: 28px;
    }

    .map-section-header:hover h3 {
      color: var(--primary-color);
    }

    .map-section-header h3 {
      margin: 0;
      font-size: 0.7rem;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: color 0.2s ease;
      line-height: 1.2;
    }

    .map-section-collapse-icon {
      font-size: 0.7rem;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }

    .map-section--collapsed .map-section-collapse-icon {
      transform: rotate(-90deg);
    }

    .map-section--collapsed .map-card-list {
      display: none;
    }

    .map-card-list {
      display: grid;
      gap: 5px;
      padding: 0;
    }

    .map-card-list.map-hierarchy-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-hierarchy-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-hierarchy-group {
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.6);
      padding: 4px;
    }

    .map-hierarchy-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      cursor: pointer;
      position: relative;
      border-radius: 6px;
      transition: background 0.2s ease;
    }

    .map-hierarchy-header--clickable {
      cursor: pointer;
    }

    .map-hierarchy-header--static {
      cursor: default;
    }

    .map-hierarchy-header--static .map-hierarchy-chevron {
      opacity: 0;
      pointer-events: none;
    }

    .map-hierarchy-header--map {
      cursor: pointer;
    }

    .map-hierarchy-header:hover .map-hierarchy-label {
      color: var(--primary-light);
    }

    .map-hierarchy-header--active {
      background: rgba(59, 130, 246, 0.15);
    }

    .map-hierarchy-header-main {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .map-hierarchy-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .map-hierarchy-path {
      font-size: 0.6rem;
      color: var(--text-secondary);
    }

    .map-hierarchy-count {
      font-size: 0.6rem;
      color: var(--text-secondary);
      font-weight: 600;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .map-hierarchy-actions {
      display: inline-flex;
      gap: 4px;
      margin-right: 4px;
    }

    .map-hierarchy-actions .map-card-btn {
      padding: 2px 6px;
    }

    .map-hierarchy-tooltip {
      position: absolute;
      top: calc(100% + 6px);
      left: 6px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(59, 130, 246, 0.45);
      border-radius: 8px;
      padding: 8px 10px;
      box-shadow: 0 12px 32px rgba(2, 6, 23, 0.55);
      font-size: 0.65rem;
      color: var(--text-primary);
      min-width: 240px;
      max-width: 320px;
      z-index: 20;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-4px);
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    .map-hierarchy-header:hover .map-hierarchy-tooltip,
    .map-hierarchy-leaf:hover .map-hierarchy-tooltip {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .map-hierarchy-tooltip-line {
      display: block;
      margin-bottom: 4px;
      color: var(--text-secondary);
    }

    .map-hierarchy-tooltip-line strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .map-hierarchy-tooltip-line:last-child {
      margin-bottom: 0;
    }

    .map-hierarchy-chevron {
      display: inline-flex;
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      color: var(--text-secondary);
      transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .map-hierarchy-chevron::before {
      content: '\25BC';
    }

    .map-hierarchy-group--collapsed .map-hierarchy-chevron {
      transform: rotate(-90deg);
    }

    .map-hierarchy-body {
      padding: 4px 4px 8px 22px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-hierarchy-leaf-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .map-hierarchy-leaf {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.45);
      cursor: pointer;
      position: relative;
      transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    .map-hierarchy-leaf:hover {
      border-color: rgba(59, 130, 246, 0.6);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(2, 6, 23, 0.45);
    }

    .map-hierarchy-leaf--active {
      border-color: rgba(59, 130, 246, 0.8);
      box-shadow: 0 12px 28px rgba(59, 130, 246, 0.2);
    }

    .map-hierarchy-leaf-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
      flex: 1;
    }

    .map-hierarchy-leaf-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .map-hierarchy-leaf-meta {
      font-size: 0.6rem;
      color: var(--text-secondary);
    }

    .map-hierarchy-leaf-right {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .map-hierarchy-children {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-hierarchy-group--collapsed .map-hierarchy-body {
      display: none;
    }

    .map-hierarchy-cards {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-card {
      border-radius: 5px;
      padding: 5px 6px;
      background: rgba(15, 23, 42, 0.7);
      cursor: pointer;
      display: grid;
      gap: 2px;
      transition: transform 0.2s ease, border 0.2s ease, box-shadow 0.2s ease;
    }

    .map-card:hover {
      transform: translateY(-2px);
      border-color: rgba(59, 130, 246, 0.6);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.45);
    }

    .map-card--active {
      border-color: rgba(59, 130, 246, 0.8);
      box-shadow: 0 10px 24px rgba(59, 130, 246, 0.25);
    }

    .map-card-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.75rem; /*  Reducido de 0.8rem a 0.75rem */
      line-height: 1.2;
    }

    .map-card-path {
      font-size: 0.6rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .map-card-path--empty {
      color: rgba(248, 113, 113, 0.9);
    }

    /*  NUEVO: Contenedor y botones de acciones en tarjetas */
    .map-card-content {
      display: grid;
      gap: 2px; /*  Reducido de 3px a 2px */
      cursor: pointer;
    }

    .map-card-actions {
      display: flex;
      gap: 3px; /*  Reducido de 4px a 3px */
      margin-top: 3px; /*  Reducido de 4px a 3px */
      padding-top: 3px; /*  Reducido de 4px a 3px */
      border-top: 1px solid rgba(148, 163, 184, 0.15);
      justify-content: flex-end;
    }

    .map-card-btn {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 3px; /*  Reducido de 4px a 3px */
      padding: 2px 5px; /*  Reducido de 3px 7px a 2px 5px */
      font-size: 0.7rem; /*  Reducido de 0.75rem a 0.7rem */
      cursor: pointer;
      transition: all 0.2s ease;
      color: #94a3b8;
      line-height: 1.2;
    }

    .map-card-btn:hover {
      background: rgba(59, 130, 246, 0.3);
      border-color: rgba(59, 130, 246, 0.6);
      transform: translateY(-1px);
    }

    .map-card-btn--edit:hover {
      background: rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.5);
    }

    .map-card-btn--delete:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .map-card-btn--link {
      background: transparent;
      border-color: rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    .map-card-btn--link:hover {
      background: rgba(59, 130, 246, 0.15);
      color: var(--text-primary);
    }

    .map-jerarquia-badge {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.8);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 0.75rem;
      line-height: 1.4;
    }

    .map-jerarquia-badge--empty {
      border-style: dashed;
      opacity: 0.85;
    }

    .map-jerarquia-badge strong {
      display: block;
      font-size: 0.8rem;
      color: var(--text-primary);
    }

    .map-jerarquia-badge__path {
      color: var(--text-secondary);
      display: block;
      margin-top: 2px;
      font-weight: 500;
    }

    .map-jerarquia-badge button {
      flex-shrink: 0;
      padding: 6px 10px;
      font-size: 0.7rem;
    }

    .map-jerarquia-badge[data-state='free'] {
      border-color: rgba(94, 234, 212, 0.5);
      background: rgba(15, 118, 110, 0.18);
    }

    .map-jerarquia-badge[data-state='locked'] {
      border-color: rgba(14, 165, 233, 0.5);
      background: rgba(15, 23, 42, 0.8);
    }

    .map-jerarquia-badge[data-state='issue'] {
      border-color: rgba(248, 113, 113, 0.6);
      background: rgba(120, 53, 15, 0.3);
    }

    .map-jerarquia-badge[data-state='conflict'] {
      border-color: rgba(249, 115, 22, 0.8);
      background: rgba(120, 53, 15, 0.4);
    }

    .map-contract-signals {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .map-contract-signals.hidden {
      display: none;
    }

    .map-contract-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.65);
      color: var(--text-secondary);
    }

    .map-contract-chip--free {
      border-color: rgba(45, 212, 191, 0.6);
      color: rgba(94, 234, 212, 0.95);
    }

    .map-contract-chip--locked {
      border-color: rgba(59, 130, 246, 0.6);
      color: rgba(191, 219, 254, 0.95);
    }

    .map-contract-chip--issue {
      border-color: rgba(248, 113, 113, 0.7);
      color: rgba(254, 226, 226, 0.95);
    }

    .map-contract-chip--conflict {
      border-color: rgba(249, 115, 22, 0.8);
      color: rgba(255, 237, 213, 0.95);
    }

    .map-jerarquia-inline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px;
      background: rgba(148, 163, 184, 0.08);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .map-jerarquia-inline-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      flex: 1;
      min-height: 1.5em;
    }

    .map-jerarquia-branch {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-contract-panel {
      margin-top: 10px;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.75);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .map-contract-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    .map-contract-stat {
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-sm);
      padding: 8px;
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .map-contract-stat span {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .map-contract-stat strong {
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .map-contract-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .map-contract-actions small {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .map-contract-issues {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-contract-issue {
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 10px;
      background: rgba(15, 23, 42, 0.65);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-contract-issue h4 {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .map-contract-issue p {
      margin: 0;
      font-size: 0.78rem;
      color: var(--text-secondary);
    }

    .map-contract-issue__meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .map-contract-issue__tag {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-secondary);
      font-weight: 600;
    }

    .map-contract-issue--success {
      border-color: rgba(34, 197, 94, 0.4);
      background: rgba(22, 101, 52, 0.25);
    }

    .map-contract-issue--warning {
      border-color: rgba(251, 191, 36, 0.5);
      background: rgba(120, 53, 15, 0.35);
    }

    .map-contract-issue--error {
      border-color: rgba(248, 113, 113, 0.7);
      background: rgba(127, 29, 29, 0.4);
    }

    .map-contract-issue--info {
      border-color: rgba(14, 165, 233, 0.5);
      background: rgba(8, 47, 73, 0.45);
    }

    .map-contract-issue--empty {
      border-style: dashed;
      opacity: 0.8;
    }

    .map-contract-issue__actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .map-contract-issue__actions .map-btn {
      font-size: 0.7rem;
      padding: 4px 10px;
    }

    .map-jerarquia-branch-node {
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: var(--radius-sm);
      padding: 8px;
      background: rgba(15, 23, 42, 0.6);
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .map-jerarquia-branch-node.is-active {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.12);
    }

    .map-jerarquia-branch-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
    }

    .map-jerarquia-branch-level {
      font-weight: 600;
      color: var(--primary-light);
      font-size: 0.7rem;
      letter-spacing: 0.02em;
    }

    .map-jerarquia-branch-name {
      flex: 1;
      font-weight: 600;
      color: var(--text-primary);
      text-align: right;
    }

    .map-jerarquia-branch-stats {
      display: flex;
      gap: 12px;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .map-jerarquia-branch-stats strong {
      color: var(--text-primary);
      margin-right: 4px;
    }

    .map-jerarquia-branch-empty {
      padding: 10px;
      border: 1px dashed rgba(148, 163, 184, 0.3);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      color: var(--text-secondary);
      background: rgba(15, 23, 42, 0.4);
    }

    .map-jerarquia-modal {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .map-jerarquia-summary {
      padding: 14px 18px;
      border-radius: var(--radius-md);
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(59, 130, 246, 0.25);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .map-jerarquia-summary-text {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .map-jerarquia-selected {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      min-height: 36px;
    }

    .map-jerarquia-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.65);
      font-size: 0.78rem;
      line-height: 1;
      color: var(--text-primary);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.4);
    }

    .map-jerarquia-chip-level {
      font-size: 0.65rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--primary-light);
      opacity: 0.85;
    }

    .map-jerarquia-chip-name {
      font-weight: 600;
      white-space: nowrap;
    }

    .map-jerarquia-chip-arrow {
      display: inline-flex;
      align-items: center;
      color: var(--text-muted);
      font-size: 0.85rem;
      padding: 0 4px;
    }

    .map-jerarquia-chip--empty {
      border-style: dashed;
      color: var(--text-secondary);
    }

    .map-jerarquia-selector {
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.65);
      padding: 16px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .jerarquia-selector-tree-root,
    .jerarquia-selector-children {
      list-style: none;
      margin: 0;
      padding-left: 0;
    }

    .jerarquia-selector-tree-root > .jerarquia-selector-item {
      padding-left: 0;
      margin-left: 0;
      border-left: none;
    }

    .jerarquia-selector-children {
      margin-left: 18px;
      padding-left: 18px;
      border-left: 1px dashed rgba(148, 163, 184, 0.25);
    }

    .jerarquia-selector-item {
      margin: 4px 0;
      position: relative;
    }

    .jerarquia-selector-node {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.5);
      color: var(--text-primary);
      text-align: left;
      transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
      cursor: pointer;
    }

    .jerarquia-selector-node:hover {
      border-color: var(--primary-light);
      background: rgba(59, 130, 246, 0.15);
      transform: translateX(4px);
    }

    .jerarquia-selector-node.is-selected {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.18);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
    }

    .jerarquia-selector-level {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .jerarquia-selector-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .map-area-filter-alert {
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      background: rgba(59, 130, 246, 0.12);
      border: 1px solid rgba(59, 130, 246, 0.3);
      font-size: 0.75rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .map-area-filter-alert button {
      border: none;
      background: transparent;
      color: var(--primary-light);
      cursor: pointer;
      font-size: 0.72rem;
      font-weight: 600;
    }

    .map-area-list {
      display: grid;
      gap: 6px;
      max-height: calc(100vh - 280px);
      overflow-y: auto;
      padding: 0;
    }

    .map-area-item {
      border-radius: 4px;
      padding: 10px 12px;
      background: #3b4558;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      transition: background 0.15s ease;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .map-area-item:hover {
      background: #445062;
    }

    .map-area-item--active {
      background: #4a5568;
    }

    .map-area-content {
      display: flex;
      flex-direction: column;
      gap: 0;
      flex: 1;
      min-width: 0;
    }

    .map-area-title {
      font-weight: 400;
      color: #e2e8f0;
      font-size: 0.8125rem;
      line-height: 1.5;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .map-area-subtitle {
      font-size: 0.75rem;
      color: #94a3b8;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .map-area-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }
    
    .map-area-action-btn {
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #4a5568;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.15s ease;
      font-size: 0.75rem;
      padding: 0;
    }
    
    .map-area-action-btn:hover {
      background: #556277;
    }
    
    .map-area-action-btn--edit {
      color: #fbbf24;
    }
    
    .map-area-action-btn--config {
      color: #cbd5e1;
    }
    
    .map-area-action-btn--delete {
      color: #cbd5e1;
    }

    .map-log-list {
      font-family: "JetBrains Mono", "Courier New", monospace;
      font-size: 0.7rem;
      display: grid;
      gap: 6px;
      max-height: 160px;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 12px;
    }

    .map-log-entry {
      color: rgba(148, 163, 184, 0.9);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .map-log-entry time {
      color: rgba(59, 130, 246, 0.8);
    }

    .map-btn {
      border: none;
      border-radius: 5px; /*  Reducido de 6px a 5px */
      padding: 5px 8px; /*  Reducido de 6px 10px a 5px 8px */
      font-size: 0.65rem; /*  Reducido de 0.7rem a 0.65rem */
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 3px; /*  Reducido de 4px a 3px */
      color: #e2e8f0;
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
      white-space: nowrap;
      min-height: 24px; /*  Reducido de 28px a 24px */
      line-height: 1.2;
    }

    .map-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      background: rgba(37, 50, 73, 0.9);
      border-color: rgba(148, 163, 184, 0.5);
    }

    .map-btn:active {
      transform: translateY(0);
    }

    .map-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .map-btn--primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: 1px solid rgba(59, 130, 246, 0.5);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
    }

    .map-btn--primary:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
    }

    .map-btn--accent {
      background: linear-gradient(135deg, #14b8a6, #0d9488);
      color: white;
      border: 1px solid rgba(20, 184, 166, 0.5);
      box-shadow: 0 2px 8px rgba(20, 184, 166, 0.25);
    }

    .map-btn--accent:hover {
      background: linear-gradient(135deg, #0d9488, #0f766e);
      box-shadow: 0 4px 16px rgba(20, 184, 166, 0.4);
    }

    .map-btn--ghost {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #cbd5e1;
    }

    .map-btn--ghost:hover {
      background: rgba(51, 65, 85, 0.8);
      color: #e2e8f0;
    }

    .map-icon-btn {
      background: rgba(30, 41, 59, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 6px;
      color: #e2e8f0;
      padding: 6px 10px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 36px;
      min-height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .map-icon-btn:hover {
      background: rgba(59, 130, 246, 0.25);
      border-color: rgba(59, 130, 246, 0.5);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .map-icon-btn:active {
      transform: translateY(0);
    }

    /*  Tooltips informativos para botones */
    .map-btn-info {
      position: relative;
    }

    .info-icon {
      font-size: 0.65rem;
      opacity: 0; /*  OCULTO por defecto */
      transition: opacity 0.2s ease;
      margin-left: -4px; /*  Reducir espacio */
    }

    .map-btn-info:hover .info-icon {
      opacity: 0.7; /*  Aparecer al hover */
    }

    .map-btn-info::after {
      content: attr(data-tooltip);
      position: absolute;
      top: calc(100% + 8px); /*  CAMBIO: Tooltip ABAJO del botn */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.98);
      color: #e2e8f0;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 500;
      line-height: 1.5;
      white-space: normal;
      max-width: 280px;
      width: max-content;
      text-align: left;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      z-index: 100000;
    }

    .map-btn-info:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(4px); /*  Hacia abajo */
    }

    .map-btn-info::before {
      content: '';
      position: absolute;
      top: calc(100% + 2px); /*  Flecha ARRIBA del tooltip */
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-bottom-color: rgba(15, 23, 42, 0.98); /*  Flecha apuntando hacia arriba */
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 100001;
    }

    .map-btn-info:hover::before {
      opacity: 1;
      transform: translateX(-50%) translateY(4px); /*  Hacia abajo */
    }

    /* Aplicar tooltips tambin a botones de icono */
    .map-icon-btn.map-btn-info {
      position: relative;
    }

    .map-icon-btn.map-btn-info::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.98);
      color: #e2e8f0;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 500;
      line-height: 1.5;
      white-space: normal;
      max-width: 280px;
      width: max-content;
      text-align: left;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      z-index: 100000;
    }

    .map-icon-btn.map-btn-info:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .map-icon-btn.map-btn-info::before {
      content: '';
      position: absolute;
      bottom: calc(100% + 2px);
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(15, 23, 42, 0.98);
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 100001;
    }

    .map-icon-btn.map-btn-info:hover::before {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .map-workspace {
      background: rgba(15, 23, 42, 0.8);
      border-radius: 12px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: var(--shadow-lg);
      overflow: visible;
      width: 100%;
      height: 100%;
      min-height: 0;
      margin: 0;
      box-sizing: border-box;
    }

    .map-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 8px 10px;
      overflow: visible;
      position: relative;
      flex-shrink: 0;
      z-index: 10;
    }

    .map-toolbar-left,
    .map-toolbar-right {
      display: flex;
      align-items: center;
      gap: 6px;
      overflow: visible;
    }

    .map-toolbar-center {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .map-zoom-badge,
    .map-meta-badge {
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.85);
      color: rgba(226, 232, 240, 0.9);
    }

    .map-canvas-stage {
      position: relative;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.7);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.4);
      flex: 1;
      width: 100%;
      min-height: 0;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      z-index: 1;
    }

    .map-canvas {
      width: 100%;
      height: 100%;
      display: block;
      cursor: crosshair;
    }

    .map-hint {
      position: fixed;
      bottom: 16px;
      left: 16px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 0.75rem;
      color: rgba(226, 232, 240, 0.85);
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .map-hint.hidden {
      opacity: 0;
    }

    /*  NUEVO: Tooltip para reas en hover */
    .map-tooltip {
      position: absolute;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(59, 130, 246, 0.5);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.95);
      pointer-events: none;
      transition: opacity 0.15s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      max-width: 280px;
    }

    /*  NUEVO: Permitir clicks cuando el tooltip est fijado */
    .map-tooltip.pinned {
      pointer-events: auto;
      border-color: rgba(251, 191, 36, 0.6); /* Borde amarillo para indicar fijacin */
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    .map-tooltip.hidden {
      opacity: 0;
      display: none;
    }

    .map-tooltip-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 6px;
      color: #60a5fa;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .map-tooltip-category {
      font-size: 0.75rem;
      color: rgba(226, 232, 240, 0.7);
      margin-bottom: 8px;
      padding: 3px 8px;
      background: rgba(59, 130, 246, 0.15);
      border-radius: 4px;
      display: inline-block;
    }

    .map-tooltip-equipos {
      font-size: 0.75rem;
      color: rgba(226, 232, 240, 0.8);
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    .map-tooltip-equipos strong {
      display: block;
      margin-bottom: 4px;
      color: rgba(226, 232, 240, 0.9);
    }

    /*  NUEVO: Minimap para navegacin rpida */
    .map-minimap-container {
      position: absolute;
      bottom: 16px;
      right: 16px;
      width: 200px;
      height: 140px;
      background: rgba(15, 23, 42, 0.95);
      border: 2px solid rgba(59, 130, 246, 0.4);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
      transition: opacity 0.2s ease;
      z-index: 100;
    }

    .map-minimap-container.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .map-minimap-canvas {
      width: 100%;
      height: 100%;
      display: block;
      cursor: pointer;
    }

    .map-minimap-viewport {
      position: absolute;
      border: 2px solid rgba(251, 191, 36, 0.8);
      background: rgba(251, 191, 36, 0.15);
      pointer-events: none;
      box-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
    }

    .map-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px; /*  Reducido de 16px a 12px */
      padding: 12px 16px; /*  Agregado padding para que sea ms compacto */
      background: rgba(15, 23, 42, 0.5); /*  Fondo sutil */
      border-radius: 10px; /*  Bordes redondeados */
    }

    .map-status-text {
      font-size: 0.75rem; /*  Reducido de 0.8rem a 0.75rem */
      color: var(--text-secondary);
    }

    .map-footer-actions {
      display: flex;
      gap: 10px;
    }

    .map-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.82);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 9999;
    }

    .map-modal.hidden {
      display: none;
    }

    .map-modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      width: min(520px, 96vw);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-xl);
    }

    .map-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .map-modal-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .map-modal-body {
      padding: 20px 24px;
      overflow-y: auto;
      display: grid;
      gap: 16px;
    }

    /* Overlay de carga para mapas pesados */
    .map-loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(5, 8, 20, 0.88);
      -webkit-backdrop-filter: blur(3px);
      backdrop-filter: blur(3px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 9998;
    }

    .map-loading-modal {
      width: min(420px, 92vw);
      background: var(--bg-primary);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 30px 70px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .map-loading-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .map-loading-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
    }

    .map-loading-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .map-loading-status {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .map-loading-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      position: relative;
      overflow: hidden;
    }

    .map-loading-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.2s ease;
    }

    .map-loading-percent {
      font-family: 'JetBrains Mono', 'Consolas', monospace;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
      text-align: right;
    }

    .map-loading-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
    }

    @media (max-width: 1180px) {
      .map-shell {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .map-panel {
        order: 2;
      }

      .map-workspace {
        order: 1;
      }
    }

    /*  Media Query para pantallas medianas - Toolbar con wrap */
    @media (max-width: 900px) {
      .map-toolbar {
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px 12px;
      }

      .map-toolbar-left,
      .map-toolbar-right {
        gap: 4px;
      }

      .btn-toolbar {
        padding: 8px 12px;
        font-size: 13px;
      }
    }

    @media (max-width: 720px) {
      .map-toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .map-toolbar-left,
      .map-toolbar-right {
        justify-content: center;
      }

      .map-panel-header {
        flex-direction: column;
        align-items: stretch;
      }

      .map-connection {
        align-items: flex-start;
      }
    }
    
    /* FIN ESTILOS DEL SISTEMA DE MAPAS */
    
    /* 
        ESTILOS APLICADOS A CONFIGURACIN - MISMO DISEO LIMPIO
        */
    
    .config-card {
      background: #3b4558 !important;
      padding: 16px !important;
      border-radius: 4px !important;
      border: none !important;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
    }
    
    .config-card h3 {
      font-weight: 400 !important;
      font-size: 0.95rem !important;
      color: #e2e8f0 !important;
      margin-bottom: 12px !important;
    }
    
    /*  Estilos para rbol Jerrquico */
    .tree-actions {
      display: none; /* No ocupar espacio cuando est oculto */
    }
    
    .tree-node-header:hover .tree-actions {
      display: flex !important;
      gap: 4px;
    }
    
    .tree-node-expandable:hover > .tree-node-header .tree-actions {
      display: flex !important;
      gap: 4px;
    }
    
    /* Hover para mostrar botones en nodos del rbol (INDIVIDUAL) */
    .tree-node-hover:hover > .tree-actions {
      display: flex !important;
      gap: 4px;
    }
    
    /* Evitar activacin en cadena - solo el hover directo */
    .tree-node-hover .tree-actions {
      display: none;
    }
    
    .tree-toggle {
      font-size: 0.9rem;
      font-weight: 700;
    }
    
    .jerarquia-tree button {
      transition: all 0.2s ease;
    }
    
    .jerarquia-tree button:hover {
      transform: scale(1.05);
      filter: brightness(1.1);
    }
    
    /*  Estilos para Modales Personalizados Centrados */
    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .custom-modal {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 24px;
      min-width: 400px;
      max-width: 500px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .custom-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }
    
    .custom-modal-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 0.95rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin-bottom: 20px;
      font-family: inherit;
    }
    
    .custom-modal-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .custom-modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .custom-modal-btn {
      padding: 8px 20px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    /* ============================================================
       ZOOM CONTROLS HORIZONTAL
       ============================================================ */
    .zoom-controls-horizontal {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 12px;
    }

    /* Botones de zoom - Minimalista */
    .zoom-btn-h {
      padding: 6px 10px;
      background: transparent;
      color: var(--text-muted);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      min-width: 32px;
    }

    .zoom-btn-h:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    #zoomLevel {
      font-weight: 600;
      color: var(--text-secondary);
      min-width: 50px;
      text-align: center;
      font-size: 12px;
    }

    #screenResolution {
      font-size: 10px;
      color: var(--text-muted);
      padding: 0 8px;
      border-left: 1px solid var(--border-color);
    }

    /* ============================================================
       MODAL JERARQUA - OVERRIDES
       ============================================================ */
    #modalJerarquia {
      display: none;
    }

    #modalJerarquia .modal-content {
      width: min(1380px, 96vw);
      max-height: 92vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #jerarquiaForm {
      display: none;
    }

    .modal-actions {
      margin-top: 20px;
    }
    
    .custom-modal-btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .custom-modal-btn-primary:hover {
      background: #5558dd;
      transform: translateY(-1px);
    }
    
    .custom-modal-btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .custom-modal-btn-secondary:hover {
      background: var(--border-color);
    }
    
    .custom-modal-message {
      color: var(--text-primary);
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .jerarquia-toolbar {
      display: grid;
      gap: 18px;
      padding: 16px 20px 0 20px;
    }

    .jerarquia-toolbar-top {
      display: grid;
      grid-template-columns: minmax(240px, 1fr) auto;
      gap: 20px;
      align-items: center;
    }

    .jerarquia-toolbar-text {
      color: var(--text-secondary);
      font-size: 0.92rem;
      line-height: 1.5;
    }

    .jerarquia-toolbar-hint {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .jerarquia-toolbar-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }

    .jerarquia-toolbar-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .jerarquia-stat-pill {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      padding: 10px 14px;
      border-radius: 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      font-size: 0.82rem;
      color: var(--text-secondary);
      min-width: 150px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
    }

    .jerarquia-stat-pill .pill-label {
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .jerarquia-stat-pill strong {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1rem;
    }

    .jerarquia-toolbar-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .jerarquia-toolbar-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }

    .jerarquia-search {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      min-width: 250px;
      transition: border-color 0.2s ease;
    }

    .jerarquia-search:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.15);
    }

    .jerarquia-search-icon {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .jerarquia-search-input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 0.9rem;
      outline: none;
    }

    .jerarquia-search-clear {
      border: none;
      background: none;
      color: var(--text-muted);
      font-size: 1rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s ease;
    }

    .jerarquia-search-clear:hover {
      color: var(--primary);
    }

    .jerarquia-search:not(.has-value) .jerarquia-search-clear {
      opacity: 0;
      pointer-events: none;
    }

    .jerarquia-results {
      padding: 0 20px 10px 20px;
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .jerarquia-results-tag {
      text-transform: uppercase;
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .jerarquia-results-highlight {
      font-weight: 600;
      color: var(--primary);
    }

    .jerarquia-tabs-wrapper {
      padding: 0 20px;
    }

    .jerarquia-tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin: 0;
    }

    .jerarquia-tab {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 14px;
      background: var(--bg-tertiary);
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .jerarquia-tab.active {
      border-color: var(--primary);
      box-shadow: 0 8px 24px rgba(56, 189, 248, 0.15);
    }

    .jerarquia-tab .tab-chevron {
      font-size: 1rem;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }

    .jerarquia-tab.active .tab-chevron {
      transform: rotate(90deg);
      color: var(--primary);
    }

    .jerarquia-content {
      margin-top: 10px;
      border-top: 1px solid var(--border-color);
      padding: 20px;
      background: var(--bg-primary);
      border-radius: 16px 16px 0 0;
    }

/* ================================================================
    MEJORAS VISUALES v6.0 - CSS REFACTORIZADO
   ================================================================ */

/* =================================================================
   REFACTORIZACIN DE ESTILOS INLINE
   Este archivo contiene todas las clases CSS creadas para reemplazar
   los estilos inline del HTML principal
   ================================================================= */

/* ============================================================
   BARRA DE PROGRESO DE BACKUP
   ============================================================ */
#backupProgressBar {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 10000;
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  padding: 8px 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  border-bottom: 2px solid var(--primary);
}

.backup-progress-container {
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: 1400px;
  margin: 0 auto;
}

.backup-progress-loading {
  width: 16px;
  height: 16px;
  border-width: 2px;
}

.backup-progress-content {
  flex: 1;
}

.backup-progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.backup-progress-text {
  color: #fff;
  font-size: 0.85rem;
  font-weight: 600;
}

.backup-progress-percent {
  color: var(--primary);
  font-weight: 700;
  font-size: 0.85rem;
}

.backup-progress-bar-bg {
  background: rgba(0,0,0,0.3);
  height: 6px;
  border-radius: 3px;
  overflow: hidden;
}

.backup-progress-bar-fill {
  background: linear-gradient(90deg, var(--primary), #10b981);
  height: 100%;
  width: 0%;
  transition: width 0.3s ease;
  box-shadow: 0 0 10px var(--primary);
}

/* ============================================================
   TOOLBAR - BOTONES Y CONTROLES
   ============================================================ */
/* CTA principal compartido para flujos de inventario (desktop-first) */
.btn-primary-cta {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 14px 26px;
  min-height: 56px;
  border-radius: var(--radius-lg);
  border: 1px solid rgba(255, 255, 255, 0.14);
  background: linear-gradient(135deg, rgba(91, 139, 180, 0.95) 0%, rgba(43, 93, 140, 0.95) 100%);
  color: #f8fafc;
  font-weight: 700;
  font-size: 0.95rem;
  letter-spacing: 0.2px;
  box-shadow: 0 18px 34px rgba(34, 114, 188, 0.35);
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
  text-transform: none;
  text-decoration: none;
  white-space: nowrap;
}

.btn-primary-cta:hover {
  transform: translateY(-1px);
  box-shadow: 0 22px 42px rgba(34, 114, 188, 0.4);
  filter: brightness(1.05);
}

.btn-primary-cta:active {
  transform: translateY(0);
  box-shadow: 0 12px 28px rgba(21, 74, 121, 0.45);
  filter: brightness(0.98);
}

.btn-primary-cta:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
  filter: none;
}

.btn-primary-cta:focus-visible {
  outline: 2px solid rgba(148, 214, 255, 0.85);
  outline-offset: 2px;
}

.btn-primary-cta .btn-icon {
  font-size: 1.2rem;
  line-height: 1;
}

.btn-primary-cta .btn-text {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn-primary-cta .btn-loading {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.btn-primary-cta .spinner-small {
  width: 18px;
  height: 18px;
}

.btn-add-main {
  margin-right: 12px;
}

.toggle-label-custom {
  margin-right: 16px;
}

.btn-quitar-filtros {
  display: none;
  margin-right: 16px;
  padding: 8px 16px;
  font-size: 0.85rem;
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  border: none;
  color: white;
}

.connection-btn-custom {
  margin-left: 4px;
  padding: 8px 12px;
  cursor: default;
}

.search-box-custom {
  max-width: 350px;
  margin-left: auto;
}

/* ============================================================
   PAGINACIN
   ============================================================ */
.pagination-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.pagination-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

.pagination-select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.9rem;
  min-width: 180px;
}

.pagination-info {
  font-size: 0.85rem;
  color: var(--text-secondary);
  opacity: 0.8;
  font-style: italic;
}

.page-numbers-container {
  display: flex;
  gap: 8px;
  align-items: center;
}

/* ============================================================
   VISTAS - LISTA Y TARJETAS
   ============================================================ */
.list-view-hidden {
  display: none;
}

/* ============================================================
   JERARQUA - TREE HEADER
   ============================================================ */
.tree-header-custom {
  font-size: 0.85rem;
  line-height: 1.6;
}

.tree-header-title {
  color: var(--primary);
}

/* ============================================================
   JERARQUA - BUSCADOR
   ============================================================ */
.jerarquia-search-container {
  padding: 16px;
  background: var(--bg-secondary);
  border-bottom: 2px solid var(--primary-color);
}

.jerarquia-search-wrapper {
  position: relative;
}

.jerarquia-search-input {
  width: 100%;
  padding: 12px 40px 12px 56px;
  font-size: 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  background: var(--bg-primary);
  color: var(--text-primary);
}

.jerarquia-search-clear {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  font-size: 1.2rem;
  color: var(--gray-500);
  cursor: pointer;
  padding: 4px 8px;
}

.jerarquia-search-results {
  margin-top: 8px;
  max-height: 300px;
  overflow-y: auto;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: none;
}

/* ============================================================
   JERARQUA - CONTROLES Y FILTROS
   ============================================================ */
.jerarquia-controls {
  padding: 12px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.toggle-tree-btn {
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.filtros-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  flex-wrap: wrap;
}

.filtros-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

.filtro-select {
  max-width: 200px;
}

.filtro-select-hidden {
  max-width: 180px;
  display: none;
}

.btn-limpiar-filtros {
  padding: 6px 12px;
  font-size: 0.85rem;
  display: none;
}

.jerarquia-counter {
  font-size: 0.85rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

/* ============================================================
   JERARQUA - BREADCRUMB
   ============================================================ */
.filtros-breadcrumb {
  padding: 8px 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-bottom: 1px solid var(--border-color);
  display: none;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  font-size: 0.85rem;
  color: white;
}

.breadcrumb-label {
  font-weight: 600;
}

.breadcrumb-path {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

/* ============================================================
   MAPAS - HEADERS
   ============================================================ */
.map-section-header-custom h3 {
  line-height: 28px;
}

.map-new-btn {
  white-space: nowrap;
}

.map-controls-wrapper {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}

/* ============================================================
   MAPAS - BUSCADOR Y FILTROS
   ============================================================ */
.map-search-container {
  padding: 8px 10px;
  background: var(--bg-secondary);
  border-radius: 6px;
  margin-bottom: 6px;
}

.map-search-input {
  width: 100%;
  padding: 6px 10px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.75rem;
  outline: none;
}

.map-category-filters {
  padding: 6px 10px;
  background: var(--bg-secondary);
  border-radius: 6px;
  margin-bottom: 8px;
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  align-items: center;
}

.map-category-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  font-weight: 600;
}

.map-category-filter-btn {
  padding: 3px 8px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.2s;
}

.map-category-filter-btn[data-category="all"] {
  background: var(--primary);
  color: white;
}

.map-category-filter-btn.active {
  background: var(--primary);
  color: white;
}

/* ============================================================
   UTILIDADES GENERALES
   ============================================================ */
.flex-center {
  display: flex;
  align-items: center;
}

.flex-between {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.gap-sm {
  gap: 6px;
}

.gap-md {
  gap: 12px;
}

.text-small {
  font-size: 0.85rem;
}

.text-tiny {
  font-size: 0.75rem;
}

.mb-sm {
  margin-bottom: 4px;
}

.mr-sm {
  margin-right: 8px;
}

.mr-md {
  margin-right: 16px;
}

/* ============================================================
   SECCIN DE MAPAS - ICONOS Y ELEMENTOS ADICIONALES
   ============================================================ */
.info-icon-small {
  font-size: 0.65rem;
}

.map-selection-badge {
  display: none;
  background: #10b981;
  color: white;
}

.map-btn-batch-hidden {
  display: none;
}

/* ============================================================
   ESTADSTICAS - TAB STATS
   ============================================================ */
.stats-title {
  margin-bottom: 24px;
  color: var(--primary);
}

.stats-details {
  margin-top: 30px;
}

/* ============================================================
   VALORES - TAB VALORES
   ============================================================ */
.valores-title {
  margin-bottom: 24px;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.valores-resumen {
  background: var(--bg-secondary);
  color: var(--text-primary);
  padding: 24px;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
}

.valores-tabs-container {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 8px;
  flex-wrap: wrap;
}

.tab-valores {
  flex: 1;
  min-width: 150px;
  padding: 12px 16px;
  border: none;
  border-radius: 8px 8px 0 0;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.9rem;
  text-align: center;
}

.tab-valores:not(.active) {
  background: var(--bg-primary);
  color: var(--text-secondary);
}

.tab-valores.active {
  background: var(--primary);
  color: white;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
}

/* ============================================================
   CONFIGURACIN - TAB CONFIG
   ============================================================ */
.config-title {
  margin-bottom: 20px;
  color: var(--primary);
}

.config-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 6px;
}

.config-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  padding: 16px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  border-radius: 10px;
  transition: all 0.2s;
  color: white;
  font-weight: 600;
  font-size: 1rem;
}

.config-content-hidden {
  display: none;
  padding-top: 16px;
}

.config-buttons-grid {
  display: grid;
  gap: 10px;
}

.config-btn-full {
  width: 100%;
  padding: 12px;
}

.config-btn-secondary {
  background: var(--secondary);
  color: white;
}

.config-btn-danger {
  background: var(--danger);
  color: white;
}

/* ============================================================
   BACKUP - PANEL DE ESTADO Y ESTRUCTURA
   ============================================================ */
.backup-structure-info {
  margin-bottom: 16px;
  padding: 12px;
  background: rgba(0,0,0,0.15);
  border-radius: 6px;
  font-family: monospace;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.backup-structure-title {
  color: var(--primary);
}

.backup-structure-content {
  margin-left: 8px;
  margin-top: 6px;
  line-height: 1.6;
}

.backup-file-name {
  color: var(--success);
}

.backup-file-hint {
  color: var(--warning);
}

.backup-file-hint-special {
  color: var(--info);
}

.backup-manual-update {
  margin-top: 10px;
  padding: 10px;
  background: rgba(245, 158, 11, 0.1);
  border-left: 3px solid var(--warning);
  border-radius: 4px;
}

.backup-manual-title {
  color: var(--warning);
}

.backup-manual-text {
  line-height: 1.6;
}

.backup-status-panel {
  margin-bottom: 16px;
  padding: 14px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.backup-status-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.backup-status-icon {
  font-size: 1.3rem;
}

.backup-status-content {
  flex: 1;
}

.backup-status-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.9rem;
}

.backup-status-text {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin-top: 2px;
}

.backup-metrics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}

.backup-metric-card {
  background: rgba(0,0,0,0.15);
  padding: 8px;
  border-radius: 6px;
}

.backup-metric-label {
  color: var(--text-secondary);
  font-size: 0.7rem;
  margin-bottom: 3px;
}

.backup-metric-value {
  color: var(--text-primary);
  font-weight: 600;
  font-size: 0.85rem;
}

/* ============================================================
   CONFIGURACIN - SECCIONES DETALLADAS
   ============================================================ */
.config-section-content {
  display: none;
  padding-top: 16px;
}

.config-buttons-container {
  display: grid;
  gap: 10px;
}

.config-btn-mobile {
  width: 100%;
  background: var(--secondary);
  color: white;
  padding: 12px;
}

.config-btn-pdf {
  width: 100%;
  padding: 12px;
  background: var(--danger);
  color: white;
}

.backup-structure {
  margin-bottom: 16px;
  padding: 12px;
  background: rgba(0,0,0,0.15);
  border-radius: 6px;
  font-family: monospace;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.backup-structure-path {
  margin-left: 8px;
  margin-top: 6px;
  line-height: 1.6;
}

.backup-manual-guide {
  margin-top: 10px;
  padding: 10px;
  background: rgba(245, 158, 11, 0.1);
  border-left: 3px solid var(--warning);
  border-radius: 4px;
}

.backup-guide-text {
  line-height: 1.6;
}

.backup-status-panel-container {
  margin-bottom: 16px;
  padding: 14px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.backup-pending-changes {
  display: none;
  margin-top: 10px;
  padding: 8px;
  background: rgba(245, 158, 11, 0.15);
  border-radius: 6px;
  border-left: 3px solid var(--warning);
}

.config-divider {
  border-top: 1px solid var(--border-color);
  padding-top: 10px;
  margin-top: 6px;
}

.config-divider-margin {
  margin-top: 10px;
}

.config-small-text {
  color: var(--text-secondary);
  font-size: 0.75rem;
  display: block;
  margin-bottom: 10px;
}

.config-small-text-line-height {
  line-height: 1.5;
}

.config-btn-warning {
  width: 100%;
  padding: 12px;
  background: var(--warning);
  color: white;
}

.config-btn-info {
  width: 100%;
  padding: 12px;
  background: var(--info);
  color: white;
  margin-top: 8px;
}

.config-btn-gradient {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.config-success-note {
  margin-top: 12px;
  padding: 12px;
  background: rgba(16, 185, 129, 0.1);
  border-radius: 6px;
  border-left: 4px solid var(--success);
}

.config-inline-code {
  background: rgba(0,0,0,0.2);
  padding: 2px 4px;
  border-radius: 3px;
}

/* ============================================================
   JERARQUA CONFIG - SECCIN ESPECIAL
   ============================================================ */
.jerarquia-config-container {
  margin-top: 4px;
  padding: 12px;
  background: var(--bg-secondary);
  border-radius: 8px;
  border: 1px solid var(--border-color);
  max-width: 600px;
}

/* Variante para pestaa Jerarqua (ancho completo) */
.jerarquia-config-container.full-width {
  max-width: 100%;
}

.jerarquia-config-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0;
  cursor: pointer;
  padding: 6px;
  background: rgba(0,0,0,0.1);
  border-radius: 4px;
  -webkit-user-select: none;
  user-select: none;
}

/* Variante sin hover para pestaa Jerarqua */
.jerarquia-config-header.no-hover {
  cursor: default;
  background: var(--bg-secondary);
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 8px;
}

.jerarquia-config-header-content {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Variante con descripcin */
.jerarquia-config-header-content.with-description {
  flex-direction: column;
  align-items: flex-start;
}

.jerarquia-config-title {
  color: var(--primary);
  margin: 0;
  font-size: 1.3rem;
  font-weight: 600;
}

.jerarquia-config-title.large {
  font-size: 1.5rem;
}

.jerarquia-description {
  margin: 8px 0 0 0;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.jerarquia-save-btn {
  padding: 10px 24px;
  font-weight: 600;
  display: none;
}

.jerarquia-save-container {
  text-align: right;
  margin-top: 8px;
}

.jerarquia-tree-container {
  background: var(--bg-primary);
  padding: 12px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  min-height: 400px;
  margin-top: 6px;
}

.visual-v2-wrapper {
  margin-top: 6px;
  border-radius: 10px;
  border: 1px solid rgba(90, 120, 160, 0.3);
  background: linear-gradient(135deg, rgba(21, 25, 33, 0.96), rgba(27, 32, 41, 0.96));
  position: relative;
  min-height: 480px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  overflow: hidden;
}

.visual-v2-wrapper.is-hidden {
  display: none;
}

.visual-v2-shell {
  display: flex;
  flex-direction: column;
  height: 100%;
  color: #eaf2ff;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.visual-v2-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 24px;
  background: rgba(24, 28, 36, 0.9);
  border-bottom: 1px solid rgba(74, 128, 176, 0.3);
  -webkit-backdrop-filter: blur(12px);
  backdrop-filter: blur(12px);
}

.visual-v2-toolbar-left {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
  gap: 16px;
  flex: 1;
}

.visual-v2-heading {
  display: flex;
  align-items: center;
  gap: 14px;
}

.visual-v2-heading-icon {
  font-size: 1.8rem;
  line-height: 1;
  filter: drop-shadow(0 0 8px rgba(91, 139, 180, 0.45));
}

.visual-v2-title {
  margin: 0;
  font-size: 1.3rem;
  letter-spacing: 0.4px;
  color: #8eb6ff;
  text-transform: uppercase;
}

.visual-v2-subtitle {
  margin: 4px 0 0;
  font-size: 0.85rem;
  color: rgba(208, 224, 255, 0.75);
}

.visual-v2-toolbar-actions {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.visual-v2-btn {
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  background: rgba(57, 90, 140, 0.35);
  color: #eaf2ff;
  font-weight: 600;
  font-size: 0.85rem;
  cursor: pointer;
  transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
  min-width: 48px;
}

.visual-v2-btn:hover {
  transform: translateY(-2px);
  background: rgba(82, 122, 186, 0.55);
  box-shadow: 0 8px 18px rgba(82, 122, 186, 0.35);
}

.visual-v2-btn:active {
  transform: translateY(0);
}

.visual-v2-zoom-indicator {
  min-width: 64px;
  text-align: center;
  font-family: 'Fira Code', 'Courier New', monospace;
  font-size: 0.9rem;
  padding: 6px 10px;
  border-radius: 8px;
  background: rgba(33, 39, 55, 0.9);
  border: 1px solid rgba(91, 139, 180, 0.45);
}

.visual-v2-toolbar-divider {
  width: 1px;
  height: 28px;
  background: linear-gradient(180deg, rgba(91, 139, 180, 0) 0%, rgba(91, 139, 180, 0.45) 50%, rgba(91, 139, 180, 0) 100%);
}

.visual-v2-statusbar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  background: rgba(24, 28, 36, 0.65);
  border-bottom: 1px solid rgba(74, 128, 176, 0.25);
  font-size: 0.85rem;
  justify-content: space-between;
  flex-wrap: wrap;
}

.visual-v2-status-label {
  color: rgba(208, 224, 255, 0.65);
}

.visual-v2-status-value {
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(91, 139, 180, 0.18);
  color: #a9c7ff;
  font-weight: 600;
}

.visual-v2-status-group {
  display: flex;
  align-items: center;
  gap: 6px;
}

.visual-v2-search-status {
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(91, 139, 180, 0.12);
  color: #c6dcff;
  font-weight: 600;
  font-size: 0.8rem;
}

.visual-v2-tree-scroll {
  flex: 1;
  overflow: auto;
  padding: 24px 32px 32px;
  position: relative;
}

.visual-v2-tree-container {
  transform-origin: top center;
  transition: transform 0.25s ease;
  min-width: 780px;
  color: #f0f4ff;
}

.visual-v2-tree-container .tree-container {
  padding: 20px;
  width: fit-content;
  min-width: 720px;
  overflow-x: visible;
}

.visual-v2-search-wrapper {
  position: relative;
  flex: 1 1 260px;
  max-width: 540px;
}

.visual-v2-wrapper .jerarquia-search-suggestions {
  z-index: 1500;
}

.visual-v2-tree-container .tree-node {
  position: relative;
  margin: 6px 0;
}

.visual-v2-tree-container .node-content {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  min-width: 320px;
  max-width: fit-content;
  background: linear-gradient(135deg, #536a83 0%, #435a73 100%);
  color: #e8edf3;
  border-radius: 6px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  z-index: 2;
  height: 32px;
}

.visual-v2-tree-container .node-content:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 6px 20px rgba(83, 106, 131, 0.5);
  filter: brightness(1.15);
}

.visual-v2-tree-container .node-content.search-highlight {
  animation: visual-v2-pulse 1.5s ease-in-out infinite;
  box-shadow: 0 0 20px rgba(251, 191, 36, 0.6) !important;
  border: 2px solid #fbbf24 !important;
}

.visual-v2-tree-container .node-content.search-match {
  border: 2px solid #10b981 !important;
}

@keyframes visual-v2-pulse {
  0%,
  100% {
    box-shadow: 0 0 20px rgba(251, 191, 36, 0.6) !important;
  }
  50% {
    box-shadow: 0 0 30px rgba(251, 191, 36, 0.9) !important;
  }
}

.visual-v2-tree-container .node-actions {
  display: none;
  gap: 3px;
  margin-left: auto;
  flex-shrink: 0;
  pointer-events: auto;
  z-index: 10;
  position: relative;
}

.visual-v2-tree-container .node-content:hover .node-actions {
  display: flex;
}

.visual-v2-tree-container .node-actions .node-btn {
  padding: 3px 6px;
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 4px;
  color: #ffffff;
  font-size: 0.7em;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  line-height: 1;
  pointer-events: auto;
  z-index: 10;
  position: relative;
}

.visual-v2-tree-container .node-actions .node-btn:hover {
  background: rgba(255, 255, 255, 0.35);
  transform: scale(1.05);
}

.visual-v2-tree-container .node-btn-add {
  background: rgba(107, 184, 147, 0.4);
  border-color: rgba(107, 184, 147, 0.5);
}

.visual-v2-tree-container .node-btn-add:hover {
  background: rgba(107, 184, 147, 0.65);
  border-color: rgba(107, 184, 147, 0.7);
}

.visual-v2-tree-container .node-btn-edit {
  background: rgba(184, 146, 107, 0.4);
  border-color: rgba(184, 146, 107, 0.5);
}

.visual-v2-tree-container .node-btn-edit:hover {
  background: rgba(184, 146, 107, 0.65);
  border-color: rgba(184, 146, 107, 0.7);
}

.visual-v2-tree-container .node-btn-delete {
  background: rgba(184, 107, 107, 0.4);
  border-color: rgba(184, 107, 107, 0.5);
}

.visual-v2-tree-container .node-btn-delete:hover {
  background: rgba(184, 107, 107, 0.65);
  border-color: rgba(184, 107, 107, 0.7);
}

.visual-v2-tree-container .node-btn-move {
  background: rgba(91, 139, 180, 0.3);
  padding: 2px 5px;
  font-size: 0.8em;
}

.visual-v2-tree-container .node-btn-move:hover {
  background: rgba(91, 139, 180, 0.5);
}

/* === REPUESTOS EN NODOS DEL ÁRBOL === */
.node-repuestos-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 8px 0;
  margin-left: 20px;
  border-left: 2px solid rgba(91, 139, 180, 0.3);
}

.node-repuesto-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: linear-gradient(135deg, rgba(30, 34, 41, 0.6), rgba(30, 34, 41, 0.4));
  border-left: 3px solid rgba(91, 139, 180, 0.5);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
  max-width: 500px;
}

.node-repuesto-item:hover {
  background: linear-gradient(135deg, rgba(91, 139, 180, 0.3), rgba(91, 139, 180, 0.2));
  border-left-color: rgba(91, 139, 180, 0.8);
  transform: translateX(4px);
  box-shadow: 0 2px 8px rgba(91, 139, 180, 0.2);
}

.node-repuesto-item .repuesto-icon {
  font-size: 1rem;
  flex-shrink: 0;
}

.node-repuesto-item .repuesto-nombre {
  flex: 1;
  color: var(--text-primary);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

.node-repuesto-item .repuesto-badges {
  display: flex;
  align-items: center;
  gap: 8px;
}

.node-repuesto-item .repuesto-cantidad {
  font-size: 0.85rem;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: 600;
  white-space: nowrap;
}

.node-repuesto-item .repuesto-cantidad.status-ok {
  background: rgba(46, 204, 113, 0.2);
  color: #2ecc71;
}

.node-repuesto-item .repuesto-cantidad.status-low {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

.instancia-badge-small {
  font-size: 0.75rem;
  padding: 2px 6px;
  background: rgba(91, 139, 180, 0.3);
  color: #5b8bb4;
  border-radius: 8px;
  font-weight: 600;
}

.instancia-badge-small-gray {
  font-size: 0.75rem;
  padding: 2px 6px;
  background: rgba(128, 128, 128, 0.2);
  color: #888;
  border-radius: 8px;
  font-weight: 500;
}

.instancia-badge-correlativo {
  font-size: 0.75rem;
  padding: 2px 7px;
  background: rgba(34, 34, 34, 0.9);
  color: #ffffff;
  border-radius: 10px;
  font-weight: 700;
  font-family: monospace;
  margin-left: 4px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.marcador-badge {
  font-size: 0.9rem;
  opacity: 1;
  transition: transform 0.2s ease;
}

.marcador-badge-empty {
  font-size: 0.9rem;
  opacity: 0.3;
}

.node-repuesto-item:hover .marcador-badge {
  transform: scale(1.2);
}

/* Estilos para lista de repuestos en modal */
.repuesto-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: rgba(30, 34, 41, 0.4);
  border-radius: 6px;
  margin-bottom: 6px;
  transition: all 0.2s ease;
}

.repuesto-item:hover {
  background: rgba(91, 139, 180, 0.2);
}

.repuesto-item .repuesto-actions {
  display: flex;
  gap: 6px;
  margin-left: auto;
}

.repuesto-item .btn-repuesto-edit,
.repuesto-item .btn-repuesto-delete {
  padding: 4px 8px;
  background: rgba(91, 139, 180, 0.3);
  border: 1px solid rgba(91, 139, 180, 0.5);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.repuesto-item .btn-repuesto-delete {
  background: rgba(231, 76, 60, 0.3);
  border-color: rgba(231, 76, 60, 0.5);
}

.repuesto-item .btn-repuesto-edit:hover {
  background: rgba(91, 139, 180, 0.5);
  transform: scale(1.1);
}

.repuesto-item .btn-repuesto-delete:hover {
  background: rgba(231, 76, 60, 0.5);
  transform: scale(1.1);
}

.instancia-badge {
  font-size: 0.8rem;
  padding: 2px 8px;
  background: rgba(52, 152, 219, 0.3);
  color: #3498db;
  border-radius: 10px;
  font-weight: 600;
  margin-left: 4px;
}

.visual-v2-tree-container .tree-children {
  margin-left: 60px;
  position: relative;
  padding-top: 0;
}

.visual-v2-tree-container .drag-handle {
  font-size: 1em;
  color: rgba(255, 255, 255, 0.95);
  cursor: pointer;
  margin-right: 4px;
  transition: all 0.2s ease;
  -webkit-user-select: none;
  user-select: none;
}

.visual-v2-tree-container .drag-handle:hover {
  transform: scale(1.1);
}

.visual-v2-tree-container .drag-handle:active {
  cursor: grabbing;
  transform: scale(1.15);
}

.visual-v2-tree-container .dragging .node-content {
  opacity: 0.7;
  transform: scale(0.98);
}

.visual-v2-tree-container .drop-target {
  outline: 2px dashed rgba(91, 139, 180, 0.6);
  outline-offset: 6px;
}

.visual-v2-tree-container .node-id,
.visual-v2-tree-container .node-level {
  font-size: 0.75em;
  opacity: 0.9;
  flex-shrink: 0;
  padding: 2px 6px;
  background: rgba(0, 0, 0, 0.15);
  border-radius: 3px;
  white-space: nowrap;
}

.visual-v2-tree-container .node-level {
  font-size: 0.7em;
  opacity: 0.8;
}

.visual-v2-tree-container .node-name {
  font-size: 0.85em;
  font-weight: 600;
  flex: 0 1 auto;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

.visual-v2-tree-container .node-toggle {
  font-size: 1em;
  color: rgba(255, 255, 255, 0.9);
  cursor: pointer;
  margin-right: 4px;
  width: 16px;
  text-align: center;
  transition: all 0.2s ease;
  -webkit-user-select: none;
  user-select: none;
  flex-shrink: 0;
}

.visual-v2-tree-container .node-toggle:hover {
  color: #ffffff;
  transform: scale(1.2);
}

.visual-v2-tree-container .node-toggle.collapsed {
  transform: rotate(0deg);
}

.visual-v2-tree-container .node-toggle.expanded {
  transform: rotate(90deg);
}

/* 📦 Toggle de repuestos a la derecha del nombre */
.visual-v2-tree-container .node-repuestos-toggle {
  font-size: 0.9em;
  color: rgba(91, 139, 180, 0.8);
  cursor: pointer;
  margin-left: 8px;
  margin-right: 8px;
  padding: 2px 6px;
  border-radius: 4px;
  background: rgba(91, 139, 180, 0.1);
  transition: all 0.2s ease;
  -webkit-user-select: none;
  user-select: none;
  flex-shrink: 0;
}

.visual-v2-tree-container .node-repuestos-toggle:hover {
  color: #5b8bb4;
  background: rgba(91, 139, 180, 0.25);
  transform: scale(1.1);
}

.visual-v2-tree-container .node-repuestos-toggle.collapsed {
  opacity: 0.6;
}

.visual-v2-tree-container .node-repuestos-toggle.expanded {
  opacity: 1;
}

.visual-v2-tree-container > .tree-node > .tree-children::before,
.visual-v2-tree-container .tree-children::before,
.visual-v2-tree-container .tree-children > .tree-node::before,
.visual-v2-tree-container .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  opacity: 1;
  z-index: 1;
}

.visual-v2-tree-container > .tree-node > .tree-children::before {
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container > .tree-node > .tree-children > .tree-node::before {
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container > .tree-node > .tree-children > .tree-node::after {
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children::before {
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node::before {
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node::after {
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

/* PASO 5: Conectar SUB-SISTEMA con SECCIONES */
.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* PASO 6: Conectar SECCIÓN con SUB-SECCIONES */
.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

.visual-v2-export {
  background: #1a1d23;
  padding: 30px;
}

.visual-v2-empty {
  padding: 40px;
  text-align: center;
  color: rgba(208, 224, 255, 0.6);
}

.jerarquia-tree-sap {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 13px;
  line-height: 1.4;
}

.sap-node {
  margin-bottom: 2px;
}

.sap-node-empresa {
  background: var(--bg-secondary);
  border-left: 3px solid #0070f3;
  padding: 8px 12px;
  border-radius: 4px;
  margin-bottom: 12px;
}

.sap-node-content {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 8px;
  border-radius: 3px;
  transition: background 0.15s;
  cursor: pointer;
}

.sap-node-content:hover {
  background: rgba(0,0,0,0.2);
}

.sap-node-drag-handle {
  cursor: grab;
  color: var(--text-muted);
  font-size: 16px;
  line-height: 1;
  padding: 0 4px;
  -webkit-user-select: none;
  user-select: none;
}

.sap-node-drag-handle:hover {
  color: var(--primary);
}

.sap-node-drag-handle:active {
  cursor: grabbing;
}

.sap-node.dragging {
  opacity: 0.5;
  cursor: move;
}

.sap-node.drag-over > .sap-node-content {
  background: rgba(46, 204, 113, 0.15);
  border: 2px dashed var(--success);
  border-radius: 4px;
}

/* Línea de inserción visual */
.sap-drop-indicator {
  position: absolute;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), var(--success));
  box-shadow: 0 0 8px rgba(52, 152, 219, 0.6);
  z-index: 1000;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s ease;
}

.sap-drop-indicator.active {
  opacity: 1;
}

.sap-drop-indicator::before {
  content: '';
  position: absolute;
  left: 0;
  top: -3px;
  width: 9px;
  height: 9px;
  background: var(--primary);
  border-radius: 50%;
  box-shadow: 0 0 6px rgba(52, 152, 219, 0.8);
}

/* Cursores personalizados según validez */
.sap-node.drag-valid {
  cursor: copy !important;
}

.sap-node.drag-invalid {
  cursor: no-drop !important;
}

.sap-node.dragging * {
  cursor: grabbing !important;
}

/* Highlight verde para contenedores válidos durante drag */
.sap-node.valid-drop-target {
  background: rgba(46, 204, 113, 0.12) !important;
  border: 2px solid rgba(46, 204, 113, 0.5) !important;
  border-radius: 6px;
  box-shadow: 0 0 12px rgba(46, 204, 113, 0.3);
  transition: all 0.2s ease;
}

.sap-node.valid-drop-target > .sap-node-content {
  background: rgba(46, 204, 113, 0.08);
}

/* Indicador visual de "drop zone" */
.sap-node.valid-drop-target::after {
  content: '✓ Soltar aquí';
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--success);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  opacity: 0.9;
  pointer-events: none;
  z-index: 10;
}

.sap-node-expand {
  cursor: pointer;
  width: 16px;
  text-align: center;
  font-size: 12px;
  font-weight: bold;
  color: #4a90a4;
  -webkit-user-select: none;
  user-select: none;
}

.sap-node-icon {
  font-size: 14px;
  width: 18px;
  text-align: center;
}

.sap-node-id {
  font-family: 'Courier New', monospace;
  font-size: 11px;
  font-weight: 600;
  color: #1a2d35;
  background: #a8c7d0;
  padding: 3px 8px;
  border-radius: 2px;
  min-width: 60px;
  text-align: center;
  border: 1px solid #7ea8b5;
}

.sap-node-name {
  flex: 1;
  color: var(--text-primary);
  font-weight: 500;
  cursor: pointer;
  -webkit-user-select: none;
  user-select: none;
  transition: color 0.2s;
}

.sap-node-name:hover {
  color: var(--primary);
}

.sap-node-part-number {
  font-family: 'Courier New', monospace;
  font-size: 11px;
  font-weight: 600;
  color: #4a5c2d;
  background: #dfe6b8;
  padding: 3px 8px;
  border-radius: 2px;
  margin-left: 8px;
  border: 1px solid #c5d19e;
}

.sap-node-actions {
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.2s;
}

.sap-node-content:hover .sap-node-actions {
  opacity: 1;
}

.sap-btn {
  background: none;
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  padding: 3px 8px;
  border-radius: 3px;
  cursor: pointer;
  font-family: 'Courier New', monospace;
  font-size: 10px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  transition: all 0.15s;
}

.sap-btn:hover {
  background: var(--bg-secondary);
  border-color: var(--text-secondary);
}

.sap-btn-edit {
  border-color: var(--info);
  color: var(--info);
}

.sap-btn-edit:hover {
  background: var(--info);
  color: white;
}

.sap-btn-delete {
  border-color: var(--danger);
  color: var(--danger);
}

.sap-btn-delete:hover {
  background: var(--danger);
  color: white;
}

.sap-btn-add {
  border-color: var(--success);
  color: var(--success);
  font-size: 12px;
}

.sap-btn-add:hover {
  background: var(--success);
  color: white;
}

/* BOTONES UNDO/REDO - Flotantes en cada pestaña */
.undo-redo-controls {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  gap: 8px;
  z-index: 999;
  opacity: 0.95;
}

.undo-redo-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
  position: relative;
}

.undo-redo-btn:hover:not(:disabled) {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.undo-redo-btn:active:not(:disabled) {
  transform: translateY(-1px) scale(0.98);
}

.undo-redo-btn:disabled {
  background: linear-gradient(135deg, #ccc 0%, #999 100%);
  cursor: not-allowed;
  opacity: 0.5;
}

.undo-redo-btn::before {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  margin-bottom: 8px;
}

.undo-redo-btn:hover::before {
  opacity: 1;
}

.undo-btn {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.redo-btn {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.sap-btn-subnivel {
  border-color: var(--warning);
  color: var(--warning);
  font-size: 10px;
}

.sap-btn-subnivel:hover {
  background: var(--warning);
  color: white;
}

.sap-children {
  margin-left: 24px;
  border-left: 1px dashed var(--border-color);
  padding-left: 8px;
  margin-top: 2px;
}

#jerarquiaTreeContainer:not(.palette-visual) .sap-node-empresa {
  margin-bottom: 16px;
  position: relative;
  z-index: 2;
}

#jerarquiaTreeContainer:not(.palette-visual) .sap-node-empresa + .sap-node {
  margin-top: 12px;
}

.sap-add-root {
  margin-top: 12px;
  padding-left: 24px;
}

/* ============================================================
   LISTAS CONFIG - SECCIN DE LISTAS DESPLEGABLES
   ============================================================ */
.listas-config-container {
  margin-top: 24px;
  padding: 24px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border: 2px solid var(--border-color);
}

.listas-config-description {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin-bottom: 12px;
}

.listas-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 12px;
}

.lista-card {
  background: var(--bg-secondary);
  padding: 12px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
}

.lista-card-info {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.jerarquia-note-title {
  display: flex;
  align-items: center;
  gap: 8px;
}

.jerarquia-note-text {
  margin: 0;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.jerarquia-note-list {
  margin: 0;
  padding-left: 18px;
  color: var(--text-secondary);
  font-size: 0.85rem;
  line-height: 1.4;
}

.jerarquia-note-tip {
  border: 1px dashed var(--border-color);
  border-radius: 6px;
  padding: 12px;
  background: var(--bg-secondary);
  color: var(--text-muted);
  font-size: 0.85rem;
}

.lista-title {
  color: var(--primary);
  margin-bottom: 8px;
  font-size: 0.85rem;
  font-weight: 600;
}

.lista-badge {
  display: inline-block;
  background: rgba(91, 124, 153, 0.2);
  color: #5B7C99;
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 0.65rem;
  margin-right: 6px;
}

.lista-badge-n1 {
  background: rgba(74, 144, 226, 0.2);
  color: #4A90E2;
}

.lista-badge-n2 {
  background: rgba(91, 124, 153, 0.2);
  color: #5B7C99;
}

.lista-badge-n3 {
  background: rgba(113, 128, 150, 0.2);
  color: #718096;
}

.lista-badge-n4 {
  background: rgba(122, 154, 184, 0.2);
  color: #7A9AB8;
}

.lista-badge-n5 {
  background: rgba(139, 154, 170, 0.2);
  color: #8B9AAA;
}

.lista-badge-n6 {
  background: rgba(154, 171, 184, 0.2);
  color: #9AABB8;
}

.lista-badge-n7 {
  background: rgba(107, 142, 127, 0.2);
  color: #6B8E7F;
}

.lista-content {
  max-height: 150px;
  overflow-y: auto;
  margin-bottom: 8px;
  background: var(--bg-primary);
  padding: 6px;
  border-radius: 4px;
  font-size: 0.8rem;
}

.lista-input-group {
  display: flex;
  gap: 6px;
}

.lista-input {
  flex: 1;
  padding: 6px 8px;
  font-size: 0.8rem;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
}

.lista-add-btn {
  padding: 6px 10px;
  font-size: 0.75rem;
}

/* ============================================================
   JERARQUIA - CONTROLES DE BÚSQUEDA Y PALETAS
   ============================================================ */

.jerarquia-controls-bar {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: flex-start;
  padding: 15px 20px;
  background: rgba(37, 42, 51, 0.6);
  border-radius: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  position: relative;
}

.jerarquia-controls-bar.is-visual-v2-active {
  display: none;
}

.jerarquia-search-wrapper {
  position: relative;
  flex: 1;
  min-width: 280px;
  max-width: 500px;
}

.jerarquia-search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  pointer-events: none;
  opacity: 0.6;
}

.jerarquia-search-input {
  width: 100%;
  padding: 8px 12px 8px 40px;
  background: #252a33;
  border: 1px solid #4a5059;
  border-radius: 6px;
  color: #e6e9ef;
  font-size: 0.9em;
  transition: all 0.3s ease;
}

.jerarquia-search-input:focus {
  outline: none;
  border-color: #5b8bb4;
  box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
}

.jerarquia-search-input::placeholder {
  color: #8a909a;
}

.jerarquia-search-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #252a33;
  border: 1px solid #5b8bb4;
  border-top: none;
  border-radius: 0 0 6px 6px;
  margin-top: 0;
  max-height: 300px;
  overflow-y: auto;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: none;
}

.jerarquia-search-suggestions.active {
  display: block;
}

.jerarquia-suggestion-item {
  padding: 10px 15px;
  cursor: pointer;
  border-bottom: 1px solid rgba(74, 80, 89, 0.3);
  transition: background 0.2s ease;
  display: flex;
  gap: 10px;
  align-items: center;
}

.jerarquia-suggestion-item:last-child {
  border-bottom: none;
}

.jerarquia-suggestion-item:hover {
  background: #2d333d;
}

.jerarquia-suggestion-item.selected {
  background: #3d4454;
  border-left: 3px solid #5b8bb4;
}

.jerarquia-suggestion-main {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
}

.jerarquia-suggestion-id {
  color: #5b8bb4;
  font-weight: 700;
  font-size: 0.85em;
  min-width: 80px;
}

.jerarquia-suggestion-meta {
  display: flex;
  gap: 6px;
  align-items: center;
  font-size: 0.75em;
  color: #8a909a;
}

.jerarquia-suggestion-path {
  font-size: 0.75em;
  color: #8a909a;
}

.jerarquia-match {
  background: rgba(91, 139, 180, 0.3);
  color: #e6e9ef;
  border-radius: 3px;
  padding: 0 2px;
}

.jerarquia-search-status {
  font-size: 0.85em;
  color: #8a909a;
  font-style: italic;
  white-space: nowrap;
  display: none; /* Oculto por defecto */
}

.jerarquia-search-status.success {
  color: #10b981;
}

.jerarquia-search-status.warning {
  color: #fbbf24;
}

/* Separador en jerarquía */
.jerarquia-controls-bar .toolbar-separator {
  width: 1px;
  height: 28px;
  background: rgba(255, 255, 255, 0.1);
  margin: 0 4px;
}

/* Toggle Triple de Vistas - Compacto sin iconos */
.jerarquia-view-toggle {
  position: relative;
  display: flex;
  background: #1a1d23;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 3px;
  gap: 3px;
  min-width: 240px;
}

/* Botones Expandir/Contraer */
.jerarquia-expand-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px 16px;
  background: rgba(255, 255, 255, 0.05);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  color: var(--text-secondary);
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.jerarquia-expand-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--text-primary);
  transform: scale(1.05);
  border-color: rgba(255, 255, 255, 0.2);
}

.jerarquia-expand-btn:active {
  transform: scale(0.95);
}

.jerarquia-expand-btn .expand-label {
  position: relative;
  z-index: 1;
}

/* Botón Debug */
.jerarquia-expand-btn.debug-btn {
  background: rgba(91, 139, 180, 0.15);
}

/* Botón Reset */
.jerarquia-expand-btn.reset-btn {
  background: rgba(180, 91, 91, 0.15);
}

.jerarquia-toggle-option {
  flex: 1;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 6px 12px;
  background: #2d333d;
  border: none;
  border-radius: 4px;
  color: #7a8189;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  white-space: nowrap;
  letter-spacing: 0.5px;
}

.jerarquia-toggle-option .toggle-label {
  position: relative;
  z-index: 1;
}

.jerarquia-toggle-option:hover:not(.active) {
  background: #3a4049;
  color: #8a9098;
  transform: translateY(-1px);
}

.jerarquia-toggle-option.active {
  background: #4a5562;
  color: #e6e9ef;
  box-shadow: 
    0 2px 8px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.08);
}

/* Botón de reset especial */
.jerarquia-toggle-option.jerarquia-reset-btn {
  flex: 0 0 auto;
  min-width: 40px;
  padding: 6px;
  background: #dc3545;
  color: white;
}

.jerarquia-toggle-option.jerarquia-reset-btn:hover {
  background: #c82333;
  transform: translateY(-1px) rotate(180deg);
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Pestañas de Vista - Ocultas ahora */
.jerarquia-view-tabs {
  display: none;
}

.jerarquia-view-selector {
  display: flex;
  align-items: center;
  gap: 10px;
}

.jerarquia-view-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  white-space: nowrap;
}

.jerarquia-palette-select {
  padding: 8px 12px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 220px;
}

.jerarquia-palette-select:hover {
  border-color: var(--primary);
}

.jerarquia-palette-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
}

/* Highlight para búsqueda */
.search-highlight {
  background: rgba(255, 235, 59, 0.3);
  border-radius: 2px;
  padding: 1px 0;
  font-weight: 600;
}

.search-match {
  background: rgba(255, 235, 59, 0.5);
  box-shadow: 0 0 8px rgba(255, 235, 59, 0.3);
}

/* ============================================================
   PALETAS DE COLORES PARA JERARQUÍA
   ============================================================ */

/* PALETA VISUAL: ÁRBOL CON CONEXIONES - Vista 3 (jerarquia_visual_dependencias) */
#jerarquiaTreeContainer {
  position: relative;
  transition: opacity 0.35s ease, transform 0.35s ease;
  opacity: 0;
  visibility: hidden;
  transform: translateY(8px);
}

#jerarquiaTreeContainer.jerarquia-tree-restoring {
  opacity: 0;
  pointer-events: none;
  visibility: hidden;
  transform: translateY(8px);
  transition: none !important;
}

#jerarquiaTreeContainer.jerarquia-tree-restoring::after {
  content: '';
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(15, 18, 25, 0.8);
  z-index: 2;
  pointer-events: none;
}

#jerarquiaTreeContainer.jerarquia-tree-restoring::before {
  content: '';
  position: absolute;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 3px solid rgba(255, 255, 255, 0.2);
  border-top-color: var(--primary, #4db6ff);
  animation: jerarquia-spinner 0.9s linear infinite;
  z-index: 3;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

#jerarquiaTreeContainer.jerarquia-tree-ready {
  opacity: 1;
  pointer-events: auto;
  visibility: visible;
  transform: translateY(0);
}

@keyframes jerarquia-spinner {
  from {
    transform: translate(-50%, -50%) rotate(0deg);
  }
  to {
    transform: translate(-50%, -50%) rotate(360deg);
  }
}

#jerarquiaTreeContainer.palette-visual {
  background: #1a1d23;
  padding: 40px;
  overflow: visible;
  min-height: 600px;
  height: auto;
}

.palette-visual .tree-container {
  overflow-x: auto;
  padding: 20px;
  height: auto;
  transform-origin: top center;
  transition: transform 0.3s ease;
}

.palette-visual .tree-node {
  position: relative;
  margin: 6px 0;
}

.palette-visual .node-content {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  min-width: 320px;
  max-width: fit-content;
  background: linear-gradient(135deg, #3d4a5c 0%, #2d3847 100%);
  color: #c5cdd9;
  border-radius: 6px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  z-index: 2;
  height: 32px;
}

.palette-visual .node-content[data-level="1"] {
  background: linear-gradient(135deg, #3d4e63 0%, #2d3d4f 100%);
  color: #d5dce5;
  padding-left: 12px;
}

.palette-visual .tree-container > .tree-node > .node-content[data-level="1"] {
  margin-bottom: 24px;
}

.palette-visual .node-content[data-level="2"] {
  background: linear-gradient(135deg, #405266 0%, #30415a 100%);
  color: #d5dce5;
  padding-left: 12px;
}

.palette-visual .node-content[data-level="3"] {
  background: linear-gradient(135deg, #43566b 0%, #33465d 100%);
  color: #dbe2ea;
  padding-left: 12px;
}

.palette-visual .node-content[data-level="4"] {
  background: linear-gradient(135deg, #475b71 0%, #374b61 100%);
  color: #dbe2ea;
  padding-left: 12px;
}

.palette-visual .node-content[data-level="5"] {
  background: linear-gradient(135deg, #4b6077 0%, #3b5067 100%);
  color: #e2e8ef;
  padding-left: 12px;
}

.palette-visual .node-content[data-level="6"] {
  background: linear-gradient(135deg, #4f657d 0%, #3f556d 100%);
  color: #e2e8ef;
  padding-left: 12px;
}

.palette-visual .node-content[data-level="7"] {
  background: linear-gradient(135deg, #536a83 0%, #435a73 100%);
  color: #e8edf3;
  padding-left: 12px;
}

.palette-visual .node-content:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 6px 20px rgba(83, 106, 131, 0.5);
  filter: brightness(1.15);
}

.palette-visual .node-toggle {
  font-size: 1em;
  color: rgba(255, 255, 255, 0.9);
  cursor: pointer;
  margin-right: 4px;
  width: 16px;
  text-align: center;
  transition: all 0.2s ease;
  -webkit-user-select: none;
  user-select: none;
  flex-shrink: 0;
}

.palette-visual .node-toggle:hover {
  color: white;
  transform: scale(1.2);
}

.palette-visual .node-toggle.collapsed {
  transform: rotate(0deg);
}

.palette-visual .node-toggle.expanded {
  transform: rotate(90deg);
}

.palette-visual .node-id {
  font-size: 0.75em;
  opacity: 0.9;
  flex-shrink: 0;
  padding: 2px 6px;
  background: rgba(0, 0, 0, 0.15);
  border-radius: 3px;
  white-space: nowrap;
}

.palette-visual .node-content[data-level="1"] .node-id,
.palette-visual .node-content[data-level="2"] .node-id,
.palette-visual .node-content[data-level="3"] .node-id,
.palette-visual .node-content[data-level="4"] .node-id,
.palette-visual .node-content[data-level="5"] .node-id,
.palette-visual .node-content[data-level="6"] .node-id,
.palette-visual .node-content[data-level="7"] .node-id {
  background: rgba(0, 0, 0, 0.15);
  color: white;
  border: none;
}

.palette-visual .node-name {
  font-size: 0.85em;
  font-weight: 600;
  flex: 0 1 auto;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}
.palette-visual .node-level {
  font-size: 0.7em;
  opacity: 0.8;
  flex-shrink: 0;
  padding: 2px 6px;
  background: rgba(0, 0, 0, 0.15);
  border-radius: 3px;
  white-space: nowrap;
}

.palette-visual .tree-children {
  margin-left: 60px;
  position: relative;
  padding-top: 0;
  max-height: none;
  overflow: visible;
}

/* CONEXIONES NIVEL 1: EMPRESA → ÁREAS */
.palette-visual .tree-container > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* CONEXIONES NIVEL 2: ÁREA → SUB-ÁREAS */
.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* CONEXIONES NIVEL 3: SUB-ÁREA → SISTEMAS */
.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* CONEXIONES NIVEL 4: SISTEMA → SUB-SISTEMAS */
.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* CONEXIONES NIVEL 5: SUB-SISTEMA → SECCIONES */
.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* CONEXIONES NIVEL 6: SECCIÓN → SUB-SECCIONES */
.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* PALETA 8: CORPORATIVO OSCURO */
.palette-8 .sap-node-empresa {
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

/* ========================================
   CONEXIONES NIVEL 5: SUB-SISTEMA → SECCIONES
   ======================================== */
   
.palette-visual .sap-node[data-node-type="subSistema"] > .sap-node-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  z-index: 1;
}

.palette-visual .sap-node[data-node-type="subSistema"] > .sap-node-children > .sap-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  z-index: 1;
}

.palette-visual .sap-node[data-node-type="subSistema"] > .sap-node-children > .sap-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

/* ========================================
   CONEXIONES NIVEL 6: SECCIÓN → SUB-SECCIONES
   ======================================== */
   
.palette-visual .sap-node[data-node-type="seccion"] > .sap-node-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  z-index: 1;
}

.palette-visual .sap-node[data-node-type="seccion"] > .sap-node-children > .sap-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  z-index: 1;
}

.palette-visual .sap-node[data-node-type="seccion"] > .sap-node-children > .sap-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

/* Estilos de nodos para todos los niveles (excepto empresa) */
.palette-visual .sap-node-content {
  background: linear-gradient(135deg, #5b8bb4 0%, #4a7090 100%);
  color: white;
  border: none;
  border-radius: 6px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  padding: 4px 8px;
  min-height: 32px;
  transition: all 0.3s ease;
}

.palette-visual .sap-node-content:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 6px 20px rgba(91, 139, 180, 0.4);
}

.palette-visual .sap-node-id {
  background: rgba(0, 0, 0, 0.15);
  color: #ffffff;
  font-size: 0.75em;
  opacity: 0.9;
  border-radius: 3px;
  padding: 2px 6px;
}

.palette-visual .sap-node-name {
  color: #ffffff;
  font-size: 0.85em;
  font-weight: 600;
}

/* Reducir espaciado entre nodos en vista visual */
.palette-visual .sap-node {
  margin-bottom: 2px;
}

/* PALETA 8: CORPORATIVO OSCURO */
.palette-8 .sap-node-empresa {
  background: linear-gradient(135deg, #171d28 0%, #232a38 100%);
  border-left: 4px solid #2d4a6b;
}

.palette-8 .sap-node-empresa .sap-node-id {
  background: #232a38;
  color: #8895ab;
  border-color: #2d4a6b;
}

/* Nivel 2: Áreas */
.palette-8 .sap-node[data-node-type="area"] > .sap-node-content {
  background: linear-gradient(135deg, #1e2936 0%, #2a3543 100%);
  border-left: 4px solid #354c69;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="area"] .sap-node-id {
  background: #2a3543;
  color: #97a8be;
  border-color: #354c69;
}

/* Nivel 3: Sub-Áreas */
.palette-8 .sap-node[data-node-type="subArea"] > .sap-node-content {
  background: linear-gradient(135deg, #283544 0%, #344254 100%);
  border-left: 4px solid #3f5573;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="subArea"] .sap-node-id {
  background: #344254;
  color: #a8b9d0;
  border-color: #3f5573;
}

/* Nivel 4: Sistemas */
.palette-8 .sap-node[data-node-type="sistema"] > .sap-node-content {
  background: linear-gradient(135deg, #324454 0%, #3e5164 100%);
  border-left: 4px solid #4a617c;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="sistema"] .sap-node-id {
  background: #3e5164;
  color: #bacbdf;
  border-color: #4a617c;
}

/* Nivel 5: Sub-Sistemas */
.palette-8 .sap-node[data-node-type="subSistema"] > .sap-node-content {
  background: linear-gradient(135deg, #3d5265 0%, #496176 100%);
  border-left: 4px solid #566e84;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="subSistema"] .sap-node-id {
  background: #496176;
  color: #cddceb;
  border-color: #566e84;
}

/* Nivel 6: Secciones */
.palette-8 .sap-node[data-node-type="seccion"] > .sap-node-content {
  background: linear-gradient(135deg, #4a6276 0%, #567185 100%);
  border-left: 4px solid #61798a;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="seccion"] .sap-node-id {
  background: #567185;
  color: #d9e2ef;
  border-color: #61798a;
}

/* Nivel 7: Sub-Secciones */
.palette-8 .sap-node[data-node-type="subSeccion"] > .sap-node-content {
  background: linear-gradient(135deg, #576d7d 0%, #61798a 100%);
  border-left: 4px solid #7692aa;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="subSeccion"] .sap-node-id {
  background: #61798a;
  color: #e8f0f7;
  border-color: #7692aa;
}

#jerarquiaTreeContainer.palette-8 .sap-node {
  margin-bottom: 12px;
  position: relative;
}

#jerarquiaTreeContainer.palette-8 .sap-node:last-child {
  margin-bottom: 0;
}

#jerarquiaTreeContainer.palette-8 .sap-node-empresa {
  padding: 0;
  border-left: none;
  margin: 12px 0 0;
  margin-left: 0;
  width: 100%;
}

#jerarquiaTreeContainer.palette-8 .sap-node-empresa .sap-node-content {
  padding: 8px 14px;
  border-radius: 6px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
  position: relative;
  z-index: 5;
  width: 100%;
  max-width: none;
  margin-left: 0;
  margin-right: 0;
  background: linear-gradient(135deg, #171d28 0%, #232a38 100%);
  border-left: 4px solid #2d4a6b;
  border: none;
}

#jerarquiaTreeContainer.palette-8 .sap-node-empresa .sap-node-content::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 6px;
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
  pointer-events: none;
}

#jerarquiaTreeContainer.palette-8 .sap-node-empresa + .sap-node {
  margin-top: 50px;
}

#jerarquiaTreeContainer.palette-8 .sap-children {
  margin-top: 10px;
  padding-left: 18px;
  border-left: 1px solid rgba(118, 146, 170, 0.4);
}

#jerarquiaTreeContainer.palette-8 .sap-node-content {
  padding: 8px 14px;
  border-radius: 6px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
  position: relative;
  overflow: hidden;
  -webkit-backdrop-filter: blur(2px);
  backdrop-filter: blur(2px);
}

#jerarquiaTreeContainer.palette-8 .sap-node-content::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 6px;
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
  pointer-events: none;
}

#jerarquiaTreeContainer.palette-8 .sap-node-content > * {
  position: relative;
  z-index: 1;
}

#jerarquiaTreeContainer.palette-8 .sap-node-expand,
#jerarquiaTreeContainer.palette-8 .sap-node-drag-handle {
  color: rgba(255, 255, 255, 0.7);
}

#jerarquiaTreeContainer.palette-8 .sap-node-expand:hover,
#jerarquiaTreeContainer.palette-8 .sap-node-drag-handle:hover {
  color: #ffffff;
}

#jerarquiaTreeContainer.palette-8 .sap-node-id {
  background: rgba(12, 22, 32, 0.6);
  color: #d7e3f5;
  border-color: rgba(118, 146, 170, 0.45);
}

#jerarquiaTreeContainer.palette-8 .sap-node-name {
  color: #f0f4ff;
  font-weight: 600;
}

#jerarquiaTreeContainer.palette-8 .sap-node-actions {
  background: rgba(0, 0, 0, 0.15);
  padding: 4px 6px;
  border-radius: 999px;
}

#jerarquiaTreeContainer.palette-8 .sap-btn {
  border-color: rgba(173, 192, 211, 0.4);
  color: #e4ebf7;
}

#jerarquiaTreeContainer.palette-8 .sap-btn:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(173, 192, 211, 0.7);
}

/* ============================================================
   HIDDEN ELEMENTS - Para elementos con display: none inicial
   ============================================================ */
.hidden {
  display: none;
}

/* ============================================================
   CONFIG - Categoras de reas del Mapa
   ============================================================ */
.config-section {
  margin-top: 32px;
  padding: 24px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border: 2px solid var(--border-color);
}

.config-section-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0;
}

.config-section-clickable {
  cursor: pointer;
  flex: 1;
  padding: 12px;
  background: rgba(0,0,0,0.1);
  border-radius: 6px;
  -webkit-user-select: none;
  user-select: none;
}

.config-section-title-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.config-section-title {
  color: var(--primary);
  margin: 0;
  font-size: 1.2rem;
  font-weight: 600;
}

.config-btn-add-category {
  background: var(--success);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.config-btn-add-category:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.config-btn-icon {
  font-size: 1.1rem;
}

.config-description {
  color: var(--text-secondary);
  font-size: 0.85rem;
  margin-bottom: 16px;
}

.config-section-content-hidden {
  display: none;
  padding-top: 16px;
}

.categorias-container {
  background: var(--bg-secondary);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid var(--border-color);
}

.categorias-grid {
  display: grid;
  gap: 12px;
}

.mensaje-no-categorias {
  display: none;
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.mensaje-no-categorias-icon {
  font-size: 3rem;
  margin-bottom: 12px;
  opacity: 0.5;
}

.mensaje-no-categorias-text {
  font-size: 0.95rem;
  margin: 0;
}

.mensaje-no-categorias-small {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.config-info-box {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
  padding: 16px;
  border-radius: 8px;
  margin-top: 16px;
  border-left: 4px solid var(--primary);
}

.config-info-content {
  display: flex;
  align-items: start;
  gap: 12px;
}

.config-info-icon {
  font-size: 1.5rem;
}

.config-info-title {
  color: var(--text-primary);
  font-size: 0.9rem;
  margin: 0 0 6px 0;
  font-weight: 600;
}

.config-info-description {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin: 0;
  line-height: 1.5;
}

/* ============================================================
   MODAL REPUESTOS - Formulario
   ============================================================ */
.form-categoria-select {
  font-size: 1.05rem;
  font-weight: 700;
  color: #4A6278;
}

.form-ejemplos-small {
  color: #7A9AB8;
  font-size: 0.68rem;
  display: block;
  margin-top: 4px;
  font-style: italic;
  min-height: 16px;
}

.form-stock-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
}

.form-hint-small {
  color: var(--text-secondary);
  font-size: 0.65rem;
  display: block;
  margin-top: -6px;
  margin-bottom: 8px;
}

.form-label-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-label-optional {
  color: var(--text-secondary);
  font-weight: 400;
  font-size: 0.65rem;
}

.form-textarea-tech {
  resize: vertical;
  min-height: 60px;
  font-family: 'Courier New', monospace;
  font-size: 0.78rem;
}

.form-textarea-hint {
  color: var(--text-secondary);
  font-size: 0.62rem;
  display: block;
  margin-top: 3px;
}

.form-multimedia-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(360px, 1fr));
  gap: 18px;
  margin-bottom: 12px;
}

.form-label-space-between {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-weight: 500;
  font-size: 0.85rem;
  color: var(--text-primary);
}

.form-upload-mode {
  color: var(--info);
  font-weight: 600;
  font-size: 0.7rem;
}

.mobile-photo-buttons {
  display: none;
  gap: 6px;
  margin-bottom: 8px;
}

.mobile-photo-btn {
  flex: 1;
  padding: 8px;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.form-input-hidden {
  display: none;
}

.form-input-file {
  padding: 8px 12px;
  font-size: 0.85rem;
}

.multimedia-preview-margin {
  margin-top: 6px;
}

.form-label-margin {
  margin-bottom: 6px;
}

.documents-list {
  margin-top: 6px;
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* Zona de carga de imgenes mejorada */
.image-upload-zone {
  border: 2px dashed var(--primary);
  border-radius: 6px;
  padding: 24px 16px;
  text-align: center;
  background: rgba(91, 139, 180, 0.04);
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 12px;
}

.image-upload-zone:hover {
  background: rgba(91, 139, 180, 0.08);
  border-color: rgba(91, 139, 180, 0.8);
}

.upload-icon {
  font-size: 2.5rem;
  margin-bottom: 8px;
  opacity: 0.6;
}

.upload-text {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.upload-hint {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

/* Modal Optimizador de Imgenes */
.optimizer-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.65);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
  overflow-y: auto;
}

.optimizer-modal.active {
  display: flex;
}

.optimizer-content {
  background: var(--bg-secondary);
  border-radius: 16px;
  max-width: 920px;
  width: 100%;
  max-height: 92vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
  margin: auto;
  animation: modalFadeIn 0.2s ease-out;
}

@keyframes modalFadeIn {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.optimizer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 2px solid var(--border-color);
  background: var(--bg-tertiary);
  border-radius: 16px 16px 0 0;
  flex-shrink: 0;
}

.optimizer-header h3 {
  margin: 0;
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.optimizer-header h3::before {
  content: '🖼️';
  font-size: 1.4rem;
}

.optimizer-close {
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  font-size: 1.5rem;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 0;
  width: 36px;
  height: 36px;
  line-height: 1;
  border-radius: 8px;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.optimizer-close:hover {
  color: white;
  background: var(--danger);
  border-color: var(--danger);
  transform: rotate(90deg);
}

.optimizer-body {
  padding: 24px;
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}

.optimizer-preview {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 16px;
  margin-bottom: 24px;
  align-items: center;
}

@media (max-width: 768px) {
  .optimizer-preview {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  .preview-arrow {
    transform: rotate(90deg);
  }
}

.preview-original,
.preview-optimized {
  text-align: center;
}

.preview-original h4,
.preview-optimized h4 {
  margin: 0 0 10px 0;
  font-size: 0.9rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.preview-original img,
.preview-optimized img {
  max-width: 100%;
  max-height: 220px;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  background: var(--bg-primary);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: transform 0.2s ease;
}

.preview-original img:hover,
.preview-optimized img:hover {
  transform: scale(1.02);
  border-color: var(--primary);
}

.preview-info {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.preview-arrow {
  font-size: 2rem;
  color: var(--primary);
}

.savings-badge {
  margin-top: 10px;
  padding: 8px 12px;
  background: var(--success);
  color: white;
  border-radius: 6px;
  font-size: 0.85rem;
  display: inline-block;
}

.savings-badge strong {
  font-size: 1.1rem;
}

.optimizer-controls {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.control-group label {
  display: block;
  margin-bottom: 10px;
  font-weight: 500;
  color: var(--text-primary);
}

.size-options {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}

.size-btn {
  padding: 12px;
  border: 2px solid var(--border-color);
  background: var(--bg-tertiary);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
}

.size-btn span {
  display: block;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.size-btn small {
  display: block;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.size-btn:hover {
  border-color: var(--primary);
  background: rgba(91, 139, 180, 0.1);
}

.size-btn.active {
  border-color: var(--primary);
  background: var(--primary);
  color: white;
}

.size-btn.active span,
.size-btn.active small {
  color: white;
}

#qualitySlider {
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: var(--border-color);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

#qualitySlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
}

#qualitySlider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
  border: none;
}

.control-group small {
  display: block;
  margin-top: 5px;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.optimizer-footer {
  display: flex;
  gap: 12px;
  padding: 20px 24px;
  border-top: 2px solid var(--border-color);
  justify-content: space-between;
  background: var(--bg-tertiary);
  border-radius: 0 0 16px 16px;
  flex-shrink: 0;
}

.optimizer-footer .btn {
  min-width: 160px;
  padding: 12px 24px;
  font-size: 0.95rem;
  font-weight: 600;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.optimizer-footer .btn-success {
  background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
  box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

.optimizer-footer .btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
}

.optimizer-footer .btn-secondary {
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  color: var(--text-primary);
}

.optimizer-footer .btn-secondary:hover {
  background: var(--bg-secondary);
  border-color: var(--primary);
  transform: translateY(-1px);
}

@media (max-width: 640px) {
  .optimizer-footer {
    flex-direction: column-reverse;
  }
  .optimizer-footer .btn {
    width: 100%;
  }
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 2px solid var(--border-color);
}

.btn-save-main {
  flex: 0 0 auto;
  min-width: 260px;
  justify-content: center;
}

.btn-loading-hidden {
  display: none;
}

.btn-cancel-modal {
  flex: 0 0 auto;
  min-width: 180px;
}

/* ============================================================
   MODALES - Estilos comunes para modales
   ============================================================ */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  z-index: 10001;
  overflow: hidden;
  -webkit-backdrop-filter: blur(4px);
  backdrop-filter: blur(4px);
}

.modal-overlay-highest {
  z-index: 99999;
}

.modal-container {
  position: relative;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  margin: 10vh auto;
  background: var(--bg-secondary);
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal-header {
  padding: 20px 24px;
  background: linear-gradient(135deg, var(--primary), var(--info));
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  margin: 0;
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-icon {
  font-size: 1.8rem;
}

.modal-close-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 1.8rem;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.modal-close-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.modal-content {
  padding: 24px;
  max-height: calc(80vh - 80px);
  overflow-y: auto;
}

/* Variantes de modal */
.modal-container-large {
  max-width: 900px;
  height: 90vh;
  margin: 5vh auto;
  background: var(--bg-primary);
}

.modal-container-xlarge {
  max-width: 1200px;
  height: 90vh;
  margin: 5vh auto;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-header-stats {
  padding: 24px;
  border-bottom: 2px solid var(--border-color);
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border-radius: 16px 16px 0 0;
  flex-shrink: 0;
}

.modal-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title-large {
  margin: 0;
  font-size: 1.8rem;
  display: flex;
  align-items: center;
  gap: 12px;
}

.modal-icon-large {
  font-size: 2rem;
}

.modal-close-btn-large {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 28px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.modal-close-btn-large:hover {
  background: rgba(239, 68, 68, 0.9);
  transform: rotate(90deg);
}

.modal-content-flex {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.modal-footer {
  padding: 20px 24px;
  border-top: 2px solid var(--border-color);
  background: var(--bg-secondary);
  border-radius: 0 0 16px 16px;
  flex-shrink: 0;
}

.modal-footer-btn {
  width: 100%;
  padding: 14px;
  font-size: 1.1rem;
}

/* Modal Cascada - estilos especficos */
.modal-header-cascada {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
  background: var(--bg-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}

.modal-title-cascada {
  margin: 0;
  font-size: 1.1rem;
  color: var(--text-primary);
  font-weight: 600;
}

.modal-close-btn-simple {
  background: none;
  border: none;
  color: var(--text-secondary);
  width: 32px;
  height: 32px;
  border-radius: 4px;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.modal-close-btn-simple:hover {
  background: var(--bg-tertiary);
  color: var(--danger);
}

.cascada-toolbar {
  padding: 12px 20px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  flex-shrink: 0;
}

.cascada-stats {
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  margin-bottom: 10px;
  font-size: 0.85rem;
  color: var(--text-secondary);
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.cascada-search-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 0.9rem;
  outline: none;
  margin-bottom: 10px;
}

.cascada-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.cascada-btn {
  padding: 6px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.2s;
}

.cascada-btn:hover {
  background: var(--bg-primary);
}

.modal-content-cascada {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
}

.modal-footer-simple {
  padding: 12px 20px;
  border-top: 1px solid var(--border-color);
  background: var(--bg-secondary);
  flex-shrink: 0;
}

.modal-footer-btn-simple {
  width: 100%;
  padding: 10px;
  background: var(--primary);
  border: none;
  border-radius: 4px;
  color: white;
  font-size: 0.95rem;
  cursor: pointer;
  transition: opacity 0.2s;
}

.modal-footer-btn-simple:hover {
  opacity: 0.9;
}

/* Modal Detalles - modal simple para confirmaciones */
.modal-detalles-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 10000;
  justify-content: center;
  align-items: center;
}

.modal-detalles-container {
  background: var(--bg-secondary);
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.modal-detalles-content {
  padding: 20px;
}

.file-input-hidden {
  display: none;
}



/* =================================================================
    REFACTORIZACIN DE ESTILOS INLINE v6.0
   Este archivo contiene todas las clases CSS creadas para reemplazar
   los estilos inline del HTML principal - Mejoras visuales aplicadas
   ================================================================= */

/* ============================================================
   BARRA DE PROGRESO DE BACKUP
   ============================================================ */
#backupProgressBar {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 10000;
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  padding: 8px 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  border-bottom: 2px solid var(--primary);
}

.backup-progress-container {
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: 1400px;
  margin: 0 auto;
}

.backup-progress-loading {
  width: 16px;
  height: 16px;
  border-width: 2px;
}

.backup-progress-content {
  flex: 1;
}

.backup-progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.backup-progress-text {
  color: #fff;
  font-size: 0.85rem;
  font-weight: 600;
}

.backup-progress-percent {
  color: var(--primary);
  font-weight: 700;
  font-size: 0.85rem;
}

.backup-progress-bar-bg {
  background: rgba(0,0,0,0.3);
  height: 6px;
  border-radius: 3px;
  overflow: hidden;
}

.backup-progress-bar-fill {
  background: linear-gradient(90deg, var(--primary), #10b981);
  height: 100%;
  width: 0%;
  transition: width 0.3s ease;
  box-shadow: 0 0 10px var(--primary);
}

/* ============================================================
   TOOLBAR - BOTONES Y CONTROLES
   ============================================================ */
.btn-add-main {
  margin-right: 12px;
}

.toggle-label-custom {
  margin-right: 16px;
}

.btn-quitar-filtros {
  display: none;
  margin-right: 16px;
  padding: 8px 16px;
  font-size: 0.85rem;
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  border: none;
  color: white;
}

.connection-btn-custom {
  margin-left: 4px;
  padding: 8px 12px;
  cursor: default;
}

.search-box-custom {
  max-width: 350px;
  margin-left: auto;
}

/* ============================================================
   PAGINACIN
   ============================================================ */
.pagination-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  flex-wrap: wrap;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 12px;
  box-shadow: var(--shadow-md);
  margin: 20px 0;
}

.pagination-items-selector {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.pagination-nav {
  display: flex;
  align-items: center;
  gap: 8px;
}

.pagination-jump {
  display: flex;
  align-items: center;
  gap: 8px;
}

.pagination-input {
  width: 70px;
  padding: 8px 12px;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  background: var(--bg-primary);
  color: var(--text-primary);
  text-align: center;
  font-size: 0.9rem;
  font-weight: 600;
}

.pagination-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn-pagination {
  min-width: 40px !important;
  padding: 8px 12px !important;
  font-size: 1.1rem;
}

.btn-pagination-text {
  min-width: auto !important;
  padding: 10px 16px !important;
  font-size: 0.875rem !important;
  font-weight: 600;
  letter-spacing: 0.3px;
  text-transform: uppercase;
  transition: all 0.2s ease;
}

.btn-pagination-text span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.btn-pagination-text:hover:not(:disabled) {
  background: var(--primary);
  color: white;
  transform: translateY(-1px);
  box-shadow: var(--shadow-lg);
}

.btn-pagination:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.pagination-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  white-space: nowrap;
  font-weight: 500;
}

.pagination-select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  background: var(--bg-primary);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.9rem;
  min-width: 180px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.pagination-select:hover {
  border-color: var(--primary);
}

.pagination-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.pagination-info {
  font-size: 0.85rem;
  color: var(--text-secondary);
  opacity: 0.8;
  font-style: italic;
  margin-left: 4px;
}

.page-numbers-container {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
}

.page-number-btn {
  min-width: 44px !important;
  padding: 10px 14px !important;
  font-size: 0.9rem !important;
  font-weight: 600 !important;
  transition: all 0.2s ease;
  border-radius: 8px;
}

.page-number-btn:hover:not(:disabled) {
  background: var(--primary-light);
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.page-number-btn.page-active {
  background: var(--primary) !important;
  color: white !important;
  box-shadow: var(--shadow-lg);
  cursor: default;
  font-weight: 700 !important;
}

.pagination-status {
  color: var(--text-secondary);
  font-size: 0.875rem;
  margin-left: 16px;
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border-radius: 6px;
  white-space: nowrap;
  font-weight: 600;
  letter-spacing: 0.3px;
}

/* ============================================================
   VISTAS - LISTA Y TARJETAS
   ============================================================ */
.list-view-hidden {
  display: none;
}

/* ============================================================
   JERARQUA - TREE HEADER
   ============================================================ */
.tree-header-custom {
  font-size: 0.85rem;
  line-height: 1.6;
}

.tree-header-title {
  color: var(--primary);
}

/* ============================================================
   JERARQUA - BUSCADOR
   ============================================================ */
.jerarquia-search-container {
  padding: 16px;
  background: var(--bg-secondary);
  border-bottom: 2px solid var(--primary-color);
}

.jerarquia-search-wrapper {
  position: relative;
}

.jerarquia-search-clear {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  font-size: 1.2rem;
  color: var(--gray-500);
  cursor: pointer;
  padding: 4px 8px;
}

.jerarquia-search-results {
  margin-top: 8px;
  max-height: 300px;
  overflow-y: auto;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: none;
}

/* ============================================================
   JERARQUA - CONTROLES Y FILTROS
   ============================================================ */
.jerarquia-controls {
  padding: 12px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.toggle-tree-btn {
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.filtros-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  flex-wrap: wrap;
}

.filtros-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

.filtro-select {
  max-width: 200px;
}

.filtro-select-hidden {
  max-width: 180px;
  display: none;
}

.btn-limpiar-filtros {
  padding: 6px 12px;
  font-size: 0.85rem;
  display: none;
}

.jerarquia-counter {
  font-size: 0.85rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

/* ============================================================
   JERARQUA - BREADCRUMB
   ============================================================ */
.filtros-breadcrumb {
  padding: 8px 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-bottom: 1px solid var(--border-color);
  display: none;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  font-size: 0.85rem;
  color: white;
}

.breadcrumb-label {
  font-weight: 600;
}

.breadcrumb-path {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

/* ============================================================
   MAPAS - HEADERS
   ============================================================ */
.map-section-header-custom h3 {
  line-height: 28px;
}

.map-new-btn {
  white-space: nowrap;
}

.map-controls-wrapper {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}

/* ============================================================
   MAPAS - BUSCADOR Y FILTROS
   ============================================================ */
.map-search-container {
  padding: 8px 10px;
  background: var(--bg-secondary);
  border-radius: 6px;
  margin-bottom: 6px;
}

.map-search-input {
  width: 100%;
  padding: 6px 10px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.75rem;
  outline: none;
}

.map-category-filters {
  padding: 6px 10px;
  background: var(--bg-secondary);
  border-radius: 6px;
  margin-bottom: 8px;
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  align-items: center;
}

.map-category-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  font-weight: 600;
}

.map-category-filter-btn {
  padding: 3px 8px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.2s;
}

.map-category-filter-btn[data-category="all"] {
  background: var(--primary);
  color: white;
}

.map-category-filter-btn.active {
  background: var(--primary);
  color: white;
}

/* ============================================================
   UTILIDADES GENERALES
   ============================================================ */
.flex-center {
  display: flex;
  align-items: center;
}

.flex-between {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.gap-sm {
  gap: 6px;
}

.gap-md {
  gap: 12px;
}

.text-small {
  font-size: 0.85rem;
}

.text-tiny {
  font-size: 0.75rem;
}

.mb-sm {
  margin-bottom: 4px;
}

.mr-sm {
  margin-right: 8px;
}

.mr-md {
  margin-right: 16px;
}

/* ============================================================
   SECCIN DE MAPAS - ICONOS Y ELEMENTOS ADICIONALES
   ============================================================ */
.info-icon-small {
  font-size: 0.65rem;
}

.map-selection-badge {
  display: none;
  background: #10b981;
  color: white;
}

.map-btn-batch-hidden {
  display: none;
}

/* ============================================================
   ESTADSTICAS - TAB STATS
   ============================================================ */
.stats-title {
  margin-bottom: 24px;
  color: var(--primary);
}

.stats-details {
  margin-top: 30px;
}

/* ============================================================
   VALORES - TAB VALORES
   ============================================================ */
.valores-title {
  margin-bottom: 24px;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.valores-resumen {
  background: var(--bg-secondary);
  color: var(--text-primary);
  padding: 24px;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
}

.valores-tabs-container {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 8px;
  flex-wrap: wrap;
}

.tab-valores {
  flex: 1;
  min-width: 150px;
  padding: 12px 16px;
  border: none;
  border-radius: 8px 8px 0 0;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.9rem;
  text-align: center;
}

.tab-valores:not(.active) {
  background: var(--bg-primary);
  color: var(--text-secondary);
}

.tab-valores.active {
  background: var(--primary);
  color: white;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
}

/* ============================================================
   CONFIGURACIN - TAB CONFIG
   ============================================================ */
.config-title {
  margin-bottom: 20px;
  color: var(--primary);
}

.config-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 6px;
}

.config-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  padding: 16px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  border-radius: 10px;
  transition: all 0.2s;
  color: white;
  font-weight: 600;
  font-size: 1rem;
}

.config-content-hidden {
  display: none;
  padding-top: 16px;
}

.config-buttons-grid {
  display: grid;
  gap: 10px;
}

.config-btn-full {
  width: 100%;
  padding: 12px;
}

.config-btn-secondary {
  background: var(--secondary);
  color: white;
}

.config-btn-danger {
  background: var(--danger);
  color: white;
}

/* ===== INDICADOR DE CARGA INICIAL ===== */
#loadingIndicator {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  color: white;
  font-family: 'Segoe UI', sans-serif;
}

.loading-icon {
  font-size: 48px;
  margin-bottom: 20px;
}

.loading-title {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 10px;
}

.loading-text {
  font-size: 14px;
  opacity: 0.7;
}

.loading-bar-container {
  margin-top: 30px;
  width: 200px;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  overflow: hidden;
}

.loading-bar {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, #5b8bb4, #6ea8d4);
  animation: loadBar 2s ease-in-out infinite;
}

@keyframes loadBar {
  0% { width: 0%; margin-left: 0%; }
  50% { width: 75%; margin-left: 0%; }
  100% { width: 0%; margin-left: 100%; }
}

/* ===== RESTO DEL CSS OMITIDO POR BREVEDAD - SE APLICAR COMPLETO ===== */
    
  </style>
  
  <!-- SheetJS para exportacin Excel profesional -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script> -->
  
  <!-- jsPDF para exportacin PDF con imgenes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- JSZip para compresin de backups completos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- Sistema de modales redimensionables y arrastrables -->
  <script src="scripts/modal-resizable.js"></script>
</head>
<body>

<!--  INDICADOR DE CARGA INICIAL -->
<div id="loadingIndicator">
  <div class="loading-icon">📦</div>
  <div class="loading-title">Inventario v6.0</div>
  <div class="loading-text">Cargando aplicación...</div>
  <div class="loading-bar-container">
    <div class="loading-bar"></div>
  </div>
</div>

<!--  MODAL DE CARGA CON BARRA DE PROGRESO -->
<div id="loadingModal" class="loading-modal">
  <div class="loading-modal-content">
    <div class="loading-modal-icon">🔄</div>
    <div class="loading-modal-title">Conectando...</div>
    <div class="loading-modal-status" id="loadingModalStatus">Inicializando módulos</div>
    <div class="loading-modal-text" id="loadingModalText">Preparando sesión FileSystem</div>
    <div class="loading-progress-container">
      <div class="loading-progress-bar" id="loadingProgressBar" style="width: 0%"></div>
    </div>
    <div class="loading-progress-text" id="loadingProgressText">0%</div>
    <div class="loading-modal-tip" id="loadingModalTip">Consejo: No cierres la ventana mientras sincronizamos tu carpeta.</div>
  </div>
</div>

<!--  CAMPANA DE NOTIFICACIONES PERSISTENTE -->
<div id="notificationBell" class="notification-bell" title="Notificaciones" onclick="
  console.log(' CLICK DIRECTO EN ONCLICK!');
  const panel = document.getElementById('notificationPanel');
  if (panel.classList.contains('active')) {
    panel.classList.remove('active');
    console.log(' Panel CERRADO');
  } else {
    panel.classList.add('active');
    console.log(' Panel ABIERTO');
  }
">
  🔔
  <span id="notificationCounter" class="notification-counter">0</span>
</div>

<!--  PANEL DE NOTIFICACIONES -->
<div id="notificationPanel" class="notification-panel">
  <!-- Encabezado -->
  <div class="notification-panel-header">
    <div class="notification-panel-title">
      <span>🔔</span>
      <span>Notificaciones</span>
    </div>
    <div class="notification-panel-actions">
      <button class="notification-panel-action" onclick="window.markAllNotificationsAsRead()">
        Marcar leídas
      </button>
      <button class="notification-panel-action" onclick="window.clearAllNotifications()">
        Limpiar todo
      </button>
    </div>
  </div>
  
  <!-- Lista de notificaciones -->
  <div id="notificationList" class="notification-list">
    <!-- Se llena dinámicamente -->
  </div>
</div>

<!--  BARRA DE PROGRESO DE BACKUP AUTOMTICO -->
<div id="backupProgressBar">
  <div class="backup-progress-container">
    <div class="loading backup-progress-loading"></div>
    <div class="backup-progress-content">
      <div class="backup-progress-header">
        <span class="backup-progress-text">Creando backup automtico...</span>
        <span id="backupProgressPercent" class="backup-progress-percent">0%</span>
      </div>
      <div class="backup-progress-bar-bg">
        <div id="backupProgressFill" class="backup-progress-bar-fill"></div>
      </div>
    </div>
  </div>
</div>

<!-- CONTENEDOR FIJO SUPERIOR -->
<div class="sticky-header-container">
  <!--  ELIMINADO: Ttulo "Inventario Visual" e indicador de conexin movido -->

  <!-- NAVEGACIN - DENTRO DEL CONTENEDOR STICKY -->
  <div class="nav-tabs">
    <button class="nav-tab active" data-tab="inventario">
      Inventario
    </button>
    <button class="nav-tab" data-tab="jerarquia">
      Jerarqua
    </button>
    <button class="nav-tab" data-tab="mapa">
      Mapa
    </button>
    <button class="nav-tab" data-tab="stats">
      Stats
    </button>
    <button class="nav-tab" data-tab="valores">
      Valores
    </button>
    <button class="nav-tab" data-tab="configuracion">
      Configuracin
    </button>
  </div>

  <div class="app-warmup-progress" id="appWarmupProgress">
    <div class="warmup-progress-label" id="appWarmupProgressLabel">Preparando aplicación...</div>
    <div class="warmup-progress-track">
      <div class="warmup-progress-fill" id="appWarmupProgressFill"></div>
    </div>
  </div>
</div>

<!-- CONTENEDOR PRINCIPAL -->
<div class="container">
  <!-- TAB INVENTARIO -->
  <div id="inventario" class="tab-content active">
    <div class="toolbar">
      <!-- GRUPO 1: ACCIONES PRINCIPALES -->
      <div class="toolbar-group">
        <button class="glass-btn glass-btn-primary" onclick="app.openModal('add')">
          <span>Agregar Repuesto</span>
        </button>
        
        <button class="glass-btn" id="quitarFiltrosJerarquicosBtn" onclick="app.quitarFiltrosJerarquicos()" title="Quitar filtros aplicados desde jerarquía">
          Quitar Filtros
        </button>
      </div>
      
      <!-- GRUPO 2: VISUALIZACIÓN -->
      <div class="toolbar-group">
        <div class="toggle-wrapper" id="togglePrecioBtn" onclick="app.togglePrecio()" title="Mostrar u ocultar columna de precio">
          <div class="toggle-track">
            <div class="toggle-thumb"></div>
          </div>
          <span class="toggle-label">Precio</span>
        </div>
        
        <div class="view-toggle">
          <button class="view-toggle-btn active" data-view="cards" onclick="app.toggleView(this, 'cards')">Tarjetas</button>
          <button class="view-toggle-btn" data-view="list" onclick="app.toggleView(this, 'list')">Lista</button>
        </div>
        
        <button class="glass-btn connection disconnected" id="connectionBtn" title="Estado de conexión con la carpeta">
          Desconectado
        </button>
      </div>
      
      <!-- GRUPO 3: CONTROLES DE ZOOM -->
      <div class="toolbar-group">
        <div class="glass-zoom-controls">
          <button onclick="zoomOut()" class="glass-zoom-btn" title="Alejar">−</button>
          <div class="glass-zoom-display" id="zoomLevel">100%</div>
          <button onclick="zoomIn()" class="glass-zoom-btn" title="Acercar">+</button>
          <button onclick="zoomReset()" class="glass-zoom-btn" title="Restablecer">⟲</button>
        </div>
      </div>
      
      <!-- GRUPO 4: BÚSQUEDA -->
      <div class="toolbar-group toolbar-group-search">
        <div class="glass-search">
          <span class="search-icon">🔍</span>
          <input type="text" id="searchInput" placeholder="Buscar...">
        </div>
        <button onclick="clearSearch()" class="glass-action-btn" title="Limpiar búsqueda">✕</button>
        <div class="toolbar-separator"></div>
        <button onclick="undoAction()" class="glass-action-btn" title="Deshacer (Ctrl+Z)">↶</button>
        <button onclick="redoAction()" class="glass-action-btn" title="Rehacer (Ctrl+Y)">↷</button>
      </div>
    </div>

    <div class="filters-selects">
      <select class="filter-select" id="filterArea" onchange="app.applyFilters()" aria-label="Filtrar por rea">
        <option value="">Todas las reas</option>
      </select>
      
      <select class="filter-select" id="filterEquipo" onchange="app.applyFilters()" aria-label="Filtrar por equipo">
        <option value="">Todos los Equipos</option>
      </select>
      
      <select class="filter-select" id="filterTipo" onchange="app.applyFilters()" aria-label="Filtrar por tipo">
        <option value="">Todos los Tipos</option>
      </select>
      
      <select class="filter-select" id="filterStock" onchange="app.applyFilters()" aria-label="Filtrar por stock">
        <option value="">Ver Todos</option>
        <option value="agotado">Agotados (0 unid.)</option>
        <option value="critico">Crticos (bajo mnimo)</option>
        <option value="adecuado">Adecuados (entre mn-pt)</option>
        <option value="optimo">ptimos (sobre ptimo)</option>
      </select>
    </div>

    <!-- PAGINACIN -->
    <div id="pagination" class="pagination-controls">
      <div class="pagination-items-selector">
        <label class="pagination-label">Items por pgina:</label>
        <select id="itemsPerPageSelect" onchange="app.changeItemsPerPage(this.value)" class="pagination-select" aria-label="Seleccionar items por pgina">
          <option value="auto">Auto (Responsive)</option>
          <option value="12">12 items</option>
          <option value="18">18 items</option>
          <option value="21">21 items</option>
          <option value="24">24 items</option>
          <option value="30">30 items</option>
          <option value="40">40 items</option>
          <option value="50">50 items</option>
          <option value="100">100 items</option>
        </select>
        <span id="itemsPerPageInfo" class="pagination-info"></span>
      </div>
      
      <div class="pagination-nav">
        <button onclick="app.goToPage(1)" class="btn btn-secondary btn-pagination btn-pagination-text" id="btnFirstPage" title="Ir a la primera pgina">
          <span> Primera</span>
        </button>
        <button onclick="app.previousPage()" class="btn btn-secondary btn-pagination btn-pagination-text" id="btnPrevPage" title="Pgina anterior">
          <span> Anterior</span>
        </button>
        
        <div id="pageNumbers" class="page-numbers-container"></div>
        
        <button onclick="app.nextPage()" class="btn btn-secondary btn-pagination btn-pagination-text" id="btnNextPage" title="Pgina siguiente">
          <span>Siguiente </span>
        </button>
        <button onclick="app.goToPage('last')" class="btn btn-secondary btn-pagination btn-pagination-text" id="btnLastPage" title="Ir a la ltima pgina">
          <span>ltima </span>
        </button>
      </div>
      
      <div class="pagination-jump">
        <label class="pagination-label">Ir a pgina:</label>
        <input type="number" id="jumpToPage" min="1" class="pagination-input" placeholder="#" onkeypress="if(event.key==='Enter') app.jumpToPage()" aria-label="Nmero de pgina">
        <button onclick="app.jumpToPage()" class="btn btn-primary btn-sm" title="Ir a pgina">
          Ir
        </button>
      </div>
    </div>

    <div id="inventarioContent">
      <div class="cards-grid" id="cardsGrid"></div>
      <div class="list-view list-view-hidden" id="listView"></div>
    </div>
  </div>

  <!-- TAB JERARQUA -->
  <div id="jerarquia" class="tab-content">
    <!--  RBOL JERRQUICO ORGANIZACIONAL -->
    <div class="jerarquia-config-container full-width">
      
      <!-- 🔍 BARRA DE CONTROLES -->
      <div class="jerarquia-controls-bar">
        <div class="jerarquia-search-wrapper">
          <span class="jerarquia-search-icon">🔍</span>
          <input 
            type="text" 
            id="jerarquiaTreeSearchInput" 
            class="jerarquia-search-input"
            placeholder="Buscar en la jerarquía..."
            autocomplete="off"
          />
          <div id="jerarquiaSearchSuggestions" class="jerarquia-search-suggestions"></div>
        </div>
        <button onclick="clearJerarquiaSearch()" class="glass-action-btn" title="Limpiar búsqueda">✕</button>
        <div class="toolbar-separator"></div>
        <button onclick="undoAction()" class="glass-action-btn" title="Deshacer (Ctrl+Z)">↶</button>
        <button onclick="redoAction()" class="glass-action-btn" title="Rehacer (Ctrl+Y)">↷</button>
        <div class="toolbar-separator"></div>
        
        <!-- Botones Expandir/Contraer -->
        <button class="jerarquia-expand-btn" onclick="app.expandirTodoJerarquia()" title="Expandir todo">
          <span class="expand-label">Expandir</span>
        </button>
        <button class="jerarquia-expand-btn" onclick="app.contraerTodoJerarquia()" title="Contraer todo">
          <span class="expand-label">Contraer</span>
        </button>
        <div class="toolbar-separator"></div>
        <button class="jerarquia-expand-btn debug-btn" onclick="debugPersistencia()" title="Ver estados en consola">
          <span class="expand-label">🐛 Debug</span>
        </button>
        <button class="jerarquia-expand-btn reset-btn" onclick="resetPersistencia()" title="Limpiar estados guardados">
          <span class="expand-label">🗑️ Reset</span>
        </button>
      </div>
      </div>
      
      <div id="jerarquiaTreeContainer" class="palette-visual">
        <!-- Se llenará dinámicamente con el árbol visual -->
      </div>
      
      <!-- Botón guardar en la parte inferior -->
      <div class="jerarquia-save-container">
        <button id="btnGuardarJerarquia" onclick="app.guardarCambiosJerarquia()" 
                class="btn btn-success jerarquia-save-btn">
           Guardar Cambios
        </button>
      </div>
    </div>
  </div>

  <!-- 
  
   MAPA ANTIGUO COMENTADO COMO BACKUP (FASE 1)
  
  Si el nuevo mapa falla, puedes descomentar esto y comentar el nuevo.
  
  <div id="mapa" class="tab-content">
    <div class="map-container">
      <h2 class="mapa-legacy-title">Mapa de Ubicaciones</h2>
      
      <div class="map-controls">
        <button class="tool-btn" onclick="document.getElementById('mapImageInput').click()">
          Cargar Imagen
        </button>
        <input type="file" id="mapImageInput" accept="image/*" class="hidden-file-input" onchange="app.loadMapImage(event)">
        
        <button class="tool-btn active" data-tool="select" onclick="app.selectTool('select')">
          Seleccionar
        </button>
        <button class="tool-btn" data-tool="rect" onclick="app.selectTool('rect')">
          Rectngulo
        </button>
        <button class="tool-btn" data-tool="circle" onclick="app.selectTool('circle')">
          Crculo
        </button>
        <button class="tool-btn" data-tool="machine" onclick="app.selectTool('machine')">
          Mquina
        </button>
        <button class="tool-btn" data-tool="delete" onclick="app.selectTool('delete')">
          Eliminar
        </button>
        <button class="btn btn-success" onclick="app.saveMap()">
          Guardar Mapa
        </button>
      </div>
      
      <canvas id="mapCanvas"></canvas>
    </div>
  </div>
  
  -->
  
  <!--  🏥 TRASPLANTE VISUAL DEL PROTOTIPO - Tab Mapas v6.0 -->
  <!-- TAB MAPA -->
  <div id='mapa' class='tab-content mapas-tab'>
    <div class='map-shell'>
      <!-- PANEL LATERAL CON TABS -->
      <aside class='map-panel'>
        <div class='map-panel-header'>
          <h2>Mapas de planta</h2>
          <p>Gestiona mapas, zonas y jerarquías</p>
        </div>

        <!-- TABS DE NAVEGACIÓN -->
        <div class='panel-tabs'>
          <button class='panel-tab active' onclick='switchPanelTab("mapas")'>
            <span class='panel-tab-text'>Mapas</span>
            <span class='panel-tab-badge'>-</span>
          </button>
          <button class='panel-tab' onclick='switchPanelTab("logs")'>
            <span class='panel-tab-text'>Logs</span>
          </button>
        </div>

        <!-- CONTENIDO: MAPAS -->
        <div id='tabMapas' class='panel-tab-content active'>
          <!-- Sidebar de subsecciones -->
          <nav class='subsections-sidebar' id='subsectionsSidebar'>
            <button class='subsection-item active' onclick='scrollToSection("jerarquia-completa")'>
              <span class='subsection-icon'>J</span>
              <span class='subsection-label'>Jerarquía Completa</span>
            </button>
            <button class='subsection-item' onclick='scrollToSection("mapas-creados")'>
              <span class='subsection-icon'>M</span>
              <span class='subsection-label'>Mapas Creados</span>
            </button>
            <button class='subsection-item' onclick='scrollToSection("pendientes")'>
              <span class='subsection-icon'>P</span>
              <span class='subsection-label'>Pendientes</span>
            </button>
            <button class='subsection-item' onclick='scrollToSection("estadisticas")'>
              <span class='subsection-icon'>E</span>
              <span class='subsection-label'>Estadísticas</span>
            </button>
          </nav>

          <!-- Contenedor del contenido -->
          <div class='tab-content-wrapper'>
            <!-- Área fija -->
            <div class='tab-fixed-header'>
              <!-- Buscador global -->
              <div class='search-container'>
                <input type='text' id='globalSearch' class='search-input' placeholder='🔎 Buscar en jerarquía...' oninput='filterHierarchy(this.value)'>
              </div>

              <!-- Stats generales -->
              <div class='stats-row' style='margin-top: 6px;'>
                <div class='stat-card'>
                  <div class='stat-value' id='statsMapasCount'>-</div>
                  <div class='stat-label'>Mapas</div>
                </div>
                <div class='stat-card'>
                  <div class='stat-value' id='statsAreasCount'>-</div>
                  <div class='stat-label'>Áreas</div>
                </div>
                <div class='stat-card'>
                  <div class='stat-value' id='statsMarcadoresCount'>-</div>
                  <div class='stat-label'>Marcadores</div>
                </div>
              </div>
            </div>

            <!-- Área con scroll -->
            <div class='tab-scroll-content'>

          <!-- 1. JERARQUÍA COMPLETA - SECCIÓN PRINCIPAL -->
          <section class='map-section' id='section-jerarquia-completa'>
            <div class='map-section-header' onclick='toggleSection(this)'>
              <h3><span class='collapse-icon'>▼</span> 🏢 Jerarquía Completa</h3>
            </div>
            <div class='section-content'>
              <div style='font-size: 0.6rem; color: var(--text-muted); margin-bottom: 8px; padding: 6px 8px; background: rgba(59, 130, 246, 0.05); border-radius: 4px; border-left: 2px solid var(--primary);'>
                💡 <strong>Indicadores:</strong> 🗺️ Mapa asignado • 📦 Área creada • 📍 Marcadores (numerados)
              </div>
              <div id='hierarchy-tree-container' class='area-tree'>
                <!-- La jerarquía completa se cargará dinámicamente aquí -->
              </div>
            </div>
          </section>

          <!-- 2. MAPAS CREADOS - LISTA COMPACTA -->
          <section class='map-section' id='section-mapas-creados'>
            <div class='map-section-header' onclick='toggleSection(this)'>
              <h3><span class='collapse-icon'>▼</span> 🗺️ Mapas Creados (<span id='mapasCount'>0</span>)</h3>
            </div>
            <div class='section-content' id='mapList'>
              <!-- Los mapas se cargarán dinámicamente desde mapas.json -->
            </div>
          </section>

          <!-- 3. PENDIENTES - ELEMENTOS SIN ASIGNAR -->
          <section class='map-section' id='section-pendientes'>
            <div class='map-section-header' onclick='toggleSection(this)'>
              <h3><span class='collapse-icon'>▼</span> ⚠️ Pendientes</h3>
            </div>
            <div class='section-content' id='pendientesList'>
              <div style='font-size: 0.62rem; color: var(--text-muted); padding: 12px; text-align: center;'>
                Cargando elementos pendientes...
              </div>
            </div>
          </section>

          <!-- 4. ESTADÍSTICAS - RESUMEN VISUAL -->
          <section class='map-section' id='section-estadisticas'>
            <div class='map-section-header' onclick='toggleSection(this)'>
              <h3><span class='collapse-icon'>▼</span> 📊 Estadísticas</h3>
            </div>
            <div class='section-content'>
              <div id='stats-details-container'>
                <!-- Estadísticas detalladas se cargarán aquí -->
              </div>
            </div>
          </section>

          </div> <!-- Fin tab-scroll-content -->
          </div> <!-- Fin tab-content-wrapper -->
        </div> <!-- Fin tabMapas -->

        <!-- CONTENIDO: LOGS -->
        <div id='tabLogs' class='panel-tab-content'>
          <!-- Área fija superior: Filtros -->
          <div class='tab-fixed-header'>
            <section class='map-section' style='margin: 0;'>
              <div class='map-section-header' onclick='toggleSection(this)'>
                <h3><span class='collapse-icon'>▼</span> Filtrar por Tipo</h3>
              </div>
              <div class='section-content'>
                <div class='filter-chips'>
                  <span class='filter-chip active' onclick='filterLogs("all")'>Todos</span>
                  <span class='filter-chip' onclick='filterLogs("success")'>Creación</span>
                  <span class='filter-chip' onclick='filterLogs("edit")'>Edición</span>
                  <span class='filter-chip' onclick='filterLogs("delete")'>Eliminación</span>
                  <span class='filter-chip' onclick='filterLogs("marker")'>Marcadores</span>
                  <span class='filter-chip' onclick='filterLogs("warning")'>Jerarquía</span>
                </div>
              </div>
            </section>
          </div>

          <!-- Área con scroll: Actividad Reciente -->
          <div class='tab-scroll-content' style='flex: 1; overflow-y: auto;'>
            <div class='log-timeline' id='logTimeline'>
              <div class='log-item log-success'>
                <div class='log-icon'>✓</div>
                <div class='log-content'>
                  <div class='log-message'>Sistema inicializado correctamente</div>
                  <div class='log-time'>Ahora</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Área fija inferior: Controles -->
          <div style='padding: 8px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);'>
            <div style='display: flex; gap: 6px; align-items: center;'>
              <label style='display: flex; align-items: center; gap: 6px; font-size: 0.7rem; color: var(--text-secondary); cursor: pointer;'>
                <input type='checkbox' id='autoRefreshLogs' checked style='cursor: pointer;'>
                Actualizar logs
              </label>
              <button class='action-btn' onclick='refreshLogs()' style='flex: 1; padding: 5px 8px; font-size: 0.65rem;'>
                🔄 Refrescar ahora
              </button>
            </div>
          </div>
        </div>
      </aside>

      <!-- WORKSPACE CANVAS -->
      <div class='map-workspace'>
        <div class='map-toolbar'>
          <div class='toolbar-section'>
            <button class='toolbar-btn' onclick='mapController.zoomIn()'>+ Zoom</button>
            <button class='toolbar-btn' onclick='mapController.zoomOut()'>- Zoom</button>
            <button class='toolbar-btn' onclick='mapController.resetView()'>Reset</button>
          </div>
          <div class='toolbar-section'>
            <span id='mapToolbarInfo' style='font-size: 0.8rem; color: var(--text-secondary)'>100% | Mapa General</span>
          </div>
          <div class='toolbar-section'>
            <button class='toolbar-btn' onclick='mapController.toggleNombres()'>Nombres</button>
            <button class='toolbar-btn' onclick='mapController.togglePuntos()'>Puntos</button>
            <button class='toolbar-btn' onclick='mapController.toggleGrid()'>Rejilla</button>
            <button class='toolbar-btn' onclick='mapController.toggleMinimap()'>Minimap</button>
          </div>
        </div>

        <div class='map-canvas-stage'>
          <canvas id='mapCanvas' class='map-canvas'></canvas>
          <div id='mapHint' class='map-hint hidden'></div>
          <div id='mapTooltip' class='map-tooltip hidden'></div>
        </div>
      </div>
    </div>

    <!-- MODALES (mantener compatibilidad) -->
    <div id='mapModalOverlay' class='map-modal hidden'>
      <div class='map-modal-content'>
        <div class='map-modal-header'>
          <h3 id='mapModalTitle'>Modal</h3>
          <button id='mapModalClose' class='map-icon-btn'>X</button>
        </div>
        <div id='mapModalBody' class='map-modal-body'></div>
      </div>
    </div>

    <div id='mapLoadingOverlay' class='map-loading-overlay hidden'>
      <div class='map-loading-modal'>
        <div class='map-loading-header'>
          <div class='map-loading-icon'>🗺️</div>
          <div>
            <div id='mapLoadingTitle' class='map-loading-title'>Preparando mapa</div>
            <div id='mapLoadingStatus' class='map-loading-status'>Inicializando...</div>
          </div>
        </div>
        <div class='map-loading-bar'>
          <div id='mapLoadingBar' class='map-loading-bar-fill'></div>
        </div>
        <div id='mapLoadingPercent' class='map-loading-percent'>0%</div>
        <div class='map-loading-hint'>Cargando recursos del mapa...</div>
      </div>
    </div>
  </div>

  <!-- TAB STATS -->
  <div id="stats" class="tab-content">
    <h2 class="stats-title">Estadsticas y Mtricas de Decisin</h2>
    <div class="stats-grid" id="statsGrid"></div>
    <div id="statsDetails" class="stats-details"></div>
  </div>

  <!-- TAB VALORES -->
  <div id="valores" class="tab-content">
    <h2 class="valores-title">
      Desglose Detallado de Valores del Inventario
    </h2>
    
    <!-- Resumen General -->
    <div id="valoresResumen" class="valores-resumen"></div>
    
    <!-- Tabs de Valores -->
    <div class="valores-tabs-container">
      <button onclick="app.switchValoresTab('area')" id="tabArea" class="tab-valores active">
        Por rea
      </button>
      <button onclick="app.switchValoresTab('equipo')" id="tabEquipo" class="tab-valores">
        Por Equipo
      </button>
      <button onclick="app.switchValoresTab('tipo')" id="tabTipo" class="tab-valores">
        Por Tipo
      </button>
      <button onclick="app.switchValoresTab('top')" id="tabTop" class="tab-valores">
        Top 10
      </button>
    </div>
    
    <!-- Contenido de Tabs -->
    <div id="valoresTabContent"></div>
  </div>

  <!-- TAB CONFIGURACIN -->
  <div id="configuracion" class="tab-content">
    <h2 class="config-title">Configuracin</h2>
    
    <div class="config-grid">
      <!-- ALMACENAMIENTO -->
      <div id="storage-config-container" class="config-card">
        <div id="storage-config-content"></div>
      </div>

      <!-- EXPORTACIN Y REPORTES -->
      <div class="config-card">
        <h3 onclick="toggleConfigSection('export-config')" class="config-section-header">
          <span id="export-config-icon"></span>
          <span> Exportacin y Reportes</span>
        </h3>
        
        <div id="export-config-content" class="config-section-content">
          <div class="config-buttons-container">
            <button onclick="configuracion.exportarHTMLConDatosEmbebidos()" class="btn config-btn-mobile">
               Exportar HTML para Mvil
            </button>

            <button onclick="configuracion.exportarExcel()" class="btn btn-primary config-btn-full">
               Exportar a Excel
            </button>
            
            <button onclick="configuracion.mostrarOpcionesPDF()" class="btn config-btn-pdf">
               Exportar a PDF
            </button>
          </div>
        </div>
      </div>

      <!-- SISTEMA DE BACKUPS Y RESPALDOS -->
      <div class="config-card">
        <h3 onclick="toggleConfigSection('backup-config')" class="config-section-header">
          <span id="backup-config-icon"></span>
          <span> Sistema de Backups y Respaldos</span>
        </h3>
        
        <div id="backup-config-content" class="config-section-content">
          <!-- Estructura de carpetas -->
          <div class="backup-structure">
            <strong class="backup-structure-title"> Estructura de Backups:</strong><br>
            <div class="backup-structure-path">
              INVENTARIO_STORAGE/<br>
               <strong class="backup-file-name">repuestos.json</strong> <span class="backup-file-hint"> Pegar aqu JSON de repuestos</span><br>
               <strong class="backup-file-name">mapas.json</strong> <span class="backup-file-hint"> Pegar aqu JSON de mapas</span><br>
               <strong class="backup-file-name">zonas.json</strong> <span class="backup-file-hint"> Pegar aqu JSON de reas</span><br>
               imagenes/ <span class="backup-file-hint backup-file-hint-special"> Copiar aqu carpeta de imgenes completa</span><br>
               backups/<br>
              &nbsp;&nbsp;&nbsp;&nbsp; automaticos/ <span class="backup-file-name"> Backups automticos (5 ltimos)</span>
            </div>
            <div class="backup-manual-guide">
              <strong class="backup-manual-title"> Para actualizar manualmente:</strong><br>
              <small class="backup-guide-text">
                1. Pega el JSON en el archivo correspondiente (repuestos.json, mapas.json, zonas.json)<br>
                2. Copia las imgenes a la carpeta imagenes/<br>
                3. Recarga la app (F5) para ver los cambios<br>
                4. La app crear un backup automtico al guardar
              </small>
          </div>
        </div>
        
        <!--  ESTADO DEL SISTEMA DE BACKUP AUTOMTICO -->
        <div id="backupStatusPanel" class="backup-status-panel-container">
          <div class="backup-status-header">
            <div id="backupStatusIcon" class="backup-status-icon"></div>
            <div class="backup-status-content">
              <div class="backup-status-title">Sistema de Backup Automtico</div>
              <div id="backupStatusText" class="backup-status-text">Inicializando...</div>
            </div>
          </div>
          
          <div class="backup-metrics-grid">
            <div class="backup-metric-card">
              <div class="backup-metric-label">ltimo backup</div>
              <div id="backupLastTime" class="backup-metric-value">---</div>
            </div>
            <div class="backup-metric-card">
              <div class="backup-metric-label">Inactividad</div>
              <div id="backupCountdown" class="backup-metric-value">---</div>
            </div>
            <div class="backup-metric-card">
              <div class="backup-metric-label">Prximo backup</div>
              <div id="backupNextTime" class="backup-metric-value">Al detectar inactividad</div>
            </div>
          </div>
          
          <div id="backupPendingChanges" class="backup-pending-changes">
            <small class="config-small-text">
               <strong>Hay cambios pendientes</strong> - Se crear backup cuando el sistema detecte 1 minuto de inactividad
            </small>
          </div>
        </div>
        
        <div class="config-buttons-container">
          <button onclick="configuracion.mostrarGestionBackups()" class="btn btn-primary config-btn-full">
             Ver Historial de Backups Automticos
          </button>
          
          <button onclick="configuracion.crearBackupManual()" class="btn btn-success config-btn-full">
             Crear Backup Manual Ahora
          </button>
          
          <div class="config-divider">
            <small class="config-small-text">
              <strong> Respaldo Completo ZIP:</strong> Incluye datos + mapas + imgenes. Ideal para migrar entre versiones o copiar toda la carpeta backups/ a otra instalacin.
            </small>
            
            <button onclick="configuracion.exportarRespaldoCompleto()" class="btn config-btn-warning">
               Crear Respaldo Completo ZIP
            </button>
            
            <button onclick="configuracion.cargarRespaldoCompleto()" class="btn config-btn-info">
               Cargar Respaldo Completo ZIP
            </button>
          </div>
          
          <div class="config-divider config-divider-margin">
            <small class="config-small-text">
              <strong> Exportar App Portable Completa:</strong> Genera un ZIP con toda la aplicacin y tus datos para llevarlo a otro PC.
            </small>
            
            <button onclick="configuracion.exportarAppCompleta()" class="btn config-btn-gradient">
               Exportar App Portable Completa
            </button>
          </div>
        </div>
        
        <div class="config-success-note">
          <small class="config-small-text config-small-text-line-height">
            <strong> Sistema de Backups Automticos COMPLETOS:</strong><br>
             Se crean automticamente al guardar cambios<br>
             <strong>Incluyen JSON + TODAS las imgenes</strong><br>
             Se mantienen los ltimos 5 backups completos<br>
             El ms antiguo se elimina automticamente (JSON + imgenes)<br>
             <strong>Restauracin automtica:</strong> Datos + Imgenes en un solo click<br>
             <strong>Para migrar:</strong> Copia toda la carpeta <code class="config-inline-code">INVENTARIO_STORAGE/backups/automaticos/</code> a la nueva versin
          </small>
        </div>
        </div> <!-- Fin backup-config-content -->
      </div>
    </div>

    <!-- GESTIN DE LISTAS DESPLEGABLES -->
    <div class="listas-config-container">
      <h3 onclick="toggleConfigSection('listas-config')" class="config-section-header">
        <span id="listas-config-icon"></span>
        <span> Gestin de Listas de Autocompletado</span>
      </h3>
      
      <div id="listas-config-content" class="config-section-content">
        <p class="listas-config-description">
          Administra los valores de autocompletado.
        </p>

        <div class="listas-grid">
        
        <!-- TIPOS -->
        <div class="lista-card">
          <h4 class="lista-title">
            Tipos de Repuesto
          </h4>
          <div id="listaTipo" class="lista-content">
            <!-- Se llenar dinmicamente -->
          </div>
          <div class="lista-input-group">
            <input type="text" id="nuevoTipo" placeholder="Nuevo tipo..." class="lista-input">
            <button onclick="app.agregarItemLista('tipo')" class="btn btn-success lista-add-btn">
              +
            </button>
          </div>
        </div>

        <!-- JERARQUIA REDIRIGIDA -->
        <div class="lista-card lista-card-info">
          <h4 class="lista-title jerarquia-note-title">
            <span class="lista-badge lista-badge-n2">N2-N7</span>
            Jerarquia corporativa
          </h4>
          <p class="jerarquia-note-text">
            Los niveles Empresa, area, Sub-area, Sistema y Seccion se sincronizan ahora desde la pestana Jerarquia. Edita el arbol y los catalogos se actualizaran automaticamente en los formularios.
          </p>
          <ul class="jerarquia-note-list">
            <li>Usa <strong>Jerarquia &gt; Arbol corporativo</strong> para agregar niveles.</li>
            <li>Las areas y repuestos toman sugerencias directo del arbol.</li>
            <li>Esta tarjeta es solo informativa; no hay mas listas manuales.</li>
          </ul>
          <div class="jerarquia-note-tip">
            Consejo: mantn la jerarquia limpia y anidada para que la busqueda y los badges N1..N6 se sincronicen con tus mapas.
          </div>
        </div>

      </div>
      </div> <!-- Fin listas-config-content -->
    </div>

    <!--  CATEGORAS DE REAS DEL MAPA -->
    <div class="config-section">
      <div class="config-section-header-row">
        <div onclick="toggleConfigSection('herramientas-config')" class="config-section-clickable">
          <div class="config-section-title-row">
            <span id="herramientas-config-icon"></span>
            <h3 class="config-section-title">
               Categoras de reas del Mapa
            </h3>
          </div>
        </div>
        <button onclick="event.stopPropagation(); app.agregarNuevaCategoria()" 
                class="config-btn-add-category">
          <span class="config-btn-icon"></span> Nueva Categora
        </button>
      </div>
      
      <div id="herramientas-config-content" class="config-section-content-hidden">
        <p class="config-description">
          Gestiona las categoras que se pueden asignar a las reas del mapa
        </p>

        <div class="categorias-container">
        <div id="listaCategoriasAreas" class="categorias-grid">
          <!-- Se llenar dinmicamente -->
        </div>
        
        <div id="mensajeNoCategoriasAreas" class="mensaje-no-categorias">
          <div class="mensaje-no-categorias-icon"></div>
          <p class="mensaje-no-categorias-text">No hay categoras configuradas</p>
          <small class="mensaje-no-categorias-small">Haz clic en "Nueva Categora" para agregar una</small>
        </div>
      </div>

      <!-- Informacin sobre sincronizacin -->
      <div class="config-info-box">
        <div class="config-info-content">
          <span class="config-info-icon"></span>
          <div>
            <p class="config-info-title">
              Sincronizacin Automtica
            </p>
            <p class="config-info-description">
              Las categoras se sincronizan automticamente con los mapas. Al editar una categora, todos los mapas se actualizarn instantneamente.
              Las categoras eliminadas se removern de las reas que las usen.
            </p>
          </div>
        </div>
      </div>
      </div> <!-- Fin herramientas-config-content -->
    </div>
  </div>
</div>

<!-- MODAL FORMULARIO -->
<div class="modal" id="modal">
  <div class="modal-content">
  <button class="modal-close" onclick="app.closeModal()" title="Cerrar" aria-label="Cerrar"></button>
    <form id="repuestoForm" onsubmit="app.saveRepuesto(event)" class="sap-modal-form">
      <input type="hidden" id="repuestoId">

      <div class="sap-form-grid">
        <div class="modal-scroll">
          <div class="wizard-timeline" id="wizardTimeline">
                <button type="button" class="wizard-step-indicator is-active" data-step="1">
                  <span class="wizard-step-number">1</span>
                  <div class="wizard-step-meta">
                    <span class="wizard-step-label">Identificacin</span>
                    <span class="wizard-step-helper">Cdigos y descripcin</span>
                  </div>
                </button>
                <button type="button" class="wizard-step-indicator" data-step="2">
                  <span class="wizard-step-number">2</span>
                  <div class="wizard-step-meta">
                    <span class="wizard-step-label">Stock & polticas</span>
                    <span class="wizard-step-helper">Cantidades y parmetros</span>
                  </div>
                </button>
                <button type="button" class="wizard-step-indicator" data-step="3">
                  <span class="wizard-step-number">3</span>
                  <div class="wizard-step-meta">
                    <span class="wizard-step-label">Ubicaciones</span>
                    <span class="wizard-step-helper">Jerarqua corporativa</span>
                  </div>
                </button>
                <button type="button" class="wizard-step-indicator" data-step="4">
                  <span class="wizard-step-number">4</span>
                  <div class="wizard-step-meta">
                    <span class="wizard-step-label">Multimedia</span>
                    <span class="wizard-step-helper">Imgenes y documentos</span>
                  </div>
                </button>
              </div>

              <div class="wizard-step-container">
                <div class="wizard-step wizard-step--active" data-step="1">
                  <section class="form-section form-section--half">
                    <div class="form-section-header">
                      <h3 class="form-section-title">Identificación general</h3>
                      <p class="form-section-description">Registra los códigos oficiales y la descripción que se verá en SAP, reportes y etiquetas.</p>
                    </div>
                    <div class="form-row-triple">
                      <div class="form-group">
                        <label>Cdigo SAP: *</label>
                        <input type="text" class="form-control" id="codSAP" list="codSAPDatalist" required placeholder="Ej: SAP12345">
                        <datalist id="codSAPDatalist">
                          <option value="Pendiente">Pendiente</option>
                        </datalist>
                      </div>

                      <div class="form-group autocomplete-container">
                        <label>Cd. Proveedor:</label>
                        <input type="text" class="form-control" id="codProv" autocomplete="off" placeholder="Ej: PROV-001">
                        <div class="autocomplete-list" id="autocomplete-codProv"></div>
                      </div>

                      <div class="form-group autocomplete-container">
                        <label>Tipo:</label>
                        <input type="text" class="form-control" id="tipo" autocomplete="off" placeholder="Ej: Filtro">
                        <div class="autocomplete-list" id="autocomplete-tipo"></div>
                      </div>
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label>Categora: *</label>
                        <select class="form-control form-categoria-select" id="categoria" required onchange="app.mostrarEjemplosCategoria(this.value)" aria-label="Seleccionar categora del repuesto">
                          <option value="">Seleccionar categora...</option>
                          <option value="Repuesto">REPUESTO</option>
                          <option value="Insumo">INSUMO</option>
                          <option value="Herramienta">HERRAMIENTA</option>
                          <option value="EPP">EPP</option>
                          <option value="Qumico">QUMICO</option>
                        </select>
                        <small id="ejemplosCategoria" class="form-ejemplos-small">Selecciona una categora para ver ejemplos</small>
                      </div>

                      <div class="form-group">
                        <label>Nombre/Descripcin: *</label>
                        <input type="text" class="form-control" id="nombre" required placeholder="Descripcin detallada del repuesto">
                      </div>
                    </div>
                  </section>

                  <section class="form-section form-section--half">
                    <div class="form-section-header">
                      <h3 class="form-section-title">Datos tcnicos</h3>
                      <p class="form-section-description">Agrega especificaciones relevantes para mantenimiento, compras o montaje.</p>
                    </div>
                    <div class="form-group">
                      <label class="form-label-row">
                        <span>Datos Tcnicos Especficos:</span>
                        <small class="form-label-optional">(Opcional - Para motores, cintas, etc.)</small>
                      </label>
                      <textarea class="form-control form-textarea-tech" id="datosTecnicos" rows="3" placeholder="Ej: Motor 0.75 kW, 380V, 1400 RPM, IP55&#10;Marca: WEG, Modelo: W22&#10;Rodamientos: 6204 y 6205"></textarea>
                      <small class="form-textarea-hint">Puedes incluir: potencia, voltaje, RPM, marca, modelo, dimensiones, especificaciones tcnicas, etc.</small>
                    </div>

                    <!-- Botón Guardar en Step 1 -->
                    <div class="step-actions-bottom">
                      <button type="button" id="saveRepuestoStep1" class="btn btn-primary btn-lg">
                        💾 Guardar Repuesto
                      </button>
                    </div>
                  </section>
                </div>

                <div class="wizard-step" data-step="2">
                  <section class="form-section form-section--full">
                    <div class="form-section-header">
                      <h3 class="form-section-title">Stock y polticas</h3>
                      <p class="form-section-description">Controla inventario fsico, cantidades instaladas y parmetros mnimos para alertas.</p>
                    </div>
                    <div class="form-stock-grid">
                      <div class="form-group">
                        <label>Stock Actual: *</label>
                        <input type="number" class="form-control" id="cantidad" min="0" required placeholder="0">
                      </div>

                      <div class="form-group">
                        <label>Instalados:</label>
                        <input type="number" class="form-control" id="cantidadInstalada" min="0" value="0" placeholder="0" title="Cantidad de repuestos actualmente instalados/en uso">
                      </div>

                      <div class="form-group">
                        <label>Mnimo: *</label>
                        <input type="number" class="form-control" id="minimo" min="0" value="5" required placeholder="5">
                      </div>

                      <div class="form-group">
                        <label>ptimo:</label>
                        <input type="number" class="form-control" id="optimo" min="0" value="10" placeholder="10">
                      </div>

                      <div class="form-group precio-info">
                        <label>Precio ($):</label>
                        <input type="number" class="form-control" id="precio" min="0" step="0.01" value="0" placeholder="0.00">
                      </div>
                    </div>
                    <small class="form-hint-small"> <strong>Instalados:</strong> Cantidad en uso. <strong>ptimo:</strong> Nivel recomendado para asegurar continuidad operativa.</small>

                    <!-- Botón Guardar en Step 2 -->
                    <div class="step-actions-bottom">
                      <button type="button" id="saveRepuestoStep2" class="btn btn-primary btn-lg">
                        💾 Guardar Repuesto
                      </button>
                    </div>
                  </section>
                </div>

                <div class="wizard-step" data-step="3">
                  <section class="form-section form-section--full">
                    <div class="ubicaciones-section-visual">
                      <!-- Panel de ubicaciones asignadas -->
                      <div id="ubicacionesAsignadas" class="ubicaciones-asignadas-panel" style="display: none;">
                        <div class="ubicaciones-asignadas-header">
                          <span class="ubicaciones-icon">📍</span>
                          <span class="ubicaciones-label">Ubicaciones asignadas:</span>
                          <span id="ubicacionesCount" class="ubicaciones-count">0</span>
                          <button type="button" id="btnAgregarOtraUbicacion" onclick="app.agregarOtraUbicacion()" class="btn btn-primary btn-sm" style="margin-left: auto;">
                            ➕ Agregar otra ubicación
                          </button>
                        </div>
                        <div id="ubicacionesAsignadasList" class="ubicaciones-asignadas-list">
                          <!-- Lista de ubicaciones asignadas se renderizará aquí -->
                        </div>
                      </div>

                      <!-- Selector Visual de Jerarquía -->
                      <div id="ubicacionesTreeContainer" class="ubicaciones-tree-selector">
                        <!-- Botón agregar área dentro del árbol -->
                        <div class="tree-actions-internal">
                          <button type="button" onclick="app.agregarNodoJerarquiaModal('area')" class="btn btn-success btn-sm">
                            ➕ Agregar Área
                          </button>
                        </div>
                        <!-- El árbol se renderizará aquí -->
                      </div>

                      <!-- Botón Guardar en Step 3 -->
                      <div class="step-actions-bottom">
                        <button type="button" id="saveRepuestoStep3" class="btn btn-primary btn-lg">
                          💾 Guardar Repuesto
                        </button>
                      </div>
                    </div>
                  </section>
                </div>

                <div class="wizard-step" data-step="4">
                  <section class="form-section form-section--full">
                    <div class="form-section-header">
                      <h3 class="form-section-title">Multimedia y soportes</h3>
                      <p class="form-section-description">Adjunta material visual o documental que facilite inspecciones, compras y capacitacin.</p>
                    </div>
                    <div class="form-multimedia-grid">
                      <div class="form-group">
                        <label class="form-label-space-between">
                          <span>Imgenes</span>
                          <small id="image-upload-mode" class="form-upload-mode" title="Optimizacin automtica WebP">WebP Auto</small>
                        </label>

                        <div class="image-upload-zone" onclick="document.getElementById('imagenFile').click()">
                          <div class="upload-icon"></div>
                          <div class="upload-text">Click para seleccionar imgenes</div>
                          <div class="upload-hint">Formatos: JPG, PNG, WebP (mx. 10MB)</div>
                        </div>

                        <input type="file"
                               class="form-input-hidden"
                               id="imagenFile"
                               accept="image/*"
                               multiple
                               onchange="app.handleImageWithOptimizer(event)"
                               aria-label="Seleccionar imgenes">

                        <div id="imagePreview" class="multimedia-preview multimedia-preview-margin"></div>
                      </div>

                      <div class="form-group">
                        <label class="form-label-margin">Documentos</label>
                        <input type="file" class="form-control form-input-file" id="documentos" accept=".pdf,.doc,.docx,.xls,.xlsx,video/*" multiple onchange="app.handleMultimedia(event, 'document')" aria-label="Seleccionar documentos">
                        <div id="documentsList" class="documents-list"></div>
                      </div>
                    </div>

                    <div id="optimizerModal" class="optimizer-modal">
                      <div class="optimizer-content">
                        <div class="optimizer-header">
                          <h3>Optimizador de Imgenes</h3>
                          <button type="button" class="optimizer-close" onclick="app.closeOptimizer()" title="Cerrar optimizador" aria-label="Cerrar optimizador"></button>
                        </div>

                        <div class="optimizer-body">
                          <div class="optimizer-preview">
                            <div class="preview-original">
                              <h4>Original</h4>
                              <img id="optimizerOriginal" src="" alt="Original">
                              <div class="preview-info">
                                <span id="originalSize">-</span>
                                <span id="originalDimensions">-</span>
                              </div>
                            </div>

                            <div class="preview-arrow"></div>

                            <div class="preview-optimized">
                              <h4>Optimizada</h4>
                              <img id="optimizerOptimized" src="" alt="Optimizada">
                              <div class="preview-info">
                                <span id="optimizedSize">-</span>
                                <span id="optimizedDimensions">-</span>
                              </div>
                              <div class="savings-badge" id="savingsBadge">Ahorro: <strong>0%</strong></div>
                            </div>
                          </div>

                          <div class="optimizer-controls">
                            <div class="control-group">
                              <label>Tamao de optimizacin:</label>
                              <div class="size-options">
                                <button type="button" class="size-btn" data-size="800" onclick="app.setOptimizeSize(800)">
                                  <span>Pequeo</span>
                                  <small>800px</small>
                                </button>
                                <button type="button" class="size-btn active" data-size="1200" onclick="app.setOptimizeSize(1200)">
                                  <span>Mediano</span>
                                  <small>1200px</small>
                                </button>
                                <button type="button" class="size-btn" data-size="1600" onclick="app.setOptimizeSize(1600)">
                                  <span>Grande</span>
                                  <small>1600px</small>
                                </button>
                                <button type="button" class="size-btn" data-size="original" onclick="app.setOptimizeSize('original')">
                                  <span>Original</span>
                                  <small>Sin redimensionar</small>
                                </button>
                              </div>
                            </div>

                            <div class="control-group">
                              <label for="qualitySlider">Calidad WebP: <span id="qualityValue">85%</span></label>
                              <input type="range" id="qualitySlider" min="60" max="95" value="85" oninput="app.updateQuality(this.value)">
                              <small>60% (mxima compresin) - 95% (mxima calidad)</small>
                            </div>
                          </div>
                        </div>

                        <div class="optimizer-footer">
                          <button type="button" class="btn btn-secondary" onclick="app.skipOptimization()">Usar Original</button>
                          <button type="button" class="btn btn-success" onclick="app.applyOptimization()">Aplicar Optimizacin</button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Botón Guardar en Step 4 -->
                    <div class="step-actions-bottom">
                      <button type="button" id="saveRepuestoStep4" class="btn btn-primary btn-lg">
                        💾 Guardar Repuesto
                      </button>
                    </div>
                  </section>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox">
  <button class="lsimpx-close" onclick="app.closeLightbox()" title="Cerrar visor" aria-label="Cerrar visor"></button>
  <button class="lightbox-nav lightbox-prev" onclick="app.lightboxPrev()" title="Imagen anterior" aria-label="Imagen anterior"></button>
  <button class="lightbox-nav lightbox-next" onclick="app.lightboxNext()" title="Imagen siguiente" aria-label="Imagen siguiente"></button>
  <div class="lightbox-content" id="lightboxContent"></div>
  <div class="lightbox-counter" id="lightboxCounter"></div>
</div>

<!-- MODAL JERARQUA VISUAL CASCADA -->
<div id="modalJerarquiaVisual" class="modal-overlay" onclick="if(event.target.id === 'modalJerarquiaVisual') this.style.display='none'">
  <div class="modal-container" onclick="event.stopPropagation()">
    
    <!-- Header con gradiente -->
    <div class="modal-header">
      <h3 class="modal-title">
        <span class="modal-icon"></span>
        <span>Ubicacin del Repuesto</span>
      </h3>
      <button onclick="document.getElementById('modalJerarquiaVisual').style.display='none'" 
        class="modal-close-btn" title="Cerrar dialogo" aria-label="Cerrar dialogo">
        
      </button>
    </div>
    
    <!-- Contenido de la jerarqua cascada -->
    <div id="jerarquiaContent" class="modal-content">
      <!-- Se llenar dinmicamente con la estructura de rbol -->
    </div>
  </div>
</div>

<!-- MODAL ESTADSTICAS -->
<div id="modalEstadisticas" class="modal-overlay" onclick="if(event.target.id === 'modalEstadisticas') this.style.display='none'">
  <div class="modal-container modal-container-large" onclick="event.stopPropagation()">
    
    <!-- Header -->
    <div class="modal-header-stats">
      <div class="modal-header-row">
        <h2 class="modal-title-large">
          <span class="modal-icon-large"></span>
          <span>Estadsticas de Almacenamiento</span>
        </h2>
  <button onclick="document.getElementById('modalEstadisticas').style.display='none'" 
    class="modal-close-btn-large" title="Cerrar dialogo" aria-label="Cerrar dialogo">
          
        </button>
      </div>
    </div>
    
    <!-- Content con scroll -->
    <div id="estadisticasContent" class="modal-content-flex">
      <!-- Contenido dinmico -->
    </div>
    
    <!-- Footer -->
    <div class="modal-footer">
      <button onclick="document.getElementById('modalEstadisticas').style.display='none'" class="btn btn-primary modal-footer-btn">
         Cerrar
      </button>
    </div>
  </div>
</div>

<!-- MODAL CASCADA JERRQUICA -->
<div id="modalCascada" class="modal-overlay modal-overlay-highest" onclick="if(event.target.id === 'modalCascada') this.style.display='none'">
  <div class="modal-container modal-container-xlarge" onclick="event.stopPropagation()">
    
    <!-- Header simplificado -->
    <div class="modal-header-cascada">
      <h3 class="modal-title-cascada">
         Cascada de reas
      </h3>
      <button onclick="document.getElementById('modalCascada').style.display='none'" 
        class="modal-close-btn-simple" title="Cerrar dialogo" aria-label="Cerrar dialogo">
        
      </button>
    </div>
    
    <!-- Barra de bsqueda y botones -->
    <div class="cascada-toolbar">
      <!-- Info de elementos -->
      <div id="cascadaStats" class="cascada-stats">
        <span> <strong id="statsAreas">0</strong> reas</span>
        <span> <strong id="statsMarcadores">0</strong> marcadores</span>
        <span> <strong id="statsSinJerarquia">0</strong> sin nivel asignado</span>
      </div>
      
      <input 
        id="cascadaSearchInput" 
        type="text" 
        placeholder=" Buscar rea o marcador..."
        class="cascada-search-input"
        onkeyup="mapController.filterCascada(this.value)"
      />
      
      <div class="cascada-buttons">
        <button onclick="mapController.expandAllCascada()" class="cascada-btn">
           Expandir todo
        </button>
        <button onclick="mapController.collapseAllCascada()" class="cascada-btn">
           Colapsar todo
        </button>
        <button onclick="mapController.toggleMostrarSoloConJerarquia()" id="btnToggleVacias" class="cascada-btn">
           Ocultar vacas
        </button>
        <button onclick="mapController.exportCascada()" class="cascada-btn">
           Exportar
        </button>
      </div>
    </div>
    
    <!-- Content con scroll -->
    <div id="cascadaContent" class="modal-content-cascada">
      <!-- Contenido dinmico generado por renderHierarchyTree -->
    </div>
    
    <!-- Footer simplificado -->
    <div class="modal-footer-simple">
      <button onclick="document.getElementById('modalCascada').style.display='none'" class="modal-footer-btn-simple">
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- MODAL PARA GESTIONAR JERARQUA -->
<div class="modal" id="modalJerarquia">
  <div class="modal-content">
  <button class="modal-close" onclick="app.closeJerarquiaModal()" title="Cerrar dialogo" aria-label="Cerrar dialogo"></button>
    
    <header class="sap-modal-header">
      <div class="sap-header-row">
        <div class="sap-header-leading">
          <span class="sap-header-eyebrow">Configuracin</span>
          <h2 class="sap-header-title">Gestionar Niveles Jerrquicos</h2>
        </div>
      </div>
      <p class="sap-header-subtitle">Mantn alineados los catlogos por nivel: cada cambio se replica en formularios, sugerencias y rutas en cascada.</p>
    </header>

    <div class="jerarquia-manager">
      <div class="jerarquia-toolbar">
        <div class="jerarquia-toolbar-top">
          <div class="jerarquia-toolbar-text">
            Ajusta los nombres oficiales por nivel y usa el buscador para saltar directo al registro que necesitas.
            <div class="jerarquia-toolbar-hint">Tip: reordena arrastrando, crea subniveles para ramificaciones frecuentes y todo quedará disponible en formularios y mapas.</div>
          </div>
          <div class="jerarquia-toolbar-actions">
            <div class="jerarquia-search" id="jerarquiaSearchWrapper">
              <span class="jerarquia-search-icon" aria-hidden="true">🔎</span>
              <input type="search" id="jerarquiaModalSearchInput" class="jerarquia-search-input" placeholder="Buscar nivel o subnivel..." oninput="app.handleJerarquiaModalSearch(this.value)" autocomplete="off" aria-label="Buscar en jerarquía" />
              <button type="button" class="jerarquia-search-clear" onclick="app.clearJerarquiaModalSearch()" title="Limpiar bsqueda">×</button>
            </div>
            <button type="button" class="jerarquia-toolbar-btn" onclick="app.expandAllJerarquiaItems()">Expandir todo</button>
            <button type="button" class="jerarquia-toolbar-btn" onclick="app.collapseAllJerarquiaItems()">Colapsar todo</button>
          </div>
        </div>
        <div class="jerarquia-toolbar-stats" id="jerarquiaStatsPills">
          <!-- pills dinámicos -->
        </div>
      </div>
      <div class="jerarquia-results" id="jerarquiaResultsSummary"></div>

      <!-- Tabs para cada nivel -->
      <div class="jerarquia-tabs jerarquia-tabs-wrapper">
        <button class="jerarquia-tab active" data-level="1" onclick="app.switchJerarquiaLevel(1)">
          <span class="tab-icon">🏢</span>
          <span class="tab-label">N1<br><small>Empresa</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="2" onclick="app.switchJerarquiaLevel(2)">
          <span class="tab-icon">🏭</span>
          <span class="tab-label">N2<br><small>Área</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="3" onclick="app.switchJerarquiaLevel(3)">
          <span class="tab-icon">📍</span>
          <span class="tab-label">N3<br><small>Sub-área</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="4" onclick="app.switchJerarquiaLevel(4)">
          <span class="tab-icon">⚙️</span>
          <span class="tab-label">N4<br><small>Sistema</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="5" onclick="app.switchJerarquiaLevel(5)">
          <span class="tab-icon">🔧</span>
          <span class="tab-label">N5<br><small>Sub-sistema</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="6" onclick="app.switchJerarquiaLevel(6)">
          <span class="tab-icon">📦</span>
          <span class="tab-label">N6<br><small>Sección</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="7" onclick="app.switchJerarquiaLevel(7)">
          <span class="tab-icon">🔩</span>
          <span class="tab-label">N7<br><small>Sub-sección</small></span>
          <span class="tab-chevron">›</span>
        </button>
      </div>

      <!-- Contenido del nivel actual -->
      <div class="jerarquia-content">
        <div class="jerarquia-level-header">
          <h3 id="jerarquiaLevelTitle">N1 - Empresa</h3>
          <button class="btn btn-primary" onclick="app.addJerarquiaItem()">
             Agregar Nuevo
          </button>
        </div>

        <!-- Formulario para agregar -->
        <div id="jerarquiaForm" class="jerarquia-form">
          <div class="form-group">
            <label for="jerarquiaItemName">Nombre:</label>
            <input type="text" id="jerarquiaItemName" class="form-control" placeholder="Ingrese el nombre...">
          </div>
          <div class="form-group">
            <label for="jerarquiaItemDesc">Descripcin (opcional):</label>
            <textarea id="jerarquiaItemDesc" class="form-control" rows="2" placeholder="Descripcin adicional..."></textarea>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-primary" onclick="app.saveJerarquiaItem()">Guardar</button>
            <button type="button" class="btn btn-secondary" onclick="app.cancelJerarquiaItem()">Cancelar</button>
          </div>
        </div>

        <!-- Lista de items del nivel -->
        <div id="jerarquiaList" class="jerarquia-list">
          <!-- Se llena dinmicamente -->
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="app.closeJerarquiaModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Script visualTreeV2.js removido - funcionalidad integrada en el código principal -->

<!-- Inicializar sistema de eventos ANTES de cargar módulos -->
<script>
// ========================================================================
//  SISTEMA DE EVENTOS GLOBAL
// ========================================================================
if (!window.appEvents) {
  window.appEvents = new EventTarget();
  console.log('✅ Sistema de eventos global creado');
}
</script>

<!-- Cargar módulo de sincronización de jerarquía (sin ES6 modules para compatibilidad file://) -->
<script src="./modules/hierarchy-sync.js"></script>

<!-- Cargar módulo de UI para Tab Mapas -->
<script src="./modules/mapas-ui.js"></script>

<script>
// @ts-nocheck

const EMBEDDED_DATA = {
  version: '1.0-mobile',
  lastUpdate: new Date().toISOString(),
  platform: 'mobile-embedded',
  note: 'Datos sin multimedia - Solo texto y nmeros para mxima compatibilidad',
  repuestos: []
};

class IndexedDBImageManager {
  constructor() {
    this.dbName = 'InventarioImagenes';
    this.dbVersion = 1;
    this.storeName = 'images';
    this.db = null;
  }

  async init() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.dbVersion);
      
      request.onerror = () => {
        console.error(' Error al abrir IndexedDB:', request.error);
        reject(request.error);
      };
      
      request.onsuccess = () => {
        this.db = request.result;
        console.log(' IndexedDB inicializada correctamente');
        resolve(this.db);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(this.storeName)) {
          const objectStore = db.createObjectStore(this.storeName, { keyPath: 'id' });
          objectStore.createIndex('repuestoId', 'repuestoId', { unique: false });
          objectStore.createIndex('timestamp', 'timestamp', { unique: false });
          console.log(' Object store "images" creado');
        }
      };
    });
  }

  async saveImage(imageId, repuestoId, file) {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      
      reader.onload = () => {
        const transaction = this.db.transaction([this.storeName], 'readwrite');
        const store = transaction.objectStore(this.storeName);
        
        const imageData = {
          id: imageId,
          repuestoId: repuestoId,
          data: reader.result, // base64 string
          type: file.type,
          size: file.size,
          name: file.name,
          timestamp: Date.now()
        };
        
        const request = store.put(imageData);
        
        request.onsuccess = () => {
          console.log(` Imagen guardada en IndexedDB: ${imageId}`);
          resolve(true);
        };
        
        request.onerror = () => {
          console.error(` Error al guardar imagen ${imageId}:`, request.error);
          reject(request.error);
        };
      };
      
      reader.onerror = () => reject(reader.error);
      reader.readAsDataURL(file); // Convierte a base64
    });
  }

  async getImage(imageId) {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([this.storeName], 'readonly');
      const store = transaction.objectStore(this.storeName);
      const request = store.get(imageId);
      
      request.onsuccess = () => {
        if (request.result) {
          const blob = this.base64ToBlob(request.result.data, request.result.type);
          const blobUrl = URL.createObjectURL(blob);
          resolve({
            url: blobUrl,
            blob: blob,
            metadata: {
              type: request.result.type,
              size: request.result.size,
              name: request.result.name,
              timestamp: request.result.timestamp
            }
          });
        } else {
          resolve(null);
        }
      };
      
      request.onerror = () => reject(request.error);
    });
  }

  async getImagesByRepuesto(repuestoId) {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([this.storeName], 'readonly');
      const store = transaction.objectStore(this.storeName);
      const index = store.index('repuestoId');
      const request = index.getAll(repuestoId);
      
      request.onsuccess = () => {
        const images = request.result.map(img => ({
          id: img.id,
          url: this.base64ToBlob(img.data, img.type),
          metadata: {
            type: img.type,
            size: img.size,
            name: img.name,
            timestamp: img.timestamp
          }
        }));
        resolve(images);
      };
      
      request.onerror = () => reject(request.error);
    });
  }

  async deleteImage(imageId) {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([this.storeName], 'readwrite');
      const store = transaction.objectStore(this.storeName);
      const request = store.delete(imageId);
      
      request.onsuccess = () => {
        console.log(` Imagen eliminada de IndexedDB: ${imageId}`);
        resolve(true);
      };
      
      request.onerror = () => reject(request.error);
    });
  }

  async getStorageStats() {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([this.storeName], 'readonly');
      const store = transaction.objectStore(this.storeName);
      const request = store.getAll();
      
      request.onsuccess = () => {
        const images = request.result;
        const totalSize = images.reduce((acc, img) => acc + img.size, 0);
        const totalCount = images.length;
        
        resolve({
          count: totalCount,
          size: totalSize,
          sizeFormatted: this.formatBytes(totalSize),
          images: images.map(img => ({
            id: img.id,
            repuestoId: img.repuestoId,
            size: img.size,
            timestamp: img.timestamp
          }))
        });
      };
      
      request.onerror = () => reject(request.error);
    });
  }

  async clearAll() {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([this.storeName], 'readwrite');
      const store = transaction.objectStore(this.storeName);
      const request = store.clear();
      
      request.onsuccess = () => {
        console.log(' Todas las imgenes eliminadas de IndexedDB');
        resolve(true);
      };
      
      request.onerror = () => reject(request.error);
    });
  }

  base64ToBlob(base64, mimeType) {
    const byteString = atob(base64.split(',')[1]);
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
      ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], { type: mimeType });
  }

  formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
}

class FileSystemManager {
  constructor() {
    this.directoryHandle = null;
    this.imagesFolder = null;
    this.isFileSystemMode = false;
    this.folderPath = '';
    this.dbName = 'InventarioFS';
    this.dbVersion = 1;
  }

  //  AGREGADO PARA COMPATIBILIDAD CON MAPSTORAGE
  get storageHandle() {
    return this.directoryHandle;
  }

  get isConnected() {
    return this.isFileSystemMode && !!this.directoryHandle;
  }
  // FIN AGREGADO PARA MAPSTORAGE

  async saveDirectoryHandle(handle) {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.dbVersion);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        const db = request.result;
        const transaction = db.transaction(['directories'], 'readwrite');
        const store = transaction.objectStore('directories');
        store.put({ id: 'main', handle: handle, timestamp: Date.now() });
        transaction.oncomplete = () => resolve(true);
        transaction.onerror = () => reject(transaction.error);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('directories')) {
          db.createObjectStore('directories', { keyPath: 'id' });
        }
      };
    });
  }

  async loadDirectoryHandle() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.dbVersion);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        const db = request.result;
        const transaction = db.transaction(['directories'], 'readonly');
        const store = transaction.objectStore('directories');
        const getRequest = store.get('main');
        
        getRequest.onsuccess = () => {
          resolve(getRequest.result?.handle || null);
        };
        getRequest.onerror = () => reject(getRequest.error);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('directories')) {
          db.createObjectStore('directories', { keyPath: 'id' });
        }
      };
    });
  }

  async restoreFromPreviousSession() {
    try {
      const savedHandle = await this.loadDirectoryHandle();
      if (!savedHandle) {
        console.log('No hay carpeta guardada previamente');
        return false;
      }

      const permission = await savedHandle.queryPermission({ mode: 'readwrite' });
      
      if (permission === 'granted') {
        this.directoryHandle = savedHandle;
        await this.ensureImageFolder();
        this.folderPath = this.directoryHandle.name;
        this.isFileSystemMode = true;
        this.updateStatusIndicator(true, this.folderPath);
        console.log(' Sesin FileSystem restaurada automticamente:', this.folderPath);
        return true;
      } else if (permission === 'prompt') {
        const hasUserActivation = Boolean(navigator.userActivation?.isActive);
        if (!hasUserActivation) {
          console.warn(' Se requiere interaccin del usuario para volver a solicitar permisos.');
          if (typeof app !== 'undefined' && typeof app.showToast === 'function') {
            app.showToast('Debes usar "Conectar Carpeta" para reactivar los permisos.', 'warning');
          }
          this.updateStatusIndicator(false);
          return false;
        }

        const newPermission = await savedHandle.requestPermission({ mode: 'readwrite' });
        if (newPermission === 'granted') {
          this.directoryHandle = savedHandle;
          await this.ensureImageFolder();
          this.folderPath = this.directoryHandle.name;
          this.isFileSystemMode = true;
          this.updateStatusIndicator(true, this.folderPath);
          console.log(' Permisos re-otorgados, sesin restaurada:', this.folderPath);
          return true;
        }
      }
      
  console.log('[WARN] Permisos denegados, necesita reactivar manualmente');
      return false;
    } catch (error) {
      console.error('Error restaurando sesin:', error);
      return false;
    }
  }

  updateStatusIndicator(connected, path = '') {
    const btn = document.getElementById('connectionBtn');
    const icon = document.getElementById('connectionIcon');

    if (btn && icon) {
      if (connected) {
        //  Verde con gradiente Neomorphism
        btn.style.background = 'linear-gradient(145deg, #10b981, #059669)';
        btn.style.color = 'white';
        btn.title = path ? ` Conectado: ${path}` : ' Conectado';
        icon.textContent = '';
      } else {
        //  Rojo con gradiente Neomorphism
        btn.style.background = 'linear-gradient(145deg, #ef4444, #dc2626)';
        btn.style.color = 'white';
        btn.title = ' No conectado';
        icon.textContent = '';
      }
    }
  }

  async selectFolder() {
    try {
      const selectedFolder = await window.showDirectoryPicker({ mode: 'readwrite' });
      console.log(' Carpeta seleccionada por usuario:', selectedFolder.name);
      
      let workingFolder = selectedFolder;
      let detectedPath = selectedFolder.name;
      
      if (selectedFolder.name === 'INVENTARIO_PORTABLE') {
        console.log(' Detectado INVENTARIO_PORTABLE, buscando INVENTARIO_STORAGE dentro...');
        try {
          const storageFolder = await selectedFolder.getDirectoryHandle('INVENTARIO_STORAGE', { create: false });
          workingFolder = storageFolder;
          detectedPath = `${selectedFolder.name}/${storageFolder.name}`;
          console.log(' INVENTARIO_STORAGE encontrado automticamente!');
        } catch (e) {
          console.warn(' INVENTARIO_STORAGE no encontrada, crendola...');
          const storageFolder = await selectedFolder.getDirectoryHandle('INVENTARIO_STORAGE', { create: true });
          workingFolder = storageFolder;
          detectedPath = `${selectedFolder.name}/${storageFolder.name}`;
          console.log(' INVENTARIO_STORAGE creada automticamente!');
        }
      } else if (selectedFolder.name === 'INVENTARIO_STORAGE') {
        console.log(' INVENTARIO_STORAGE seleccionada directamente');
      } else {
        console.log(' Buscando INVENTARIO_STORAGE dentro de', selectedFolder.name);
        try {
          const storageFolder = await selectedFolder.getDirectoryHandle('INVENTARIO_STORAGE', { create: false });
          workingFolder = storageFolder;
          detectedPath = `${selectedFolder.name}/${storageFolder.name}`;
          console.log(' INVENTARIO_STORAGE encontrado dentro de', selectedFolder.name);
        } catch (e) {
          console.log(' INVENTARIO_STORAGE no encontrada, usando carpeta seleccionada como est');
        }
      }
      
      this.directoryHandle = workingFolder;
      await this.ensureImageFolder();
      
      await this.saveDirectoryHandle(this.directoryHandle);
      localStorage.setItem('fsDirectory', 'enabled');
      
      this.folderPath = detectedPath;
      localStorage.setItem('fsFolderName', this.folderPath);
      
      this.isFileSystemMode = true;
      console.log(' Sistema configurado con carpeta:', detectedPath);
      
      this.updateStatusIndicator(true, detectedPath);
      
      return true;
    } catch (error) {
      console.error('Error seleccionando carpeta:', error);
      this.updateStatusIndicator(false);
      return false;
    }
  }

  async ensureImageFolder() {
    try {
      this.imagesFolder = await this.directoryHandle.getDirectoryHandle('imagenes', { create: true });
      console.log(' Carpeta "imagenes" accesible:', this.imagesFolder);
      
      let count = 0;
      for await (const entry of this.imagesFolder.values()) {
        count++;
        if (count <= 3) {
          console.log(`    Encontrado: ${entry.name}`);
        }
      }
      console.log(`    Total de archivos en carpeta imagenes: ${count}`);
    } catch (error) {
      console.error(' Error accediendo a carpeta imagenes:', error);
      this.imagesFolder = null;
    }
  }

  async saveJSON(data) {
    if (!this.isFileSystemMode) {
      return false; // No est en modo FileSystem
    }
    try {
      const fileHandle = await this.directoryHandle.getFileHandle('inventario.json', { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(JSON.stringify(data, null, 2));
      await writable.close();
      console.log(' JSON guardado en archivo: inventario.json');
      return true;
    } catch (error) {
      console.error(' Error guardando JSON en FileSystem:', error);
      return false;
    }
  }

  async saveImage(blob, filename) {
    if (!this.isFileSystemMode) return null;
    try {
      const fileHandle = await this.imagesFolder.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      console.log(' Imagen guardada:', filename);
      return './imagenes/' + filename;
    } catch (error) {
      console.error('Error guardando imagen:', error);
      return null;
    }
  }

  /**
   * Guarda imagen en carpeta jerrquica segn ubicacin
   */
  async saveImageJerarquica(blob, filename, carpetaDestino) {
    if (!this.isFileSystemMode) return null;
    try {
      const fileHandle = await carpetaDestino.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      console.log(' Imagen guardada en carpeta jerrquica:', filename);
      return filename;
    } catch (error) {
      console.error('Error guardando imagen en carpeta jerrquica:', error);
      return null;
    }
  }

  /**
   * Lee un archivo desde el File System Access API
   * @param {string|Array} imagePath - Ruta del archivo (string con / o array de segmentos)
   * @returns {Promise<Blob|null>} - Blob del archivo o null si falla
   */
  async readFile(imagePath) {
    if (!this.isFileSystemMode) {
      console.warn(' FileSystem no est activo');
      return null;
    }

    try {
      // Convertir path string a array de segmentos
      const segments = Array.isArray(imagePath) 
        ? imagePath 
        : String(imagePath || '').split('/').filter(Boolean);

      if (!segments.length) {
        console.warn(' Ruta de imagen vaca');
        return null;
      }

      // Navegar por la jerarqua de carpetas
      let currentDir = this.directoryHandle;
      
      for (let i = 0; i < segments.length - 1; i++) {
        const folderName = segments[i];
        currentDir = await currentDir.getDirectoryHandle(folderName, { create: false });
      }

      // Obtener el archivo final
      const fileName = segments[segments.length - 1];
      const fileHandle = await currentDir.getFileHandle(fileName, { create: false });
      const file = await fileHandle.getFile();
      
      return file;
    } catch (error) {
      console.error(' Error leyendo archivo:', imagePath, error);
      return null;
    }
  }

  async deleteImage(imagePath) {
    if (!this.isFileSystemMode) return false;
    try {
      const filename = imagePath.replace('./imagenes/', '').replace('imagenes/', '');
      
      if (!filename) {
        console.warn(' Nombre de archivo invlido:', imagePath);
        return false;
      }
      
      console.log(` Intentando eliminar archivo: ${filename}`);
      
      await this.imagesFolder.removeEntry(filename);
      console.log(` Archivo eliminado del FileSystem: ${filename}`);
      return true;
    } catch (error) {
      if (error.name === 'NotFoundError') {
        console.warn(` Archivo no encontrado (ya estaba eliminado): ${imagePath}`);
        return true; // Considerar como xito si ya no existe
      }
      console.error(' Error eliminando imagen del FileSystem:', error);
      return false;
    }
  }

  async deleteMultipleImages(imagePaths) {
    if (!this.isFileSystemMode) return { deleted: 0, failed: 0 };
    
    let deleted = 0;
    let failed = 0;
    
    console.log(` Eliminando ${imagePaths.length} imgenes del FileSystem...`);
    
    for (const imagePath of imagePaths) {
      const success = await this.deleteImage(imagePath);
      if (success) {
        deleted++;
      } else {
        failed++;
      }
    }
    
    console.log(` Eliminadas: ${deleted} |  Fallidas: ${failed}`);
    return { deleted, failed };
  }

  async getAllImagesInFolder() {
    if (!this.isFileSystemMode) return [];
    
    try {
      const images = [];
      for await (const entry of this.imagesFolder.values()) {
        if (entry.kind === 'file') {
          images.push(entry.name);
        }
      }
      return images;
    } catch (error) {
      console.error('Error listando imgenes:', error);
      return [];
    }
  }

  async cleanOrphanImages(repuestos) {
    if (!this.isFileSystemMode) return { orphans: 0, deleted: 0, failed: 0, size: 0 };
    
    console.log(' Buscando imgenes hurfanas...');
    
    const allImages = await this.getAllImagesInFolder();
    console.log(` Total de imgenes en carpeta: ${allImages.length}`);
    
    const referencedImages = new Set();
    repuestos.forEach(r => {
      if (r.multimedia) {
        r.multimedia
          .filter(m => m.type === 'image' && m.isFileSystem && m.url)
          .forEach(m => {
            const filename = m.url.replace('./imagenes/', '').replace('imagenes/', '');
            referencedImages.add(filename);
          });
      }
    });
    console.log(` Imgenes referenciadas: ${referencedImages.size}`);
    
    const orphanImages = allImages.filter(img => !referencedImages.has(img));
    console.log(` Imgenes hurfanas encontradas: ${orphanImages.length}`);
    
    if (orphanImages.length === 0) {
      return { orphans: 0, deleted: 0, failed: 0, size: 0 };
    }
    
    let totalSize = 0;
    for (const filename of orphanImages) {
      try {
        const fileHandle = await this.imagesFolder.getFileHandle(filename);
        const file = await fileHandle.getFile();
        totalSize += file.size;
      } catch (error) {
        console.warn(` No se pudo leer tamao de: ${filename}`);
      }
    }
    
    let deleted = 0;
    let failed = 0;
    
    for (const filename of orphanImages) {
      try {
        await this.imagesFolder.removeEntry(filename);
        deleted++;
        console.log(` Eliminada hurfana: ${filename}`);
      } catch (error) {
        failed++;
        console.error(` Error eliminando: ${filename}`, error);
      }
    }
    
    console.log(` Limpieza completada: ${deleted} eliminadas, ${failed} fallidas`);
    console.log(` Espacio liberado: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
    
    return { 
      orphans: orphanImages.length, 
      deleted, 
      failed, 
      size: totalSize 
    };
  }
}

const fsManager = new FileSystemManager();
const indexedDBManager = new IndexedDBImageManager();

if (!('showDirectoryPicker' in window)) {
  indexedDBManager.init().then(() => {
    console.log(' IndexedDB Manager inicializado para modo mvil');
  }).catch(err => {
    console.error(' Error al inicializar IndexedDB:', err);
  });
}

const globalBlobCache = new Map();

// ============================================================
//  BUS DE EVENTOS GLOBAL - SINCRONIZAR PESTAÑAS
// ============================================================
const appEvents = (() => {
  const listeners = new Map();

  return {
    on(eventName, handler) {
      if (!eventName || typeof handler !== 'function') {
        return () => {};
      }

      if (!listeners.has(eventName)) {
        listeners.set(eventName, new Set());
      }

      const eventListeners = listeners.get(eventName);
      eventListeners.add(handler);

      return () => {
        eventListeners.delete(handler);
        if (eventListeners.size === 0) {
          listeners.delete(eventName);
        }
      };
    },

    emit(eventName, payload = {}) {
      const eventListeners = listeners.get(eventName);
      if (!eventListeners || eventListeners.size === 0) {
        return;
      }

      eventListeners.forEach((handler) => {
        try {
          handler(payload);
        } catch (error) {
          console.error('appEvents handler error:', eventName, error);
        }
      });
    }
  };
})();

// NO sobreescribir window.appEvents si ya es un EventTarget
// El EventTarget se crea antes en el HTML y es compatible con addEventListener
if (!(window.appEvents instanceof EventTarget)) {
  window.appEvents = appEvents;
}

// Funcin para obtener o crear Blob URL con cach global
async function getCachedBlobUrl(filename, loadFunction) {
  // NO usar caché para evitar problemas con "Tracking Prevention" de Edge
  // que bloquea blob URLs antiguos. Siempre generar blob fresco.
  const url = await loadFunction();
  
  if (url) {
    // Guardar referencia pero siempre generar nuevo blob
    globalBlobCache.set(filename, {
      url: url,
      timestamp: Date.now(),
      filename: filename
    });
    console.log(` [CACH GLOBAL] Blob fresco creado: ${filename} (Total: ${globalBlobCache.size})`);
  }
  return url;
}

function activarModoFileSystem() {
  if (!('showDirectoryPicker' in window)) {
    alert('Tu navegador no soporta FileSystem Access API.\n\nPor favor usa:\n Google Chrome 86+\n Microsoft Edge 86+');
    return;
  }
  fsManager.selectFolder().then(ok => {
    if (ok) {
      document.getElementById('fsBadge').style.display = 'inline';
      alert('Almacenamiento Ilimitado activado!\n\nAhora puedes agregar INFINITAS imgenes.\nCarpeta: ' + fsManager.folderPath);
    }
  });
}

// FUNCIN TOGGLE PARA ACTIVAR/DESACTIVAR ALMACENAMIENTO ILIMITADO
function toggleModoFileSystem() {
  if (fsManager.isFileSystemMode) {
    // Si est activo, mostrar confirmacin para desactivar
    const confirmar = confirm(
      'Almacenamiento Ilimitado ACTIVO\n\n' +
      'Deseas DESACTIVAR el almacenamiento ilimitado?\n\n' +
      'Se volver al modo localStorage (lmite 10MB)\n' +
      'Los datos guardados en la carpeta NO se perdern'
    );
    if (confirmar) {
      desactivarModoFileSystem();
    }
  } else {
    // Si est inactivo, activar
    activarModoFileSystem();
  }
}

//  FUNCIN PARA DESACTIVAR MODO FILESYSTEM
function desactivarModoFileSystem() {
  console.log(' Desactivando modo FileSystem...');
  
  // Limpiar estado del FileSystemManager
  fsManager.isFileSystemMode = false;
  fsManager.directoryHandle = null;
  fsManager.imagesFolder = null;
  fsManager.folderPath = null;
  
  // Limpiar localStorage
  localStorage.removeItem('fsDirectory');
  localStorage.removeItem('fsFolderName');
  
  // Eliminar base de datos IndexedDB
  const deleteRequest = indexedDB.deleteDatabase(fsManager.dbName);
  deleteRequest.onsuccess = () => {
    console.log(' Base de datos IndexedDB eliminada');
  };
  deleteRequest.onerror = () => {
    console.warn(' No se pudo eliminar la base de datos IndexedDB');
  };
  
  // Actualizar indicador visual
  fsManager.updateStatusIndicator(false);
  document.getElementById('fsBadge').style.display = 'none';
  
  // Mostrar notificacin
  if (typeof app !== 'undefined' && app.showToast) {
    app.showToast(' Modo Carpeta DESACTIVADO - Volviendo a localStorage (lmite 10MB)', 'error', 4000);
  } else {
    alert(' Modo Carpeta DESACTIVADO\n\nAhora usars localStorage con lmite de 10MB');
  }
  
  console.log(' Modo FileSystem desactivado completamente');
}

/* 
    MAP STORAGE SERVICE - INTEGRADO DESDE APP_BASE (FASE 4A)
   
   Gestiona el almacenamiento de mapas y reas en FileSystem con backups y logs.
    */

class MapStorageService {
  constructor(fsManager) {
    this.fsManager = fsManager;
    this.maps = [];
    this.areas = []; // Antes 'zones' - Mantener compatibilidad con zonas.json
    this.maxBackups = 5;
    this.mapsFileName = 'mapas.json';
    this.areasFileName = 'zonas.json'; // IMPORTANTE: Mantener 'zonas.json' para compatibilidad con datos existentes
    this.logsDirName = 'logs';
    this.logFileName = 'mapas-history.log';
    this.mapImagesPath = ['imagenes', 'mapas'];
    this.backupMapPath = ['backups', 'mapas'];
    this.backupAreaPath = ['backups', 'zonas']; // IMPORTANTE: Mantener 'zonas' para compatibilidad
    this.initialized = false;
    this.logsDirHandle = null;
    this.backupMapsDir = null;
    this.backupAreasDir = null; // Antes 'backupZonesDir'
    this.mapImagesDir = null;
  }

  get rootHandle() {
    return this.fsManager ? this.fsManager.storageHandle : null;
  }

  setMaxBackups(value) {
    if (typeof value === 'number' && value >= 1) {
      this.maxBackups = Math.floor(value);
    }
  }

  async init(options = {}) {
    const { autoReconnect = false } = options; // Cambiado a false por defecto - se controla desde inicialización centralizada
    if (!this.fsManager) {
      return false;
    }

    if (!this.fsManager.isConnected && autoReconnect && typeof this.fsManager.restoreFromPreviousSession === 'function') {
      try {
        await this.fsManager.restoreFromPreviousSession();
      } catch (error) {
        console.warn('No se pudo restaurar la carpeta de FileSystem:', error);
      }
    }

    if (!this.fsManager.isConnected) {
      return false;
    }

    await this.ensureStructure();
    await Promise.all([this.loadMaps(), this.loadAreas()]);
    this.initialized = true;
    
    return true;
  }

  async ensureStructure() {
    const root = this.rootHandle;
    if (!root) {
      return;
    }

    this.mapImagesDir = await this.ensureDirectory(this.mapImagesPath);
    this.backupMapsDir = await this.ensureDirectory(this.backupMapPath);
    this.backupAreasDir = await this.ensureDirectory(this.backupAreaPath);
    this.logsDirHandle = await this.ensureDirectory([this.logsDirName]);

    await this.ensureJSONFile(this.mapsFileName, '[]');
    await this.ensureJSONFile(this.areasFileName, '[]'); // Archivo zonas.json para compatibilidad
    await this.ensureLogFile();
  }

  async ensureDirectory(pathSegments) {
    let current = this.rootHandle;
    if (!current) {
      return null;
    }

    for (const segment of pathSegments) {
      if (!segment) {
        continue;
      }
      current = await current.getDirectoryHandle(segment, { create: true });
    }

    return current;
  }

  async ensureJSONFile(fileName, defaultContent) {
    const root = this.rootHandle;
    if (!root) {
      return;
    }

    try {
      await root.getFileHandle(fileName);
    } catch (error) {
      if (error.name === 'NotFoundError') {
        const handle = await root.getFileHandle(fileName, { create: true });
        const writable = await handle.createWritable();
        await writable.write(defaultContent);
        await writable.close();
      } else {
        console.warn(`No se pudo asegurar ${fileName}:`, error);
      }
    }
  }

  async ensureLogFile() {
    if (!this.logsDirHandle) {
      return;
    }

    try {
      await this.logsDirHandle.getFileHandle(this.logFileName);
    } catch (error) {
      if (error.name === 'NotFoundError') {
        const handle = await this.logsDirHandle.getFileHandle(this.logFileName, { create: true });
        const writable = await handle.createWritable();
        await writable.write('');
        await writable.close();
      } else {
        console.warn('No se pudo asegurar el archivo de log:', error);
      }
    }
  }

  normalizeJerarquiaPath(path) {
    if (!Array.isArray(path)) {
      return [];
    }

    return path
      .map((node) => {
        if (!node) {
          return null;
        }

        if (typeof node === 'string') {
          return { id: node, nivel: null };
        }

        if (typeof node === 'object') {
          const id = node.id ?? node.value ?? null;
          if (!id) {
            return null;
          }
          return {
            id,
            nivel: node.nivel ?? node.level ?? null
          };
        }

        return null;
      })
      .filter(Boolean);
  }

  deriveMapLevel(jerarquiaPath = []) {
    if (!Array.isArray(jerarquiaPath) || !jerarquiaPath.length) {
      return null;
    }
    const leaf = jerarquiaPath[jerarquiaPath.length - 1];
    return leaf?.nivel ?? null;
  }

  normalizeMap(map) {
    if (!map || typeof map !== 'object') {
      return {
        id: Date.now(),
        name: 'Mapa sin nombre',
        jerarquiaPath: [],
        allowFreeLevel: false,
        mapLevel: null
      };
    }

    const normalizedPath = this.normalizeJerarquiaPath(map.jerarquiaPath);
    const allowFreeLevel = Boolean(map.allowFreeLevel);
    const mapLevel = allowFreeLevel ? null : (map.mapLevel ?? this.deriveMapLevel(normalizedPath));

    return {
      ...map,
      allowFreeLevel,
      jerarquiaPath: normalizedPath,
      mapLevel: mapLevel || null
    };
  }

  validateMapEntry(map) {
    const issues = [];

    if (!map.allowFreeLevel) {
      if (!Array.isArray(map.jerarquiaPath) || !map.jerarquiaPath.length) {
        issues.push('Mapa sin jerarquiaPath asignado');
      } else {
        const leaf = map.jerarquiaPath[map.jerarquiaPath.length - 1];
        if (!leaf || !leaf.id) {
          issues.push('Nodo hoja sin ID');
        }
        if (!leaf || !leaf.nivel) {
          issues.push('Nodo hoja sin nivel');
        }
        if (!map.mapLevel) {
          issues.push('mapLevel no definido');
        }
      }
    }

    return {
      ok: issues.length === 0,
      issues
    };
  }

  validateMapCollection(maps) {
    const errors = [];
    const warnings = [];
    const leafAssignments = new Map();

    maps.forEach((map) => {
      const result = this.validateMapEntry(map);
      if (!result.ok) {
        errors.push({ mapId: map.id, name: map.name || 'Sin nombre', issues: result.issues.join('; ') });
      }

      if (map.allowFreeLevel) {
        return;
      }

      if (Array.isArray(map.jerarquiaPath) && map.jerarquiaPath.length) {
        const leaf = map.jerarquiaPath[map.jerarquiaPath.length - 1];
        const key = `${leaf.nivel || 'sin-nivel'}:${leaf.id}`;
        if (!leafAssignments.has(key)) {
          leafAssignments.set(key, []);
        }
        leafAssignments.get(key).push({ mapId: map.id, name: map.name || 'Sin nombre' });
      }
    });

    for (const [key, list] of leafAssignments.entries()) {
      if (list.length > 1) {
        warnings.push({
          leaf: key,
          maps: list.map((item) => `${item.name} (#${item.mapId})`).join(', ')
        });
      }
    }

    return {
      ok: errors.length === 0,
      errors,
      warnings
    };
  }

  logMapValidation(result) {
    if (!result) {
      return;
    }

    if (result.errors.length) {
      console.group('❌ Errores de validación de mapas');
      console.table(result.errors);
      console.groupEnd();
    }

    if (result.warnings.length) {
      console.group('⚠️ Advertencias de jerarquía duplicada');
      console.table(result.warnings);
      console.groupEnd();
    }
  }

  async loadMaps() {
    if (!this.fsManager || !this.fsManager.isConnected) {
      this.maps = [];
      return this.maps;
    }

    try {
      const fileHandle = await this.rootHandle.getFileHandle(this.mapsFileName, { create: true });
      const file = await fileHandle.getFile();
      const raw = (await file.text()).trim();
      let parsed = [];
      if (raw) {
        parsed = JSON.parse(raw);
      }
      this.maps = Array.isArray(parsed)
        ? parsed.map((map) => this.normalizeMap(map))
        : [];
    } catch (error) {
      console.warn('No se pudieron cargar los mapas:', error);
      this.maps = [];
    }

    return this.maps;
  }

  async loadAreas() { // Antes loadZones
    if (!this.fsManager || !this.fsManager.isConnected) {
      this.areas = [];
      return this.areas;
    }

    try {
      const fileHandle = await this.rootHandle.getFileHandle(this.areasFileName, { create: true });
      const file = await fileHandle.getFile();
      const raw = (await file.text()).trim();
      let parsed = [];
      if (raw) {
        parsed = JSON.parse(raw);
      }
      this.areas = Array.isArray(parsed) ? parsed : [];
    } catch (error) {
      console.warn('No se pudieron cargar las reas:', error);
      this.areas = [];
    }

    return this.areas;
  }

  async writeJSON(fileName, data) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return false;
    }

    try {
      const handle = await this.rootHandle.getFileHandle(fileName, { create: true });
      const writable = await handle.createWritable();
      await writable.write(JSON.stringify(data, null, 2));
      await writable.close();
      return true;
    } catch (error) {
      console.warn(`No se pudo escribir ${fileName}:`, error);
      return false;
    }
  }

  async saveMaps(maps, meta = {}) {
    const normalized = Array.isArray(maps) ? maps.map((map) => this.normalizeMap(map)) : [];
    const validation = this.validateMapCollection(normalized);
    this.logMapValidation(validation);

    if (!validation.ok) {
      console.warn('Guardado abortado: la colección de mapas no supera la validación de jerarquía.');
      return false;
    }

    if (!this.fsManager || !this.fsManager.isConnected) {
      this.maps = [...normalized];
      return false;
    }

    await this.createBackup(this.mapsFileName, 'maps');
    await this.writeJSON(this.mapsFileName, normalized);
    this.maps = [...normalized];

    await this.appendLog({ scope: 'maps', action: meta.action || 'save', mapId: meta.mapId || null, detail: meta.detail || null });
    return true;
  }

  async saveAreas(areas, meta = {}) { // Antes saveZones
    const normalized = Array.isArray(areas) ? areas : [];

    if (!this.fsManager || !this.fsManager.isConnected) {
      this.areas = [...normalized];
      return false;
    }

    await this.createBackup(this.areasFileName, 'areas'); // Backup sigue siendo 'areas'
    await this.writeJSON(this.areasFileName, normalized); // Archivo sigue siendo zonas.json
    this.areas = [...normalized];

    await this.appendLog({ scope: 'areas', action: meta.action || 'save', mapId: meta.mapId || null, areaId: meta.areaId || null, detail: meta.detail || null });
    return true;
  }

  async createBackup(fileName, namespace) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return;
    }

    const dirHandle = namespace === 'areas' ? this.backupAreasDir : this.backupMapsDir;
    if (!dirHandle) {
      return;
    }

    try {
      const fileHandle = await this.rootHandle.getFileHandle(fileName);
      const file = await fileHandle.getFile();
      const content = await file.text();
      if (!content || !content.trim()) {
        return;
      }

      const timestamp = this.formatTimestamp(new Date());
      const baseName = fileName.replace('.json', '');
      const backupHandle = await dirHandle.getFileHandle(`${baseName}-${timestamp}.json`, { create: true });
      const writable = await backupHandle.createWritable();
      await writable.write(content);
      await writable.close();

      await this.rotateBackups(dirHandle);
    } catch (error) {
      if (error.name !== 'NotFoundError') {
        console.warn(`No se pudo crear backup para ${fileName}:`, error);
      }
    }
  }

  async rotateBackups(dirHandle) {
    if (!dirHandle) {
      return;
    }

    const files = [];
    try {
      for await (const entry of dirHandle.values()) {
        if (entry.kind === 'file') {
          files.push(entry.name);
        }
      }
    } catch (error) {
      console.warn('No se pudo enumerar los backups:', error);
      return;
    }

    files.sort();

    while (files.length > this.maxBackups) {
      const oldest = files.shift();
      try {
        await dirHandle.removeEntry(oldest);
      } catch (error) {
        console.warn('No se pudo eliminar backup antiguo:', oldest, error);
        break;
      }
    }
  }

  async appendLog(event) {
    if (!event || typeof event !== 'object') {
      return;
    }

    if (!this.logsDirHandle) {
      return;
    }

    try {
      const payload = {
        scope: event.scope || 'maps',
        action: event.action || 'update',
        mapId: event.mapId || null,
        areaId: event.areaId || null, // Antes 'zoneId'
        detail: event.detail || null,
        timestamp: new Date().toISOString()
      };
      const handle = await this.logsDirHandle.getFileHandle(this.logFileName, { create: true });
      const file = await handle.getFile();
      const writable = await handle.createWritable({ keepExistingData: true });
      await writable.seek(file.size);
      await writable.write(JSON.stringify(payload) + '\n');
      await writable.close();
    } catch (error) {
      console.warn('No se pudo registrar el evento de mapa:', error);
    }
  }

  async readLog(limit = null) {
    if (!this.logsDirHandle) {
      return [];
    }

    try {
      const handle = await this.logsDirHandle.getFileHandle(this.logFileName, { create: true });
      const file = await handle.getFile();
      const text = await file.text();
      if (!text) {
        return [];
      }

      const lines = text.split('\n').filter(line => line.trim().length > 0);
      const events = [];
      for (const line of lines) {
        try {
          events.push(JSON.parse(line));
        } catch (error) {
          console.warn('Entrada de log invalida:', line);
        }
      }

      if (typeof limit === 'number' && limit > 0) {
        return events.slice(-limit);
      }

      return events;
    } catch (error) {
      console.warn('No se pudo leer el log de mapas:', error);
      return [];
    }
  }

  async getFileHandleFromPath(path) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return null;
    }

    const segments = Array.isArray(path) ? path : String(path || '').split('/').filter(Boolean);
    if (!segments.length) {
      return null;
    }

    let currentDir = this.rootHandle;
    try {
      for (let i = 0; i < segments.length; i++) {
        const segment = segments[i];
        const isLast = i === segments.length - 1;
        if (isLast) {
          return await currentDir.getFileHandle(segment, { create: false });
        }
        currentDir = await currentDir.getDirectoryHandle(segment, { create: false });
      }
    } catch (error) {
      console.warn('No se pudo resolver ruta de archivo:', path, error);
      return null;
    }

    return null;
  }

  async getMapImage(map) {
    if (!map || !map.imagePath) {
      return null;
    }

    try {
      const handle = await this.getFileHandleFromPath(map.imagePath);
      if (!handle) {
        return null;
      }
      return await handle.getFile();
    } catch (error) {
      console.warn('No se pudo obtener imagen del mapa:', error);
      return null;
    }
  }
  
  async listMapImageFiles() {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return [];
    }

    await this.ensureStructure();
    if (!this.mapImagesDir) {
      return [];
    }

    const files = [];
    try {
      for await (const entry of this.mapImagesDir.values()) {
        if (entry.kind === 'file') {
          files.push(entry.name);
        }
      }
    } catch (error) {
      console.warn('No se pudieron enumerar las imgenes de mapas:', error);
    }

    return files;
  }

  async deleteMapImage(target) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return { success: false, reason: 'fs-offline' };
    }

    const imagePath = typeof target === 'string'
      ? target
      : (target && target.imagePath) ? target.imagePath : null;

    if (!imagePath) {
      return { success: false, reason: 'no-path' };
    }

    const segments = String(imagePath).split('/').filter(Boolean);
    if (!segments.length || !this.rootHandle) {
      return { success: false, reason: 'invalid-path' };
    }

    try {
      let currentDir = this.rootHandle;
      for (let i = 0; i < segments.length - 1; i++) {
        currentDir = await currentDir.getDirectoryHandle(segments[i], { create: false });
      }
      const fileName = segments[segments.length - 1];
      await currentDir.removeEntry(fileName);
      return { success: true, reason: 'deleted' };
    } catch (error) {
      if (error.name === 'NotFoundError') {
        return { success: true, reason: 'missing' };
      }
      console.warn('No se pudo eliminar imagen del mapa:', imagePath, error);
      return { success: false, reason: 'fs-error', error };
    }
  }

  async cleanupOrphanMapImages() {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return { scanned: 0, referenced: 0, orphans: 0, removed: 0, failed: [] };
    }

    await this.ensureStructure();
    const files = await this.listMapImageFiles();
    if (!files.length) {
      return { scanned: 0, referenced: 0, orphans: 0, removed: 0, failed: [] };
    }

    const referenced = new Set(
      (this.maps || [])
        .map(map => {
          if (!map || !map.imagePath) {
            return null;
          }
          const parts = map.imagePath.split('/').filter(Boolean);
          return parts.length ? parts[parts.length - 1] : null;
        })
        .filter(Boolean)
    );

    const orphans = files.filter(name => !referenced.has(name));
    const failed = [];
    let removed = 0;

    for (const fileName of orphans) {
      try {
        await this.mapImagesDir.removeEntry(fileName);
        removed++;
      } catch (error) {
        failed.push({ fileName, error: error?.message || 'unknown' });
        console.warn('No se pudo eliminar mapa hurfano:', fileName, error);
      }
    }

    return {
      scanned: files.length,
      referenced: referenced.size,
      orphans: orphans.length,
      removed,
      failed
    };
  }
  
  getMapById(mapId) {
    return this.maps.find(map => map.id === mapId) || null;
  }

  getAreasByMap(mapId) { // Antes getZonesByMap
    return this.areas.filter(area => area.mapId === mapId);
  }

  formatTimestamp(date = new Date()) {
    const pad = (value) => String(value).padStart(2, '0');
    const year = date.getFullYear();
    const month = pad(date.getMonth() + 1);
    const day = pad(date.getDate());
    const hours = pad(date.getHours());
    const minutes = pad(date.getMinutes());
    const seconds = pad(date.getSeconds());
    return `${year}${month}${day}-${hours}${minutes}${seconds}`;
  }

  // Mtodos para exportacin de respaldo completo
  async getMaps() {
    await this.loadMaps();
    return this.maps;
  }

  async getAreas() {
    await this.loadAreas();
    return this.areas;
  }

  async auditMapHierarchy({ log = true } = {}) {
    await Promise.all([this.loadMaps(), this.loadAreas()]);

    const summary = {
      timestamp: new Date().toISOString(),
      totalMaps: this.maps.length,
      totalAreas: this.areas.length,
      stats: {
        mapsWithJerarquia: 0,
        mapsWithoutJerarquia: 0,
        uniqueLeafNodes: 0,
        duplicateLeafNodes: 0,
        areasOrphan: 0,
        mapsWithoutAreas: 0
      },
      issues: {
        missingJerarquiaPath: [],
        missingLeafNode: [],
        duplicateLeafAssignments: [],
        orphanAreas: [],
        mapsWithoutAreas: []
      }
    };

    const leafAssignments = new Map();
    const mapsById = new Map();
    const mapAreaCounts = new Map();

    for (const map of this.maps) {
      if (!map || typeof map !== 'object') {
        continue;
      }
      mapsById.set(map.id, map);
      const path = Array.isArray(map.jerarquiaPath) ? map.jerarquiaPath.filter(Boolean) : [];
      if (!path.length) {
        summary.issues.missingJerarquiaPath.push({ mapId: map.id, name: map.name || 'Sin nombre' });
        continue;
      }

      summary.stats.mapsWithJerarquia++;
      const leaf = path[path.length - 1];
      if (!leaf || !leaf.id) {
        summary.issues.missingLeafNode.push({ mapId: map.id, name: map.name || 'Sin nombre' });
        continue;
      }

      const key = `${leaf.nivel || 'sin-nivel'}:${leaf.id}`;
      if (!leafAssignments.has(key)) {
        leafAssignments.set(key, []);
      }
      leafAssignments.get(key).push({
        mapId: map.id,
        name: map.name || 'Sin nombre',
        nivel: leaf.nivel || null,
        nodeId: leaf.id
      });
    }

    summary.stats.mapsWithoutJerarquia = summary.issues.missingJerarquiaPath.length;
    summary.stats.uniqueLeafNodes = leafAssignments.size;

    for (const [, maps] of leafAssignments.entries()) {
      if (Array.isArray(maps) && maps.length > 1) {
        summary.issues.duplicateLeafAssignments.push(maps);
      }
    }

    summary.stats.duplicateLeafNodes = summary.issues.duplicateLeafAssignments.length;

    for (const area of this.areas) {
      if (!area || typeof area !== 'object') {
        continue;
      }
      const mapId = area.mapId;
      if (!mapsById.has(mapId)) {
        summary.issues.orphanAreas.push({ areaId: area.id, mapId, name: area.name || null });
        continue;
      }
      mapAreaCounts.set(mapId, (mapAreaCounts.get(mapId) || 0) + 1);
    }

    summary.stats.areasOrphan = summary.issues.orphanAreas.length;

    for (const map of this.maps) {
      if (!mapAreaCounts.has(map.id)) {
        summary.issues.mapsWithoutAreas.push({ mapId: map.id, name: map.name || 'Sin nombre' });
      }
    }

    summary.stats.mapsWithoutAreas = summary.issues.mapsWithoutAreas.length;

    if (log) {
      this.printMapAuditSummary(summary);
    }

    return summary;
  }

  printMapAuditSummary(summary) {
    if (!summary) {
      console.warn('Resumen de auditoria no disponible');
      return;
    }

    console.groupCollapsed('📊 Auditoria de mapas y jerarquia');
    console.log('Timestamp:', summary.timestamp);
    console.table(summary.stats);

    const logIssues = (label, items) => {
      if (Array.isArray(items) && items.length) {
        console.group(label);
        console.table(items);
        console.groupEnd();
      }
    };

    logIssues('Mapas sin jerarquiaPath', summary.issues.missingJerarquiaPath);
    logIssues('Mapas sin nodo hoja', summary.issues.missingLeafNode);
    if (Array.isArray(summary.issues.duplicateLeafAssignments) && summary.issues.duplicateLeafAssignments.length) {
      console.group('Mapas duplicados por nodo hoja');
      summary.issues.duplicateLeafAssignments.forEach((group, index) => {
        console.group(`Nodo duplicado ${index + 1}`);
        console.table(group);
        console.groupEnd();
      });
      console.groupEnd();
    }
    logIssues('Areas huerfanas', summary.issues.orphanAreas);
    logIssues('Mapas sin areas asociadas', summary.issues.mapsWithoutAreas);
    console.groupEnd();
  }
}

//  Crear instancia de MapStorage (usa el fsManager ya existente)
const mapStorage = new MapStorageService(fsManager);
console.log(' MapStorage inicializado');

/* FIN MAP STORAGE SERVICE */

/* 
    MAP CONTROLLER - INTEGRADO DESDE APP_BASE (FASE 4B)
   
   Controlador principal del editor de mapas con canvas, zoom, pan y dibujo de reas.
    */

const mapController = {
  elements: {},
  cachedJerarquiaOptions: null,
  cachedJerarquiaStructure: null,
  cachedJerarquiaVersion: 0,
  
  // 
  //  SISTEMA DE CATEGORAS PARA REAS (Etapa 1.2)
  // 
  categories: {
    area: { 
      icon: '', 
      color: '#3b82f6',
      name: 'rea',
      description: 'Zona general de planta'
    },
    maquina: { 
      icon: '', 
      color: '#10b981',
      name: 'Mquina',
      description: 'Equipo industrial principal'
    },
    estructura: { 
      icon: '', 
      color: '#64748b',
      name: 'Estructura',
      description: 'Componente estructural'
    },
    cinta: { 
      icon: '', 
      color: '#f59e0b',
      name: 'Cinta',
      description: 'Transportador o cinta'
    },
    componente: { 
      icon: '', 
      color: '#8b5cf6',
      name: 'Componente',
      description: 'Pieza o elemento menor'
    }
  },

  jerarquiaLevelConfig: {
    empresa: { label: 'Empresa', childKey: 'areas', childNivel: 'area' },
    area: { label: 'rea', childKey: 'subAreas', childNivel: 'subArea' },
    subArea: { label: 'Sub-rea', childKey: 'sistemas', childNivel: 'sistema' },
    sistema: { label: 'Sistema', childKey: 'subSistemas', childNivel: 'subSistema' },
    subSistema: { label: 'Sub-Sistema', childKey: 'secciones', childNivel: 'seccion' },
    seccion: { label: 'Seccin', childKey: 'subSecciones', childNivel: 'subSeccion' },
    subSeccion: { label: 'Sub-Seccin', childKey: null, childNivel: null }
  },
  // JERARQUÍA UNIFICADA DE 7 NIVELES (sincronizada con app.js)
  areaJerarquiaFieldOrder: ['nivel1', 'nivel2', 'nivel3', 'nivel4', 'nivel5', 'nivel6', 'nivel7'],
  areaJerarquiaFieldOrderLegacy: ['planta', 'areaGeneral', 'subArea', 'sistemaEquipo', 'subSistema', 'seccion', 'detalle'],
  
  state: {
    currentMapId: null,
    currentMap: null,
    currentImage: null,
    currentImageUrl: null,
    imageLODs: [],
    imageDimensions: { width: 0, height: 0 },
    usingBitmapRenderer: false,
    scale: 1,
    minScale: 0.05,
    maxScale: 20,
    offsetX: 0,
    offsetY: 0,
    isPanning: false,
    panStartX: 0,
    panStartY: 0,
    drawing: false,
    tempPoints: [],
    previewPoint: null,
    highlightAreaId: null, // Antes highlightZoneId
    showGrid: false,
    showRulers: false, //  NUEVO: Mostrar reglas laterales
    gridSize: 50, //  NUEVO: Tamao de celda del grid (pxeles)
    showMinimap: true, //  NUEVO: Mostrar minimap por defecto
    mostrarNombresAreas: true, //  NUEVO: Mostrar nombres de reas
    mostrarPuntosRepuestos: true, //  NUEVO: Mostrar puntos de repuestos
    repuestoFiltrado: null, //  NUEVO: ID del repuesto filtrado
    tooltipPinned: false, //  Tooltip fijado al hacer click
    pinnedAreaId: null, //  ID del rea cuyo tooltip est fijado
    cascadaEditMode: false, //  NUEVO: Modo edicin drag & drop en cascada
    mostrarSoloConJerarquia: false, //  NUEVO: Filtro para ocultar elementos sin jerarqua
    draggedRepuesto: null, //  NUEVO: Repuesto siendo arrastrado
    dropTargetArea: null, //  NUEVO: rea objetivo del drop
    areas: [], // Antes zones
    categoryFilter: null, // NUEVO: filtro activo por categora
    
    jerarquiaBranchFilter: null,
    //  ETAPA 3.1: Seleccin mltiple
    selectedAreaIds: [], // IDs de reas seleccionadas
    isMultiSelectMode: false, // Modo seleccin mltiple activo
    
    //  ETAPA 3.2: Edicin de puntos de reas (reshape)
    isReshapeMode: false, // Modo reshape activo
    reshapeAreaId: null, // ID del rea siendo editada
    reshapePoints: [], // Puntos del rea en edicin
    selectedPointIndex: null, // ndice del punto seleccionado
    isDraggingPoint: false, // Arrastrando un punto
    hoveredPointIndex: null, // Punto bajo el cursor
    hoveredEdgeIndex: null, // Borde bajo el cursor (para agregar punto)
    
    // Modo de edicin de puntos
    editingAreaId: null, // Antes editingZoneId
    editingPoints: [],
    selectedPointIndex: null,
    isDraggingPoint: false,
    // Performance optimization
    animationFrameId: null,
    needsRedraw: false,

    // Sincronizacin con jerarqua/inventario
    pendingJerarquiaRefresh: false,
    pendingCatalogRefresh: false,
    lastJerarquiaSync: null,
    contractAudit: null,
    lastCatalogSync: null,

    // Asignacin temporal de jerarqua para mapas
    tempJerarquiaAssignment: null,
    mapFormContext: null,

    // Overlay de carga de mapas
    mapLoadingActive: false,
    mapLoadingProgress: 0,
    mapLoadingHideTimeout: null
  },

  viewportState: null,
  mapViewportStorageKey: 'mapViewportState_v1',
  viewportPersistDelay: 600,
  viewportSaveTimer: null,
  viewportChangedDuringPan: false,

  restoreViewportState() {
    try {
      const raw = localStorage.getItem(this.mapViewportStorageKey);
      if (raw) {
        this.viewportState = JSON.parse(raw);
      }
    } catch (error) {
      console.warn('No se pudo restaurar el estado visual del mapa:', error);
    }

    if (!this.viewportState || typeof this.viewportState !== 'object') {
      this.viewportState = { lastMapId: null, views: {} };
    } else {
      this.viewportState.lastMapId = this.viewportState.lastMapId || null;
      this.viewportState.views = this.viewportState.views || {};
    }
  },

  captureCurrentViewportSnapshot() {
    if (!this.state.currentMapId) return null;
    const scale = Number(this.state.scale);
    const offsetX = Number(this.state.offsetX);
    const offsetY = Number(this.state.offsetY);
    if (!Number.isFinite(scale) || !Number.isFinite(offsetX) || !Number.isFinite(offsetY)) {
      return null;
    }

    const clampedScale = Math.min(this.state.maxScale, Math.max(this.state.minScale, scale));
    return {
      mapId: this.state.currentMapId,
      scale: clampedScale,
      offsetX,
      offsetY
    };
  },

  getLastViewedMapId() {
    return this.viewportState?.lastMapId || null;
  },

  getPersistedViewportForMap(mapId) {
    if (!mapId || !this.viewportState || !this.viewportState.views) {
      return null;
    }
    return this.viewportState.views[mapId] || null;
  },

  sanitizeViewportSnapshot(snapshot) {
    if (!snapshot || typeof snapshot !== 'object') {
      return null;
    }
    const scale = Number(snapshot.scale);
    const offsetX = Number(snapshot.offsetX);
    const offsetY = Number(snapshot.offsetY);
    if (!Number.isFinite(scale) || !Number.isFinite(offsetX) || !Number.isFinite(offsetY)) {
      return null;
    }
    return {
      scale: Math.min(this.state.maxScale, Math.max(this.state.minScale, scale)),
      offsetX,
      offsetY
    };
  },

  applyViewportSnapshot(snapshot) {
    const sanitized = this.sanitizeViewportSnapshot(snapshot);
    if (!sanitized) return false;
    this.state.scale = sanitized.scale;
    this.state.offsetX = sanitized.offsetX;
    this.state.offsetY = sanitized.offsetY;
    return true;
  },

  queueViewportPersist(reason = 'auto') {
    if (!this.state.currentMapId) return;
    if (this.viewportSaveTimer) {
      clearTimeout(this.viewportSaveTimer);
    }
    this.viewportSaveTimer = setTimeout(() => {
      this.persistViewportState(reason);
    }, this.viewportPersistDelay);
  },

  persistViewportState(reason = 'auto') {
    if (!this.state.currentMapId) {
      return;
    }

    const snapshot = this.captureCurrentViewportSnapshot();
    if (!snapshot) {
      return;
    }

    if (!this.viewportState || typeof this.viewportState !== 'object') {
      this.viewportState = { lastMapId: null, views: {} };
    }

    this.viewportState.lastMapId = snapshot.mapId;
    const entry = {
      scale: snapshot.scale,
      offsetX: snapshot.offsetX,
      offsetY: snapshot.offsetY,
      updatedAt: Date.now()
    };
    this.viewportState.views[snapshot.mapId] = entry;

    const viewEntries = Object.entries(this.viewportState.views);
    const maxEntries = 25;
    if (viewEntries.length > maxEntries) {
      viewEntries
        .sort((a, b) => (a[1]?.updatedAt || 0) - (b[1]?.updatedAt || 0))
        .slice(0, viewEntries.length - maxEntries)
        .forEach(([key]) => delete this.viewportState.views[key]);
    }

    try {
      localStorage.setItem(this.mapViewportStorageKey, JSON.stringify(this.viewportState));
    } catch (error) {
      console.warn('No se pudo guardar el estado visual del mapa:', error, reason);
    }

    if (this.viewportSaveTimer) {
      clearTimeout(this.viewportSaveTimer);
      this.viewportSaveTimer = null;
    }
  },


  init() {
    //  Cargar categoras personalizadas desde localStorage
    const savedCategories = localStorage.getItem('mapCategories');
    if (savedCategories) {
      try {
        this.categories = JSON.parse(savedCategories);
        console.log(' Categoras personalizadas cargadas:', Object.keys(this.categories));
      } catch (e) {
        console.warn(' Error al cargar categoras personalizadas:', e);
      }
    }

    this.restoreViewportState();

    if (typeof window !== 'undefined' && window.addEventListener) {
      window.addEventListener('beforeunload', () => {
        this.persistViewportState('beforeunload');
      });
    }

    this.elements = {
      shell: document.querySelector('.map-shell'),
      connectBtn: document.getElementById('mapConnectBtn'),
      cleanImagesBtn: document.getElementById('mapCleanImagesBtn'),
      newBtn: document.getElementById('mapNewBtn'),
      drawBtn: document.getElementById('mapDrawAreaBtn'), // Antes mapDrawZoneBtn
      saveBtn: document.getElementById('mapSaveAreasBtn'), // Antes mapSaveZonesBtn
      mapList: document.getElementById('mapList'),
      areaList: document.getElementById('areaList'), // Antes zoneList
      jerarquiaBadge: document.getElementById('mapJerarquiaBadge'),
      jerarquiaBranch: document.getElementById('mapJerarquiaBranch'),
      contractPanel: document.getElementById('mapContractAuditPanel'),
      contractIssueList: document.getElementById('mapContractIssueList'),
      contractRefreshBtn: document.getElementById('mapContractAuditRefresh'),
      contractTimestamp: document.getElementById('mapContractAuditTimestamp'),
      contractStats: {
        total: document.getElementById('mapAuditTotal'),
        compliant: document.getElementById('mapAuditCompliant'),
        pending: document.getElementById('mapAuditPending'),
        conflicts: document.getElementById('mapAuditConflicts')
      },
      logList: document.getElementById('mapLogList'),
      logRefreshBtn: document.getElementById('mapLogRefreshBtn'),
      connectionBadge: document.getElementById('mapConnectionBadge'),
      status: document.getElementById('mapStatus'),
      zoomBadge: document.getElementById('mapZoomBadge'),
      metaBadge: document.getElementById('mapMetaBadge'),
      toolbar: document.getElementById('mapToolbar'),
      canvasStage: document.querySelector('.map-canvas-stage'),
      canvas: document.getElementById('mapCanvas'),
      hint: document.getElementById('mapHint'),
      tooltip: document.getElementById('mapTooltip'), //  NUEVO: Tooltip para reas
      minimapContainer: document.getElementById('mapMinimapContainer'), //  NUEVO: Contenedor minimap
      minimap: document.getElementById('mapMinimap'), //  NUEVO: Canvas minimap
      minimapViewport: document.getElementById('mapMinimapViewport'), //  NUEVO: Indicador viewport
      modal: document.getElementById('mapModalOverlay'),
      modalBody: document.getElementById('mapModalBody'),
      modalTitle: document.getElementById('mapModalTitle'),
      modalClose: document.getElementById('mapModalClose'),
      mapLoadingOverlay: document.getElementById('mapLoadingOverlay'),
      mapLoadingTitle: document.getElementById('mapLoadingTitle'),
      mapLoadingStatus: document.getElementById('mapLoadingStatus'),
      mapLoadingBar: document.getElementById('mapLoadingBar'),
      mapLoadingPercent: document.getElementById('mapLoadingPercent')
    };
    this.state.contractAudit = this.buildContractAuditReport();
    this.renderContractAudit();

    if (!this.elements.canvas) {
      console.warn('mapController: canvas no disponible');
      return;
    }

    this.ctx = this.elements.canvas.getContext('2d', { alpha: false, desynchronized: true });
    
    //  NUEVO: Inicializar contexto del minimap
    if (this.elements.minimap) {
      this.minimapCtx = this.elements.minimap.getContext('2d', { alpha: true });
    }
    
    this.bindEvents();
    this.updateConnectionBadge();
    this.resizeCanvas();

    if (mapStorage.initialized) {
      this.loadData();
    } else if (fsManager.isConnected) {
      mapStorage.init({ autoReconnect: false }).then(() => this.loadData()).catch((error) => {
        console.warn('mapController: no se pudo inicializar mapStorage de inmediato', error);
      });
    } else {
      this.drawMessage('Conecta la carpeta INVENTARIO_STORAGE para comenzar.');
      this.renderMapList([]);
      this.renderAreaList([]);
      this.updateMapJerarquiaBadge();
    }

    if (this.state.pendingJerarquiaRefresh) {
      this.handleJerarquiaStructureUpdate({ silent: true, reason: 'pending-refresh' });
    }

    if (this.state.pendingCatalogRefresh) {
      this.handleJerarquiaCatalogUpdate({ silent: true, reason: 'pending-refresh' });
    }
  },

  bindEvents() {
    const { connectBtn, cleanImagesBtn, newBtn, drawBtn, toolbar, logRefreshBtn, modalClose, modal } = this.elements;

    if (connectBtn) connectBtn.addEventListener('click', () => this.handleConnect());
    if (cleanImagesBtn) cleanImagesBtn.addEventListener('click', () => this.cleanOrphanMapImages());
    if (newBtn) newBtn.addEventListener('click', () => this.openNewMapModal());
    if (drawBtn) drawBtn.addEventListener('click', () => this.toggleDrawingMode());
    
    //  BOTN AGREGAR MARCADOR
    const addMarkerBtn = document.getElementById('mapAddMarkerBtn');
    if (addMarkerBtn) {
      addMarkerBtn.addEventListener('click', () => this.toggleModoAgregarMarcador());
    }
    
    if (toolbar) {
      toolbar.addEventListener('click', (event) => {
        const target = event.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        event.preventDefault();
        this.handleToolbarAction(action);
      });
    }
    if (logRefreshBtn) logRefreshBtn.addEventListener('click', () => this.refreshLog());
    if (modalClose) modalClose.addEventListener('click', () => this.closeModal());
    if (modal) modal.addEventListener('click', (event) => {
      if (event.target === modal) this.closeModal();
    });

    // Event listeners para filtros de historial
    const filterAction = document.getElementById('mapLogFilterAction');
    const filterScope = document.getElementById('mapLogFilterScope');
    const helpBtn = document.getElementById('mapLogHelpBtn');
    
    if (filterAction) filterAction.addEventListener('change', () => this.refreshLog());
    if (filterScope) filterScope.addEventListener('change', () => this.refreshLog());
    if (helpBtn) helpBtn.addEventListener('click', () => this.showHistorialHelp());

    //  NUEVO: Event listeners para filtros de categora
    const categoryFilterBtns = document.querySelectorAll('.map-category-filter-btn');
    categoryFilterBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const category = e.target.dataset.category;
        this.applyCategoryFilter(category);
        
        // Actualizar estilos de botones activo/inactivo
        categoryFilterBtns.forEach(b => {
          if (b.dataset.category === category) {
            b.style.background = 'var(--primary)';
            b.style.color = 'white';
          } else {
            b.style.background = 'var(--bg-tertiary)';
            b.style.color = 'var(--text-primary)';
          }
        });
      });
    });

    //  NUEVO: Event listener para buscador de reas
    const areaSearchInput = document.getElementById('mapAreaSearch');
    if (areaSearchInput) {
      areaSearchInput.addEventListener('input', () => {
        // Re-renderizar la lista con el filtro de bsqueda aplicado
        if (this.state.currentMapId) {
          const currentAreas = this.state.areas.filter(a => a.mapId === this.state.currentMapId);
          this.renderAreaList(currentAreas);
        }
      });
    }

    if (this.elements.contractRefreshBtn) {
      this.elements.contractRefreshBtn.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        this.runContractAudit();
      });
    }

    if (this.elements.contractIssueList) {
      this.elements.contractIssueList.addEventListener('click', (event) => {
        const actionBtn = event.target.closest('[data-action]');
        if (!actionBtn) {
          return;
        }
        event.preventDefault();
        event.stopPropagation();
        this.handleContractIssueAction(actionBtn.dataset.action, actionBtn.dataset);
      });
    }

    if (this.elements.jerarquiaBadge) {
      this.elements.jerarquiaBadge.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;
        const actionBtn = target.closest('[data-action="badge-assign-jerarquia"]');
        if (!actionBtn) return;
        event.preventDefault();
        event.stopPropagation();
        if (this.state.currentMapId) {
          this.openAssignJerarquiaModal(this.state.currentMapId);
        } else {
          this.showToast('Selecciona un mapa primero.', 'info');
        }
      });
    }

    if (this.elements.jerarquiaBranch) {
      this.elements.jerarquiaBranch.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;

        const clearBtn = target.closest('[data-action="branch-clear-filter"]');
        if (clearBtn) {
          event.preventDefault();
          event.stopPropagation();
          this.clearJerarquiaBranchFilter();
          return;
        }

        const nodeBtn = target.closest('[data-branch-index]');
        if (!nodeBtn) return;

        const index = parseInt(nodeBtn.getAttribute('data-branch-index'), 10);
        if (Number.isNaN(index)) {
          return;
        }
        event.preventDefault();
        this.toggleJerarquiaBranchFilter(index);
      });
    }

    //  NUEVO: Event listener para clic en minimap
    if (this.elements.minimap) {
      this.elements.minimap.addEventListener('click', (event) => {
        this.handleMinimapClick(event);
      });
    }

    this.registerCanvasEvents();
    window.addEventListener('resize', () => this.handleResize());
  },

  async handleConnect() {
    if (typeof fsManager?.checkFileSystemAPI === 'function' && !fsManager.checkFileSystemAPI()) {
      this.showToast('Tu navegador no soporta File System Access API. Usa Microsoft Edge o Chrome.', 'warning');
      return;
    }

    //  USAR MTODO CENTRALIZADO
    try {
      console.log(' Iniciando conexin...');
      const connected = await LoadingModal.runTask(
        () => app.connectWorkspace(false, true),
        {
          startMessage: 'Conectando carpeta...',
          statusMessage: 'Solicitando permisos...',
          successMessage: 'Carpeta lista',
          errorMessage: 'Operacin cancelada',
          autoHide: false,
          tips: [
            'Autoriza la carpeta INVENTARIO_STORAGE cuando el navegador lo solicite.',
            'Puedes cambiar la carpeta en cualquier momento desde Configuración.',
            'No cierres la ventana hasta que la sincronización finalice.'
          ]
        }
      );
      console.log(' Resultado conexin:', connected);
      LoadingModal.finish({
        message: 'Carpeta conectada',
        status: 'Sincronización completa',
        tip: 'Recargando para usar tu carpeta principal...',
        delay: 800
      });
      
      //  SIEMPRE recargar pgina despus de intentar conectar
      console.log(' Recargando pgina en 1 segundo...');
      setTimeout(() => {
        location.reload();
      }, 1000);
      
    } catch (error) {
      console.error('Error conectando carpeta:', error);
      this.showToast('No se pudo conectar la carpeta: ' + (error?.message || error), 'error');
      LoadingModal.finish({
        message: 'Conexión interrumpida',
        status: 'Revisa los permisos',
        tip: 'Vuelve a intentar seleccionando la carpeta nuevamente.',
        delay: 800
      });
    }
  },

  updateConnectionBadge() {
    const { connectionBadge, status } = this.elements;
    if (!connectionBadge) return;

    if (mapStorage.initialized && fsManager.isConnected) {
      connectionBadge.textContent = fsManager.folderPath || 'INVENTARIO_STORAGE';
      connectionBadge.classList.remove('map-status-badge--off');
      connectionBadge.classList.add('map-status-badge--on');
      if (status) {
        status.textContent = 'Selecciona un mapa o crea uno nuevo para comenzar a trabajar.';
      }
    } else {
      connectionBadge.textContent = 'Sin carpeta';
      connectionBadge.classList.remove('map-status-badge--on');
      connectionBadge.classList.add('map-status-badge--off');
      if (status) {
        status.textContent = 'Conecta la carpeta INVENTARIO_STORAGE para habilitar el editor de mapas.';
      }
    }
  },

  async loadData(options = {}) {
    if (!mapStorage.initialized) {
      this.renderMapList([]);
      this.renderAreaList([]);
      this.drawMessage('Conecta la carpeta INVENTARIO_STORAGE para comenzar.');
      this.updateMapJerarquiaBadge();
      return;
    }

    try {
      if (options.force) {
        await mapStorage.ensureStructure();
        await Promise.all([mapStorage.loadMaps(), mapStorage.loadAreas()]);
      }

      const maps = mapStorage.maps || [];
      this.renderMapList(maps);

      if (!maps.length) {
        this.state.currentMapId = null;
        this.state.currentMap = null;
        this.state.jerarquiaBranchFilter = null;
        this.state.areas = [];
        this.cleanupImage();
        this.renderAreaList([]);
        this.drawMessage('Crea un mapa para comenzar a dibujar zonas.');
        this.updateMapJerarquiaBadge();
        return;
      }

      const hasMap = (mapId) => maps.some((m) => Number(m.id) === Number(mapId));
      let targetMapId = this.state.currentMapId && hasMap(this.state.currentMapId)
        ? this.state.currentMapId
        : null;

      if (!targetMapId) {
        const persistedId = this.getLastViewedMapId();
        if (persistedId && hasMap(persistedId)) {
          targetMapId = persistedId;
        }
      }

      if (!targetMapId) {
        targetMapId = maps[0].id;
      }

      const keepViewport = Boolean(this.state.currentMapId && this.state.currentMapId === targetMapId);
      await this.selectMap(targetMapId, { keepViewport });

      await this.refreshLog();
      this.runContractAudit({ silent: true });
    } catch (error) {
      console.error('mapController.loadData error:', error);
      this.showToast('No se pudieron cargar los mapas. Revisa la consola.', 'error');
      this.renderContractAudit();
    }
  },

  renderMapList(maps) {
    const { mapList } = this.elements;
    if (!mapList) return;

    if (!Array.isArray(maps) || !maps.length) {
      mapList.classList.remove('map-hierarchy-list');
      mapList.innerHTML = `<div style="padding: 16px; border: 1px dashed var(--border-color); border-radius: 10px; color: var(--text-secondary); font-size: 0.85rem;">An no hay mapas registrados.</div>`;
      return;
    }

    const tree = this.buildMapHierarchyTree(maps);
    const hierarchyHtml = this.renderMapHierarchyGroups(tree.children, 0);
    mapList.classList.add('map-hierarchy-list');
    mapList.innerHTML = hierarchyHtml;

    this.attachMapHierarchyEvents();
    this.attachMapCardEvents();
  },

  getMapHierarchyPath(map) {
    if (map && Array.isArray(map.jerarquiaPath) && map.jerarquiaPath.length) {
      return map.jerarquiaPath.map(node => ({
        id: node.id || null,
        nivel: node.nivel || null,
        nombre: node.nombre || null
      }));
    }

    return [{ id: 'sin-jerarquia', nivel: 'sin-nivel', nombre: 'Sin jerarqua asignada' }];
  },

  getJerarquiaNodeName(node) {
    if (!node) {
      return 'Sin nombre';
    }

    const found = this.findJerarquiaNodeInTree(node.id, node.nivel);
    return found?.nombre || node.nombre || node.id || 'Nivel sin nombre';
  },

  buildMapHierarchyTree(maps) {
    const root = { key: 'root', label: 'root', fullPath: '', children: new Map(), maps: [] };

    maps.forEach(map => {
      const path = this.getMapHierarchyPath(map);
      let current = root;

      path.forEach((node, index) => {
        const key = `${node.id || 'nivel'}-${node.nivel || index}`;
        if (!current.children.has(key)) {
          const partialPath = path.slice(0, index + 1);
          current.children.set(key, {
            key,
            label: this.getJerarquiaNodeName(node),
            fullPath: this.getJerarquiaPathLabel(partialPath),
            nivel: node.nivel || null,
            children: new Map(),
            maps: []
          });
        }

        current = current.children.get(key);
      });

      current.maps.push(map);
    });

    return root;
  },

  sortHierarchyChildren(childrenMap) {
    return Array.from(childrenMap.values()).sort((a, b) => a.label.localeCompare(b.label || '', 'es', { sensitivity: 'base' }));
  },

  countMapsInGroup(group) {
    let total = Array.isArray(group.maps) ? group.maps.length : 0;
    if (group.children && group.children.size) {
      total += Array.from(group.children.values()).reduce((acc, child) => acc + this.countMapsInGroup(child), 0);
    }
    return total;
  },

  renderMapHierarchyGroups(childrenMap, depth = 0) {
    if (!childrenMap || !childrenMap.size) {
      return '';
    }

    return this.sortHierarchyChildren(childrenMap).map(group => {
      const totalMaps = this.countMapsInGroup(group);
      const hasChildren = !!(group.children && group.children.size);
      const mapCount = Array.isArray(group.maps) ? group.maps.length : 0;
      const mapRef = mapCount === 1 ? group.maps[0] : null;
      const headerClasses = `map-hierarchy-header ${hasChildren ? 'map-hierarchy-header--clickable' : 'map-hierarchy-header--static'} ${mapRef ? 'map-hierarchy-header--map' : ''} ${mapRef && String(this.state.currentMapId) === String(mapRef.id) ? 'map-hierarchy-header--active' : ''}`;
      const headerAttributes = mapRef ? `data-map-id="${mapRef.id}"` : '';
      const tooltip = mapRef ? this.renderGroupTooltip(mapRef) : '';
      const actionsHtml = mapRef ? this.renderGroupActions(mapRef) : '';
      const nestedHtml = group.children?.size ? `<div class="map-hierarchy-children">${this.renderMapHierarchyGroups(group.children, depth + 1)}</div>` : '';
      const mapList = mapRef ? [] : (group.maps || []);
      const mapsHtml = mapList.length ? `<div class="map-hierarchy-leaf-list">${mapList.map((map) => this.renderMapHierarchyLeaf(map)).join('')}</div>` : '';

      return `
        <div class="map-hierarchy-group" data-depth="${depth}">
          <div class="${headerClasses}" ${headerAttributes}>
            <div class="map-hierarchy-header-main">
              <span class="map-hierarchy-chevron" data-action="toggle-group"></span>
              <div>
                <div class="map-hierarchy-label">${this.escapeHtml(group.label)}</div>
                ${group.fullPath ? `<div class="map-hierarchy-path">${this.escapeHtml(group.fullPath)}</div>` : ''}
              </div>
            </div>
            <span class="map-hierarchy-count">
              ${actionsHtml}
              ${totalMaps} mapa${totalMaps === 1 ? '' : 's'}
            </span>
            ${tooltip}
          </div>
          <div class="map-hierarchy-body">
            ${mapsHtml}
            ${nestedHtml}
          </div>
        </div>
      `;
    }).join('');
  },

  renderMapCard(map) {
    const isActive = this.state.currentMapId === map.id;
    const hasJerarquia = Array.isArray(map.jerarquiaPath) && map.jerarquiaPath.length > 0;
    const pathLabel = hasJerarquia ? this.getJerarquiaPathLabel(map.jerarquiaPath) : 'Sin jerarqua asignada';

    return `
      <article class="map-card ${isActive ? 'map-card--active' : ''}" data-map-id="${map.id}">
        <div class="map-card-content" data-action="select-map">
          <div class="map-card-title">${this.escapeHtml(map.name || 'Mapa sin nombre')}</div>
          <div class="map-card-path ${hasJerarquia ? '' : 'map-card-path--empty'}">${this.escapeHtml(pathLabel)}</div>
        </div>
      </article>
    `;
  },

  getAreasCountForMap(mapId) {
    if (!mapStorage || !Array.isArray(mapStorage.areas)) {
      return 0;
    }
    return mapStorage.areas.filter(z => z.mapId === mapId).length;
  },

  renderGroupTooltip(map) {
    if (!map) {
      return '';
    }

    const createdAt = map.createdAt ? new Date(map.createdAt).toLocaleDateString('es-CL') : '';
    const dimensions = map.width && map.height ? `${map.width}  ${map.height}px` : 'Dimensiones pendientes';
    const areasCount = this.getAreasCountForMap(map.id);
    const pathLabel = Array.isArray(map.jerarquiaPath) && map.jerarquiaPath.length
      ? this.getJerarquiaPathLabel(map.jerarquiaPath)
      : '';

    const rows = [
      `<span class="map-hierarchy-tooltip-line"><strong>${this.escapeHtml(map.name || 'Mapa sin nombre')}</strong></span>`,
      pathLabel ? `<span class="map-hierarchy-tooltip-line">Ruta: ${this.escapeHtml(pathLabel)}</span>` : null,
      `<span class="map-hierarchy-tooltip-line">${areasCount} rea(s) registradas</span>`,
      dimensions ? `<span class="map-hierarchy-tooltip-line">Resolucin: ${this.escapeHtml(dimensions)}</span>` : null,
      createdAt ? `<span class="map-hierarchy-tooltip-line">Creado: ${this.escapeHtml(createdAt)}</span>` : null
    ].filter(Boolean).join('');

    return `<div class="map-hierarchy-tooltip">${rows}</div>`;
  },

  renderGroupActions(map) {
    return `
      <span class="map-hierarchy-actions">
        <button class="map-card-btn map-card-btn--link" data-action="assign-jerarquia" data-map-id="${map.id}" title="Asignar jerarqua">Jerarqua</button>
        <button class="map-card-btn map-card-btn--edit" data-action="edit-map" data-map-id="${map.id}" title="Editar mapa"></button>
        <button class="map-card-btn map-card-btn--delete" data-action="delete-map" data-map-id="${map.id}" title="Eliminar mapa"></button>
      </span>
    `;
  },

  renderMapHierarchyLeaf(map) {
    if (!map) return '';

    const isActive = String(this.state.currentMapId) === String(map.id);
    const areasCount = this.getAreasCountForMap(map.id);

    return `
      <div class="map-hierarchy-leaf ${isActive ? 'map-hierarchy-leaf--active' : ''}" data-map-id="${map.id}">
        <div class="map-hierarchy-leaf-main">
          <span class="map-hierarchy-leaf-label">${this.escapeHtml(map.name || 'Mapa sin nombre')}</span>
          <span class="map-hierarchy-leaf-meta">${areasCount} rea${areasCount === 1 ? '' : 's'}</span>
        </div>
        <div class="map-hierarchy-leaf-right">
          ${this.renderGroupActions(map)}
        </div>
        ${this.renderGroupTooltip(map)}
      </div>
    `;
  },

  attachMapHierarchyEvents() {
    const { mapList } = this.elements;
    if (!mapList) return;

    Array.from(mapList.querySelectorAll('.map-hierarchy-chevron[data-action="toggle-group"]')).forEach(toggle => {
      toggle.addEventListener('click', (event) => {
        event.stopPropagation();
        const groupEl = toggle.closest('.map-hierarchy-group');
        if (!groupEl) return;
        groupEl.classList.toggle('map-hierarchy-group--collapsed');
      });
    });

    Array.from(mapList.querySelectorAll('.map-hierarchy-header--clickable:not([data-map-id])')).forEach(header => {
      header.addEventListener('click', () => {
        const groupEl = header.closest('.map-hierarchy-group');
        if (!groupEl) return;
        groupEl.classList.toggle('map-hierarchy-group--collapsed');
      });
    });

    Array.from(mapList.querySelectorAll('.map-hierarchy-header[data-map-id]')).forEach(header => {
      header.addEventListener('click', async () => {
        const mapId = header.getAttribute('data-map-id');
        if (!mapId) return;
        await this.selectMap(mapId);
      });
    });

    Array.from(mapList.querySelectorAll('.map-hierarchy-leaf[data-map-id]')).forEach(leaf => {
      leaf.addEventListener('click', async () => {
        const mapId = leaf.getAttribute('data-map-id');
        if (!mapId) return;
        await this.selectMap(mapId);
      });
    });
  },

  attachMapCardEvents() {
    const { mapList } = this.elements;
    if (!mapList) return;

    Array.from(mapList.querySelectorAll('[data-action="select-map"]')).forEach(content => {
      content.addEventListener('click', async (e) => {
        const card = e.target.closest('.map-card');
        const mapId = card?.getAttribute('data-map-id');
        if (!mapId) return;
        await this.selectMap(mapId);
      });
    });

    Array.from(mapList.querySelectorAll('[data-action="edit-map"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const mapId = btn.getAttribute('data-map-id');
        await this.openEditMapModal(mapId);
      });
    });

    Array.from(mapList.querySelectorAll('[data-action="assign-jerarquia"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const mapId = btn.getAttribute('data-map-id');
        await this.openAssignJerarquiaModal(mapId);
      });
    });

    Array.from(mapList.querySelectorAll('[data-action="delete-map"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const mapId = btn.getAttribute('data-map-id');
        await this.deleteMap(mapId);
      });
    });
  },

  //  FUNCIÓN CENTRALIZADA: Calcular correlativos GLOBALES para todo el sistema
  calcularCorrelativosGlobales(mapId) {
    if (!app || !app.repuestos || !Array.isArray(app.repuestos)) return {};
    
    const correlativosGlobales = {}; // { repuestoId: { ubicacionIndex: { numero, total } } }
    
    // Calcular correlativos globales por repuesto (igual que en árbol de jerarquía)
    app.repuestos.forEach(repuesto => {
      if (!repuesto.ubicaciones || !Array.isArray(repuesto.ubicaciones)) return;
      
      // Generar array con todas las instancias globales
      let ubicacionesConCantidad = [];
      repuesto.ubicaciones.forEach((ub, ubIndex) => {
        const cantidadEnUbicacion = ub.cantidadEnUbicacion || 1;
        for (let i = 1; i <= cantidadEnUbicacion; i++) {
          ubicacionesConCantidad.push({
            ubicacionIndex: ubIndex,
            instanciaLocal: i,
            ubicacion: ub
          });
        }
      });
      
      // Total global de instancias
      const totalGlobal = ubicacionesConCantidad.length;
      
      // Asignar correlativo global a cada instancia
      correlativosGlobales[repuesto.id] = {};
      ubicacionesConCantidad.forEach((item, globalIndex) => {
        const ubIndex = item.ubicacionIndex;
        
        if (!correlativosGlobales[repuesto.id][ubIndex]) {
          correlativosGlobales[repuesto.id][ubIndex] = [];
        }
        
        correlativosGlobales[repuesto.id][ubIndex].push({
          numero: globalIndex + 1,
          total: totalGlobal,
          instanciaLocal: item.instanciaLocal
        });
      });
    });
    
    return correlativosGlobales;
  },

  //  Obtener marcadores agrupados por área y categoría con numeración correlativa GLOBAL
  getMarcadoresPorArea(areaId) {
    if (!app || !app.repuestos || !Array.isArray(app.repuestos)) return {};
    
    const mapId = this.state.currentMapId;
    const marcadoresPorCategoria = {};
    
    // Obtener correlativos globales una sola vez
    const correlativosGlobales = this.calcularCorrelativosGlobales(mapId);
    
    app.repuestos.forEach(repuesto => {
      if (!repuesto.ubicaciones || !Array.isArray(repuesto.ubicaciones)) return;
      
      repuesto.ubicaciones.forEach((ubicacion, index) => {
        // Filtrar por mapa y área actual
        if (String(ubicacion.mapId) !== String(mapId)) return;
        if (String(ubicacion.areaId) !== String(areaId)) return;
        
        const categoria = ubicacion.categoria || 'Sin categoría';
        
        if (!marcadoresPorCategoria[categoria]) {
          marcadoresPorCategoria[categoria] = [];
        }
        
        // Obtener correlativos globales para esta ubicación (puede tener múltiples instancias)
        const corrInfoArray = correlativosGlobales[repuesto.id]?.[index] || [{ numero: 1, total: 1, instanciaLocal: 1 }];
        
        // Agregar una entrada por cada instancia
        corrInfoArray.forEach(corrInfo => {
          marcadoresPorCategoria[categoria].push({
            repuesto: repuesto,
            ubicacion: ubicacion,
            ubicacionIndex: index,
            numeroCorrelativo: corrInfo.numero,
            totalInstancias: corrInfo.total,
            instanciaLocal: corrInfo.instanciaLocal
          });
        });
      });
    });
    
    return marcadoresPorCategoria;
  },

  // Toggle para expandir/colapsar rea
  toggleArea(toggleBtn) {
    const areaDiv = toggleBtn.closest('[data-area-id]');
    if (!areaDiv) return;
    
    const children = areaDiv.nextElementSibling;
    if (!children || !children.classList.contains('area-children')) return;
    
    const isCollapsed = children.style.display === 'none';
    children.style.display = isCollapsed ? 'block' : 'none';
    toggleBtn.textContent = isCollapsed ? 'v' : '>';
  },

  //  Toggle para expandir/colapsar categora
  toggleCategoria(catHeader) {
    const catGroup = catHeader.closest('.categoria-group');
    if (!catGroup) return;
    
    const marcadores = catGroup.querySelector('.categoria-marcadores');
    const toggle = catHeader.querySelector('.categoria-toggle');
    if (!marcadores || !toggle) return;
    
    const isCollapsed = marcadores.style.display === 'none';
    marcadores.style.display = isCollapsed ? 'block' : 'none';
    toggle.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(-90deg)';
  },

  //  Hacer zoom a un marcador especfico
  focusOnMarker(repuestoId, ubicacionIndex) {
    //  Limpiar seleccin anterior antes de seleccionar nuevo
    const prevSelection = this.state.highlightMarker;
    const sameMarker = prevSelection && 
                       prevSelection.repuestoId === repuestoId && 
                       prevSelection.ubicacionIndex === ubicacionIndex;
    
    // Si es el mismo marcador, no hacer nada (ya est seleccionado)
    if (sameMarker) {
      console.log(' Marcador ya seleccionado');
      return;
    }
    
    //  Si haba una animacin anterior, detenerla
    if (prevSelection) {
      this.stopMarkerAnimation();
    }
    
    const repuesto = app.repuestos.find(r => r.id === repuestoId);
    if (!repuesto || !repuesto.ubicaciones || !repuesto.ubicaciones[ubicacionIndex]) {
      console.warn('focusOnMarker: repuesto o ubicacin no encontrada', { repuestoId, ubicacionIndex });
      return;
    }
    
    const ubicacion = repuesto.ubicaciones[ubicacionIndex];
    
    if (!ubicacion.markerX || !ubicacion.markerY) {
      console.warn('focusOnMarker: ubicacin sin coordenadas', ubicacion);
      return;
    }
    
    const canvas = this.elements.canvas;
    if (!canvas) {
      console.warn('focusOnMarker: canvas no disponible');
      return;
    }
    
    //  SOLUCIN: Centrar el marcador manteniendo el zoom actual
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    
    //  Calcular nuevo offset para centrar el marcador
    // Frmula canvas: screenPos = translate(offset) + scale(worldPos)
    // Para centrar: centerX = offsetX + (markerX * scale)
    // Por lo tanto: offsetX = centerX - (markerX * scale)
    this.state.offsetX = centerX - (ubicacion.markerX * this.state.scale);
    this.state.offsetY = centerY - (ubicacion.markerY * this.state.scale);
    
    console.log(` Marcador centrado: ${repuesto.nombre} #${ubicacionIndex + 1}`, {
      worldPos: [ubicacion.markerX.toFixed(1), ubicacion.markerY.toFixed(1)],
      zoom: `${Math.round(this.state.scale * 100)}%`,
      nuevoOffset: [this.state.offsetX.toFixed(1), this.state.offsetY.toFixed(1)]
    });
    
    //  Resaltar marcador de forma persistente
    this.state.highlightMarker = { repuestoId, ubicacionIndex };
    
    //  ANIMACIN: Iniciar loop para el efecto de halo pulsante
    this.startMarkerAnimation();
    
    // Redibujar para mostrar el resaltado
    this.draw();
    this.queueViewportPersist('focus-marker');
  },
  
  //  NUEVO: Iniciar animacin continua para marcador resaltado
  startMarkerAnimation() {
    // Si ya hay una animacin activa, no crear otra
    if (this.state.markerAnimationId) {
      return;
    }
    
    const animate = () => {
      // Solo continuar si hay un marcador resaltado
      if (this.state.highlightMarker) {
        this.draw();
        this.state.markerAnimationId = requestAnimationFrame(animate);
      } else {
        this.state.markerAnimationId = null;
      }
    };
    
    this.state.markerAnimationId = requestAnimationFrame(animate);
  },
  
  //  NUEVO: Detener animacin de marcador
  stopMarkerAnimation() {
    if (this.state.markerAnimationId) {
      cancelAnimationFrame(this.state.markerAnimationId);
      this.state.markerAnimationId = null;
    }
  },
  
  //  Limpiar seleccin de marcador (llamar al hacer click fuera o seleccionar otro)
  clearMarkerSelection() {
    if (this.state.highlightMarker) {
      this.state.highlightMarker = null;
      this.stopMarkerAnimation(); //  Detener animacin del halo
      this.scheduleRender();
    }
  },

  //  Abrir modal para editar datos de un marcador (jerarqua, categora)
  openEditMarkerModal(repuestoId, ubicacionIndex) {
    const repuesto = app.repuestos.find(r => r.id === repuestoId);
    if (!repuesto || !repuesto.ubicaciones || !repuesto.ubicaciones[ubicacionIndex]) {
      this.showToast(' Marcador no encontrado', 'error');
      return;
    }
    
    const ubicacion = repuesto.ubicaciones[ubicacionIndex];
    const area = this.state.areas.find(a => a.id === ubicacion.areaId);
    
    //  CALCULAR NIVEL SUGERIDO basado en la jerarqua del rea
    let nivelSugerido = 'N8'; // Por defecto N8 (Detalle)
    let razonSugerencia = '';
    
    const areaJerarquia = area ? this.normalizeAreaJerarquia(area.jerarquia) : null;
    if (areaJerarquia) {
      // Mapeo de niveles: planta  N2, areaGeneral  N3, subArea  N4, etc.
      const mapaJerarquia = {
        'planta': 'N2',
        'areaGeneral': 'N3', 
        'subArea': 'N4',
        'sistemaEquipo': 'N5',
        'subSistema': 'N6',
        'seccion': 'N7',
        'detalle': 'N8'
      };
      
      // Encontrar el nivel ms profundo definido en el rea
      const nivelesDefinidos = ['detalle', 'seccion', 'subSistema', 'sistemaEquipo', 'subArea', 'areaGeneral', 'planta'];
      for (const nivel of nivelesDefinidos) {
        if (areaJerarquia[nivel]) {
          nivelSugerido = mapaJerarquia[nivel];
          razonSugerencia = `Basado en ${areaJerarquia[nivel]}`;
          break;
        }
      }
      
      // Si el rea tiene nivel, el repuesto debera estar un nivel ms abajo
      const nivelNumerico = parseInt(nivelSugerido.substring(1));
      if (nivelNumerico < 8) {
        nivelSugerido = 'N' + (nivelNumerico + 1);
        razonSugerencia = `Repuesto dentro de ${razonSugerencia}`;
      }
    }
    
    // Obtener nivel jerrquico actual del repuesto
    const nivelActual = repuesto.nivelJerarquico || nivelSugerido;
    
    // Crear modal
    const modalHTML = `
      <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100000;">
        <div style="background: var(--bg-secondary); border-radius: 6px; padding: 20px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
          <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 1rem; font-weight: 600;">
             Editar Datos del Repuesto
          </h3>
          
          <div style="margin-bottom: 12px; padding: 10px; background: var(--bg-tertiary); border-radius: 4px;">
            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Repuesto:</div>
            <div style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">
              ${this.escapeHtml(repuesto.nombre)}
            </div>
            ${repuesto.codSAP ? `<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">SAP: ${repuesto.codSAP}</div>` : ''}
          </div>
          
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">
               Ubicacin Actual:
            </label>
            <div style="padding: 8px; background: var(--bg-tertiary); border-radius: 4px; color: var(--text-primary); font-size: 0.85rem;">
              ${this.escapeHtml(area ? area.name : 'Desconocida')}
            </div>
          </div>
          
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">
               Nivel Jerrquico:
            </label>
            ${nivelActual !== nivelSugerido && razonSugerencia ? `
              <div style="margin-bottom: 8px; padding: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 4px;">
                <div style="font-size: 0.75rem; color: #22c55e; font-weight: 600; margin-bottom: 2px;">
                   Nivel sugerido: ${nivelSugerido}
                </div>
                <div style="font-size: 0.7rem; color: var(--text-secondary);">
                  ${razonSugerencia}
                </div>
                <button onclick="document.getElementById('editMarkerNivel').value='${nivelSugerido}'; this.parentElement.style.display='none';" style="margin-top: 6px; padding: 4px 12px; background: #22c55e; color: white; border: none; border-radius: 3px; font-size: 0.7rem; cursor: pointer; font-weight: 600;">
                   Aplicar Sugerencia
                </button>
              </div>
            ` : ''}
            <select id="editMarkerNivel" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.9rem;">
              <option value="N1" ${nivelActual === 'N1' ? 'selected' : ''}>N1 - Empresa</option>
              <option value="N2" ${nivelActual === 'N2' ? 'selected' : ''}>N2 - Planta (Planta Principal, Acopio, etc.)</option>
              <option value="N3" ${nivelActual === 'N3' ? 'selected' : ''}>N3 - rea General</option>
              <option value="N4" ${nivelActual === 'N4' ? 'selected' : ''}>N4 - Sub-rea</option>
              <option value="N5" ${nivelActual === 'N5' ? 'selected' : ''}>N5 - Sistema/Equipo</option>
              <option value="N6" ${nivelActual === 'N6' ? 'selected' : ''}>N6 - Sub-Sistema</option>
              <option value="N7" ${nivelActual === 'N7' ? 'selected' : ''}>N7 - Seccin</option>
              <option value="N8" ${nivelActual === 'N8' ? 'selected' : ''}>N8 - Detalle (predeterminado)</option>
            </select>
          </div>
          
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">
               Categora:
            </label>
            <select id="editMarkerCategoria" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.9rem;">
              <option value="Sin categora" ${ubicacion.categoria === 'Sin categora' ? 'selected' : ''}>Sin categora</option>
              <option value="Componentes" ${ubicacion.categoria === 'Componentes' ? 'selected' : ''}>Componentes</option>
              <option value="Elctrico" ${ubicacion.categoria === 'Elctrico' ? 'selected' : ''}>Elctrico</option>
              <option value="Mecnico" ${ubicacion.categoria === 'Mecnico' ? 'selected' : ''}>Mecnico</option>
              <option value="Hidrulico" ${ubicacion.categoria === 'Hidrulico' ? 'selected' : ''}>Hidrulico</option>
              <option value="Neumtico" ${ubicacion.categoria === 'Neumtico' ? 'selected' : ''}>Neumtico</option>
              <option value="Estructura" ${ubicacion.categoria === 'Estructura' ? 'selected' : ''}>Estructura</option>
              <option value="Seguridad" ${ubicacion.categoria === 'Seguridad' ? 'selected' : ''}>Seguridad</option>
              <option value="Instrumentacin" ${ubicacion.categoria === 'Instrumentacin' ? 'selected' : ''}>Instrumentacin</option>
              <option value="Otro" ${ubicacion.categoria === 'Otro' ? 'selected' : ''}>Otro</option>
            </select>
          </div>
          
          <div style="margin-bottom: 16px; padding: 10px; background: rgba(99,102,241,0.08); border-left: 3px solid #6366f1; border-radius: 4px;">
            <p style="margin: 0 0 6px 0; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">
               Sobre el nivel jerrquico:
            </p>
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.75rem; line-height: 1.4;">
              El nivel determina el orden en cascada e inventario. N1 (Empresa) es el ms alto, N8 (Detalle) el ms especfico. Usa los mismos niveles configurados en Configuracin.
            </p>
          </div>
          
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button id="editMarkerCancelBtn" style="padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.9rem;">
              Cancelar
            </button>
            <button id="editMarkerSaveBtn" style="padding: 8px 16px; background: var(--primary); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
              Guardar
            </button>
          </div>
        </div>
      </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Event listeners
    const cancelBtn = modalContainer.querySelector('#editMarkerCancelBtn');
    const saveBtn = modalContainer.querySelector('#editMarkerSaveBtn');
    
    cancelBtn.onclick = () => {
      document.body.removeChild(modalContainer);
    };
    
    saveBtn.onclick = () => {
      const nuevaCategoria = modalContainer.querySelector('#editMarkerCategoria').value;
      const nuevoNivel = modalContainer.querySelector('#editMarkerNivel').value;
      
      // Actualizar la categora en la ubicacin especfica
      repuesto.ubicaciones[ubicacionIndex].categoria = nuevaCategoria;
      
      // Actualizar el nivel jerrquico del repuesto (aplica a todas sus ubicaciones)
      repuesto.nivelJerarquico = nuevoNivel;
      
      // Guardar cambios
      app.guardarDatos();
      
      // Cerrar modal
      document.body.removeChild(modalContainer);
      
      // Re-renderizar lista
      this.renderAreaList(this.state.areas);
      
      this.showToast(` Repuesto actualizado: Nivel ${nuevoNivel}`, 'success');
    };
  },

  renderAreaList(areas) {
    const { areaList } = this.elements;
    if (!areaList) return;

    this.renderMapJerarquiaBranch();

    //  Aplicar filtro de categora si est activo
    let filteredAreas = Array.isArray(areas) ? areas : [];

    if (this.state.jerarquiaBranchFilter) {
      filteredAreas = this.applyActiveBranchFilter(filteredAreas);
    }

    if (this.state.categoryFilter) {
      filteredAreas = filteredAreas.filter(area => (area.category || 'area') === this.state.categoryFilter);
    }

    //  NUEVO: Aplicar filtro de bsqueda si existe texto
    const searchInput = document.getElementById('mapAreaSearch');
    if (searchInput && searchInput.value.trim()) {
      const searchTerm = searchInput.value.trim().toLowerCase();
      filteredAreas = filteredAreas.filter(area => {
        const areaName = (area.name || '').toLowerCase();
        const normalized = this.normalizeAreaJerarquia(area.jerarquia);
        const jerarquia = Object.values(normalized).filter(Boolean).join(' ').toLowerCase();
        return areaName.includes(searchTerm) || jerarquia.includes(searchTerm);
      });
    }

    const filterLabel = this.getActiveBranchFilterLabel();
    const filterNoticeHtml = filterLabel
      ? `<div class="map-area-filter-alert">Filtrando por jerarqua: <strong>${this.escapeHtml(filterLabel)}</strong> <button type="button" data-action="branch-clear-filter">Limpiar</button></div>`
      : '';

    if (!Array.isArray(filteredAreas) || !filteredAreas.length) {
      let mensaje = this.state.categoryFilter 
        ? `No hay reas de la categora seleccionada.`
        : (searchInput && searchInput.value.trim() ? `No se encontraron reas con "${searchInput.value.trim()}".` : `No hay reas registradas para este mapa.`);
      if (filterLabel) {
        mensaje = `No se encontraron reas para el nivel "${filterLabel}".`;
      }
      areaList.innerHTML = `${filterNoticeHtml}<div style="padding: 12px; border: 1px dashed var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 0.8rem;">${mensaje}</div>`;
      if (filterLabel) {
        const clearBtn = areaList.querySelector('[data-action="branch-clear-filter"]');
        if (clearBtn) {
          clearBtn.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            this.clearJerarquiaBranchFilter();
          });
        }
      }
      return;
    }

    //  Construir rbol jerrquico completo (6 niveles)
    const tree = this.buildHierarchyTree(filteredAreas);
    areaList.innerHTML = `${filterNoticeHtml}${this.renderHierarchyTree(tree)}`;

    if (filterLabel) {
      const clearBtn = areaList.querySelector('[data-action="branch-clear-filter"]');
      if (clearBtn) {
        clearBtn.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          this.clearJerarquiaBranchFilter();
        });
      }
    }

    // Event listeners para enfocar zona
    Array.from(areaList.querySelectorAll('[data-action="focus-area"]')).forEach(content => {
      content.addEventListener('click', (e) => {
        const areaId = e.target.closest('[data-area-id]')?.getAttribute('data-area-id');
        if (areaId) this.focusArea(areaId);
      });
    });

    // Event listeners para editar forma (puntos) de zona
    Array.from(areaList.querySelectorAll('[data-action="edit-area-points"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        await this.startEditAreaPoints(areaId);
      });
    });

    // Event listeners para editar metadatos de zona
    Array.from(areaList.querySelectorAll('[data-action="edit-area-metadata"]')).forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        this.openEditAreaMetadataModal(areaId);
      });
    });

    // Event listeners para editar la jerarqua desde la lista principal
    Array.from(areaList.querySelectorAll('[data-action="edit-area-hierarchy"]')).forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        this.openEditAreaHierarchyModal(areaId);
      });
    });

    // Event listeners para eliminar zona
    Array.from(areaList.querySelectorAll('[data-action="delete-area"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        await this.deleteArea(areaId);
      });
    });
  },

  handleJerarquiaStructureUpdate(eventDetail = {}) {
    this.state.lastJerarquiaSync = Date.now();
    this.cachedJerarquiaStructure = app?.jerarquiaAnidada || null;
    this.cachedJerarquiaOptions = this.mergeWithFallbackJerarquiaOptions(
      this.buildJerarquiaOptionSetsFromStructure(this.cachedJerarquiaStructure)
    );

    if (!this.elements || !this.elements.areaList) {
      this.state.pendingJerarquiaRefresh = true;
      return;
    }

    this.state.pendingJerarquiaRefresh = false;

    if (Array.isArray(this.state.areas) && this.state.areas.length) {
      this.renderAreaList(this.state.areas);
    }

    if (!eventDetail?.silent) {
      console.log(' mapController: Jerarquia actualizada', eventDetail);
    }
  },

  handleJerarquiaCatalogUpdate(eventDetail = {}) {
    this.state.lastCatalogSync = Date.now();
    this.cachedJerarquiaOptions = this.mergeWithFallbackJerarquiaOptions(
      this.buildJerarquiaOptionSetsFromStructure(app?.jerarquiaAnidada)
    );

    if (!this.elements || !this.elements.areaList) {
      this.state.pendingCatalogRefresh = true;
      return;
    }

    this.state.pendingCatalogRefresh = false;

    if (Array.isArray(this.state.areas) && this.state.areas.length) {
      this.renderAreaList(this.state.areas);
    }

    this.refreshAreaMetadataFormOptions();

    if (!eventDetail?.silent) {
      console.log(' mapController: Catalogos de jerarquia actualizados', eventDetail);
    }
  },

  refreshAreaMetadataFormOptions() {
    const form = document.getElementById('editAreaForm');
    if (!form) return;

    const jerarquiaOptions = this.getJerarquiaOptionCatalog();
    const datalistConfig = [
      { id: 'plantaList', key: 'planta' },
      { id: 'areaGeneralList', key: 'areaGeneral' },
      { id: 'subAreaList', key: 'subArea' },
      { id: 'sistemaEquipoList', key: 'sistemaEquipo' },
      { id: 'subSistemaList', key: 'subSistema' },
      { id: 'seccionList', key: 'seccion' }
    ];

    datalistConfig.forEach(({ id, key }) => {
      const listElement = document.getElementById(id);
      if (!listElement) return;

      const values = Array.isArray(jerarquiaOptions[key]) ? jerarquiaOptions[key] : [];
      listElement.innerHTML = values.map((value) => `<option value="${this.escapeHtml(value)}"></option>`).join('');
    });
  },

  //  MODAL CASCADA JERRQUICA GRANDE
  openCascadaModal() {
    console.log(' openCascadaModal llamado');
    
    const modal = document.getElementById('modalCascada');
    const contentDiv = document.getElementById('cascadaContent');
    
    console.log('Modal:', modal);
    console.log('ContentDiv:', contentDiv);
    
    if (!modal || !contentDiv) {
      console.error(' Modal de cascada no encontrado en el DOM');
      alert('Error: Modal no encontrado. Por favor recarga la pgina.');
      return;
    }

    // Obtener reas del mapa actual desde el state
    const currentMap = this.state.currentMap;
    const areas = this.state.areas || [];
    
    console.log('Current Map:', currentMap);
    console.log('Areas:', areas);
    
    if (!currentMap || !areas || areas.length === 0) {
  console.log('[WARN] No hay reas en el mapa actual');
      contentDiv.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
          <div style="font-size: 4rem; margin-bottom: 16px;"></div>
          <h3 style="margin: 0 0 8px 0;">No hay reas en este mapa</h3>
          <p style="margin: 0; opacity: 0.7;">Dibuja algunas reas primero para ver la cascada jerrquica</p>
        </div>
      `;
      modal.style.display = 'block';
      console.log(' Modal mostrado (sin reas)');
      return;
    }

    // Construir y renderizar el rbol jerrquico
    const tree = this.buildHierarchyTree(areas);
    contentDiv.innerHTML = this.renderHierarchyTree(tree);

    // Agregar event listeners para interaccin
    this.attachCascadaEventListeners(contentDiv);
    
    // Calcular y mostrar estadsticas
    this.updateCascadaStats(areas);

    // Mostrar modal
    console.log(' Mostrando modal...');
    modal.style.display = 'block';
    modal.style.zIndex = '99999'; // Forzar z-index muy alto
    console.log(' Modal display:', modal.style.display);
    console.log(' Modal z-index:', modal.style.zIndex);

    // ESC key para cerrar
    const escHandler = (e) => {
      if (e.key === 'Escape') {
        console.log(' ESC presionado, cerrando modal');
        modal.style.display = 'none';
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);

    // Limpiar input de bsqueda
    const searchInput = document.getElementById('cascadaSearchInput');
    if (searchInput) searchInput.value = '';
    
    console.log(' Modal completamente configurado y visible');
  },

  // Agregar event listeners a la cascada en el modal
  attachCascadaEventListeners(container) {
    // Event listeners para enfocar zona
    Array.from(container.querySelectorAll('[data-action="focus-area"]')).forEach(content => {
      content.addEventListener('click', (e) => {
        const areaId = e.target.closest('[data-area-id]')?.getAttribute('data-area-id');
        if (areaId) {
          this.focusArea(areaId);
          // Cerrar modal despus de enfocar
          document.getElementById('modalCascada').style.display = 'none';
        }
      });
    });

    // Event listeners para editar forma (puntos) de zona
    Array.from(container.querySelectorAll('[data-action="edit-area-points"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        await this.startEditAreaPoints(areaId);
        document.getElementById('modalCascada').style.display = 'none';
      });
    });

    // Event listeners para editar metadatos de zona
    Array.from(container.querySelectorAll('[data-action="edit-area-metadata"]')).forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        this.openEditAreaMetadataModal(areaId);
        document.getElementById('modalCascada').style.display = 'none';
      });
    });

    // Event listeners para editar jerarqua de rea
    Array.from(container.querySelectorAll('[data-action="edit-area-hierarchy"]')).forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        this.openEditAreaHierarchyModal(areaId);
      });
    });

    // Event listeners para eliminar zona
    Array.from(container.querySelectorAll('[data-action="delete-area"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        await this.deleteArea(areaId);
        // Refrescar contenido del modal
        this.openCascadaModal();
      });
    });
  },

  // Filtrar cascada por bsqueda
  filterCascada(searchTerm) {
    const contentDiv = document.getElementById('cascadaContent');
    if (!contentDiv) return;

    const areas = this.state.areas || [];
    
    if (!areas || areas.length === 0) return;

    // Filtrar reas por trmino de bsqueda
    const filtered = searchTerm.trim() 
      ? areas.filter(area => {
          const normalized = this.normalizeAreaJerarquia(area.jerarquia);
          const searchLower = searchTerm.toLowerCase();
          return (
            (area.name || '').toLowerCase().includes(searchLower) ||
            Object.values(normalized).some(val => 
              (val || '').toLowerCase().includes(searchLower)
            )
          );
        })
      : areas;

    const tree = this.buildHierarchyTree(filtered);
    contentDiv.innerHTML = filtered.length > 0 
      ? this.renderHierarchyTree(tree)
      : `<div style="text-align: center; padding: 40px; color: var(--text-secondary);">
           <div style="font-size: 3rem;"></div>
           <p>No se encontraron reas con "${searchTerm}"</p>
         </div>`;

    this.attachCascadaEventListeners(contentDiv);
  },

  // Expandir todos los nodos
  expandAllCascada() {
    const contentDiv = document.getElementById('cascadaContent');
    if (!contentDiv) return;
    
    // Buscar todos los divs que tienen el toggle
    const allParents = contentDiv.querySelectorAll('[onclick*="nextElementSibling.style.display"]');
    allParents.forEach(parent => {
      const content = parent.nextElementSibling;
      const toggleIcon = parent.querySelector('.toggle');
      if (content && toggleIcon) {
        content.style.display = 'block';
        toggleIcon.textContent = 'v';
      }
    });
    
    console.log(' Todos los nodos expandidos');
  },

  // Colapsar todos los nodos
  collapseAllCascada() {
    const contentDiv = document.getElementById('cascadaContent');
    if (!contentDiv) return;
    
    // Buscar todos los divs que tienen el toggle
    const allParents = contentDiv.querySelectorAll('[onclick*="nextElementSibling.style.display"]');
    allParents.forEach(parent => {
      const content = parent.nextElementSibling;
      const toggleIcon = parent.querySelector('.toggle');
      if (content && toggleIcon) {
        content.style.display = 'none';
        toggleIcon.textContent = '>';
      }
    });
    
    console.log(' Todos los nodos colapsados');
  },

  // Modal para editar solo la jerarqua de un rea
  openEditAreaHierarchyModal(areaId) {
    const numericId = typeof areaId === 'string' ? parseInt(areaId, 10) : areaId;
    const area = this.state.areas.find(a => a.id === numericId);
    
    if (!area) {
      this.showToast('rea no encontrada', 'error');
      return;
    }

    const jerarquia = this.normalizeAreaJerarquia(area.jerarquia);
    const jerarquiaOptions = this.getJerarquiaOptionCatalog();
    
    const buildDatalist = (id, values) => {
      if (!Array.isArray(values) || !values.length) return '';
      return `<datalist id="${id}">${values.map(v => `<option value="${this.escapeHtml(v)}"></option>`).join('')}</datalist>`;
    };

    // Crear modal simple
    const modalHTML = `
      <div id="modalEditHierarchy" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target.id==='modalEditHierarchy') this.remove()">
        <div style="background: var(--bg-primary); border-radius: 8px; padding: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; color: var(--text-primary);">Editar Jerarqua de rea</h3>
            <button onclick="document.getElementById('modalEditHierarchy').remove()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer;"></button>
          </div>
          
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 16px;">
            <div style="color: var(--text-secondary); font-size: 0.9rem;">
              <strong style="color: var(--text-primary);">rea:</strong> ${this.escapeHtml(area.name || 'Sin nombre')}
            </div>
          </div>
          
          <form id="formEditHierarchy" style="display: flex; flex-direction: column; gap: 12px;">
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N1 - Empresa 🏢
                <span title="Nivel corporativo más alto (ej: Aquachile Antarfood)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel1" list="nivel1List" placeholder="Ej: Aquachile Antarfood" value="${this.escapeHtml(jerarquia.nivel1 || 'Aquachile Antarfood')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel1List', ['Aquachile Antarfood'])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N2 - Área 🏭
                <span title="Área de la planta (ej: Planta Principal, Procesamiento)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel2" list="nivel2List" placeholder="Ej: Planta Principal" value="${this.escapeHtml(jerarquia.nivel2 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel2List', jerarquiaOptions.nivel2 || [])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N3 - Sub-área 📍
                <span title="Zona específica dentro del área (ej: Eviscerado, Filete)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel3" list="nivel3List" placeholder="Ej: Eviscerado" value="${this.escapeHtml(jerarquia.nivel3 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel3List', jerarquiaOptions.nivel3 || [])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N4 - Sistema ⚙️
                <span title="Sistema o equipo principal (ej: Grader, Marel)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel4" list="nivel4List" placeholder="Ej: Grader" value="${this.escapeHtml(jerarquia.nivel4 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel4List', jerarquiaOptions.nivel4 || [])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N5 - Sub-sistema 🔧
                <span title="Componente del sistema (ej: Pocket 1-4, Cinta Z)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel5" list="nivel5List" placeholder="Ej: Pocket 1-4" value="${this.escapeHtml(jerarquia.nivel5 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel5List', jerarquiaOptions.nivel5 || [])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N6 - Sección 📦
                <span title="Sección específica (ej: Sistema Neumático, Hidráulico)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel6" list="nivel6List" placeholder="Ej: Sistema Neumático" value="${this.escapeHtml(jerarquia.nivel6 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel6List', jerarquiaOptions.nivel6 || [])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N7 - Sub-sección 🔩
                <span title="Detalle más específico (ej: Válvula Principal, Sensor)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel7" list="nivel7List" placeholder="Ej: Válvula Principal" value="${this.escapeHtml(jerarquia.nivel7 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel7List', jerarquiaOptions.nivel7 || [])}
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button type="button" onclick="document.getElementById('modalEditHierarchy').remove()" style="flex: 1; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); cursor: pointer;">
                Cancelar
              </button>
              <button type="submit" style="flex: 1; padding: 10px; background: var(--primary); border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: 600;">
                Guardar Jerarqua
              </button>
            </div>
          </form>
        </div>
      </div>
    `;
    
    // Agregar al DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Event listener para el formulario
    const form = document.getElementById('formEditHierarchy');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      // NUEVA ESTRUCTURA: Guardar en jerarquía unificada de 7 niveles
      const newJerarquia = {
        nivel1: formData.get('nivel1') || 'Aquachile Antarfood',
        nivel2: formData.get('nivel2') || null,
        nivel3: formData.get('nivel3') || null,
        nivel4: formData.get('nivel4') || null,
        nivel5: formData.get('nivel5') || null,
        nivel6: formData.get('nivel6') || null,
        nivel7: formData.get('nivel7') || null
      };
      
      // Preservar jerarquía legacy si existía (para rollback)
      if (area.jerarquia && !area._jerarquiaLegacy) {
        area._jerarquiaLegacy = { ...area.jerarquia };
      }
      
      // Actualizar área con nueva jerarquía
      area.jerarquia = newJerarquia;
      
      // Guardar
      await mapStorage.updateArea(area);
      
      // Cerrar modal
      document.getElementById('modalEditHierarchy').remove();
      
      // Refrescar cascada
      this.openCascadaModal();
      
      this.showToast(' Jerarquía actualizada a 7 niveles', 'success');
      console.log('✅ Área guardada con jerarquía unificada:', newJerarquia);
    });
  },

  // Exportar cascada a JSON
  exportCascada() {
    const currentMap = this.state.currentMap;
    const areas = this.state.areas || [];
    
    if (!currentMap || !areas || areas.length === 0) {
      alert('No hay datos para exportar');
      return;
    }

    const tree = this.buildHierarchyTree(areas);
    const dataStr = JSON.stringify(tree, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `cascada_jerarquica_${currentMap.name || 'mapa'}_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  },

  // Toggle modo edicin de cascada
  toggleCascadaEditMode() {
    this.state.cascadaEditMode = !this.state.cascadaEditMode;
    const btn = document.getElementById('cascadaEditModeBtn');
    
    if (this.state.cascadaEditMode) {
      if (btn) {
        btn.classList.add('active');
        btn.style.background = 'var(--success)';
        btn.style.color = 'white';
      }
      this.showToast(' Modo edicin activado', 'success');
      console.log(' Modo edicin de cascada ACTIVADO');
    } else {
      if (btn) {
        btn.classList.remove('active');
        btn.style.background = '';
        btn.style.color = '';
      }
      this.showToast(' Modo edicin desactivado', 'info');
      console.log(' Modo edicin de cascada DESACTIVADO');
    }
  },

  // Calcular estadsticas de la cascada
  updateCascadaStats(areas) {
    const statsAreas = document.getElementById('statsAreas');
    const statsMarcadores = document.getElementById('statsMarcadores');
    const statsSinJerarquia = document.getElementById('statsSinJerarquia');
    
    if (!statsAreas || !statsMarcadores || !statsSinJerarquia) return;
    
    // Contar reas
    const totalAreas = areas.length;
    
    // Contar reas sin jerarqua definida (todas vacas o "Sin...")
    const areasSinJerarquia = areas.filter(area => {
      const j = area.jerarquia || {};
      return (!j.planta || j.planta === 'Sin planta') && 
             (!j.areaGeneral || j.areaGeneral === 'Sin rea') &&
             !j.subArea && !j.sistemaEquipo && !j.subSistema && !j.seccion;
    }).length;
    
    // Contar marcadores
    let totalMarcadores = 0;
    let marcadoresSinNivel = 0;
    
    const repuestos = app?.repuestos || [];
    repuestos.forEach(rep => {
      if (rep.ubicaciones && Array.isArray(rep.ubicaciones)) {
        rep.ubicaciones.forEach(ub => {
          if (ub.mapaId === this.state.currentMapId) {
            totalMarcadores++;
            if (!rep.nivelJerarquico || rep.nivelJerarquico === '') {
              marcadoresSinNivel++;
            }
          }
        });
      }
    });
    
    // Actualizar UI
    statsAreas.textContent = totalAreas;
    statsMarcadores.textContent = totalMarcadores;
    statsSinJerarquia.textContent = areasSinJerarquia + marcadoresSinNivel;
    
    // Cambiar color si hay elementos sin jerarqua
    const statsSinJerarquiaParent = statsSinJerarquia.parentElement;
    if (areasSinJerarquia + marcadoresSinNivel > 0) {
      statsSinJerarquiaParent.style.color = '#f59e0b';
    } else {
      statsSinJerarquiaParent.style.color = 'var(--text-secondary)';
    }
  },

  // Toggle mostrar solo elementos con jerarqua
  toggleMostrarSoloConJerarquia() {
    this.state.mostrarSoloConJerarquia = !this.state.mostrarSoloConJerarquia;
    const btn = document.getElementById('btnToggleVacias');
    
    if (this.state.mostrarSoloConJerarquia) {
      btn.textContent = ' Mostrar vacas';
      btn.style.background = 'var(--primary)';
      btn.style.color = 'white';
    } else {
      btn.textContent = ' Ocultar vacas';
      btn.style.background = '';
      btn.style.color = '';
    }
    
    // Refrescar vista
    this.openCascadaModal();
  },

  //  Construir rbol jerrquico de 6 niveles (MEJORADO: sin duplicados)
  buildHierarchyTree(areas) {
    const tree = {};
    
    // Filtrar reas vacas si est activado
    let areasToProcess = areas;
    if (this.state.mostrarSoloConJerarquia) {
      areasToProcess = areas.filter(area => {
        const j = area.jerarquia || {};
        return (j.planta && j.planta !== 'Sin planta') || 
               (j.areaGeneral && j.areaGeneral !== 'Sin rea') ||
               j.subArea || j.sistemaEquipo || j.subSistema || j.seccion;
      });
    }
    
    areasToProcess.forEach(area => {
      const normalizedJerarquia = this.normalizeAreaJerarquia(area.jerarquia);
      const planta = normalizedJerarquia.planta || 'Sin empresa';
      const areaGeneral = normalizedJerarquia.areaGeneral || 'Sin rea';
      const subArea = normalizedJerarquia.subArea || null;
      const sistema = normalizedJerarquia.sistemaEquipo || null;
      const subSistema = normalizedJerarquia.subSistema || null;
      const seccion = normalizedJerarquia.seccion || null;
      
      //  DETECTAR NIVEL MS PROFUNDO - El rea solo se agrega UNA VEZ en su nivel ms especfico
      let nivelMasProfundo = null;
      let targetNode = null;
      
      // Nivel 1: Planta
      if (!tree[planta]) tree[planta] = {};
      
      // Nivel 2: rea General
      if (!tree[planta][areaGeneral]) tree[planta][areaGeneral] = {};
      
      // Si no hay ms niveles definidos, el rea va aqu
      if (!subArea && !sistema && !subSistema && !seccion) {
        nivelMasProfundo = 'areaGeneral';
        targetNode = tree[planta][areaGeneral];
      }
      
      // Nivel 3: Sub-rea
      if (subArea) {
        if (!tree[planta][areaGeneral][subArea]) tree[planta][areaGeneral][subArea] = {};
        
        // Si no hay ms niveles, el rea va aqu
        if (!sistema && !subSistema && !seccion) {
          nivelMasProfundo = 'subArea';
          targetNode = tree[planta][areaGeneral][subArea];
        }
        
        // Nivel 4: Sistema/Equipo
        if (sistema) {
          if (!tree[planta][areaGeneral][subArea][sistema]) tree[planta][areaGeneral][subArea][sistema] = {};
          
          // Si no hay ms niveles, el rea va aqu
          if (!subSistema && !seccion) {
            nivelMasProfundo = 'sistema';
            targetNode = tree[planta][areaGeneral][subArea][sistema];
          }
          
          // Nivel 5: Sub-sistema
          if (subSistema) {
            if (!tree[planta][areaGeneral][subArea][sistema][subSistema]) tree[planta][areaGeneral][subArea][sistema][subSistema] = {};
            
            // Si no hay ms niveles, el rea va aqu
            if (!seccion) {
              nivelMasProfundo = 'subSistema';
              targetNode = tree[planta][areaGeneral][subArea][sistema][subSistema];
            }
            
            // Nivel 6: Seccin (nivel ms profundo posible)
            if (seccion) {
              if (!tree[planta][areaGeneral][subArea][sistema][subSistema][seccion]) {
                tree[planta][areaGeneral][subArea][sistema][subSistema][seccion] = { _areas: [] };
              }
              nivelMasProfundo = 'seccion';
              targetNode = tree[planta][areaGeneral][subArea][sistema][subSistema][seccion];
            }
          }
        }
      }
      
      //  AGREGAR EL REA SOLO UNA VEZ EN SU NIVEL MS PROFUNDO
      if (targetNode) {
        if (!targetNode._areas) {
          targetNode._areas = [];
        }
        // Evitar duplicados por ID
        if (!targetNode._areas.find(a => a.id === area.id)) {
          targetNode._areas.push(area);
        }
      }
    });
    
    return tree;
  },

  //  Renderizar rbol jerrquico completo (MEJORADO: ordenado alfabticamente)
  renderHierarchyTree(tree, level = 0) {
    let html = '';
    const indent = level * 12; // 12px por nivel
    
    //  ORDENAR CLAVES alfabticamente (espaol), _areas siempre al final
    const keys = Object.keys(tree).sort((a, b) => {
      if (a === '_areas') return 1; // _areas al final
      if (b === '_areas') return -1;
      return a.localeCompare(b, 'es', { sensitivity: 'base', numeric: true });
    });
    
    for (const key of keys) {
      if (key === '_areas') {
        //  ORDENAR REAS alfabticamente por nombre
        const areasOrdenadas = [...tree[key]].sort((a, b) => {
          return (a.name || '').localeCompare(b.name || '', 'es', { sensitivity: 'base' });
        });
        
        // Renderizar reas en este nivel
        areasOrdenadas.forEach(area => {
          html += this.renderAreaItem(area, indent, level);
        });
      } else {
        // Renderizar nodo de jerarqua
        const childrenHTML = this.renderHierarchyTree(tree[key], level + 1);
        const hasChildren = childrenHTML.trim().length > 0;
        
        //  Badge de nivel jerrquico - MOVIDO A LA IZQUIERDA
        const nivelBadge = `<span style="
          background: rgba(59, 130, 246, 0.2);
          color: #60a5fa;
          padding: 1px 4px;
          border-radius: 2px;
          font-size: 0.65rem;
          font-weight: 600;
          font-family: monospace;
          min-width: 22px;
          text-align: center;
        ">N${Math.max(1, level + 1)}</span>`;
        
        html += `
          <div style="margin-bottom: 1px;">
            <div style="
              padding: 4px 6px;
              padding-left: ${indent + 6}px;
              background: rgba(255,255,255,0.02);
              border-left: 2px solid rgba(100,100,100,0.3);
              font-size: 0.75rem;
              font-weight: 600;
              color: #d4d4d4;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 6px;
            " onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle').textContent = this.nextElementSibling.style.display === 'none' ? '>' : 'v'">
              <span class="toggle" style="font-size: 0.7rem; width: 8px; font-family: monospace;">${hasChildren ? 'v' : '>'}</span>
              ${nivelBadge}
              <span style="flex: 1;">${this.escapeHtml(key)}</span>
            </div>
            <div style="display: ${hasChildren ? 'block' : 'none'};">
              ${childrenHTML}
            </div>
          </div>
        `;
      }
    }
    
    return html;
  },

  //  Renderizar item de rea individual
  renderAreaItem(area, indent, level = 0) {
    const color = area.color || '#3b82f6';
    const category = area.category || 'area';
    
    //  Obtener marcadores agrupados por categora para esta rea
    const marcadoresPorCategoria = this.getMarcadoresPorArea(area.id);
    const totalMarcadores = Object.values(marcadoresPorCategoria).reduce((sum, markers) => sum + markers.length, 0);

    //  Badge de nivel jerrquico para rea (nivel+1 porque el rea es un nivel ms profundo que su nodo padre)
    const nivelBadge = `<span style="
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
      padding: 1px 4px;
      border-radius: 2px;
      font-size: 0.65rem;
      font-weight: 600;
      font-family: monospace;
      margin-left: 4px;
    ">N${Math.max(1, level + 1)}</span>`;

    // Generar HTML para las categoras y marcadores
    let categoriasHTML = '';
    const categorias = Object.keys(marcadoresPorCategoria).sort();
    
    if (categorias.length > 0) {
      categoriasHTML = categorias.map(catNombre => {
        const marcadores = marcadoresPorCategoria[catNombre];
        
        const marcadoresHTML = marcadores.map(m => {
          // Mostrar nmero correlativo solo si hay ms de 1 instancia
          const showCorrelativo = m.totalInstancias > 1;
          
          return `
          <div class="marker-item" style="
            padding: 3px 8px;
            padding-left: ${indent + 24}px;
            font-size: 0.72rem;
            color: #bbb;
            cursor: pointer;
            transition: all 0.1s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
          " 
          onmouseover="this.style.background='rgba(255,255,255,0.05)'; this.style.color='#fff'; this.querySelector('.marker-edit-btn').style.opacity='1'"
          onmouseout="this.style.background='transparent'; this.style.color='#bbb'; this.querySelector('.marker-edit-btn').style.opacity='0'">
            <span onclick="mapController.focusOnMarker('${m.repuesto.id}', ${m.ubicacionIndex})" style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 4px;">
              <span style="overflow: hidden; text-overflow: ellipsis;">${this.escapeHtml(m.repuesto.nombre || 'Sin nombre')}</span>
              ${showCorrelativo ? `<span style="
                background: #222;
                color: #fff;
                padding: 1px 4px;
                border-radius: 2px;
                font-size: 0.65rem;
                font-weight: 600;
                font-family: monospace;
                flex-shrink: 0;
              ">#${m.numeroCorrelativo}</span>` : ''}
            </span>
            <button 
              class="marker-edit-btn"
              onclick="event.stopPropagation(); mapController.openEditMarkerModal('${m.repuesto.id}', ${m.ubicacionIndex})" 
              style="
                opacity: 0;
                transition: opacity 0.15s;
                background: none;
                border: none;
                color: #888;
                cursor: pointer;
                padding: 0;
                font-size: 0.7rem;
              " 
              title="Editar marcador">E</button>
          </div>
        `;
        }).join('');
        
        return `
          <div class="categoria-group" style="
            display: block;
            border-left: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 1px;
          ">
            <div class="categoria-header" style="
              padding: 3px 8px;
              padding-left: ${indent + 16}px;
              font-size: 0.72rem;
              font-weight: 500;
              color: #aaa;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 6px;
              transition: background 0.1s;
            "
            onclick="mapController.toggleCategoria(this)"
            onmouseover="this.style.background='rgba(255,255,255,0.03)'"
            onmouseout="this.style.background='transparent'">
              <span class="categoria-toggle" style="
                font-size: 0.7rem; 
                font-family: monospace;
                width: 8px;
              ">v</span>
              <span>${catNombre}</span>
              <span style="
                font-size: 0.65rem;
                color: #666;
                background: rgba(255,255,255,0.05);
                padding: 1px 5px;
                border-radius: 3px;
                margin-left: auto;
              ">${marcadores.length}</span>
            </div>
            <div class="categoria-marcadores" style="display: block;">
              ${marcadoresHTML}
            </div>
          </div>
        `;
      }).join('');
    }
    
    return `
      <div style="
        padding: 4px 6px;
        padding-left: ${indent + 6}px;
        background: rgba(255,255,255,0.02);
        border-left: 2px solid ${color};
        font-size: 0.75rem;
        font-weight: 500;
        color: #d4d4d4;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        position: relative;
        margin-bottom: 1px;
      "
      data-area-id="${area.id}"
      onmouseover="this.querySelector('.map-area-actions').style.opacity='1'"
      onmouseout="this.querySelector('.map-area-actions').style.opacity='0'">
        <div class="area-toggle" 
             onclick="mapController.toggleArea(this)" 
             style="
               cursor: pointer; 
               font-size: 0.7rem;
               font-family: monospace;
               user-select: none;
               width: 8px;
             ">${totalMarcadores > 0 ? 'v' : '>'}</div>
        <span style="
          background: rgba(59, 130, 246, 0.3);
          color: #60a5fa;
          padding: 1px 5px;
          border-radius: 2px;
          font-size: 0.65rem;
          font-weight: 700;
          font-family: monospace;
        ">REA</span>
        ${nivelBadge}
        <div class="map-area-content" 
             data-action="focus-area" 
             style="flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
          ${this.escapeHtml(area.name || 'Area sin nombre')}${totalMarcadores > 0 ? ` (${totalMarcadores})` : ''}
        </div>
        <div class="map-area-actions" style="
          display: flex; 
          gap: 6px;
          opacity: 0;
          transition: opacity 0.15s;
          font-size: 0.7rem;
          color: #888;
        ">
          <span data-action="edit-area-hierarchy" data-area-id="${area.id}" title="Editar jerarqua" style="cursor: pointer; color: #8b5cf6;">J</span>
          <span data-action="edit-area-points" data-area-id="${area.id}" title="Editar forma" style="cursor: pointer;">E</span>
          <span data-action="edit-area-metadata" data-area-id="${area.id}" title="Editar datos" style="cursor: pointer;">C</span>
          <span data-action="delete-area" data-area-id="${area.id}" title="Eliminar" style="cursor: pointer; color: #c55;">X</span>
        </div>
      </div>
      ${totalMarcadores > 0 ? `
        <div class="area-children" style="display: block;">
          ${categoriasHTML}
        </div>
      ` : ''}
    `;
  },

  //  NUEVO: Aplicar filtro de categora
  applyCategoryFilter(category) {
    console.log(` Filtro de categora aplicado: ${category}`);
    
    if (category === 'all') {
      this.state.categoryFilter = null;
    } else {
      this.state.categoryFilter = category;
    }
    
    // Re-renderizar la lista con el filtro aplicado
    this.renderAreaList(this.state.areas);
    
    // Mostrar toast informativo
    const categoryName = category === 'all' 
      ? 'Todas las categoras' 
      : this.categories[category]?.name || category;
    this.showToast(`Filtrando: ${categoryName}`, 'info');
  },

  async selectMap(mapId, options = {}) {
    if (!mapId) return;
    if (!mapStorage.initialized) {
      this.showToast('Conecta la carpeta primero.', 'warning');
      return;
    }

    const numericId = typeof mapId === 'string' ? parseInt(mapId, 10) : mapId;
    const map = mapStorage.getMapById(numericId);

    if (!map) {
      this.showToast('Mapa no encontrado.', 'warning');
      return;
    }

    if (this.state.currentMapId !== map.id) {
      this.state.jerarquiaBranchFilter = null;
    }

    this.state.currentMapId = map.id;
    this.state.currentMap = map;
    this.state.areas = mapStorage.getAreasByMap(map.id);
    this.state.highlightAreaId = null;

    const viewportOverride = !options.keepViewport
      ? this.getPersistedViewportForMap(map.id)
      : null;

    if (!options.keepViewport && !viewportOverride) {
      this.state.scale = 1;
      this.state.offsetX = 0;
      this.state.offsetY = 0;
    } else if (viewportOverride) {
      this.applyViewportSnapshot(viewportOverride);
    }

    this.showMapLoadingOverlay(map);
    await this.loadMapImage(map, { ...options, viewportOverride });
    this.renderMapList(mapStorage.maps);
    this.renderAreaList(this.state.areas);
    this.updateMetaBadge();
    this.updateMapJerarquiaBadge();
    this.syncButtonStates(); //  Sincronizar estado visual de botones
    this.queueViewportPersist('select-map');
  },

  async loadMapImage(map, options = {}) {
    this.cleanupImage();

    if (!map.imagePath) {
      this.drawMessage('El mapa seleccionado no tiene imagen asociada.');
      this.hideMapLoadingOverlay(true, 'Sin imagen asociada.');
      return;
    }

    if (!this.state.mapLoadingActive) {
      this.showMapLoadingOverlay(map);
    }

    this.updateMapLoadingProgress(10, 'Buscando imagen en la carpeta...');
    try {
      const file = await mapStorage.getMapImage(map);
      if (!file) {
        this.drawMessage('No se encontr la imagen del mapa.');
        this.hideMapLoadingOverlay(true, 'No se encontr la imagen del mapa.');
        return;
      }

      this.updateMapLoadingProgress(25, 'Procesando imagen...');
      if (typeof window !== 'undefined' && typeof window.createImageBitmap === 'function') {
        await this.loadMapImageFromBitmaps(file, map, options);
      } else {
        await this.loadMapImageLegacy(file, options);
      }
    } catch (error) {
      console.error('Error cargando imagen del mapa:', error);
      this.drawMessage('No se pudo cargar la imagen del mapa.');
      this.hideMapLoadingOverlay(true, 'No se pudo cargar la imagen.');
    }
  },

  async loadMapImageFromBitmaps(file, map, options = {}) {
    const dimensions = {
      width: Number(map?.width) || 0,
      height: Number(map?.height) || 0
    };

    if (!dimensions.width || !dimensions.height) {
      const fallback = await this.getImageDimensions(file);
      dimensions.width = fallback.width;
      dimensions.height = fallback.height;
    }

    if (!dimensions.width || !dimensions.height) {
      this.drawMessage('No se pudo determinar el tamao del mapa.');
      this.hideMapLoadingOverlay(true, 'No se pudo determinar el tamao del mapa.');
      return;
    }

    this.state.imageDimensions = { ...dimensions };

    this.updateMapLoadingProgress(40, 'Optimizando resoluciones...');
    const lods = await this.buildImageLODs(file, dimensions, (value, label) => {
      this.updateMapLoadingProgress(value, label);
    });
    if (!lods.length) {
      this.drawMessage('No se pudo preparar la imagen del mapa.');
      this.hideMapLoadingOverlay(true, 'No se pudo preparar la imagen del mapa.');
      return;
    }

    this.state.imageLODs = lods;
    this.state.currentImage = lods[lods.length - 1].bitmap;
    this.state.currentImageUrl = null;
    this.state.usingBitmapRenderer = true;

    this.updateMapLoadingProgress(90, 'Aplicando mapa al lienzo...');
    this.configureCanvasForImage({ width: dimensions.width, height: dimensions.height }, options);
    this.draw();
    this.completeMapLoadingProgress();
      this.completeMapLoadingProgress();
  },

  async loadMapImageLegacy(file, options = {}) {
    const url = URL.createObjectURL(file);
    const img = new Image();
      this.hideMapLoadingOverlay(true, 'Error cargando la imagen del mapa.');
    img.onload = () => {
      this.updateMapLoadingProgress(85, 'Aplicando mapa al lienzo...');
      this.state.currentImage = img;
      this.state.currentImageUrl = url;
      this.state.imageDimensions = { width: img.width, height: img.height };
      this.state.usingBitmapRenderer = false;
      this.state.imageLODs = [];
      this.configureCanvasForImage(img, options);
      this.draw();
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      this.drawMessage('Error cargando la imagen del mapa.');
    };
    img.src = url;
  },

  async buildImageLODs(file, dimensions, progressCallback = null) {
    const originalWidth = dimensions.width;
    const originalHeight = dimensions.height;
    const targetWidths = this.getLODTargetWidths(originalWidth);
    const lods = [];

    let baseBitmap = null;
    const totalTargets = targetWidths.length || 1;
    const reportProgress = (index, width) => {
      if (typeof progressCallback !== 'function') {
        return;
      }
      const base = 45;
      const span = 40;
      const ratio = (index + 1) / totalTargets;
      const percent = Math.min(90, Math.round(base + span * ratio));
      progressCallback(percent, `Escala ${width}px optimizada`);
    };

    for (const targetWidth of targetWidths) {
      const ratio = targetWidth / originalWidth;
      const targetHeight = Math.max(1, Math.round(originalHeight * ratio));

      try {
        if (!baseBitmap) {
          baseBitmap = await createImageBitmap(file);
        }

        const bitmap = targetWidth === originalWidth && targetHeight === originalHeight
          ? baseBitmap
          : await createImageBitmap(baseBitmap, {
              resizeWidth: targetWidth,
              resizeHeight: targetHeight,
              resizeQuality: 'high'
            });

        lods.push({
          width: targetWidth,
          height: targetHeight,
          scale: ratio,
          bitmap
        });
        reportProgress(lods.length - 1, targetWidth);
      } catch (error) {
        console.warn(`No se pudo generar LOD ${targetWidth}px:`, error);
      }
    }

    lods.sort((a, b) => a.scale - b.scale);
    return lods;
  },

  getLODTargetWidths(originalWidth) {
    const presets = [1024, 2048, 4096, 6144, 8192];
    const targets = presets
      .filter((size) => originalWidth > size * 1.05)
      .concat(originalWidth);

    const uniqueTargets = [...new Set(targets.map((value) => Math.round(value)))];
    uniqueTargets.sort((a, b) => a - b);
    return uniqueTargets;
  },

  configureCanvasForImage(img, options = {}) {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    const container = this.elements.canvasStage || canvas.parentElement;
    if (container) {
      const containerWidth = container.clientWidth;
      const containerHeight = container.clientHeight;
      
      //  Buffer del canvas = tamao del contenedor
      canvas.width = containerWidth;
      canvas.height = containerHeight;
      
      //  Canvas CSS ocupa TODO el contenedor amarillo
      canvas.style.width = '100%';
      canvas.style.height = '100%';
    } else {
      // Fallback
      canvas.width = img.width;
      canvas.height = img.height;
    }

    if (options.viewportOverride) {
      this.applyViewportSnapshot(options.viewportOverride);
    } else if (!options.keepViewport) {
      this.state.scale = 1;
      this.state.offsetX = 0;
      this.state.offsetY = 0;
    }

    this.updateZoomBadge();
  },

  cleanupImage() {
    if (this.state.currentImageUrl) {
      try {
        URL.revokeObjectURL(this.state.currentImageUrl);
      } catch (error) {
        console.debug('cleanupImage revoke fall:', error);
      }
    }
    this.state.currentImageUrl = null;

    if (Array.isArray(this.state.imageLODs) && this.state.imageLODs.length) {
      this.state.imageLODs.forEach((lod) => {
        try {
          lod?.bitmap?.close?.();
        } catch (error) {
          console.debug('No se pudo liberar LOD:', error);
        }
      });
    }

    this.state.imageLODs = [];
    this.state.imageDimensions = { width: 0, height: 0 };
    this.state.usingBitmapRenderer = false;
    this.state.currentImage = null;
  },

  handleResize() {
    if (!this.elements.canvas) return;
    if (!this.state.currentImage) {
      this.resizeCanvas();
      return;
    }

    //  Canvas siempre ocupa TODO el contenedor amarillo (100%)
    this.elements.canvas.style.width = '100%';
    this.elements.canvas.style.height = '100%';

    this.draw();
  },

  resizeCanvas() {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    if (!this.state.currentImage) {
      const container = this.elements.canvasStage || canvas.parentElement;
      const rectWidth = container ? container.clientWidth : 640;
      const rectHeight = container ? container.clientHeight : 480;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.max(1, Math.round(rectWidth * dpr));
      canvas.height = Math.max(1, Math.round(rectHeight * dpr));
      this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      this.drawMessage('Conecta la carpeta INVENTARIO_STORAGE para comenzar.');
    } else {
      this.handleResize();
    }
  },

  drawMessage(message) {
    const canvas = this.elements.canvas;
    if (!canvas || !this.ctx) return;
    const ctx = this.ctx;
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'rgba(148, 163, 184, 0.9)';
    ctx.font = '16px "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(message, canvas.width / 2, canvas.height / 2);
    ctx.restore();
  },

  getVisibleMapBounds() {
    const canvas = this.elements.canvas;
    const dimensions = this.state.imageDimensions || {};
    if (!canvas || !dimensions.width || !dimensions.height) {
      return null;
    }

    const scale = this.state.scale;
    const offsetX = this.state.offsetX;
    const offsetY = this.state.offsetY;
    const viewWidth = canvas.width / scale;
    const viewHeight = canvas.height / scale;
    const viewX = (-offsetX) / scale;
    const viewY = (-offsetY) / scale;

    return {
      x: viewX,
      y: viewY,
      width: viewWidth,
      height: viewHeight,
      maxWidth: dimensions.width,
      maxHeight: dimensions.height
    };
  },

  getMapDimensionsSafe() {
    if (this.state.imageDimensions?.width && this.state.imageDimensions?.height) {
      return { ...this.state.imageDimensions };
    }

    if (this.state.currentImage) {
      return { width: this.state.currentImage.width, height: this.state.currentImage.height };
    }

    return { width: 0, height: 0 };
  },

  getMinimapBitmap() {
    if (this.state.imageLODs?.length) {
      return this.state.imageLODs[0]?.bitmap || null;
    }
    return this.state.currentImage;
  },

  pickLODForScale(scale) {
    const lods = this.state.imageLODs;
    if (!Array.isArray(lods) || lods.length === 0) {
      return null;
    }

    let chosen = lods[0];
    for (const lod of lods) {
      if (scale >= lod.scale || lod.scale === 1) {
        chosen = lod;
      } else {
        break;
      }
    }
    return chosen;
  },

  drawBaseImage(ctx) {
    if (this.state.usingBitmapRenderer && this.state.imageLODs.length) {
      const lod = this.pickLODForScale(this.state.scale);
      const bounds = this.getVisibleMapBounds();
      if (!lod || !bounds) {
        return;
      }

      const startX = Math.max(0, bounds.x);
      const startY = Math.max(0, bounds.y);
      const endX = Math.min(bounds.maxWidth, bounds.x + bounds.width);
      const endY = Math.min(bounds.maxHeight, bounds.y + bounds.height);

      const visibleWidth = Math.max(0, endX - startX);
      const visibleHeight = Math.max(0, endY - startY);

      if (visibleWidth <= 0 || visibleHeight <= 0) {
        return;
      }

      const ratio = lod.scale;
      const sourceX = startX * ratio;
      const sourceY = startY * ratio;
      const sourceWidth = visibleWidth * ratio;
      const sourceHeight = visibleHeight * ratio;

      ctx.drawImage(
        lod.bitmap,
        sourceX,
        sourceY,
        sourceWidth,
        sourceHeight,
        startX,
        startY,
        visibleWidth,
        visibleHeight
      );
      return;
    }

    if (this.state.currentImage) {
      ctx.drawImage(this.state.currentImage, 0, 0);
    }
  },

  draw() {
    const canvas = this.elements.canvas;
    if (!canvas || !this.ctx) return;

    const ctx = this.ctx;
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    //  Aplicar transformaciones de pan y zoom
    ctx.translate(this.state.offsetX, this.state.offsetY);
    ctx.scale(this.state.scale, this.state.scale);
    
    this.drawBaseImage(ctx);

    if (this.state.showGrid) {
      this.drawGrid(ctx);
    }

    this.drawAreas(ctx);
    this.drawTempShape(ctx);
    this.drawEditPoints(ctx);

    //  ETAPA 3.2: Dibujar handles de reshape
    if (this.state.isReshapeMode && this.state.reshapeAreaId) {
      this.drawReshapeHandles(ctx);
    }

    //  NUEVO: Dibujar marcadores de repuestos
    this.drawMarkers(ctx);
    
    //  NUEVO: Dibujar ubicaciones resaltadas (con animacin)
    this.dibujarUbicacionesResaltadas(ctx);

    ctx.restore();
    this.updateZoomBadge();
    
    //  NUEVO: Dibujar reglas si estn activadas
    if (this.state.showRulers) {
      this.drawRulers();
    }
    
    //  NUEVO: Dibujar minimap si est activado
    if (this.state.showMinimap && this.getMinimapBitmap()) {
      this.drawMinimap();
    }
  },

  // Rendering optimizado con requestAnimationFrame
  scheduleRender() {
    if (this.state.animationFrameId) {
      return; // Ya hay un render pendiente
    }
    this.state.animationFrameId = requestAnimationFrame(() => {
      this.draw();
      this.state.animationFrameId = null;
    });
  },

  drawCanvas() {
    // Alias para draw()
    this.draw();
  },

  drawGrid(ctx) {
    const dimensions = this.getMapDimensionsSafe();
    if (!dimensions.width || !dimensions.height) return;

    const step = this.state.gridSize || 50; //  Usar gridSize configurable
    const width = dimensions.width;
    const height = dimensions.height;
    ctx.save();
    ctx.strokeStyle = 'rgba(148, 163, 184, 0.25)';
    ctx.lineWidth = 1 / this.state.scale;

    for (let x = step; x < width; x += step) {
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, height);
      ctx.stroke();
    }
    for (let y = step; y < height; y += step) {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(width, y);
      ctx.stroke();
    }

    ctx.restore();
  },

  //  NUEVO: Dibujar reglas laterales con medidas
  drawRulers() {
    if (!this.state.showRulers) return;

    const dimensions = this.getMapDimensionsSafe();
    if (!dimensions.width || !dimensions.height) return;

    const canvas = this.elements.canvas;
    const ctx = this.ctx;
    const rulerSize = 30; // Ancho/alto de las reglas en pxeles
    const gridSize = this.state.gridSize || 50;

    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0); // Resetear transformacin

    // Fondo de las reglas
    ctx.fillStyle = 'rgba(15, 23, 42, 0.9)';
    
    // Regla horizontal (arriba)
    ctx.fillRect(rulerSize, 0, canvas.width - rulerSize, rulerSize);
    
    // Regla vertical (izquierda)
    ctx.fillRect(0, rulerSize, rulerSize, canvas.height - rulerSize);
    
    // Esquina (interseccin)
    ctx.fillStyle = 'rgba(15, 23, 42, 0.95)';
    ctx.fillRect(0, 0, rulerSize, rulerSize);

    // Configuracin de texto
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // Calcular rango visible en coordenadas del mundo
    const viewLeft = -this.state.offsetX / this.state.scale;
    const viewRight = (canvas.width - this.state.offsetX) / this.state.scale;
    const viewTop = -this.state.offsetY / this.state.scale;
    const viewBottom = (canvas.height - this.state.offsetY) / this.state.scale;

    // Dibujar marcas horizontales (regla superior)
    ctx.strokeStyle = 'rgba(148, 163, 184, 0.5)';
    ctx.fillStyle = 'rgba(226, 232, 240, 0.9)';
    ctx.lineWidth = 1;

    const startX = Math.floor(viewLeft / gridSize) * gridSize;
    for (let x = startX; x <= viewRight; x += gridSize) {
      const screenX = x * this.state.scale + this.state.offsetX;
      if (screenX < rulerSize || screenX > canvas.width) continue;

      // Lnea de marca
      ctx.beginPath();
      ctx.moveTo(screenX, rulerSize - 8);
      ctx.lineTo(screenX, rulerSize);
      ctx.stroke();

      // Nmero
      if (x % (gridSize * 2) === 0) { // Mostrar cada 2 marcas
        ctx.fillText(Math.round(x).toString(), screenX, rulerSize / 2);
      }
    }

    // Dibujar marcas verticales (regla izquierda)
    ctx.textAlign = 'left';
    const startY = Math.floor(viewTop / gridSize) * gridSize;
    for (let y = startY; y <= viewBottom; y += gridSize) {
      const screenY = y * this.state.scale + this.state.offsetY;
      if (screenY < rulerSize || screenY > canvas.height) continue;

      // Lnea de marca
      ctx.beginPath();
      ctx.moveTo(rulerSize - 8, screenY);
      ctx.lineTo(rulerSize, screenY);
      ctx.stroke();

      // Nmero (rotado)
      if (y % (gridSize * 2) === 0) {
        ctx.save();
        ctx.translate(rulerSize / 2, screenY);
        ctx.rotate(-Math.PI / 2);
        ctx.textAlign = 'center';
        ctx.fillText(Math.round(y).toString(), 0, 0);
        ctx.restore();
      }
    }

    // Borde de las reglas
    ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
    ctx.lineWidth = 1;
    ctx.strokeRect(rulerSize, 0, canvas.width - rulerSize, rulerSize);
    ctx.strokeRect(0, rulerSize, rulerSize, canvas.height - rulerSize);

    ctx.restore();
  },

  drawAreas(ctx) {
    if (!Array.isArray(this.state.areas) || !this.state.areas.length) return;

    ctx.save();
    this.state.areas.forEach(area => {
      if (!Array.isArray(area.points) || area.points.length < 3) return;
      const color = area.color || '#3b82f6';
      const opacity = typeof area.opacity === 'number' ? area.opacity : 0.35;
      
      //  ETAPA 3.1: Verificar si el rea est seleccionada
      const isSelected = this.state.selectedAreaIds.includes(area.id);
      
      ctx.beginPath();
      area.points.forEach((point, index) => {
        if (index === 0) ctx.moveTo(point.x, point.y);
        else ctx.lineTo(point.x, point.y);
      });
      ctx.closePath();
      
      //  Si es el rea resaltada, usar relleno amarillo brillante
      if (area.id === this.state.highlightAreaId) {
        ctx.fillStyle = 'rgba(251, 191, 36, 0.4)'; // Amarillo brillante semi-transparente
      } else {
        ctx.fillStyle = this.hexToRgba(color, opacity);
      }
      
      //  Cambiar estilo de borde segn estado
      if (isSelected) {
        ctx.strokeStyle = '#10b981'; // Verde para seleccionadas
        ctx.lineWidth = 4 / this.state.scale;
      } else if (area.id === this.state.highlightAreaId) {
        //  REA RESALTADA - EFECTO SUPER VISIBLE
        // Sombra exterior brillante (resplandor)
        ctx.shadowColor = '#fbbf24'; // Amarillo brillante
        ctx.shadowBlur = 20 / this.state.scale;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        
        // Borde amarillo grueso
        ctx.strokeStyle = '#fbbf24'; // Amarillo muy visible
        ctx.lineWidth = 6 / this.state.scale;
      } else {
        ctx.strokeStyle = color;
        ctx.lineWidth = 2 / this.state.scale;
      }
      
      ctx.fill();
      ctx.stroke();
      
      // Limpiar sombra para el resto del dibujo
      ctx.shadowBlur = 0;

      //  Solo dibujar nombres si estn habilitados
      if (this.state.mostrarNombresAreas) {
        const centroid = this.calculateCentroid(area.points);
        if (centroid) {
          //  ETAPA 2: Etiqueta mejorada con fondo semi-transparente y texto multi-lnea
          ctx.save();
          
          // Obtener offset personalizado (por defecto 0, 0)
          const labelOffsetX = area.labelOffsetX || 0;
          const labelOffsetY = area.labelOffsetY || 0;
          const labelX = centroid.x + labelOffsetX;
          const labelY = centroid.y + labelOffsetY;
          
          //  TAMAO DE FUENTE ADAPTATIVO AL ZOOM
          // Formula mejorada: Tamao base decrece con el zoom para no ocupar tanto espacio
          // Zoom 1.0 (normal): 28px
          // Zoom 0.5 (alejado 2x): 20px
          // Zoom 0.25 (alejado 4x): 14px (mnimo)
          const baseFontSize = 28;
          const minFontSize = 14;
          const zoomFactor = this.state.zoom || 1.0;
          
          // Aplicar raz cuadrada para suavizar el cambio
        const fontSize = Math.max(minFontSize, baseFontSize / Math.sqrt(zoomFactor));
        
        ctx.font = `bold ${fontSize}px "Segoe UI", sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        //  MEJORA: Dividir texto largo en mltiples lneas (mximo 20 caracteres por lnea)
        const text = area.name || 'rea';
        const maxCharsPerLine = 20;
        const lines = [];
        
        if (text.length <= maxCharsPerLine) {
          lines.push(text);
        } else {
          // Dividir por palabras para no cortar a la mitad
          const words = text.split(' ');
          let currentLine = '';
          
          words.forEach((word, idx) => {
            const testLine = currentLine ? `${currentLine} ${word}` : word;
            if (testLine.length <= maxCharsPerLine) {
              currentLine = testLine;
            } else {
              if (currentLine) lines.push(currentLine);
              currentLine = word;
            }
            if (idx === words.length - 1 && currentLine) {
              lines.push(currentLine);
            }
          });
        }
        
        // Medir el ancho mximo de todas las lneas
        let maxWidth = 0;
        lines.forEach(line => {
          const metrics = ctx.measureText(line);
          if (metrics.width > maxWidth) maxWidth = metrics.width;
        });
        
        const textWidth = maxWidth;
        const lineHeight = fontSize * 1.2;
        const textHeight = lineHeight * lines.length;
        
        //  Padding interno adaptativo al zoom (ms pequeo cuando hay zoom)
        const paddingX = Math.max(6, 12 / Math.sqrt(zoomFactor));
        const paddingY = Math.max(4, 8 / Math.sqrt(zoomFactor));
        
        // Dimensiones del rectngulo
        const rectWidth = textWidth + paddingX * 2;
        const rectHeight = textHeight + paddingY * 2;
        const rectX = labelX - rectWidth / 2;
        const rectY = labelY - rectHeight / 2;
        
        //  MEJORA: Fondo semi-transparente con efecto glassmorphism
        const isSelected = this.state.selectedAreaIds.includes(area.id);
        const isHighlighted = area.id === this.state.highlightAreaId;
        
        //  Sombra adaptativa al zoom
        ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
        ctx.shadowBlur = Math.max(4, 8 / Math.sqrt(zoomFactor));
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = Math.max(1, 2 / Math.sqrt(zoomFactor));
        
        // Fondo con gradiente sutil
        const gradient = ctx.createLinearGradient(rectX, rectY, rectX, rectY + rectHeight);
        if (isSelected) {
          gradient.addColorStop(0, 'rgba(209, 250, 229, 0.95)');  // Verde claro
          gradient.addColorStop(1, 'rgba(167, 243, 208, 0.95)');
        } else if (isHighlighted) {
          gradient.addColorStop(0, 'rgba(254, 249, 195, 0.95)');  // Amarillo claro
          gradient.addColorStop(1, 'rgba(253, 230, 138, 0.95)');
        } else {
          gradient.addColorStop(0, 'rgba(255, 255, 255, 0.92)');  // Blanco semi-transparente
          gradient.addColorStop(1, 'rgba(249, 250, 251, 0.92)');
        }
        ctx.fillStyle = gradient;
        
        //  Rectngulo con bordes redondeados adaptativos
        const radius = Math.max(3, 6 / Math.sqrt(zoomFactor));
        ctx.beginPath();
        ctx.moveTo(rectX + radius, rectY);
        ctx.lineTo(rectX + rectWidth - radius, rectY);
        ctx.quadraticCurveTo(rectX + rectWidth, rectY, rectX + rectWidth, rectY + radius);
        ctx.lineTo(rectX + rectWidth, rectY + rectHeight - radius);
        ctx.quadraticCurveTo(rectX + rectWidth, rectY + rectHeight, rectX + rectWidth - radius, rectY + rectHeight);
        ctx.lineTo(rectX + radius, rectY + rectHeight);
        ctx.quadraticCurveTo(rectX, rectY + rectHeight, rectX, rectY + rectHeight - radius);
        ctx.lineTo(rectX, rectY + radius);
        ctx.quadraticCurveTo(rectX, rectY, rectX + radius, rectY);
        ctx.closePath();
        ctx.fill();
        
        // Remover sombra para el borde
        ctx.shadowBlur = 0;
        
        // Dibujar borde (verde si seleccionado, amarillo si resaltado, gris si normal)
        if (isSelected) {
          ctx.strokeStyle = '#10b981';
          ctx.lineWidth = 3 / this.state.scale;
        } else if (isHighlighted) {
          ctx.strokeStyle = '#facc15';
          ctx.lineWidth = 3 / this.state.scale;
        } else {
          ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
          ctx.lineWidth = 2 / this.state.scale;
        }
        ctx.stroke();
        
        //  MEJORA: Dibujar texto multi-lnea con mejor contraste
        ctx.fillStyle = isSelected ? '#064e3b' : (isHighlighted ? '#713f12' : '#1f2937');
        ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
        ctx.shadowBlur = 3 / this.state.scale;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        
        // Calcular posicin Y inicial (centrada verticalmente)
        const startY = labelY - (textHeight / 2) + (lineHeight / 2);
        
        lines.forEach((line, idx) => {
          const lineY = startY + (idx * lineHeight);
          ctx.fillText(line, labelX, lineY);
        });
        
        ctx.shadowBlur = 0;
        
        //  Agregar check mark si est seleccionado
        if (isSelected) {
          ctx.font = `bold ${fontSize * 0.9}px "Segoe UI", sans-serif`;
          ctx.fillStyle = '#10b981';
          ctx.shadowBlur = 0;
          ctx.fillText('', rectX + rectWidth + (paddingX * 1.5), labelY);
        }
        
        //  ICONOS DE CATEGORA REMOVIDOS (ocupaban mucho espacio)
        // Los nombres ahora se muestran sin iconos para mejor legibilidad
        
        ctx.restore();
        } // Fin del if mostrarNombresAreas
      } // Fin del if centroid
    });
    ctx.restore();
  },

  //  NUEVO: Dibujar marcadores de repuestos en el mapa
  drawMarkers(ctx) {
    //  MODIFICADO: Si el botón está OFF, solo mostrar el marcador seleccionado
    // Si está ON, mostrar todos los marcadores
    
    if (!app || !app.repuestos) return;
    
    ctx.save();
    
    //  Usar función centralizada para correlativos GLOBALES
    const correlativosGlobales = this.calcularCorrelativosGlobales(this.state.currentMapId);
    
    //  PASO 2: Buscar repuestos con ubicaciones en el mapa actual y asignar número correlativo GLOBAL
    const marcadores = [];
    
    app.repuestos.forEach(repuesto => {
      // Formato NUEVO: array de ubicaciones
      if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones)) {
        repuesto.ubicaciones.forEach((ub, index) => {
          if (String(ub.mapId) === String(this.state.currentMapId) && ub.markerX && ub.markerY) {
            // Obtener todas las instancias de esta ubicación
            const corrInfoArray = correlativosGlobales[repuesto.id]?.[index] || [{ numero: 1, total: 1, instanciaLocal: 1 }];
            
            // Agregar un marcador por cada instancia (con el mismo markerX, markerY pero correlativo diferente)
            corrInfoArray.forEach(corrInfo => {
              marcadores.push({
                repuesto: repuesto,
                x: ub.markerX,
                y: ub.markerY,
                areaId: ub.areaId,
                ubicacionIndex: index,
                numeroCorrelativo: corrInfo.numero,
                totalInstancias: corrInfo.total,
                instanciaLocal: corrInfo.instanciaLocal
              });
            });
          }
        });
      }
      
      // Formato ANTIGUO: propiedades directas (compatibilidad)
      if (repuesto.mapId && String(repuesto.mapId) === String(this.state.currentMapId) && repuesto.markerX && repuesto.markerY) {
        const corrInfoArray = correlativosGlobales[repuesto.id]?.[0] || [{ numero: 1, total: 1, instanciaLocal: 1 }];
        corrInfoArray.forEach(corrInfo => {
          marcadores.push({
            repuesto: repuesto,
            x: repuesto.markerX,
            y: repuesto.markerY,
            areaId: repuesto.areaId,
            ubicacionIndex: 0,
            numeroCorrelativo: corrInfo.numero,
            totalInstancias: corrInfo.total,
            instanciaLocal: corrInfo.instanciaLocal
          });
        });
      }
    });
    
    //  FILTRAR: Si hay un repuesto filtrado, mostrar solo sus marcadores
    let marcadoresFiltrados = marcadores;
    if (this.state.repuestoFiltrado) {
      marcadoresFiltrados = marcadores.filter(m => 
        String(m.repuesto.id) === String(this.state.repuestoFiltrado)
      );
      console.log(` Filtro activo: Mostrando ${marcadoresFiltrados.length} de ${marcadores.length} marcadores`);
    }
    
    //  NUEVO FILTRO: Si el botón de puntos está OFF, solo mostrar el marcador seleccionado
    if (!this.state.mostrarPuntosRepuestos) {
      if (this.state.highlightMarker) {
        // Solo mostrar el marcador resaltado
        marcadoresFiltrados = marcadores.filter(m => 
          String(m.repuesto.id) === String(this.state.highlightMarker.repuestoId) &&
          m.ubicacionIndex === this.state.highlightMarker.ubicacionIndex
        );
        console.log(` Botn OFF: Mostrando solo marcador seleccionado`);
      } else {
        // No hay seleccin, no mostrar nada
        ctx.restore();
        return;
      }
    }
    
    //  Si hay un marcador siendo arrastrado, dibujarlo en posicin temporal
    if (this.state.marcadorArrastre && this.state.marcadorArrastre.iniciado) {
      const { info, mapX, mapY } = this.state.marcadorArrastre;
      
  // Dibujar marcador en posicin temporal con efecto fantasma
  this.dibujarMarcadorIndividual(ctx, info.repuesto, mapX, mapY, info.ubicacion.areaId, true, 1.0, info.ubicacionIndex, info.numeroCorrelativo, info.totalInstancias);
      
      // Tambin mostrar la posicin original con opacidad reducida
      marcadoresFiltrados.forEach((m, i) => {
        const esElMismomarcador = m.repuesto.id === info.repuesto.id && 
                                  Math.abs(m.x - info.x) < 1 && 
                                  Math.abs(m.y - info.y) < 1;
        
  this.dibujarMarcadorIndividual(ctx, m.repuesto, m.x, m.y, m.areaId, false, esElMismomarcador ? 0.3 : 1.0, m.ubicacionIndex, m.numeroCorrelativo, m.totalInstancias);
      });
    } else {
      // Dibujar todos los marcadores (filtrados o todos)
    if (marcadoresFiltrados.length === 0) {
      ctx.restore();
      return;
    }
    
    // console.log(` Dibujando ${marcadoresFiltrados.length} marcadores en el mapa`);
    
    marcadoresFiltrados.forEach(({ repuesto, x, y, areaId, ubicacionIndex, numeroCorrelativo, totalInstancias }) => {
      this.dibujarMarcadorIndividual(ctx, repuesto, x, y, areaId, false, 1.0, ubicacionIndex, numeroCorrelativo, totalInstancias);
    });
  }    ctx.restore();
  },
  
  //  NUEVA FUNCIN: Dibujar un marcador individual
  dibujarMarcadorIndividual(ctx, repuesto, x, y, areaId, esPreview = false, opacidad = 1.0, ubicacionIndex = null, numeroCorrelativo = null, totalInstancias = 1) {
    ctx.save();
    
    // Verificar si este es el pin en modo edicin
    const esEdicionPin = this.state.pinAMover && 
                         this.state.pinAMover.editando && 
                         String(repuesto.id) === String(this.state.pinAMover.repuestoId);
    
    //  Verificar si este marcador est resaltado (highlight)
    // IMPORTANTE: Verificar tambin el ubicacionIndex para resaltar solo el correcto
  const esResaltado = this.state.highlightMarker &&
            String(repuesto.id) === String(this.state.highlightMarker.repuestoId) &&
            (ubicacionIndex !== null && ubicacionIndex === this.state.highlightMarker.ubicacionIndex);
    
    // Si es preview, aplicar efecto pulsante
    if (esPreview) {
      ctx.globalAlpha = 0.8;
      const pulso = Math.sin(Date.now() / 100) * 0.1 + 0.9;
      // No aplicar scale, solo dibujar en la posicin temporal
    } else if (esResaltado) {
      //  Efecto pulsante para marcador resaltado
      ctx.globalAlpha = 1.0;
    } else {
      ctx.globalAlpha = opacidad;
    }
    
    //  Dibujar marcador tipo "pin"
    //  CORRECCIN: Aplicar efecto pulsante al tamao en lugar de ctx.scale()
    // para evitar que el marcador se "mueva" por el escalado desde origen (0,0)
    const pulsoMultiplicador = esResaltado ? (Math.sin(Date.now() / 200) * 0.15 + 1.15) : 1.0;
    const pinHeight = Math.max(30, 40 / this.state.scale) * pulsoMultiplicador;
    const pinWidth = Math.max(20, 26 / this.state.scale) * pulsoMultiplicador;
    
    //  EFECTO HALO: Dibujar aura pulsante para marcador resaltado
    if (esResaltado) {
      const haloPulso = Math.sin(Date.now() / 300) * 0.3 + 0.7; // Pulso suave entre 0.4 y 1.0
      const haloRadius = (pinWidth * 1.8) * haloPulso;
      
      // Dibujar mltiples anillos semi-transparentes para efecto de "ondas"
      for (let i = 3; i >= 1; i--) {
        ctx.beginPath();
        ctx.arc(x, y - pinHeight / 2, haloRadius * (1 + i * 0.15), 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(251, 191, 36, ${0.2 / i})`; // Amarillo dorado semi-transparente
        ctx.lineWidth = Math.max(2, 4 / this.state.scale);
        ctx.stroke();
      }
      
      // Crculo de relleno suave en el centro del halo
      const gradientHalo = ctx.createRadialGradient(x, y - pinHeight / 2, 0, x, y - pinHeight / 2, haloRadius);
      gradientHalo.addColorStop(0, 'rgba(251, 191, 36, 0.15)');
      gradientHalo.addColorStop(0.7, 'rgba(251, 191, 36, 0.05)');
      gradientHalo.addColorStop(1, 'rgba(251, 191, 36, 0)');
      
      ctx.fillStyle = gradientHalo;
      ctx.beginPath();
      ctx.arc(x, y - pinHeight / 2, haloRadius * 1.3, 0, Math.PI * 2);
      ctx.fill();
    }
    
    // Sombra del pin (ms pronunciada para marcador resaltado)
    if (esResaltado) {
      ctx.shadowColor = 'rgba(251, 191, 36, 0.8)'; // Sombra amarilla para resaltado
      ctx.shadowBlur = 25 / this.state.scale;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 8 / this.state.scale;
    } else {
      ctx.shadowColor = esPreview ? 'rgba(59, 130, 246, 0.6)' : 
                        esEdicionPin ? 'rgba(249, 115, 22, 0.6)' : 
                        'rgba(0, 0, 0, 0.4)';
      ctx.shadowBlur = 15 / this.state.scale;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 5 / this.state.scale;
    }
    
    // Color segn stock o modo edicin
    const cantidad = repuesto.cantidad || 0;
    const minimo = repuesto.minimo || 5;
    let markerColor, markerBorder;
    
    if (esEdicionPin) {
      //  NARANJA para modo edicin (como cuando editas reas)
      markerColor = '#f97316'; // Naranja brillante
      markerBorder = '#ea580c';
    } else if (esResaltado) {
      //  AMARILLO BRILLANTE para marcador resaltado
      markerColor = '#fbbf24'; // Amarillo dorado
      markerBorder = '#f59e0b';
    } else if (esPreview) {
      markerColor = '#3b82f6'; // Azul para preview
      markerBorder = '#2563eb';
    } else if (cantidad === 0) {
      markerColor = '#ef4444'; // Rojo - sin stock
      markerBorder = '#dc2626';
    } else if (cantidad < minimo) {
      markerColor = '#f59e0b'; // Naranja - bajo stock
      markerBorder = '#d97706';
    } else {
      markerColor = '#10b981'; // Verde - stock OK
      markerBorder = '#059669';
    }
    
    // Dibujar forma de pin (gota invertida)
    ctx.beginPath();
    
    // Crculo superior del pin
    const circleRadius = pinWidth / 2;
    ctx.arc(x, y - pinHeight + circleRadius, circleRadius, 0, Math.PI * 2);
    
    // Punta del pin (tringulo hacia abajo)
    ctx.moveTo(x - circleRadius * 0.5, y - circleRadius);
    ctx.lineTo(x, y);
    ctx.lineTo(x + circleRadius * 0.5, y - circleRadius);
    
    ctx.fillStyle = markerColor;
    ctx.fill();
    
    // Borde del pin
    ctx.strokeStyle = markerBorder;
    ctx.lineWidth = Math.max(1.5, 2 / this.state.scale);
    ctx.stroke();
    
    ctx.shadowBlur = 0;
    
    // Punto central blanco dentro del crculo
    ctx.beginPath();
    ctx.arc(x, y - pinHeight + circleRadius, circleRadius * 0.4, 0, Math.PI * 2);
    ctx.fillStyle = '#ffffff';
    ctx.fill();
    
    //  Etiqueta del repuesto (ESCALADA SEGN ZOOM)
    // Frmula similar a nombres de reas: baseFontSize / zoomFactor
    const baseFontSize = 18;
    const minFontSize = 10;
    const zoomFactor = this.state.zoom || 1.0;
    const fontSize = Math.max(minFontSize, baseFontSize / Math.sqrt(zoomFactor));
    
    ctx.font = `bold ${fontSize}px "Segoe UI", sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    
    // Limitar longitud del texto
    let text = repuesto.nombre;
    if (text.length > 20) {
      text = text.substring(0, 17) + '...';
    }
    
    const metrics = ctx.measureText(text);
    const textWidth = metrics.width;
    
    // Padding adaptativo segn zoom
    const paddingX = Math.max(4, 8 / Math.sqrt(zoomFactor));
    const paddingY = Math.max(2.5, 5 / Math.sqrt(zoomFactor));
    
    // Fondo de la etiqueta con bordes redondeados
    const rectX = x - textWidth / 2 - paddingX;
    const rectY = y - pinHeight - fontSize - paddingY * 2.5;
    const rectWidth = textWidth + paddingX * 2;
    const rectHeight = fontSize + paddingY * 2;
    const cornerRadius = Math.max(2, 4 / Math.sqrt(zoomFactor));
    
    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
    ctx.shadowBlur = Math.max(5, 10 / Math.sqrt(zoomFactor));
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = Math.max(1, 2 / Math.sqrt(zoomFactor));
    
    // Rectngulo con esquinas redondeadas
    ctx.beginPath();
    ctx.moveTo(rectX + cornerRadius, rectY);
    ctx.lineTo(rectX + rectWidth - cornerRadius, rectY);
    ctx.arcTo(rectX + rectWidth, rectY, rectX + rectWidth, rectY + cornerRadius, cornerRadius);
    ctx.lineTo(rectX + rectWidth, rectY + rectHeight - cornerRadius);
    ctx.arcTo(rectX + rectWidth, rectY + rectHeight, rectX + rectWidth - cornerRadius, rectY + rectHeight, cornerRadius);
    ctx.lineTo(rectX + cornerRadius, rectY + rectHeight);
    ctx.arcTo(rectX, rectY + rectHeight, rectX, rectY + rectHeight - cornerRadius, cornerRadius);
    ctx.lineTo(rectX, rectY + cornerRadius);
    ctx.arcTo(rectX, rectY, rectX + cornerRadius, rectY, cornerRadius);
    ctx.closePath();
    
    ctx.fillStyle = esPreview ? 'rgba(59, 130, 246, 0.95)' : 'rgba(0, 0, 0, 0.85)';
    ctx.fill();
    
    // Borde de la etiqueta
    ctx.strokeStyle = markerColor;
    ctx.lineWidth = Math.max(1, 1.5 / this.state.scale);
    ctx.stroke();
    
    ctx.shadowBlur = 0;
    
    // Texto del nombre
    ctx.fillStyle = '#ffffff';
    ctx.fillText(text, x, y - pinHeight - paddingY * 1.5);
    
    //  Badge de cantidad (pequeo crculo con nmero)
    if (cantidad >= 0 && !esPreview) {
      const badgeRadius = Math.max(10, 14 / this.state.scale);
      const badgeX = x + circleRadius * 0.7;
      const badgeY = y - pinHeight + circleRadius - circleRadius * 0.7;
      
      // Crculo del badge
      ctx.beginPath();
      ctx.arc(badgeX, badgeY, badgeRadius, 0, Math.PI * 2);
      ctx.fillStyle = cantidad === 0 ? '#dc2626' : (cantidad < minimo ? '#d97706' : '#059669');
      ctx.fill();
      
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = Math.max(1, 2 / this.state.scale);
      ctx.stroke();
      
      // Nmero de cantidad
      const badgeFontSize = Math.max(9, 12 / this.state.scale);
      ctx.font = `bold ${badgeFontSize}px "Segoe UI", sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#ffffff';
      ctx.fillText(cantidad.toString(), badgeX, badgeY);
    }
    
    //  Badge de nmero correlativo (solo si hay mltiples instancias)
    if (totalInstancias > 1 && numeroCorrelativo && !esPreview) {
      const correlativoBadgeRadius = Math.max(9, 12 / this.state.scale);
      const correlativoBadgeX = x - circleRadius * 0.7;
      const correlativoBadgeY = y - pinHeight + circleRadius - circleRadius * 0.7;
      
      // Crculo del badge negro
      ctx.beginPath();
      ctx.arc(correlativoBadgeX, correlativoBadgeY, correlativoBadgeRadius, 0, Math.PI * 2);
      ctx.fillStyle = '#222222';
      ctx.fill();
      
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = Math.max(1, 1.5 / this.state.scale);
      ctx.stroke();
      
      // Nmero correlativo
      const correlativoFontSize = Math.max(8, 10 / this.state.scale);
      ctx.font = `bold ${correlativoFontSize}px monospace`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#ffffff';
      ctx.fillText(`#${numeroCorrelativo}`, correlativoBadgeX, correlativoBadgeY);
    }
    
    // Texto "ARRASTRANDO" si es preview
    if (esPreview) {
      const previewFontSize = Math.max(10, 14 / this.state.scale);
      ctx.font = `bold ${previewFontSize}px "Segoe UI", sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillStyle = '#3b82f6';
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 3 / this.state.scale;
      ctx.strokeText(' ARRASTRANDO', x, y + 10 / this.state.scale);
      ctx.fillText(' ARRASTRANDO', x, y + 10 / this.state.scale);
    }
    
  ctx.restore();
},

//  Continuar con ubicaciones resaltadas (solo si no hay arrastre activo)
dibujarUbicacionesResaltadas(ctx) {
  if (!this.state.ubicacionesResaltadas || this.state.ubicacionesResaltadas.length === 0) return;
  if (this.state.marcadorArrastre && this.state.marcadorArrastre.iniciado) return;
  
  //  OPTIMIZADO: Animacin ms sutil y menos costosa
  // Solo animar cada 100ms en lugar de cada frame
  const ahora = Date.now();
  if (!this.state.ultimaAnimacion || ahora - this.state.ultimaAnimacion > 100) {
    this.state.ultimaAnimacion = ahora;
    this.state.pulsoAnimacion = (this.state.pulsoAnimacion || 0) + 0.15;
  }
  
  this.state.ubicacionesResaltadas.forEach(({ x, y, repuesto, descripcion }, index) => {
    // Animacin simple: solo un anillo pulsante
    const pulso = Math.sin(this.state.pulsoAnimacion + index * 0.5) * 0.3 + 0.7; // 0.4 a 1.0
    
    // Tamao base adaptable al zoom
    const baseSize = Math.max(25, 40 / this.state.scale);
    const ringRadius = baseSize * pulso;
    
    // UN SOLO anillo (en lugar de 2)
    ctx.beginPath();
    ctx.arc(x, y, ringRadius, 0, Math.PI * 2);
    ctx.strokeStyle = `rgba(59, 130, 246, ${0.5 * pulso})`;
    ctx.lineWidth = Math.max(2, 4 / this.state.scale);
    ctx.stroke();
    
    // Punto central SIN sombra (las sombras son costosas)
    const centerRadius = Math.max(10, 15 / this.state.scale);
    
    ctx.beginPath();
    ctx.arc(x, y, centerRadius, 0, Math.PI * 2);
    ctx.fillStyle = '#3b82f6';
    ctx.fill();
    
    // Borde blanco del punto
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = Math.max(2, 3 / this.state.scale);
    ctx.stroke();
    
    // Punto interno
    ctx.beginPath();
    ctx.arc(x, y, centerRadius * 0.3, 0, Math.PI * 2);
    ctx.fillStyle = '#ffffff';
    ctx.fill();
  });
  
  //  Continuar animacin solo si hay ubicaciones resaltadas
  if (this.state.ubicacionesResaltadas && this.state.ubicacionesResaltadas.length > 0) {
    if (!this.state.animacionResaltadaActiva) {
      this.state.animacionResaltadaActiva = true;
      const animarResaltado = () => {
        if (this.state.ubicacionesResaltadas && this.state.ubicacionesResaltadas.length > 0) {
          this.draw();
          requestAnimationFrame(animarResaltado);
        } else {
          this.state.animacionResaltadaActiva = false;
        }
      };
      requestAnimationFrame(animarResaltado);
    }
  }
},

  //  NUEVA FUNCIN: Guardar nueva posicin del marcador despus de arrastrar
  async guardarNuevaPosicionMarcador(marcadorInfo, nuevoX, nuevoY) {
    const { repuesto, ubicacionIndex, ubicacion } = marcadorInfo;
    
    console.log(` Guardando nueva posicin del marcador:`, {
      repuesto: repuesto.nombre,
      indice: ubicacionIndex,
      antiguaPos: { x: ubicacion.markerX, y: ubicacion.markerY },
      nuevaPos: { x: nuevoX, y: nuevoY }
    });
    
    // Verificar que la nueva posicin est en un rea vlida
    const areasCercanas = this.buscarAreasCercanas(nuevoX, nuevoY, 300);
    
    if (areasCercanas.length === 0) {
      this.showToast(' No hay reas cercanas. Coloca el marcador dentro de un rea.', 'warning');
      this.draw(); // Redibujar sin cambios
      return;
    }
    
    // Si hay un rea vlida, usar la primera (ms cercana)
    const areaNueva = areasCercanas[0].area;
    
    // Actualizar ubicacin en el repuesto
    if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones)) {
      const ub = repuesto.ubicaciones[ubicacionIndex];
      if (ub) {
        ub.markerX = nuevoX;
        ub.markerY = nuevoY;
        ub.areaId = areaNueva.id; // Actualizar rea si cambi
      }
    }
    
    // Guardar cambios
    try {
      await app.saveData();
      this.showToast(` Posicin actualizada en "${areaNueva.name}"`, 'success');
      this.draw(); // Redibujar con nueva posicin
    } catch (error) {
      console.error('Error guardando posicin:', error);
      this.showToast(' Error al guardar la nueva posicin', 'error');
      // Revertir cambio
      if (repuesto.ubicaciones && repuesto.ubicaciones[ubicacionIndex]) {
        repuesto.ubicaciones[ubicacionIndex].markerX = ubicacion.markerX;
        repuesto.ubicaciones[ubicacionIndex].markerY = ubicacion.markerY;
        repuesto.ubicaciones[ubicacionIndex].areaId = ubicacion.areaId;
      }
      this.draw();
    }
  },

  drawTempShape(ctx) {
    if (!this.state.drawing || this.state.tempPoints.length === 0) return;

    ctx.save();
    
    //  MEJORA: Lneas ms gruesas y visibles
    ctx.strokeStyle = 'rgba(59, 130, 246, 1)'; // Opacidad 100%
    ctx.fillStyle = 'rgba(59, 130, 246, 0.25)'; // Ms opaco
    ctx.lineWidth = Math.max(3, 3 / this.state.scale); // Mnimo 3px
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    //  SOMBRA para el polgono
    ctx.shadowColor = 'rgba(59, 130, 246, 0.5)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;

    ctx.beginPath();
    this.state.tempPoints.forEach((point, index) => {
      if (index === 0) ctx.moveTo(point.x, point.y);
      else ctx.lineTo(point.x, point.y);
    });

    if (this.state.previewPoint) {
      ctx.lineTo(this.state.previewPoint.x, this.state.previewPoint.y);
    }

    if (this.state.tempPoints.length >= 2) {
      ctx.fill();
    }
    ctx.stroke();

    //  PUNTOS ms grandes y visibles con borde
    ctx.shadowBlur = 0; // Quitar sombra para puntos
    
    this.state.tempPoints.forEach((point, index) => {
      const radius = Math.max(6, 8 / this.state.scale); // Mnimo 6px
      
      // Borde blanco
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius + 2 / this.state.scale, 0, Math.PI * 2);
      ctx.fillStyle = '#ffffff';
      ctx.fill();
      
      // Punto principal azul
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius, 0, Math.PI * 2);
      ctx.fillStyle = index === 0 ? '#facc15' : '#3b82f6'; // Primer punto amarillo
      ctx.fill();
      
      // Nmero del punto
      if (this.state.tempPoints.length > 2) {
        ctx.fillStyle = '#ffffff';
        ctx.font = `bold ${Math.max(10, 12 / this.state.scale)}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText((index + 1).toString(), point.x, point.y);
      }
    });
    
    //  Punto de preview (cursor)
    if (this.state.previewPoint && this.state.tempPoints.length > 0) {
      const radius = Math.max(4, 6 / this.state.scale);
      ctx.beginPath();
      ctx.arc(this.state.previewPoint.x, this.state.previewPoint.y, radius, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(59, 130, 246, 0.5)';
      ctx.fill();
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 2 / this.state.scale;
      ctx.stroke();
    }
    
    ctx.restore();
  },

  drawEditPoints(ctx) {
    if (!this.state.editingAreaId || !this.state.editingPoints.length) return;

    ctx.save();
    
    const lineWidth = Math.max(3, 3 / this.state.scale);
    const pointRadius = Math.max(16, 16 / this.state.scale); // MS GRANDE: 16px (era 14px)
    const selectedRadius = Math.max(22, 22 / this.state.scale); // MS GRANDE: 22px (era 20px)
    
    // Dibujar las lneas de la forma
    ctx.beginPath();
    this.state.editingPoints.forEach((point, index) => {
      if (index === 0) {
        ctx.moveTo(point.x, point.y);
      } else {
        ctx.lineTo(point.x, point.y);
      }
    });
    ctx.closePath();
    
    // Lnea con estilo destacado
    ctx.strokeStyle = '#f59e0b'; // Amber para indicar modo edicin
    ctx.lineWidth = lineWidth;
    ctx.setLineDash([10 / this.state.scale, 5 / this.state.scale]);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Dibujar TODOS los puntos editables (todos visibles y arrastrables)
    this.state.editingPoints.forEach((point, index) => {
      const isSelected = index === this.state.selectedPointIndex;
      const isDragging = isSelected && this.state.isDraggingPoint;
      const radius = isSelected ? selectedRadius : pointRadius;
      
      // Sombra ms pronunciada para puntos seleccionados
      if (isDragging) {
        ctx.shadowColor = 'rgba(245, 158, 11, 0.6)';
        ctx.shadowBlur = 20 / this.state.scale;
      } else {
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 15 / this.state.scale;
      }
      ctx.shadowOffsetX = 3 / this.state.scale;
      ctx.shadowOffsetY = 3 / this.state.scale;
      
      // Crculo exterior (color principal) - MS TRANSPARENTE
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius, 0, Math.PI * 2);
      
      // Color segn estado - con transparencia para ver el fondo
      if (isDragging) {
        ctx.fillStyle = 'rgba(245, 158, 11, 0.7)'; // Amber semi-transparente
      } else if (isSelected) {
        ctx.fillStyle = 'rgba(251, 146, 60, 0.7)'; // Amber claro semi-transparente
      } else {
        ctx.fillStyle = 'rgba(59, 130, 246, 0.6)'; // Azul semi-transparente
      }
      ctx.fill();
      
      // Quitar sombra para el borde
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      
      // Borde blanco grueso
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 3 / this.state.scale;
      ctx.stroke();
      
      // Punto interior blanco semi-transparente para ver a travs
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius * 0.4, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.fill();
      
      // Anillo interior para puntos seleccionados
      if (isSelected) {
        ctx.beginPath();
        ctx.arc(point.x, point.y, radius * 0.65, 0, Math.PI * 2);
        ctx.strokeStyle = isDragging ? '#fbbf24' : '#fb923c';
        ctx.lineWidth = 2 / this.state.scale;
        ctx.stroke();
      }
      
      // Nmero del punto con fondo semi-transparente
      const fontSize = Math.max(16, 16 / this.state.scale);
      ctx.font = `bold ${fontSize}px sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      const labelY = point.y - radius - 14 / this.state.scale;
      const text = String(index + 1);
      
      // Medir texto para el fondo
      const metrics = ctx.measureText(text);
      const padding = 5 / this.state.scale;
      const bgWidth = metrics.width + padding * 2;
      const bgHeight = fontSize + padding * 2;
      
      // Fondo semi-transparente con bordes redondeados
      ctx.fillStyle = isSelected ? 'rgba(245, 158, 11, 0.85)' : 'rgba(0, 0, 0, 0.75)';
      const bgX = point.x - bgWidth / 2;
      const bgY = labelY - bgHeight / 2;
      const borderRadius = 5 / this.state.scale;
      
      ctx.beginPath();
      ctx.roundRect(bgX, bgY, bgWidth, bgHeight, borderRadius);
      ctx.fill();
      
      // Borde blanco del fondo
      ctx.strokeStyle = isSelected ? '#fbbf24' : 'white';
      ctx.lineWidth = 2 / this.state.scale;
      ctx.stroke();
      
      // Texto blanco
      ctx.fillStyle = 'white';
      ctx.fillText(text, point.x, labelY);
    });
    
    ctx.restore();
  },

  //  ETAPA 3.2: Dibujar handles de reshape (puntos editables)
  drawReshapeHandles(ctx) {
    if (!this.state.reshapeAreaId || !this.state.reshapePoints.length) return;
    
    ctx.save();
    
    const lineWidth = Math.max(3, 3 / this.state.scale);
    const pointRadius = Math.max(8, 8 / this.state.scale);
    const selectedRadius = Math.max(12, 12 / this.state.scale);
    const hoveredRadius = Math.max(10, 10 / this.state.scale);
    
    // Dibujar el polgono en edicin con estilo destacado
    ctx.beginPath();
    this.state.reshapePoints.forEach((point, index) => {
      if (index === 0) {
        ctx.moveTo(point.x, point.y);
      } else {
        ctx.lineTo(point.x, point.y);
      }
    });
    ctx.closePath();
    
    // Lnea punteada azul
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = lineWidth;
    ctx.setLineDash([8 / this.state.scale, 4 / this.state.scale]);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Dibujar bordes con indicador de hover (para agregar puntos)
    if (this.state.hoveredEdgeIndex !== null && this.state.hoveredEdgeIndex !== -1) {
      const p1 = this.state.reshapePoints[this.state.hoveredEdgeIndex];
      const p2 = this.state.reshapePoints[(this.state.hoveredEdgeIndex + 1) % this.state.reshapePoints.length];
      
      ctx.beginPath();
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.strokeStyle = '#10b981'; // Verde para indicar que puede agregar
      ctx.lineWidth = lineWidth * 1.5;
      ctx.stroke();
      
      // Dibujar punto fantasma donde se agregara
      const midX = (p1.x + p2.x) / 2;
      const midY = (p1.y + p2.y) / 2;
      
      ctx.beginPath();
      ctx.arc(midX, midY, pointRadius * 0.8, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(16, 185, 129, 0.3)';
      ctx.fill();
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 2 / this.state.scale;
      ctx.stroke();
    }
    
    // Dibujar puntos editables
    this.state.reshapePoints.forEach((point, index) => {
      const isSelected = index === this.state.selectedPointIndex;
      const isHovered = index === this.state.hoveredPointIndex;
      const isDragging = isSelected && this.state.isDraggingPoint;
      
      let radius = pointRadius;
      if (isSelected) radius = selectedRadius;
      else if (isHovered) radius = hoveredRadius;
      
      // Sombra
      ctx.shadowColor = isDragging ? 'rgba(59, 130, 246, 0.6)' : 'rgba(0, 0, 0, 0.3)';
      ctx.shadowBlur = isDragging ? 12 / this.state.scale : 6 / this.state.scale;
      ctx.shadowOffsetX = 2 / this.state.scale;
      ctx.shadowOffsetY = 2 / this.state.scale;
      
      // Crculo principal
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius, 0, Math.PI * 2);
      
      if (isDragging) {
        ctx.fillStyle = '#3b82f6'; // Azul slido
      } else if (isSelected) {
        ctx.fillStyle = '#60a5fa'; // Azul claro
      } else if (isHovered) {
        ctx.fillStyle = '#93c5fd'; // Azul muy claro
      } else {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)'; // Blanco semi-transparente
      }
      ctx.fill();
      
      // Quitar sombra para el borde
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      
      // Borde
      ctx.strokeStyle = isSelected || isDragging ? '#3b82f6' : '#64748b';
      ctx.lineWidth = 2 / this.state.scale;
      ctx.stroke();
      
      // Punto interior
      if (isSelected || isHovered) {
        ctx.beginPath();
        ctx.arc(point.x, point.y, radius * 0.4, 0, Math.PI * 2);
        ctx.fillStyle = '#3b82f6';
        ctx.fill();
      }
      
      // Nmero del punto
      const fontSize = Math.max(10, 10 / this.state.scale);
      ctx.font = `bold ${fontSize}px sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      const labelY = point.y - radius - 10 / this.state.scale;
      const text = String(index + 1);
      
      // Fondo del nmero
      const metrics = ctx.measureText(text);
      const padding = 3 / this.state.scale;
      const bgWidth = metrics.width + padding * 2;
      const bgHeight = fontSize + padding;
      
      ctx.fillStyle = isSelected ? '#3b82f6' : 'rgba(0, 0, 0, 0.7)';
      const bgX = point.x - bgWidth / 2;
      const bgY = labelY - bgHeight / 2;
      
      ctx.beginPath();
      ctx.roundRect(bgX, bgY, bgWidth, bgHeight, 3 / this.state.scale);
      ctx.fill();
      
      // Texto
      ctx.fillStyle = 'white';
      ctx.fillText(text, point.x, labelY);
    });
    
    // Mostrar controles en pantalla
    if (this.state.reshapeAreaId) {
      ctx.restore(); // Restaurar para dibujar en coordenadas de pantalla
      
      ctx.save();
      ctx.setTransform(1, 0, 0, 1, 0, 0); // Resetear transformacin
      
      // Panel de ayuda
      const canvas = this.elements.canvas;
      const panelX = 10;
      const panelY = canvas.height - 100;
      const panelWidth = 280;
      const panelHeight = 90;
      
      // Fondo del panel
      ctx.fillStyle = 'rgba(15, 23, 42, 0.95)';
      ctx.beginPath();
      ctx.roundRect(panelX, panelY, panelWidth, panelHeight, 8);
      ctx.fill();
      
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // Texto de ayuda
      ctx.fillStyle = '#e2e8f0';
      ctx.font = 'bold 12px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText(' Modo Edicin de Puntos', panelX + 12, panelY + 20);
      
      ctx.font = '11px sans-serif';
      ctx.fillStyle = '#cbd5e1';
      ctx.fillText(' Arrastra puntos para moverlos', panelX + 12, panelY + 40);
      ctx.fillText(' Click en borde para agregar punto', panelX + 12, panelY + 55);
      ctx.fillText(' Selecciona + Delete para eliminar', panelX + 12, panelY + 70);
      
      // Botones
      const btnY = panelY + panelHeight + 10;
      const btnHeight = 32;
      const btnPadding = 8;
      
      // Botn Guardar
      const saveBtn = { x: panelX, y: btnY, width: 100, height: btnHeight };
      ctx.fillStyle = '#10b981';
      ctx.beginPath();
      ctx.roundRect(saveBtn.x, saveBtn.y, saveBtn.width, saveBtn.height, 6);
      ctx.fill();
      
      ctx.fillStyle = 'white';
      ctx.font = 'bold 12px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(' Guardar (Enter)', saveBtn.x + saveBtn.width / 2, saveBtn.y + saveBtn.height / 2);
      
      // Botn Cancelar
      const cancelBtn = { x: panelX + 110, y: btnY, width: 100, height: btnHeight };
      ctx.fillStyle = '#ef4444';
      ctx.beginPath();
      ctx.roundRect(cancelBtn.x, cancelBtn.y, cancelBtn.width, cancelBtn.height, 6);
      ctx.fill();
      
      ctx.fillStyle = 'white';
      ctx.fillText(' Cancelar (Esc)', cancelBtn.x + cancelBtn.width / 2, cancelBtn.y + cancelBtn.height / 2);
      
      ctx.restore();
      return; // Ya hicimos restore
    }
    
    ctx.restore();
  },

  //  NUEVO: Renderizar minimap con vista general
  drawMinimap() {
    if (!this.minimapCtx || !this.elements.minimap) return;

    const image = this.getMinimapBitmap();
    if (!image) return;

    const minimap = this.elements.minimap;
    const ctx = this.minimapCtx;
    const container = this.elements.minimapContainer;
    
    // Ajustar tamao del canvas minimap al contenedor
    const containerWidth = container.offsetWidth;
    const containerHeight = container.offsetHeight;
    
    if (minimap.width !== containerWidth || minimap.height !== containerHeight) {
      minimap.width = containerWidth;
      minimap.height = containerHeight;
    }

    // Limpiar minimap
    ctx.clearRect(0, 0, minimap.width, minimap.height);
    ctx.fillStyle = 'rgba(15, 23, 42, 0.5)';
    ctx.fillRect(0, 0, minimap.width, minimap.height);

    // Calcular escala para que la imagen completa quepa en el minimap
    const dimensions = this.getMapDimensionsSafe();
    if (!dimensions.width || !dimensions.height) return;

    const imgWidth = dimensions.width;
    const imgHeight = dimensions.height;
    const scaleX = minimap.width / imgWidth;
    const scaleY = minimap.height / imgHeight;
    const minimapScale = Math.min(scaleX, scaleY) * 0.95; // 95% para dejar margen

    // Centrar imagen en minimap
    const drawWidth = imgWidth * minimapScale;
    const drawHeight = imgHeight * minimapScale;
    const offsetX = (minimap.width - drawWidth) / 2;
    const offsetY = (minimap.height - drawHeight) / 2;

    // Dibujar imagen en minimap
    ctx.save();
    ctx.translate(offsetX, offsetY);
    ctx.scale(minimapScale, minimapScale);
    ctx.globalAlpha = 0.6;
    ctx.drawImage(image, 0, 0, image.width, image.height, 0, 0, imgWidth, imgHeight);
    ctx.globalAlpha = 1;

    // Dibujar reas en minimap
    this.state.areas.forEach(area => {
      if (!Array.isArray(area.points) || area.points.length < 3) return;

      ctx.beginPath();
      area.points.forEach((point, index) => {
        if (index === 0) {
          ctx.moveTo(point.x, point.y);
        } else {
          ctx.lineTo(point.x, point.y);
        }
      });
      ctx.closePath();

      // Color del rea
      ctx.fillStyle = area.color ? `${area.color}40` : 'rgba(59, 130, 246, 0.25)';
      ctx.fill();
      ctx.strokeStyle = area.color || '#3b82f6';
      ctx.lineWidth = 1.5 / minimapScale;
      ctx.stroke();
    });

    ctx.restore();

    // Dibujar rectngulo del viewport actual
    const viewport = this.elements.minimapViewport;
    if (viewport) {
      const mainCanvas = this.elements.canvas;
      
      // Calcular viewport en coordenadas del mundo
      const viewLeft = -this.state.offsetX / this.state.scale;
      const viewTop = -this.state.offsetY / this.state.scale;
      const viewWidth = mainCanvas.width / this.state.scale;
      const viewHeight = mainCanvas.height / this.state.scale;

      // Convertir a coordenadas del minimap
      const vpLeft = offsetX + viewLeft * minimapScale;
      const vpTop = offsetY + viewTop * minimapScale;
      const vpWidth = viewWidth * minimapScale;
      const vpHeight = viewHeight * minimapScale;

      viewport.style.left = `${Math.max(0, Math.min(vpLeft, minimap.width))}px`;
      viewport.style.top = `${Math.max(0, Math.min(vpTop, minimap.height))}px`;
      viewport.style.width = `${Math.max(0, Math.min(vpWidth, minimap.width - vpLeft))}px`;
      viewport.style.height = `${Math.max(0, Math.min(vpHeight, minimap.height - vpTop))}px`;
    }
  },

  registerCanvasEvents() {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    canvas.addEventListener('mousedown', (event) => {
      if (event.button === 0) {
        const rect = canvas.getBoundingClientRect();
        const screenX = event.clientX - rect.left;
        const screenY = event.clientY - rect.top;
        
        // Calcular coordenadas transformadas (coordenadas de la imagen)
        const mapX = (screenX - this.state.offsetX) / this.state.scale;
        const mapY = (screenY - this.state.offsetY) / this.state.scale;
        
        //  VERIFICAR SI SE HIZO CLICK EN EL NOMBRE DE UN REA (para fijar tooltip)
        if (this.state.mostrarNombresAreas && !this.state.drawing && !this.state.editingAreaId && !this.state.modoAgregarMarcadorActivo) {
          let clickedOnLabel = false;
          let clickedArea = null;
          
          for (const area of this.state.areas) {
            if (!Array.isArray(area.points) || area.points.length < 3) continue;
            
            const centroid = this.calculateCentroid(area.points);
            if (!centroid) continue;
            
            const labelOffsetX = area.labelOffsetX || 0;
            const labelOffsetY = area.labelOffsetY || 0;
            const labelX = centroid.x + labelOffsetX;
            const labelY = centroid.y + labelOffsetY;
            
            // Calcular dimensiones del rectngulo del texto
            const text = area.name || 'rea';
            const maxCharsPerLine = 20;
            const lines = [];
            
            if (text.length <= maxCharsPerLine) {
              lines.push(text);
            } else {
              const words = text.split(' ');
              let currentLine = '';
              words.forEach((word, idx) => {
                const testLine = currentLine ? `${currentLine} ${word}` : word;
                if (testLine.length <= maxCharsPerLine) {
                  currentLine = testLine;
                } else {
                  if (currentLine) lines.push(currentLine);
                  currentLine = word;
                }
                if (idx === words.length - 1 && currentLine) {
                  lines.push(currentLine);
                }
              });
            }
            
            const baseFontSize = 28;
            const minFontSize = 14;
            const zoomFactor = this.state.zoom || 1.0;
            const fontSize = Math.max(minFontSize, baseFontSize / Math.sqrt(zoomFactor));
            
            const maxLineLength = Math.max(...lines.map(l => l.length));
            const textWidth = maxLineLength * fontSize * 0.6;
            const lineHeight = fontSize * 1.2;
            const textHeight = lineHeight * lines.length;
            
            const paddingX = Math.max(6, 12 / Math.sqrt(zoomFactor));
            const paddingY = Math.max(4, 8 / Math.sqrt(zoomFactor));
            
            const rectWidth = textWidth + paddingX * 2;
            const rectHeight = textHeight + paddingY * 2;
            const rectX = labelX - rectWidth / 2;
            const rectY = labelY - rectHeight / 2;
            
            // Verificar si el click est dentro del rectngulo del nombre
            if (mapX >= rectX && mapX <= rectX + rectWidth &&
                mapY >= rectY && mapY <= rectY + rectHeight) {
              clickedOnLabel = true;
              clickedArea = area;
              break;
            }
          }
          
          if (clickedOnLabel && clickedArea) {
            // Si el tooltip ya est fijado en esta rea, desfijarlo
            if (this.state.tooltipPinned && this.state.pinnedAreaId === clickedArea.id) {
              this.state.tooltipPinned = false;
              this.state.pinnedAreaId = null;
              this.state.highlightAreaId = null; //  Quitar resaltado amarillo
              this.elements.tooltip.classList.add('hidden');
              this.scheduleRender(); //  Redibujar para quitar el amarillo
              console.log(' Tooltip desfijado');
            } else {
              // Fijar el tooltip en esta rea
              this.state.tooltipPinned = true;
              this.state.pinnedAreaId = clickedArea.id;
              this.state.highlightAreaId = clickedArea.id; //  Resaltar rea en amarillo
              // Forzar actualizacin del tooltip
              this.updateTooltip(event);
              this.scheduleRender(); //  Redibujar con resaltado
              console.log(' Tooltip fijado en:', clickedArea.name);
            }
            
            // Prevenir otros comportamientos
            event.preventDefault();
            event.stopPropagation();
            return;
          } else if (!clickedOnLabel && this.state.tooltipPinned) {
            // Si se hace click fuera del label y el tooltip est fijado, desfijarlo
            this.state.tooltipPinned = false;
            this.state.pinnedAreaId = null;
            this.state.highlightAreaId = null; //  Quitar resaltado amarillo
            this.elements.tooltip.classList.add('hidden');
            this.scheduleRender(); //  Redibujar para quitar el amarillo
            console.log(' Tooltip desfijado por click fuera');
          }
          
          //  NUEVO: Si se hace click fuera, quitar seleccin de marcador tambin
          if (!clickedOnLabel) {
            this.clearMarkerSelection();
          }
        }
        
        //  MODO AGREGAR MARCADOR: Detectar click en rea y abrir modal
        if (this.state.modoAgregarMarcadorActivo) {
          console.log(' Click en modo agregar marcador:', { 
            screen: { screenX, screenY },
            map: { mapX, mapY },
            transform: { offsetX: this.state.offsetX, offsetY: this.state.offsetY, scale: this.state.scale }
          });
          
          // Buscar el rea donde se hizo click (usando coordenadas de la imagen)
          const areas = this.state.areas || [];
          console.log(' reas en el mapa:', areas.length);
          
          if (areas.length === 0) {
            console.warn(' No hay reas cargadas!');
            this.showToast(' Este mapa no tiene reas definidas', 'warning');
            event.preventDefault();
            event.stopPropagation();
            return;
          }
          
          // Probar cada rea
          let areaClickeada = null;
          for (const area of areas) {
            console.log(` Probando rea "${area.name}":`, {
              points: area.points.length,
              primer_punto: area.points[0],
              click: { mapX, mapY }
            });
            
            const dentro = this.puntoEnArea(mapX, mapY, area);
            console.log(`   Resultado: ${dentro ? ' DENTRO' : ' fuera'}`);
            
            if (dentro) {
              areaClickeada = area;
              break;
            }
          }
          
          if (areaClickeada) {
            console.log(' Click dentro del rea:', areaClickeada.name);
            // Usar coordenadas de la imagen para el marcador
            this.abrirModalBusquedaRepuesto(mapX, mapY, areaClickeada);
          } else {
            console.log(' No se encontr rea en las coordenadas:', { mapX, mapY });
            this.showToast(' Debes hacer click dentro de un rea', 'warning');
          }
          
          event.preventDefault();
          event.stopPropagation();
          return;
        }
        
        //  MODO MOVER PIN: Si estamos en modo edicin de pin
        if (this.state.pinAMover && this.state.pinAMover.editando) {
          console.log(' Click en modo edicin de pin');
          
          const marcadorClickeado = this.detectarClickEnMarcador(mapX, mapY);
          
          if (marcadorClickeado && 
              String(marcadorClickeado.repuesto.id) === String(this.state.pinAMover.repuestoId) &&
              marcadorClickeado.ubicacionIndex === this.state.pinAMover.ubicacionIndex) {
            
            console.log(' Click en el pin correcto! Activando arrastre...');
            
            // Activar arrastre del pin
            this.state.marcadorArrastre = {
              info: marcadorClickeado,
              iniciado: true,
              inicioX: screenX,
              inicioY: screenY,
              tiempoInicio: Date.now(),
              mapX: mapX,
              mapY: mapY,
              esEdicionPin: true  // Bandera especial para saber que es edicin de pin
            };
            
            canvas.style.cursor = 'grabbing';
            event.preventDefault();
            event.stopPropagation();
            return;
          }
        }
        
        //  CLICK EN MARCADORES FUERA DE MODO EDICIN: Fijar tarjeta hover
        if (!this.state.isReshapeMode && !this.state.pinAMover) {
          const marcadorClickeado = this.detectarClickEnMarcador(mapX, mapY);
          if (marcadorClickeado) {
            console.log(' Click en marcador  Fijar tarjeta hover');
            
            //  SOLUCIN: Delay para evitar que se cierre inmediatamente
            // Primero cerrar tarjeta anterior
            const tarjetaAnterior = document.getElementById('tarjetaHoverRepuesto');
            if (tarjetaAnterior) {
              tarjetaAnterior.remove();
            }
            
            // Marcar que estamos abriendo una nueva tarjeta
            this.state.abriendo_tarjeta_fija = true;
            
            // Abrir nueva tarjeta con delay
            setTimeout(() => {
              this.fijarTarjetaHoverRepuesto(marcadorClickeado, screenX, screenY);
              // Resetear bandera despus de que se haya montado
              setTimeout(() => {
                this.state.abriendo_tarjeta_fija = false;
              }, 150);
            }, 10);
            
            event.preventDefault();
            event.stopPropagation();
            return;
          } else {
            // Click fuera de marcadores  Cerrar tarjeta fija si existe
            // Solo cerrar si NO estamos abriendo una nueva
            if (!this.state.abriendo_tarjeta_fija) {
              this.cerrarTarjetaFija();
            }
          }
        }
        
        //  PRIORIDAD MXIMA: Modo marcador de repuesto
        if (this.state.modoMarcador && this.state.marcadorPendiente) {
          console.log(' Click detectado en modo marcador:', { mapX, mapY });
          this.colocarMarcador(mapX, mapY);
          return;
        }
        
        //  ETAPA 3.2: Detectar click en botones del panel de reshape
        if (this.state.isReshapeMode && this.state.reshapeAreaId) {
          const rect = canvas.getBoundingClientRect();
          const clickX = event.clientX - rect.left;
          const clickY = event.clientY - rect.top;
          
          const panelY = canvas.height - 100;
          const btnY = panelY + 90 + 10;
          const btnHeight = 32;
          
          // Botn Guardar
          if (clickX >= 10 && clickX <= 110 && clickY >= btnY && clickY <= btnY + btnHeight) {
            this.saveReshapeChanges();
            return;
          }
          
          // Botn Cancelar
          if (clickX >= 120 && clickX <= 220 && clickY >= btnY && clickY <= btnY + btnHeight) {
            this.cancelReshape();
            return;
          }
        }
        
        //  ETAPA 3.2: Modo reshape (edicin de puntos Y repuestos)
        if (this.state.isReshapeMode) {
          //  PRIORIDAD 1: Verificar si se clicke un marcador de repuesto
          const marcadorClickeado = this.detectarClickEnMarcador(mapX, mapY);
          if (marcadorClickeado) {
            console.log(' Modo edicin: Click en marcador de repuesto - PERMITIR ARRASTRE');
            //  Activar arrastre del marcador (SOLO en modo edicin)
            this.state.marcadorArrastre = {
              info: marcadorClickeado,
              iniciado: false, // Se activar al mover el mouse
              inicioX: screenX,
              inicioY: screenY,
              tiempoInicio: Date.now(),
              modoEdicion: true // Bandera para saber que est en modo edicin
            };
            event.preventDefault();
            event.stopPropagation();
            return;
          }
          
          //  PRIORIDAD 2: Si no hay marcador, verificar puntos de rea
          const pointIndex = this.state.reshapeAreaId ? this.findPointAtCursor(
            (event.clientX - this.elements.canvas.getBoundingClientRect().left - this.state.offsetX) / this.state.scale,
            (event.clientY - this.elements.canvas.getBoundingClientRect().top - this.state.offsetY) / this.state.scale
          ) : -1;
          
          if (pointIndex !== -1) {
            // Iniciar arrastre de punto de rea
            this.state.selectedPointIndex = pointIndex;
            this.state.isDraggingPoint = true;
          } else {
            // Click normal en reshape (seleccionar rea)
            this.handleReshapeClick(event);
          }
        }
        //  ETAPA 3.1: Modo seleccin mltiple
        else if (this.state.isMultiSelectMode && !this.state.drawing && !this.state.editingAreaId) {
          this.handleMultiSelectClick(event);
        } else if (this.state.editingAreaId) {
          // Modo edicin de puntos
          this.handleEditPointMouseDown(event);
        } else if (this.state.drawing) {
          this.addPoint(event);
        } else {
          this.beginPan(event);
        }
      }
    });

    canvas.addEventListener('mousemove', (event) => {
      //  ARRASTRE DE MARCADOR: Detectar movimiento para activar arrastre
      if (this.state.marcadorArrastre && !this.state.marcadorArrastre.iniciado) {
        const rect = canvas.getBoundingClientRect();
        const screenX = event.clientX - rect.left;
        const screenY = event.clientY - rect.top;
        
        const distancia = Math.sqrt(
          Math.pow(screenX - this.state.marcadorArrastre.inicioX, 2) +
          Math.pow(screenY - this.state.marcadorArrastre.inicioY, 2)
        );
        
        // Si se movi ms de 5px, activar modo arrastre
        if (distancia > 5) {
          this.state.marcadorArrastre.iniciado = true;
          canvas.style.cursor = 'grabbing';
        }
      }
      
      //  ARRASTRE DE MARCADOR: Mover marcador
      if (this.state.marcadorArrastre && this.state.marcadorArrastre.iniciado) {
        const rect = canvas.getBoundingClientRect();
        const screenX = event.clientX - rect.left;
        const screenY = event.clientY - rect.top;
        const mapX = (screenX - this.state.offsetX) / this.state.scale;
        const mapY = (screenY - this.state.offsetY) / this.state.scale;
        
        // Actualizar posicin temporal para dibujo
        this.state.marcadorArrastre.mapX = mapX;
        this.state.marcadorArrastre.mapY = mapY;
        
        // Si es edicin de pin, actualizar tambin ubicacionesResaltadas
        if (this.state.marcadorArrastre.esEdicionPin) {
          this.state.ubicacionesResaltadas = [{
            x: mapX,
            y: mapY,
            repuesto: 'Nueva posicin',
            descripcion: 'Suelta aqu para guardar'
          }];
        }
        
        requestAnimationFrame(() => this.draw());
        return;
      }
      
      //  ETAPA 3.2: Modo reshape
      if (this.state.isReshapeMode && this.state.reshapeAreaId) {
        this.handleReshapeMouseMove(event);
      }
      else if (this.state.isDraggingPoint) {
        // Arrastrando un punto en modo edicin
        this.handleEditPointDrag(event);
      } else if (this.state.editingAreaId) {
        // Hover sobre puntos en modo edicin
        this.updateEditPointHover(event);
      } else if (this.state.drawing) {
        this.updatePreviewPoint(event);
      } else if (this.state.isPanning) {
        this.pan(event);
      } else {
        //  Cambiar cursor y mostrar tarjeta hover si est sobre un marcador
        const rect = canvas.getBoundingClientRect();
        const screenX = event.clientX - rect.left;
        const screenY = event.clientY - rect.top;
        const mapX = (screenX - this.state.offsetX) / this.state.scale;
        const mapY = (screenY - this.state.offsetY) / this.state.scale;
        
        const marcadorHover = this.detectarClickEnMarcador(mapX, mapY);
        if (marcadorHover) {
          canvas.style.cursor = this.state.isReshapeMode ? 'grab' : 'pointer';
          
          //  Mostrar tarjeta hover simplificada
          this.mostrarTarjetaHoverRepuesto(marcadorHover, screenX, screenY);
        } else {
          canvas.style.cursor = 'default';
          
          // Ocultar tarjeta hover
          this.ocultarTarjetaHoverRepuesto();
        }
        
        //  NUEVO: Mostrar tooltip al pasar sobre reas
        this.updateTooltip(event);
      }
    });

    ['mouseup', 'mouseleave'].forEach(type => {
      canvas.addEventListener(type, (event) => {
        //  ARRASTRE DE MARCADOR: Finalizar arrastre o mostrar men
        if (this.state.marcadorArrastre) {
          if (this.state.marcadorArrastre.iniciado) {
            // Se arrastr el marcador
            const rect = canvas.getBoundingClientRect();
            const screenX = event.clientX - rect.left;
            const screenY = event.clientY - rect.top;
            const mapX = (screenX - this.state.offsetX) / this.state.scale;
            const mapY = (screenY - this.state.offsetY) / this.state.scale;
            
            // Si es edicin de pin, NO guardar automticamente
            if (this.state.marcadorArrastre.esEdicionPin) {
              console.log(' Pin soltado en modo edicin');
              // Solo actualizar la posicin visual, el usuario debe hacer click en "Guardar"
              canvas.style.cursor = 'grab';
            } else {
              // Arrastre normal, guardar automticamente
              this.guardarNuevaPosicionMarcador(
                this.state.marcadorArrastre.info,
                mapX,
                mapY
              );
              canvas.style.cursor = 'default';
            }
          } else {
            // Click corto - distinguir entre modo edicin y modo normal
            if (this.state.marcadorArrastre.modoEdicion) {
              // En modo edicin, NO mostrar men (solo arrastre o nada)
              console.log(' Click corto en modo edicin - no hacer nada');
            } else if (!this.state.marcadorArrastre.esEdicionPin) {
              // Modo normal: mostrar men contextual
              const tiempoClick = Date.now() - this.state.marcadorArrastre.tiempoInicio;
              
              if (tiempoClick < 300) {
                // Click rpido = men contextual
                this.mostrarMenuMarcador(
                  this.state.marcadorArrastre.info,
                  this.state.marcadorArrastre.inicioX,
                  this.state.marcadorArrastre.inicioY
                );
              }
            }
          }
          
          this.state.marcadorArrastre = null;
          return;
        }
        
        //  ETAPA 3.2: Soltar punto en reshape
        if (this.state.isReshapeMode && this.state.isDraggingPoint) {
          this.state.isDraggingPoint = false;
          this.draw();
        }
        else if (this.state.isDraggingPoint) {
          this.handleEditPointMouseUp();
        }
        this.endPan();
      });
    });

    // Event listener pasivo para wheel - mejora rendimiento
    canvas.addEventListener('wheel', (event) => this.handleWheel(event), { passive: false });

    canvas.addEventListener('dblclick', (event) => {
      if (this.state.editingAreaId) {
        event.preventDefault();
        // No hacer nada, los botones de guardar/cancelar estn en pantalla
        return;
      } else if (this.state.drawing) {
        event.preventDefault();
        this.finishDrawing();
      } else {
        //  Doble click afuera: Limpiar filtro de repuesto
        if (this.state.repuestoFiltrado || this.state.ubicacionesResaltadas.length > 0) {
          this.state.repuestoFiltrado = null;
          this.state.ubicacionesResaltadas = [];
          this.showToast(' Filtro limpiado - Mostrando todos los repuestos', 'success', 2000);
          this.draw();
        }
      }
    });

    canvas.addEventListener('contextmenu', (event) => {
      if (this.state.editingAreaId) {
        event.preventDefault();
        // No cancelar con click derecho, solo los botones en pantalla
        return;
      } else if (this.state.drawing) {
        event.preventDefault();
        this.finishDrawing();
      }
    });

    //  ETAPA 3.1: Atajos de teclado para seleccin mltiple
    document.addEventListener('keydown', (event) => {
      // Solo si el mapa est visible y activo
      if (!this.state.currentMap) return;
      
      //  ETAPA 3.2: Atajos de reshape
      if (this.state.isReshapeMode && this.state.reshapeAreaId) {
        // Delete: Eliminar punto seleccionado
        if (event.key === 'Delete' && this.state.selectedPointIndex !== null) {
          event.preventDefault();
          this.deleteSelectedPoint();
          return;
        }
        
        // Enter: Guardar cambios
        if (event.key === 'Enter') {
          event.preventDefault();
          this.saveReshapeChanges();
          return;
        }
        
        // Escape: Cancelar edicin
        if (event.key === 'Escape') {
          event.preventDefault();
          this.cancelReshape();
          return;
        }
      }
      
      // Ctrl+A: Seleccionar todas las reas
      if (event.ctrlKey && event.key === 'a' && this.state.isMultiSelectMode) {
        event.preventDefault();
        this.selectAllAreas();
      }
      
      // Escape: Deseleccionar todas
      if (event.key === 'Escape' && this.state.selectedAreaIds.length > 0) {
        event.preventDefault();
        this.deselectAllAreas();
      }
      
      // Delete: Eliminar reas seleccionadas
      if (event.key === 'Delete' && this.state.selectedAreaIds.length > 0 && this.state.isMultiSelectMode) {
        event.preventDefault();
        this.batchDeleteAreas();
      }
      
      // Ctrl+B: Abrir operaciones en lote
      if (event.ctrlKey && event.key === 'b' && this.state.selectedAreaIds.length > 0) {
        event.preventDefault();
        this.openBatchOperationsModal();
      }
    });
  },

  beginPan(event) {
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    this.state.isPanning = true;
    this.state.panStartX = canvasX - this.state.offsetX;
    this.state.panStartY = canvasY - this.state.offsetY;
    this.elements.canvas.style.cursor = 'grabbing';
  },

  pan(event) {
    if (!this.state.isPanning) return;
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    this.state.offsetX = canvasX - this.state.panStartX;
    this.state.offsetY = canvasY - this.state.panStartY;
    this.scheduleRender();
    this.viewportChangedDuringPan = true;
  },

  endPan() {
    if (this.state.isPanning) {
      this.state.isPanning = false;
      this.elements.canvas.style.cursor = this.state.drawing ? 'crosshair' : 'grab';
      if (this.viewportChangedDuringPan) {
        this.viewportChangedDuringPan = false;
        this.queueViewportPersist('pan');
      }
    }
  },

  handleWheel(event) {
    if (!this.state.currentImage) return;
    event.preventDefault();
    const delta = event.deltaY > 0 ? 0.85 : 1.15;
    const coords = this.getCanvasCoordinates(event);
    this.zoomAt(coords.canvasX, coords.canvasY, delta);
  },

  handleEditPointMouseDown(event) {
    if (!this.state.editingAreaId || !this.state.editingPoints.length) return;
    
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const threshold = 50; // Threshold ENORME: 50px (era 35px)
    
    // Buscar el punto ms cercano
    let closestIndex = -1;
    let closestDist = Infinity;
    
    this.state.editingPoints.forEach((point, index) => {
      // Convertir punto de imagen a pantalla
      const screenX = point.x * this.state.scale + this.state.offsetX;
      const screenY = point.y * this.state.scale + this.state.offsetY;
      
      const dx = screenX - canvasX;
      const dy = screenY - canvasY;
      const dist = Math.sqrt(dx * dx + dy * dy);
      
      if (dist < threshold && dist < closestDist) {
        closestDist = dist;
        closestIndex = index;
      }
    });
    
    if (closestIndex !== -1) {
      this.state.selectedPointIndex = closestIndex;
      this.state.isDraggingPoint = true;
      this.elements.canvas.style.cursor = 'grabbing';
      this.draw(); // Redibujar para mostrar punto seleccionado
      console.log(' Punto', closestIndex + 1, 'seleccionado, distancia:', closestDist.toFixed(1), 'px');
    }
  },

  handleEditPointDrag(event) {
    if (!this.state.isDraggingPoint || this.state.selectedPointIndex === null) return;
    
    const { mapX, mapY } = this.getMapPoint(event);
    if (!Number.isFinite(mapX) || !Number.isFinite(mapY)) return;
    
    // Actualizar posicin del punto seleccionado
    this.state.editingPoints[this.state.selectedPointIndex] = { x: mapX, y: mapY };
    this.scheduleRender();
  },

  handleEditPointMouseUp() {
    if (this.state.isDraggingPoint) {
      this.state.isDraggingPoint = false;
      // NO limpiar selectedPointIndex para mantener el punto resaltado
      console.log(' Punto', (this.state.selectedPointIndex + 1), 'soltado, listo para mover otro');
      this.elements.canvas.style.cursor = 'grab';
      this.scheduleRender(); // Redibujar
    }
  },

  updateEditPointHover(event) {
    if (!this.state.editingAreaId || !this.state.editingPoints.length || this.state.isDraggingPoint) return;
    
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const threshold = 50; // 50px en pantalla
    
    // Ver si el cursor est cerca de algn punto (en coordenadas de pantalla)
    let nearPoint = false;
    for (const point of this.state.editingPoints) {
      const screenX = point.x * this.state.scale + this.state.offsetX;
      const screenY = point.y * this.state.scale + this.state.offsetY;
      
      const dx = screenX - canvasX;
      const dy = screenY - canvasY;
      const dist = Math.sqrt(dx * dx + dy * dy);
      
      if (dist < threshold) {
        nearPoint = true;
        break;
      }
    }
    
    this.elements.canvas.style.cursor = nearPoint ? 'grab' : 'default';
  },

  //  NUEVO: Mostrar tooltip al pasar sobre el NOMBRE del rea (no el rea completa)
  updateTooltip(event) {
    const tooltip = this.elements.tooltip;
    if (!tooltip || !this.state.currentImage || this.state.drawing || this.state.editingAreaId) {
      if (tooltip && !this.state.tooltipPinned) {
        tooltip.classList.add('hidden');
      }
      return;
    }

    // Si el tooltip est "fijado" (pinned), mantenerlo con el rea fijada
    if (this.state.tooltipPinned && this.state.pinnedAreaId) {
      const pinnedArea = this.state.areas.find(a => a.id === this.state.pinnedAreaId);
      if (pinnedArea) {
        this.renderTooltipContent(pinnedArea, event);
        return;
      } else {
        // Si el rea ya no existe, desfijar
        this.state.tooltipPinned = false;
        this.state.pinnedAreaId = null;
        this.state.highlightAreaId = null; //  Quitar resaltado
        this.scheduleRender(); //  Redibujar
      }
    }

    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    
    // Convertir coordenadas de canvas a coordenadas del mundo (imagen)
    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;

    // Buscar rea cuyo NOMBRE est bajo el cursor
    let hoveredArea = null;
    
    if (this.state.mostrarNombresAreas) {
      for (const area of this.state.areas) {
        if (!Array.isArray(area.points) || area.points.length < 3) continue;
        
        // Calcular centroide y posicin del label
        const centroid = this.calculateCentroid(area.points);
        if (!centroid) continue;
        
        const labelOffsetX = area.labelOffsetX || 0;
        const labelOffsetY = area.labelOffsetY || 0;
        const labelX = centroid.x + labelOffsetX;
        const labelY = centroid.y + labelOffsetY;
        
        // Calcular dimensiones del rectngulo del texto
        const text = area.name || 'rea';
        const maxCharsPerLine = 20;
        const lines = [];
        
        if (text.length <= maxCharsPerLine) {
          lines.push(text);
        } else {
          const words = text.split(' ');
          let currentLine = '';
          words.forEach((word, idx) => {
            const testLine = currentLine ? `${currentLine} ${word}` : word;
            if (testLine.length <= maxCharsPerLine) {
              currentLine = testLine;
            } else {
              if (currentLine) lines.push(currentLine);
              currentLine = word;
            }
            if (idx === words.length - 1 && currentLine) {
              lines.push(currentLine);
            }
          });
        }
        
        // Estimar dimensiones (aproximado, sin usar ctx.measureText)
        const baseFontSize = 28;
        const minFontSize = 14;
        const zoomFactor = this.state.zoom || 1.0;
        const fontSize = Math.max(minFontSize, baseFontSize / Math.sqrt(zoomFactor));
        
        // Aproximar ancho: cada carcter ~0.6 del fontSize
        const maxLineLength = Math.max(...lines.map(l => l.length));
        const textWidth = maxLineLength * fontSize * 0.6;
        const lineHeight = fontSize * 1.2;
        const textHeight = lineHeight * lines.length;
        
        const paddingX = Math.max(6, 12 / Math.sqrt(zoomFactor));
        const paddingY = Math.max(4, 8 / Math.sqrt(zoomFactor));
        
        const rectWidth = textWidth + paddingX * 2;
        const rectHeight = textHeight + paddingY * 2;
        const rectX = labelX - rectWidth / 2;
        const rectY = labelY - rectHeight / 2;
        
        // Verificar si el cursor est dentro del rectngulo del nombre
        if (worldX >= rectX && worldX <= rectX + rectWidth &&
            worldY >= rectY && worldY <= rectY + rectHeight) {
          hoveredArea = area;
          break;
        }
      }
    }

    if (hoveredArea) {
      this.renderTooltipContent(hoveredArea, event);
    } else {
      tooltip.classList.add('hidden');
    }
  },

  //  Renderizar contenido del tooltip para un rea
  renderTooltipContent(area, event) {
    const tooltip = this.elements.tooltip;
    if (!tooltip) return;
    
    // Obtener categora
    const category = this.categories[area.category] || this.categories.area;
    
    // Construir contenido del tooltip
    let tooltipHTML = `
      <div class="map-tooltip-title">
        <span>${category.icon}</span>
        <span>${area.name || 'Sin nombre'}</span>
      </div>
      <div class="map-tooltip-category">${category.name}</div>
    `;
    
    // Agregar equipos si existen
    if (Array.isArray(area.equipos) && area.equipos.length > 0) {
      const equiposPreview = area.equipos.slice(0, 3).join(', ');
      const moreText = area.equipos.length > 3 ? ` (+${area.equipos.length - 3} mas)` : '';
      tooltipHTML += `
        <div class="map-tooltip-equipos">
          <strong>Equipos:</strong>
          ${equiposPreview}${moreText}
        </div>
      `;
    }
    
    // Indicar si est fijado
    const pinnedIndicator = this.state.tooltipPinned && this.state.pinnedAreaId === area.id
      ? '<div style="font-size: 0.7rem; color: #fbbf24; margin-top: 4px;"> Fijado (click para desfijar)</div>'
      : '<div style="font-size: 0.7rem; color: #888; margin-top: 4px;">Click en el nombre para fijar</div>';
    
    // Agregar botones de accion
    tooltipHTML += `
      ${pinnedIndicator}
      <div style="display: flex; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
        <button onclick="mapController.startEditAreaPoints('${area.id}');" style="flex: 1; padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); cursor: pointer; font-size: 0.75rem;">
          E Forma
        </button>
        <button onclick="mapController.openEditAreaMetadataModal('${area.id}');" style="flex: 1; padding: 4px 8px; background: var(--primary); border: none; border-radius: 3px; color: white; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
          C Datos
        </button>
        <button onclick="mapController.deleteArea('${area.id}');" style="padding: 4px 8px; background: #dc2626; border: none; border-radius: 3px; color: white; cursor: pointer; font-size: 0.75rem;">
          X
        </button>
      </div>
    `;
    
    tooltip.innerHTML = tooltipHTML;
    
    //  Agregar/quitar clase 'pinned' segn estado
    if (this.state.tooltipPinned && this.state.pinnedAreaId === area.id) {
      tooltip.classList.add('pinned');
    } else {
      tooltip.classList.remove('pinned');
    }
    
    // Posicionar tooltip cerca del cursor (solo si no est fijado)
    if (!this.state.tooltipPinned) {
      const rect = this.elements.canvasStage.getBoundingClientRect();
      let tooltipX = event.clientX - rect.left + 15;
      let tooltipY = event.clientY - rect.top + 15;
      
      // Ajustar si se sale del canvas
      const tooltipRect = tooltip.getBoundingClientRect();
      if (tooltipX + tooltipRect.width > rect.width) {
        tooltipX = event.clientX - rect.left - tooltipRect.width - 15;
      }
      if (tooltipY + tooltipRect.height > rect.height) {
        tooltipY = event.clientY - rect.top - tooltipRect.height - 15;
      }
      
      tooltip.style.left = `${tooltipX}px`;
      tooltip.style.top = `${tooltipY}px`;
    }
    
    tooltip.classList.remove('hidden');
  },

  // Funcin helper para detectar si un punto est dentro de un polgono
  isPointInPolygon(point, polygon) {
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const xi = polygon[i].x, yi = polygon[i].y;
      const xj = polygon[j].x, yj = polygon[j].y;
      
      const intersect = ((yi > point.y) !== (yj > point.y))
        && (point.x < (xj - xi) * (point.y - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  },

  zoomAt(canvasX, canvasY, factor) {
    const newScale = Math.max(this.state.minScale, Math.min(this.state.maxScale, this.state.scale * factor));
    if (newScale === this.state.scale) return;

    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;

    this.state.scale = newScale;
    this.state.offsetX = canvasX - worldX * newScale;
    this.state.offsetY = canvasY - worldY * newScale;
    this.updateZoomBadge(); //  Actualizar badge de zoom
    this.draw();
    this.queueViewportPersist('zoom');
  },

  handleToolbarAction(action) {
    switch (action) {
      case 'zoom-in':
        this.zoomCentered(1.2);
        break;
      case 'zoom-out':
        this.zoomCentered(1 / 1.2);
        break;
      case 'reset-view':
        this.resetView();
        break;
      case 'toggle-nombres-areas':
        this.toggleNombresAreas();
        break;
      case 'toggle-puntos-repuestos':
        this.togglePuntosRepuestos();
        break;
      case 'toggle-grid':
        this.toggleGrid();
        break;
      case 'toggle-minimap':
        this.toggleMinimap();
        break;
      case 'toggle-rulers':
        this.toggleRulers();
        break;
      case 'toggle-multiselect':
        this.toggleMultiSelect();
        break;
      case 'toggle-reshape':
        this.toggleReshape();
        break;
      case 'recenter':
        this.recenter();
        break;
      default:
        console.debug('Accin de toolbar no implementada:', action);
    }
  },

  zoomCentered(factor) {
    if (!this.state.currentImage) return;
    const canvas = this.elements.canvas;
    const canvasX = canvas.width / 2;
    const canvasY = canvas.height / 2;
    this.zoomAt(canvasX, canvasY, factor);
  },

  resetView() {
    this.state.scale = 1;
    this.state.offsetX = 0;
    this.state.offsetY = 0;
    this.updateZoomBadge(); //  Actualizar badge de zoom
    this.draw();
    this.queueViewportPersist('reset-view');
  },

  recenter() {
    if (!this.state.currentImage) return;
    const canvas = this.elements.canvas;
    const centerX = (this.state.currentImage.width / 2) * this.state.scale;
    const centerY = (this.state.currentImage.height / 2) * this.state.scale;
    this.state.offsetX = canvas.width / 2 - centerX;
    this.state.offsetY = canvas.height / 2 - centerY;
    this.draw();
    this.queueViewportPersist('recenter');
  },

  toggleGrid() {
    this.state.showGrid = !this.state.showGrid;
    this.draw();
    this.showToast(this.state.showGrid ? 'Rejilla activada.' : 'Rejilla desactivada.', 'info');
  },

  toggleNombresAreas() {
    this.state.mostrarNombresAreas = !this.state.mostrarNombresAreas;
    this.draw();
    const btn = document.querySelector('[data-action="toggle-nombres-areas"]');
    if (btn) {
      btn.style.background = this.state.mostrarNombresAreas ? '#3b82f6' : '';
      btn.style.color = this.state.mostrarNombresAreas ? 'white' : '';
    }
    this.showToast(this.state.mostrarNombresAreas ? ' Nombres de reas visibles' : ' Nombres de reas ocultos', 'info');
  },

  togglePuntosRepuestos() {
    this.state.mostrarPuntosRepuestos = !this.state.mostrarPuntosRepuestos;
    this.draw();
    const btn = document.querySelector('[data-action="toggle-puntos-repuestos"]');
    if (btn) {
      //  MEJORA VISUAL: Estilos ms claros para ON/OFF
      if (this.state.mostrarPuntosRepuestos) {
        // Estado ON: Fondo azul brillante
        btn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
        btn.style.color = 'white';
        btn.style.fontWeight = 'bold';
        btn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
        btn.style.transform = 'scale(1.0)';
      } else {
        // Estado OFF: Gris oscuro con borde
        btn.style.background = 'linear-gradient(135deg, #4b5563 0%, #374151 100%)';
        btn.style.color = '#d1d5db';
        btn.style.fontWeight = 'normal';
        btn.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3), inset 0 0 0 2px rgba(239, 68, 68, 0.5)';
        btn.style.transform = 'scale(0.95)';
      }
      btn.style.transition = 'all 0.3s ease';
    }
    this.showToast(
      this.state.mostrarPuntosRepuestos 
        ? ' Todos los puntos visibles' 
        : ' Solo marcador seleccionado', 
      'info'
    );
  },

  //  NUEVA FUNCIN: Sincronizar estado visual de botones con el estado interno
  syncButtonStates() {
    // Botn de puntos
    const btnPuntos = document.querySelector('[data-action="toggle-puntos-repuestos"]');
    if (btnPuntos) {
      if (this.state.mostrarPuntosRepuestos) {
        // Estado ON: Fondo azul brillante
        btnPuntos.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
        btnPuntos.style.color = 'white';
        btnPuntos.style.fontWeight = 'bold';
        btnPuntos.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
        btnPuntos.style.transform = 'scale(1.0)';
      } else {
        // Estado OFF: Gris oscuro con borde rojo
        btnPuntos.style.background = 'linear-gradient(135deg, #4b5563 0%, #374151 100%)';
        btnPuntos.style.color = '#d1d5db';
        btnPuntos.style.fontWeight = 'normal';
        btnPuntos.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3), inset 0 0 0 2px rgba(239, 68, 68, 0.5)';
        btnPuntos.style.transform = 'scale(0.95)';
      }
      btnPuntos.style.transition = 'all 0.3s ease';
    }
    
    // Botn de nombres de reas
    const btnNombres = document.querySelector('[data-action="toggle-nombres-areas"]');
    if (btnNombres) {
      btnNombres.style.background = this.state.mostrarNombresAreas ? '#3b82f6' : '';
      btnNombres.style.color = this.state.mostrarNombresAreas ? 'white' : '';
    }
  },

  toggleMinimap() {
    this.state.showMinimap = !this.state.showMinimap;
    if (this.elements.minimapContainer) {
      if (this.state.showMinimap) {
        this.elements.minimapContainer.classList.remove('hidden');
        this.drawMinimap();
      } else {
        this.elements.minimapContainer.classList.add('hidden');
      }
    }
    this.showToast(this.state.showMinimap ? 'Minimap activado.' : 'Minimap desactivado.', 'info');
  },

  handleMinimapClick(event) {
    if (!this.state.currentImage || !this.elements.minimap) return;

    const minimap = this.elements.minimap;
    const rect = minimap.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const clickY = event.clientY - rect.top;

    // Calcular escala del minimap (igual que en drawMinimap)
    const imgWidth = this.state.currentImage.width;
    const imgHeight = this.state.currentImage.height;
    const scaleX = minimap.width / imgWidth;
    const scaleY = minimap.height / imgHeight;
    const minimapScale = Math.min(scaleX, scaleY) * 0.95;

    const drawWidth = imgWidth * minimapScale;
    const drawHeight = imgHeight * minimapScale;
    const offsetX = (minimap.width - drawWidth) / 2;
    const offsetY = (minimap.height - drawHeight) / 2;

    // Convertir coordenadas de clic a coordenadas del mundo
    const worldX = (clickX - offsetX) / minimapScale;
    const worldY = (clickY - offsetY) / minimapScale;

    // Centrar el viewport en el punto clicado
    const mainCanvas = this.elements.canvas;
    this.state.offsetX = -worldX * this.state.scale + mainCanvas.width / 2;
    this.state.offsetY = -worldY * this.state.scale + mainCanvas.height / 2;

    this.draw();
    this.queueViewportPersist('minimap');
  },

  toggleRulers() {
    this.state.showRulers = !this.state.showRulers;
    this.draw();
    this.showToast(this.state.showRulers ? 'Reglas activadas.' : 'Reglas desactivadas.', 'info');
  },

  //  ETAPA 3.1: Toggle modo seleccin mltiple
  toggleMultiSelect() {
    this.state.isMultiSelectMode = !this.state.isMultiSelectMode;
    
    const btn = document.getElementById('mapMultiSelectBtn');
    if (this.state.isMultiSelectMode) {
      btn.classList.add('map-btn--primary');
      btn.textContent = ' Modo Activo';
      this.showHint('Modo seleccin mltiple: Click en reas para seleccionar/deseleccionar. Ctrl+A para seleccionar todas.');
    } else {
      btn.classList.remove('map-btn--primary');
      btn.textContent = ' Seleccin Mltiple';
      this.state.selectedAreaIds = []; // Limpiar seleccin
      this.updateSelectionBadge();
      this.hideHint();
    }
    
    this.draw();
    this.showToast(this.state.isMultiSelectMode ? ' Modo seleccin mltiple activado' : ' Modo seleccin mltiple desactivado', 'info');
  },

  //  ETAPA 3.1: Actualizar badge de seleccin
  updateSelectionBadge() {
    const badge = document.getElementById('mapSelectionBadge');
    if (!badge) return;
    
    if (this.state.selectedAreaIds.length > 0) {
      badge.textContent = `${this.state.selectedAreaIds.length} seleccionada${this.state.selectedAreaIds.length !== 1 ? 's' : ''}`;
      badge.style.display = 'block';
    } else {
      badge.style.display = 'none';
    }
  },

  //  ETAPA 3.1: Seleccionar/deseleccionar rea
  toggleAreaSelection(areaId) {
    const index = this.state.selectedAreaIds.indexOf(areaId);
    if (index > -1) {
      this.state.selectedAreaIds.splice(index, 1); // Deseleccionar
    } else {
      this.state.selectedAreaIds.push(areaId); // Seleccionar
    }
    this.updateSelectionBadge();
    this.draw();
    console.log(` reas seleccionadas: ${this.state.selectedAreaIds.length}`);
  },

  //  ETAPA 3.1: Seleccionar todas las reas
  selectAllAreas() {
    this.state.selectedAreaIds = this.state.areas.map(area => area.id);
    this.updateSelectionBadge();
    this.draw();
    this.showToast(` ${this.state.selectedAreaIds.length} reas seleccionadas`, 'success');
  },

  //  ETAPA 3.1: Deseleccionar todas las reas
  deselectAllAreas() {
    this.state.selectedAreaIds = [];
    this.updateSelectionBadge();
    this.draw();
    this.showToast(' Seleccin limpiada', 'info');
  },

  //  ETAPA 3.1: Abrir modal de operaciones en lote
  openBatchOperationsModal() {
    if (this.state.selectedAreaIds.length === 0) {
      this.showToast(' No hay reas seleccionadas', 'warning');
      return;
    }

    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) return;

    this.elements.modalTitle.textContent = `Operaciones en lote (${this.state.selectedAreaIds.length} reas)`;

    // Generar opciones de categoras
    const categoryOptions = Object.entries(this.categories).map(([key, cat]) => 
      `<option value="${key}">${cat.icon} ${cat.name}</option>`
    ).join('');

    body.innerHTML = `
      <form id="batchOperationsForm" class="map-area-form">
        <p style="color: var(--text-secondary); margin-bottom: 16px;">
          Aplicar cambios a <strong>${this.state.selectedAreaIds.length}</strong> rea(s) seleccionada(s):
        </p>

        <div class="form-group">
          <label>Cambiar categora</label>
          <select name="batchCategory" id="batchCategory">
            <option value="">No cambiar</option>
            ${categoryOptions}
          </select>
        </div>

        <div class="form-group">
          <label>Cambiar color</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="checkbox" id="batchColorEnable" style="width: auto;">
            <input type="color" name="batchColor" id="batchColor" value="#3b82f6" disabled />
            <span id="batchColorHex" style="font-family: monospace; color: var(--text-secondary);">#3b82f6</span>
          </div>
        </div>

        <div class="form-group">
          <label>Cambiar opacidad</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="checkbox" id="batchOpacityEnable" style="width: auto;">
            <input type="range" name="batchOpacity" id="batchOpacity" min="10" max="90" value="35" disabled />
            <span id="batchOpacityValue" style="min-width: 40px; color: var(--text-secondary);">35%</span>
          </div>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">

        <div class="form-actions">
          <button type="button" class="map-btn map-btn--danger" onclick="mapController.batchDeleteAreas()">
             Eliminar todas
          </button>
          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>
          <button type="submit" class="map-btn map-btn--primary">Aplicar cambios</button>
        </div>
      </form>
    `;

    modal.classList.remove('hidden');

    // Event listeners para habilitar/deshabilitar inputs
    const colorCheckbox = document.getElementById('batchColorEnable');
    const colorInput = document.getElementById('batchColor');
    const colorHex = document.getElementById('batchColorHex');
    
    colorCheckbox.addEventListener('change', () => {
      colorInput.disabled = !colorCheckbox.checked;
    });
    
    colorInput.addEventListener('input', () => {
      colorHex.textContent = colorInput.value;
    });

    const opacityCheckbox = document.getElementById('batchOpacityEnable');
    const opacityInput = document.getElementById('batchOpacity');
    const opacityValue = document.getElementById('batchOpacityValue');
    
    opacityCheckbox.addEventListener('change', () => {
      opacityInput.disabled = !opacityCheckbox.checked;
    });
    
    opacityInput.addEventListener('input', () => {
      opacityValue.textContent = `${opacityInput.value}%`;
    });

    const cancelBtn = body.querySelector('[data-action="cancel"]');
    if (cancelBtn) cancelBtn.addEventListener('click', () => this.closeModal());

    const form = body.querySelector('#batchOperationsForm');
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        this.applyBatchOperations(new FormData(form));
      });
    }
  },

  //  ETAPA 3.1: Aplicar operaciones en lote
  applyBatchOperations(formData) {
    const category = formData.get('batchCategory');
    const colorEnable = document.getElementById('batchColorEnable').checked;
    const color = formData.get('batchColor');
    const opacityEnable = document.getElementById('batchOpacityEnable').checked;
    const opacity = parseInt(formData.get('batchOpacity')) / 100;

    let changesCount = 0;

    this.state.areas.forEach(area => {
      if (this.state.selectedAreaIds.includes(area.id)) {
        if (category) {
          area.category = category;
          changesCount++;
        }
        if (colorEnable) {
          area.color = color;
          changesCount++;
        }
        if (opacityEnable) {
          area.opacity = opacity;
          changesCount++;
        }
      }
    });

    this.saveAreas();
    this.draw();
    this.renderAreasList();
    this.closeModal();
    this.showToast(` Cambios aplicados a ${this.state.selectedAreaIds.length} rea(s)`, 'success');
  },

  //  ETAPA 3.1: Eliminar reas seleccionadas en lote
  batchDeleteAreas() {
    if (!confirm(`Eliminar ${this.state.selectedAreaIds.length} rea(s) seleccionada(s)?\n\nEsta accin no se puede deshacer.`)) {
      return;
    }

    this.state.areas = this.state.areas.filter(area => !this.state.selectedAreaIds.includes(area.id));
    this.state.selectedAreaIds = [];
    
    this.updateSelectionBadge();
    this.saveAreas();
    this.draw();
    this.renderAreasList();
    this.closeModal();
    this.showToast(' reas eliminadas correctamente', 'success');
  },

  //  ETAPA 3.1: Manejar click en modo seleccin mltiple
  handleMultiSelectClick(event) {
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;

    // Buscar rea en el punto clicado
    const clickedArea = this.findAreaAtPoint(worldX, worldY);
    
    if (clickedArea) {
      this.toggleAreaSelection(clickedArea.id);
    }
    
    // Prevenir panning
    event.stopPropagation();
  },

  //  ETAPA 3.1: Encontrar rea en un punto
  findAreaAtPoint(worldX, worldY) {
    // Buscar en orden inverso (las ms recientes primero)
    for (let i = this.state.areas.length - 1; i >= 0; i--) {
      const area = this.state.areas[i];
      if (this.isPointInPolygon({ x: worldX, y: worldY }, area.points)) {
        return area;
      }
    }
    return null;
  },

  //  ETAPA 3.2: Toggle modo reshape (edicin de puntos)
  toggleReshape() {
    this.state.isReshapeMode = !this.state.isReshapeMode;
    
    const btn = document.getElementById('mapReshapeBtn');
    if (this.state.isReshapeMode) {
      // Desactivar otros modos
      if (this.state.isMultiSelectMode) {
        this.toggleMultiSelect();
      }
      if (this.state.drawing) {
        this.cancelDrawing();
      }
      
      btn.classList.add('map-btn--primary');
      btn.innerHTML = ' Modo Activo <span class="info-icon"></span>';
      this.showHint('Modo Edicin: Click en un rea para editar puntos. Arrastra repuestos para reubicarlos. Click en bordes para agregar puntos, selecciona punto + Delete para eliminar.');
    } else {
      btn.classList.remove('map-btn--primary');
      btn.innerHTML = ' Editar Ubicaciones <span class="info-icon"></span>';
      this.exitReshapeMode();
      this.hideHint();
    }
    
    this.draw();
    this.showToast(this.state.isReshapeMode ? ' Modo edicin activado - Puedes mover reas y repuestos' : ' Modo edicin desactivado', 'info');
  },

  //  ETAPA 3.2: Salir del modo reshape
  exitReshapeMode() {
    this.state.reshapeAreaId = null;
    this.state.reshapePoints = [];
    this.state.selectedPointIndex = null;
    this.state.isDraggingPoint = false;
    this.state.hoveredPointIndex = null;
    this.state.hoveredEdgeIndex = null;
  },

  //  ETAPA 3.2: Iniciar edicin de un rea
  startReshapingArea(areaId) {
    const area = this.state.areas.find(a => a.id === areaId);
    if (!area) return;
    
    this.state.reshapeAreaId = areaId;
    this.state.reshapePoints = JSON.parse(JSON.stringify(area.points)); // Copia profunda
    this.draw();
    this.showToast(` Editando rea: ${area.name}`, 'info');
  },

  //  ETAPA 3.2: Guardar cambios del reshape
  saveReshapeChanges() {
    if (!this.state.reshapeAreaId || this.state.reshapePoints.length < 3) {
      this.showToast(' El rea debe tener mnimo 3 puntos', 'warning');
      return;
    }
    
    const area = this.state.areas.find(a => a.id === this.state.reshapeAreaId);
    if (area) {
      area.points = JSON.parse(JSON.stringify(this.state.reshapePoints));
      this.saveAreas();
      this.showToast(' Cambios guardados correctamente', 'success');
    }
    
    this.exitReshapeMode();
    this.draw();
  },

  //  ETAPA 3.2: Cancelar edicin reshape
  cancelReshape() {
    this.exitReshapeMode();
    this.draw();
    this.showToast(' Edicin cancelada', 'info');
  },

  //  ETAPA 3.2: Encontrar punto bajo el cursor
  findPointAtCursor(worldX, worldY, threshold = 10) {
    if (!this.state.reshapeAreaId) return -1;
    
    const screenThreshold = threshold / this.state.scale;
    
    for (let i = 0; i < this.state.reshapePoints.length; i++) {
      const point = this.state.reshapePoints[i];
      const dx = point.x - worldX;
      const dy = point.y - worldY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance < screenThreshold) {
        return i;
      }
    }
    
    return -1;
  },

  //  ETAPA 3.2: Encontrar borde bajo el cursor (para agregar punto)
  findEdgeAtCursor(worldX, worldY, threshold = 15) {
    if (!this.state.reshapeAreaId) return -1;
    
    const screenThreshold = threshold / this.state.scale;
    const points = this.state.reshapePoints;
    
    for (let i = 0; i < points.length; i++) {
      const p1 = points[i];
      const p2 = points[(i + 1) % points.length];
      
      const distance = this.pointToLineDistance(worldX, worldY, p1.x, p1.y, p2.x, p2.y);
      
      if (distance < screenThreshold) {
        return i; // Retorna el ndice del primer punto del borde
      }
    }
    
    return -1;
  },

  //  ETAPA 3.2: Calcular distancia de punto a lnea
  pointToLineDistance(px, py, x1, y1, x2, y2) {
    const A = px - x1;
    const B = py - y1;
    const C = x2 - x1;
    const D = y2 - y1;
    
    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    let param = -1;
    
    if (lenSq !== 0) {
      param = dot / lenSq;
    }
    
    let xx, yy;
    
    if (param < 0) {
      xx = x1;
      yy = y1;
    } else if (param > 1) {
      xx = x2;
      yy = y2;
    } else {
      xx = x1 + param * C;
      yy = y1 + param * D;
    }
    
    const dx = px - xx;
    const dy = py - yy;
    return Math.sqrt(dx * dx + dy * dy);
  },

  //  ETAPA 3.2: Agregar punto en borde
  addPointToEdge(edgeIndex, worldX, worldY) {
    // Insertar el nuevo punto despus del punto en edgeIndex
    this.state.reshapePoints.splice(edgeIndex + 1, 0, { x: worldX, y: worldY });
    this.draw();
    this.showToast(' Punto agregado', 'success');
  },

  //  ETAPA 3.2: Eliminar punto seleccionado
  deleteSelectedPoint() {
    if (this.state.selectedPointIndex === null) return;
    
    if (this.state.reshapePoints.length <= 3) {
      this.showToast(' El rea debe tener mnimo 3 puntos', 'warning');
      return;
    }
    
    this.state.reshapePoints.splice(this.state.selectedPointIndex, 1);
    this.state.selectedPointIndex = null;
    this.draw();
    this.showToast(' Punto eliminado', 'success');
  },

  //  ETAPA 3.2: Manejar click en modo reshape
  handleReshapeClick(event) {
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;
    
    // Si no hay rea seleccionada, seleccionar una
    if (!this.state.reshapeAreaId) {
      const clickedArea = this.findAreaAtPoint(worldX, worldY);
      if (clickedArea) {
        this.startReshapingArea(clickedArea.id);
      }
      return;
    }
    
    // Verificar si se hizo click en un punto
    const pointIndex = this.findPointAtCursor(worldX, worldY);
    if (pointIndex !== -1) {
      this.state.selectedPointIndex = pointIndex;
      this.draw();
      return;
    }
    
    // Verificar si se hizo click en un borde (para agregar punto)
    const edgeIndex = this.findEdgeAtCursor(worldX, worldY);
    if (edgeIndex !== -1) {
      this.addPointToEdge(edgeIndex, worldX, worldY);
      return;
    }
    
    // Click fuera: deseleccionar punto
    this.state.selectedPointIndex = null;
    this.draw();
  },

  //  ETAPA 3.2: Manejar movimiento del mouse en reshape
  handleReshapeMouseMove(event) {
    if (!this.state.reshapeAreaId) return;
    
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;
    
    // Si est arrastrando un punto
    if (this.state.isDraggingPoint && this.state.selectedPointIndex !== null) {
      this.state.reshapePoints[this.state.selectedPointIndex] = { x: worldX, y: worldY };
      this.draw();
      return;
    }
    
    // Actualizar punto/borde bajo el cursor
    const pointIndex = this.findPointAtCursor(worldX, worldY);
    const edgeIndex = pointIndex === -1 ? this.findEdgeAtCursor(worldX, worldY) : -1;
    
    if (this.state.hoveredPointIndex !== pointIndex || this.state.hoveredEdgeIndex !== edgeIndex) {
      this.state.hoveredPointIndex = pointIndex;
      this.state.hoveredEdgeIndex = edgeIndex;
      
      // Cambiar cursor
      const canvas = this.elements.canvas;
      if (pointIndex !== -1) {
        canvas.style.cursor = 'move';
      } else if (edgeIndex !== -1) {
        canvas.style.cursor = 'copy';
      } else {
        canvas.style.cursor = 'default';
      }
      
      this.draw();
    }
  },

  getCanvasCoordinates(event) {
    const canvas = this.elements.canvas;
    const rect = canvas.getBoundingClientRect();
    const cssScaleX = canvas.width / rect.width;
    const cssScaleY = canvas.height / rect.height;
    const canvasX = (event.clientX - rect.left) * cssScaleX;
    const canvasY = (event.clientY - rect.top) * cssScaleY;
    return { canvasX, canvasY };
  },

  getMapPoint(event) {
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const mapX = (canvasX - this.state.offsetX) / this.state.scale;
    const mapY = (canvasY - this.state.offsetY) / this.state.scale;
    return { mapX, mapY, canvasX, canvasY };
  },

  addPoint(event) {
    const { mapX, mapY } = this.getMapPoint(event);
    if (!Number.isFinite(mapX) || !Number.isFinite(mapY)) return;

    if (this.state.tempPoints.length >= 3) {
      const firstPoint = this.state.tempPoints[0];
      const distance = Math.hypot(firstPoint.x - mapX, firstPoint.y - mapY);
      if (distance <= 15) {
        this.finishDrawing();
        return;
      }
    }

    this.state.tempPoints.push({ x: mapX, y: mapY });
    this.draw();
  },

  updatePreviewPoint(event) {
    const { mapX, mapY } = this.getMapPoint(event);
    this.state.previewPoint = { x: mapX, y: mapY };
    this.scheduleRender();
  },

  finishDrawing() {
    if (this.state.tempPoints.length < 3) {
      this.showToast('Necesitas al menos 3 puntos para crear un rea.', 'warning');
      return;
    }

    if (!this.guardMapContract('crear una nueva rea')) {
      return;
    }

    this.openAreaModal();
  },

  toggleDrawingMode() {
    if (this.state.drawing) {
      this.cancelDrawing();
      return;
    }

    if (!this.guardMapContract('dibujar nuevas zonas')) {
      return;
    }

    this.state.drawing = true;
    this.state.tempPoints = [];
    this.state.previewPoint = null;
    this.state.highlightAreaId = null;
    if (this.elements.drawBtn) {
      this.elements.drawBtn.textContent = 'Finalizar rea';
      this.elements.drawBtn.classList.add('map-btn--primary');
    }
    this.showHint('Modo dibujo activo: haz clic para agregar puntos. Doble clic o clic derecho para cerrar.');
    this.elements.canvas.style.cursor = 'crosshair';
  },

  cancelDrawing() {
    this.state.drawing = false;
    this.state.tempPoints = [];
    this.state.previewPoint = null;
    if (this.elements.drawBtn) {
      this.elements.drawBtn.textContent = 'Dibujar zona';
      this.elements.drawBtn.classList.remove('map-btn--primary');
    }
    this.hideHint();
    this.elements.canvas.style.cursor = 'grab';
    this.draw();
  },

  //  MODO AGREGAR MARCADOR CON BSQUEDA
  toggleModoAgregarMarcador() {
    const btn = document.getElementById('mapAddMarkerBtn');
    
    if (this.state.modoAgregarMarcadorActivo) {
      // Desactivar modo
      this.state.modoAgregarMarcadorActivo = false;
      if (btn) {
        btn.textContent = ' Agregar Marcador';
        btn.classList.remove('map-btn--danger');
        btn.classList.add('map-btn--success');
      }
      if (this.elements.canvas) {
        this.elements.canvas.style.cursor = 'grab';
      }
      this.hideHint();
      this.showToast('Modo agregar marcador desactivado', 'info');
      return;
    }

    if (!this.guardMapContract('agregar marcadores')) {
      return;
    }

    // Activar modo
    this.state.modoAgregarMarcadorActivo = true;
    if (btn) {
      btn.textContent = ' Cancelar';
      btn.classList.remove('map-btn--success');
      btn.classList.add('map-btn--danger');
    }
    if (this.elements.canvas) {
      this.elements.canvas.style.cursor = 'crosshair';
    }
    this.showHint('Modo Agregar Marcador: Haz clic dentro de un rea para colocar un marcador');
    this.showToast(' Haz clic en un rea para agregar marcador', 'success');
  },

  //  MODAL DE BSQUEDA DE REPUESTOS
  abrirModalBusquedaRepuesto(x, y, area) {
    const modalHTML = `
      <div id="modalBusquedaRepuesto" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 10000;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      ">
        <!-- Header -->
        <div style="
          padding: 16px 20px;
          border-bottom: 1px solid var(--border-color);
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: var(--bg-secondary);
        ">
          <div>
            <h3 style="margin: 0; color: var(--text-primary); font-size: 1.1rem;">
               Seleccionar Repuesto
            </h3>
            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
              rea: <strong>${area.name}</strong>
            </p>
          </div>
          <button onclick="mapController.cerrarModalBusquedaRepuesto()" style="
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px 8px;
            line-height: 1;
          "></button>
        </div>

        <!-- Buscador -->
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color);">
          <input 
            type="text" 
            id="inputBusquedaRepuesto" 
            placeholder=" Escribe para buscar repuesto..."
            style="
              width: 100%;
              padding: 12px 16px;
              border: 2px solid var(--border-color);
              border-radius: 8px;
              font-size: 1rem;
              background: var(--bg-tertiary);
              color: var(--text-primary);
              transition: border-color 0.2s;
            "
            autocomplete="off"
          />
          
          <!--  Selector de Categora -->
          <div style="margin-top: 12px;">
            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">
               Categora (opcional):
            </label>
            <select 
              id="selectCategoriaMarker" 
              style="
                width: 100%;
                padding: 10px 14px;
                border: 2px solid var(--border-color);
                border-radius: 6px;
                font-size: 0.95rem;
                background: var(--bg-tertiary);
                color: var(--text-primary);
                cursor: pointer;
              "
            >
              <option value="Sin categora">Sin categora</option>
              <option value="Componentes"> Componentes</option>
              <option value="Elctrico"> Elctrico</option>
              <option value="Mecnico"> Mecnico</option>
              <option value="Hidrulico"> Hidrulico</option>
              <option value="Neumtico"> Neumtico</option>
              <option value="Estructura"> Estructura</option>
              <option value="Seguridad"> Seguridad</option>
              <option value="Instrumentacin"> Instrumentacin</option>
              <option value="Otro"> Otro</option>
            </select>
          </div>
          
          <div id="contadorResultados" style="
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
          "></div>
        </div>

        <!-- Lista de resultados -->
        <div id="listaResultadosRepuestos" style="
          flex: 1;
          overflow-y: auto;
          padding: 8px;
        "></div>

        <!-- Footer -->
        <div style="
          padding: 12px 20px;
          border-top: 1px solid var(--border-color);
          background: var(--bg-secondary);
          display: flex;
          justify-content: flex-end;
          gap: 8px;
        ">
          <button onclick="mapController.cerrarModalBusquedaRepuesto()" style="
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.95rem;
          ">
            Cancelar
          </button>
        </div>
      </div>

      <!-- Overlay -->
      <div id="overlayBusquedaRepuesto" onclick="mapController.cerrarModalBusquedaRepuesto()" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
      "></div>
    `;

    // Eliminar modal previo si existe
    this.cerrarModalBusquedaRepuesto();

    // Agregar al DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Guardar contexto
    this.state.modalBusqueda = { x, y, area };

    // Focus en el input y configurar bsqueda
    const input = document.getElementById('inputBusquedaRepuesto');
    if (input) {
      input.focus();
      input.addEventListener('input', (e) => {
        this.filtrarRepuestos(e.target.value);
      });
    }

    // Mostrar todos los repuestos inicialmente
    this.filtrarRepuestos('');
  },

  filtrarRepuestos(termino) {
    const lista = document.getElementById('listaResultadosRepuestos');
    const contador = document.getElementById('contadorResultados');
    if (!lista || !app || !app.repuestos) return;

    const terminoNorm = termino.toLowerCase().trim();
    
    let repuestosFiltrados = app.repuestos;
    if (terminoNorm) {
      repuestosFiltrados = app.repuestos.filter(r => {
        const nombre = (r.nombre || '').toLowerCase();
        const codigo = (r.codigo || '').toLowerCase();
        const area = (r.areaGeneral || r.area || '').toLowerCase();
        const sistema = (r.sistemaEquipo || r.equipo || '').toLowerCase();
        
        return nombre.includes(terminoNorm) || 
               codigo.includes(terminoNorm) ||
               area.includes(terminoNorm) ||
               sistema.includes(terminoNorm);
      });
    }

    // Actualizar contador
    if (contador) {
      contador.textContent = `${repuestosFiltrados.length} repuesto(s) encontrado(s)`;
    }

    // Renderizar lista
    if (repuestosFiltrados.length === 0) {
      lista.innerHTML = `
        <div style="
          padding: 40px 20px;
          text-align: center;
          color: var(--text-muted);
        ">
          <div style="font-size: 3rem; margin-bottom: 12px;"></div>
          <p>No se encontraron repuestos</p>
        </div>
      `;
      return;
    }

    lista.innerHTML = repuestosFiltrados.map(r => `
      <div 
        onclick="mapController.seleccionarRepuestoParaMarcador('${r.id}')"
        style="
          padding: 12px 16px;
          margin-bottom: 8px;
          border: 1px solid var(--border-color);
          border-radius: 8px;
          background: var(--bg-tertiary);
          cursor: pointer;
          transition: all 0.2s;
        "
        onmouseover="this.style.background='var(--bg-hover)'; this.style.borderColor='var(--primary)';"
        onmouseout="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border-color)';"
      >
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
              ${r.nombre || 'Sin nombre'}
            </div>
            <div style="font-size: 0.85rem; color: var(--text-muted);">
              ${r.codigo ? `Cdigo: ${r.codigo}` : ''}
              ${r.areaGeneral ? `  ${r.areaGeneral}` : ''}
              ${r.sistemaEquipo ? `  ${r.sistemaEquipo}` : ''}
            </div>
          </div>
          <div style="
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
          ">
            Seleccionar
          </div>
        </div>
      </div>
    `).join('');
  },

  async seleccionarRepuestoParaMarcador(repuestoId, numeroCorrelativoSeleccionado = null) {
    const repuesto = app.repuestos.find(r => r.id === repuestoId);
    if (!repuesto || !this.state.modalBusqueda) return;

    const { x, y, area } = this.state.modalBusqueda;
    const mapId = this.state.currentMapId;
    
    // 🔢 DETECTAR MÚLTIPLES INSTANCIAS: Si el repuesto tiene cantidadEnUbicacion > 1 en esta área
    const ubicacionEnArea = repuesto.ubicaciones?.find(ub => {
      // Buscar ubicación que coincida con la jerarquía del área del mapa
      return ub.mapId === mapId && ub.areaId === area.id;
    });
    
    const cantidadEnEstaArea = ubicacionEnArea?.cantidadEnUbicacion || 1;
    
    // Si hay múltiples instancias Y NO se ha seleccionado el correlativo aún, mostrar selector
    if (cantidadEnEstaArea > 1 && numeroCorrelativoSeleccionado === null) {
      this.mostrarSelectorCorrelativo(repuestoId, cantidadEnEstaArea);
      return;
    }
    
    //  Obtener categora seleccionada
    const selectCategoria = document.getElementById('selectCategoriaMarker');
    const categoria = selectCategoria ? selectCategoria.value : 'Sin categora';

    console.log('📌 Agregando marcador:', {
      repuesto: repuesto.nombre,
      repuestoId: repuesto.id,
      coordenadas: { x, y },
      area: area.name,
      areaId: area.id,
      mapId: mapId,
      categoria: categoria //  Log de categora
    });

    try {
      // Inicializar array de ubicaciones si no existe
      if (!repuesto.ubicaciones || !Array.isArray(repuesto.ubicaciones)) {
        repuesto.ubicaciones = [];
        console.log('   Inicializando array de ubicaciones');
      }

      console.log(`   Ubicaciones actuales: ${repuesto.ubicaciones.length}`);
      repuesto.ubicaciones.forEach((ub, idx) => {
        console.log(`    [${idx}] mapId: ${ub.mapId}, areaId: ${ub.areaId}, pos: (${ub.markerX}, ${ub.markerY})`);
      });

      //  MEJORADO: Solo verificar duplicados si es en la MISMA POSICIN (no solo misma rea)
      // Permitir mltiples marcadores del mismo repuesto en la misma rea pero en posiciones diferentes
      const TOLERANCE = 5; // Tolerancia de 5 pxeles para considerar "misma posicin"
      const yaExisteEnMismaPosicion = repuesto.ubicaciones.some(ub => {
        const mismoMapa = String(ub.mapId) === String(mapId);
        const mismaArea = String(ub.areaId) === String(area.id);
        const mismaPosicion = Math.abs(ub.markerX - x) < TOLERANCE && Math.abs(ub.markerY - y) < TOLERANCE;
        return mismoMapa && mismaArea && mismaPosicion;
      });

      if (yaExisteEnMismaPosicion) {
        console.log('   Ya existe un marcador en esta posicin exacta');
        this.showToast(' Ya hay un marcador en esta posicin', 'warning');
        this.cerrarModalBusquedaRepuesto();
        return;
      }

      // Agregar nueva ubicacin (ahora permite mltiples marcadores del mismo repuesto en la misma rea)
      console.log('   Agregando nueva ubicacin con correlativo:', numeroCorrelativoSeleccionado);
      repuesto.ubicaciones.push({
        mapId: mapId,
        areaId: area.id,
        areaName: area.name, //  Guardar nombre del rea padre
        markerX: x,
        markerY: y,
        categoria: categoria, //  Categora jerrquica
        numeroCorrelativo: numeroCorrelativoSeleccionado || 1 // 🔢 Correlativo seleccionado
      });
      console.log(`   Total ubicaciones ahora: ${repuesto.ubicaciones.length}`);
      
      // Contar cuntos marcadores de este repuesto hay en esta rea
      const marcadoresEnArea = repuesto.ubicaciones.filter(ub => 
        String(ub.mapId) === String(mapId) && String(ub.areaId) === String(area.id)
      ).length;
      
      if (marcadoresEnArea > 1) {
        this.showToast(` "${repuesto.nombre}" agregado (${marcadoresEnArea} en "${area.name}")`, 'success');
      } else {
        this.showToast(` "${repuesto.nombre}" agregado a "${area.name}"`, 'success');
      }

      // Guardar cambios
      console.log('   Guardando cambios...');
      await app.saveData();
      console.log('    Guardado completado');

      // Cerrar modal y redibujar
      this.cerrarModalBusquedaRepuesto();
      this.draw();

      console.log(` Marcador agregado: ${repuesto.nombre} en (${x}, ${y})`);

    } catch (error) {
      console.error(' Error agregando marcador:', error);
      this.showToast(' Error al agregar marcador', 'error');
    }
  },

  mostrarSelectorCorrelativo(repuestoId, cantidadTotal) {
    const repuesto = app.repuestos.find(r => r.id === repuestoId);
    if (!repuesto) return;

    const modalHTML = `
      <div id="modalSelectorCorrelativo" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-primary);
        border: 2px solid var(--primary);
        border-radius: 12px;
        box-shadow: 0 12px 48px rgba(0,0,0,0.4);
        z-index: 10001;
        width: 90%;
        max-width: 450px;
        padding: 24px;
      ">
        <h3 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 1.2rem;">
          🔢 Seleccionar Instancia
        </h3>
        <p style="margin: 0 0 20px 0; color: var(--text-muted); font-size: 0.95rem;">
          Este repuesto tiene <strong>${cantidadTotal} instancias</strong> en esta ubicación.<br>
          ¿Cuál instancia estás marcando en el mapa?
        </p>
        
        <div style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
          gap: 12px;
          margin-bottom: 20px;
        ">
          ${Array.from({ length: cantidadTotal }, (_, i) => i + 1).map(num => `
            <button 
              onclick="mapController.seleccionarCorrelativo('${repuestoId}', ${num})"
              style="
                padding: 16px 12px;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                background: var(--bg-secondary);
                color: var(--text-primary);
                cursor: pointer;
                font-size: 1.1rem;
                font-weight: 700;
                font-family: monospace;
                transition: all 0.2s;
              "
              onmouseover="this.style.background='var(--primary)'; this.style.color='white'; this.style.borderColor='var(--primary)';"
              onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)'; this.style.borderColor='var(--border-color)';"
            >
              #${num}
            </button>
          `).join('')}
        </div>

        <div style="display: flex; gap: 8px; justify-content: flex-end;">
          <button 
            onclick="mapController.cerrarSelectorCorrelativo()"
            style="
              padding: 10px 20px;
              border: 1px solid var(--border-color);
              border-radius: 6px;
              background: var(--bg-tertiary);
              color: var(--text-primary);
              cursor: pointer;
              font-size: 0.95rem;
            "
          >
            Cancelar
          </button>
        </div>
      </div>

      <div id="overlaySelectorCorrelativo" onclick="mapController.cerrarSelectorCorrelativo()" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 10000;
      "></div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
  },

  seleccionarCorrelativo(repuestoId, numeroCorrelativo) {
    this.cerrarSelectorCorrelativo();
    this.seleccionarRepuestoParaMarcador(repuestoId, numeroCorrelativo);
  },

  cerrarSelectorCorrelativo() {
    const modal = document.getElementById('modalSelectorCorrelativo');
    const overlay = document.getElementById('overlaySelectorCorrelativo');
    if (modal) modal.remove();
    if (overlay) overlay.remove();
  },

  cerrarModalBusquedaRepuesto() {
    const modal = document.getElementById('modalBusquedaRepuesto');
    const overlay = document.getElementById('overlayBusquedaRepuesto');
    
    if (modal) modal.remove();
    if (overlay) overlay.remove();
    
    this.state.modalBusqueda = null;
  },

  openAreaModal() {
    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) return;

    this.elements.modalTitle.textContent = 'Definir nueva rea';

    const jerarquia = this.getJerarquiaOptionCatalog();
    const mapJerarquiaDefaults = this.getCurrentMapJerarquiaDefaults();
    const buildDatalist = (id, values) => {
      if (!Array.isArray(values) || !values.length) return '';
      return `<datalist id="${id}">${values.map(v => `<option value="${this.escapeHtml(v)}"></option>`).join('')}</datalist>`;
    };

    // Construir opciones de categoras con iconos
    const categoryOptions = Object.entries(this.categories).map(([key, cat]) => 
      `<option value="${key}">${cat.icon} ${cat.name}</option>`
    ).join('');

    body.innerHTML = `
      <form id="mapAreaForm" class="map-area-form">
        <div class="form-group">
          <label> Categora</label>
          <select name="category" id="areaCategorySelect" style="font-size: 1rem; padding: 8px;">
            ${categoryOptions}
          </select>
        </div>
        <div class="form-group">
          <label>Nombre del rea</label>
          <input type="text" name="areaName" required placeholder="Ej: Planta Principal" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Color</label>
            <input type="color" name="areaColor" id="areaColorInput" value="#3b82f6" />
          </div>
          <div class="form-group">
            <label>Opacidad</label>
            <input type="range" name="areaOpacity" min="10" max="90" value="35" />
          </div>
        </div>
        
        <!--  NUEVO: Controles para posicionar el nombre en el canvas -->
        <div class="form-group" style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 1.1rem;"></span>
            <span>Posicin del nombre en el mapa</span>
          </label>
          <div class="form-row" style="gap: 12px;">
            <div class="form-group" style="flex: 1;">
              <label style="font-size: 0.85rem; color: var(--text-secondary);">Desplazar horizontalmente (X)</label>
              <input type="number" name="labelOffsetX" value="0" step="10" placeholder="0" 
                     style="text-align: center;" title="Valores positivos mueven a la derecha, negativos a la izquierda" />
              <small style="color: var(--text-muted); font-size: 0.75rem;"> Izq (-)  |  Der (+) </small>
            </div>
            <div class="form-group" style="flex: 1;">
              <label style="font-size: 0.85rem; color: var(--text-secondary);">Desplazar verticalmente (Y)</label>
              <input type="number" name="labelOffsetY" value="0" step="10" placeholder="0" 
                     style="text-align: center;" title="Valores positivos mueven hacia abajo, negativos hacia arriba" />
              <small style="color: var(--text-muted); font-size: 0.75rem;"> Arriba (-)  |  Abajo (+) </small>
            </div>
          </div>
          <small style="display: block; margin-top: 8px; color: var(--text-muted); font-size: 0.8rem;">
             Ajusta estos valores si el nombre se monta sobre otra rea (puedes editarlo despus)
          </small>
        </div>
        
        <div class="form-group">
          <label>Nivel 1  Empresa / Planta</label>
          <input type="text" name="planta" list="plantaList" placeholder="Ej: Aquachile Antarfood" value="${this.escapeHtml(mapJerarquiaDefaults.planta || '')}" />
          ${buildDatalist('plantaList', jerarquia.planta)}
        </div>
        <div class="form-group">
          <label>Nivel 2  rea general</label>
          <input type="text" name="areaGeneral" list="areaGeneralList" placeholder="Ej: Planta Principal" value="${this.escapeHtml(mapJerarquiaDefaults.areaGeneral || '')}" />
          ${buildDatalist('areaGeneralList', jerarquia.areaGeneral)}
        </div>
        <div class="form-group">
          <label>Nivel 3  Sub-rea</label>
          <input type="text" name="subArea" list="subAreaList" placeholder="Ej: Estanques" value="${this.escapeHtml(mapJerarquiaDefaults.subArea || '')}" />
          ${buildDatalist('subAreaList', jerarquia.subArea)}
        </div>
        <div class="form-group">
          <label>Nivel 4  Sistema / Equipo</label>
          <input type="text" name="sistemaEquipo" list="sistemaEquipoList" placeholder="Ej: Grader Baader" value="${this.escapeHtml(mapJerarquiaDefaults.sistemaEquipo || '')}" />
          ${buildDatalist('sistemaEquipoList', jerarquia.sistemaEquipo)}
        </div>
        <div class="form-group">
          <label>Nivel 5  Sub-sistema</label>
          <input type="text" name="subSistema" list="subSistemaList" placeholder="Ej: Cinta Zeta" value="${this.escapeHtml(mapJerarquiaDefaults.subSistema || '')}" />
          ${buildDatalist('subSistemaList', jerarquia.subSistema)}
        </div>
        <div class="form-group">
          <label>Nivel 6  Seccin</label>
          <input type="text" name="seccion" list="seccionList" placeholder="Ej: Mdulo 1" value="${this.escapeHtml(mapJerarquiaDefaults.seccion || '')}" />
          ${buildDatalist('seccionList', jerarquia.seccion)}
        </div>
        <div class="form-group">
          <label>Equipos / mquinas (uno por lnea)</label>
          <textarea name="equipos" rows="4" placeholder="Ej:\nMotor principal\nBanda transportadora"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>
          <button type="submit" class="map-btn map-btn--primary">Guardar rea</button>
        </div>
      </form>
    `;

    modal.classList.remove('hidden');

    const form = body.querySelector('#mapAreaForm');
    const cancelBtn = body.querySelector('[data-action="cancel"]');
    if (cancelBtn) cancelBtn.addEventListener('click', () => {
      this.closeModal();
      this.cancelDrawing();
    });

    // Event listener para cambiar color sugerido al seleccionar categora
    const categorySelect = body.querySelector('#areaCategorySelect');
    const colorInput = body.querySelector('#areaColorInput');
    if (categorySelect && colorInput) {
      categorySelect.addEventListener('change', (e) => {
        const selectedCategory = e.target.value;
        if (this.categories[selectedCategory]) {
          colorInput.value = this.categories[selectedCategory].color;
          console.log(` Color sugerido para categora "${selectedCategory}": ${this.categories[selectedCategory].color}`);
        }
      });
    }

    if (form) {
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        this.saveAreaFromModal(new FormData(form));
      });
    }
  },

  closeModal() {
    const modal = this.elements.modal;
    if (modal) {
      modal.classList.add('hidden');
    }
    this.elements.modalBody.innerHTML = '';
    this.elements.modalTitle.textContent = '';
    this.state.tempJerarquiaAssignment = null;
    this.state.mapFormContext = null;
  },

  async saveAreaFromModal(formData) {
    const name = (formData.get('areaName') || '').toString().trim();
    if (!name) {
      this.showToast('Asigna un nombre a el rea.', 'warning');
      return;
    }

    const color = (formData.get('areaColor') || '#3b82f6').toString();
    const opacityValue = parseInt(formData.get('areaOpacity'), 10);
    const opacity = Number.isFinite(opacityValue) ? opacityValue / 100 : 0.35;
    
    //  NUEVO: Obtener categora seleccionada (por defecto 'area')
    const category = (formData.get('category') || 'area').toString().trim();

    //  NUEVO: Obtener offsets de posicin del nombre
    const labelOffsetX = parseInt(formData.get('labelOffsetX'), 10) || 0;
    const labelOffsetY = parseInt(formData.get('labelOffsetY'), 10) || 0;

    const jerarquia = {};
    const planta = (formData.get('planta') || '').toString().trim();
    const areaGeneral = (formData.get('areaGeneral') || '').toString().trim();
    const subArea = (formData.get('subArea') || '').toString().trim();
    const sistemaEquipo = (formData.get('sistemaEquipo') || '').toString().trim();
    const subSistema = (formData.get('subSistema') || '').toString().trim();
    const seccion = (formData.get('seccion') || '').toString().trim();

    if (planta) jerarquia.planta = planta;
    if (areaGeneral) jerarquia.areaGeneral = areaGeneral;
    if (subArea) jerarquia.subArea = subArea;
    if (sistemaEquipo) jerarquia.sistemaEquipo = sistemaEquipo;
    if (subSistema) jerarquia.subSistema = subSistema;
    if (seccion) jerarquia.seccion = seccion;

    const equiposRaw = (formData.get('equipos') || '').toString();
    const equipos = equiposRaw
      .split(/\r?\n/)
      .map(line => line.trim())
      .filter(Boolean);

    const areaId = Date.now();

    let jerarquiaPath = [];
    if (typeof app?.registerJerarquiaPath === 'function' && Object.keys(jerarquia).length) {
      try {
        jerarquiaPath = app.registerJerarquiaPath(jerarquia, {
          source: 'map-area',
          entityId: areaId,
          meta: {
            mapId: this.state.currentMapId,
            areaName: name
          }
        }) || [];
      } catch (error) {
        console.error(' Error registrando jerarqua del rea:', error);
      }
    }

    const area = {
      id: areaId,
      mapId: this.state.currentMapId,
      name,
      color,
      opacity,
      category, //  NUEVO: Guardar categora
      labelOffsetX, //  NUEVO: Offset horizontal del nombre
      labelOffsetY, //  NUEVO: Offset vertical del nombre
      parentId: null, //  ETAPA 4: ID del rea padre (null = nivel raz)
      children: [], //  ETAPA 4: Array de IDs de reas hijas
      points: [...this.state.tempPoints],
      jerarquia,
      jerarquiaPath,
      equipos,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    try {
      const areas = [...(mapStorage.areas || []), area];
      await mapStorage.saveAreas(areas, { action: 'create', mapId: area.mapId, areaId: area.id, detail: area.name });
      this.state.areas = mapStorage.getAreasByMap(area.mapId);
      this.renderAreaList(this.state.areas);
      this.state.highlightAreaId = area.id;
      this.closeModal();
      this.cancelDrawing();
      this.draw();
      this.showToast('rea guardada correctamente.', 'success');
      this.updateMetaBadge();
    } catch (error) {
      console.error('Error guardando la rea:', error);
      this.showToast('No se pudo guardar el rea. Revisa la consola.', 'error');
    }
  },

  focusArea(areaId) {
    const area = this.state.areas.find(z => z.id == areaId);
    if (!area || !Array.isArray(area.points) || area.points.length < 1) return;

    this.state.highlightAreaId = area.id;

    const xs = area.points.map(p => p.x);
    const ys = area.points.map(p => p.y);
    const minX = Math.min(...xs);
    const maxX = Math.max(...xs);
    const minY = Math.min(...ys);
    const maxY = Math.max(...ys);

    const areaWidth = Math.max(1, maxX - minX);
    const areaHeight = Math.max(1, maxY - minY);
    const canvas = this.elements.canvas;

    const scaleX = (canvas.width * 0.6) / areaWidth;
    const scaleY = (canvas.height * 0.6) / areaHeight;
    const targetScale = Math.min(scaleX, scaleY, this.state.maxScale);

    this.state.scale = Math.max(this.state.minScale, targetScale);
    const centerX = (minX + maxX) / 2;
    const centerY = (minY + maxY) / 2;
    this.state.offsetX = canvas.width / 2 - centerX * this.state.scale;
    this.state.offsetY = canvas.height / 2 - centerY * this.state.scale;

    this.draw();
    this.queueViewportPersist('focus-area');
  },

  updateMetaBadge() {
    const badge = this.elements.metaBadge;
    if (!badge) return;
    if (!this.state.currentMap) {
      badge.textContent = 'Sin mapa';
      return;
    }
    const map = this.state.currentMap;
    const areasCount = this.state.areas.length;
    const dimensions = map.width && map.height ? `${map.width}  ${map.height}px` : 'Dimensiones pendientes';
    const contract = this.getCurrentMapContractState();
    let contractLabel;
    if (contract.allowFreeLevel) {
      contractLabel = 'Modo nivel libre';
    } else if (!contract.hasJerarquia) {
      contractLabel = 'Sin jerarquía asignada';
    } else {
      contractLabel = `Nivel ${this.getMapLevelLabel(contract.mapLevel)}`;
    }
    if (contract.conflicts.length) {
      contractLabel += ' · ⚠ Conflicto';
    }
    badge.textContent = `${map.name} · ${dimensions} · ${areasCount} rea(s) · ${contractLabel}`;
  },

  updateMapJerarquiaBadge() {
    const badge = this.elements?.jerarquiaBadge;
    if (!badge) return;

    const contract = this.getCurrentMapContractState();
    const map = contract.map;
    const applyState = (state) => {
      badge.dataset.state = state;
      badge.dataset.conflict = contract.conflicts.length ? 'true' : 'false';
    };

    if (!map) {
      badge.classList.add('map-jerarquia-badge--empty');
      applyState('idle');
      badge.innerHTML = `
        <div>
          <strong>Sin mapa activo</strong>
          <span class="map-jerarquia-badge__path">Selecciona un mapa para ver su jerarquia.</span>
        </div>
        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Asignar</button>
      `;
      this.renderMapJerarquiaBranch();
      this.renderMapContractSignals(contract);
      return;
    }

    if (contract.allowFreeLevel) {
      badge.classList.remove('map-jerarquia-badge--empty');
       applyState('free');
      badge.innerHTML = `
        <div>
          <strong>Modo nivel libre</strong>
          <span class="map-jerarquia-badge__path">${this.escapeHtml(map.name || 'Mapa sin nombre')} acepta reas sin anclar al rbol corporativo.</span>
        </div>
        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Configurar</button>
      `;
      this.renderMapJerarquiaBranch();
      this.renderMapContractSignals(contract);
      return;
    }

    if (!contract.hasJerarquia) {
      badge.classList.add('map-jerarquia-badge--empty');
      applyState('issue');
      badge.innerHTML = `
        <div>
          <strong>${this.escapeHtml(map.name || 'Mapa sin nombre')}</strong>
          <span class="map-jerarquia-badge__path">Sin jerarquia asignada.</span>
        </div>
        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Asignar</button>
      `;
      this.renderMapJerarquiaBranch();
      this.renderMapContractSignals(contract);
      return;
    }

    const label = this.getJerarquiaPathLabel(contract.path);
    const levelLabel = this.getMapLevelLabel(contract.mapLevel);
    const warningHtml = contract.conflicts.length
      ? `<span style="color: #f97316; font-size: 0.78rem; display: block; margin-top: 4px;">⚠ Este nodo ya est asignado a: ${contract.conflicts.map(item => this.escapeHtml(item.name || `#${item.id}`)).join(', ')}.</span>`
      : '';

    badge.classList.remove('map-jerarquia-badge--empty');
    applyState(contract.conflicts.length ? 'conflict' : 'locked');
    badge.innerHTML = `
      <div>
        <strong>Rama asignada · ${this.escapeHtml(levelLabel)}</strong>
        <span class="map-jerarquia-badge__path">${this.escapeHtml(label)}</span>
        ${warningHtml}
      </div>
        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Editar</button>
    `;
    this.renderMapJerarquiaBranch();
    this.renderMapContractSignals(contract);
  },

  showMapLoadingOverlay(map) {
    const overlay = this.elements.mapLoadingOverlay;
    if (!overlay) return;

    clearTimeout(this.state.mapLoadingHideTimeout);
    this.state.mapLoadingActive = true;
    this.state.mapLoadingProgress = 0;

    const title = map?.name ? `Cargando ${map.name}` : 'Preparando mapa';
    if (this.elements.mapLoadingTitle) {
      this.elements.mapLoadingTitle.textContent = title;
    }
    if (this.elements.mapLoadingStatus) {
      this.elements.mapLoadingStatus.textContent = 'Buscando imagen en la carpeta...';
    }
    if (this.elements.mapLoadingPercent) {
      this.elements.mapLoadingPercent.textContent = '0%';
    }
    if (this.elements.mapLoadingBar) {
      this.elements.mapLoadingBar.style.width = '0%';
    }

    overlay.classList.remove('hidden');
  },

  updateMapLoadingProgress(percent, message = null) {
    if (!this.state.mapLoadingActive) {
      return;
    }
    const overlay = this.elements.mapLoadingOverlay;
    if (!overlay) {
      return;
    }

    const clamped = Math.max(this.state.mapLoadingProgress, Math.min(99, Math.round(percent)));
    this.state.mapLoadingProgress = clamped;

    if (this.elements.mapLoadingBar) {
      this.elements.mapLoadingBar.style.width = `${clamped}%`;
    }
    if (this.elements.mapLoadingPercent) {
      this.elements.mapLoadingPercent.textContent = `${clamped}%`;
    }
    if (message && this.elements.mapLoadingStatus) {
      this.elements.mapLoadingStatus.textContent = message;
    }
  },

  completeMapLoadingProgress(message = 'Mapa listo') {
    if (!this.state.mapLoadingActive) {
      return;
    }

    this.state.mapLoadingProgress = 100;
    if (this.elements.mapLoadingBar) {
      this.elements.mapLoadingBar.style.width = '100%';
    }
    if (this.elements.mapLoadingPercent) {
      this.elements.mapLoadingPercent.textContent = '100%';
    }
    if (this.elements.mapLoadingStatus && message) {
      this.elements.mapLoadingStatus.textContent = message;
    }

    clearTimeout(this.state.mapLoadingHideTimeout);
    this.state.mapLoadingHideTimeout = setTimeout(() => {
      this.hideMapLoadingOverlay();
    }, 450);
  },

  hideMapLoadingOverlay(force = false, message = null) {
    if (!this.elements.mapLoadingOverlay) {
      return;
    }
    if (!this.state.mapLoadingActive && !force) {
      return;
    }

    if (message && this.elements.mapLoadingStatus) {
      this.elements.mapLoadingStatus.textContent = message;
    }

    clearTimeout(this.state.mapLoadingHideTimeout);
    this.state.mapLoadingHideTimeout = null;
    this.state.mapLoadingActive = false;
    this.state.mapLoadingProgress = 0;
    this.elements.mapLoadingOverlay.classList.add('hidden');
    if (this.elements.mapLoadingBar) {
      this.elements.mapLoadingBar.style.width = '0%';
    }
    if (this.elements.mapLoadingPercent) {
      this.elements.mapLoadingPercent.textContent = '0%';
    }
  },

  normalizeMapJerarquiaPath(path = []) {
    if (!Array.isArray(path) || !path.length) {
      return [];
    }

    return path.map((node) => {
      if (!node || !node.id) {
        return null;
      }
      const resolved = this.findJerarquiaNodeInTree(node.id, node.nivel);
      const label = resolved?.nombre || node.nombre || node.id;
      return {
        id: node.id,
        nivel: node.nivel || resolved?.nivel || null,
        label,
        labelLower: (label || '').toString().trim().toLowerCase()
      };
    }).filter(Boolean);
  },

  getAreasMatchingBranch(pathSegments, depth, areasSource = null) {
    if (!Array.isArray(pathSegments) || !pathSegments.length) {
      return Array.isArray(areasSource) ? areasSource : (this.state.areas || []);
    }

    const areasList = Array.isArray(areasSource) ? areasSource : (this.state.areas || []);
    if (!areasList.length) {
      return [];
    }

    const baseIndex = pathSegments[0]?.nivel === 'empresa' ? 1 : 0;
    const targetDepth = typeof depth === 'number' ? depth : pathSegments.length - 1;
    if (targetDepth < baseIndex) {
      return areasList;
    }

    const fieldOrder = this.areaJerarquiaFieldOrder;
    return areasList.filter((area) => {
      const jerarquia = area.jerarquia || {};
      for (let i = baseIndex; i <= targetDepth; i++) {
        const orderIndex = i - baseIndex;
        if (orderIndex < 0) continue;
        const field = fieldOrder[orderIndex];
        if (!field) continue;
        const expected = pathSegments[i]?.labelLower;
        if (!expected) {
          return false;
        }
        const value = (jerarquia[field] || '').toString().trim().toLowerCase();
        if (!value || value !== expected) {
          return false;
        }
      }
      return true;
    });
  },

  countMarkersForAreas(areaList = []) {
    if (!Array.isArray(areaList) || !areaList.length) {
      return 0;
    }

    const areaIds = new Set(areaList.map((area) => String(area.id)));
    if (!areaIds.size) {
      return 0;
    }

    const repuestos = app?.repuestos || [];
    let count = 0;
    repuestos.forEach((repuesto) => {
      if (!Array.isArray(repuesto.ubicaciones)) {
        return;
      }
      repuesto.ubicaciones.forEach((ubicacion) => {
        if (String(ubicacion.mapId) !== String(this.state.currentMapId)) {
          return;
        }
        if (areaIds.has(String(ubicacion.areaId))) {
          count++;
        }
      });
    });
    return count;
  },

  renderMapContractSignals(contract) {
    const container = document.getElementById('mapContractSignals');
    if (!container) return;

    if (!contract || !contract.map) {
      container.innerHTML = '';
      container.classList.add('hidden');
      return;
    }

    const chips = [];
    if (contract.allowFreeLevel) {
      chips.push({
        label: 'Modo nivel libre',
        css: 'map-contract-chip--free',
        hint: 'Este mapa permite reas sin bloquearse a la jerarquía corporativa.'
      });
    } else if (!contract.hasJerarquia) {
      chips.push({
        label: 'Sin jerarquía',
        css: 'map-contract-chip--issue',
        hint: 'Debes asignar una rama antes de dibujar nuevas reas.'
      });
    } else {
      chips.push({
        label: `Nivel ${this.getMapLevelLabel(contract.mapLevel)}`,
        css: 'map-contract-chip--locked',
        hint: this.getJerarquiaPathLabel(contract.path)
      });
    }

    if (!contract.allowFreeLevel && contract.conflicts.length) {
      chips.push({
        label: `Conflicto (${contract.conflicts.length})`,
        css: 'map-contract-chip--conflict',
        hint: `También usan este nivel: ${contract.conflicts.map(item => item.name || `#${item.id}`).join(', ')}`
      });
    }

    if (contract.issues.length) {
      chips.push({
        label: contract.issues[0],
        css: 'map-contract-chip--issue',
        hint: 'Revisa la configuración del mapa para resolverlo.'
      });
    }

    container.innerHTML = chips.map((chip) => `
      <span class="map-contract-chip ${chip.css || ''}" title="${this.escapeHtml(chip.hint || '')}">
        ${this.escapeHtml(chip.label)}
      </span>
    `).join('');
    container.classList.toggle('hidden', chips.length === 0);
  },

  renderMapJerarquiaBranch() {
    const container = this.elements?.jerarquiaBranch;
    if (!container) return;

    const map = this.state.currentMap;
    if (!map) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">Selecciona un mapa para ver su ruta jerarquica.</div>';
      return;
    }

    if (map.allowFreeLevel) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">Este mapa est en modo nivel libre, por lo que no existe una rama corporativa que mostrar.</div>';
      return;
    }

    if (!app || !app.jerarquiaAnidada) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">Configura la jerarqua para habilitar esta vista.</div>';
      return;
    }

    const path = Array.isArray(map.jerarquiaPath) ? map.jerarquiaPath : [];
    if (!path.length) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">Este mapa an no tiene jerarqua asignada.</div>';
      return;
    }

    const normalizedPath = this.normalizeMapJerarquiaPath(path);
    if (!normalizedPath.length) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">No se pudo interpretar la jerarqua asignada.</div>';
      return;
    }

    const activeFilter = this.state.jerarquiaBranchFilter;
    const baseIndex = normalizedPath[0]?.nivel === 'empresa' ? 1 : 0;
    const nodesForRender = normalizedPath
      .map((segment, index) => ({ segment, index }))
      .filter(({ index }) => index >= baseIndex);

    if (!nodesForRender.length) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">La jerarqua asignada no tiene niveles descendentes configurados.</div>';
      return;
    }

    const nodesHtml = nodesForRender.map(({ segment, index }) => {
      const areasAtLevel = this.getAreasMatchingBranch(normalizedPath, index);
      const markersCount = this.countMarkersForAreas(areasAtLevel);
      const levelLabel = this.jerarquiaLevelConfig[segment.nivel]?.label || `Nivel ${index + 1}`;
      const isActive = activeFilter && activeFilter.mapId === this.state.currentMapId && activeFilter.index === index;
      const stateHint = isActive ? 'Filtro aplicado. Click para limpiar.' : 'Click para filtrar las reas de este nivel.';
      return `
        <div class="map-jerarquia-branch-node ${isActive ? 'is-active' : ''}" data-branch-index="${index}">
          <div class="map-jerarquia-branch-header">
            <span class="map-jerarquia-branch-level">N${index + 1} · ${this.escapeHtml(levelLabel)}</span>
            <span class="map-jerarquia-branch-name">${this.escapeHtml(segment.label)}</span>
          </div>
          <div class="map-jerarquia-branch-stats">
            <span><strong>${areasAtLevel.length}</strong> ${areasAtLevel.length === 1 ? 'rea' : 'reas'}</span>
            <span><strong>${markersCount}</strong> ${markersCount === 1 ? 'marcador' : 'marcadores'}</span>
          </div>
          <div style="font-size: 0.68rem; color: var(--text-muted);">${stateHint}</div>
        </div>
      `;
    }).join('');

    container.innerHTML = nodesHtml;
  },

  getActiveBranchFilterLabel() {
    const filter = this.state.jerarquiaBranchFilter;
    if (!filter || !Array.isArray(filter.pathSnapshot)) {
      return '';
    }
    const node = filter.pathSnapshot[filter.index];
    return node?.label || '';
  },

  toggleJerarquiaBranchFilter(index) {
    const map = this.state.currentMap;
    if (!map) {
      this.showToast('Selecciona un mapa primero.', 'info');
      return;
    }

    const normalizedPath = this.normalizeMapJerarquiaPath(map.jerarquiaPath || []);
    if (!normalizedPath.length) {
      this.showToast('Este mapa an no tiene jerarqua asignada.', 'info');
      return;
    }

    const currentFilter = this.state.jerarquiaBranchFilter;
    if (currentFilter && currentFilter.mapId === this.state.currentMapId && currentFilter.index === index) {
      this.state.jerarquiaBranchFilter = null;
    } else {
      this.state.jerarquiaBranchFilter = {
        mapId: this.state.currentMapId,
        index,
        pathSnapshot: normalizedPath
      };
    }

    this.renderAreaList(this.state.areas);
  },

  clearJerarquiaBranchFilter() {
    if (!this.state.jerarquiaBranchFilter) return;
    this.state.jerarquiaBranchFilter = null;
    this.renderAreaList(this.state.areas);
  },

  applyActiveBranchFilter(areas) {
    const filter = this.state.jerarquiaBranchFilter;
    if (!filter) {
      return areas;
    }

    if (filter.mapId !== this.state.currentMapId) {
      this.state.jerarquiaBranchFilter = null;
      return areas;
    }

    const pathSnapshot = Array.isArray(filter.pathSnapshot)
      ? filter.pathSnapshot
      : this.normalizeMapJerarquiaPath(this.state.currentMap?.jerarquiaPath || []);

    if (!pathSnapshot.length || filter.index >= pathSnapshot.length) {
      this.state.jerarquiaBranchFilter = null;
      return areas;
    }

    return this.getAreasMatchingBranch(pathSnapshot, filter.index, areas);
  },

  updateZoomBadge() {
    const badge = this.elements.zoomBadge;
    if (!badge) return;
    badge.textContent = `${Math.round(this.state.scale * 100)}%`;
  },

  calculateCentroid(points) {
    if (!Array.isArray(points) || points.length === 0) return null;
    const sum = points.reduce((acc, point) => {
      acc.x += point.x;
      acc.y += point.y;
      return acc;
    }, { x: 0, y: 0 });
    return {
      x: sum.x / points.length,
      y: sum.y / points.length
    };
  },

  //  ETAPA 5: Mtodos para vinculacin Repuesto  Mapa
  
  highlightArea(areaId) {
    console.log(' Resaltando rea:', areaId);
    this.state.highlightAreaId = areaId;
    this.draw();
  },

  //  Hacer parpadear un rea para llamar la atencin
  flashArea(areaId, times = 3) {
    console.log(` Haciendo parpadear rea ${areaId} (${times} veces)`);
    let count = 0;
    const interval = setInterval(() => {
      this.state.highlightAreaId = count % 2 === 0 ? areaId : null;
      this.draw();
      count++;
      
      if (count >= times * 2) {
        clearInterval(interval);
        this.state.highlightAreaId = areaId; // Dejar resaltada al final
        this.draw();
      }
    }, 300); // Parpadear cada 300ms
  },

  zoomToArea(areaId) {
    console.log(' Haciendo zoom al rea:', areaId);
    const area = this.state.areas.find(a => String(a.id) === String(areaId));
    
    if (!area || !area.points || area.points.length === 0) {
      console.warn(' rea no encontrada o sin puntos');
      return;
    }

    // Calcular el bounding box del rea
    let minX = Infinity, minY = Infinity;
    let maxX = -Infinity, maxY = -Infinity;

    area.points.forEach(point => {
      if (point.x < minX) minX = point.x;
      if (point.x > maxX) maxX = point.x;
      if (point.y < minY) minY = point.y;
      if (point.y > maxY) maxY = point.y;
    });

    // Calcular el centro del rea
    const centerX = (minX + maxX) / 2;
    const centerY = (minY + maxY) / 2;

    // Calcular el tamao del rea
    const areaWidth = maxX - minX;
    const areaHeight = maxY - minY;

    // Calcular el zoom ptimo (con un margen del 20%)
    const canvas = this.elements.canvas;
    if (!canvas) return;

    const canvasWidth = canvas.width;
    const canvasHeight = canvas.height;

    const scaleX = (canvasWidth * 0.6) / areaWidth;
    const scaleY = (canvasHeight * 0.6) / areaHeight;
    const targetScale = Math.min(scaleX, scaleY, this.state.maxScale);

    // Aplicar zoom y centrado con animacin suave
    this.animateZoomTo(centerX, centerY, targetScale);
  },

  animateZoomTo(targetX, targetY, targetScale, duration = 500) {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    const startScale = this.state.scale;
    const startOffsetX = this.state.offsetX;
    const startOffsetY = this.state.offsetY;

    // Calcular el offset final para centrar el punto
    const finalOffsetX = canvas.width / 2 - targetX * targetScale;
    const finalOffsetY = canvas.height / 2 - targetY * targetScale;

    const startTime = performance.now();

    const animate = (currentTime) => {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // Easing function (ease-in-out)
      const eased = progress < 0.5
        ? 2 * progress * progress
        : 1 - Math.pow(-2 * progress + 2, 2) / 2;

      // Interpolar valores
      this.state.scale = startScale + (targetScale - startScale) * eased;
      this.state.offsetX = startOffsetX + (finalOffsetX - startOffsetX) * eased;
      this.state.offsetY = startOffsetY + (finalOffsetY - startOffsetY) * eased;

      this.draw();
      this.updateZoomBadge();

      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        this.queueViewportPersist('animate-zoom');
      }
    };

    requestAnimationFrame(animate);
  },

  pulseArea(areaId, pulses = 3) {
    console.log(' Animando pulsacin del rea:', areaId);
    let count = 0;
    const interval = setInterval(() => {
      this.state.highlightAreaId = count % 2 === 0 ? areaId : null;
      this.draw();
      count++;
      
      if (count >= pulses * 2) {
        clearInterval(interval);
        this.state.highlightAreaId = areaId; // Dejar resaltada al final
        this.draw();
      }
    }, 300);
  },

  async loadMap(mapId) {
    console.log(' Cargando mapa:', mapId);
    await this.selectMap(mapId);
  },

  async loadMapImageFromStorage(imagePath) {
    try {
      if (!this.state.mapLoadingActive) {
        this.showMapLoadingOverlay(this.state.currentMap);
      }
      this.updateMapLoadingProgress(15, 'Leyendo imagen desde la carpeta...');
      const blob = await fsManager.readFile(imagePath);
      if (!blob) {
        console.warn(' No se pudo cargar la imagen del mapa');
        this.hideMapLoadingOverlay(true, 'No se encontr el archivo de imagen.');
        return;
      }

      const url = URL.createObjectURL(blob);
      const img = new Image();
      
      img.onload = () => {
        this.updateMapLoadingProgress(85, 'Aplicando mapa al lienzo...');
        this.state.currentImage = img;
        this.state.currentImageUrl = url;
        this.configureCanvasForImage(img, { keepViewport: false }); //  FIX: Configurar canvas con imagen escalada
        this.draw();
        this.completeMapLoadingProgress();
        URL.revokeObjectURL(url);
      };

      img.onerror = () => {
        console.error(' Error cargando imagen del mapa');
        URL.revokeObjectURL(url);
        this.hideMapLoadingOverlay(true, 'Error cargando la imagen del mapa.');
      };

      img.src = url;
    } catch (error) {
      console.error(' Error leyendo imagen:', error);
      this.hideMapLoadingOverlay(true, 'Error leyendo la imagen.');
    }
  },

  loadAreasForMap(mapId) {
    const allAreas = mapStorage.areas || [];
    this.state.areas = allAreas.filter(area => String(area.mapId) === String(mapId));
    this.renderAreaList(this.state.areas);
    console.log(` ${this.state.areas.length} reas cargadas para el mapa`);
  },

  //  NUEVO: Activar modo para colocar marcador de repuesto
  activarModoMarcador(repuestoId, mapId, areaId, modoEdicion = false) {
    this.state.modoMarcador = true;
    this.state.marcadorPendiente = {
      repuestoId,
      mapId,
      areaId
    };
    
    // Cambiar cursor
    if (this.elements.canvas) {
      this.elements.canvas.style.cursor = 'crosshair';
    }
    
    // Mostrar instruccin segn modo
    const mensaje = modoEdicion 
      ? ' Haz clic en el rea para cambiar la posicin del marcador'
      : ' Haz clic en el rea resaltada para colocar el marcador';
    
    this.showToast(mensaje, 'info', 5000);
    
    console.log(` Modo marcador activado para repuesto: ${repuestoId} (edicin: ${modoEdicion})`);
  },

  //  NUEVO: Colocar marcador en el mapa
  async colocarMarcador(x, y) {
    if (!this.state.modoMarcador || !this.state.marcadorPendiente) return;
    
    const { repuestoId, mapId, areaId } = this.state.marcadorPendiente;
    
    console.log(' Colocando marcador en:', { x, y });
    console.log('   rea objetivo:', areaId);
    console.log('   reas disponibles:', this.state.areas.length);
    
    //  NUEVA LGICA: Buscar reas cercanas al click (radio aumentado a 300px)
    const areasEncontradas = this.buscarAreasCercanas(x, y, 300);
    
    console.log(' reas encontradas cerca del click:', areasEncontradas);
    
    // Si no hay reas cercanas, buscar especficamente el rea asignada
    if (areasEncontradas.length === 0) {
      const areaAsignada = this.state.areas.find(a => String(a.id) === String(areaId));
      console.log('   Buscando rea asignada:', areaAsignada?.name);
      
      if (areaAsignada) {
        // Calcular distancia al rea asignada
        const distancia = this.distanciaPuntoAArea(x, y, areaAsignada);
        console.log('   Distancia al rea asignada:', distancia, 'px');
        
        // Si est dentro o relativamente cerca (hasta 500px), aceptarlo
        if (distancia <= 500) {
          areasEncontradas.push({ area: areaAsignada, distancia, dentro: this.puntoEnArea(x, y, areaAsignada) });
          console.log('    rea asignada incluida (distancia aceptable)');
        }
      }
    }
    
    // Si TODAVA no hay reas, mostrar error con ms info
    if (areasEncontradas.length === 0) {
      const areaAsignada = this.state.areas.find(a => String(a.id) === String(areaId));
      const distancia = areaAsignada ? Math.round(this.distanciaPuntoAArea(x, y, areaAsignada)) : 'N/A';
      this.showToast(` Click muy lejos del rea "${areaAsignada?.name || 'desconocida'}" (${distancia}px). Haz zoom y acrcate ms al rea resaltada.`, 'warning', 5000);
      return;
    }
    
    // Si hay exactamente 1 rea, usarla directamente
    if (areasEncontradas.length === 1) {
      await this.confirmarMarcador(x, y, areasEncontradas[0].area, repuestoId, mapId);
      return;
    }
    
    // Si hay mltiples reas, mostrar men de seleccin
    this.mostrarMenuSeleccionArea(x, y, areasEncontradas, repuestoId, mapId);
  },

  //  NUEVO: Buscar reas cercanas a un punto
  buscarAreasCercanas(x, y, radio = 100) {
    const areasEncontradas = [];
    
    for (const area of this.state.areas) {
      if (!area.points || area.points.length < 3) continue;
      
      // 1. Verificar si est dentro del rea (prioridad mxima)
      if (this.puntoEnArea(x, y, area)) {
        areasEncontradas.push({ area, distancia: 0, dentro: true });
        continue;
      }
      
      // 2. Calcular distancia al borde del rea
      const distancia = this.distanciaPuntoAArea(x, y, area);
      
      if (distancia <= radio) {
        areasEncontradas.push({ area, distancia, dentro: false });
      }
    }
    
    // Ordenar por distancia (primero las que contienen el punto, luego por cercana)
    areasEncontradas.sort((a, b) => {
      if (a.dentro && !b.dentro) return -1;
      if (!a.dentro && b.dentro) return 1;
      return a.distancia - b.distancia;
    });
    
    return areasEncontradas;
  },

  //  NUEVO: Calcular distancia de un punto al borde de un rea
  distanciaPuntoAArea(x, y, area) {
    let distanciaMin = Infinity;
    
    for (let i = 0; i < area.points.length; i++) {
      const p1 = area.points[i];
      const p2 = area.points[(i + 1) % area.points.length];
      
      const distancia = this.distanciaPuntoASegmento(x, y, p1.x, p1.y, p2.x, p2.y);
      distanciaMin = Math.min(distanciaMin, distancia);
    }
    
    return distanciaMin;
  },

  //  NUEVO: Calcular distancia de un punto a un segmento de lnea
  distanciaPuntoASegmento(px, py, x1, y1, x2, y2) {
    const A = px - x1;
    const B = py - y1;
    const C = x2 - x1;
    const D = y2 - y1;

    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    let param = -1;

    if (lenSq !== 0) param = dot / lenSq;

    let xx, yy;

    if (param < 0) {
      xx = x1;
      yy = y1;
    } else if (param > 1) {
      xx = x2;
      yy = y2;
    } else {
      xx = x1 + param * C;
      yy = y1 + param * D;
    }

    const dx = px - xx;
    const dy = py - yy;
    return Math.sqrt(dx * dx + dy * dy);
  },

  //  NUEVO: Mostrar men contextual para seleccionar rea
  mostrarMenuSeleccionArea(x, y, areasEncontradas, repuestoId, mapId) {
    // Eliminar men previo si existe
    const menuPrevio = document.getElementById('areaSelectionMenu');
    if (menuPrevio) menuPrevio.remove();
    
    // Convertir coordenadas del mapa a coordenadas de pantalla
    const canvas = this.elements.canvas;
    const rect = canvas.getBoundingClientRect();
    const screenX = x * this.state.scale + this.state.offsetX + rect.left;
    const screenY = y * this.state.scale + this.state.offsetY + rect.top;
    
    // Crear men
    const menu = document.createElement('div');
    menu.id = 'areaSelectionMenu';
    menu.style.cssText = `
      position: fixed;
      left: ${screenX}px;
      top: ${screenY}px;
      background: rgba(15, 23, 42, 0.98);
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 10000;
      min-width: 250px;
      max-width: 350px;
      animation: fadeInScale 0.2s ease-out;
    `;
    
    // Ttulo
    const titulo = document.createElement('div');
    titulo.textContent = ' Selecciona el rea';
    titulo.style.cssText = `
      color: #60a5fa;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 14px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.3);
      padding-bottom: 8px;
    `;
    menu.appendChild(titulo);
    
    // Lista de reas
    areasEncontradas.forEach(({ area, distancia, dentro }) => {
      const boton = document.createElement('button');
      const icono = dentro ? '' : '';
      const distanciaTexto = dentro ? 'Click dentro' : `${Math.round(distancia)}px`;
      
      boton.textContent = `${icono} ${area.name}`;
      boton.style.cssText = `
        display: block;
        width: 100%;
        padding: 10px 12px;
        margin: 4px 0;
        background: ${dentro ? 'rgba(16, 185, 129, 0.2)' : 'rgba(59, 130, 246, 0.1)'};
        border: 1px solid ${dentro ? '#10b981' : '#3b82f6'};
        border-radius: 8px;
        color: ${dentro ? '#10b981' : '#60a5fa'};
        cursor: pointer;
        text-align: left;
        font-size: 13px;
        transition: all 0.2s;
        position: relative;
      `;
      
      // Badge de distancia
      const badge = document.createElement('span');
      badge.textContent = distanciaTexto;
      badge.style.cssText = `
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 11px;
        opacity: 0.7;
      `;
      boton.appendChild(badge);
      
      boton.onmouseover = () => {
        boton.style.background = dentro ? 'rgba(16, 185, 129, 0.3)' : 'rgba(59, 130, 246, 0.2)';
        boton.style.transform = 'translateX(4px)';
      };
      boton.onmouseout = () => {
        boton.style.background = dentro ? 'rgba(16, 185, 129, 0.2)' : 'rgba(59, 130, 246, 0.1)';
        boton.style.transform = 'translateX(0)';
      };
      
      boton.onclick = async () => {
        menu.remove();
        await this.confirmarMarcador(x, y, area, repuestoId, mapId);
      };
      
      menu.appendChild(boton);
    });
    
    // Botn cancelar
    const btnCancelar = document.createElement('button');
    btnCancelar.textContent = ' Cancelar';
    btnCancelar.style.cssText = `
      display: block;
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      border-radius: 8px;
      color: #f87171;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    `;
    btnCancelar.onmouseover = () => {
      btnCancelar.style.background = 'rgba(239, 68, 68, 0.2)';
    };
    btnCancelar.onmouseout = () => {
      btnCancelar.style.background = 'rgba(239, 68, 68, 0.1)';
    };
    btnCancelar.onclick = () => menu.remove();
    menu.appendChild(btnCancelar);
    
    document.body.appendChild(menu);
    
    // Cerrar al hacer click fuera
    setTimeout(() => {
      const cerrarMenu = (e) => {
        if (!menu.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', cerrarMenu);
        }
      };
      document.addEventListener('click', cerrarMenu);
    }, 100);
  },

  //  NUEVO: Confirmar y guardar marcador en rea seleccionada
  async confirmarMarcador(x, y, area, repuestoId, mapId) {
    console.log(' rea seleccionada:', area.name);
    console.log(' Coordenadas del marcador:', { x, y });
    
    try {
      const repuesto = app.repuestos.find(r => String(r.id) === String(repuestoId));
      if (!repuesto) {
        this.showToast(' Repuesto no encontrado', 'error');
        return;
      }
      
      //  MODO EDICIN: Actualizar ubicacin existente
      if (window._editandoUbicacion && window._editandoUbicacion.modoEdicion) {
        const { indice } = window._editandoUbicacion;
        
        // Asegurar que existe el array de ubicaciones
        if (!repuesto.ubicaciones || !Array.isArray(repuesto.ubicaciones)) {
          repuesto.ubicaciones = [];
        }
        
        // Si estamos editando pero el array est vaco (migracin de formato antiguo)
        if (repuesto.ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
          repuesto.ubicaciones = [{
            mapId: repuesto.mapId,
            areaId: repuesto.areaId,
            markerX: repuesto.markerX,
            markerY: repuesto.markerY
          }];
          delete repuesto.mapId;
          delete repuesto.areaId;
          delete repuesto.markerX;
          delete repuesto.markerY;
        }
        
        // Actualizar ubicacin especfica
        if (repuesto.ubicaciones[indice]) {
          repuesto.ubicaciones[indice].mapId = mapId;
          repuesto.ubicaciones[indice].areaId = area.id;
          repuesto.ubicaciones[indice].markerX = x;
          repuesto.ubicaciones[indice].markerY = y;
          
          console.log(' Ubicacin actualizada en ndice:', indice);
          this.showToast(` Ubicacin de "${repuesto.nombre}" actualizada en "${area.name}"`, 'success');
        }
        
        // Limpiar modo edicin
        delete window._editandoUbicacion;
      } 
      //  MODO AGREGAR: Crear nueva ubicacin
      else {
        // Inicializar array de ubicaciones si no existe
        if (!repuesto.ubicaciones || !Array.isArray(repuesto.ubicaciones)) {
          repuesto.ubicaciones = [];
        }
        
        // Si hay datos en formato antiguo, migrarlos primero
        if (repuesto.mapId && repuesto.areaId && repuesto.ubicaciones.length === 0) {
          repuesto.ubicaciones.push({
            mapId: repuesto.mapId,
            areaId: repuesto.areaId,
            markerX: repuesto.markerX,
            markerY: repuesto.markerY
          });
          delete repuesto.mapId;
          delete repuesto.areaId;
          delete repuesto.markerX;
          delete repuesto.markerY;
        }
        
        //  VERIFICAR SI YA EXISTE una ubicacin en este mapa/rea (prevenir duplicados)
        const yaExiste = repuesto.ubicaciones.some(ub => 
          String(ub.mapId) === String(mapId) && String(ub.areaId) === String(area.id)
        );
        
        if (yaExiste) {
          console.warn(' Ya existe una ubicacin en este mapa/rea. Actualizando posicin...');
          // Actualizar la existente en lugar de agregar duplicado
          const ubicacionExistente = repuesto.ubicaciones.find(ub =>
            String(ub.mapId) === String(mapId) && String(ub.areaId) === String(area.id)
          );
          if (ubicacionExistente) {
            ubicacionExistente.markerX = x;
            ubicacionExistente.markerY = y;
            this.showToast(` Ubicacin actualizada en "${area.name}"`, 'success');
          }
        } else {
          // Agregar nueva ubicacin (sin duplicado)
          repuesto.ubicaciones.push({
            mapId: mapId,
            areaId: area.id,
            markerX: x,
            markerY: y
          });
          
          console.log(' Nueva ubicacin agregada. Total ubicaciones:', repuesto.ubicaciones.length);
          this.showToast(` "${repuesto.nombre}" ubicado en "${area.name}"`, 'success');
        }
      }
      
      // Guardar cambios
      await app.saveData();
      
      // Desactivar modo marcador
      this.state.modoMarcador = false;
      this.state.marcadorPendiente = null;
      
      if (this.elements.canvas) {
        this.elements.canvas.style.cursor = 'grab';
      }
      
      // Redibujar con el nuevo marcador
      this.draw();
      
      console.log(' Marcador guardado exitosamente');
    } catch (error) {
      console.error(' Error guardando marcador:', error);
      this.showToast(' Error al guardar la ubicacin', 'error');
    }
  },

  //  NUEVO: Verificar si un punto est dentro de un rea
  puntoEnArea(x, y, area) {
    if (!area || !area.points || area.points.length < 3) return false;
    
    // Algoritmo Ray Casting para determinar si el punto est dentro del polgono
    let inside = false;
    for (let i = 0, j = area.points.length - 1; i < area.points.length; j = i++) {
      const xi = area.points[i].x, yi = area.points[i].y;
      const xj = area.points[j].x, yj = area.points[j].y;
      
      const intersect = ((yi > y) !== (yj > y)) && 
                        (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    
    return inside;
  },

  //  NUEVO: Mostrar marcador en el canvas
  showMarker(x, y, label) {
    // Esta funcin se llamar desde el draw() para mostrar el marcador
    this.state.currentMarker = { x, y, label };
    this.draw();
  },

  //  NUEVA FUNCIN: Mostrar mltiples ubicaciones en el mapa
  async mostrarMultiplesUbicaciones(ubicaciones, repuesto) {
    if (!ubicaciones || ubicaciones.length === 0) return;
    
    console.log(` Mostrando ${ubicaciones.length} ubicaciones de "${repuesto.nombre}"`);
    
    // Agrupar ubicaciones por mapa
    const ubicacionesPorMapa = {};
    ubicaciones.forEach(ub => {
      if (!ubicacionesPorMapa[ub.mapId]) {
        ubicacionesPorMapa[ub.mapId] = [];
      }
      ubicacionesPorMapa[ub.mapId].push(ub);
    });
    
    // Si hay ubicaciones en mltiples mapas, preguntar cul mostrar
    const mapIds = Object.keys(ubicacionesPorMapa);
    
    if (mapIds.length > 1) {
      // Mostrar modal de seleccin de mapa
      let mapaSeleccionado = null;
      
      const mapasHTML = mapIds.map(mapId => {
        const mapa = mapStorage.maps.find(m => m.id === parseInt(mapId));
        const count = ubicacionesPorMapa[mapId].length;
        return `<option value="${mapId}">${mapa ? mapa.name : 'Mapa desconocido'} (${count} ubicaciones)</option>`;
      }).join('');
      
      // Usar el primer mapa por defecto
      mapaSeleccionado = parseInt(mapIds[0]);
    } else {
      mapaSeleccionado = parseInt(mapIds[0]);
    }
    
    // Cargar el mapa seleccionado
    await this.loadMap(mapaSeleccionado);
    
    const ubicacionesEnMapa = ubicacionesPorMapa[mapaSeleccionado];
    
    // Esperar a que se cargue el mapa
    setTimeout(() => {
      //  MEJORADO: Calcular zoom proporcional segn nmero de ubicaciones
      if (ubicacionesEnMapa.length > 0) {
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        
        ubicacionesEnMapa.forEach(ub => {
          if (ub.markerX && ub.markerY) {
            minX = Math.min(minX, ub.markerX);
            minY = Math.min(minY, ub.markerY);
            maxX = Math.max(maxX, ub.markerX);
            maxY = Math.max(maxY, ub.markerY);
          }
        });
        
        if (minX === Infinity) return;
        
        const canvas = this.elements.canvas;
        const centerX = (minX + maxX) / 2;
        const centerY = (minY + maxY) / 2;
        const width = maxX - minX;
        const height = maxY - minY;
        
        let targetScale, padding;
        
        //  ZOOM PROPORCIONAL segn cantidad de ubicaciones
        if (ubicacionesEnMapa.length === 1) {
          // UNA ubicacin: Zoom ms cercano (mostrar rea con detalle)
          if (ubicacionesEnMapa[0].areaId) {
            // Guardar ubicaciones resaltadas ANTES de hacer zoom
            this.state.ubicacionesResaltadas = ubicacionesEnMapa.map(ub => ({
              x: ub.markerX,
              y: ub.markerY,
              repuesto: repuesto.nombre,
              descripcion: ub.descripcion
            }));
            
            this.zoomToArea(ubicacionesEnMapa[0].areaId);
            
            // Redibujar para mostrar marcadores resaltados
            setTimeout(() => {
              this.draw();
            }, 100);
            
            return; // zoomToArea ya maneja el zoom
          } else {
            // Si no hay rea, zoom fijo cercano
            targetScale = 1.5;
            this.state.scale = targetScale;
            this.state.offsetX = canvas.width / 2 - centerX * targetScale;
            this.state.offsetY = canvas.height / 2 - centerY * targetScale;
          }
        } else if (ubicacionesEnMapa.length === 2) {
          // DOS ubicaciones: Zoom moderado con padding generoso
          padding = Math.max(width, height) * 0.8; // 80% de padding
          const scaleX = canvas.width / (width + padding);
          const scaleY = canvas.height / (height + padding);
          targetScale = Math.min(scaleX, scaleY, 1.2); // Mximo 1.2x para 2 puntos
          
          this.state.scale = Math.max(0.2, targetScale);
          this.state.offsetX = canvas.width / 2 - centerX * this.state.scale;
          this.state.offsetY = canvas.height / 2 - centerY * this.state.scale;
          
          console.log(` Zoom aplicado (2 ubicaciones): escala ${this.state.scale.toFixed(2)}x`);
        } else {
          // TRES O MS ubicaciones: Zoom ajustado para ver todas
          // Padding proporcional: menos padding para ms puntos
          const paddingFactor = Math.max(0.3, 1 - (ubicacionesEnMapa.length * 0.05)); // De 30% a 100%
          padding = Math.max(width, height) * paddingFactor;
          
          const scaleX = canvas.width / (width + padding);
          const scaleY = canvas.height / (height + padding);
          targetScale = Math.min(scaleX, scaleY, 1.0); // Mximo 1.0x para mltiples
          
          this.state.scale = Math.max(0.1, targetScale);
          this.state.offsetX = canvas.width / 2 - centerX * this.state.scale;
          this.state.offsetY = canvas.height / 2 - centerY * this.state.scale;
          
          console.log(` Zoom aplicado (${ubicacionesEnMapa.length} ubicaciones): escala ${this.state.scale.toFixed(2)}x`);
        }
      }
      
      // Resaltar reas con animacin pulsante
      const areasIds = [...new Set(ubicacionesEnMapa.map(ub => ub.areaId))];
      areasIds.forEach(areaId => {
        if (this.flashArea) {
          this.flashArea(areaId, 2); // Parpadear 2 veces
        } else if (this.highlightArea) {
          this.highlightArea(areaId);
        }
      });
      
      // Guardar temporalmente las ubicaciones resaltadas
      this.state.ubicacionesResaltadas = ubicacionesEnMapa.map(ub => ({
        x: ub.markerX,
        y: ub.markerY,
        repuesto: repuesto.nombre,
        descripcion: ub.descripcion
      }));
      
      this.draw();
      this.queueViewportPersist('multi-ubicaciones');
      
      app.showToast(` ${ubicacionesEnMapa.length} ubicaciones resaltadas en el mapa`, 'success');
    }, 500);
  },

  //  NUEVA FUNCIN: Detectar click en un marcador de repuesto
  detectarClickEnMarcador(mapX, mapY) {
    if (!app || !app.repuestos) return null;
    
    // console.log(` Detectando click en (${mapX.toFixed(0)}, ${mapY.toFixed(0)}) en mapa ${this.state.currentMapId}`); // Silenciado para reducir spam
    
    // Buscar todos los marcadores en el mapa actual
    for (const repuesto of app.repuestos) {
      // Formato NUEVO: array de ubicaciones
      if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones)) {
        for (let i = 0; i < repuesto.ubicaciones.length; i++) {
          const ub = repuesto.ubicaciones[i];
          if (String(ub.mapId) === String(this.state.currentMapId) && ub.markerX && ub.markerY) {
            // Calcular distancia al marcador
            const distancia = Math.sqrt(
              Math.pow(mapX - ub.markerX, 2) + 
              Math.pow(mapY - ub.markerY, 2)
            );
            
            //  Radio de deteccin MEJORADO: Ms grande cuando hay zoom alejado
            // Sin zoom (scale=1): 60px, Con zoom medio (scale=0.5): 120px, Muy alejado (scale=0.2): 300px
            const radioDeteccion = Math.max(40, Math.min(300, 60 / this.state.scale));
            
            // console.log(`   Marcador ${repuesto.nombre}[${i}]: distancia ${distancia.toFixed(0)}px, radio ${radioDeteccion.toFixed(0)}px, scale ${this.state.scale.toFixed(2)}`);
            
            if (distancia <= radioDeteccion) {
              console.log(`   CLICK DETECTADO en ${repuesto.nombre}[${i}]`);
              return {
                repuesto: repuesto,
                ubicacionIndex: i,
                ubicacion: ub,
                x: ub.markerX,
                y: ub.markerY
              };
            }
          }
        }
      }
      
      // Formato ANTIGUO: propiedades directas
      if (repuesto.mapId && String(repuesto.mapId) === String(this.state.currentMapId) && repuesto.markerX && repuesto.markerY) {
        const distancia = Math.sqrt(
          Math.pow(mapX - repuesto.markerX, 2) + 
          Math.pow(mapY - repuesto.markerY, 2)
        );
        
        const radioDeteccion = Math.max(40, Math.min(300, 60 / this.state.scale));
        
        if (distancia <= radioDeteccion) {
          console.log(`   CLICK DETECTADO en ${repuesto.nombre} (formato antiguo)`);
          return {
            repuesto: repuesto,
            ubicacionIndex: 0,
            ubicacion: {
              mapId: repuesto.mapId,
              areaId: repuesto.areaId,
              markerX: repuesto.markerX,
              markerY: repuesto.markerY,
              descripcion: repuesto.ubicacionDescripcion
            },
            x: repuesto.markerX,
            y: repuesto.markerY
          };
        }
      }
    }
    
    // console.log('   No se detectó click en ningún marcador'); // Silenciado para evitar spam en mousemove
    return null;
  },

  //  NUEVA FUNCIN: Mostrar men contextual al hacer click en un marcador
  mostrarMenuMarcador(marcadorInfo, screenX, screenY) {
    console.log(' Click en marcador:', marcadorInfo.repuesto.nombre);
    
    // Eliminar men previo si existe
    const menuPrevio = document.getElementById('marcadorContextMenu');
    if (menuPrevio) menuPrevio.remove();
    
    const { repuesto, ubicacionIndex, ubicacion } = marcadorInfo;
    const area = mapStorage.areas.find(a => a.id === ubicacion.areaId);
    const areaNombre = area ? area.name : 'Ubicacin';
    
    // Verificar si hay imagen
    const tieneImagen = (repuesto.imagenes && repuesto.imagenes.length > 0) || repuesto.imagen;
    
    // Crear men contextual
    const menuHTML = `
      <div id="marcadorContextMenu" style="
        position: fixed;
        left: ${screenX}px;
        top: ${screenY}px;
        background: var(--bg-primary);
        border: 2px solid var(--primary);
        border-radius: 8px;
        padding: 8px 0;
        min-width: 220px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        z-index: 10000;
        animation: fadeInScale 0.2s ease;
      ">
        <div style="
          padding: 8px 12px;
          font-weight: 600;
          color: var(--primary);
          border-bottom: 1px solid var(--border-color);
          font-size: 0.85rem;
        ">
           ${repuesto.nombre}
        </div>
        <div style="
          padding: 6px 12px;
          font-size: 0.75rem;
          color: var(--text-secondary);
          border-bottom: 1px solid var(--border-color);
        ">
          ${areaNombre}
          ${ubicacion.descripcion ? `<br><em>"${ubicacion.descripcion}"</em>` : ''}
        </div>
        <button onclick="mapController.verMarcadorEnMapa('${repuesto.id}', ${ubicacionIndex})" style="
          width: 100%;
          padding: 8px 12px;
          background: none;
          border: none;
          text-align: left;
          cursor: pointer;
          color: var(--text-primary);
          font-size: 0.85rem;
          transition: all 0.2s;
        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
           Ver en Mapa
        </button>
        <button onclick="mapController.moverMarcador('${repuesto.id}', ${ubicacionIndex})" style="
          width: 100%;
          padding: 8px 12px;
          background: none;
          border: none;
          text-align: left;
          cursor: pointer;
          color: var(--text-primary);
          font-size: 0.85rem;
          transition: all 0.2s;
        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
           Mover Marcador
        </button>
        ${tieneImagen ? `
        <button onclick="mapController.abrirModalImagenZoom('${repuesto.id}'); document.getElementById('marcadorContextMenu').remove();" style="
          width: 100%;
          padding: 8px 12px;
          background: none;
          border: none;
          text-align: left;
          cursor: pointer;
          color: var(--text-primary);
          font-size: 0.85rem;
          transition: all 0.2s;
        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
           Ver Imagen
        </button>
        ` : ''}
        <button onclick="app.editarDescripcionUbicacion('${repuesto.id}', ${ubicacionIndex}); document.getElementById('marcadorContextMenu').remove();" style="
          width: 100%;
          padding: 8px 12px;
          background: none;
          border: none;
          text-align: left;
          cursor: pointer;
          color: var(--text-primary);
          font-size: 0.85rem;
          transition: all 0.2s;
        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
           Editar Descripcin
        </button>
        <button onclick="app.irATarjeta('${repuesto.id}'); document.getElementById('marcadorContextMenu').remove();" style="
          width: 100%;
          padding: 8px 12px;
          background: none;
          border: none;
          text-align: left;
          cursor: pointer;
          color: var(--text-primary);
          font-size: 0.85rem;
          transition: all 0.2s;
        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
           Ver Repuesto
        </button>
        <button onclick="app.eliminarUbicacionRepuesto('${repuesto.id}', ${ubicacionIndex}); document.getElementById('marcadorContextMenu').remove();" style="
          width: 100%;
          padding: 8px 12px;
          background: none;
          border: none;
          text-align: left;
          cursor: pointer;
          color: var(--danger);
          font-size: 0.85rem;
          border-top: 1px solid var(--border-color);
          transition: all 0.2s;
          margin-top: 4px;
        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
           Eliminar Ubicacin
        </button>
        <button onclick="document.getElementById('marcadorContextMenu').remove()" style="
          width: 100%;
          padding: 6px 12px;
          background: none;
          border: none;
          text-align: center;
          cursor: pointer;
          color: var(--text-muted);
          font-size: 0.75rem;
          border-top: 1px solid var(--border-color);
          margin-top: 4px;
        ">
          Cerrar
        </button>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', menuHTML);
    
    // Cerrar men al hacer click fuera
    setTimeout(() => {
      const cerrarMenu = (e) => {
        const menu = document.getElementById('marcadorContextMenu');
        if (menu && !menu.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', cerrarMenu);
        }
      };
      document.addEventListener('click', cerrarMenu);
    }, 100);
  },

  //  NUEVA FUNCIN: Ver marcador en mapa (sin modal de edicin)
  async verMarcadorEnMapa(repuestoId, ubicacionIndex) {
    const repuesto = app.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    // Cerrar men contextual y tarjeta fija
    const menu = document.getElementById('marcadorContextMenu');
    if (menu) menu.remove();
    this.cerrarTarjetaFija();
    
    let ubicaciones = repuesto.ubicaciones || [];
    if (ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
      ubicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY,
        descripcion: repuesto.ubicacionDescripcion
      }];
    }
    
    const ubicacion = ubicaciones[ubicacionIndex];
    if (!ubicacion) return;
    
    const area = mapStorage.areas.find(a => a.id === ubicacion.areaId);
    const areaNombre = area ? area.name : 'rea desconocida';
    
    //  FILTRAR: Mostrar solo los puntos de este repuesto
    this.state.repuestoFiltrado = repuestoId;
    
    // Mostrar toast informativo
    this.showToast(` Filtrando "${repuesto.nombre}" - ${ubicaciones.length} ubicacin(es). Doble click afuera para limpiar filtro.`, 'info', 3000);
    
    // Cargar mapa y hacer zoom
    await this.loadMap(ubicacion.mapId);
    
    setTimeout(() => {
      // Hacer zoom al rea con el marcador
      this.zoomToArea(ubicacion.areaId);
      
      setTimeout(() => {
        //  Resaltar TODOS los marcadores de este repuesto en el mapa actual
        const marcadoresEnMapa = ubicaciones.filter(ub => 
          String(ub.mapId) === String(this.state.currentMapId) && ub.markerX && ub.markerY
        );
        
        this.state.ubicacionesResaltadas = marcadoresEnMapa.map(ub => ({
          x: ub.markerX,
          y: ub.markerY,
          repuesto: repuesto.nombre,
          descripcion: ub.descripcion || 'Ubicacin del repuesto'
        }));
        
        console.log(` Resaltando ${this.state.ubicacionesResaltadas.length} ubicaciones de "${repuesto.nombre}"`);
        
        this.draw();
      }, 800);
    }, 500);
  },

  //  NUEVA FUNCIN: Abrir modal con zoom directo desde URL de imagen
  abrirModalImagenZoomDirecto(urlImagen, nombreRepuesto) {
    console.log(' Abriendo modal de imagen:', urlImagen);
    
    if (!urlImagen) {
      this.showToast(' No hay imagen para mostrar', 'error');
      return;
    }
    
    // Cerrar tarjeta fija si existe
    this.cerrarTarjetaFija();
    
    // Crear modal con imagen
    const modalHTML = `
      <div id="modalImagenZoom" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.95);
        z-index: 20000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
      " onclick="if(event.target.id === 'modalImagenZoom') mapController.cerrarModalImagenZoom()">
        <!-- Header -->
        <div style="
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          padding: 16px 24px;
          background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
          display: flex;
          justify-content: space-between;
          align-items: center;
          z-index: 2;
        ">
          <div style="
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
          ">
             ${nombreRepuesto || 'Imagen'}
          </div>
          <button onclick="mapController.cerrarModalImagenZoom(); event.stopPropagation();" style="
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            padding: 8px 16px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
             Cerrar
          </button>
        </div>
        
        <!-- Indicador de Zoom (solo lectura) -->
        <div style="
          position: absolute;
          bottom: 24px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0, 0, 0, 0.8);
          border: 2px solid rgba(255, 255, 255, 0.2);
          border-radius: 12px;
          padding: 12px 24px;
          z-index: 2;
          pointer-events: none;
        ">
          <span id="zoomImagenLabel" style="
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
          "> 100% (usa el scroll para zoom)</span>
        </div>
        
        <!-- Container de imagen con scroll -->
        <div id="imagenZoomContainer" style="
          flex: 1;
          width: 100%;
          height: 100%;
          overflow: auto;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 80px 24px 120px;
          cursor: grab;
        ">
          <img id="imagenZoomable" src="${urlImagen}" style="
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.2s ease;
            user-select: none;
            -webkit-user-drag: none;
          " draggable="false" onclick="event.stopPropagation()">
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Inicializar estado de zoom
    this.state.imagenZoom = {
      scale: 1.0,
      offsetX: 0,
      offsetY: 0,
      isDragging: false,
      startX: 0,
      startY: 0
    };
    
    // Configurar eventos
    const img = document.getElementById('imagenZoomable');
    const container = document.getElementById('imagenZoomContainer');
    
    // Arrastre para pan
    img.addEventListener('mousedown', (e) => {
      if (this.state.imagenZoom.scale > 1.0) {
        e.preventDefault();
        e.stopPropagation();
        this.state.imagenZoom.isDragging = true;
        this.state.imagenZoom.startX = e.clientX - this.state.imagenZoom.offsetX;
        this.state.imagenZoom.startY = e.clientY - this.state.imagenZoom.offsetY;
        container.style.cursor = 'grabbing';
      }
    });
    
    container.addEventListener('mousemove', (e) => {
      if (this.state.imagenZoom.isDragging) {
        this.state.imagenZoom.offsetX = e.clientX - this.state.imagenZoom.startX;
        this.state.imagenZoom.offsetY = e.clientY - this.state.imagenZoom.startY;
        this.actualizarTransformImagen();
      }
    });
    
    container.addEventListener('mouseup', () => {
      this.state.imagenZoom.isDragging = false;
      if (this.state.imagenZoom.scale > 1.0) {
        container.style.cursor = 'grab';
      }
    });
    
    container.addEventListener('mouseleave', () => {
      this.state.imagenZoom.isDragging = false;
      if (this.state.imagenZoom.scale > 1.0) {
        container.style.cursor = 'grab';
      }
    });
    
    // Zoom con rueda del mouse
    container.addEventListener('wheel', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      this.ajustarZoomImagen(delta);
    }, { passive: false });
    
    // Cerrar con ESC
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        this.cerrarModalImagenZoom();
        document.removeEventListener('keydown', handleEsc);
      }
    };
    document.addEventListener('keydown', handleEsc);
  },

  //  FUNCIN ORIGINAL: Abrir modal con imagen ampliada y zoom (desde FileSystem)
  async abrirModalImagenZoom(repuestoId) {
    const repuesto = app.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    // Cerrar tarjeta fija si existe
    this.cerrarTarjetaFija();
    
    // Obtener ruta de la imagen
    let imagePath = null;
    if (repuesto.imagenes && repuesto.imagenes.length > 0) {
      imagePath = repuesto.imagenes[0].path;
    } else if (repuesto.imagen) {
      imagePath = repuesto.imagen;
    }
    
    if (!imagePath) {
      this.showToast(' Este repuesto no tiene imagen', 'error');
      return;
    }
    
    // Verificar si el archivo existe
    let fileHandle = null;
    try {
      fileHandle = await app.dirHandle.getFileHandle(imagePath);
    } catch (error) {
      this.showToast(' No se encontr la imagen', 'error');
      return;
    }
    
    // Crear modal con imagen
    const modalHTML = `
      <div id="modalImagenZoom" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.95);
        z-index: 20000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
      ">
        <!-- Header -->
        <div style="
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          padding: 16px 24px;
          background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
          display: flex;
          justify-content: space-between;
          align-items: center;
          z-index: 2;
        ">
          <div style="
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
          ">
             ${repuesto.nombre}
          </div>
          <button onclick="mapController.cerrarModalImagenZoom()" style="
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            padding: 8px 16px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
             Cerrar
          </button>
        </div>
        
        <!-- Indicador de Zoom (solo lectura) -->
        <div style="
          position: absolute;
          bottom: 24px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0, 0, 0, 0.8);
          border: 2px solid rgba(255, 255, 255, 0.2);
          border-radius: 12px;
          padding: 12px 24px;
          z-index: 2;
          pointer-events: none;
        ">
          <span id="zoomImagenLabel" style="
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
          "> 100% (usa el scroll para zoom)</span>
        </div>
        
        <!-- Container de imagen con scroll -->
        <div id="imagenZoomContainer" style="
          flex: 1;
          width: 100%;
          height: 100%;
          overflow: auto;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 80px 24px 120px;
          cursor: grab;
        ">
          <img id="imagenZoomable" src="" style="
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.2s ease;
            user-select: none;
            -webkit-user-drag: none;
          " draggable="false">
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Cargar imagen
    try {
      const file = await fileHandle.getFile();
      const url = URL.createObjectURL(file);
      const img = document.getElementById('imagenZoomable');
      img.src = url;
      
      // Inicializar estado de zoom
      this.state.imagenZoom = {
        scale: 1.0,
        offsetX: 0,
        offsetY: 0,
        isDragging: false,
        startX: 0,
        startY: 0
      };
      
      // Configurar eventos de arrastre para pan
      const container = document.getElementById('imagenZoomContainer');
      
      img.addEventListener('mousedown', (e) => {
        if (this.state.imagenZoom.scale > 1.0) {
          e.preventDefault();
          this.state.imagenZoom.isDragging = true;
          this.state.imagenZoom.startX = e.clientX - this.state.imagenZoom.offsetX;
          this.state.imagenZoom.startY = e.clientY - this.state.imagenZoom.offsetY;
          container.style.cursor = 'grabbing';
        }
      });
      
      container.addEventListener('mousemove', (e) => {
        if (this.state.imagenZoom.isDragging) {
          this.state.imagenZoom.offsetX = e.clientX - this.state.imagenZoom.startX;
          this.state.imagenZoom.offsetY = e.clientY - this.state.imagenZoom.startY;
          this.actualizarTransformImagen();
        }
      });
      
      container.addEventListener('mouseup', () => {
        this.state.imagenZoom.isDragging = false;
        if (this.state.imagenZoom.scale > 1.0) {
          container.style.cursor = 'grab';
        }
      });
      
      container.addEventListener('mouseleave', () => {
        this.state.imagenZoom.isDragging = false;
        if (this.state.imagenZoom.scale > 1.0) {
          container.style.cursor = 'grab';
        }
      });
      
      // Zoom con rueda del mouse
      container.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        this.ajustarZoomImagen(delta);
      }, { passive: false });
      
      // Cerrar con ESC
      const handleEsc = (e) => {
        if (e.key === 'Escape') {
          this.cerrarModalImagenZoom();
          document.removeEventListener('keydown', handleEsc);
        }
      };
      document.addEventListener('keydown', handleEsc);
      
    } catch (error) {
      console.error('Error cargando imagen:', error);
      this.showToast(' Error al cargar la imagen', 'error');
      this.cerrarModalImagenZoom();
    }
  },

  ajustarZoomImagen(delta) {
    if (!this.state.imagenZoom) return;
    
    this.state.imagenZoom.scale = Math.max(0.5, Math.min(5.0, this.state.imagenZoom.scale + delta));
    
    // Actualizar cursor
    const container = document.getElementById('imagenZoomContainer');
    if (this.state.imagenZoom.scale > 1.0) {
      container.style.cursor = 'grab';
    } else {
      container.style.cursor = 'default';
      this.state.imagenZoom.offsetX = 0;
      this.state.imagenZoom.offsetY = 0;
    }
    
    this.actualizarTransformImagen();
  },

  resetearZoomImagen() {
    if (!this.state.imagenZoom) return;
    
    this.state.imagenZoom.scale = 1.0;
    this.state.imagenZoom.offsetX = 0;
    this.state.imagenZoom.offsetY = 0;
    
    const container = document.getElementById('imagenZoomContainer');
    container.style.cursor = 'default';
    
    this.actualizarTransformImagen();
  },

  actualizarTransformImagen() {
    const img = document.getElementById('imagenZoomable');
    const label = document.getElementById('zoomImagenLabel');
    
    if (img) {
      img.style.transform = `scale(${this.state.imagenZoom.scale}) translate(${this.state.imagenZoom.offsetX / this.state.imagenZoom.scale}px, ${this.state.imagenZoom.offsetY / this.state.imagenZoom.scale}px)`;
    }
    
    if (label) {
      const porcentaje = Math.round(this.state.imagenZoom.scale * 100);
      label.textContent = ` ${porcentaje}%${porcentaje === 100 ? ' (usa el scroll para zoom)' : ''}`;
    }
  },

  cerrarModalImagenZoom() {
    const modal = document.getElementById('modalImagenZoom');
    if (modal) {
      // Liberar URL de objeto
      const img = document.getElementById('imagenZoomable');
      if (img && img.src.startsWith('blob:')) {
        URL.revokeObjectURL(img.src);
      }
      modal.remove();
    }
    this.state.imagenZoom = null;
  },

  //  NUEVA FUNCIN: Mostrar tarjeta hover simplificada al pasar sobre un repuesto
  mostrarTarjetaHoverRepuesto(marcadorInfo, screenX, screenY) {
    const { repuesto, ubicacion } = marcadorInfo;
    
    // Si hay una tarjeta fija, no mostrar hover
    if (document.getElementById('tarjetaHoverRepuesto')?.dataset.fija === 'true') {
      return;
    }
    
    // Evitar recrear la tarjeta constantemente
    let tarjeta = document.getElementById('tarjetaHoverRepuesto');
    if (tarjeta && tarjeta.dataset.repuestoId === String(repuesto.id)) {
      // Ya existe y es para el mismo repuesto, solo actualizar posicin
      tarjeta.style.left = (screenX + 20) + 'px';
      tarjeta.style.top = (screenY - 10) + 'px';
      return;
    }
    
    // Eliminar tarjeta anterior si existe
    if (tarjeta) tarjeta.remove();
    
    this.crearTarjetaRepuesto(repuesto, ubicacion, screenX, screenY, false);
  },

  //  NUEVA FUNCIN: Fijar tarjeta hover al hacer click
  fijarTarjetaHoverRepuesto(marcadorInfo, screenX, screenY) {
    const { repuesto, ubicacion, ubicacionIndex } = marcadorInfo;
    
    // Eliminar tarjeta anterior (hover o fija)
    const tarjetaAnterior = document.getElementById('tarjetaHoverRepuesto');
    if (tarjetaAnterior) tarjetaAnterior.remove();
    
    this.crearTarjetaRepuesto(repuesto, ubicacion, screenX, screenY, true, ubicacionIndex);
  },

  //  NUEVA FUNCIN: Crear tarjeta de repuesto (compartida entre hover y fija)
  crearTarjetaRepuesto(repuesto, ubicacion, screenX, screenY, esFija = false, ubicacionIndex = 0) {
    // Obtener informacin del repuesto
    const area = mapStorage.areas.find(a => a.id === ubicacion.areaId);
    const areaNombre = area ? area.name : 'rea desconocida';
    const cantidad = repuesto.cantidad || 0;
    const minimo = repuesto.minimo || 0;
    const optimo = repuesto.optimo || 0;
    
    //  Calcular escala de texto segn el zoom del mapa
    // Zoom 1.0 = 100%, Zoom 2.0 = 80%, Zoom 3.0 = 70%, etc.
    const zoom = this.state.zoom || 1.0;
    const factorEscala = Math.max(0.6, 1.0 / Math.sqrt(zoom)); // Mnimo 60%, mximo 100%
    
    const fontSize = {
      titulo: (1.0 * factorEscala).toFixed(2) + 'rem',
      subtitulo: (0.8 * factorEscala).toFixed(2) + 'rem',
      codigo: (0.75 * factorEscala).toFixed(2) + 'rem',
      label: (0.7 * factorEscala).toFixed(2) + 'rem',
      stock: (1.1 * factorEscala).toFixed(2) + 'rem',
      stockDetalle: (0.95 * factorEscala).toFixed(2) + 'rem',
      boton: (0.8 * factorEscala).toFixed(2) + 'rem'
    };
    
    const anchoTarjeta = Math.round(300 * factorEscala);
    const padding = Math.round(14 * factorEscala);
    
    // Determinar estado de stock
    let estadoStock = '';
    let colorStock = '';
    if (cantidad === 0) {
      estadoStock = 'SIN STOCK';
      colorStock = '#ef4444';
    } else if (cantidad < minimo) {
      estadoStock = 'BAJO';
      colorStock = '#f59e0b';
    } else if (cantidad >= optimo) {
      estadoStock = 'PTIMO';
      colorStock = '#22c55e';
    } else {
      estadoStock = 'NORMAL';
      colorStock = '#3b82f6';
    }
    
    // Crear galera de imgenes si existen
    let imagenesHTML = '';
    if (repuesto.multimedia && repuesto.multimedia.length > 0) {
      // Filtrar solo imgenes y eliminar duplicados por URL
      const todasImagenes = repuesto.multimedia.filter(m => m.type === 'image');
      
      // Eliminar duplicados usando un Set con las URLs
      const urlsUnicas = new Set();
      const imagenes = todasImagenes.filter(img => {
        const url = img.url || '';
        if (url && !urlsUnicas.has(url)) {
          urlsUnicas.add(url);
          return true;
        }
        return false;
      }).slice(0, 5); // Mximo 5 imgenes nicas
      
      console.log(` Repuesto "${repuesto.nombre}": ${todasImagenes.length} imgenes totales  ${imagenes.length} nicas`);
      
      if (imagenes.length > 0) {
        const alturaImagen = Math.round(140 * factorEscala);
        
        //  CARRUSEL DE IMGENES
        imagenesHTML = `
          <div id="carruselContainer" style="position: relative; margin-bottom: ${Math.round(12 * factorEscala)}px;">
            <!-- Imgenes del carrusel -->
            <div id="carruselImagenes" style="
              width: 100%;
              height: ${alturaImagen}px;
              position: relative;
              overflow: hidden;
              border-radius: ${Math.round(6 * factorEscala)}px;
              border: 1px solid rgba(255,255,255,0.1);
            ">
              ${imagenes.map((img, idx) => {
                //  Resolver ruta de imagen correctamente
                let urlImagen = img.url || '';
                
                //  Detectar si estamos en servidor HTTP o FileSystem local
                const isHTTPMode = window.location.protocol === 'http:' || window.location.protocol === 'https:';
                
                if (isHTTPMode) {
                  //  Modo HTTP - usar rutas relativas del servidor
                  if (urlImagen.startsWith('./imagenes/')) {
                    urlImagen = 'INVENTARIO_STORAGE/' + urlImagen.substring(2);
                  } else if (urlImagen.startsWith('imagenes/')) {
                    urlImagen = 'INVENTARIO_STORAGE/' + urlImagen;
                  } else if (!urlImagen.startsWith('INVENTARIO_STORAGE/')) {
                    urlImagen = 'INVENTARIO_STORAGE/imagenes/' + urlImagen;
                  }
                  // Codificar espacios para URLs HTTP
                  urlImagen = urlImagen.replace(/ /g, '%20');
                } else {
                  //  Modo FileSystem - las imágenes no se pueden cargar directamente
                  //  Mostrar placeholder o mensaje
                  console.warn(' Modo FileSystem: imágenes no disponibles en tarjetas hover');
                  urlImagen = ''; // Esto mostrará el placeholder
                }
                
                console.log(' [HTTP:${isHTTPMode}] URL imagen:', urlImagen);
                
                const urlImagenCodificada = urlImagen;
                
                return `
                  <div class="carrusel-item" data-index="${idx}" 
                    onclick="mapController.abrirModalImagenZoomDirecto('${urlImagenCodificada.replace(/'/g, "\\'")}', '${repuesto.nombre.replace(/'/g, "\\'")}'); event.stopPropagation();"
                    style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: url('${urlImagenCodificada}') center/cover no-repeat, linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(37,99,235,0.1) 100%);
                    opacity: ${idx === 0 ? '1' : '0'};
                    transition: opacity 0.3s ease-in-out;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: zoom-in;
                  ">
                    ${!urlImagen ? '<div style="font-size: 3rem; opacity: 0.3;"></div>' : ''}
                    ${urlImagen ? '<div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; pointer-events: none;"> Click para ampliar</div>' : ''}
                  </div>
                `;
              }).join('')}
            </div>
            
            ${imagenes.length > 1 ? `
              <!-- Flechas de navegacin -->
              <button onclick="mapController.anteriorImagenCarrusel(event)" style="
                position: absolute;
                left: ${Math.round(8 * factorEscala)}px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(0,0,0,0.7);
                color: white;
                border: none;
                border-radius: 50%;
                width: ${Math.round(32 * factorEscala)}px;
                height: ${Math.round(32 * factorEscala)}px;
                cursor: pointer;
                font-size: ${Math.round(18 * factorEscala)}px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
                transition: all 0.2s;
              " onmouseenter="this.style.background='rgba(0,0,0,0.9)'" onmouseleave="this.style.background='rgba(0,0,0,0.7)'">
                
              </button>
              <button onclick="mapController.siguienteImagenCarrusel(event)" style="
                position: absolute;
                right: ${Math.round(8 * factorEscala)}px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(0,0,0,0.7);
                color: white;
                border: none;
                border-radius: 50%;
                width: ${Math.round(32 * factorEscala)}px;
                height: ${Math.round(32 * factorEscala)}px;
                cursor: pointer;
                font-size: ${Math.round(18 * factorEscala)}px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
                transition: all 0.2s;
              " onmouseenter="this.style.background='rgba(0,0,0,0.9)'" onmouseleave="this.style.background='rgba(0,0,0,0.7)'">
                
              </button>
              
              <!-- Indicadores (dots) -->
              <div style="
                position: absolute;
                bottom: ${Math.round(8 * factorEscala)}px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: ${Math.round(6 * factorEscala)}px;
                z-index: 10;
              ">
                ${imagenes.map((_, idx) => `
                  <div class="carrusel-dot" data-index="${idx}" style="
                    width: ${Math.round(8 * factorEscala)}px;
                    height: ${Math.round(8 * factorEscala)}px;
                    border-radius: 50%;
                    background: ${idx === 0 ? 'white' : 'rgba(255,255,255,0.4)'};
                    cursor: pointer;
                    transition: background 0.3s;
                  " onclick="mapController.irAImagenCarrusel(${idx}, event)"></div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }
    }
    
    // Botones solo si es tarjeta fija
    let botonesHTML = '';
    if (esFija) {
      const btnPadding = `${Math.round(8 * factorEscala)}px ${Math.round(12 * factorEscala)}px`;
      const btnBorderRadius = Math.round(6 * factorEscala) + 'px';
      const btnGap = Math.round(6 * factorEscala) + 'px';
      
      botonesHTML = `
        <div style="
          display: grid;
          grid-template-columns: 1fr 1fr 1fr;
          gap: ${btnGap};
          margin-top: ${Math.round(12 * factorEscala)}px;
          padding-top: ${Math.round(12 * factorEscala)}px;
          border-top: 1px solid rgba(255,255,255,0.1);
        ">
          <button onclick="mapController.verMarcadorEnMapa('${repuesto.id}', ${ubicacionIndex}); event.stopPropagation();" style="
            padding: ${btnPadding};
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: ${btnBorderRadius};
            font-size: ${fontSize.boton};
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform='translateY(0)'">
             Ver
          </button>
          <button onclick="mapController.openEditMarkerModal('${repuesto.id}', ${ubicacionIndex}); event.stopPropagation();" style="
            padding: ${btnPadding};
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            border-radius: ${btnBorderRadius};
            font-size: ${fontSize.boton};
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform='translateY(0)'">
            E Datos
          </button>
          <button onclick="mapController.moverMarcador('${repuesto.id}', ${ubicacionIndex}); event.stopPropagation();" style="
            padding: ${btnPadding};
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: ${btnBorderRadius};
            font-size: ${fontSize.boton};
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform='translateY(0)'">
             Mover
          </button>
        </div>
        <div style="
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: ${btnGap};
          margin-top: ${btnGap};
        ">
          <button onclick="mapController.irATarjetaDesdeMapa('${repuesto.id}'); event.stopPropagation();" style="
            padding: ${btnPadding};
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: ${btnBorderRadius};
            font-size: ${fontSize.boton};
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
             Tarjeta
          </button>
          <button onclick="app.eliminarUbicacionRepuesto('${repuesto.id}', ${ubicacionIndex}); mapController.cerrarTarjetaFija(); event.stopPropagation();" style="
            padding: ${btnPadding};
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
            border-radius: ${btnBorderRadius};
            font-size: ${fontSize.boton};
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseenter="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseleave="this.style.background='rgba(239, 68, 68, 0.2)'">
             Eliminar
          </button>
        </div>
      `;
    }
    
    const tarjetaHTML = `
      <div id="tarjetaHoverRepuesto" 
           data-repuesto-id="${repuesto.id}" 
           data-fija="${esFija}"
           style="
        position: fixed;
        left: ${screenX + 20}px;
        top: ${screenY - 10}px;
        background: rgba(15, 23, 42, 0.98);
        color: white;
        border-radius: ${Math.round(12 * factorEscala)}px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.1);
        z-index: 99999;
        width: ${anchoTarjeta}px;
        backdrop-filter: blur(20px);
        animation: fadeInCard 0.2s ease-out;
        ${esFija ? 'pointer-events: auto; cursor: default;' : 'pointer-events: none;'}
      ">
        <style>
          @keyframes fadeInCard {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
          }
        </style>
        
        <div style="padding: ${padding}px;">
          ${imagenesHTML}
          
          <!-- Ttulo -->
          <div style="font-weight: 700; font-size: ${fontSize.titulo}; margin-bottom: ${Math.round(8 * factorEscala)}px; line-height: 1.3;">
            ${repuesto.nombre}
          </div>
          
          <!-- Cdigos -->
          ${repuesto.codigoSAP || repuesto.codigoFabrica ? `
            <div style="font-size: ${fontSize.codigo}; opacity: 0.7; margin-bottom: ${Math.round(10 * factorEscala)}px; font-family: 'Courier New', monospace;">
              ${repuesto.codigoSAP ? `SAP: ${repuesto.codigoSAP}` : ''}
              ${repuesto.codigoSAP && repuesto.codigoFabrica ? ' | ' : ''}
              ${repuesto.codigoFabrica ? `FAB: ${repuesto.codigoFabrica}` : ''}
            </div>
          ` : ''}
          
          <!-- Stock -->
          <div style="
            display: flex;
            gap: ${Math.round(8 * factorEscala)}px;
            margin-bottom: ${Math.round(10 * factorEscala)}px;
            padding: ${Math.round(8 * factorEscala)}px ${Math.round(10 * factorEscala)}px;
            background: rgba(255,255,255,0.05);
            border-radius: ${Math.round(6 * factorEscala)}px;
            border-left: ${Math.round(3 * factorEscala)}px solid ${colorStock};
          ">
            <div style="flex: 1;">
              <div style="font-size: ${fontSize.label}; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px;">Stock</div>
              <div style="font-size: ${fontSize.stock}; font-weight: 700; color: ${colorStock};">${cantidad}</div>
            </div>
            <div style="flex: 1;">
              <div style="font-size: ${fontSize.label}; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px;">Mn</div>
              <div style="font-size: ${fontSize.stockDetalle}; font-weight: 600;">${minimo}</div>
            </div>
            <div style="flex: 1;">
              <div style="font-size: ${fontSize.label}; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px;">pt</div>
              <div style="font-size: ${fontSize.stockDetalle}; font-weight: 600;">${optimo}</div>
            </div>
          </div>
          
          <!-- Estado -->
          <div style="
            display: inline-block;
            padding: ${Math.round(4 * factorEscala)}px ${Math.round(10 * factorEscala)}px;
            background: ${colorStock}22;
            border: 1px solid ${colorStock};
            border-radius: ${Math.round(6 * factorEscala)}px;
            font-size: ${fontSize.label};
            font-weight: 700;
            color: ${colorStock};
            letter-spacing: 0.5px;
            margin-bottom: ${Math.round(8 * factorEscala)}px;
          ">
            ${estadoStock}
          </div>
          
          <!-- Ubicacin -->
          <div style="
            font-size: ${fontSize.subtitulo};
            opacity: 0.8;
            padding-top: ${Math.round(8 * factorEscala)}px;
            border-top: 1px solid rgba(255,255,255,0.1);
          ">
             ${areaNombre}
          </div>
          
          ${botonesHTML}
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', tarjetaHTML);
    
    // Si es fija, agregar event listener para cerrar al hacer click fuera
    if (esFija) {
      //  MEJORA: Delay ms largo para asegurar que el click se procese
      setTimeout(() => {
        const cerrarAlClickFuera = (e) => {
          const tarjeta = document.getElementById('tarjetaHoverRepuesto');
          // Verificar si el click fue en un marcador del canvas
          const canvas = document.getElementById('mapCanvas');
          const esClickEnCanvas = canvas && canvas.contains(e.target);
          
          if (tarjeta && !tarjeta.contains(e.target)) {
            // Si es click en canvas, verificar si es en un marcador
            if (esClickEnCanvas) {
              // Dejar que el mousedown del canvas maneje esto
              return;
            }
            
            tarjeta.remove();
            document.removeEventListener('click', cerrarAlClickFuera);
          }
        };
        document.addEventListener('click', cerrarAlClickFuera);
      }, 200); // Aumentado de 100 a 200ms
    }
  },

  //  NUEVA FUNCIN: Ocultar tarjeta hover (solo si NO es fija)
  ocultarTarjetaHoverRepuesto() {
    const tarjeta = document.getElementById('tarjetaHoverRepuesto');
    if (tarjeta && tarjeta.dataset.fija !== 'true') {
      tarjeta.remove();
    }
  },

  //  NUEVA FUNCIN: Cerrar tarjeta fija manualmente
  cerrarTarjetaFija() {
    const tarjeta = document.getElementById('tarjetaHoverRepuesto');
    if (tarjeta && tarjeta.dataset.fija === 'true') {
      tarjeta.remove();
    }
  },

  //  FUNCIONES DEL CARRUSEL DE IMGENES
  siguienteImagenCarrusel(event) {
    event.stopPropagation();
    const items = document.querySelectorAll('.carrusel-item');
    if (items.length <= 1) return;
    
    let currentIndex = 0;
    items.forEach((item, idx) => {
      if (item.style.opacity === '1') currentIndex = idx;
    });
    
    const nextIndex = (currentIndex + 1) % items.length;
    this.mostrarImagenCarrusel(nextIndex);
  },

  anteriorImagenCarrusel(event) {
    event.stopPropagation();
    const items = document.querySelectorAll('.carrusel-item');
    if (items.length <= 1) return;
    
    let currentIndex = 0;
    items.forEach((item, idx) => {
      if (item.style.opacity === '1') currentIndex = idx;
    });
    
    const prevIndex = (currentIndex - 1 + items.length) % items.length;
    this.mostrarImagenCarrusel(prevIndex);
  },

  irAImagenCarrusel(index, event) {
    event.stopPropagation();
    this.mostrarImagenCarrusel(index);
  },

  mostrarImagenCarrusel(index) {
    const items = document.querySelectorAll('.carrusel-item');
    const dots = document.querySelectorAll('.carrusel-dot');
    
    items.forEach((item, idx) => {
      item.style.opacity = idx === index ? '1' : '0';
    });
    
    dots.forEach((dot, idx) => {
      dot.style.background = idx === index ? 'white' : 'rgba(255,255,255,0.4)';
    });
  },

  //  FUNCIN: Ir a tarjeta desde el mapa (cierra modal y navega)
  irATarjetaDesdeMapa(repuestoId) {
    console.log(' Navegando a tarjeta desde mapa:', repuestoId);
    
    // 1. Cerrar modal del mapa
    this.cerrarTarjetaFija();
    
    // 2. Cambiar a tab de inventario
    if (typeof app !== 'undefined' && app.irATarjeta) {
      // Pequeo delay para que el cierre del modal se complete
      setTimeout(() => {
        app.irATarjeta(repuestoId);
      }, 100);
    }
  },

  //  NUEVA FUNCIN: Activar modo mover marcador
  //  REDISEADO: Nueva funcin para mover marcador con modal de arrastre
  async moverMarcador(repuestoId, ubicacionIndex) {
    const repuesto = app.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    // Cerrar men contextual
    const menu = document.getElementById('marcadorContextMenu');
    if (menu) menu.remove();
    
    let ubicaciones = repuesto.ubicaciones || [];
    if (ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
      ubicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY,
        descripcion: repuesto.ubicacionDescripcion
      }];
      repuesto.ubicaciones = ubicaciones;
      delete repuesto.mapId;
      delete repuesto.areaId;
      delete repuesto.markerX;
      delete repuesto.markerY;
      delete repuesto.ubicacionDescripcion;
    }
    
    const ubicacion = ubicaciones[ubicacionIndex];
    if (!ubicacion) return;
    
    const area = mapStorage.areas.find(a => a.id === ubicacion.areaId);
    const mapa = mapStorage.maps.find(m => m.id === ubicacion.mapId);
    const areaNombre = area ? area.name : 'rea desconocida';
    const mapaNombre = mapa ? mapa.name : 'Mapa desconocido';
    
    // Cerrar modal de ubicaciones si est abierto
    const modalUbicaciones = document.getElementById('modalSeleccionUbicacion');
    if (modalUbicaciones) modalUbicaciones.remove();
    
    // Cambiar a tab de mapa
    app.switchTab('mapa');
    
    // Mostrar toast de carga
    this.showToast(' Cargando mapa...', 'info', 1500);
    
    // Cargar mapa y hacer zoom
    setTimeout(async () => {
      // Cargar el mapa
      await this.loadMap(ubicacion.mapId);
      
      setTimeout(() => {
        // Hacer zoom al rea con el marcador
        this.zoomToArea(ubicacion.areaId);
        
        setTimeout(() => {
          // Resaltar el marcador actual
          this.state.ubicacionesResaltadas = [{
            x: ubicacion.markerX,
            y: ubicacion.markerY,
            repuesto: repuesto.nombre,
            descripcion: ubicacion.descripcion
          }];
          
          this.draw();
          
          // Mostrar modal flotante con instrucciones
          this.mostrarModalMoverPin(repuesto, ubicacion, ubicacionIndex, areaNombre, mapaNombre);
        }, 800);
      }, 500);
    }, 300);
  },
  
  //  NUEVA FUNCIN: Modal flotante para mover pin
  mostrarModalMoverPin(repuesto, ubicacion, ubicacionIndex, areaNombre, mapaNombre) {
    console.log(' mostrarModalMoverPin llamado:', { repuesto, ubicacion, ubicacionIndex, areaNombre, mapaNombre });
    
    // Guardar informacin del pin a mover
    this.state.pinAMover = {
      repuestoId: repuesto.id,
      ubicacionIndex: ubicacionIndex,
      ubicacionOriginal: { ...ubicacion },
      editando: false  // Inicia en false, se activa al hacer click en "Mover Pin"
    };
    
    console.log(' Estado pinAMover inicializado:', this.state.pinAMover);
    
    const modalHTML = `
      <div id="modalMoverPin" style="
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(30, 41, 59, 0.95);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.1);
        z-index: 10000;
        width: 320px;
        backdrop-filter: blur(20px);
        animation: fadeInRight 0.3s ease-out;
        cursor: move;
      " onmousedown="mapController.iniciarArrastreModal(event)">
        <style>
          @keyframes fadeInRight {
            from {
              transform: translateX(100px);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
          @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
          }
          #modalMoverPin:hover {
            background: rgba(30, 41, 59, 0.98);
          }
        </style>
        
        <!-- Ttulo compacto con drag handle -->
        <div style="
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 14px;
          padding-bottom: 12px;
          border-bottom: 1px solid rgba(255,255,255,0.1);
        ">
          <div style="
            font-size: 1.4rem;
            animation: pulse 2s infinite;
          "></div>
          <div style="flex: 1;">
            <div style="font-size: 0.95rem; font-weight: 700; margin-bottom: 2px;">
              Mover Pin
            </div>
            <div style="font-size: 0.75rem; opacity: 0.7;">
              ${repuesto.nombre.length > 25 ? repuesto.nombre.substring(0, 25) + '...' : repuesto.nombre}
            </div>
          </div>
          <button onclick="event.stopPropagation(); mapController.cancelarMoverPin()" style="
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
            line-height: 1;
            padding: 0;
          " onmouseenter="this.style.background='rgba(255,60,60,0.8)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
            
          </button>
        </div>
        
        <!-- Info compacta -->
        <div style="
          background: rgba(255,255,255,0.08);
          padding: 10px 12px;
          border-radius: 8px;
          margin-bottom: 14px;
          border-left: 3px solid #3b82f6;
          font-size: 0.85rem;
        ">
          <div style="opacity: 0.7; margin-bottom: 4px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">
            Ubicacin Actual
          </div>
          <div style="display: flex; flex-direction: column; gap: 3px;">
            <div> ${mapaNombre.length > 30 ? mapaNombre.substring(0, 30) + '...' : mapaNombre}</div>
            <div> ${areaNombre.length > 30 ? areaNombre.substring(0, 30) + '...' : areaNombre}</div>
          </div>
        </div>
        
        <!-- Botones compactos -->
        <div id="botonesIniciales" style="display: flex; gap: 8px;">
          <button id="btnIniciarMoverPin" onclick="event.stopPropagation(); mapController.iniciarEdicionPin()" style="
            flex: 1;
            padding: 10px 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 8px rgba(59, 130, 246, 0.3);
          " onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 12px rgba(59, 130, 246, 0.4)'" 
             onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 8px rgba(59, 130, 246, 0.3)'">
             Mover
          </button>
          <button onclick="event.stopPropagation(); mapController.cancelarMoverPin()" style="
            padding: 10px 16px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
            
          </button>
        </div>
        
        <!-- Botones durante edicin (ocultos inicialmente) -->
        <div id="botonesEdicion" style="display: none; gap: 8px;">
          <button id="btnGuardarNuevaPosicion" onclick="event.stopPropagation(); mapController.guardarNuevaPosicionPin()" style="
            flex: 1;
            padding: 10px 16px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 8px rgba(34, 197, 94, 0.3);
          " onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 12px rgba(34, 197, 94, 0.4)'" 
             onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 8px rgba(34, 197, 94, 0.3)'">
             Guardar
          </button>
          <button onclick="event.stopPropagation(); mapController.cancelarMoverPin()" style="
            padding: 10px 16px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
            
          </button>
        </div>
        
        <!--  Ayuda del crculo pulsante -->
        <div style="
          margin-top: 12px;
          padding: 8px 12px;
          background: rgba(59, 130, 246, 0.15);
          border-left: 3px solid #3b82f6;
          border-radius: 6px;
          font-size: 0.8rem;
          line-height: 1.4;
        ">
          <strong style="color: #60a5fa;"> Crculo azul pulsante:</strong>
          <div style="opacity: 0.9; margin-top: 4px;">
            Indica la ubicacin actual del repuesto en el mapa. Al activar "Mover", el pin se volver naranja y podrs arrastrarlo.
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  },
  
  //  NUEVA FUNCIN: Iniciar arrastre del modal
  iniciarArrastreModal(event) {
    // Solo permitir arrastre si se hace click en el rea del ttulo/fondo, no en botones
    if (event.target.tagName === 'BUTTON' || event.target.closest('button')) {
      return; // No arrastrar si se clicke un botn
    }
    
    const modal = document.getElementById('modalMoverPin');
    if (!modal) return;
    
    // Guardar estado inicial
    this.state.arrastreModal = {
      activo: true,
      inicioX: event.clientX,
      inicioY: event.clientY,
      modalX: modal.offsetLeft,
      modalY: modal.offsetTop
    };
    
    modal.style.cursor = 'grabbing';
    
    // Agregar listeners temporales
    const moverModal = (e) => {
      if (!this.state.arrastreModal || !this.state.arrastreModal.activo) return;
      
      const deltaX = e.clientX - this.state.arrastreModal.inicioX;
      const deltaY = e.clientY - this.state.arrastreModal.inicioY;
      
      const nuevaX = this.state.arrastreModal.modalX + deltaX;
      const nuevaY = this.state.arrastreModal.modalY + deltaY;
      
      // Limitar a los bordes de la ventana
      const maxX = window.innerWidth - modal.offsetWidth;
      const maxY = window.innerHeight - modal.offsetHeight;
      
      modal.style.left = Math.max(0, Math.min(nuevaX, maxX)) + 'px';
      modal.style.top = Math.max(0, Math.min(nuevaY, maxY)) + 'px';
      modal.style.right = 'auto'; // Desactivar posicionamiento por right
    };
    
    const soltarModal = () => {
      if (modal) modal.style.cursor = 'move';
      this.state.arrastreModal = null;
      document.removeEventListener('mousemove', moverModal);
      document.removeEventListener('mouseup', soltarModal);
    };
    
    document.addEventListener('mousemove', moverModal);
    document.addEventListener('mouseup', soltarModal);
  },
  
  //  NUEVA FUNCIN: Iniciar modo edicin del pin (pin naranja)
  iniciarEdicionPin() {
    console.log(' Iniciando modo edicin de pin...');
    
    if (!this.state.pinAMover) {
      console.error(' No hay pin para mover');
      return;
    }
    
    // Activar modo edicin
    this.state.pinAMover.editando = true;
    
    // Cambiar UI del modal
    const botonesIniciales = document.getElementById('botonesIniciales');
    const botonesEdicion = document.getElementById('botonesEdicion');
    
    if (botonesIniciales) botonesIniciales.style.display = 'none';
    if (botonesEdicion) botonesEdicion.style.display = 'flex';
    
    // Toast de instruccin
    this.showToast(' Arrastra el pin naranja a su nueva ubicacin', 'info', 4000);
    
    // Redibujar para mostrar el pin en naranja
    this.draw();
  },
  
  //  NUEVA FUNCIN: Cancelar modo mover pin
  cancelarMoverPin() {
    console.log(' Cancelando modo mover pin...');
    
    // Limpiar estado
    this.state.pinAMover = null;
    this.state.ubicacionesResaltadas = null;
    
    // Cerrar modal
    const modal = document.getElementById('modalMoverPin');
    if (modal) modal.remove();
    
    // Redibujar
    this.draw();
    
    this.showToast(' Movimiento de pin cancelado', 'info');
  },
  
  //  NUEVA FUNCIN: Guardar nueva posicin del pin
  async guardarNuevaPosicionPin() {
    console.log(' Guardando nueva posicin del pin...');
    
    if (!this.state.pinAMover) {
      console.error(' No hay pin para guardar');
      return;
    }
    
    const { repuestoId, ubicacionIndex } = this.state.pinAMover;
    
    const repuesto = app.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) {
      console.error(' Repuesto no encontrado');
      return;
    }
    
    // Obtener la nueva posicin desde ubicacionesResaltadas (es donde se arrastra el pin)
    if (!this.state.ubicacionesResaltadas || this.state.ubicacionesResaltadas.length === 0) {
      this.showToast(' Debes mover el pin primero', 'warning');
      return;
    }
    
    const nuevaPosicion = this.state.ubicacionesResaltadas[0];
    
    // Buscar rea cercana
    const areasCercanas = this.buscarAreasCercanas(nuevaPosicion.x, nuevaPosicion.y, 300);
    
    if (areasCercanas.length === 0) {
      this.showToast(' El pin debe estar dentro de un rea', 'warning');
      return;
    }
    
    const area = areasCercanas[0].area;
    
    console.log(' rea encontrada:', area.name);
    console.log(' Nueva posicin:', { x: nuevaPosicion.x, y: nuevaPosicion.y });
    
    // Actualizar ubicacin
    if (repuesto.ubicaciones && repuesto.ubicaciones[ubicacionIndex]) {
      repuesto.ubicaciones[ubicacionIndex].markerX = nuevaPosicion.x;
      repuesto.ubicaciones[ubicacionIndex].markerY = nuevaPosicion.y;
      repuesto.ubicaciones[ubicacionIndex].areaId = area.id;
    }
    
    // Guardar cambios
    try {
      await app.saveData();
      
      this.showToast(` Pin movido exitosamente a "${area.name}"`, 'success');
      
      // Limpiar estado
      this.state.pinAMover = null;
      this.state.ubicacionesResaltadas = null;
      
      // Cerrar modal
      const modal = document.getElementById('modalMoverPin');
      if (modal) modal.remove();
      
      // Redibujar
      this.draw();
    } catch (error) {
      console.error('Error guardando nueva posicin:', error);
      this.showToast(' Error al guardar la nueva posicin', 'error');
    }
  },

  openNewMapModal() {
    if (!mapStorage.initialized) {
      this.showToast('Conecta la carpeta antes de crear un mapa.', 'info');
      return;
    }

    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) return;

    this.elements.modalTitle.textContent = 'Nuevo mapa';
    body.innerHTML = `
      <form id="mapCreateForm" class="map-area-form">
        <div class="form-group">
          <label>Nombre del mapa</label>
          <input type="text" name="mapName" required placeholder="Ej: Planta principal" />
        </div>
        <div class="form-group">
          <label>Imagen del mapa</label>
          <input type="file" name="mapImage" accept="image/*" required />
          <small style="color: var(--text-secondary); font-size: 0.75rem;">Se recomienda usar imgenes en alta resolucin (PNG, JPG o WEBP).</small>
        </div>
        <div class="form-group" id="mapJerarquiaFormGroup">
          <label>Jerarquia corporativa del mapa</label>
          <p style="margin: 4px 0 8px; font-size: 0.85rem; color: var(--text-secondary);">
             Cada mapa debe apuntar a un nico nodo para mantener una jerarquia consistente.
          </p>
          <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer;">
            <input type="checkbox" name="allowFreeLevel" id="mapFormAllowFreeLevel" style="accent-color: var(--primary);" />
            <span>Permitir nivel libre (sin jerarquia fija)</span>
          </label>
          <small style="display: block; margin: 4px 0 12px; color: var(--text-muted); font-size: 0.75rem;">
             Usa nivel libre slo cuando el mapa no pertenezca a la jerarquia oficial.
          </small>
          <div id="mapFormLevelStatus" style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 8px;"></div>
          <div class="map-jerarquia-inline" style="gap: 8px; margin-bottom: 8px;">
            <span class="map-jerarquia-inline-label" id="mapJerarquiaSelectedPath">Sin asignacin</span>
            <button type="button" class="map-btn map-btn--ghost" data-action="map-form-clear-jerarquia">Limpiar</button>
          </div>
          <div id="mapJerarquiaSelectorContainer" class="map-jerarquia-selector" style="max-height: 260px; overflow: auto; border: 1px solid var(--border-color); border-radius: 6px;"></div>
          <div id="mapFormWarnings" class="map-form-warning hidden" style="margin-top: 8px; font-size: 0.85rem; color: #f97316;"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>
          <button type="submit" class="map-btn map-btn--primary">Guardar mapa</button>
        </div>
      </form>
    `;

    modal.classList.remove('hidden');

    this.state.tempJerarquiaAssignment = { mapId: null, path: [], allowFreeLevel: false };
    this.state.mapFormContext = { mode: 'create', mapId: null, allowFreeLevel: false };
    this.renderJerarquiaSelectorTree({ containerId: 'mapJerarquiaSelectorContainer', selectedPath: [] });
    this.updateJerarquiaAssignPreview();
    this.setupMapFormJerarquiaControls();
    this.updateMapFormLevelStatus();

    const form = body.querySelector('#mapCreateForm');
    const cancelBtn = body.querySelector('[data-action="cancel"]');

    if (cancelBtn) cancelBtn.addEventListener('click', () => this.closeModal());
    if (form) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        await this.createMapFromForm(formData);
      });
    }
  },

  async createMapFromForm(formData) {
    const name = (formData.get('mapName') || '').toString().trim();
    const file = formData.get('mapImage');
    const allowFreeLevel = formData.get('allowFreeLevel') === 'on';
    const selectedPath = this.sanitizeMapJerarquiaPath(this.state.tempJerarquiaAssignment?.path || []);
    if (!name) {
      this.showToast('Asigna un nombre al mapa.', 'warning');
      return;
    }
    if (!(file instanceof File)) {
      this.showToast('Selecciona una imagen para el mapa.', 'warning');
      return;
    }
    if (!allowFreeLevel && !selectedPath.length) {
      this.showToast('Selecciona un nodo de la jerarquia para este mapa o marca nivel libre.', 'warning');
      return;
    }

    try {
      await mapStorage.ensureStructure();
      const timestamp = Date.now();
      const extension = (file.name.split('.').pop() || 'png').toLowerCase();
      const safeExtension = extension.length <= 5 ? extension : 'png';
      const fileName = `map_${timestamp}.${safeExtension}`;
      let mapDir = mapStorage.mapImagesDir;
      if (!mapDir) {
        mapDir = await mapStorage.rootHandle.getDirectoryHandle('imagenes', { create: true });
        mapDir = await mapDir.getDirectoryHandle('mapas', { create: true });
        mapStorage.mapImagesDir = mapDir;
      }

      const fileHandle = await mapDir.getFileHandle(fileName, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(file);
      await writable.close();
      const dimensions = await this.getImageDimensions(file);

      const mapRecord = {
        id: timestamp,
        name,
        imagePath: `${mapStorage.mapImagesPath.join('/')}/${fileName}`,
        width: dimensions.width,
        height: dimensions.height,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        jerarquiaPath: selectedPath,
        allowFreeLevel,
        mapLevel: allowFreeLevel ? null : (typeof mapStorage?.deriveMapLevel === 'function'
          ? mapStorage.deriveMapLevel(selectedPath)
          : null)
      };

      const updatedMaps = [...(mapStorage.maps || []), mapRecord];
      await mapStorage.saveMaps(updatedMaps, { action: 'create', mapId: mapRecord.id, detail: mapRecord.name });

      this.closeModal();
      await this.loadData();
      await this.selectMap(mapRecord.id);
      this.showToast('Mapa creado correctamente.', 'success');
      if (app && app.jerarquiaAnidada) {
        this.openAssignJerarquiaModal(mapRecord.id);
      }
    } catch (error) {
      console.error('Error creando mapa:', error);
      this.showToast('No se pudo crear el mapa. Revisa la consola.', 'error');
    }
  },

  async getImageDimensions(file) {
    return new Promise((resolve) => {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        resolve({ width: img.width, height: img.height });
        URL.revokeObjectURL(url);
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        resolve({ width: 0, height: 0 });
      };
      img.src = url;
    });
  },

  //  EDITAR MAPA
  async openEditMapModal(mapId) {
    const numericId = typeof mapId === 'string' ? parseInt(mapId, 10) : mapId;
    const map = mapStorage.getMapById(numericId);
    
    if (!map) {
      this.showToast('Mapa no encontrado.', 'warning');
      return;
    }

    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) return;

    const initialPath = Array.isArray(map.jerarquiaPath) ? [...map.jerarquiaPath] : [];
    const allowFreeChecked = map.allowFreeLevel ? 'checked' : '';

    this.elements.modalTitle.textContent = 'Editar mapa';
    body.innerHTML = `
      <form id="mapEditForm" class="map-area-form">
        <div class="form-group">
          <label>Nombre del mapa</label>
          <input type="text" name="mapName" required placeholder="Ej: Planta principal" value="${this.escapeHtml(map.name)}" />
        </div>
        <div class="form-group">
          <label>Imagen del mapa (opcional - dejar vaco para mantener actual)</label>
          <input type="file" name="mapImage" accept="image/*" />
          <small style="color: var(--text-secondary); font-size: 0.75rem;">
            Imagen actual: ${map.width}  ${map.height}px
          </small>
        </div>
        <div class="form-group" id="mapJerarquiaFormGroup">
          <label>Jerarquia corporativa del mapa</label>
          <p style="margin: 4px 0 8px; font-size: 0.85rem; color: var(--text-secondary);">
             Ajusta el nodo al que apunta este mapa para asegurar que las reas coincidan con la jerarquia oficial.
          </p>
          <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer;">
            <input type="checkbox" name="allowFreeLevel" id="mapFormAllowFreeLevel" style="accent-color: var(--primary);" ${allowFreeChecked} />
            <span>Permitir nivel libre (sin jerarquia fija)</span>
          </label>
          <small style="display: block; margin: 4px 0 12px; color: var(--text-muted); font-size: 0.75rem;">
             Desactiva esta opcin para exigir que todas las reas pertenezcan al mismo nivel corporativo.
          </small>
          <div id="mapFormLevelStatus" style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 8px;"></div>
          <div class="map-jerarquia-inline" style="gap: 8px; margin-bottom: 8px;">
            <span class="map-jerarquia-inline-label" id="mapJerarquiaSelectedPath">${this.escapeHtml(this.getJerarquiaPathLabel(map.jerarquiaPath))}</span>
            <button type="button" class="map-btn map-btn--ghost" data-action="map-form-clear-jerarquia">Limpiar</button>
          </div>
          <div id="mapJerarquiaSelectorContainer" class="map-jerarquia-selector" style="max-height: 260px; overflow: auto; border: 1px solid var(--border-color); border-radius: 6px;"></div>
          <div id="mapFormWarnings" class="map-form-warning hidden" style="margin-top: 8px; font-size: 0.85rem; color: #f97316;"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>
          <button type="submit" class="map-btn map-btn--primary">Guardar cambios</button>
        </div>
      </form>
    `;

    modal.classList.remove('hidden');

    this.state.tempJerarquiaAssignment = { mapId: map.id, path: initialPath, allowFreeLevel: Boolean(map.allowFreeLevel) };
    this.state.mapFormContext = { mode: 'edit', mapId: map.id, allowFreeLevel: Boolean(map.allowFreeLevel) };
    this.renderJerarquiaSelectorTree({ containerId: 'mapJerarquiaSelectorContainer', selectedPath: initialPath });
    this.updateJerarquiaAssignPreview();
    this.setupMapFormJerarquiaControls();
    this.updateMapFormLevelStatus();

    const form = body.querySelector('#mapEditForm');
    const cancelBtn = body.querySelector('[data-action="cancel"]');

    if (cancelBtn) cancelBtn.addEventListener('click', () => this.closeModal());
    if (form) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        await this.updateMapFromForm(numericId, formData);
      });
    }
  },

  //  ACTUALIZAR MAPA
  async updateMapFromForm(mapId, formData) {
    const name = (formData.get('mapName') || '').toString().trim();
    const file = formData.get('mapImage');
    const allowFreeLevel = formData.get('allowFreeLevel') === 'on';
    const selectedPath = this.sanitizeMapJerarquiaPath(this.state.tempJerarquiaAssignment?.path || []);
    
    if (!name) {
      this.showToast('Asigna un nombre al mapa.', 'warning');
      return;
    }
    if (!allowFreeLevel && !selectedPath.length) {
      this.showToast('Selecciona una jerarquia para el mapa o activa el nivel libre.', 'warning');
      return;
    }

    const map = mapStorage.getMapById(mapId);
    if (!map) {
      this.showToast('Mapa no encontrado.', 'warning');
      return;
    }

    try {
      let updatedMap = {
        ...map,
        name,
        updatedAt: new Date().toISOString(),
        allowFreeLevel,
        jerarquiaPath: selectedPath,
        mapLevel: allowFreeLevel ? null : (typeof mapStorage?.deriveMapLevel === 'function'
          ? mapStorage.deriveMapLevel(selectedPath)
          : null)
      };

      // Si hay nueva imagen, actualizar
      if (file && file instanceof File && file.size > 0) {
        await mapStorage.ensureStructure();
        const timestamp = Date.now();
        const extension = (file.name.split('.').pop() || 'png').toLowerCase();
        const safeExtension = extension.length <= 5 ? extension : 'png';
        const fileName = `map_${timestamp}.${safeExtension}`;
        
        let mapDir = mapStorage.mapImagesDir;
        if (!mapDir) {
          mapDir = await mapStorage.rootHandle.getDirectoryHandle('imagenes', { create: true });
          mapDir = await mapDir.getDirectoryHandle('mapas', { create: true });
          mapStorage.mapImagesDir = mapDir;
        }

        const fileHandle = await mapDir.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(file);
        await writable.close();
        const dimensions = await this.getImageDimensions(file);
        
        updatedMap.imagePath = `${mapStorage.mapImagesPath.join('/')}/${fileName}`;
        updatedMap.width = dimensions.width;
        updatedMap.height = dimensions.height;
      }

      const updatedMaps = mapStorage.maps.map(m => m.id === mapId ? updatedMap : m);
      await mapStorage.saveMaps(updatedMaps, { action: 'update', mapId, detail: name });

      this.closeModal();
      await this.loadData({ force: true });
      await this.selectMap(mapId);
      this.showToast('Mapa actualizado correctamente.', 'success');
    } catch (error) {
      console.error('Error actualizando mapa:', error);
      this.showToast('No se pudo actualizar el mapa. Revisa la consola.', 'error');
    }
  },

  openAssignJerarquiaModal(mapId) {
    const numericId = typeof mapId === 'string' ? parseInt(mapId, 10) : mapId;
    const map = mapStorage.getMapById(numericId);

    if (!map) {
      this.showToast('Mapa no encontrado.', 'warning');
      return;
    }

    if (!app || !app.jerarquiaAnidada) {
      this.showToast('Configura la jerarqua en su pestaña antes de asignarla.', 'warning');
      return;
    }

    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) return;

    this.state.tempJerarquiaAssignment = {
      mapId: numericId,
      path: Array.isArray(map.jerarquiaPath) ? [...map.jerarquiaPath] : [],
      allowFreeLevel: Boolean(map.allowFreeLevel)
    };

    this.elements.modalTitle.textContent = 'Asignar jerarqua al mapa';
    body.innerHTML = `
      <div class="map-jerarquia-modal">
        <div class="map-jerarquia-summary">
          <p><strong>Mapa:</strong> ${this.escapeHtml(map.name || 'Mapa sin nombre')}</p>
          <p class="map-jerarquia-summary-text">Selecciona el nivel exacto dentro de la jerarqua corporativa. Servir para mantener sincronizadas las reas dibujadas y los marcadores.</p>
          <div class="map-jerarquia-selected" id="mapJerarquiaSelectedPath"></div>
          <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem; margin-top:12px; cursor:pointer;">
            <input type="checkbox" id="mapAssignAllowFree" style="accent-color: var(--primary);" ${map.allowFreeLevel ? 'checked' : ''}>
            <span>Permitir nivel libre (sin jerarqua fija)</span>
          </label>
          <small style="display:block; margin:4px 0 12px; color:var(--text-muted); font-size:0.8rem;">
             Activa esta opcin solo si el mapa no pertenece al rbol corporativo. De lo contrario, asigna el nodo hoja exacto.
          </small>
          <div id="mapAssignLevelStatus" style="font-size:0.85rem; color:var(--text-primary); margin-bottom:6px;"></div>
          <div id="mapAssignWarnings" class="map-form-warning hidden" style="font-size:0.85rem; color:#f97316;"></div>
        </div>
        <div id="mapJerarquiaSelectorContainer" class="map-jerarquia-selector"></div>
        <div class="form-actions" style="justify-content: flex-end; gap: 8px;">
          <button type="button" class="map-btn map-btn--ghost" data-action="cancel-jerarquia">Cancelar</button>
          <button type="button" class="map-btn map-btn--ghost" data-action="clear-jerarquia">Quitar asignacin</button>
          <button type="button" class="map-btn map-btn--primary" data-action="confirm-jerarquia">Guardar</button>
        </div>
      </div>
    `;

    modal.classList.remove('hidden');

    this.renderJerarquiaSelectorTree({
      containerId: 'mapJerarquiaSelectorContainer',
      selectedPath: this.state.tempJerarquiaAssignment.path
    });
    this.updateJerarquiaAssignPreview();

    const cancelBtn = body.querySelector('[data-action="cancel-jerarquia"]');
    const clearBtn = body.querySelector('[data-action="clear-jerarquia"]');
    const confirmBtn = body.querySelector('[data-action="confirm-jerarquia"]');

    const allowFreeInput = body.querySelector('#mapAssignAllowFree');

    if (allowFreeInput) {
      allowFreeInput.addEventListener('change', () => {
        if (!this.state.tempJerarquiaAssignment) {
          this.state.tempJerarquiaAssignment = { mapId: numericId, path: [] };
        }
        this.state.tempJerarquiaAssignment.allowFreeLevel = allowFreeInput.checked;
        this.updateAssignJerarquiaStatus();
      });
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => {
        this.state.tempJerarquiaAssignment = null;
        this.closeModal();
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', () => this.clearJerarquiaAssignment());
    }

    if (confirmBtn) {
      confirmBtn.addEventListener('click', () => this.applyJerarquiaAssignment());
    }

    this.updateAssignJerarquiaStatus();
  },

  renderJerarquiaSelectorTree({ containerId, selectedPath = [] } = {}) {
    const container = typeof containerId === 'string' ? document.getElementById(containerId) : containerId;
    if (!container) return;

    if (!app || !app.jerarquiaAnidada) {
      container.innerHTML = '<p style="color: var(--text-secondary);">Configura la jerarqua en la pestaña correspondiente.</p>';
      return;
    }

    const jerarquia = app.jerarquiaAnidada;
    if (!jerarquia.empresa) {
      container.innerHTML = '<p style="color: var(--text-secondary);">No se encontr empresa en la jerarqua.</p>';
      return;
    }

    const normalizedPath = Array.isArray(selectedPath) ? selectedPath : [];
    const treeHtml = `
      <ul class="jerarquia-selector-tree-root">
        ${this.buildJerarquiaSelectorHTML({
          node: jerarquia.empresa,
          nivel: 'empresa',
          path: [],
          selectedPath: normalizedPath,
          childrenOverride: jerarquia.areas || []
        })}
      </ul>
    `;

    container.innerHTML = treeHtml;

    Array.from(container.querySelectorAll('[data-jerarquia-node]')).forEach((btn) => {
      btn.addEventListener('click', (event) => {
        const payload = event.currentTarget.getAttribute('data-path');
        if (!payload) return;
        try {
          const decoded = JSON.parse(decodeURIComponent(payload));
          this.handleJerarquiaNodeSelection(decoded);
        } catch (error) {
          console.error('No se pudo interpretar la seleccin de jerarqua:', error);
        }
      });
    });
  },

  buildJerarquiaSelectorHTML({ node, nivel, path = [], selectedPath = [], childrenOverride = null }) {
    if (!node) {
      return '';
    }

    const nodeId = node.id || `${nivel}-${Math.random().toString(36).slice(2, 7)}`;
    const nodeNombre = node.nombre || node.name || 'Sin nombre';
    const currentPath = [...path, { id: nodeId, nivel, nombre: nodeNombre }];
    const isSelected = this.compareJerarquiaPaths(currentPath, selectedPath);
    const config = this.jerarquiaLevelConfig[nivel] || null;
    const childKey = config?.childKey;
    const childNivel = config?.childNivel;
    const children = Array.isArray(childrenOverride)
      ? childrenOverride
      : (childKey && Array.isArray(node[childKey]) ? node[childKey] : []);

    const childrenHtml = childNivel && Array.isArray(children) && children.length
      ? `<ul class="jerarquia-selector-children">
          ${children.map(child => this.buildJerarquiaSelectorHTML({
            node: child,
            nivel: childNivel,
            path: currentPath,
            selectedPath
          })).join('')}
        </ul>`
      : '';

    const pathPayload = encodeURIComponent(JSON.stringify(currentPath));
    const label = this.jerarquiaLevelConfig[nivel]?.label || nivel;

    return `
      <li class="jerarquia-selector-item">
        <button type="button" class="jerarquia-selector-node ${isSelected ? 'is-selected' : ''}" data-jerarquia-node="true" data-path="${pathPayload}">
          <span class="jerarquia-selector-level">${this.escapeHtml(label)}</span>
          <span class="jerarquia-selector-name">${this.escapeHtml(nodeNombre)}</span>
        </button>
        ${childrenHtml}
      </li>
    `;
  },

  compareJerarquiaPaths(pathA, pathB) {
    if (!Array.isArray(pathA) || !Array.isArray(pathB)) return false;
    if (pathA.length !== pathB.length) return false;
    return pathA.every((node, index) => {
      const compareNode = pathB[index];
      return node.id === compareNode.id && (node.nivel || null) === (compareNode.nivel || null);
    });
  },

  handleJerarquiaNodeSelection(pathNodes) {
    if (!Array.isArray(pathNodes)) return;
    if (!this.state.tempJerarquiaAssignment) {
      this.state.tempJerarquiaAssignment = { mapId: null, path: [], allowFreeLevel: false };
    }
    this.state.tempJerarquiaAssignment.path = pathNodes;
    this.updateJerarquiaAssignPreview();
    this.renderJerarquiaSelectorTree({
      containerId: 'mapJerarquiaSelectorContainer',
      selectedPath: pathNodes
    });
    this.updateMapFormLevelStatus();
    this.updateAssignJerarquiaStatus();
  },

  updateJerarquiaAssignPreview() {
    const preview = document.getElementById('mapJerarquiaSelectedPath');
    if (!preview) return;

    const path = this.state.tempJerarquiaAssignment?.path || [];
    if (!Array.isArray(path) || !path.length) {
      preview.innerHTML = '<span class="map-jerarquia-chip map-jerarquia-chip--empty">Sin asignacin</span>';
      return;
    }

    const arrow = '<span class="map-jerarquia-chip-arrow">›</span>';
    preview.innerHTML = path
      .map((node) => {
        const levelConfig = node?.nivel ? this.jerarquiaLevelConfig[node.nivel] : null;
        const levelLabel = levelConfig?.label || node?.nivel || '';
        const safeLevel = levelLabel ? `<span class="map-jerarquia-chip-level">${this.escapeHtml(levelLabel)}</span>` : '';
        const safeName = `<span class="map-jerarquia-chip-name">${this.escapeHtml(node?.nombre || node?.id || 'Sin nombre')}</span>`;
        return `<span class="map-jerarquia-chip">${safeLevel}${safeName}</span>`;
      })
      .join(arrow);
  },

  clearJerarquiaAssignment() {
    if (!this.state.tempJerarquiaAssignment) {
      this.state.tempJerarquiaAssignment = { mapId: null, path: [], allowFreeLevel: false };
    } else {
      this.state.tempJerarquiaAssignment.path = [];
    }

    this.updateJerarquiaAssignPreview();
    this.renderJerarquiaSelectorTree({
      containerId: 'mapJerarquiaSelectorContainer',
      selectedPath: []
    });
    this.updateMapFormLevelStatus();
    this.updateAssignJerarquiaStatus();
  },

  async applyJerarquiaAssignment() {
    const assignment = this.state.tempJerarquiaAssignment;
    if (!assignment) {
      this.showToast('No hay cambios por guardar.', 'info');
      return;
    }

    if (typeof assignment.mapId === 'undefined' || assignment.mapId === null) {
      this.showToast('Selecciona un mapa antes de guardar.', 'warning');
      return;
    }

    const map = mapStorage.getMapById(assignment.mapId);
    if (!map) {
      this.showToast('Mapa no encontrado.', 'warning');
      return;
    }

    const allowFreeLevel = Boolean(assignment.allowFreeLevel);
    const sanitizedPath = Array.isArray(assignment.path)
      ? assignment.path
          .filter(node => node && node.id)
          .map(node => ({ id: node.id, nivel: node.nivel || null }))
      : [];

    if (!allowFreeLevel && !sanitizedPath.length) {
      this.showToast('Selecciona alguna rama o marca el modo de nivel libre.', 'warning');
      return;
    }

    if (!allowFreeLevel) {
      const conflicts = this.findMapLevelConflicts(sanitizedPath, assignment.mapId);
      if (conflicts.length) {
        const names = conflicts.map(item => item.name || `#${item.id}`).join(', ');
        const confirmMessage = `El nodo seleccionado ya est asignado a: ${names}. Deseas continuar igualmente?`;
        if (!confirm(confirmMessage)) {
          return;
        }
      }
    }

    const mapLevel = allowFreeLevel ? null : this.getMapLevelFromPath(sanitizedPath);
    const updatedMap = {
      ...map,
      allowFreeLevel,
      jerarquiaPath: sanitizedPath,
      mapLevel,
      updatedAt: new Date().toISOString()
    };
    const updatedMaps = (mapStorage.maps || []).map(existing => existing.id === assignment.mapId ? updatedMap : existing);

    try {
      await mapStorage.saveMaps(updatedMaps, { action: 'assign_jerarquia', mapId: assignment.mapId, detail: map.name });

      if (this.state.currentMapId === assignment.mapId) {
        this.state.currentMap = updatedMap;
        this.state.jerarquiaBranchFilter = null;
      }

      this.state.tempJerarquiaAssignment = null;
      this.closeModal();
      this.showToast('Jerarqua asignada correctamente.', 'success');

      if (window.appEvents && typeof window.appEvents.emit === 'function') {
        window.appEvents.emit('mapa:jerarquia-asignada', {
          mapId: assignment.mapId,
          jerarquiaPath: sanitizedPath,
          mapName: map.name
        });
      }

      this.renderMapList(updatedMaps);
      this.updateMapJerarquiaBadge();
      await this.selectMap(assignment.mapId, { keepViewport: true });
    } catch (error) {
      console.error('Error guardando la jerarqua del mapa:', error);
      this.showToast('No se pudo guardar la jerarqua. Revisa la consola.', 'error');
    }
  },

  getJerarquiaRootNode() {
    if (!app || !app.jerarquiaAnidada || !app.jerarquiaAnidada.empresa) {
      return null;
    }
    const root = { ...app.jerarquiaAnidada.empresa };
    root.areas = app.jerarquiaAnidada.areas || [];
    return root;
  },

  findJerarquiaNodeInTree(targetId, targetNivel) {
    if (!targetId) return null;
    const root = this.getJerarquiaRootNode();
    if (!root) return null;

    const visit = (node, nivel) => {
      if (!node) return null;
      if (node.id === targetId && (!targetNivel || targetNivel === nivel)) {
        return node;
      }

      const config = this.jerarquiaLevelConfig[nivel];
      if (!config?.childKey || !config?.childNivel) {
        return null;
      }

      const children = node[config.childKey];
      if (!Array.isArray(children)) {
        return null;
      }

      for (const child of children) {
        const found = visit(child, config.childNivel);
        if (found) {
          return found;
        }
      }

      return null;
    };

    return visit(root, 'empresa');
  },

  getJerarquiaPathLabel(path) {
    if (!Array.isArray(path) || !path.length) {
      return 'Sin asignacin';
    }

    const labels = path.map((node) => {
      const resolved = this.findJerarquiaNodeInTree(node.id, node.nivel);
      return resolved?.nombre || node.nombre || node.id;
    }).filter(Boolean);

    return labels.length ? labels.join(' > ') : path.map(node => node.id).join(' > ');
  },

  sanitizeMapJerarquiaPath(path = []) {
    if (!Array.isArray(path)) {
      return [];
    }

    return path
      .filter(node => node && node.id)
      .map(node => ({
        id: node.id,
        nivel: node.nivel || null
      }));
  },

  getMapLevelFromPath(path = []) {
    if (!Array.isArray(path) || !path.length) {
      return null;
    }
    const leaf = path[path.length - 1];
    return leaf?.nivel || null;
  },

  getMapLevelLabel(level) {
    if (!level) {
      return 'Sin nivel';
    }
    return this.jerarquiaLevelConfig[level]?.label || level;
  },

  findMapLevelConflicts(path, currentMapId = null) {
    if (!Array.isArray(path) || !path.length || !mapStorage || !Array.isArray(mapStorage.maps)) {
      return [];
    }

    const leaf = path[path.length - 1];
    if (!leaf || !leaf.id) {
      return [];
    }

    return mapStorage.maps.filter(map => {
      if (!map || map.allowFreeLevel) {
        return false;
      }
      if (currentMapId && String(map.id) === String(currentMapId)) {
        return false;
      }
      const mapPath = Array.isArray(map.jerarquiaPath) ? map.jerarquiaPath : [];
      if (!mapPath.length) {
        return false;
      }
      const targetLeaf = mapPath[mapPath.length - 1];
      if (!targetLeaf) {
        return false;
      }
      return targetLeaf.id === leaf.id && (targetLeaf.nivel || null) === (leaf.nivel || null);
    });
  },

  buildMapContractState(map) {
    if (!map) {
      return {
        map: null,
        allowFreeLevel: false,
        hasJerarquia: false,
        mapLevel: null,
        issues: ['Sin mapa activo'],
        conflicts: [],
        path: [],
        isCompliant: false
      };
    }

    const allowFreeLevel = Boolean(map.allowFreeLevel);
    const sanitizedPath = this.sanitizeMapJerarquiaPath(map.jerarquiaPath || []);
    const hasJerarquia = sanitizedPath.length > 0;
    const mapLevel = allowFreeLevel ? null : (map.mapLevel || this.getMapLevelFromPath(sanitizedPath));
    const issues = [];

    if (!allowFreeLevel) {
      if (!hasJerarquia) {
        issues.push('El mapa no tiene una jerarquía asignada');
      } else if (!mapLevel) {
        issues.push('El nodo seleccionado no define un nivel válido');
      }
    }

    return {
      map,
      allowFreeLevel,
      hasJerarquia,
      mapLevel,
      issues,
      conflicts: [],
      path: sanitizedPath,
      isCompliant: allowFreeLevel || issues.length === 0
    };
  },

  updateMapFormLevelStatus() {
    const statusEl = document.getElementById('mapFormLevelStatus');
    const warningsEl = document.getElementById('mapFormWarnings');
    const allowFreeInput = document.getElementById('mapFormAllowFreeLevel');

    if (!statusEl && !warningsEl && !allowFreeInput) {
      return;
    }

    const context = this.state.mapFormContext || { allowFreeLevel: false };
    const allowFree = allowFreeInput ? allowFreeInput.checked : !!context.allowFreeLevel;
    context.allowFreeLevel = allowFree;
    this.state.mapFormContext = context;

    const path = Array.isArray(this.state.tempJerarquiaAssignment?.path)
      ? this.state.tempJerarquiaAssignment.path
      : [];

    if (allowFree) {
      if (statusEl) {
        statusEl.textContent = 'Nivel libre activado: este mapa admite reas sin una jerarquía fija.';
      }
      if (warningsEl) {
        warningsEl.textContent = '';
        warningsEl.classList.add('hidden');
      }
      return;
    }

    if (!path.length) {
      if (statusEl) {
        statusEl.textContent = 'Selecciona un nodo en la jerarquía para bloquear este mapa a un nivel corporativo.';
      }
      if (warningsEl) {
        warningsEl.textContent = '';
        warningsEl.classList.add('hidden');
      }
      return;
    }

    const level = this.getMapLevelFromPath(path);
    const levelLabel = this.getMapLevelLabel(level);
    if (statusEl) {
      statusEl.textContent = `Nivel asignado: ${levelLabel}. Guardaremos este mapa en "${this.getJerarquiaPathLabel(path)}".`;
    }

    if (!warningsEl) {
      return;
    }

    const conflicts = this.findMapLevelConflicts(path, context.mapId);
    if (conflicts.length) {
      const names = conflicts.map(map => this.escapeHtml(map.name || 'Sin nombre')).join(', ');
      warningsEl.innerHTML = `<strong>Advertencia:</strong> Este nivel ya está en uso por: ${names}.`;
      warningsEl.classList.remove('hidden');
    } else {
      warningsEl.textContent = '';
      warningsEl.classList.add('hidden');
    }
  },

  getCurrentMapContractState() {
    const map = this.state.currentMap || (this.state.currentMapId ? mapStorage.getMapById(this.state.currentMapId) : null);
    const state = this.buildMapContractState(map);
    if (!state.map) {
      return state;
    }

    if (!state.allowFreeLevel && state.hasJerarquia) {
      state.conflicts = this.findMapLevelConflicts(state.path, state.map.id);
      if (state.conflicts.length) {
        state.isCompliant = false;
      }
    }

    return state;
  },

  guardMapContract(actionLabel = 'continuar') {
    if (!mapStorage.initialized) {
      this.showToast('Conecta la carpeta INVENTARIO_STORAGE para trabajar con mapas.', 'info');
      return false;
    }

    if (!this.state.currentMapId) {
      this.showToast(`Selecciona un mapa antes de ${actionLabel}.`, 'info');
      return false;
    }

    const contract = this.getCurrentMapContractState();
    if (!contract.map) {
      this.showToast(`Selecciona un mapa activo antes de ${actionLabel}.`, 'info');
      return false;
    }

    if (contract.allowFreeLevel) {
      return true;
    }

    if (contract.issues.length) {
      this.showToast(`No puedes ${actionLabel} hasta corregir la jerarquía del mapa (${contract.issues[0]}).`, 'warning');
      if (!contract.hasJerarquia && contract.map?.id) {
        setTimeout(() => this.openAssignJerarquiaModal(contract.map.id), 250);
      }
      return false;
    }

    return true;
  },

  collectContractConflictGroups(states = []) {
    const buckets = new Map();
    states.forEach((state) => {
      if (!state || !state.map || state.allowFreeLevel || !state.hasJerarquia) {
        return;
      }
      const leaf = state.path[state.path.length - 1];
      if (!leaf?.id) {
        return;
      }
      const key = `${leaf.nivel || 'sin-nivel'}::${leaf.id}`;
      if (!buckets.has(key)) {
        buckets.set(key, []);
      }
      buckets.get(key).push(state);
    });

    const result = [];
    buckets.forEach((group) => {
      if (group.length <= 1) {
        return;
      }
      group.forEach((state) => {
        state.conflicts = group.filter(item => item.map.id !== state.map.id).map(item => item.map);
        state.isCompliant = false;
      });
      result.push({
        node: group[0].path[group[0].path.length - 1] || null,
        level: group[0].mapLevel || null,
        maps: group.map((state) => ({ id: state.map.id, name: state.map.name || `Mapa #${state.map.id}` }))
      });
    });

    return result;
  },

  detectAreaAlignmentIssue(areaJerarquia, mapState) {
    if (!mapState || mapState.allowFreeLevel || !Array.isArray(mapState.path) || !mapState.path.length) {
      return null;
    }

    const normalizedPath = this.normalizeMapJerarquiaPath(mapState.map?.jerarquiaPath || []);
    if (!normalizedPath.length) {
      return null;
    }

    const baseIndex = normalizedPath[0]?.nivel === 'empresa' ? 1 : 0;
    for (let i = baseIndex; i < normalizedPath.length; i++) {
      const fieldIndex = i - baseIndex;
      if (fieldIndex < 0 || fieldIndex >= this.areaJerarquiaFieldOrder.length) {
        continue;
      }
      const fieldName = this.areaJerarquiaFieldOrder[fieldIndex];
      if (!fieldName) {
        continue;
      }
      const expectedNode = normalizedPath[i];
      const expected = expectedNode?.labelLower || '';
      if (!expected) {
        continue;
      }
      const actualValue = (areaJerarquia[fieldName] || '').toString().trim();
      if (!actualValue) {
        return {
          type: 'missing',
          field: fieldName,
          expected: expectedNode.label || expectedNode.id
        };
      }
      if (actualValue.toLowerCase() !== expected) {
        return {
          type: 'mismatch',
          field: fieldName,
          expected: expectedNode.label || expectedNode.id,
          actual: actualValue
        };
      }
    }

    return null;
  },

  buildContractAuditReport() {
    const connected = Boolean(mapStorage?.initialized);
    const base = {
      connected,
      timestamp: new Date().toISOString(),
      stats: {
        totalMaps: 0,
        compliant: 0,
        pending: 0,
        freeMode: 0,
        locked: 0,
        missingJerarquia: 0,
        invalidLevel: 0,
        conflicts: 0,
        orphanAreas: 0,
        areasSinJerarquia: 0,
        lockedAreasSinJerarquia: 0,
        misalignedAreas: 0
      },
      states: [],
      conflictGroups: [],
      orphanAreas: [],
      areasSinJerarquia: [],
      misalignedAreas: []
    };

    if (!connected) {
      return base;
    }

    const maps = Array.isArray(mapStorage.maps) ? mapStorage.maps : [];
    const areas = Array.isArray(mapStorage.areas) ? mapStorage.areas : [];
    base.stats.totalMaps = maps.length;
    const stateById = new Map();

    maps.forEach((map) => {
      const state = this.buildMapContractState(map);
      base.states.push(state);
      stateById.set(map.id, state);
      if (state.isCompliant) {
        base.stats.compliant += 1;
      } else {
        base.stats.pending += 1;
      }
      if (state.allowFreeLevel) {
        base.stats.freeMode += 1;
      } else {
        base.stats.locked += 1;
        if (!state.hasJerarquia) {
          base.stats.missingJerarquia += 1;
        }
        if (!state.mapLevel) {
          base.stats.invalidLevel += 1;
        }
      }
    });

    base.conflictGroups = this.collectContractConflictGroups(base.states);
    base.stats.conflicts = base.conflictGroups.length;

    const orphanAreas = [];
    const areasSinJerarquia = [];
    const misalignedAreas = [];

    areas.forEach((area) => {
      const mapState = stateById.get(area.mapId);
      if (!mapState) {
        orphanAreas.push({
          id: area.id,
          name: area.name || `rea #${area.id}`,
          mapId: area.mapId
        });
        return;
      }

      const normalized = this.normalizeAreaJerarquia(area.jerarquia);
      const hasJerarquia = Object.values(normalized).some((value) => (value || '').toString().trim().length);

      if (!hasJerarquia) {
        areasSinJerarquia.push({
          id: area.id,
          name: area.name || `rea #${area.id}`,
          mapId: area.mapId,
          mapName: mapState.map?.name || 'Mapa sin nombre',
          requiresLock: !mapState.allowFreeLevel
        });
        return;
      }

      if (!mapState.allowFreeLevel) {
        const mismatch = this.detectAreaAlignmentIssue(normalized, mapState);
        if (mismatch) {
          misalignedAreas.push({
            id: area.id,
            name: area.name || `rea #${area.id}`,
            mapId: area.mapId,
            mapName: mapState.map?.name || 'Mapa sin nombre',
            details: mismatch
          });
        }
      }
    });

    base.orphanAreas = orphanAreas;
    base.areasSinJerarquia = areasSinJerarquia;
    base.misalignedAreas = misalignedAreas;
    base.stats.orphanAreas = orphanAreas.length;
    base.stats.areasSinJerarquia = areasSinJerarquia.length;
    base.stats.lockedAreasSinJerarquia = areasSinJerarquia.filter(item => item.requiresLock).length;
    base.stats.misalignedAreas = misalignedAreas.length;

    return base;
  },

  runContractAudit(options = {}) {
    const { silent = false } = options;
    const audit = this.buildContractAuditReport();
    this.state.contractAudit = audit;
    this.renderContractAudit();
    if (!silent) {
      if (!audit.connected) {
        this.showToast('Conecta la carpeta INVENTARIO_STORAGE para ejecutar la auditoría.', 'info');
      } else {
        this.showToast('Auditoría de jerarquía actualizada.', 'success');
      }
    }
  },

  renderContractAudit() {
    const audit = this.state.contractAudit;
    const stats = this.elements.contractStats || {};

    if (stats.total) {
      stats.total.textContent = audit?.stats?.totalMaps != null ? audit.stats.totalMaps : '--';
    }
    if (stats.compliant) {
      stats.compliant.textContent = audit?.stats?.compliant != null ? audit.stats.compliant : '--';
    }
    if (stats.pending) {
      stats.pending.textContent = audit?.stats?.pending != null ? audit.stats.pending : '--';
    }
    if (stats.conflicts) {
      stats.conflicts.textContent = audit?.stats?.conflicts != null ? audit.stats.conflicts : '--';
    }

    if (this.elements.contractTimestamp) {
      this.elements.contractTimestamp.textContent = audit?.timestamp
        ? `Actualizado ${this.formatAuditTimestamp(audit.timestamp)}`
        : 'Sin auditorías ejecutadas';
    }

    this.renderContractIssueList(audit);
  },

  buildContractIssueEntries(audit) {
    if (!audit) {
      return [];
    }

    if (!audit.connected) {
      return [{
        severity: 'info',
        tag: 'Conexin',
        title: 'Conecta la carpeta INVENTARIO_STORAGE',
        description: 'Necesitamos acceso a la carpeta principal para evaluar mapas y reas.',
        action: { label: 'Conectar ahora', action: 'audit-connect-storage' }
      }];
    }

    const issues = [];

    audit.states
      .filter((state) => state.map && !state.allowFreeLevel && state.issues.length)
      .slice(0, 4)
      .forEach((state) => {
        issues.push({
          severity: 'warning',
          tag: 'Mapa',
          title: state.map.name || `Mapa #${state.map.id}`,
          description: state.issues[0],
          action: { label: 'Asignar nivel', action: 'audit-open-assignment', mapId: state.map.id }
        });
      });

    audit.conflictGroups.slice(0, 3).forEach((group) => {
      issues.push({
        severity: 'error',
        tag: 'Conflicto',
        title: `Nodo duplicado (${group.maps.length} mapas)`,
        description: group.maps.map((item) => item.name).join(', '),
        action: { label: 'Ver primero', action: 'audit-open-map', mapId: group.maps[0]?.id }
      });
    });

    audit.orphanAreas.slice(0, 3).forEach((area) => {
      issues.push({
        severity: 'warning',
        tag: 'rea hrfana',
        title: area.name,
        description: `Mapa ${area.mapId || 'desconocido'} no existe en mapas.json.`
      });
    });

    audit.areasSinJerarquia
      .filter((item) => item.requiresLock)
      .slice(0, 3)
      .forEach((area) => {
        issues.push({
          severity: 'warning',
          tag: 'rea sin nivel',
          title: area.name,
          description: `Mapa ${area.mapName} exige jerarquía.`,
          action: { label: 'Ver mapa', action: 'audit-open-map', mapId: area.mapId }
        });
      });

    audit.misalignedAreas.slice(0, 3).forEach((area) => {
      const details = area.details;
      issues.push({
        severity: 'info',
        tag: 'Desfase',
        title: area.name,
        description: details?.type === 'mismatch'
          ? `Nivel ${details.field} esperado: ${details.expected}. Actual: ${details.actual}.`
          : `Nivel ${details?.field} sin valor.`,
        action: { label: 'Corregir', action: 'audit-open-map', mapId: area.mapId }
      });
    });

    if (!issues.length) {
      issues.push({
        severity: 'success',
        tag: 'Contrato',
        title: 'Todo en orden',
        description: 'No se detectaron infracciones al contrato de jerarquía.'
      });
    }

    return issues;
  },

  renderContractIssueList(audit) {
    const container = this.elements.contractIssueList;
    if (!container) {
      return;
    }

    const entries = this.buildContractIssueEntries(audit);
    if (!entries.length) {
      container.innerHTML = '<div class="map-contract-issue map-contract-issue--empty">Sin datos para mostrar.</div>';
      return;
    }

    container.innerHTML = entries.map((issue) => {
      const actionHtml = issue.action
        ? `<div class="map-contract-issue__actions">
             <button type="button" class="map-btn map-btn--ghost" data-action="${issue.action.action || ''}" data-map-id="${issue.action.mapId || ''}" data-area-id="${issue.action.areaId || ''}">${this.escapeHtml(issue.action.label)}</button>
           </div>`
        : '';
      return `
        <article class="map-contract-issue map-contract-issue--${issue.severity || 'info'}">
          <div class="map-contract-issue__meta">
            <span class="map-contract-issue__tag">${this.escapeHtml(issue.tag || 'Aviso')}</span>
          </div>
          <h4>${this.escapeHtml(issue.title || 'Incidencia')}</h4>
          <p>${this.escapeHtml(issue.description || '')}</p>
          ${actionHtml}
        </article>
      `;
    }).join('');
  },

  formatAuditTimestamp(timestamp) {
    if (!timestamp) {
      return '--';
    }
    const date = new Date(timestamp);
    if (Number.isNaN(date.getTime())) {
      return '--';
    }
    return date.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  },

  async handleContractIssueAction(action, dataset = {}) {
    switch (action) {
      case 'audit-connect-storage':
        this.handleConnect();
        return;
      case 'audit-open-map': {
        const mapId = Number(dataset.mapId);
        if (!mapId) {
          return;
        }
        await this.selectMap(mapId, { keepViewport: true });
        if (dataset.areaId) {
          const areaId = Number(dataset.areaId);
          setTimeout(() => this.focusArea(areaId), 200);
        }
        return;
      }
      case 'audit-open-assignment': {
        const mapId = Number(dataset.mapId);
        if (!mapId) {
          return;
        }
        await this.selectMap(mapId, { keepViewport: true });
        setTimeout(() => this.openAssignJerarquiaModal(mapId), 200);
        return;
      }
      default:
        return;
    }
  },

  updateAssignJerarquiaStatus() {
    const statusEl = document.getElementById('mapAssignLevelStatus');
    const warningsEl = document.getElementById('mapAssignWarnings');
    const allowFreeInput = document.getElementById('mapAssignAllowFree');

    if (!statusEl && !warningsEl && !allowFreeInput) {
      return;
    }

    const assignment = this.state.tempJerarquiaAssignment || { path: [], allowFreeLevel: false };
    const allowFreeLevel = allowFreeInput ? allowFreeInput.checked : Boolean(assignment.allowFreeLevel);

    if (allowFreeInput) {
      allowFreeInput.checked = allowFreeLevel;
    }

    if (allowFreeLevel) {
      if (statusEl) {
        statusEl.textContent = 'Nivel libre activado: este mapa aceptar reas sin anclar al rbol corporativo.';
      }
      if (warningsEl) {
        warningsEl.textContent = '';
        warningsEl.classList.add('hidden');
      }
      return;
    }

    const path = Array.isArray(assignment.path) ? assignment.path : [];
    if (!path.length) {
      if (statusEl) {
        statusEl.textContent = 'Selecciona un nodo hoja para vincular este mapa a la jerarquía corporativa.';
      }
      if (warningsEl) {
        warningsEl.textContent = '';
        warningsEl.classList.add('hidden');
      }
      return;
    }

    const level = this.getMapLevelFromPath(path);
    if (statusEl) {
      statusEl.textContent = `Nivel asignado: ${this.getMapLevelLabel(level)}. Ruta: ${this.getJerarquiaPathLabel(path)}.`;
    }

    if (!warningsEl) {
      return;
    }

    const conflicts = this.findMapLevelConflicts(path, assignment.mapId);
    if (conflicts.length) {
      const names = conflicts.map(map => this.escapeHtml(map.name || 'Sin nombre')).join(', ');
      warningsEl.innerHTML = `<strong>Advertencia:</strong> Este nivel ya está en uso por: ${names}.`;
      warningsEl.classList.remove('hidden');
    } else {
      warningsEl.textContent = '';
      warningsEl.classList.add('hidden');
    }
  },

  setupMapFormJerarquiaControls({
    allowFreeSelector = '#mapFormAllowFreeLevel',
    clearButtonSelector = '[data-action="map-form-clear-jerarquia"]'
  } = {}) {
    const allowFreeInput = typeof allowFreeSelector === 'string'
      ? document.querySelector(allowFreeSelector)
      : allowFreeSelector;
    if (allowFreeInput) {
      allowFreeInput.checked = Boolean(this.state.mapFormContext?.allowFreeLevel);
      allowFreeInput.addEventListener('change', () => {
        if (!this.state.mapFormContext) {
          this.state.mapFormContext = {};
        }
        this.state.mapFormContext.allowFreeLevel = allowFreeInput.checked;
        if (this.state.tempJerarquiaAssignment) {
          this.state.tempJerarquiaAssignment.allowFreeLevel = allowFreeInput.checked;
        }
        this.updateMapFormLevelStatus();
      });
    }

    const clearBtn = typeof clearButtonSelector === 'string'
      ? document.querySelector(clearButtonSelector)
      : clearButtonSelector;
    if (clearBtn) {
      clearBtn.addEventListener('click', (event) => {
        event.preventDefault();
        if (!this.state.tempJerarquiaAssignment) {
          this.state.tempJerarquiaAssignment = { mapId: null, path: [] };
        } else {
          this.state.tempJerarquiaAssignment.path = [];
        }
        if (this.state.tempJerarquiaAssignment) {
          this.state.tempJerarquiaAssignment.allowFreeLevel = Boolean(this.state.mapFormContext?.allowFreeLevel);
        }
        this.renderJerarquiaSelectorTree({
          containerId: 'mapJerarquiaSelectorContainer',
          selectedPath: []
        });
        this.updateJerarquiaAssignPreview();
        this.updateMapFormLevelStatus();
      });
    }
  },

  getJerarquiaOptionCatalog() {
    if (this.cachedJerarquiaOptions) {
      return this.cachedJerarquiaOptions;
    }

    const structureOptions = this.buildJerarquiaOptionSetsFromStructure(app?.jerarquiaAnidada);
    const mergedOptions = this.mergeWithFallbackJerarquiaOptions(structureOptions);
    this.cachedJerarquiaOptions = mergedOptions;
    return mergedOptions;
  },

  buildJerarquiaOptionSetsFromStructure(structure) {
    const empty = {
      planta: [],
      areaGeneral: [],
      subArea: [],
      sistemaEquipo: [],
      subSistema: [],
      seccion: [],
      subSeccion: []
    };

    if (!structure || !structure.empresa) {
      return empty;
    }

    const sets = Object.fromEntries(Object.keys(empty).map(key => [key, new Set()]));
    const addValue = (key, value) => {
      if (!key || !value) return;
      sets[key].add(value);
    };

    const traverse = (node, nivel) => {
      if (!node) return;
      const nombre = node.nombre || node.name || node.label || node.id;
      switch (nivel) {
        case 'empresa':
          addValue('planta', nombre);
          break;
        case 'area':
          addValue('areaGeneral', nombre);
          break;
        case 'subArea':
          addValue('subArea', nombre);
          break;
        case 'sistema':
          addValue('sistemaEquipo', nombre);
          break;
        case 'subSistema':
          addValue('subSistema', nombre);
          break;
        case 'seccion':
          addValue('seccion', nombre);
          break;
        case 'subSeccion':
          addValue('subSeccion', nombre);
          break;
        default:
          break;
      }

      const config = this.jerarquiaLevelConfig[nivel];
      if (!config?.childKey || !config?.childNivel) {
        return;
      }

      const children = node[config.childKey];
      if (Array.isArray(children)) {
        children.forEach(child => traverse(child, config.childNivel));
      }
    };

    traverse(structure.empresa, 'empresa');

    return Object.fromEntries(Object.entries(sets).map(([key, set]) => {
      const values = Array.from(set);
      values.sort((a, b) => a.localeCompare(b || '', 'es', { sensitivity: 'base' }));
      return [key, values];
    }));
  },

  mergeWithFallbackJerarquiaOptions(baseOptions = {}) {
    const clone = JSON.parse(JSON.stringify({
      planta: [],
      areaGeneral: [],
      subArea: [],
      sistemaEquipo: [],
      subSistema: [],
      seccion: [],
      subSeccion: [],
      ...baseOptions
    }));

    const pushUnique = (key, value) => {
      if (!value) return;
      if (!Array.isArray(clone[key])) clone[key] = [];
      if (!clone[key].includes(value)) {
        clone[key].push(value);
      }
    };

    const fallbackSources = [app?.opcionesJerarquia];
    fallbackSources.forEach(source => {
      if (!source) return;
      Object.entries(source).forEach(([key, values]) => {
        if (!Array.isArray(values)) return;
        values.forEach(value => pushUnique(key, value));
      });
    });

    Object.keys(clone).forEach(key => {
      if (Array.isArray(clone[key])) {
        clone[key].sort((a, b) => a.localeCompare(b || '', 'es', { sensitivity: 'base' }));
      }
    });

    return clone;
  },

  normalizeAreaJerarquia(jerarquia = {}) {
    const safe = jerarquia || {};
    return {
      planta: safe.planta || safe.nivel1 || safe.empresa || '',
      areaGeneral: safe.areaGeneral || safe.nivel2 || '',
      subArea: safe.subArea || safe.nivel3 || '',
      sistemaEquipo: safe.sistemaEquipo || safe.nivel4 || '',
      subSistema: safe.subSistema || safe.nivel5 || '',
      seccion: safe.seccion || safe.nivel6 || '',
      subSeccion: safe.subSeccion || safe.nivel7 || '',
      detalle: safe.detalle || ''
    };
  },

  getCurrentMapJerarquiaDefaults() {
    if (!this.state.currentMap || !Array.isArray(this.state.currentMap.jerarquiaPath)) {
      return {};
    }

    const path = this.state.currentMap.jerarquiaPath;
    const getLabel = (index) => {
      const node = path[index];
      if (!node) return '';
      return this.getJerarquiaNodeName(node);
    };

    return {
      planta: getLabel(0),
      areaGeneral: getLabel(1),
      subArea: getLabel(2),
      sistemaEquipo: getLabel(3),
      subSistema: getLabel(4),
      seccion: getLabel(5)
    };
  },

  //  ELIMINAR MAPA
  async deleteMap(mapId) {
    const numericId = typeof mapId === 'string' ? parseInt(mapId, 10) : mapId;
    const map = mapStorage.getMapById(numericId);
    
    if (!map) {
      this.showToast('Mapa no encontrado.', 'warning');
      return;
    }

    // Contar zonas asociadas
    const areasCount = (mapStorage.areas || []).filter(z => z.mapId === numericId).length;
    const confirmMessage = areasCount > 0
      ? `Eliminar "${map.name}"? Esto tambin eliminar ${areasCount} rea(s) asociada(s). Esta accin no se puede deshacer.`
      : `Eliminar "${map.name}"? Esta accin no se puede deshacer.`;

    if (!confirm(confirmMessage)) {
      return;
    }

    try {
      // Eliminar reas asociadas
      if (areasCount > 0) {
        const updatedAreas = (mapStorage.areas || []).filter(z => z.mapId !== numericId);
        await mapStorage.saveAreas(updatedAreas, { action: 'delete-cascade', mapId: numericId, detail: `${areasCount} reas eliminadas` });
      }

      // Eliminar mapa
      const updatedMaps = (mapStorage.maps || []).filter(m => m.id !== numericId);
      await mapStorage.saveMaps(updatedMaps, { action: 'delete', mapId: numericId, detail: map.name });

      let imageDeleteWarning = null;
      if (map.imagePath) {
        const deleteResult = await mapStorage.deleteMapImage(map.imagePath);
        if (!deleteResult.success && deleteResult.reason !== 'fs-offline' && deleteResult.reason !== 'no-path') {
          imageDeleteWarning = 'El mapa se elimin, pero la imagen no pudo borrarse. Revisa la consola para ms detalles.';
        }
      }

      // Limpiar estado actual si era el mapa activo
      if (this.state.currentMapId === numericId) {
        this.state.currentMapId = null;
        this.state.currentMap = null;
        this.state.areas = [];
        this.state.jerarquiaBranchFilter = null;
        this.cleanupImage();
      }

      await this.loadData({ force: true });
      this.showToast(`Mapa "${map.name}" eliminado correctamente.`, 'success');
      if (imageDeleteWarning) {
        this.showToast(imageDeleteWarning, 'warning');
      }
    } catch (error) {
      console.error('Error eliminando mapa:', error);
      this.showToast('No se pudo eliminar el mapa. Revisa la consola.', 'error');
    }
  },

  async cleanOrphanMapImages() {
    if (!mapStorage.initialized) {
      this.showToast('Conecta la carpeta antes de limpiar mapas.', 'info');
      return;
    }

    try {
      const stats = await mapStorage.cleanupOrphanMapImages();
      if (!stats.orphans) {
        this.showToast('No hay imgenes hurfanas en la carpeta de mapas.', 'success');
        return;
      }

      const message = stats.removed === stats.orphans
        ? `${stats.removed} imagen(es) hurfana(s) eliminada(s).`
        : `Se eliminaron ${stats.removed} de ${stats.orphans} imgenes hurfanas. Revisa la consola para los errores.`;
      this.showToast(message, stats.removed === stats.orphans ? 'success' : 'warning');
    } catch (error) {
      console.error('Error limpiando imgenes de mapas:', error);
      this.showToast('No se pudo limpiar la carpeta de mapas.', 'error');
    }
  },

  async startEditAreaPoints(areaId) {
    console.log(' Iniciando edicin de rea:', areaId);
    
    // Convertir a nmero si es string
    const numericId = typeof areaId === 'string' ? parseInt(areaId, 10) : areaId;
    
    // Validar ID
    if (isNaN(numericId)) {
      console.error(' ID de rea invlido:', areaId);
      this.showToast('Error: ID de rea invlido.', 'error');
      return;
    }
    
    console.log(' Buscando zona ID:', numericId, 'en:', this.state.areas.map(z => ({ id: z.id, name: z.name })));
    
    // Buscar zona
    const area = this.state.areas.find(z => z.id === numericId);
    if (!area || !area.points || area.points.length === 0) {
      console.error(' rea no encontrada o sin puntos. rea:', area);
      this.showToast('No se puede editar esta rea.', 'error');
      return;
    }

    console.log(' rea encontrada:', area.name, 'con', area.points.length, 'puntos');

    // Cancelar modo de dibujo si estaba activo
    if (this.state.drawing) {
      this.cancelDrawing();
    }

    // Activar modo de edicin
    this.state.editingAreaId = numericId;
    this.state.editingPoints = JSON.parse(JSON.stringify(area.points)); // Copia profunda
    this.state.selectedPointIndex = null;
    this.state.highlightAreaId = numericId;
    this.state.isDraggingPoint = false;

    console.log(' Estado de edicin configurado. Puntos editables:', this.state.editingPoints.length);

    // Actualizar UI
    this.elements.drawBtn?.classList.remove('map-btn--active');
    this.renderAreaList(this.state.areas);
    this.showEditPointButtons(area.name); // Mostrar botones
    this.draw();
    
    this.showToast(` Arrastra cualquier punto para ajustar la forma de "${area.name}"`, 'info', 4000);
  },

  showEditPointButtons(areaName) {
    // Crear contenedor de botones si no existe
    let buttonContainer = document.getElementById('editPointButtons');
    if (!buttonContainer) {
      buttonContainer = document.createElement('div');
      buttonContainer.id = 'editPointButtons';
      buttonContainer.style.cssText = `
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        display: flex;
        gap: 12px;
        padding: 16px 24px;
        background: rgba(15, 23, 42, 0.95);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
      `;
      document.body.appendChild(buttonContainer);
    }

    buttonContainer.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px; color: white; font-size: 0.9rem; font-weight: 500;">
        <span style="padding-right: 12px; border-right: 1px solid rgba(255, 255, 255, 0.2);">
           Editando: ${this.escapeHtml(areaName)}
        </span>
        <button id="saveEditPoints" style="
          padding: 10px 20px;
          background: #22c55e;
          color: white;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          font-size: 0.9rem;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        " onmouseover="this.style.background='#16a34a'; this.style.transform='translateY(-2px)'" 
           onmouseout="this.style.background='#22c55e'; this.style.transform='translateY(0)'">
           Guardar cambios
        </button>
        <button id="cancelEditPoints" style="
          padding: 10px 20px;
          background: #ef4444;
          color: white;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          font-size: 0.9rem;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        " onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-2px)'" 
           onmouseout="this.style.background='#ef4444'; this.style.transform='translateY(0)'">
           Cancelar
        </button>
      </div>
    `;

    // Event listeners
    document.getElementById('saveEditPoints').addEventListener('click', () => {
      this.saveEditedAreaPoints();
    });

    document.getElementById('cancelEditPoints').addEventListener('click', () => {
      this.exitEditZonePoints();
      this.showToast('Edicin cancelada', 'info');
    });
  },

  hideEditPointButtons() {
    const buttonContainer = document.getElementById('editPointButtons');
    if (buttonContainer) {
      buttonContainer.remove();
    }
  },

  exitEditZonePoints() {
    console.log(' Saliendo del modo edicin');
    this.hideEditPointButtons(); // Ocultar botones
    this.state.editingAreaId = null;
    this.state.editingPoints = [];
    this.state.selectedPointIndex = null;
    this.state.isDraggingPoint = false;
    this.elements.canvas.style.cursor = 'default';
    this.draw();
  },

  async saveEditedAreaPoints() {
    if (!this.state.editingAreaId || this.state.editingPoints.length === 0) {
      console.log(' No hay zona en edicin o no hay puntos');
      return;
    }

    const numericId = this.state.editingAreaId;
    console.log(' Guardando zona ID:', numericId);
    console.log(' Puntos editados:', this.state.editingPoints.length);
    console.log(' Puntos:', JSON.stringify(this.state.editingPoints));
    
    // Recargar zonas desde storage para asegurar que tenemos la ltima versin
    if (!mapStorage.initialized) {
      console.error(' MapStorage no inicializado');
      this.showToast('Error: Sistema de almacenamiento no disponible.', 'error');
      return;
    }
    
    // Asegurarse de que mapStorage.areas est actualizado
    console.log(' Total reas en mapStorage:', mapStorage.areas.length);
    console.log(' Zonas:', mapStorage.areas.map(z => ({ id: z.id, name: z.name })));
    
    const area = mapStorage.areas.find(z => z.id === numericId);
    
    if (!area) {
      console.error(' rea no encontrada en storage. Buscando ID:', numericId);
      console.error(' IDs disponibles:', mapStorage.areas.map(z => z.id));
      this.showToast('Error: rea no encontrada.', 'error');
      this.exitEditZonePoints();
      return;
    }

    console.log(' rea encontrada:', area.name, 'Puntos originales:', area.points?.length);
    console.log(' mapId de la rea:', area.mapId);
    console.log(' currentMapId:', this.state.currentMapId);

    try {
      // Actualizar los puntos de la zona
      const updatedArea = {
        ...area,
        points: [...this.state.editingPoints], // Copia limpia
        updatedAt: new Date().toISOString()
      };

      console.log(' rea actualizada:', updatedArea.name, 'Nuevos puntos:', updatedArea.points.length);
      console.log(' updatedArea.mapId:', updatedArea.mapId);

      // Actualizar en el array global
      mapStorage.areas = mapStorage.areas.map(z => z.id === numericId ? updatedArea : z);
      
      console.log(' Guardando en filesystem...');
      await mapStorage.saveAreas(mapStorage.areas, {
        action: 'update',
        mapId: this.state.currentMapId,
        areaId: numericId,
        detail: `Editados ${this.state.editingPoints.length} puntos de "${area.name}"`
      });
      console.log(' Guardado exitoso');

      // Recargar zonas del mapa actual
      console.log(' Recargando zonas para mapId:', this.state.currentMapId);
      console.log(' Zonas totales en storage:', mapStorage.areas.length);
      console.log(' Detalle zonas:', mapStorage.areas.map(z => ({ id: z.id, name: z.name, mapId: z.mapId })));
      
      this.state.areas = mapStorage.getAreasByMap(this.state.currentMapId);
      console.log(' Zonas recargadas del mapa actual:', this.state.areas.length);
      
      this.exitEditZonePoints();
      this.renderAreaList(this.state.areas);
      this.draw();
      
      this.showToast(` Forma de "${area.name}" actualizada correctamente.`, 'success');
    } catch (error) {
      console.error(' Error guardando puntos editados:', error);
      this.showToast('No se pudo guardar los cambios. Revisa la consola.', 'error');
    }
  },

  async openEditAreaMetadataModal(areaId) {
    console.log(' openEditAreaMetadataModal llamado con areaId:', areaId);
    
    // Este mtodo abre el modal para editar nombre, color, jerarqua, etc.
    const numericId = typeof areaId === 'string' ? parseInt(areaId, 10) : areaId;
    console.log(' numericId:', numericId);
    
    // Buscar en las reas del mapa actual
    const area = this.state.areas.find(z => z.id === numericId);
    if (!area) {
      console.error(' rea no encontrada. ID buscado:', areaId, 'Zonas disponibles:', this.state.areas.map(z => ({ id: z.id, name: z.name })));
      this.showToast('No se encontr la zona especificada.', 'error');
      return;
    }

    console.log(' rea encontrada:', area.name);

    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) {
      console.error(' Modal o body no encontrado. modal:', modal, 'body:', body);
      return;
    }

    console.log(' Elementos modal encontrados');

    this.elements.modalTitle.textContent = 'editar rea';

    const jerarquia = this.normalizeAreaJerarquia(area.jerarquia);
    const equiposText = Array.isArray(area.equipos) ? area.equipos.join('\n') : '';
    
    const jerarquiaOptions = this.getJerarquiaOptionCatalog();
    const buildDatalist = (id, values) => {
      if (!Array.isArray(values) || !values.length) return '';
      return `<datalist id="${id}">${values.map(v => `<option value="${this.escapeHtml(v)}"></option>`).join('')}</datalist>`;
    };

    //  Generar opciones de categoras dinmicamente desde mapController.categories
    const categoryOptions = Object.entries(this.categories).map(([key, cat]) => {
      const selected = (area.category || 'area') === key ? 'selected' : '';
      return `<option value="${key}" ${selected}>${cat.icon} ${cat.name} - ${cat.description}</option>`;
    }).join('');

    body.innerHTML = `
      <form id="editAreaForm" class="map-area-form">
        <div class="form-group">
          <label>Nombre del rea</label>
          <input type="text" name="areaName" required placeholder="Ej: Planta Principal" value="${this.escapeHtml(area.name || '')}" />
        </div>
        
        <!--  NUEVO: Selector de categora (dinmico) -->
        <div class="form-group" style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 1.1rem;"></span>
            <span>Categora del rea</span>
          </label>
          <select name="category" id="editCategorySelect" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.95rem;">
            ${categoryOptions}
          </select>
          <small style="display: block; margin-top: 8px; color: var(--text-muted); font-size: 0.8rem;">
             La categora determina el icono y color sugerido del rea. <a href="#" onclick="event.preventDefault(); app.switchTab('configuracion'); app.closeModal();" style="color: var(--info); text-decoration: underline;">Gestionar categoras</a>
          </small>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Color</label>
            <input type="color" name="areaColor" value="${area.color || '#3b82f6'}" />
          </div>
          <div class="form-group">
            <label>Opacidad</label>
            <input type="range" name="areaOpacity" min="10" max="90" value="${Math.round((area.opacity || 0.35) * 100)}" />
          </div>
        </div>
        
        <!--  NUEVO: Controles para posicionar el nombre en el canvas -->
        <div class="form-group" style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 1.1rem;"></span>
            <span>Posicin del nombre en el mapa</span>
          </label>
          <div class="form-row" style="gap: 12px;">
            <div class="form-group" style="flex: 1;">
              <label style="font-size: 0.85rem; color: var(--text-secondary);">Desplazar horizontalmente (X)</label>
              <input type="number" name="labelOffsetX" value="${area.labelOffsetX || 0}" step="10" placeholder="0" 
                     style="text-align: center;" title="Valores positivos mueven a la derecha, negativos a la izquierda" />
              <small style="color: var(--text-muted); font-size: 0.75rem;"> Izq (-)  |  Der (+) </small>
            </div>
            <div class="form-group" style="flex: 1;">
              <label style="font-size: 0.85rem; color: var(--text-secondary);">Desplazar verticalmente (Y)</label>
              <input type="number" name="labelOffsetY" value="${area.labelOffsetY || 0}" step="10" placeholder="0" 
                     style="text-align: center;" title="Valores positivos mueven hacia abajo, negativos hacia arriba" />
              <small style="color: var(--text-muted); font-size: 0.75rem;"> Arriba (-)  |  Abajo (+) </small>
            </div>
          </div>
          <small style="display: block; margin-top: 8px; color: var(--text-muted); font-size: 0.8rem;">
             Usa estos valores para evitar que los nombres se monten unos sobre otros
          </small>
        </div>
        
        <div class="form-group">
          <label>Empresa / Planta (N1)</label>
          <input type="text" name="planta" list="plantaList" placeholder="Ej: Aquachile Antarfood" value="${this.escapeHtml(jerarquia.planta || '')}" />
          ${buildDatalist('plantaList', jerarquiaOptions.planta)}
        </div>
        <div class="form-group">
          <label>rea General (N2)</label>
          <input type="text" name="areaGeneral" list="areaGeneralList" placeholder="Ej: Planta Principal" value="${this.escapeHtml(jerarquia.areaGeneral || '')}" />
          ${buildDatalist('areaGeneralList', jerarquiaOptions.areaGeneral)}
        </div>
        <div class="form-group">
          <label>Sub-rea (N3)</label>
          <input type="text" name="subArea" list="subAreaList" placeholder="Ej: Estanques" value="${this.escapeHtml(jerarquia.subArea || '')}" />
          ${buildDatalist('subAreaList', jerarquiaOptions.subArea)}
        </div>
        <div class="form-group">
          <label>Sistema / Equipo (N4)</label>
          <input type="text" name="sistemaEquipo" list="sistemaEquipoList" placeholder="Ej: Grader Baader" value="${this.escapeHtml(jerarquia.sistemaEquipo || '')}" />
          ${buildDatalist('sistemaEquipoList', jerarquiaOptions.sistemaEquipo)}
        </div>
        <div class="form-group">
          <label>Sub-sistema (N5)</label>
          <input type="text" name="subSistema" list="subSistemaList" placeholder="Ej: Motor Principal" value="${this.escapeHtml(jerarquia.subSistema || '')}" />
          ${buildDatalist('subSistemaList', jerarquiaOptions.subSistema)}
        </div>
        <div class="form-group">
          <label>Seccin (N6)</label>
          <input type="text" name="seccion" list="seccionList" placeholder="Ej: Mdulo 1" value="${this.escapeHtml(jerarquia.seccion || '')}" />
          ${buildDatalist('seccionList', jerarquiaOptions.seccion)}
        </div>
        <div class="form-group">
          <label>Equipos / maquinas (uno por linea)</label>
          <textarea name="equipos" rows="4" placeholder="Ej:\nMotor principal\nBanda transportadora">${this.escapeHtml(equiposText)}</textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="map-btn map-btn--ghost" id="cancelEditAreaBtn">Cancelar</button>
          <button type="submit" class="map-btn map-btn--primary">Guardar cambios</button>
        </div>
      </form>
    `;

    console.log(' HTML del formulario generado, mostrando modal...');
    
    modal.classList.remove('hidden');

    console.log(' Modal visible, agregando event listeners...');

    //  NUEVO: Event listener para cambiar color al seleccionar categora
    const categorySelect = document.getElementById('editCategorySelect');
    const colorInput = document.querySelector('input[name="areaColor"]');
    if (categorySelect && colorInput) {
      categorySelect.addEventListener('change', (e) => {
        const selectedCategory = e.target.value;
        const categoryData = this.categories[selectedCategory];
        if (categoryData && categoryData.color) {
          colorInput.value = categoryData.color;
        }
      });
    }

    // Event listener para cancelar
    const cancelBtn = document.getElementById('cancelEditAreaBtn');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => {
        this.closeModal();
      });
    }

    // Event listener para submit
    const form = document.getElementById('editAreaForm');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await this.updateAreaFromForm(areaId, new FormData(e.target));
      });
    }
  },

  async updateAreaFromForm(areaId, formData) {
    try {
      // Convertir a nmero si es string
      const numericId = typeof areaId === 'string' ? parseInt(areaId, 10) : areaId;
      
      const name = formData.get('areaName')?.trim();
      if (!name) {
        this.showToast('El Nombre del rea es obligatorio.', 'error');
        return;
      }

      const color = formData.get('areaColor') || '#3b82f6';
      const opacity = parseFloat(formData.get('areaOpacity')) / 100 || 0.35; // Convertir de 0-100 a 0-1
      
      //  NUEVO: Obtener categora seleccionada
      const category = (formData.get('category') || 'area').toString().trim();
      
      //  NUEVO: Obtener offsets de posicin del nombre
      const labelOffsetX = parseInt(formData.get('labelOffsetX'), 10) || 0;
      const labelOffsetY = parseInt(formData.get('labelOffsetY'), 10) || 0;
      
      //  Construir jerarqua con los nombres correctos
      const jerarquia = {};
      const planta = formData.get('planta')?.trim();
      const areaGeneral = formData.get('areaGeneral')?.trim();
      const subArea = formData.get('subArea')?.trim();
      const sistemaEquipo = formData.get('sistemaEquipo')?.trim();
      const subSistema = formData.get('subSistema')?.trim();
      const seccion = formData.get('seccion')?.trim();
      
      if (planta) jerarquia.planta = planta;
      if (areaGeneral) jerarquia.areaGeneral = areaGeneral;
      if (subArea) jerarquia.subArea = subArea;
      if (sistemaEquipo) jerarquia.sistemaEquipo = sistemaEquipo;
      if (subSistema) jerarquia.subSistema = subSistema;
      if (seccion) jerarquia.seccion = seccion;

      const equiposText = formData.get('equipos')?.trim() || '';
      const equipos = equiposText.split('\n').map(e => e.trim()).filter(Boolean);

      // Buscar la zona en el array global de mapStorage
      const area = mapStorage.areas.find(z => z.id === numericId);
      if (!area) {
        console.error('rea no encontrada en mapStorage. ID buscado:', areaId, 'Zonas en mapStorage:', mapStorage.areas.map(z => ({ id: z.id, name: z.name })));
        this.showToast('No se encontr la zona especificada.', 'error');
        return;
      }

      const updatedArea = {
        ...area,
        name,
        color,
        opacity,
        category, //  NUEVO: Categora actualizada
        labelOffsetX, //  NUEVO: Offset horizontal del nombre
        labelOffsetY, //  NUEVO: Offset vertical del nombre
        jerarquia,
        equipos,
        updatedAt: new Date().toISOString()
      };

      // Actualizar en el array global
      mapStorage.areas = mapStorage.areas.map(z => z.id === numericId ? updatedArea : z);
      
      // Guardar con metadata para el log
      await mapStorage.saveAreas(mapStorage.areas, {
        action: 'update',
        mapId: this.state.currentMapId,
        areaId: numericId,
        detail: `Actualizada zona "${name}"`
      });

      // Recargar y actualizar UI
      this.state.areas = mapStorage.getAreasByMap(this.state.currentMapId);
      this.renderAreaList(this.state.areas);
      this.draw();
      this.closeModal();
      this.showToast(` Zona "${name}" actualizada correctamente.`, 'success');
    } catch (error) {
      console.error(' Error actualizando rea:', error);
      this.showToast('No se pudo actualizar el rea. Revisa la consola.', 'error');
    }
  },

  async deleteArea(areaId) {
    // Convertir a nmero si es string
    const numericId = typeof areaId === 'string' ? parseInt(areaId, 10) : areaId;
    
    // Validar que sea un nmero vlido
    if (isNaN(numericId) || numericId === null || numericId === undefined) {
      console.error('ID de rea invlido:', zoneId, 'tipo:', typeof areaId);
      this.showToast('Error: ID de rea invlido.', 'error');
      return;
    }
    
    console.log(' Intentando Eliminar rea con ID:', numericId);
    console.log('Zonas actuales en mapStorage:', mapStorage.areas.map(z => ({ id: z.id, name: z.name })));
    
    // Buscar en las reas del mapa actual
    const area = this.state.areas.find(z => z.id === numericId);
    if (!area) {
      console.error('rea no encontrada. ID buscado:', numericId, 'Zonas disponibles:', this.state.areas.map(z => ({ id: z.id, name: z.name })));
      this.showToast('No se encontr la zona especificada.', 'error');
      return;
    }

    const confirmed = confirm(`Eliminar la zona "${area.name}"?\n\nEsta accin no se puede deshacer.`);
    if (!confirmed) return;

    try {
      // Guardar cantidad antes de eliminar
      const beforeCount = mapStorage.areas.length;
      
      // Eliminar del array global usando el ID numrico
      mapStorage.areas = mapStorage.areas.filter(z => {
        const keep = z.id !== numericId;
        if (!keep) {
          console.log(' Eliminando rea:', z.id, z.name);
        }
        return keep;
      });
      
      const afterCount = mapStorage.areas.length;
      console.log(`Zonas antes: ${beforeCount}, despus: ${afterCount}, eliminadas: ${beforeCount - afterCount}`);
      
      await mapStorage.saveAreas();

      // Recargar zonas del mapa actual
      this.state.areas = mapStorage.getAreasByMap(this.state.currentMapId);
      
      // Limpiar highlight si era esta rea
      if (this.state.highlightAreaId === numericId) {
        this.state.highlightAreaId = null;
      }

      this.renderAreaList(this.state.areas);
      this.drawCanvas();
      this.showToast(`Zona "${area.name}" eliminada correctamente.`, 'success');
    } catch (error) {
      console.error('Error eliminando rea:', error);
      this.showToast('No se pudo eliminar el rea. Revisa la consola.', 'error');
    }
  },

  async refreshLog() {
    const events = mapStorage.initialized ? await mapStorage.readLog(30) : [];
    this.renderLog(events);
  },

  renderLog(events) {
    const { logList } = this.elements;
    if (!logList) return;

    if (!Array.isArray(events) || !events.length) {
      logList.innerHTML = `<div style="color: var(--text-secondary); padding: 12px;">Sin eventos registrados.</div>`;
      return;
    }

    // Obtener filtros
    const filterAction = document.getElementById('mapLogFilterAction')?.value || 'all';
    const filterScope = document.getElementById('mapLogFilterScope')?.value || 'all';

    // Filtrar eventos
    const filteredEvents = events.filter(event => {
      const matchAction = filterAction === 'all' || event.action === filterAction;
      const matchScope = filterScope === 'all' || event.scope === filterScope;
      return matchAction && matchScope;
    });

    if (!filteredEvents.length) {
      logList.innerHTML = `<div style="color: var(--text-secondary); padding: 12px;">No hay eventos que coincidan con los filtros.</div>`;
      return;
    }

    logList.innerHTML = filteredEvents.map(event => {
      const timestamp = event.timestamp ? new Date(event.timestamp).toLocaleString('es-CL', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : '';
      
      const scope = event.scope || 'maps';
      const action = event.action || 'update';
      const detail = event.detail ? `  ${this.escapeHtml(event.detail)}` : '';
      
      // Color-coding por accin
      let actionColor = '#64748b'; // Gris por defecto
      let actionIcon = '';
      let actionText = 'Actualizado';
      
      if (action === 'create') {
        actionColor = '#10b981'; // Verde
        actionIcon = '';
        actionText = 'Creado';
      } else if (action === 'update') {
        actionColor = '#3b82f6'; // Azul
        actionIcon = '';
        actionText = 'Actualizado';
      } else if (action === 'delete') {
        actionColor = '#ef4444'; // Rojo
        actionIcon = '';
        actionText = 'Eliminado';
      }
      
      const scopeIcon = scope === 'maps' ? '' : '';
      const scopeText = scope === 'maps' ? 'Mapa' : 'Zona';
      
      // Agregar atributos para hacer clickable
      const clickable = event.mapId || event.zoneId;
      const cursorStyle = clickable ? 'cursor: pointer;' : '';
      const hoverStyle = clickable ? 'transition: all 0.2s; &:hover { background: rgba(59, 130, 246, 0.1); }' : '';
      
      return `
        <div class="map-log-entry" 
             data-map-id="${event.mapId || ''}" 
             data-area-id="${event.zoneId || ''}"
             style="padding: 10px 12px; border-left: 3px solid ${actionColor}; margin-bottom: 6px; border-radius: 4px; background: var(--surface-color); ${cursorStyle} ${hoverStyle}">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <time style="font-size: 0.75rem; color: var(--text-secondary);">${timestamp}</time>
            <span style="font-size: 0.75rem; padding: 2px 6px; border-radius: 3px; background: ${actionColor}20; color: ${actionColor}; font-weight: 500;">
              ${actionIcon} ${actionText}
            </span>
          </div>
          <div style="font-size: 0.85rem; color: var(--text-primary);">
            ${scopeIcon} <strong>${scopeText}</strong>${detail}
          </div>
        </div>
      `;
    }).join('');

    // Agregar event listeners para entradas clickables
    Array.from(logList.querySelectorAll('.map-log-entry')).forEach(entry => {
      const mapId = entry.getAttribute('data-map-id');
      const areaId = entry.getAttribute('data-area-id');
      
      if (mapId || areaId) {
        entry.addEventListener('click', () => {
          if (zoneId && mapId) {
            // Si tiene zoneId, ir a ese mapa y enfocar la zona
            this.selectMap(parseInt(mapId, 10));
            setTimeout(() => {
              this.focusArea(parseInt(zoneId, 10));
            }, 300);
          } else if (mapId) {
            // Solo mapId, ir al mapa
            this.selectMap(parseInt(mapId, 10));
          }
        });
      }
    });
  },

  showHistorialHelp() {
    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) return;

    this.elements.modalTitle.textContent = ' Qu es el Historial?';

    body.innerHTML = `
      <div style="padding: 16px; line-height: 1.6;">
        <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 1.1rem;"> Registro de actividades</h3>
        <p style="margin: 0 0 16px 0; color: var(--text-secondary);">
          El historial registra automticamente todas las acciones que realizas en mapas y zonas, 
          creando un registro de auditora completo con marca de tiempo.
        </p>

        <h4 style="margin: 16px 0 8px 0; color: var(--text-primary); font-size: 0.95rem;"> Qu se registra?</h4>
        <ul style="margin: 0 0 16px 0; padding-left: 24px; color: var(--text-secondary);">
          <li style="margin-bottom: 6px;"> <strong style="color: #10b981;">Creacin</strong>: Cuando creas un nuevo mapa o zona</li>
          <li style="margin-bottom: 6px;"> <strong style="color: #3b82f6;">Actualizacin</strong>: Cuando editas datos o formas</li>
          <li style="margin-bottom: 6px;"> <strong style="color: #ef4444;">Eliminacin</strong>: Cuando borras mapas o zonas</li>
        </ul>

        <h4 style="margin: 16px 0 8px 0; color: var(--text-primary); font-size: 0.95rem;"> Filtros disponibles</h4>
        <p style="margin: 0 0 8px 0; color: var(--text-secondary);">
          Usa los selectores para filtrar eventos por:
        </p>
        <ul style="margin: 0 0 16px 0; padding-left: 24px; color: var(--text-secondary);">
          <li style="margin-bottom: 6px;"><strong>Tipo de accin:</strong> Creadas, Actualizadas o Eliminadas</li>
          <li style="margin-bottom: 6px;"><strong>mbito:</strong> Solo Mapas o Solo Zonas</li>
        </ul>

        <h4 style="margin: 16px 0 8px 0; color: var(--text-primary); font-size: 0.95rem;"> Navegacin rpida</h4>
        <p style="margin: 0 0 16px 0; color: var(--text-secondary);">
          Haz <strong>click en cualquier entrada</strong> del historial para saltar directamente al mapa o zona correspondiente.
        </p>

        <div style="margin-top: 24px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid #3b82f6;">
          <p style="margin: 0; color: var(--text-primary); font-size: 0.85rem;">
            <strong> Tip:</strong> El historial se guarda en archivo <code>mapas-history.log</code> dentro de la carpeta de logs para mantener un registro permanente.
          </p>
        </div>

        <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
          <button type="button" id="closeHistorialHelpBtn" class="map-btn map-btn--primary">Entendido</button>
        </div>
      </div>
    `;

    modal.classList.remove('hidden');

    // Event listener para cerrar
    const closeBtn = document.getElementById('closeHistorialHelpBtn');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        this.closeModal();
      });
    }
  },

  showHint(text) {
    const hint = this.elements.hint;
    if (!hint) return;
    hint.textContent = text;
    hint.classList.remove('hidden');
  },

  hideHint() {
    const hint = this.elements.hint;
    if (!hint) return;
    hint.classList.add('hidden');
  },

  escapeHtml(text) {
    return text
      .toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  },

  hexToRgba(hex, alpha = 0.35) {
    let normalized = hex.replace('#', '').trim();
    if (normalized.length === 3) {
      normalized = normalized.split('').map(char => char + char).join('');
    }
    const bigint = parseInt(normalized, 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  },

  showToast(message, type = 'info') {
    if (typeof app?.showToast === 'function') {
      app.showToast(message, type);
    } else {
      console.log(`[${type}] ${message}`);
    }
  }
};

if (window.appEvents && typeof window.appEvents.on === 'function') {
  window.appEvents.on('jerarquia:structure-updated', (detail) => {
    mapController.handleJerarquiaStructureUpdate(detail || {});
  });

  window.appEvents.on('jerarquia:catalogs-updated', (detail) => {
    mapController.handleJerarquiaCatalogUpdate(detail || {});
  });
} else {
  console.warn(' appEvents no disponible todavia para mapController');
}

console.log(' MapController definido');

window.addEventListener('load', () => {
  if (window.app && typeof window.app.initJerarquiaSearch === 'function') {
    window.app.initJerarquiaSearch();
  }
});

/* FIN MAP CONTROLLER */

// ============================================
//  SISTEMA DE ACORDEN PARA CONFIGURACIN
// ============================================
function toggleConfigSection(sectionId) {
  const content = document.getElementById(sectionId + '-content');
  const icon = document.getElementById(sectionId + '-icon');
  
  if (!content || !icon) return;
  
  const isCollapsed = content.style.display === 'none';
  
  if (isCollapsed) {
    content.style.display = 'block';
    icon.textContent = '';
  } else {
    content.style.display = 'none';
    icon.textContent = '';
  }
  
  // Guardar estado en localStorage
  localStorage.setItem('config-' + sectionId, isCollapsed ? 'open' : 'closed');
}

function initConfigSections() {
  // Lista de secciones con estado por defecto colapsado
  const sections = [
    'storage-config',
    'export-config',
    'backup-config',
    'listas-config',
    'herramientas-config'
  ];
  
  sections.forEach(sectionId => {
    const content = document.getElementById(sectionId + '-content');
    const icon = document.getElementById(sectionId + '-icon');
    
    if (!content || !icon) return;
    
    // Leer estado guardado o usar 'closed' por defecto
    const savedState = localStorage.getItem('config-' + sectionId) || 'closed';
    
    if (savedState === 'closed') {
      content.style.display = 'none';
      icon.textContent = '';
    } else {
      content.style.display = 'block';
      icon.textContent = '';
    }
  });
}

class InventarioCompleto {
  constructor() {
    this.repuestos = [];
    this.conteoData = {};
    this.conteoActivo = false;
    this.currentView = 'cards';
    this.currentTab = 'inventario';
    this.mapTool = 'select';
    this.mapObjects = [];
    this.mapImage = null;
    this.currentMultimedia = [];
    this.currentDocuments = [];
    this.currentEditingId = null;
    
    // Sistema de eliminación diferida de multimedia
    this.pendingDeletions = [];           // Archivos físicos a eliminar al guardar
    this.originalMultimedia = [];         // Backup para "Cancelar"
    
    this.currentPage = 1;
    this.itemsPerPage = 'auto'; // Modo automtico responsive por defecto
    this.itemsPerPageManual = 21; // Valor manual cuando no es auto
    this.viewMode = localStorage.getItem('viewMode') || 'auto'; // 'auto', 'mobile', 'desktop'
    this.isEdge = this.detectEdge(); // Detectar si es Microsoft Edge
    this.isEdgeIOS = false; // Se setea en detectEdge() si es Edge iOS
    this.filteredRepuestos = [];
    this.showPrecio = false;
    this.autocompleteData = { codProv: [], tipo: [], area: [], equipo: [] };
    this.lightboxMedias = [];
    this.lightboxIndex = 0;
    this.canvas = null;
    this.ctx = null;
    this.listSortField = 'codSAP';
    this.listSortOrder = 'asc';
    this.columnWidths = ['50px', '0.9fr', '1.5fr', '160px', '220px'];
  this.currentJerarquiaPalette = 'palette-visual';
  this.lastVisualV2Refresh = 0;
    
    // Sistema de Undo/Redo
    this.historyStack = [];  // Pila de estados anteriores
    this.redoStack = [];     // Pila de estados rehechos
    this.maxHistorySize = 50; // Máximo de estados a guardar
    this.draggedSAPNode = null;
    this.dropPosition = null;

    //  Estado del asistente por pasos (Layout 8)
    this.wizardState = {
      currentStep: 1,
      totalSteps: 0,
      steps: [],
      indicators: [],
      stepsVisited: new Set([1]),
      maxCompletedStep: 1,
      nextBtn: null,
      prevBtn: null,
      saveBtn: null,
      pendingInvalidField: null,
      lastValidationError: null
    };

    this.handleWizardNext = this.handleWizardNext.bind(this);
    this.handleWizardPrev = this.handleWizardPrev.bind(this);
    this.handleWizardIndicatorClick = this.handleWizardIndicatorClick.bind(this);
    
    //  SISTEMA DE NOTIFICACIONES PERSISTENTE
    this.notifications = [];
    this.unreadNotifications = 0;
    this.notificationPanel = null;
    this.notificationBell = null;
    
    // Cargar notificaciones desde localStorage (con fallback seguro)
    try {
      const saved = localStorage.getItem('notifications');
      if (saved) {
        this.notifications = JSON.parse(saved);
      }
    } catch (error) {
      console.warn(' Error cargando notificaciones guardadas:', error);
      this.notifications = [];
    }
    
    //  CONTROL DE VERSIN DE UBICACIONES
    // true = usa renderUbicacionesCascada() (NUEVA versin con selects en cascada)
    // false = usa renderUbicaciones() (versin ORIGINAL con inputs + datalist)
    this.usarVersionCascada = true; //  CAMBIAR A false PARA VOLVER A LA VERSIN ORIGINAL
    
    this.sistemaPorEquipo = {
      'Grader': [
        'Pocket 1', 'Pocket 2', 'Pocket 3', 'Pocket 4',
        'Cinta Z', 'Cinta Aceleracin 1', 'Cinta Aceleracin 2', 'Cinta Larga',
        'Sistema Hidrulico', 'Sistema Neumtico', 'Panel Elctrico Principal',
        'Tablero Control', 'Motor Principal', 'Otro'
      ],
      'Compresor': [
        'Motor Principal', 'Tanque Almacenamiento', 'Vlvulas Control',
        'Sistema Refrigeracin', 'Panel Control', 'Filtros Aire', 'Otro'
      ],
      'Bomba': [
        'Motor Elctrico', 'Impulsor', 'Carcasa', 'Sellos Mecnicos',
        'Rodamientos', 'Base y Acople', 'Vlvulas', 'Otro'
      ],
      'Transportador': [
        'Banda/Cadena', 'Motor Traccin', 'Rodillos', 'Tensor',
        'Estructura Soporte', 'Sistema Guas', 'Otro'
      ],
      'default': [
        'Motor', 'Transmisin', 'Sistema Elctrico', 'Sistema Hidrulico',
        'Sistema Neumtico', 'Estructura', 'Controles', 'Otro'
      ]
    };
    
    this.customSistemas = this.loadCustomSistemas();
    
    this.plantaBase = 'Aquachile Antarfood Chonchi';
    
    // ===============================================
    //  NUEVA ESTRUCTURA JERRQUICA ANIDADA
    // ===============================================
    // Estructura en rbol para jerarqua real
    this.jerarquiaAnidada = null; // Se carga desde localStorage o se inicializa
    this.loadJerarquiaAnidada(); // Cargar o crear estructura
    
    // ===============================================
    //  MTODO HELPER PARA ALTERNAR VERSIONES (DEBUG)
    // ===============================================
    window.toggleVersionUbicaciones = () => {
      this.usarVersionCascada = !this.usarVersionCascada;
      console.log(` Versin de ubicaciones cambiada a: ${this.usarVersionCascada ? 'CASCADA (nueva)' : 'ORIGINAL (inputs)'}`);
      
      // Re-renderizar si hay modal abierto
      const modal = document.getElementById('repuestoModal');
      if (modal && modal.classList.contains('show')) {
        if (this.usarVersionCascada) {
          this.renderUbicacionesCascada();
        } else {
          this.renderUbicaciones();
        }
        console.log(' Modal re-renderizado con nueva versin');
      }
    };
    
    // ===============================================
    // CONFIGURACIN DE ORGANIZACIN DE IMGENES
    // ===============================================
    this.nivelJerarquiaImagenes = parseInt(localStorage.getItem('nivelJerarquiaImagenes')) || 1;
    // 1 = Solo rea General
    // 2 = rea + Sistema/Equipo
    // 3 = Jerarqua Completa (rea > Subrea > Sistema)
    
    this.renombrarImagenesAutomaticamente = localStorage.getItem('renombrarImagenesAuto') !== 'false'; // true por defecto
    this.eliminarImagenAntiguaAlMover = localStorage.getItem('eliminarImagenAntigua') === 'true'; // false por defecto
    this.longitudMaximaNombreArchivo = 100; // Mximo caracteres para nombres de archivo
    
    // Opciones predefinidas por defecto (solo se usan si no hay nada guardado)
    this.opcionesJerarquiaPredefinidas = {
      'areaGeneral': [
        'Planta Principal',
        'Acopio',
        'Planta Yal',
        'Estanques Agua',
        'Estanque Inox',
        'Entretecho',
        'Bodega General',
        'Zona Externa',
        'rea de Mantencin',
        'GENERAL'
      ],
      'subArea': [
        'Zona Norte',
        'Zona Sur',
        'Piso 1',
        'Piso 2',
        'Sector A',
        'Sector B',
        'Pasillo Central',
        'Lnea 1',
        'Lnea 2'
      ],
      'sistemaEquipo': [
        'Grader Marel',
        'Compresor Atlas Copco',
        'Cinta Transportadora 1',
        'Cinta Transportadora 2',
        'Bomba Principal',
        'Sistema Hidrulico',
        'Panel Elctrico Central',
        'Grader',
        'Compresor 01',
        'Compresor 02'
      ],
      'subSistema': [
        'Motor Principal',
        'Sistema de Lubricacin',
        'Tablero de Control',
        'Pocket 1',
        'Pocket 2',
        'Pocket 3',
        'Pocket 4',
        'Cinta Z',
        'Cinta Aceleracin 1',
        'Cinta Aceleracin 2',
        'Panel Elctrico'
      ],
      'seccion': [
        'Panel Elctrico',
        'Controles',
        'Sistema Hidrulico',
        'Sistema Neumtico',
        'Zona de Corte',
        'Sistema de Refrigeracin',
        'Vlvulas Control'
      ]
      // Nota: 'detalle' no tiene opciones predefinidas porque es texto libre
    };
    
    // Cargar opciones desde localStorage (o inicializar con predefinidas)
    this.opcionesJerarquia = {};
    this.loadOpcionesPersonalizadas();
    
    this.jerarquiaNiveles = [
      { id: 'planta', nombre: 'Empresa', requerido: true, visible: true },
      { id: 'areaGeneral', nombre: 'rea General', requerido: true, visible: true },
      { id: 'subArea', nombre: 'Sub-rea', requerido: false, visible: false },
      { id: 'sistemaEquipo', nombre: 'Sistema/Equipo', requerido: false, visible: true },
      { id: 'subSistema', nombre: 'Sub-Sistema', requerido: false, visible: false },
      { id: 'seccion', nombre: 'Seccin', requerido: false, visible: false },
      { id: 'detalle', nombre: 'Detalle/Ubicacin', requerido: false, visible: false }
    ];
    
    this.isMobile = this.detectMobile();
    this.hasFileSystemAPI = this.checkFileSystemAPI();
    this.storageMode = this.hasFileSystemAPI ? 'filesystem' : 'indexeddb';
    
    // Referencia al FileSystemManager global
    this.fsManager = fsManager;
    console.log(` fsManager asignado:`, this.fsManager ? ' OK' : ' UNDEFINED');
    console.log(` fsManager.rootFolder:`, this.fsManager?.rootFolder ? ' OK' : ' NO CONECTADO');
    
    console.log(` Dispositivo: ${this.isMobile ? 'Mvil' : 'PC'}`);
    console.log(` Modo de almacenamiento: ${this.storageMode.toUpperCase()}`);
    console.log(` File System API: ${this.hasFileSystemAPI ? ' Disponible' : ' No disponible'}`);
  }
  
  // NUEVO: Detectar si es dispositivo mvil
  detectMobile() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isMobileUA = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    const isSmallScreen = window.innerWidth < 768;
    
    return isMobileUA || (isTouchDevice && isSmallScreen);
  }
  
  // NUEVO: Verificar disponibilidad de File System Access API
  checkFileSystemAPI() {
    return 'showDirectoryPicker' in window;
  }

  // Detectar si el navegador es Microsoft Edge
  detectEdge() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isEdgeChromium = userAgent.includes('edg/'); // Edge Chromium (PC y mvil)
    const isEdgeLegacy = userAgent.includes('edge/'); // Edge Legacy (ya no se usa)
    const isIOS = /iphone|ipad|ipod/.test(userAgent);
    
    //  ACEPTAR Edge iOS tambin (aunque use WebKit)
    // El usuario ya est usando Edge, no tiene sentido pedirle que lo descargue
    if (isEdgeChromium && isIOS) {
      console.log(' Edge en iOS detectado - Modo mvil con IndexedDB');
      this.isEdgeIOS = true; // Flag especial para Edge iOS
      return true; //  S es Edge (aunque limitado)
    }
    
    this.isEdgeIOS = false;
    return isEdgeChromium || isEdgeLegacy;
  }

  // Mostrar advertencia si no es Edge
  showBrowserWarning() {
    // PRIORIDAD 1: Mostrar banner de mvil simplificado si no hay FileSystem
    if (this.isMobile && !this.hasFileSystemAPI) {
      console.log(' Modo Mvil Simplificado detectado');
      this.showMobileSimplifiedBanner();
      return;
    }
    
    if (this.isEdge) {
      // Si es Edge iOS, mostrar mensaje informativo suave
      if (this.isEdgeIOS) {
        console.log(' Microsoft Edge iOS detectado - Modo mvil activo');
        this.showEdgeIOSInfo();
        return;
      }
      
      console.log(' Microsoft Edge detectado - Experiencia optimizada');
      return;
    }

    // Ya no mostramos banner de advertencia para otros navegadores
    console.log(' Navegador:', this.getBrowserName());
  }
  
  // Mostrar info amigable para Edge iOS (sin alarmar al usuario)
  showEdgeIOSInfo() {
    // Crear banner informativo SUAVE (azul, no rojo)
    const banner = document.createElement('div');
    banner.id = 'edge-ios-info-banner';
    banner.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 99999;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
        color: white;
        padding: 12px 16px;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        animation: slideDown 0.5s ease-out;
        font-size: 0.9rem;
      ">
        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
          <span style="font-size: 1.5rem;"></span>
          <div>
            <strong>Edge Mvil Detectado</strong>  
             Cmara +  Galera/iCloud disponibles
          </div>
        </div>
        <button onclick="document.getElementById('edge-ios-info-banner').style.display='none'" 
                style="
                  padding: 6px 12px;
                  background: rgba(255,255,255,0.2);
                  color: white;
                  border: 1px solid rgba(255,255,255,0.3);
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.85rem;
                  font-weight: 600;
                "
                onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                onmouseout="this.style.background='rgba(255,255,255,0.2)'">
           Entendido
        </button>
      </div>
      <style>
        @keyframes slideDown {
          from { transform: translateY(-100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        @media (max-width: 768px) {
          #edge-ios-info-banner > div {
            font-size: 0.85rem;
          }
        }
      </style>
    `;

    document.body.insertBefore(banner, document.body.firstChild);
    
    // Auto-cerrar despus de 5 segundos
    setTimeout(() => {
      const bannerEl = document.getElementById('edge-ios-info-banner');
      if (bannerEl) {
        bannerEl.style.transition = 'opacity 0.5s ease-out';
        bannerEl.style.opacity = '0';
        setTimeout(() => bannerEl.remove(), 500);
      }
    }, 5000);
  }

  // Mostrar banner de modo mvil simplificado (sin FileSystem)
  showMobileSimplifiedBanner() {
    const banner = document.createElement('div');
    banner.id = 'mobile-simplified-banner';
    banner.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 99999;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.95), rgba(124, 58, 237, 0.95));
        color: white;
        padding: 14px 16px;
        box-shadow: var(--shadow-lg);
        animation: slideDown 0.5s ease-out;
        font-size: 0.85rem;
      ">
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
              <span style="font-size: 1.8rem;"></span>
              <div>
                <strong style="font-size: 1rem; display: block; margin-bottom: 3px;">
                  Modo Mvil Simplificado
                </strong>
                <span style="opacity: 0.95; font-size: 0.8rem;">
                  Solo datos  Sin fotos
                </span>
              </div>
            </div>
            <button onclick="document.getElementById('mobile-simplified-banner').style.display='none'" 
                    style="
                      padding: 6px 12px;
                      background: rgba(255,255,255,0.2);
                      color: white;
                      border: 1px solid rgba(255,255,255,0.3);
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 0.8rem;
                      font-weight: 600;
                      white-space: nowrap;
                    ">
               Entendido
            </button>
          </div>
          
          <div style="
            background: rgba(255,255,255,0.15);
            padding: 10px 12px;
            border-radius: 6px;
            line-height: 1.5;
            font-size: 0.8rem;
          ">
            <strong style="display: block; margin-bottom: 6px;"> Funciones activas:</strong>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.75rem;">
              <span> Ver inventario</span>
              <span> Conteo rpido</span>
              <span> Agregar repuestos</span>
              <span> Buscar/Filtrar</span>
              <span> Editar datos</span>
              <span> Eliminar items</span>
            </div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.75rem;">
               <strong>Para fotos:</strong> Usa la versin de PC
            </div>
          </div>
        </div>
      </div>
      <style>
        @keyframes slideDown {
          from { transform: translateY(-100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
      </style>
    `;
    
    document.body.insertBefore(banner, document.body.firstChild);
    
    // Auto-cerrar despus de 8 segundos (ms tiempo para leer todo)
    setTimeout(() => {
      const bannerEl = document.getElementById('mobile-simplified-banner');
      if (bannerEl) {
        bannerEl.style.transition = 'opacity 0.5s ease-out';
        bannerEl.style.opacity = '0';
        setTimeout(() => bannerEl.remove(), 500);
      }
    }, 8000);
    
    console.log(' Banner de Modo Mvil Simplificado mostrado');
  }

  // Obtener nombre del navegador actual
  getBrowserName() {
    const userAgent = navigator.userAgent.toLowerCase();
    
    if (userAgent.includes('firefox')) return 'Mozilla Firefox';
    if (userAgent.includes('chrome') && !userAgent.includes('edg')) return 'Google Chrome';
    if (userAgent.includes('safari') && !userAgent.includes('chrome')) return 'Safari';
    if (userAgent.includes('opera') || userAgent.includes('opr')) return 'Opera';
    
    return 'Navegador Desconocido';
  }

  normalizeMultimediaItem(media, index = 0) {
    if (!media || typeof media !== 'object') {
      return media;
    }

    const normalized = { ...media };

    let rawType = normalized.type ?? normalized.tipo ?? '';
    if (typeof rawType === 'string') {
      rawType = rawType.trim().toLowerCase();
    } else {
      rawType = '';
    }

    const typeMap = {
      image: 'image',
      imagen: 'image',
      img: 'image',
      foto: 'image',
      picture: 'image',
      video: 'video',
      'vdeo': 'video',
      document: 'document',
      documento: 'document',
      doc: 'document',
      archivo: 'document'
    };

    if (typeMap[rawType]) {
      normalized.type = typeMap[rawType];
    } else if (rawType) {
      normalized.type = rawType;
    }

    if (!normalized.name) {
      normalized.name = normalized.filename || normalized.originalName || normalized.nombreArchivo || `archivo_${index + 1}`;
    }

    if (!normalized.url) {
      if (normalized.path) {
        normalized.url = normalized.path;
      } else if (normalized.ruta) {
        normalized.url = normalized.ruta;
      } else if (normalized.location) {
        normalized.url = normalized.location;
      } else if (normalized.filename) {
        normalized.url = `./imagenes/${normalized.filename}`;
      }
    }

    if (!normalized.size) {
      normalized.size = normalized.sizeBytes || normalized.tamano || normalized.originalSize || 0;
    }

    if (normalized.type === 'image' && normalized.isFileSystem === undefined && typeof normalized.url === 'string') {
      const maybeFs = normalized.url.startsWith('./') || normalized.url.startsWith('imagenes/') || normalized.url.startsWith('/imagenes/');
      if (maybeFs) {
        normalized.isFileSystem = true;
      }
    }

    return normalized;
  }

  // Helper para obtener URL de imagen (soporta base64 Y rutas externas)
  async getImageUrl(media) {
    if (!media) {
      console.warn(' getImageUrl: media es null/undefined');
      return null;
    }
    
    console.log(' getImageUrl llamado con:', media);
    
    // ===================================================================
    // MANEJO UNIVERSAL DE IMGENES (FileSystem, IndexedDB, base64)
    // ===================================================================
    
    // Si es un string simple
    if (typeof media === 'string') {
      console.log('    Es string:', media.substring(0, 50));
      // Base64 inline  Retornar directamente
      if (media.startsWith('data:image')) {
        console.log('    Es base64, retornando directo');
        return media;
      }
      // ID de IndexedDB (img_timestamp_filename)
      if (media.startsWith('img_') && this.storageMode === 'indexeddb') {
        console.log('    Cargando desde IndexedDB...');
        return await this.loadImageFromFileSystem(media);
      }
      // Ruta de FileSystem (./imagenes/...)
      if (media.startsWith('./imagenes/') || media.startsWith('imagenes/')) {
        console.log('    Cargando desde FileSystem...');
        return await this.loadImageFromFileSystem(media);
      }
      // Ruta relativa o absoluta
      console.log('    Retornando como ruta:', media);
      return media;
    }
    
    // Si es objeto con type === 'image'
    if (media.type === 'image' && media.url) {
      console.log('    Es objeto con type=image, url:', media.url?.substring(0, 50));
      console.log('    isFileSystem:', media.isFileSystem, 'isIndexedDB:', media.isIndexedDB);
      
      //  CORRECCIN: Verificar isFileSystem PRIMERO
      if (media.isFileSystem === true) {
        console.log('     Detectado isFileSystem=true, cargando desde FileSystem...');
        return await this.loadImageFromFileSystem(media.url);
      }
      
      if (media.isIndexedDB && media.url.startsWith('img_')) {
        console.log('    Cargando desde IndexedDB (objeto)...');
        return await this.loadImageFromFileSystem(media.url);
      }
      
      // Si la URL tiene formato de FileSystem pero no tiene flag
      if (media.url.startsWith('./imagenes/') || media.url.startsWith('imagenes/') || media.url.startsWith('/imagenes/')) {
        console.log('    URL con formato FileSystem, cargando...');
        return await this.loadImageFromFileSystem(media.url);
      }
      
      // Base64 u otro formato
      console.log('    Retornando media.url directo');
      return media.url;
    }
    
    // Si es objeto con estructura {tipo: 'imagen', url: '...'}
    if (media.tipo && media.url) {
      console.log('    Es objeto legacy con tipo:', media.tipo);
      const legacyType = typeof media.tipo === 'string' ? media.tipo.toLowerCase() : '';
      if (['imagen', 'image', 'img', 'foto'].includes(legacyType)) {
        if (media.esArchivoExterno) {
          console.log('    Es archivo externo, retornando url');
          return media.url;
        }
        console.log('    Retornando media.url');
        return media.url;
      }
    }
    
    console.warn('    No se pudo determinar cmo obtener la URL');
    return null;
  }

  async loadImageFromFileSystem(path) {
    // ===================================================================
    // CARGA UNIVERSAL DE IMGENES (FileSystem, IndexedDB o base64)
    // ===================================================================
    
    console.log(` [DEBUG] loadImageFromFileSystem llamado con:`, path);
    console.log(`   storageMode: ${this.storageMode}`);
    console.log(`   fsManager.isFileSystemMode: ${fsManager.isFileSystemMode}`);
    console.log(`   fsManager.imagesFolder:`, fsManager.imagesFolder ? 'EXISTE ' : 'NO EXISTE ');
    
    // CASO 1: Base64 inline (LocalStorage mode) - Retornar directamente
    if (path.startsWith('data:image')) {
      console.log(` [DEBUG] Base64 detectado, retornando directamente`);
      return path;
    }
    
    // CASO 2: IndexedDB ID (Mobile mode)
    if (path.startsWith('img_') && this.storageMode === 'indexeddb') {
      console.log(` [DEBUG] Intentando cargar desde IndexedDB...`);
      try {
        const imageData = await indexedDBManager.getImage(path);
        if (imageData && imageData.url) {
          console.log(` IndexedDB: ${path} cargada`);
          return imageData.url;
        }
      } catch (error) {
        console.error(` Error cargando desde IndexedDB: ${path}`, error);
        return null;
      }
    }
    
    // CASO 3: FileSystem path (PC mode con Edge)
    if (!fsManager.isFileSystemMode || !fsManager.imagesFolder) {
      // Detectar si estamos en servidor HTTP
      const isHTTPMode = window.location.protocol === 'http:' || window.location.protocol === 'https:';
      
      if (isHTTPMode) {
        // En modo HTTP, convertir a ruta del servidor
        let serverPath = path;
        if (path.startsWith('./imagenes/')) {
          serverPath = 'INVENTARIO_STORAGE/' + path.substring(2);
        } else if (path.startsWith('imagenes/')) {
          serverPath = 'INVENTARIO_STORAGE/' + path;
        } else if (!path.startsWith('INVENTARIO_STORAGE/')) {
          serverPath = 'INVENTARIO_STORAGE/imagenes/' + path;
        }
        // Codificar espacios
        serverPath = serverPath.replace(/ /g, '%20');
        console.log(' [HTTP Mode] Usando ruta servidor:', serverPath);
        return serverPath;
      } else {
        // Modo archivo local
        const sanitized = (() => {
          if (path.startsWith('./')) return path;
          if (path.startsWith('/')) return `.${path}`;
          if (path.startsWith('imagenes/')) return `./${path}`;
          return path;
        })();
        console.warn(' [DEBUG] FileSystem no activo, usando ruta directa:', sanitized);
        return sanitized;
      }
    }

    try {
      // SIMPLIFICADO: Todas las imgenes estn en carpeta raz INVENTARIO_STORAGE/imagenes/
      // Extraer solo el nombre del archivo (sin subcarpetas)
      let filename = path.replace('./', '').replace(/^imagenes\//, '');
      
      // Si tiene subcarpetas en el path (modo legacy), extraer solo el nombre final
      if (filename.includes('/')) {
        const parts = filename.split('/');
        filename = parts[parts.length - 1];
      }
      
      console.log(` Cargando imagen desde FileSystem (carpeta plana): ${filename}`);
      
      // Usar cach global con referencias fuertes (previene Garbage Collection)
      return await getCachedBlobUrl(filename, async () => {
        // Cargar directamente desde carpeta raz imagenes/
        const fileHandle = await fsManager.imagesFolder.getFileHandle(filename);
        const file = await fileHandle.getFile();
        
        // Crear Blob URL permanente
        const blobUrl = URL.createObjectURL(file);
        
        console.log(` Imagen cargada: ${filename} (${file.size} bytes)`);
        return blobUrl;
      });
    } catch (error) {
      // Error silencioso - retornar placeholder automticamente
      console.debug(` Imagen no encontrada: ${path.split('/').pop()}`);
      return null;
    }
  }

  // Obtener primera imagen de multimedia array
  // Imagen placeholder SVG para repuestos sin foto
  getPlaceholderImage() {
    // Placeholder simple en PNG base64 (200x150 gris con texto)
    return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAACWCAYAAACb3McZAAAACXBIWXMAAAsTAAALEwEAmpwYAAADGklEQVR4nO3dy0pDQRRF0ZOI///L4sPIQNAY86h0n7X2gDvJoKu7TqeqngEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgP/q9cV7AK7w+uXlbYwxvr5/f/sewKV+hOPx+Ph8fHwc3wW40I9wjDHG4/Fx8R7Ahb6F4/n5+eE9gAt9C8cY4+49gAt9D8er9wAu9CMcz+N1eA/gQj/CMcZr8x7AhSYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgFv6AyRmU3vlastLAAAAAElFTkSuQmCC';
  }

  async getFirstImage(multimedia) {
    if (!multimedia || !Array.isArray(multimedia) || multimedia.length === 0) {
      return this.getPlaceholderImage();
    }
    
    for (const media of multimedia) {
      const url = await this.getImageUrl(media);
      if (url) return url;
    }
    
    return this.getPlaceholderImage();
  }

  loadCustomSistemas() {
    try {
      const stored = localStorage.getItem('inventarioCustomSistemas');
      return stored ? JSON.parse(stored) : {};
    } catch (error) {
      console.error(' Error cargando sistemas personalizados:', error);
      return {};
    }
  }
  
  saveCustomSistemas() {
    try {
      localStorage.setItem('inventarioCustomSistemas', JSON.stringify(this.customSistemas));
      console.log(' Sistemas personalizados guardados:', this.customSistemas);
    } catch (error) {
      console.error(' Error guardando sistemas personalizados:', error);
      this.showAlert('Error al guardar sistemas personalizados', 'error');
    }
  }
  
  addCustomSistema(equipo, sistema) {
    if (!equipo || !sistema || sistema.trim() === '') return;
    
    if (!this.customSistemas[equipo]) {
      this.customSistemas[equipo] = [];
    }
    
    const sistemaTrimmed = sistema.trim();
    const predefinidos = this.sistemaPorEquipo[equipo] || this.sistemaPorEquipo['default'];
    
    if (predefinidos.includes(sistemaTrimmed) || this.customSistemas[equipo].includes(sistemaTrimmed)) {
      return false;
    }
    
    this.customSistemas[equipo].push(sistemaTrimmed);
    this.saveCustomSistemas();
    console.log(` Sistema personalizado agregado: ${sistemaTrimmed} (${equipo})`);
    return true;
  }
  
  deleteCustomSistema(equipo, sistema) {
    if (!this.customSistemas[equipo]) return false;
    
    const index = this.customSistemas[equipo].indexOf(sistema);
    if (index > -1) {
      this.customSistemas[equipo].splice(index, 1);
      
      if (this.customSistemas[equipo].length === 0) {
        delete this.customSistemas[equipo];
      }
      
      this.saveCustomSistemas();
      console.log(` Sistema personalizado eliminado: ${sistema} (${equipo})`);
      return true;
    }
    return false;
  }
  
  editCustomSistema(equipo, oldSistema, newSistema) {
    if (!this.customSistemas[equipo] || !newSistema || newSistema.trim() === '') return false;
    
    const index = this.customSistemas[equipo].indexOf(oldSistema);
    if (index > -1) {
      const newSistemaTrimmed = newSistema.trim();
      
      const predefinidos = this.sistemaPorEquipo[equipo] || this.sistemaPorEquipo['default'];
      if (predefinidos.includes(newSistemaTrimmed) || this.customSistemas[equipo].includes(newSistemaTrimmed)) {
        this.showAlert('Este sistema ya existe', 'warning');
        return false;
      }
      
      this.customSistemas[equipo][index] = newSistemaTrimmed;
      this.saveCustomSistemas();
      console.log(` Sistema personalizado editado: ${oldSistema}  ${newSistemaTrimmed} (${equipo})`);
      return true;
    }
    return false;
  }
  
  // ============================================
  // GESTIN DE OPCIONES PERSONALIZADAS DE JERARQUA
  // ============================================
  
  loadOpcionesPersonalizadas() {
    try {
      const stored = localStorage.getItem('inventarioOpcionesJerarquia');
      if (stored) {
        // Si existe en localStorage, usar ESO (respeta eliminaciones)
        this.opcionesJerarquia = JSON.parse(stored);
        console.log(' Opciones cargadas desde localStorage');
      } else {
        // Primera vez: usar valores predefinidos y guardarlos
        this.opcionesJerarquia = JSON.parse(JSON.stringify(this.opcionesJerarquiaPredefinidas));
        this.saveOpcionesPersonalizadas({
          reason: 'bootstrap-opciones',
          meta: { origen: 'loadOpcionesPersonalizadas' }
        });
        console.log(' Opciones inicializadas con valores predefinidos');
      }
    } catch (error) {
      console.error(' Error cargando opciones personalizadas:', error);
      // En caso de error, usar predefinidas
      this.opcionesJerarquia = JSON.parse(JSON.stringify(this.opcionesJerarquiaPredefinidas));
    }
  }
  
  saveOpcionesPersonalizadas(context = {}) {
    try {
      // Guardar todas las opciones actuales
      const toSave = {};
      Object.keys(this.opcionesJerarquia).forEach(nivel => {
        toSave[nivel] = [...this.opcionesJerarquia[nivel]];
      });
      localStorage.setItem('inventarioOpcionesJerarquia', JSON.stringify(toSave));
      console.log(' Opciones personalizadas guardadas');

      const detail = {
        scope: 'opcionesJerarquia',
        ...context,
        catalogs: this.opcionesJerarquia
      };

      if (!detail.reason) {
        detail.reason = 'save';
      }

      this.emitAppEvent('jerarquia:catalogs-updated', detail);
    } catch (error) {
      console.error(' Error guardando opciones personalizadas:', error);
    }
  }
  
  //  NUEVA FUNCIN: Cargar/Inicializar Jerarqua Anidada
  loadJerarquiaAnidada() {
    try {
      const stored = localStorage.getItem('inventarioJerarquiaAnidada');
      const legacy = !stored ? localStorage.getItem('jerarquiaAnidada') : null;
      if (stored || legacy) {
        const raw = stored || legacy;
        this.jerarquiaAnidada = JSON.parse(raw);
        
        //  MIGRACIN: Si tiene "plantas", renombrar a "areas"
        if (this.jerarquiaAnidada.plantas && !this.jerarquiaAnidada.areas) {
          console.log(' Migrando "plantas"  "areas"');
          this.jerarquiaAnidada.areas = this.jerarquiaAnidada.plantas;
          delete this.jerarquiaAnidada.plantas;
          this.saveJerarquiaAnidada({
            reason: 'migracion-plantas',
            meta: { origen: 'legacy-planta' }
          });
        }
        
        //  Alinear claves usadas por la demo Visual 2.0
        if (!stored) {
          console.log(' Sincronizando jerarquiaAnidada legado hacia inventarioJerarquiaAnidada');
          this.saveJerarquiaAnidada({
            reason: 'sincronizacion-legado',
            meta: { origen: 'legacy-sync' }
          });
        }

        console.log(' Jerarqua anidada cargada desde localStorage');
      } else {
        // Primera vez: crear estructura base
        this.jerarquiaAnidada = this.crearEstructuraJerarquicaBase();
        this.saveJerarquiaAnidada({
          reason: 'crear-estructura-base',
          meta: { origen: 'init' }
        });
        console.log(' Jerarqua anidada inicializada con estructura base');
      }
    } catch (error) {
      console.error(' Error cargando jerarqua anidada:', error);
      this.jerarquiaAnidada = this.crearEstructuraJerarquicaBase();
    }
  }
  
  //  NUEVA FUNCIN: Crear estructura base
  crearEstructuraJerarquicaBase() {
    return {
      empresa: {
        nombre: 'Aquachile Antarfood Chonchi',
        id: 'empresa_principal'
      },
      areas: [
        {
          id: 'area_planta_principal',
          nombre: 'Planta Principal',
          subAreas: [
            {
              id: 'eviscerado',
              nombre: 'Eviscerado',
              sistemas: [
                {
                  id: 'grader',
                  nombre: 'Grader',
                  subSistemas: [
                    {
                      id: 'cinta_larga_grader',
                      nombre: 'Cinta Larga Grader',
                      secciones: [
                        {
                          id: 'sistema_electrico',
                          nombre: 'Sistema Elctrico',
                          subSecciones: [
                            {
                              id: 'panel_control',
                              nombre: 'Panel de Control'
                            },
                            {
                              id: 'cableado',
                              nombre: 'Cableado'
                            }
                          ]
                        },
                        {
                          id: 'sistema_mecanico',
                          nombre: 'Sistema Mecnico',
                          subSecciones: [
                            {
                              id: 'rodamientos',
                              nombre: 'Rodamientos'
                            },
                            {
                              id: 'correa',
                              nombre: 'Correa'
                            }
                          ]
                        }
                      ]
                    },
                    {
                      id: 'motor_principal',
                      nombre: 'Motor Principal',
                      secciones: [
                        {
                          id: 'alimentacion_electrica',
                          nombre: 'Alimentacin Elctrica',
                          subSecciones: []
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              id: 'filete',
              nombre: 'Filete',
              sistemas: []
            }
          ]
        },
        {
          id: 'acopio',
          nombre: 'Acopio',
          subAreas: []
        }
      ]
    };
  }

  emitAppEvent(eventName, detail = {}) {
    if (!eventName || !window.appEvents || typeof window.appEvents.emit !== 'function') {
      return;
    }

    const payload = {
      source: 'inventario',
      ...detail
    };

    if (!('timestamp' in payload)) {
      payload.timestamp = Date.now();
    }

    try {
      window.appEvents.emit(eventName, payload);
    } catch (error) {
      console.error(' Error emitiendo evento global', eventName, error);
    }
  }
  
  //  NUEVA FUNCIN: Guardar jerarqua anidada
  saveJerarquiaAnidada(context = {}) {
    try {
      localStorage.setItem('inventarioJerarquiaAnidada', JSON.stringify(this.jerarquiaAnidada));
      localStorage.setItem('jerarquiaAnidada', JSON.stringify(this.jerarquiaAnidada));
      console.log(' Jerarqua anidada guardada');

      const detail = {
        scope: 'jerarquiaAnidada',
        ...context,
        jerarquia: this.jerarquiaAnidada
      };

      if (!detail.reason) {
        detail.reason = 'save';
      }

      this.emitAppEvent('jerarquia:structure-updated', detail);
    } catch (error) {
      console.error(' Error guardando jerarqua anidada:', error);
    }
  }

  getJerarquiaLevelConfig() {
    if (!this._jerarquiaLevelConfig) {
      this._jerarquiaLevelConfig = [
        { id: 'planta', storageKey: 'nivel1', label: 'Empresa / Planta' },
        { id: 'areaGeneral', storageKey: 'nivel2', label: 'rea general' },
        { id: 'subArea', storageKey: 'nivel3', label: 'Sub-rea' },
        { id: 'sistemaEquipo', storageKey: 'nivel4', label: 'Sistema / Equipo' },
        { id: 'subSistema', storageKey: 'nivel5', label: 'Sub-sistema' },
        { id: 'seccion', storageKey: 'nivel6', label: 'Seccin' },
        { id: 'subSeccion', storageKey: 'nivel7', label: 'Sub-seccin' },
        { id: 'detalle', storageKey: 'nivel8', label: 'Detalle / Ubicacin' }
      ];
    }
    return this._jerarquiaLevelConfig;
  }

  getJerarquiaLevelMap() {
    if (!this._jerarquiaLevelMap) {
      this._jerarquiaLevelMap = this.getJerarquiaLevelConfig().reduce((map, level) => {
        map[level.id] = level;
        map[level.storageKey] = level;
        return map;
      }, {});
    }
    return this._jerarquiaLevelMap;
  }

  rebuildJerarquiaNodeIndex() {
    const config = this.getJerarquiaLevelConfig();
    this._jerarquiaNodeIndex = {};

    config.forEach(level => {
      if (!Array.isArray(this.jerarquiaData[level.storageKey])) {
        this.jerarquiaData[level.storageKey] = [];
      }

      const levelIndex = {};
      this.jerarquiaData[level.storageKey].forEach(item => {
        if (item && item.name) {
          levelIndex[item.name.trim().toLowerCase()] = item;
        }
      });

      this._jerarquiaNodeIndex[level.id] = levelIndex;
    });
  }

  ensureJerarquiaNodeIndex() {
    if (!this._jerarquiaNodeIndex) {
      this.rebuildJerarquiaNodeIndex();
    }
  }

  normalizeJerarquiaInput(jerarquia = {}) {
    const normalized = {};
    const alias = {
      area: 'areaGeneral',
      equipo: 'sistemaEquipo',
      sistema: 'subSistema',
      ubicacion: 'detalle',
      areaDetallada: 'detalle',
      detalleUbicacion: 'detalle'
    };

    Object.entries(jerarquia || {}).forEach(([key, value]) => {
      if (!value || typeof value !== 'string') return;
      const targetKey = alias[key] || key;
      if (this.getJerarquiaLevelMap()[targetKey]) {
        normalized[targetKey] = value.trim();
      }
    });

    if (!normalized.planta && typeof this.plantaBase === 'string' && this.plantaBase.trim()) {
      normalized.planta = this.plantaBase.trim();
    }

    return normalized;
  }

  ensureJerarquiaNode(levelId, value, options = {}) {
    const config = this.getJerarquiaLevelMap()[levelId];
    if (!config) {
      return { node: null, created: false };
    }

    const normalizedValue = (value || '').trim();
    if (!normalizedValue) {
      return { node: null, created: false };
    }

    this.ensureJerarquiaNodeIndex();

    if (!Array.isArray(this.jerarquiaData[config.storageKey])) {
      this.jerarquiaData[config.storageKey] = [];
    }
    if (!this._jerarquiaNodeIndex[levelId]) {
      this._jerarquiaNodeIndex[levelId] = {};
    }

    const lookupKey = normalizedValue.toLowerCase();
    let node = this._jerarquiaNodeIndex[levelId][lookupKey];
    let created = false;

    if (!node) {
      node = {
        id: `${config.storageKey}-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`,
        name: normalizedValue,
        description: options.description || '',
        parentId: options.parentId || null,
        timestamp: Date.now(),
        lastUsage: Date.now()
      };
      this.jerarquiaData[config.storageKey].push(node);
      this._jerarquiaNodeIndex[levelId][lookupKey] = node;
      created = true;
    } else {
      node.lastUsage = Date.now();
      if (options.parentId && !node.parentId) {
        node.parentId = options.parentId;
      }
    }

    const skipAprendizaje = levelId === 'detalle';
    if (!skipAprendizaje && typeof this.aprenderNuevaOpcion === 'function') {
      this.aprenderNuevaOpcion(levelId, normalizedValue);
    }

    return { node, created };
  }

  registerJerarquiaPath(jerarquiaInput = {}, context = {}) {
    const normalized = this.normalizeJerarquiaInput(jerarquiaInput);
    const path = [];
    let parentId = context.parentId || null;
    let levelsUpdated = false;

    this.getJerarquiaLevelConfig().forEach(level => {
      const value = normalized[level.id];
      if (!value) return;

      const { node, created } = this.ensureJerarquiaNode(level.id, value, {
        parentId,
        description: context.description,
        source: context.source
      });

      if (node) {
        parentId = node.id;
        path.push({
          id: node.id,
          name: node.name,
          level: level.id,
          storageKey: level.storageKey
        });
        if (created) {
          levelsUpdated = true;
        }
      }
    });

    if (levelsUpdated) {
      localStorage.setItem('jerarquiaLevels', JSON.stringify(this.jerarquiaData));
      if (typeof this.sincronizarJerarquiaConAutocompletado === 'function') {
        this.sincronizarJerarquiaConAutocompletado();
      }
      this.cachedJerarquiaOptions = null;
    }

    if (!this.jerarquiaPathRegistry) {
      this.jerarquiaPathRegistry = [];
    }

    if (path.length) {
      this.jerarquiaPathRegistry.push({
        path: path.map(segment => segment.name),
        source: context.source || 'unknown',
        entityId: context.entityId || null,
        meta: context.meta || null,
        timestamp: Date.now()
      });
    }

    return path;
  }
  
  aprenderNuevaOpcion(nivel, valor) {
    if (!nivel || !valor || valor.trim() === '') return false;
    if (!this.opcionesJerarquia[nivel]) return false;
    
    const valorTrimmed = valor.trim();
    
    // Si ya existe, no hacer nada
    if (this.opcionesJerarquia[nivel].includes(valorTrimmed)) {
      return false;
    }
    
    // Agregar nueva opcin
    this.opcionesJerarquia[nivel].push(valorTrimmed);
    this.saveOpcionesPersonalizadas({
      reason: 'aprender-opcion',
      meta: {
        nivel,
        valor: valorTrimmed
      }
    });
    console.log(` Nueva opcin aprendida: ${valorTrimmed} en ${nivel}`);
    
    //  SINCRONIZACIN: Si la pestaa de configuracin est visible, actualizar UI en tiempo real
    if (this.currentTab === 'configuracion') {
      this.renderListasGestion();
      console.log(` UI de configuracin actualizada automticamente`);
    }
    
    return true;
  }
  
  eliminarOpcionJerarquia(nivel, valor) {
    if (!this.opcionesJerarquia[nivel]) return false;
    
    const index = this.opcionesJerarquia[nivel].indexOf(valor);
    if (index > -1) {
      this.opcionesJerarquia[nivel].splice(index, 1);
      this.saveOpcionesPersonalizadas({
        reason: 'eliminar-opcion',
        meta: {
          nivel,
          valor
        }
      });
      
      // Limpiar esta opcin de todos los repuestos que la usen
      this.limpiarOpcionDeRepuestos(nivel, valor);
      
      console.log(` Opcin eliminada: ${valor} de ${nivel}`);
      return true;
    }
    return false;
  }
  
  limpiarOpcionDeRepuestos(nivel, valor) {
    let modificados = 0;
    
    this.repuestos.forEach(repuesto => {
      if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones)) {
        repuesto.ubicaciones.forEach(ubicacion => {
          if (ubicacion[nivel] === valor) {
            ubicacion[nivel] = '';
            modificados++;
          }
        });
      }
    });
    
    if (modificados > 0) {
      this.guardarDatos();
      console.log(` Limpiado "${valor}" de ${modificados} ubicacin(es)`);
      this.showAlert(`Se elimin "${valor}" de ${modificados} ubicacin(es)`, 'success');
    }
  }
  
  agregarOpcionJerarquia(nivel, valor) {
    if (!nivel || !valor || valor.trim() === '') {
      this.showToast(' Debes ingresar un valor', 'warning');
      return false;
    }
    
    // Inicializar array si no existe
    if (!this.opcionesJerarquia[nivel]) {
      this.opcionesJerarquia[nivel] = [];
    }
    
    const valorTrimmed = valor.trim();
    
    if (this.opcionesJerarquia[nivel].includes(valorTrimmed)) {
      this.showToast(' Esta opcin ya existe', 'warning');
      return false;
    }
    
    this.opcionesJerarquia[nivel].push(valorTrimmed);
    this.opcionesJerarquia[nivel].sort();
    this.saveOpcionesPersonalizadas({
      reason: 'agregar-opcion',
      meta: {
        nivel,
        valor: valorTrimmed
      }
    });
    console.log(` Opcin agregada: ${valorTrimmed} a ${nivel}`);
    this.showToast(` "${valorTrimmed}" agregado correctamente`, 'success');
    return true;
  }


  toggleNivelesConfig() {
    const panel = document.getElementById('nivelesConfigPanel');
    if (panel.style.display === 'none') {
      panel.style.display = 'block';
      this.renderNivelesConfig();
    } else {
      panel.style.display = 'none';
    }
  }

  renderNivelesConfig() {
    const container = document.getElementById('nivelesCheckboxes');
    if (!container) return;
    
    let html = '';
    this.jerarquiaNiveles.forEach((nivel, index) => {
      if (nivel.id === 'planta' || nivel.id === 'areaGeneral') return;
      
      html += `
        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-primary); border-radius: 6px; cursor: pointer; border: 2px solid ${nivel.visible ? 'var(--success)' : 'var(--border-color)'};">
          <input type="checkbox" 
                 ${nivel.visible ? 'checked' : ''}
                 onchange="app.toggleNivelVisibilidad('${nivel.id}', this.checked)"
                 style="cursor: pointer;">
          <span style="font-weight: 600; font-size: 0.85rem;">${index + 1}. ${nivel.nombre}</span>
        </label>
      `;
    });
    
    container.innerHTML = html;
  }

  toggleNivelVisibilidad(nivelId, visible) {
    const nivel = this.jerarquiaNiveles.find(n => n.id === nivelId);
    if (nivel) {
      nivel.visible = visible;
      this.renderNivelesDinamicos();
      this.updateJerarquiaPreview();
    }
  }

  renderNivelesDinamicos() {
    const container = document.getElementById('nivelesDinamicosContainer');
    if (!container) return;
    
    let html = '';
    let numeroNivel = 3;
    
    this.jerarquiaNiveles.forEach(nivel => {
      if (nivel.id === 'planta' || nivel.id === 'areaGeneral') return;
      
      html += `
        <div class="form-group" style="opacity: ${nivel.visible ? '1' : '0.5'};">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" 
                   ${nivel.visible ? 'checked' : ''}
                   onchange="app.toggleNivelVisibilidad('${nivel.id}', this.checked)"
                   style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-weight: 700; color: var(--primary); min-width: 20px;">${numeroNivel}.</span>
            <span style="flex: 1;">${nivel.nombre}:</span>
            ${nivel.requerido ? '<span style="background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700;">OBLIGATORIO</span>' : '<span style="background: var(--text-secondary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem;">Opcional</span>'}
          </label>
          <input type="text" 
                 class="form-control nivel-input" 
                 id="nivel_${nivel.id}" 
                 data-nivel="${nivel.id}"
                 ${nivel.requerido ? 'required' : ''}
                 ${nivel.visible ? '' : 'disabled'}
                 placeholder="Ej: ${this.getPlaceholderParaNivel(nivel.id)}"
                 onchange="app.updateJerarquiaPreview()"
                 style="margin-left: 26px;">
        </div>
      `;
      
      numeroNivel++;
    });
    
    container.innerHTML = html;
  }

  getPlaceholderParaNivel(nivelId) {
    const placeholders = {
      'subArea': 'Zona Norte, Piso 1, Sector A',
      'sistemaEquipo': 'Grader, Compresor 01, Bomba Principal',
      'subSistema': 'Pocket 1, Motor Principal, Cinta Z',
      'seccion': 'Sistema Hidrulico, Panel Elctrico, Controles',
      'detalle': 'Lado Izquierdo, Bastidor Superior, Vlvula V3'
    };
    return placeholders[nivelId] || 'Ingrese valor';
  }

  updateJerarquiaPreview() {
    const previewText = document.getElementById('jerarquiaPreviewText');
    if (!previewText) return;
    
    const partes = [];
    
    partes.push(this.plantaBase);
    
    this.jerarquiaNiveles.forEach(nivel => {
      if (nivel.id === 'planta') return;
      
      const input = document.getElementById(`nivel_${nivel.id}`);
      if (input && input.value.trim() !== '') {
        partes.push(input.value.trim());
      }
    });
    
    if (partes.length > 0) {
      previewText.innerHTML = partes.map(parte => 
        `<span style="font-weight: 600;">${parte}</span>`
      ).join(' <span style="color: var(--success); font-weight: bold;"></span> ');
    } else {
      previewText.innerHTML = '<span style="color: var(--text-secondary); font-style: italic;">Complete los campos para ver la ruta</span>';
    }
  }

  generarUbicacionResumida(repuesto) {
    // Si tiene mltiples ubicaciones
    if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones) && repuesto.ubicaciones.length > 0) {
      return repuesto.ubicaciones.map(ub => {
        const partes = [];
        if (ub.areaGeneral) partes.push(ub.areaGeneral);
        if (ub.sistemaEquipo) partes.push(ub.sistemaEquipo);
        if (ub.subSistema) partes.push(ub.subSistema);
        return partes.length > 0 ? partes.join('  ') : 'Sin detalles';
      }).join(' <span style="color: var(--warning);">|</span> ');
    }
    
    // Compatibilidad con formato antiguo
    const partes = [];
    const areaGeneral = repuesto.areaGeneral || repuesto.area || '';
    if (areaGeneral) partes.push(areaGeneral);
    
    const sistemaEquipo = repuesto.sistemaEquipo || repuesto.equipo || '';
    if (sistemaEquipo) partes.push(sistemaEquipo);
    
    const subSistema = repuesto.subSistema || repuesto.sistema || '';
    if (subSistema) partes.push(subSistema);
    
    if (partes.length === 0) return '<em style="color: var(--text-secondary);">Sin ubicacin</em>';
    
    return partes.join('  ');
  }

  // ===== GESTIN DE MLTIPLES UBICACIONES =====
  
  ubicacionesActuales = [];
  
  agregarUbicacion() {
    const nuevaUbicacion = {
      id: Date.now(),
      areaGeneral: '',
      subArea: '',
      sistemaEquipo: '',
      subSistema: '',
      seccion: '',
      detalle: ''
    };
    
    this.ubicacionesActuales.push(nuevaUbicacion);
    
    //  SWITCH: Usar versin con cascada o versin original
    if (this.usarVersionCascada) {
      this.renderUbicacionesCascada();
    } else {
      this.renderUbicaciones();
    }
  }
  
  eliminarUbicacion(id) {
    this.ubicacionesActuales = this.ubicacionesActuales.filter(ub => ub.id !== id);
    
    //  SWITCH: Usar versin con cascada o versin original
    if (this.usarVersionCascada) {
      this.renderUbicacionesCascada();
    } else {
      this.renderUbicaciones();
    }
  }
  
  /**
   * VERSIN NUEVA CON CASCADA - Usa jerarquiaAnidada con selects en cascada
   * Esta versin reemplazar a renderUbicaciones() despus de ser probada
   */
  // ====================================================================
  // SELECTOR VISUAL DE JERARQUÍA PARA UBICACIONES
  // ====================================================================
  
  renderUbicacionesTreeSelector() {
    console.log('🌳 [UBICACIONES] Renderizando selector visual de jerarquía');
    
    const container = document.getElementById('ubicacionesTreeContainer');
    if (!container) {
      console.error('❌ No se encontró ubicacionesTreeContainer');
      return;
    }

    // Si no hay jerarquía anidada, construirla
    if (!this.jerarquiaAnidada) {
      this.buildJerarquiaAnidada();
    }

    if (!this.jerarquiaAnidada || !this.jerarquiaAnidada.areas) {
      container.innerHTML = '<p style="color: var(--danger); padding: 20px;">Error: No hay jerarquía disponible. Ve a Configuración y guarda los cambios.</p>';
      return;
    }

    const html = this.buildUbicacionesTreeHTML();
    container.innerHTML = html;
    
    // 🎯 Event delegation: Capturar clicks en nodos de ubicación
    const clickableNodes = container.querySelectorAll('[data-clickable="ubicacion"]');
    clickableNodes.forEach(node => {
      node.addEventListener('click', (event) => {
        const pathString = node.getAttribute('data-node-path');
        if (pathString) {
          try {
            const nodePath = JSON.parse(pathString);
            this.toggleUbicacionSelection(event, nodePath);
          } catch (error) {
            console.error('❌ Error parseando data-node-path:', pathString, error);
          }
        }
      });
    });
    
    // 🎯 Event delegation: Capturar clicks en toggles (▶/▼)
    const toggleButtons = container.querySelectorAll('.jerarquia-node-toggle');
    toggleButtons.forEach(toggle => {
      toggle.addEventListener('click', (event) => {
        event.stopPropagation(); // Evitar que dispare click del nodo
        this.toggleUbicacionNode(event, toggle);
      });
    });
    
    // 🌿 Expandir solo la rama de la ubicación asignada (si existe)
    this.expandOnlyAssignedPath();

    // Mostrar panel de asignación
    this.mostrarPanelAsignacion();

    console.log('✅ [UBICACIONES] Selector visual renderizado');
  }
  
  expandOnlyAssignedPath() {
    const container = document.getElementById('ubicacionesTreeContainer');
    if (!container) return;
    
    // Si no hay ubicación asignada, colapsar todo
    if (!this.ubicacionesActuales || this.ubicacionesActuales.length === 0) {
      console.log('👁️ [EXPAND] No hay ubicación asignada - colapsando todo');
      this.collapseAllNodes(container);
      return;
    }
    
    const ubicacion = this.ubicacionesActuales[0];
    console.log('🌿 [EXPAND] Expandiendo solo path:', ubicacion);
    
    // 1. Colapsar TODOS los nodos primero
    this.collapseAllNodes(container);
    
    // 2. Construir el path que necesitamos expandir
    const pathToExpand = [];
    if (ubicacion.areaGeneral) pathToExpand.push(ubicacion.areaGeneral);
    if (ubicacion.subArea) pathToExpand.push(ubicacion.subArea);
    if (ubicacion.sistemaEquipo) pathToExpand.push(ubicacion.sistemaEquipo);
    if (ubicacion.subSistema) pathToExpand.push(ubicacion.subSistema);
    if (ubicacion.seccion) pathToExpand.push(ubicacion.seccion);
    if (ubicacion.subSeccion) pathToExpand.push(ubicacion.subSeccion);
    
    console.log('📍 Path a expandir:', pathToExpand);
    
    // 3. Expandir solo los nodos en el path
    const allNodes = container.querySelectorAll('.jerarquia-tree-node');
    allNodes.forEach(node => {
      const content = node.querySelector('.jerarquia-node-content');
      const nodeName = content?.querySelector('.jerarquia-node-name')?.textContent?.trim();
      
      if (nodeName && pathToExpand.includes(nodeName)) {
        const children = node.querySelector('.jerarquia-node-children');
        const toggle = content?.querySelector('.jerarquia-node-toggle');
        
        if (children && toggle) {
          children.style.display = 'block';
          toggle.textContent = '▼';
          console.log(`  ✅ Expandido: ${nodeName}`);
        }
        
        // Si es el último nodo del path, resaltarlo
        const lastInPath = pathToExpand[pathToExpand.length - 1];
        if (nodeName === lastInPath) {
          content?.classList.add('is-assigned', 'is-selected');
          console.log(`  🎯 Resaltado nodo final: ${nodeName}`);
        }
      }
    });
  }
  
  collapseAllNodes(container) {
    const allChildren = container.querySelectorAll('.jerarquia-node-children');
    const allToggles = container.querySelectorAll('.jerarquia-node-toggle');
    
    allChildren.forEach(child => {
      child.style.display = 'none';
    });
    
    allToggles.forEach(toggle => {
      if (toggle.textContent.trim() === '▼') {
        toggle.textContent = '▶';
      }
    });
    
    console.log('  📦 Todos los nodos colapsados');
  }

  buildUbicacionesTreeHTML() {
    const { empresa, areas } = this.jerarquiaAnidada;
    
    let html = '<div class="ubicaciones-tree-root">';
    
    // Empresa (raíz) - con toggle y children
    const hasChildren = areas && areas.length > 0;
    html += `
      <div class="jerarquia-tree-node">
        <div class="jerarquia-node-content" data-node-type="empresa" data-node-id="${empresa.id || 'EMP-01'}">
          ${hasChildren ? '<span class="jerarquia-node-toggle">▼</span>' : '<span class="jerarquia-node-toggle"></span>'}
          <span class="jerarquia-node-icon">🏢</span>
          <span class="jerarquia-node-name">${this.escapeHtml(empresa.nombre)}</span>
        </div>
    `;

    // Áreas (niveles anidados)
    if (hasChildren) {
      html += '<div class="jerarquia-node-children" style="display: block;">'; // 👁️ Empresa expandida por defecto
      areas.forEach((area, areaIdx) => {
        html += this.buildUbicacionNodeHTML(area, ['areaGeneral'], [areaIdx]);
      });
      html += '</div>';
    }

    html += '</div>'; // Cerrar jerarquia-tree-node
    html += '</div>'; // Cerrar ubicaciones-tree-root
    return html;
  }

  buildUbicacionNodeHTML(node, pathKeys, indices = []) {
    const nodeId = node.id || `node-${Date.now()}-${Math.random()}`;
    const hasChildren = (node.subAreas && node.subAreas.length > 0) ||
                       (node.sistemas && node.sistemas.length > 0) ||
                       (node.subSistemas && node.subSistemas.length > 0) ||
                       (node.secciones && node.secciones.length > 0) ||
                       (node.subSecciones && node.subSecciones.length > 0);
    
    // Contar repuestos en este nodo
    const repuestosCount = this.contarRepuestosEnNodo(pathKeys, node.nombre);
    
    // Verificar si está seleccionado
    const pathString = JSON.stringify([...pathKeys, node.nombre]);
    const isSelected = this.isUbicacionSelected(pathKeys, node.nombre);

    // Determinar tipo de nodo y siguiente nivel hijo
    const { tipo, childType, childLabel } = this.getNodoTypeInfo(pathKeys);
    const indicesStr = indices.join(', ');

    // Usar data-path en lugar de onclick inline para evitar problemas de escape
    
    let html = `
      <div class="jerarquia-tree-node">
        <div class="jerarquia-node-content ${isSelected ? 'is-selected' : ''}" 
             data-node-id="${nodeId}"
             data-node-path='${pathString}'
             data-clickable="ubicacion">
          ${hasChildren ? '<span class="jerarquia-node-toggle">▶</span>' : '<span class="jerarquia-node-toggle"></span>'}
          <span class="jerarquia-node-icon">📦</span>
          <span class="jerarquia-node-name">${this.escapeHtml(node.nombre)}</span>
          ${repuestosCount > 0 ? `<span class="jerarquia-node-count">${repuestosCount} repuestos</span>` : ''}
          <div class="jerarquia-node-actions" onclick="event.stopPropagation();">
            ${childType ? `<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquiaModal('${childType}', ${indicesStr})" title="Agregar ${childLabel}">+</button>` : ''}
            <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquiaModal('${tipo}', ${indicesStr})" title="Editar">✏️</button>
            <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquiaModal('${tipo}', ${indicesStr})" title="Eliminar">🗑️</button>
          </div>
        </div>
    `;

    if (hasChildren) {
      html += '<div class="jerarquia-node-children" style="display: none;">'; // 👁️ Iniciar colapsado

      // Sub-áreas
      if (node.subAreas && node.subAreas.length > 0) {
        node.subAreas.forEach((subArea, subIdx) => {
          html += this.buildUbicacionNodeHTML(subArea, [...pathKeys, node.nombre, 'subArea'], [...indices, subIdx]);
        });
      }

      // Sistemas
      if (node.sistemas && node.sistemas.length > 0) {
        node.sistemas.forEach((sistema, sisIdx) => {
          html += this.buildUbicacionNodeHTML(sistema, [...pathKeys, node.nombre, 'sistemaEquipo'], [...indices, sisIdx]);
        });
      }

      // Sub-sistemas
      if (node.subSistemas && node.subSistemas.length > 0) {
        node.subSistemas.forEach((subSistema, subSisIdx) => {
          html += this.buildUbicacionNodeHTML(subSistema, [...pathKeys, node.nombre, 'subSistema'], [...indices, subSisIdx]);
        });
      }

      // Secciones
      if (node.secciones && node.secciones.length > 0) {
        node.secciones.forEach((seccion, secIdx) => {
          html += this.buildUbicacionNodeHTML(seccion, [...pathKeys, node.nombre, 'seccion'], [...indices, secIdx]);
        });
      }

      // Sub-secciones
      if (node.subSecciones && node.subSecciones.length > 0) {
        node.subSecciones.forEach((subSeccion, subSecIdx) => {
          html += this.buildUbicacionNodeHTML(subSeccion, [...pathKeys, node.nombre, 'subSeccion'], [...indices, subSecIdx]);
        });
      }

      html += '</div>';
    }

    html += '</div>';
    return html;
  }

  toggleUbicacionNode(event, toggleBtn) {
    event.stopPropagation();
    const nodeContent = toggleBtn.closest('.jerarquia-tree-node');
    const children = nodeContent.querySelector('.jerarquia-node-children');
    
    if (children) {
      const isExpanded = children.style.display !== 'none';
      children.style.display = isExpanded ? 'none' : 'block';
      toggleBtn.textContent = isExpanded ? '▶' : '▼';
    }
  }

  toggleUbicacionSelection(event, nodePath) {
    try {
      console.log('🎯 [DEBUG] toggleUbicacionSelection INICIADO');
      console.log('   event:', event);
      console.log('   nodePath (tipo):', typeof nodePath);
      console.log('   nodePath (valor):', nodePath);
      
      event.stopPropagation();
      
      console.log('🎯 [UBICACIONES] Toggle selección:', nodePath);

      // Convertir path a objeto ubicación
      console.log('   Llamando pathToUbicacion...');
      const ubicacion = this.pathToUbicacion(nodePath);
      console.log('   ubicacion convertida:', ubicacion);
      
      // NUEVO FLUJO: Agregar directamente al panel de ubicaciones asignadas
      // Verificar si ya existe esta ubicación
      const yaExiste = this.ubicacionesActuales.some(ub => {
        return ub.areaGeneral === ubicacion.areaGeneral &&
               ub.subArea === ubicacion.subArea &&
               ub.sistemaEquipo === ubicacion.sistemaEquipo &&
               ub.subSistema === ubicacion.subSistema &&
               ub.seccion === ubicacion.seccion &&
               ub.subSeccion === ubicacion.subSeccion;
      });
      
      if (yaExiste) {
        this.showToast('⚠️ Esta ubicación ya está asignada', 'warning');
        return;
      }

      // Agregar ubicación con cantidad por defecto
      ubicacion.id = Date.now() + Math.random();
      ubicacion.cantidadEnUbicacion = 1;
      this.ubicacionesActuales.push(ubicacion);
      console.log('✅ Ubicación agregada:', ubicacion);
      this.showToast('✅ Ubicación agregada', 'success');

      // Actualizar UI
      this.renderUbicacionesAsignadas();
      this.renderUbicacionesTreeSelector();
      console.log('✅ [DEBUG] toggleUbicacionSelection COMPLETADO');
      
    } catch (error) {
      console.error('❌ [ERROR] en toggleUbicacionSelection:', error);
      console.error('   Stack:', error.stack);
      console.error('   nodePath recibido:', nodePath);
    }
  }

  isUbicacionSelected(pathKeys, nodeName) {
    return this.ubicacionesActuales.some(ub => {
      // Construir path desde ubicación
      const path = [];
      if (pathKeys.includes('areaGeneral')) path.push(ub.areaGeneral);
      if (pathKeys.includes('subArea') && ub.subArea) path.push(ub.subArea);
      if (pathKeys.includes('sistemaEquipo') && ub.sistemaEquipo) path.push(ub.sistemaEquipo);
      if (pathKeys.includes('subSistema') && ub.subSistema) path.push(ub.subSistema);
      if (pathKeys.includes('seccion') && ub.seccion) path.push(ub.seccion);
      if (pathKeys.includes('subSeccion') && ub.subSeccion) path.push(ub.subSeccion);
      
      return path[path.length - 1] === nodeName;
    });
  }

  pathToUbicacion(path) {
    const ubicacion = {};
    
    // path es un array tipo: ["areaGeneral", "Producción", "sistemaEquipo", "Cinta Transversal"]
    for (let i = 0; i < path.length; i += 2) {
      const key = path[i];
      const value = path[i + 1];
      if (value) ubicacion[key] = value;
    }
    
    return ubicacion;
  }

  ubicacionToPath(ubicacion) {
    const path = [];
    if (ubicacion.areaGeneral) {
      path.push('areaGeneral', ubicacion.areaGeneral);
    }
    if (ubicacion.subArea) {
      path.push('subArea', ubicacion.subArea);
    }
    if (ubicacion.sistemaEquipo) {
      path.push('sistemaEquipo', ubicacion.sistemaEquipo);
    }
    if (ubicacion.subSistema) {
      path.push('subSistema', ubicacion.subSistema);
    }
    if (ubicacion.seccion) {
      path.push('seccion', ubicacion.seccion);
    }
    if (ubicacion.subSeccion) {
      path.push('subSeccion', ubicacion.subSeccion);
    }
    return path;
  }

  contarRepuestosEnNodo(pathKeys, nodeName) {
    return this.repuestos.filter(r => {
      if (!r.ubicaciones || r.ubicaciones.length === 0) return false;
      
      return r.ubicaciones.some(ub => {
        if (pathKeys.includes('areaGeneral') && ub.areaGeneral !== nodeName) return false;
        if (pathKeys.includes('subArea') && ub.subArea !== nodeName) return false;
        if (pathKeys.includes('sistemaEquipo') && ub.sistemaEquipo !== nodeName) return false;
        if (pathKeys.includes('subSistema') && ub.subSistema !== nodeName) return false;
        if (pathKeys.includes('seccion') && ub.seccion !== nodeName) return false;
        if (pathKeys.includes('subSeccion') && ub.subSeccion !== nodeName) return false;
        return true;
      });
    }).length;
  }
  
  /**
   * Obtiene los repuestos asignados a un nodo específico del árbol visual
   */
  getRepuestosDeNodo(ubicacion) {
    return this.repuestos.filter(r => {
      if (!r.ubicaciones || r.ubicaciones.length === 0) return false;
      
      return r.ubicaciones.some(ub => {
        // Comparar cada nivel de la ubicación
        if (ubicacion.areaGeneral && ub.areaGeneral !== ubicacion.areaGeneral) return false;
        if (ubicacion.subArea && ub.subArea !== ubicacion.subArea) return false;
        if (ubicacion.sistemaEquipo && ub.sistemaEquipo !== ubicacion.sistemaEquipo) return false;
        if (ubicacion.subSistema && ub.subSistema !== ubicacion.subSistema) return false;
        if (ubicacion.seccion && ub.seccion !== ubicacion.seccion) return false;
        if (ubicacion.subSeccion && ub.subSeccion !== ubicacion.subSeccion) return false;
        return true;
      });
    });
  }
  
  /**
   * Obtiene repuestos asignados EXACTAMENTE a un nodo (path completo debe coincidir)
   * Evita duplicados - solo muestra repuestos que terminan en ese nivel
   */
  getRepuestosDeNodoExacto(ubicacion) {
    console.log('🔍 [FILTRO] getRepuestosDeNodoExacto llamado con:', ubicacion);
    
    const resultado = this.repuestos.filter(r => {
      if (!r.ubicaciones || r.ubicaciones.length === 0) return false;
      
      return r.ubicaciones.some(ub => {
        // Verificar que TODOS los niveles del path coincidan
        if (ubicacion.areaGeneral) {
          if (ub.areaGeneral !== ubicacion.areaGeneral) return false;
        }
        if (ubicacion.subArea) {
          if (ub.subArea !== ubicacion.subArea) return false;
        }
        if (ubicacion.sistemaEquipo) {
          if (ub.sistemaEquipo !== ubicacion.sistemaEquipo) return false;
        }
        if (ubicacion.subSistema) {
          if (ub.subSistema !== ubicacion.subSistema) return false;
        }
        if (ubicacion.seccion) {
          if (ub.seccion !== ubicacion.seccion) return false;
        }
        if (ubicacion.subSeccion) {
          if (ub.subSeccion !== ubicacion.subSeccion) return false;
        }
        
        // IMPORTANTE: Verificar que no haya niveles adicionales en el repuesto
        // Contar niveles NO VACÍOS en ambos (nodo y repuesto)
        const levelsInNode = [
          ubicacion.areaGeneral, ubicacion.subArea, ubicacion.sistemaEquipo,
          ubicacion.subSistema, ubicacion.seccion, ubicacion.subSeccion
        ].filter(v => v && v.trim() !== '').length;
        
        const levelsInRepuesto = [
          ub.areaGeneral, ub.subArea, ub.sistemaEquipo, 
          ub.subSistema, ub.seccion, ub.subSeccion
        ].filter(v => v && v.trim() !== '').length;
        
        console.log(`  📊 Repuesto "${r.nombre}": levelsInNode=${levelsInNode}, levelsInRepuesto=${levelsInRepuesto}`);
        console.log(`     ubicacion nodo:`, ubicacion);
        console.log(`     ubicacion repuesto:`, ub);
        
        // Solo mostrar si el repuesto termina exactamente en este nivel
        const coincide = levelsInRepuesto === levelsInNode;
        console.log(`     ✅ Coincide: ${coincide}`);
        return coincide;
      });
    });
    
    console.log(`  🎯 Total repuestos encontrados: ${resultado.length}`);
    return resultado;
  }
  
  /**
   * Renderiza lista de repuestos para mostrar debajo de un nodo en el árbol
   * @param {Array} repuestos - Lista de repuestos a renderizar
   * @param {Number} nivel - Nivel de indentación en el árbol
   * @param {Object} ubicacionActual - Path actual del nodo (para mostrar cantidad específica)
   */
  renderRepuestosEnNodo(repuestos, nivel = 2, ubicacionActual = null) {
    if (!repuestos || repuestos.length === 0) return '';
    
    const paddingLeft = (nivel * 20) + 40; // Indentar según nivel
    
    let html = `<div class="node-repuestos-list" style="padding-left: ${paddingLeft}px; margin-top: 8px;">`;
    
    repuestos.forEach(r => {
      const nombreCorto = r.nombre?.length > 40 ? r.nombre.substring(0, 40) + '...' : r.nombre || 'Sin nombre';
      const cantidad = r.cantidad || 0;
      const minimo = r.minimo || 0;
      const statusClass = cantidad < minimo ? 'status-low' : 'status-ok';
      const statusIcon = cantidad < minimo ? '⚠️' : '✅';
      
      // 📊 CORRELATIVOS GLOBALES: Calcular correlativo global basado en TODAS las ubicaciones del repuesto
      let ubicacionesConCantidad = [];
      
      if (r.ubicaciones && Array.isArray(r.ubicaciones)) {
        r.ubicaciones.forEach((ub, ubIndex) => {
          const cantidadEnUbicacion = ub.cantidadEnUbicacion || 1;
          // Generar array con todas las instancias de esta ubicación
          for (let i = 1; i <= cantidadEnUbicacion; i++) {
            ubicacionesConCantidad.push({
              ubicacionIndex: ubIndex,
              instanciaLocal: i,
              ubicacion: ub
            });
          }
        });
      }
      
      // Filtrar solo las instancias que pertenecen a la ubicación actual
      const instanciasEnEstaUbicacion = ubicacionesConCantidad.filter((item, globalIndex) => {
        if (!ubicacionActual) return false;
        
        const ub = item.ubicacion;
        let coincide = true;
        if (ubicacionActual.areaGeneral) coincide = coincide && ub.areaGeneral === ubicacionActual.areaGeneral;
        if (ubicacionActual.subArea) coincide = coincide && ub.subArea === ubicacionActual.subArea;
        if (ubicacionActual.sistemaEquipo) coincide = coincide && ub.sistemaEquipo === ubicacionActual.sistemaEquipo;
        if (ubicacionActual.subSistema) coincide = coincide && ub.subSistema === ubicacionActual.subSistema;
        if (ubicacionActual.seccion) coincide = coincide && ub.seccion === ubicacionActual.seccion;
        if (ubicacionActual.subSeccion) coincide = coincide && ub.subSeccion === ubicacionActual.subSeccion;
        
        if (coincide) {
          // Guardar el índice global para usar como correlativo
          item.correlativoGlobal = globalIndex + 1;
        }
        return coincide;
      });
      
      // 🔢 RENDERIZAR MÚLTIPLES FILAS: Una por cada instancia con correlativo GLOBAL
      instanciasEnEstaUbicacion.forEach(item => {
        const correlativoGlobal = item.correlativoGlobal;
        const totalGlobal = ubicacionesConCantidad.length;
        
        // Indicadores adicionales
        const tieneMarcador = r.marcadorMapaId ? '<span class="marcador-badge" title="Tiene marcador en el mapa">🗺️</span>' : '<span class="marcador-badge-empty" title="Sin marcador en el mapa">📍</span>';
        
        // 🎯 BADGE CORRELATIVO GLOBAL: #1, #2, #3... #8
        const correlativoBadge = totalGlobal > 1 
          ? `<span class="instancia-badge-correlativo" title="Instancia #${correlativoGlobal} de ${totalGlobal} globales">#${correlativoGlobal}</span>` 
          : '';
        
        html += `
          <div class="node-repuesto-item" onclick="app.irAInventarioConRepuesto('${r.id}', ${item.ubicacionIndex}, ${item.instanciaLocal})" title="Click para ver en inventario - Instancia global #${correlativoGlobal}">
            <span class="repuesto-icon">📦</span>
            <span class="repuesto-nombre">${this.escapeHtml(nombreCorto)} ${correlativoBadge}</span>
            <div class="repuesto-badges">
              ${tieneMarcador}
              <span class="repuesto-cantidad ${statusClass}">${statusIcon} ${cantidad}/${minimo}</span>
            </div>
          </div>
        `;
      });
    });
    
    html += '</div>';
    return html;
  }

  limpiarSeleccionUbicaciones() {
    this.ubicacionesActuales = [];
    this.renderUbicacionesTreeSelector();
    this.mostrarPanelAsignacion();
    this.showToast('🗑️ Selección limpiada', 'info');
  }

  mostrarPanelAsignacion() {
    const selectedInfo = document.getElementById('ubicacionSelectedInfo');
    const noSelected = document.getElementById('ubicacionNoSelected');
    const selectedAreaPath = document.getElementById('selectedAreaPath');
    const btnAgregarInstancia = document.getElementById('btnAgregarInstancia');
    const siguienteInstanciaSpan = document.getElementById('siguienteInstancia');

    if (this.ubicacionesActuales.length === 0) {
      if (selectedInfo) selectedInfo.style.display = 'none';
      if (noSelected) noSelected.style.display = 'block';
      if (btnAgregarInstancia) btnAgregarInstancia.style.display = 'none';
      return;
    }

    // Mostrar panel con ubicación seleccionada
    if (selectedInfo) selectedInfo.style.display = 'block';
    if (noSelected) noSelected.style.display = 'none';

    // Construir path jerárquico
    const ub = this.ubicacionesActuales[0];
    const pathParts = [];
    if (ub.areaGeneral) pathParts.push(`<span class="path-level">📦 ${this.escapeHtml(ub.areaGeneral)}</span>`);
    if (ub.subArea) pathParts.push(`<span class="path-level">📁 ${this.escapeHtml(ub.subArea)}</span>`);
    if (ub.sistemaEquipo) pathParts.push(`<span class="path-level">⚙️ ${this.escapeHtml(ub.sistemaEquipo)}</span>`);
    if (ub.subSistema) pathParts.push(`<span class="path-level">🔧 ${this.escapeHtml(ub.subSistema)}</span>`);
    if (ub.seccion) pathParts.push(`<span class="path-level">📍 ${this.escapeHtml(ub.seccion)}</span>`);
    if (ub.subSeccion) pathParts.push(`<span class="path-level">🎯 ${this.escapeHtml(ub.subSeccion)}</span>`);
    
    if (selectedAreaPath) {
      selectedAreaPath.innerHTML = pathParts.join(' <span class="path-arrow">→</span> ');
    }

    // 🔢 Detectar si debemos mostrar botón de agregar instancia correlativa
    const nombreActual = document.getElementById('nombre')?.value?.trim();
    if (nombreActual && btnAgregarInstancia && siguienteInstanciaSpan) {
      const siguienteNumero = this.calcularSiguienteInstancia(nombreActual, ub);
      if (siguienteNumero > 1) {
        siguienteInstanciaSpan.textContent = siguienteNumero;
        btnAgregarInstancia.style.display = 'inline-block';
      } else {
        btnAgregarInstancia.style.display = 'none';
      }
    }

    // Mostrar repuestos existentes en esta ubicación
    this.mostrarRepuestosEnUbicacion(ub);
  }

  mostrarRepuestosEnUbicacion(ubicacion) {
    const container = document.getElementById('repuestosEnUbicacion');
    const list = document.getElementById('repuestosList');
    const count = document.getElementById('repuestosCount');

    if (!container || !list || !count) return;

    // Buscar repuestos en esta ubicación
    const repuestosEnEstaUbicacion = this.repuestos.filter(r => {
      if (!r.ubicaciones || r.ubicaciones.length === 0) return false;
      return r.ubicaciones.some(ub => 
        ub.areaGeneral === ubicacion.areaGeneral &&
        (!ubicacion.subArea || ub.subArea === ubicacion.subArea) &&
        (!ubicacion.sistemaEquipo || ub.sistemaEquipo === ubicacion.sistemaEquipo) &&
        (!ubicacion.subSistema || ub.subSistema === ubicacion.subSistema) &&
        (!ubicacion.seccion || ub.seccion === ubicacion.seccion) &&
        (!ubicacion.subSeccion || ub.subSeccion === ubicacion.subSeccion)
      );
    });

    count.textContent = repuestosEnEstaUbicacion.length;

    if (repuestosEnEstaUbicacion.length === 0) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    list.innerHTML = repuestosEnEstaUbicacion.map((r, idx) => {
      const tieneInstancia = r.instanciaNumero && r.instanciaNumero > 1;
      const tieneMarcador = r.marcadorMapaId ? '🗺️' : '';
      const instanciaBadge = tieneInstancia ? `<span class="instancia-badge">#${r.instanciaNumero}</span>` : '';
      
      return `
        <div class="repuesto-item">
          <span class="repuesto-icon">⚙️</span>
          <div class="repuesto-info">
            <span class="repuesto-nombre">
              ${this.escapeHtml(r.nombre)} ${instanciaBadge} ${tieneMarcador}
            </span>
            <span class="repuesto-codigo">${this.escapeHtml(r.codigoInterno || 'Sin código')}</span>
          </div>
          <div class="repuesto-actions">
            <button onclick="app.editarRepuestoModal('${r.id}')" class="btn-repuesto-edit" title="Editar">✏️</button>
            ${tieneInstancia ? `<button onclick="app.eliminarInstancia('${r.id}')" class="btn-repuesto-delete" title="Eliminar instancia">🗑️</button>` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  /**
   * Prepara la UI para agregar otra ubicación
   */
  agregarOtraUbicacion() {
    this.showToast('👆 Haz click en el árbol para agregar otra ubicación', 'info');
  }
  
  limpiarSeleccionUbicaciones() {
    if (this.ubicacionesActuales.length === 0) return;
    
    if (!confirm('¿Eliminar todas las ubicaciones asignadas?')) {
      return;
    }
    
    this.ubicacionesActuales = [];
    this.renderUbicacionesAsignadas();
    this.renderUbicacionesTreeSelector();
    this.showToast('🗑️ Ubicaciones eliminadas', 'info');
  }
  renderUbicacionesAsignadas() {
    const panel = document.getElementById('ubicacionesAsignadas');
    const list = document.getElementById('ubicacionesAsignadasList');
    const count = document.getElementById('ubicacionesCount');
    
    if (this.ubicacionesActuales.length === 0) {
      panel.style.display = 'none';
      return;
    }
    
    panel.style.display = 'block';
    count.textContent = this.ubicacionesActuales.length;
    
    list.innerHTML = this.ubicacionesActuales.map((ub, idx) => {
      // Construir path compacto
      const pathParts = [];
      if (ub.areaGeneral) pathParts.push(ub.areaGeneral);
      if (ub.subArea) pathParts.push(ub.subArea);
      if (ub.sistemaEquipo) pathParts.push(ub.sistemaEquipo);
      if (ub.subSistema) pathParts.push(ub.subSistema);
      if (ub.seccion) pathParts.push(ub.seccion);
      if (ub.subSeccion) pathParts.push(ub.subSeccion);
      
      const pathHTML = pathParts.map(part => 
        `<span class="path-level">${part}</span>`
      ).join('<span class="path-separator">→</span>');
      
      const cantidadEnUbicacion = ub.cantidadEnUbicacion || 1;
      
      return `
        <div class="ubicacion-asignada-item">
          <div class="ubicacion-path-compact">${pathHTML}</div>
          <div class="ubicacion-cantidad-control">
            <label style="font-size: 0.75rem; color: var(--text-secondary); margin-right: 6px;">Cantidad:</label>
            <input type="number" 
                   min="1" 
                   value="${cantidadEnUbicacion}" 
                   onchange="app.actualizarCantidadEnUbicacion(${idx}, this.value)"
                   style="width: 50px; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); text-align: center;"
                   title="Número de instancias en esta ubicación">
          </div>
          <button onclick="app.eliminarUbicacionAsignada(${idx})" class="btn-ubicacion-delete" title="Eliminar ubicación">
            🗑️
          </button>
        </div>
      `;
    }).join('');
  }
  
  /**
   * Actualiza la cantidad de instancias en una ubicación
   */
  actualizarCantidadEnUbicacion(index, cantidad) {
    if (index < 0 || index >= this.ubicacionesActuales.length) return;
    
    const cant = parseInt(cantidad) || 1;
    if (cant < 1) {
      this.showToast('⚠️ La cantidad debe ser al menos 1', 'warning');
      this.renderUbicacionesAsignadas();
      return;
    }
    
    this.ubicacionesActuales[index].cantidadEnUbicacion = cant;
    console.log(`📊 Cantidad actualizada en ubicación ${index}: ${cant}`);
  }
  
  /**
   * Elimina una ubicación asignada por índice
   */
  eliminarUbicacionAsignada(index) {
    if (index < 0 || index >= this.ubicacionesActuales.length) return;
    
    const ubicacion = this.ubicacionesActuales[index];
    const pathParts = [];
    if (ubicacion.areaGeneral) pathParts.push(ubicacion.areaGeneral);
    if (ubicacion.subArea) pathParts.push(ubicacion.subArea);
    if (ubicacion.sistemaEquipo) pathParts.push(ubicacion.sistemaEquipo);
    
    if (!confirm(`¿Eliminar la ubicación "${pathParts.join(' → ')}"?`)) {
      return;
    }
    
    this.ubicacionesActuales.splice(index, 1);
    this.renderUbicacionesAsignadas();
    this.showToast('🗑️ Ubicación eliminada', 'info');
    
    // Ocultar botón si no hay ubicaciones
    if (this.ubicacionesActuales.length === 0) {
      document.getElementById('btnAgregarOtraUbicacion').style.display = 'none';
    }
  }
  
  /**
   * Prepara la UI para agregar otra ubicación
   */
  agregarOtraUbicacion() {
    // Limpiar selección actual (sin borrar ubicacionesActuales)
    this.ocultarSeleccionUbicacion();
    this.showToast('👆 Selecciona otra ubicación en el árbol', 'info');
  }
  
  /**
   * Oculta el panel de selección de ubicación
   */
  ocultarSeleccionUbicacion() {
    document.getElementById('ubicacionSelectedInfo').style.display = 'none';
    document.getElementById('ubicacionNoSelected').style.display = 'block';
    document.getElementById('repuestosEnUbicacion').style.display = 'none';
  }

  cancelarSeleccionUbicacion() {
    // Solo remover la selección temporal (primer elemento)
    if (this.ubicacionesActuales.length > 0) {
      this.ubicacionesActuales.shift(); // Quitar el primero (temporal)
    }
    this.renderUbicacionesAsignadas();
    this.ocultarSeleccionUbicacion();
    this.renderUbicacionesTreeSelector();
  }
  
  /**
   * Calcula el siguiente número de instancia para un repuesto en una ubicación
   */
  calcularSiguienteInstancia(nombreBase, ubicacion) {
    // Extraer nombre base sin número (ej: "Parada Emergencia #2" → "Parada Emergencia")
    const nombreSinNumero = nombreBase.replace(/\s*#\d+\s*$/, '').trim();
    
    // Buscar todos los repuestos con el mismo nombre base en cualquier ubicación
    const instanciasExistentes = this.repuestos.filter(r => {
      const nombreRepuesto = r.nombre?.replace(/\s*#\d+\s*$/, '').trim();
      return nombreRepuesto === nombreSinNumero;
    });
    
    // Obtener el número máximo
    let maxNumero = 0;
    instanciasExistentes.forEach(r => {
      const match = r.nombre?.match(/#(\d+)\s*$/);
      if (match) {
        const numero = parseInt(match[1], 10);
        if (numero > maxNumero) maxNumero = numero;
      } else if (instanciasExistentes.length === 1) {
        // Si solo hay uno sin número, es el #1
        maxNumero = 1;
      }
    });
    
    return maxNumero + 1;
  }
  
  /**
   * Agrega una nueva instancia correlativa del repuesto actual en la ubicación seleccionada
   */
  async agregarInstanciaCorrelativa() {
    const nombreActual = document.getElementById('nombre')?.value?.trim();
    if (!nombreActual) {
      this.showToast('⚠️ Debes ingresar un nombre de repuesto primero', 'warning');
      return;
    }
    
    if (this.ubicacionesActuales.length === 0) {
      this.showToast('⚠️ Debes seleccionar una ubicación primero', 'warning');
      return;
    }
    
    const ubicacion = this.ubicacionesActuales[0];
    const siguienteNumero = this.calcularSiguienteInstancia(nombreActual, ubicacion);
    
    // Extraer nombre base sin número
    const nombreBase = nombreActual.replace(/\s*#\d+\s*$/, '').trim();
    const nuevoNombre = `${nombreBase} #${siguienteNumero}`;
    
    console.log(`➕ Creando instancia correlativa: ${nuevoNombre}`);
    
    // Crear nuevo repuesto duplicando los datos actuales
    const repuestoBase = {
      codSAP: document.getElementById('codSAP')?.value || '',
      codProv: document.getElementById('codProv')?.value || '',
      tipo: document.getElementById('tipo')?.value || '',
      categoria: document.getElementById('categoria')?.value || '',
      cantidad: parseInt(document.getElementById('cantidad')?.value) || 0,
      cantidadInstalada: parseInt(document.getElementById('cantidadInstalada')?.value) || 0,
      minimo: parseInt(document.getElementById('minimo')?.value) || 5,
      optimo: parseInt(document.getElementById('optimo')?.value) || 10,
      precio: parseFloat(document.getElementById('precio')?.value) || 0,
      datosTecnicos: document.getElementById('datosTecnicos')?.value || ''
    };
    
    const nuevoRepuesto = {
      id: Date.now().toString() + Math.random(),
      ...repuestoBase,
      nombre: nuevoNombre,
      instanciaNumero: siguienteNumero,
      nombreBase: nombreBase,
      ubicaciones: [{ ...ubicacion }],
      planta: this.plantaBase,
      // Compatibilidad con formato antiguo
      areaGeneral: ubicacion.areaGeneral || '',
      subArea: ubicacion.subArea || '',
      sistemaEquipo: ubicacion.sistemaEquipo || '',
      subSistema: ubicacion.subSistema || '',
      seccion: ubicacion.seccion || '',
      detalle: ubicacion.detalle || '',
      area: ubicacion.areaGeneral || '',
      equipo: ubicacion.sistemaEquipo || '',
      sistema: ubicacion.subSistema || '',
      detalleUbicacion: ubicacion.detalle || '',
      multimedia: [],
      marcadorMapaId: null, // Se asignará después en el mapa
      ultimaModificacion: new Date().toISOString(),
      ultimoConteo: null
    };
    
    // Agregar al array
    this.repuestos.unshift(nuevoRepuesto);
    
    // Guardar
    await this.saveData();
    
    // Actualizar UI
    await this.render();
    this.renderFilters();
    
    // Mostrar toast
    this.showToast(`✅ Instancia #${siguienteNumero} creada: ${nuevoNombre}`, 'success');
    
    // Actualizar panel
    this.mostrarRepuestosEnUbicacion(ubicacion);
    
    // Actualizar botón para siguiente instancia
    const siguienteInstanciaSpan = document.getElementById('siguienteInstancia');
    if (siguienteInstanciaSpan) {
      siguienteInstanciaSpan.textContent = siguienteNumero + 1;
    }
    
    console.log(`✅ Instancia creada con ID: ${nuevoRepuesto.id}`);
  }
  
  /**
   * Elimina una instancia correlativa de repuesto
   */
  async eliminarInstancia(repuestoId) {
    const repuesto = this.repuestos.find(r => r.id === repuestoId);
    
    if (!repuesto) {
      this.showToast('❌ Repuesto no encontrado', 'error');
      return;
    }
    
    // Confirmar eliminación
    const confirmar = confirm(`¿Eliminar la instancia "${repuesto.nombre}"?\n\nEsta acción no se puede deshacer.`);
    if (!confirmar) return;
    
    console.log(`🗑️ Eliminando instancia: ${repuesto.nombre} (ID: ${repuestoId})`);
    
    // Eliminar imágenes si existen
    if (repuesto.multimedia && fsManager.isFileSystemMode) {
      const imagenesFileSystem = repuesto.multimedia
        .filter(m => m.type === 'image' && m.isFileSystem && m.url)
        .map(m => m.url);
      
      if (imagenesFileSystem.length > 0) {
        console.log(`  📁 Eliminando ${imagenesFileSystem.length} imágenes...`);
        await fsManager.deleteMultipleImages(imagenesFileSystem);
      }
    }
    
    // Eliminar del array
    this.repuestos = this.repuestos.filter(r => r.id !== repuestoId);
    
    // Guardar
    await this.saveData();
    
    // Actualizar UI
    await this.render();
    this.renderFilters();
    
    // Si estamos en el modal, actualizar panel
    if (this.ubicacionesActuales && this.ubicacionesActuales.length > 0) {
      this.mostrarRepuestosEnUbicacion(this.ubicacionesActuales[0]);
      
      // Recalcular siguiente instancia
      const nombreActual = document.getElementById('nombre')?.value?.trim();
      if (nombreActual) {
        const siguienteNumero = this.calcularSiguienteInstancia(nombreActual, this.ubicacionesActuales[0]);
        const siguienteInstanciaSpan = document.getElementById('siguienteInstancia');
        if (siguienteInstanciaSpan) {
          siguienteInstanciaSpan.textContent = siguienteNumero;
        }
      }
    }
    
    this.showToast(`✅ Instancia "${repuesto.nombre}" eliminada`, 'success');
    console.log(`✅ Instancia eliminada correctamente`);
  }

  // Helper para determinar tipo de nodo y nivel hijo
  getNodoTypeInfo(pathKeys) {
    const lastKey = pathKeys[pathKeys.length - 1];
    
    const mappings = {
      'areaGeneral': {
        tipo: 'area',
        childType: 'subArea',
        childLabel: 'Sub-Área'
      },
      'subArea': {
        tipo: 'subArea',
        childType: 'sistema',
        childLabel: 'Sistema'
      },
      'sistemaEquipo': {
        tipo: 'sistema',
        childType: 'subSistema',
        childLabel: 'Sub-Sistema'
      },
      'subSistema': {
        tipo: 'subSistema',
        childType: 'seccion',
        childLabel: 'Sección'
      },
      'seccion': {
        tipo: 'seccion',
        childType: 'subSeccion',
        childLabel: 'Sub-Sección'
      },
      'subSeccion': {
        tipo: 'subSeccion',
        childType: null,
        childLabel: null
      }
    };

    return mappings[lastKey] || { tipo: 'unknown', childType: null, childLabel: null };
  }

  // Wrappers para edición desde modal - re-renderizan el selector en lugar del tab
  async agregarNodoJerarquiaModal(tipo, ...indices) {
    await this.agregarNodoJerarquia(tipo, ...indices);
    // Re-renderizar selector visual en el modal
    this.renderUbicacionesTreeSelector();
    // Auto-expandir el nodo padre que contiene el nuevo sub-nivel
    setTimeout(() => this.autoExpandirNodoPadre(indices), 100);
  }

  async editarNodoJerarquiaModal(tipo, ...indices) {
    await this.editarNodoJerarquia(tipo, ...indices);
    // Re-renderizar selector visual en el modal
    this.renderUbicacionesTreeSelector();
  }

  async eliminarNodoJerarquiaModal(tipo, ...indices) {
    await this.eliminarNodoJerarquia(tipo, ...indices);
    // Re-renderizar selector visual en el modal
    this.renderUbicacionesTreeSelector();
  }

  autoExpandirNodoPadre(indices) {
    if (!indices || indices.length === 0) return;
    
    // Expandir todos los nodos en el path hasta el padre
    const container = document.getElementById('ubicacionesTreeContainer');
    if (!container) return;

    const allToggles = container.querySelectorAll('.jerarquia-node-toggle');
    let expandCount = indices.length;
    
    allToggles.forEach((toggle, index) => {
      if (index < expandCount && toggle.textContent === '▶') {
        const children = toggle.closest('.jerarquia-tree-node')?.querySelector('.jerarquia-node-children');
        if (children) {
          children.style.display = 'block';
          toggle.textContent = '▼';
        }
      }
    });
  }

  // DEPRECATED: Mantener temporalmente para compatibilidad
  renderUbicacionesCascada() {
    // Redirigir a la nueva función
    this.renderUbicacionesTreeSelector();
  }
  
  /**
   * Inicializa los selects con las opciones correctas segn valores actuales
   */
  inicializarSelectsCascada() {
    this.ubicacionesActuales.forEach(ubicacion => {
      // Cargar reas (siempre disponibles)
      this.cargarOpcionesSelect(ubicacion.id, 'area', {});
      
      // Si hay rea seleccionada, cargar sub-reas
      if (ubicacion.areaGeneral) {
        this.cargarOpcionesSelect(ubicacion.id, 'subArea', { area: ubicacion.areaGeneral });
      }
      
      // Si hay sub-rea, cargar sistemas
      if (ubicacion.areaGeneral && ubicacion.subArea) {
        this.cargarOpcionesSelect(ubicacion.id, 'sistema', { 
          area: ubicacion.areaGeneral, 
          subArea: ubicacion.subArea 
        });
      }
      
      // Si hay sistema, cargar sub-sistemas
      if (ubicacion.areaGeneral && ubicacion.subArea && ubicacion.sistemaEquipo) {
        this.cargarOpcionesSelect(ubicacion.id, 'subSistema', { 
          area: ubicacion.areaGeneral, 
          subArea: ubicacion.subArea,
          sistema: ubicacion.sistemaEquipo
        });
      }
      
      // Si hay sub-sistema, cargar secciones
      if (ubicacion.areaGeneral && ubicacion.subArea && ubicacion.sistemaEquipo && ubicacion.subSistema) {
        this.cargarOpcionesSelect(ubicacion.id, 'seccion', { 
          area: ubicacion.areaGeneral, 
          subArea: ubicacion.subArea,
          sistema: ubicacion.sistemaEquipo,
          subSistema: ubicacion.subSistema
        });
      }
      
      // Si hay seccin, cargar sub-secciones
      if (ubicacion.areaGeneral && ubicacion.subArea && ubicacion.sistemaEquipo && 
          ubicacion.subSistema && ubicacion.seccion) {
        this.cargarOpcionesSelect(ubicacion.id, 'subSeccion', { 
          area: ubicacion.areaGeneral, 
          subArea: ubicacion.subArea,
          sistema: ubicacion.sistemaEquipo,
          subSistema: ubicacion.subSistema,
          seccion: ubicacion.seccion
        });
      }
    });
  }
  
  /**
   * Carga opciones en un select especfico segn nivel y padres
   */
  cargarOpcionesSelect(ubicacionId, nivel, valoresPadres) {
    const select = document.querySelector(`select[data-ubicacion-id="${ubicacionId}"][data-nivel="${nivel}"]`);
    if (!select) return;
    
    const opciones = this.getOpcionesJerarquicasCascada(nivel, valoresPadres);
    const ubicacion = this.ubicacionesActuales.find(ub => ub.id === ubicacionId);
    const valorActual = ubicacion ? ubicacion[select.dataset.field] : '';
    
    // Generar options
    let optionsHtml = `<option value="">-- Seleccionar ${this.getNombreNivel(nivel)} --</option>`;
    opciones.forEach(opcion => {
      const selected = opcion === valorActual ? 'selected' : '';
      optionsHtml += `<option value="${opcion}" ${selected}>${opcion}</option>`;
    });
    
    select.innerHTML = optionsHtml;
    select.disabled = opciones.length === 0;
    
    console.log(` [cargarOpcionesSelect] ${nivel} para ubicacin ${ubicacionId}: ${opciones.length} opciones`);
  }
  
  /**
   * Obtiene el nombre legible de un nivel
   */
  getNombreNivel(nivel) {
    const nombres = {
      'area': 'rea',
      'subArea': 'Sub-rea',
      'sistema': 'Sistema',
      'subSistema': 'Sub-Sistema',
      'seccion': 'Seccin',
      'subSeccion': 'Sub-Seccin'
    };
    return nombres[nivel] || nivel;
  }
  
  /**
   * Configura los listeners para la cascada de selects
   */
  configurarListenersCascada() {
    document.querySelectorAll('.ubicacion-select-cascada').forEach(select => {
      select.addEventListener('change', (e) => {
        const ubicacionId = parseInt(e.target.dataset.ubicacionId);
        const field = e.target.dataset.field;
        const nivel = e.target.dataset.nivel;
        const valor = e.target.value;
        
        // Actualizar valor en ubicacionesActuales
        const ubicacion = this.ubicacionesActuales.find(ub => ub.id === ubicacionId);
        if (ubicacion) {
          ubicacion[field] = valor;
          console.log(` [Cascada] Seleccionado ${field} = "${valor}"`);
          
          // Resetear niveles inferiores
          this.resetearNivelesInferiores(ubicacion, nivel);
          
          // Actualizar select del siguiente nivel
          this.actualizarSiguienteNivel(ubicacionId, nivel, ubicacion);
        }
      });
    });
  }
  
  /**
   * Resetea los valores de niveles inferiores al cambiar un nivel superior
   */
  resetearNivelesInferiores(ubicacion, nivelCambiado) {
    const jerarquia = ['area', 'subArea', 'sistema', 'subSistema', 'seccion', 'subSeccion'];
    const index = jerarquia.indexOf(nivelCambiado);
    
    if (index === -1) return;
    
    // Mapeo de niveles a campos
    const camposPorNivel = {
      'area': 'areaGeneral',
      'subArea': 'subArea',
      'sistema': 'sistemaEquipo',
      'subSistema': 'subSistema',
      'seccion': 'seccion',
      'subSeccion': 'subSeccion'
    };
    
    // Resetear todos los niveles inferiores
    for (let i = index + 1; i < jerarquia.length; i++) {
      const campo = camposPorNivel[jerarquia[i]];
      if (campo && ubicacion[campo]) {
        console.log(` [resetearNivelesInferiores] Reseteando ${campo}`);
        ubicacion[campo] = '';
      }
    }
  }
  
  /**
   * Actualiza el siguiente nivel en la cascada
   */
  actualizarSiguienteNivel(ubicacionId, nivelActual, ubicacion) {
    const siguienteNivel = {
      'area': 'subArea',
      'subArea': 'sistema',
      'sistema': 'subSistema',
      'subSistema': 'seccion',
      'seccion': 'subSeccion'
    };
    
    const proximoNivel = siguienteNivel[nivelActual];
    if (!proximoNivel) return;
    
    // Construir objeto de valores padres
    const valoresPadres = {};
    if (ubicacion.areaGeneral) valoresPadres.area = ubicacion.areaGeneral;
    if (ubicacion.subArea) valoresPadres.subArea = ubicacion.subArea;
    if (ubicacion.sistemaEquipo) valoresPadres.sistema = ubicacion.sistemaEquipo;
    if (ubicacion.subSistema) valoresPadres.subSistema = ubicacion.subSistema;
    if (ubicacion.seccion) valoresPadres.seccion = ubicacion.seccion;
    
    // Cargar opciones del siguiente nivel
    this.cargarOpcionesSelect(ubicacionId, proximoNivel, valoresPadres);
    
    // Tambin resetear y deshabilitar niveles an ms abajo
    const select = document.querySelector(`select[data-ubicacion-id="${ubicacionId}"][data-nivel="${proximoNivel}"]`);
    if (select) {
      select.disabled = false;
    }
  }

  renderUbicaciones() {
    const container = document.getElementById('ubicacionesContainer');
    if (!container) return;
    container.classList.remove('sap-ubicaciones-grid');
    
    if (this.ubicacionesActuales.length === 0) {
      this.agregarUbicacion(); // Agregar al menos una ubicacin
      return;
    }
    
    // Layout horizontal adaptativo segn cantidad de ubicaciones
    const numUbicaciones = this.ubicacionesActuales.length;
    const minWidth = numUbicaciones <= 2 ? '350px' : '320px';
    let html = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(${minWidth}, 1fr)); gap: 16px;">`;
    
    this.ubicacionesActuales.forEach((ubicacion, index) => {
      html += `
        <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; border: 2px solid var(--border-color);">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <h5 style="margin: 0; color: var(--text-primary); font-size: 0.95rem; font-weight: 600;">
              Ubicacin ${index + 1}
            </h5>
            ${this.ubicacionesActuales.length > 1 ? `
              <button type="button" onclick="app.eliminarUbicacion(${ubicacion.id})" class="btn btn-danger" style="padding: 4px 10px; font-size: 0.75rem;">
                Eliminar
              </button>
            ` : ''}
          </div>
          
          <!-- Nivel 1: Empresa (fijo) -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">1.</span>
              <span>Empresa:</span>
            </label>
            <input type="text" class="form-control" value="Aquachile Antarfood Chonchi" readonly style="background: var(--bg-secondary); cursor: not-allowed; font-size: 0.85rem;">
          </div>
          
          <!-- Nivel 2: rea General -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">2.</span>
              <span>rea General: *</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="areaGeneral"
                   value="${ubicacion.areaGeneral}"
                   list="areaGeneralList-${ubicacion.id}"
                   placeholder="Ej: Planta Principal, Acopio"
                   style="font-size: 0.85rem;">
            <datalist id="areaGeneralList-${ubicacion.id}">
              ${this.opcionesJerarquia.areaGeneral.map(opt => `<option value="${opt}">`).join('')}
            </datalist>
          </div>
          
          <!-- Nivel 3: Sub-rea -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">3.</span>
              <span>Sub-rea:</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="subArea"
                   value="${ubicacion.subArea}"
                   list="subAreaList-${ubicacion.id}"
                   placeholder="Ej: Zona Norte, Piso 1"
                   style="font-size: 0.85rem;">
            <datalist id="subAreaList-${ubicacion.id}">
              ${this.opcionesJerarquia.subArea.map(opt => `<option value="${opt}">`).join('')}
            </datalist>
          </div>
          
          <!-- Nivel 4: Sistema/Equipo -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">4.</span>
              <span>Sistema/Equipo:</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="sistemaEquipo"
                   value="${ubicacion.sistemaEquipo}"
                   list="sistemaEquipoList-${ubicacion.id}"
                   placeholder="Ej: Grader Marel, Compresor 01"
                   style="font-size: 0.85rem;">
            <datalist id="sistemaEquipoList-${ubicacion.id}">
              ${this.opcionesJerarquia.sistemaEquipo.map(opt => `<option value="${opt}">`).join('')}
            </datalist>
          </div>
          
          <!-- Nivel 5: Sub-Sistema -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">5.</span>
              <span>Sub-Sistema:</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="subSistema"
                   value="${ubicacion.subSistema}"
                   list="subSistemaList-${ubicacion.id}"
                   placeholder="Ej: Pocket 1, Motor Principal"
                   style="font-size: 0.85rem;">
            <datalist id="subSistemaList-${ubicacion.id}">
              ${this.opcionesJerarquia.subSistema.map(opt => `<option value="${opt}">`).join('')}
            </datalist>
          </div>
          
          <!-- Nivel 6: Seccin -->
          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">6.</span>
              <span>Seccin:</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="seccion"
                   value="${ubicacion.seccion}"
                   list="seccionList-${ubicacion.id}"
                   placeholder="Ej: Sistema Hidrulico, Panel Elctrico"
                   style="font-size: 0.85rem;">
            <datalist id="seccionList-${ubicacion.id}">
              ${this.opcionesJerarquia.seccion.map(opt => `<option value="${opt}">`).join('')}
            </datalist>
          </div>
          
          <!-- Nivel 7: Detalle -->
          <div class="form-group" style="margin-bottom: 0;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
              <span style="font-weight: 700; color: var(--primary);">7.</span>
              <span>Detalle / Ubicacin Especfica:</span>
            </label>
            <input type="text" 
                   class="form-control ubicacion-input" 
                   data-ubicacion-id="${ubicacion.id}"
                   data-field="detalle"
                   value="${ubicacion.detalle}"
                   placeholder="Ej: Lado Izquierdo, Estante 2 Nivel 3, Bastidor Superior"
                   style="font-size: 0.85rem;">
            <small style="color: var(--text-secondary); font-size: 0.7rem; display: block; margin-top: 4px;">
               Campo de texto libre para referencia exacta de ubicacin
            </small>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Agregar listeners para actualizar datos
    document.querySelectorAll('.ubicacion-input').forEach(input => {
      input.addEventListener('input', (e) => {
        const ubicacionId = parseInt(e.target.dataset.ubicacionId);
        const field = e.target.dataset.field;
        const ubicacion = this.ubicacionesActuales.find(ub => ub.id === ubicacionId);
        if (ubicacion) {
          ubicacion[field] = e.target.value;
          console.log(` Actualizado ${field} =`, e.target.value, 'en ubicacin', ubicacionId);
        }
      });
    });
    
    // DEBUG: Mostrar estado actual
    console.log(' Ubicaciones actuales:', JSON.stringify(this.ubicacionesActuales, null, 2));
    
    // Actualizar indicador visual
    this.actualizarIndicadorVersion();
    
    // Ajustar ancho del modal segn cantidad de ubicaciones
    this.ajustarAnchoModal();
  }
  
  /**
   *  Actualiza el indicador visual de qu versin est activa
   *  DESHABILITADO - Indicador eliminado del UI
   */
  actualizarIndicadorVersion() {
    // Función deshabilitada - el indicador ya no existe en el DOM
    return;
  }
  
  ajustarAnchoModal() {
    const modalContent = document.querySelector('.modal-content');
    if (!modalContent) return;
    
    const screenWidth = window.innerWidth;
    
    // Restablece estilos para respetar las reglas CSS base
    modalContent.style.removeProperty('width');
    modalContent.style.removeProperty('max-width');
    modalContent.style.removeProperty('height');
    modalContent.style.removeProperty('max-height');
    modalContent.style.removeProperty('margin-top');
    modalContent.style.removeProperty('margin-bottom');

    // En pantallas pequeas usamos casi todo el viewport
    if (screenWidth <= 768) {
      modalContent.style.width = 'calc(100vw - 24px)';
      modalContent.style.maxWidth = 'calc(100vw - 24px)';
      modalContent.style.height = 'auto';
      modalContent.style.maxHeight = 'calc(100vh - 40px)';
      modalContent.style.marginTop = '20px';
      modalContent.style.marginBottom = '20px';
      return;
    }

    // Para pantallas grandes, usar dimensiones ms compactas
    const horizontalMargin = Math.max(32, Math.round(screenWidth * 0.02));
    const desiredWidth = Math.min(screenWidth - (horizontalMargin * 2), 1200); // Reducido de 2100 a 1200
    const topSpacing = Math.max(10, Math.round(window.innerHeight * 0.02));
    const bottomSpacing = Math.max(20, Math.round(window.innerHeight * 0.04));

    // Eliminar estilos de altura fija, dejar que sea automtico
    modalContent.style.width = desiredWidth + 'px';
    modalContent.style.maxWidth = desiredWidth + 'px';
    modalContent.style.height = 'auto';
    modalContent.style.maxHeight = '92vh';
    modalContent.style.marginTop = topSpacing + 'px';
    modalContent.style.marginBottom = bottomSpacing + 'px';
  }

  /**
   * NUEVA FUNCIN AUXILIAR - Obtiene opciones jerrquicas en cascada
   * Recorre jerarquiaAnidada y retorna opciones vlidas segn seleccin de padres
   * 
   * @param {string} nivel - El nivel a obtener: 'area', 'subArea', 'sistema', 'subSistema', 'seccion', 'subSeccion'
   * @param {object} valoresPadres - Valores seleccionados de niveles superiores
   * @returns {Array<string>} - Array de nombres vlidos para el nivel especificado
   * 
   * Ejemplos de uso:
   *   getOpcionesJerarquicasCascada('area', {})  
   *    ['Planta Principal', 'Acopio', ...]
   * 
   *   getOpcionesJerarquicasCascada('subArea', { area: 'Planta Principal' })  
   *    ['Eviscerado', 'Proceso', ...] (solo las que pertenecen a Planta Principal)
   * 
   *   getOpcionesJerarquicasCascada('sistema', { area: 'Planta Principal', subArea: 'Eviscerado' })
   *    ['Grader', ...] (solo sistemas bajo Eviscerado)
   */
  getOpcionesJerarquicasCascada(nivel, valoresPadres = {}) {
    console.log(`[getOpcionesJerarquicasCascada] Nivel: ${nivel}, Padres:`, valoresPadres);
    
    // Si no hay jerarqua anidada, retornar array vaco
    if (!this.jerarquiaAnidada || !this.jerarquiaAnidada.areas) {
      console.warn('[getOpcionesJerarquicasCascada] No existe jerarquiaAnidada');
      return [];
    }
    
    const opciones = [];
    
    try {
      switch(nivel) {
        case 'area':
          // Nivel 2: retornar todas las reas
          this.jerarquiaAnidada.areas.forEach(area => {
            if (area.nombre) opciones.push(area.nombre);
          });
          break;
          
        case 'subArea':
          // Nivel 3: filtrar por rea seleccionada
          if (!valoresPadres.area) {
            console.warn('[getOpcionesJerarquicasCascada] Se requiere rea para obtener sub-reas');
            return [];
          }
          
          const area = this.jerarquiaAnidada.areas.find(a => a.nombre === valoresPadres.area);
          if (area && area.subAreas) {
            area.subAreas.forEach(subArea => {
              if (subArea.nombre) opciones.push(subArea.nombre);
            });
          }
          break;
          
        case 'sistema':
          // Nivel 4: filtrar por rea y sub-rea seleccionadas
          if (!valoresPadres.area || !valoresPadres.subArea) {
            console.warn('[getOpcionesJerarquicasCascada] Se requiere rea y sub-rea para obtener sistemas');
            return [];
          }
          
          const areaParaSistema = this.jerarquiaAnidada.areas.find(a => a.nombre === valoresPadres.area);
          if (areaParaSistema && areaParaSistema.subAreas) {
            const subArea = areaParaSistema.subAreas.find(sa => sa.nombre === valoresPadres.subArea);
            if (subArea && subArea.sistemas) {
              subArea.sistemas.forEach(sistema => {
                if (sistema.nombre) opciones.push(sistema.nombre);
              });
            }
          }
          break;
          
        case 'subSistema':
          // Nivel 5: filtrar por rea, sub-rea y sistema seleccionados
          if (!valoresPadres.area || !valoresPadres.subArea || !valoresPadres.sistema) {
            console.warn('[getOpcionesJerarquicasCascada] Se requiere rea, sub-rea y sistema para obtener sub-sistemas');
            return [];
          }
          
          const areaParaSubSistema = this.jerarquiaAnidada.areas.find(a => a.nombre === valoresPadres.area);
          if (areaParaSubSistema && areaParaSubSistema.subAreas) {
            const subAreaParaSubSistema = areaParaSubSistema.subAreas.find(sa => sa.nombre === valoresPadres.subArea);
            if (subAreaParaSubSistema && subAreaParaSubSistema.sistemas) {
              const sistema = subAreaParaSubSistema.sistemas.find(s => s.nombre === valoresPadres.sistema);
              if (sistema && sistema.subSistemas) {
                sistema.subSistemas.forEach(subSistema => {
                  if (subSistema.nombre) opciones.push(subSistema.nombre);
                });
              }
            }
          }
          break;
          
        case 'seccion':
          // Nivel 6: filtrar por rea, sub-rea, sistema y sub-sistema seleccionados
          if (!valoresPadres.area || !valoresPadres.subArea || !valoresPadres.sistema || !valoresPadres.subSistema) {
            console.warn('[getOpcionesJerarquicasCascada] Se requiere rea, sub-rea, sistema y sub-sistema para obtener secciones');
            return [];
          }
          
          const areaParaSeccion = this.jerarquiaAnidada.areas.find(a => a.nombre === valoresPadres.area);
          if (areaParaSeccion && areaParaSeccion.subAreas) {
            const subAreaParaSeccion = areaParaSeccion.subAreas.find(sa => sa.nombre === valoresPadres.subArea);
            if (subAreaParaSeccion && subAreaParaSeccion.sistemas) {
              const sistemaParaSeccion = subAreaParaSeccion.sistemas.find(s => s.nombre === valoresPadres.sistema);
              if (sistemaParaSeccion && sistemaParaSeccion.subSistemas) {
                const subSistema = sistemaParaSeccion.subSistemas.find(ss => ss.nombre === valoresPadres.subSistema);
                if (subSistema && subSistema.secciones) {
                  subSistema.secciones.forEach(seccion => {
                    if (seccion.nombre) opciones.push(seccion.nombre);
                  });
                }
              }
            }
          }
          break;
          
        case 'subSeccion':
          // Nivel 7: filtrar por rea, sub-rea, sistema, sub-sistema y seccin seleccionados
          if (!valoresPadres.area || !valoresPadres.subArea || !valoresPadres.sistema || 
              !valoresPadres.subSistema || !valoresPadres.seccion) {
            console.warn('[getOpcionesJerarquicasCascada] Se requieren todos los niveles superiores para obtener sub-secciones');
            return [];
          }
          
          const areaParaSubSeccion = this.jerarquiaAnidada.areas.find(a => a.nombre === valoresPadres.area);
          if (areaParaSubSeccion && areaParaSubSeccion.subAreas) {
            const subAreaParaSubSeccion = areaParaSubSeccion.subAreas.find(sa => sa.nombre === valoresPadres.subArea);
            if (subAreaParaSubSeccion && subAreaParaSubSeccion.sistemas) {
              const sistemaParaSubSeccion = subAreaParaSubSeccion.sistemas.find(s => s.nombre === valoresPadres.sistema);
              if (sistemaParaSubSeccion && sistemaParaSubSeccion.subSistemas) {
                const subSistemaParaSubSeccion = sistemaParaSubSeccion.subSistemas.find(ss => ss.nombre === valoresPadres.subSistema);
                if (subSistemaParaSubSeccion && subSistemaParaSubSeccion.secciones) {
                  const seccion = subSistemaParaSubSeccion.secciones.find(sec => sec.nombre === valoresPadres.seccion);
                  if (seccion && seccion.subSecciones) {
                    seccion.subSecciones.forEach(subSeccion => {
                      if (subSeccion.nombre) opciones.push(subSeccion.nombre);
                    });
                  }
                }
              }
            }
          }
          break;
          
        default:
          console.error(`[getOpcionesJerarquicasCascada] Nivel desconocido: ${nivel}`);
          return [];
      }
      
      console.log(`[getOpcionesJerarquicasCascada] Resultado: ${opciones.length} opciones`, opciones);
      return opciones;
      
    } catch (error) {
      console.error('[getOpcionesJerarquicasCascada] Error al obtener opciones:', error);
      return [];
    }
  }

  mostrarEjemplosCategoria(categoria) {
    const ejemplosElement = document.getElementById('ejemplosCategoria');
    if (!ejemplosElement) return;
    
    const ejemplos = {
      'Repuesto': 'Ejemplos: filtros, rodamientos, vlvulas, correas, motores',
      'Insumo': 'Ejemplos: brochas, guantes, grasas, pinturas, cintas adhesivas',
      'Herramienta': 'Ejemplos: taladros, llaves, destornilladores, martillos',
      'EPP': 'Ejemplos: cascos, lentes, arneses, guantes de seguridad',
      'Qumico': 'Ejemplos: desengrasantes, cidos, solventes, desinfectantes'
    };
    
    if (categoria && ejemplos[categoria]) {
      ejemplosElement.textContent = ejemplos[categoria];
      ejemplosElement.style.color = '#7A9AB8'; // Azul claro
    } else {
      ejemplosElement.textContent = 'Selecciona una categora para ver ejemplos';
      ejemplosElement.style.color = '#94a3b8'; // Gris
    }
  }

  mostrarJerarquia(id) {
    const repuesto = this.repuestos.find(r => r.id === id);
    if (!repuesto) return;
    
    // Obtener ubicaciones (nuevo formato o antiguo)
    let ubicaciones = [];
    if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones) && repuesto.ubicaciones.length > 0) {
      ubicaciones = repuesto.ubicaciones;
    } else {
      // Formato antiguo: crear array con una ubicacin
      ubicaciones = [{
        areaGeneral: repuesto.areaGeneral || repuesto.area,
        subArea: repuesto.subArea,
        sistemaEquipo: repuesto.sistemaEquipo || repuesto.equipo,
        subSistema: repuesto.subSistema || repuesto.sistema,
        seccion: repuesto.seccion,
        detalle: repuesto.detalle || repuesto.detalleUbicacion
      }];
    }
    
    const planta = repuesto.planta || this.plantaBase;
    
    // CONSTRUIR RBOL RAMIFICADO (con nombre del repuesto)
    const arbolHTML = this.construirArbolJerarquia(ubicaciones, planta, repuesto.nombre);
    
    const html = `
      <div style="width: 90vw; max-width: 1400px; max-height: 85vh; background: var(--card-bg); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        
        <!-- Header -->
        <div style="padding: 20px 24px; background: var(--primary); border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <h3 style="margin: 0; color: #ffffff; font-size: 1.3rem; font-weight: 600;">
               Ubicacin del Repuesto
            </h3>
            <button onclick="app.closeCustomModal()" 
                    style="background: rgba(255,255,255,0.15); border: none; color: white; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 18px; transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.25)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.15)'"></button>
          </div>
          <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <div style="font-size: 0.9rem; font-weight: 600; color: #ffffff;">${repuesto.nombre}</div>
            ${repuesto.codSAP ? `<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">SAP: ${repuesto.codSAP}</div>` : ''}
            <div style="margin-left: auto; font-size: 0.7rem; color: rgba(255,255,255,0.75); background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 12px; font-weight: 500;">
              ${ubicaciones.length} ${ubicaciones.length === 1 ? 'Ubicacin' : 'Ubicaciones'}
            </div>
          </div>
        </div>
        
        <!-- rea del rbol con scroll -->
        <div style="flex: 1; overflow: auto; background: var(--bg-secondary); padding: 20px;">
          ${arbolHTML}
        </div>
        
        <!-- Footer -->
        <div style="padding: 14px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border); flex-shrink: 0; display: flex; justify-content: center;">
          <button onclick="app.closeCustomModal()" 
                  style="padding: 12px 48px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.2s;"
                  onmouseover="this.style.opacity='0.9'"
                  onmouseout="this.style.opacity='1'">
            Cerrar
          </button>
        </div>
        
      </div>
    `;
    
    this.showCustomModal(html);
  }
  
  construirArbolJerarquia(ubicaciones, planta, nombreRepuesto) {
    console.log(' Construyendo rbol tipo dendrograma VERTICAL...', ubicaciones);
    if (ubicaciones.length === 0) return '<div style="text-align: center; color: var(--text-secondary); padding: 40px; font-size: 0.95rem;">Sin ubicaciones registradas</div>';
    
    // JERARQUÍA UNIFICADA: Usar niveles 2-7 (nivel1 es Empresa, no se muestra en árbol)
    const niveles = ['nivel2', 'nivel3', 'nivel4', 'nivel5', 'nivel6', 'nombreRepuesto', 'nivel7'];
    const nodos = this.construirNodosArbol(ubicaciones, planta, niveles, nombreRepuesto);
    console.log(' Nodos construidos con jerarquía unificada:', nodos);
    
    // Calcular posiciones VERTICALES (hacia abajo)
    let posicionX = 0;
    const nodosConPosicion = [];
    const nivelY = 110; // Espacio vertical entre niveles
    const anchoNodo = 240; // Ancho de nodos
    const altoNodo = 70;
    
    const calcularPosiciones = (nodo, nivel = 0) => {
      const y = nivel * nivelY + 50;
      
      if (!nodo.hijos || nodo.hijos.length === 0) {
        // Nodo hoja
        const x = posicionX * (anchoNodo + 30) + 50;
        nodosConPosicion.push({ ...nodo, x, y, nivel });
        posicionX++;
        return x;
      } else {
        // Nodo con hijos
        const posicionesHijos = nodo.hijos.map(hijo => 
          calcularPosiciones(hijo, nivel + 1)
        );
        const xPromedio = (Math.min(...posicionesHijos) + Math.max(...posicionesHijos)) / 2;
        nodosConPosicion.push({ ...nodo, x: xPromedio, y, nivel, posicionesHijos });
        return xPromedio;
      }
    };
    
    // Calcular posiciones de todos los nodos
    nodos.forEach(nodo => calcularPosiciones(nodo));
    
    // Calcular dimensiones del SVG
    const maxX = Math.max(...nodosConPosicion.map(n => n.x)) + anchoNodo + 100;
    const maxY = Math.max(...nodosConPosicion.map(n => n.y)) + altoNodo + 60;
    
    // Generar SVG con lneas y nodos (VERTICAL)
    let svg = `<svg width="${maxX}" height="${maxY}" style="font-family: system-ui, -apple-system, sans-serif; display: block; min-width: 100%;">`;
    
    // Definir gradientes y filtros SUAVES
    svg += `
      <defs>
        <filter id="sombra" x="-30%" y="-30%" width="160%" height="160%">
          <feGaussianBlur in="SourceAlpha" stdDeviation="4"/>
          <feOffset dx="0" dy="3" result="offsetblur"/>
          <feComponentTransfer>
            <feFuncA type="linear" slope="0.15"/>
          </feComponentTransfer>
          <feMerge>
            <feMergeNode/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
    `;
    
    // Dibujar lneas de conexin
    nodosConPosicion.forEach(nodo => {
      if (nodo.hijos && nodo.hijos.length > 0) {
        const nodoCentroX = nodo.x + anchoNodo / 2;
        const nodoCentroYAbajo = nodo.y + altoNodo;
        
        nodo.hijos.forEach((hijo, idx) => {
          const hijoNodo = nodosConPosicion.find(n => n.valor === hijo.valor && n.nivel === nodo.nivel + 1);
          if (hijoNodo) {
            const hijoCentroX = hijoNodo.x + anchoNodo / 2;
            const hijoCentroYArriba = hijoNodo.y;
            
            // Lnea vertical desde el padre
            const yMedio = nodoCentroYAbajo + 25;
            svg += `<line x1="${nodoCentroX}" y1="${nodoCentroYAbajo}" x2="${nodoCentroX}" y2="${yMedio}" stroke="#94a3b8" stroke-width="2" opacity="0.6"/>`;
            
            // Lnea horizontal (si hay mltiples hijos)
            if (nodo.hijos.length > 1) {
              if (idx === 0) {
                const ultimoHijo = nodosConPosicion.find(n => n.valor === nodo.hijos[nodo.hijos.length - 1].valor && n.nivel === nodo.nivel + 1);
                if (ultimoHijo) {
                  const ultimoHijoCentroX = ultimoHijo.x + anchoNodo / 2;
                  svg += `<line x1="${hijoCentroX}" y1="${yMedio}" x2="${ultimoHijoCentroX}" y2="${yMedio}" stroke="#94a3b8" stroke-width="2" opacity="0.6"/>`;
                }
              }
            }
            
            // Lnea vertical hasta el hijo
            svg += `<line x1="${hijoCentroX}" y1="${yMedio}" x2="${hijoCentroX}" y2="${hijoCentroYArriba}" stroke="#94a3b8" stroke-width="2" opacity="0.6"/>`;
          }
        });
      }
    });
    
    // Colores CORPORATIVOS MATE del proyecto (los originales que pediste)
    const coloresPorNivel = [
      { fondo: '#C4A882', borde: '#A68F6D', texto: '#ffffff' }, // Nivel 0 - Empresa (beige/caf mate)
      { fondo: '#6B8499', borde: '#5A7188', texto: '#ffffff' }, // Nivel 1 - rea (azul gris mate)
      { fondo: '#7D8A97', borde: '#6A7784', texto: '#ffffff' }, // Nivel 2 - Sub-rea (gris azulado mate)
      { fondo: '#8897A8', borde: '#7586a7', texto: '#ffffff' }, // Nivel 3 - Sistema (azul acero mate)
      { fondo: '#939FAB', borde: '#808C98', texto: '#ffffff' }, // Nivel 4 - Sub-sistema (gris perla mate)
      { fondo: '#A1B0BC', borde: '#8E9DA9', texto: '#ffffff' }, // Nivel 5 - Seccin (azul claro mate)
      { fondo: '#7FA396', borde: '#6C9083', texto: '#ffffff' }, // Nivel 6 - Repuesto (verde gris mate)
      { fondo: '#6D9488', borde: '#5A8175', texto: '#ffffff' }  // Nivel 7 - Detalle (verde azulado mate)
    ];
    
    // Dibujar nodos SIN INTERACTIVIDAD (solo visualizacin)
    nodosConPosicion.forEach(nodo => {
      const tieneUbicaciones = nodo.ubicaciones && nodo.ubicaciones.length > 0;
      const colores = coloresPorNivel[nodo.nivel] || coloresPorNivel[coloresPorNivel.length - 1];
      
      // Grupo del nodo (sin eventos)
      svg += `<g>`;
      
      // Fondo del nodo
      if (tieneUbicaciones) {
        // Nodo final con ubicacin - Verde corporativo destacado
        svg += `<rect x="${nodo.x}" y="${nodo.y}" width="${anchoNodo}" height="${altoNodo}" rx="8" 
                  fill="#6D9488" 
                  stroke="#5A8175" 
                  stroke-width="2.5"
                  filter="url(#sombra)"/>`;
      } else {
        // Nodo normal con colores corporativos
        svg += `<rect x="${nodo.x}" y="${nodo.y}" width="${anchoNodo}" height="${altoNodo}" rx="8" 
                  fill="${colores.fondo}" 
                  stroke="${colores.borde}" 
                  stroke-width="2"
                  filter="url(#sombra)"/>`;
      }
      
      // Etiqueta del nivel
      if (nodo.etiqueta) {
        svg += `<text x="${nodo.x + anchoNodo/2}" y="${nodo.y + 15}" 
                  text-anchor="middle" 
                  fill="rgba(255,255,255,0.65)" 
                  font-size="9" 
                  font-weight="600"
                  letter-spacing="0.8"
                  pointer-events="none">${nodo.etiqueta.toUpperCase()}</text>`;
      }
      
      // Texto del nodo
      const lineas = this.dividirTextoEnLineas(nodo.valor, 32);
      const yInicial = nodo.y + (lineas.length === 1 ? altoNodo/2 + 6 : altoNodo/2 - 2);
      
      lineas.forEach((linea, idx) => {
        svg += `<text x="${nodo.x + anchoNodo/2}" y="${yInicial + (idx * 17)}" 
                  text-anchor="middle" 
                  dominant-baseline="middle" 
                  fill="#ffffff" 
                  font-size="13.5" 
                  font-weight="600"
                  pointer-events="none">${linea}</text>`;
      });
      
      // Badge de ubicacin
      if (tieneUbicaciones) {
        svg += `<text x="${nodo.x + anchoNodo/2}" y="${nodo.y + altoNodo - 10}" 
                  text-anchor="middle" 
                  fill="rgba(255,255,255,0.9)" 
                  font-size="8.5" 
                  font-weight="700"
                  letter-spacing="0.5"
                  pointer-events="none"> UBICACIN ${nodo.ubicaciones.join(', ')}</text>`;
      }
      
      svg += `</g>`;
    });
    
    svg += '</svg>';
    
    return `<div style="width: 100%; height: 100%; overflow: auto; display: flex; align-items: center; justify-content: center;">${svg}</div>`;
  }
  
  // Funcin auxiliar para dividir texto en lneas
  dividirTextoEnLineas(texto, maxCaracteres) {
    if (texto.length <= maxCaracteres) return [texto];
    
    const palabras = texto.split(' ');
    const lineas = [];
    let lineaActual = '';
    
    palabras.forEach(palabra => {
      if ((lineaActual + palabra).length <= maxCaracteres) {
        lineaActual += (lineaActual ? ' ' : '') + palabra;
      } else {
        if (lineaActual) lineas.push(lineaActual);
        lineaActual = palabra;
      }
    });
    
    if (lineaActual) lineas.push(lineaActual);
    return lineas.slice(0, 3); // Mximo 3 lneas
  }

  // Filtrar repuestos por nivel de jerarqua
  filtrarPorJerarquia(campo, valor) {
    console.log(` Filtrando por ${campo}: "${valor}"`);
    
    // Mapeo de campos del rbol a campos de ubicacin
    const mapaCampos = {
      'planta': 'planta',
      'areaGeneral': 'areaGeneral',
      'subArea': 'subArea',
      'sistemaEquipo': 'sistemaEquipo',
      'subSistema': 'subSistema',
      'seccion': 'seccion',
      'detalle': 'detalle'
    };
    
    const campoReal = mapaCampos[campo] || campo;
    
    // Buscar repuestos que tengan este valor en cualquiera de sus ubicaciones
    const repuestosFiltrados = this.repuestos.filter(repuesto => {
      if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones)) {
        return repuesto.ubicaciones.some(ub => ub[campoReal] === valor);
      } else {
        // Formato antiguo
        return repuesto[campoReal] === valor;
      }
    });
    
    console.log(` Encontrados ${repuestosFiltrados.length} repuestos`);
    
    // Mostrar resultados en modal ampliado
    this.mostrarResultadosFiltro(campo, valor, repuestosFiltrados);
  }

  // Mostrar resultados del filtro en modal ampliado
  mostrarResultadosFiltro(campo, valor, repuestos) {
    const nombreCampo = {
      'planta': 'Empresa',
      'areaGeneral': 'rea General',
      'subArea': 'Sub-rea',
      'sistemaEquipo': 'Sistema/Equipo',
      'subSistema': 'Sub-Sistema',
      'seccion': 'Seccin',
      'detalle': 'Detalle'
    }[campo] || campo;
    
    let html = `
      <div style="padding: clamp(20px, 3vw, 32px); background: var(--card-bg); border-radius: 16px; width: 95vw; max-width: 1800px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 16px; flex-shrink: 0; flex-wrap: wrap; gap: 12px;">
          <div>
            <h3 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: clamp(1.1rem, 2vw, 1.4rem); font-weight: 600;">
              Repuestos en ${nombreCampo}
            </h3>
            <div style="font-size: clamp(0.8rem, 1.5vw, 0.9rem); color: var(--text-secondary); font-weight: 500;">
              "${valor}"
            </div>
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <div style="font-size: 0.75rem; color: var(--text-secondary); background: var(--bg-secondary); padding: 6px 14px; border-radius: 20px; font-weight: 600;">
              ${repuestos.length} Repuesto${repuestos.length !== 1 ? 's' : ''}
            </div>
            <button onclick="app.closeCustomModal()" style="background: var(--bg-secondary); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; color: var(--text-primary); font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='var(--bg-secondary)'">
              Cerrar
            </button>
          </div>
        </div>
        
        <div style="flex: 1; overflow-y: auto; padding-right: 8px;">
    `;
    
    if (repuestos.length === 0) {
      html += `
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
          <div style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></div>
          <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">No hay repuestos</div>
          <div style="font-size: 0.9rem;">No se encontraron repuestos en esta ubicacin</div>
        </div>
      `;
    } else {
      // Grid de repuestos (responsivo)
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(min(300px, 100%), 1fr)); gap: 16px;">';
      
      repuestos.forEach(repuesto => {
        // Obtener imagen principal (buscar formatos FileSystem primero)
        let imagenPrincipal = null;
        if (repuesto.multimedia && repuesto.multimedia.length > 0) {
          const imagenFS = repuesto.multimedia.find(m => m.isFileSystem && m.url);
          imagenPrincipal = imagenFS ? imagenFS.url : repuesto.multimedia[0].url;
        }
        
        html += `
          <div style="background: var(--bg-primary); border: 2px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; cursor: pointer; position: relative;" 
               onclick="app.openModal('edit', '${repuesto.id}')"
               onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            
            ${imagenPrincipal ? `
              <div style="height: 180px; background: var(--bg-secondary); position: relative; overflow: hidden; pointer-events: none;">
                <img src="${imagenPrincipal}" 
                     style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" 
                     onerror="this.parentElement.innerHTML='<div style=\\'height: 180px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 3rem; opacity: 0.3; pointer-events: none;\\'></div>'">
              </div>
            ` : `
              <div style="height: 180px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 3rem; opacity: 0.3; pointer-events: none;">
                
              </div>
            `}
            
            <div style="padding: 16px; pointer-events: none;">
              <div style="font-weight: 600; font-size: 1rem; color: var(--text-primary); margin-bottom: 8px; line-height: 1.3;">
                ${repuesto.nombre}
              </div>
              
              ${repuesto.codSAP ? `
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">
                  <span style="font-weight: 600;">SAP:</span> ${repuesto.codSAP}
                </div>
              ` : ''}
              
              <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                ${repuesto.tipo ? `<span style="font-size: 0.7rem; background: var(--bg-secondary); padding: 4px 8px; border-radius: 6px; color: var(--text-secondary); font-weight: 600;">${repuesto.tipo}</span>` : ''}
                <span style="font-size: 0.7rem; background: ${repuesto.cantidad > repuesto.minimo ? '#d1fae5' : '#fee2e2'}; color: ${repuesto.cantidad > repuesto.minimo ? '#065f46' : '#991b1b'}; padding: 4px 8px; border-radius: 6px; font-weight: 600;">Stock: ${repuesto.cantidad}</span>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
    }
    
    html += `
        </div>
      </div>
    `;
    
    this.showCustomModal(html);
  }
  
  construirNodosArbol(ubicaciones, planta, niveles, nombreRepuesto) {
    // Crear nodo raíz (empresa - nivel1)
    const raiz = {
      nivel: -1,
      campo: 'nivel1',
      valor: planta || 'Aquachile Antarfood',
      etiqueta: 'Empresa',
      hijos: [],
      ubicaciones: []
    };
    
    // ETIQUETAS PARA JERARQUÍA UNIFICADA
    const etiquetasNiveles = {
      'nivel2': 'Área',
      'nivel3': 'Sub-área',
      'nivel4': 'Sistema',
      'nivel5': 'Sub-sistema',
      'nivel6': 'Sección',
      'nombreRepuesto': 'Repuesto',
      'nivel7': 'Sub-sección',
      // COMPATIBILIDAD: Mantener etiquetas legacy por si acaso
      'areaGeneral': 'Área General',
      'subArea': 'Sub-área',
      'sistemaEquipo': 'Sistema/Equipo',
      'subSistema': 'Sub-Sistema',
      'seccion': 'Sección',
      'detalle': 'Detalle Ubicación'
    };
    
    // Procesar cada ubicación
    ubicaciones.forEach((ubicacion, index) => {
      let nodoActual = raiz;
      let ultimoNodoConValor = null;
      
      // Recorrer cada nivel de jerarquía unificada
      niveles.forEach((campo, nivelIdx) => {
        let valor;
        
        // Si es nombreRepuesto, usar el valor pasado como parámetro
        if (campo === 'nombreRepuesto') {
          valor = nombreRepuesto;
        } else {
          // Leer desde jerarquia.nivelX o directamente del campo (compatibilidad)
          valor = ubicacion.jerarquia?.[campo] || ubicacion[campo];
        }
        
        if (!valor || valor.trim() === '') return; // Saltar niveles vacíos
        
        // Buscar si ya existe un hijo con este valor
        let hijo = nodoActual.hijos.find(h => h.campo === campo && h.valor === valor);
        
        if (!hijo) {
          // Crear nuevo nodo
          hijo = {
            nivel: nivelIdx,
            campo: campo,
            valor: valor,
            etiqueta: etiquetasNiveles[campo] || campo,
            hijos: [],
            ubicaciones: []
          };
          nodoActual.hijos.push(hijo);
        }
        
        ultimoNodoConValor = hijo;
        nodoActual = hijo;
      });
      
      // Marcar la ubicacin en el ltimo nodo con valor
      if (ultimoNodoConValor) {
        ultimoNodoConValor.ubicaciones.push(index + 1);
      }
    });
    
    return [raiz];
  }

  showCustomModal(content) {
    let modal = document.getElementById('customModalOverlay');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'customModalOverlay';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
      `;
      modal.onclick = (e) => {
        if (e.target === modal) this.closeCustomModal();
      };
      document.body.appendChild(modal);
    }
    modal.innerHTML = `
      <div style="max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
        ${content}
      </div>
    `;
    modal.style.display = 'flex';
    
    // Agregar listener para ESC
    this.addEscapeListener();
  }

  closeCustomModal() {
    const modal = document.getElementById('customModalOverlay');
    if (modal) modal.style.display = 'none';
    this.removeEscapeListener();
  }

  addEscapeListener() {
    if (!this.escapeHandler) {
      this.escapeHandler = (e) => {
        if (e.key === 'Escape') {
          // Cerrar modal personalizado si est abierto
          const customModal = document.getElementById('customModalOverlay');
          if (customModal && customModal.style.display === 'flex') {
            this.closeCustomModal();
            return;
          }
          
          // Cerrar modal principal si est abierto
          const mainModal = document.getElementById('modal');
          if (mainModal && mainModal.classList.contains('active')) {
            this.closeModal();
            return;
          }
        }
      };
    }
    document.addEventListener('keydown', this.escapeHandler);
  }

  removeEscapeListener() {
    if (this.escapeHandler) {
      document.removeEventListener('keydown', this.escapeHandler);
    }
  }

  // ===============================================
  // SISTEMA DE ORGANIZACIN AUTOMTICA DE IMGENES
  // ===============================================

  /**
   * Normaliza un nombre para usarlo como nombre de carpeta
   * Elimina caracteres especiales, acentos y espacios
   */
  normalizarNombreCarpeta(texto) {
    if (!texto || texto.trim() === '') return '_SIN_NOMBRE';
    
    return texto
      .trim()
      .toUpperCase()
      // Reemplazar acentos
      .replace(/[]/gi, 'A')
      .replace(/[]/gi, 'E')
      .replace(/[]/gi, 'I')
      .replace(/[]/gi, 'O')
      .replace(/[]/gi, 'U')
      .replace(/[]/gi, 'N')
      // Solo alfanumricos, espacios, guiones y guiones bajos
      .replace(/[^A-Z0-9\s_-]/g, '')
      // Espacios a guiones bajos
      .replace(/\s+/g, '_')
      // Mltiples guiones bajos a uno solo
      .replace(/_+/g, '_')
      // Mximo 50 caracteres
      .substring(0, 50);
  }

  /**
   * Genera un nombre de archivo descriptivo automticamente
   * Formato: SAP_NOMBRE_TIMESTAMP_INDEX.webp
   */
  generarNombreArchivo(repuesto, imageIndex = 0) {
    // 1. Cdigo SAP (mx 20 caracteres)
    const codigoSAP = (repuesto.codSAP || 'SAP_PENDIENTE')
      .replace(/[^a-zA-Z0-9_-]/g, '')
      .substring(0, 20);
    
    // 2. Nombre del repuesto (mx 40 caracteres)
    const nombreNormalizado = repuesto.nombre
      .toUpperCase()
      .trim()
      .replace(/[]/gi, 'A')
      .replace(/[]/gi, 'E')
      .replace(/[]/gi, 'I')
      .replace(/[]/gi, 'O')
      .replace(/[]/gi, 'U')
      .replace(/[]/gi, 'N')
      .replace(/[^A-Z0-9\s]/g, '') // Solo letras, nmeros y espacios
      .replace(/\s+/g, '_')        // Espacios  guiones bajos
      .substring(0, 40);
    
    // 3. Timestamp nico
    const timestamp = Date.now();
    
    // 4. ndice (si hay mltiples imgenes)
    const suffix = imageIndex > 0 ? `_${imageIndex + 1}` : '';
    
    // Resultado: SAP_NOMBRE_TIMESTAMP_INDEX.webp
    return `${codigoSAP}_${nombreNormalizado}_${timestamp}${suffix}.webp`;
  }

  /**
   * Genera la ruta jerrquica segn la ubicacin del repuesto
   */
  generarRutaImagen(ubicacion) {
    const partes = ['imagenes']; // Siempre empieza con /imagenes/
    
    // Nivel 1: rea General (OBLIGATORIO)
    if (ubicacion.areaGeneral && ubicacion.areaGeneral.trim() !== '') {
      partes.push(this.normalizarNombreCarpeta(ubicacion.areaGeneral));
    } else {
      partes.push('_SIN_UBICACION');
    }
    
    // Nivel 2: Sistema/Equipo (OPCIONAL - solo si nivelJerarquiaImagenes >= 2)
    if (this.nivelJerarquiaImagenes >= 2 && ubicacion.sistemaEquipo && ubicacion.sistemaEquipo.trim() !== '') {
      partes.push(this.normalizarNombreCarpeta(ubicacion.sistemaEquipo));
    }
    
    // Nivel 3: Sub-Sistema (OPCIONAL - solo si nivelJerarquiaImagenes >= 3)
    if (this.nivelJerarquiaImagenes >= 3 && ubicacion.subSistema && ubicacion.subSistema.trim() !== '') {
      partes.push(this.normalizarNombreCarpeta(ubicacion.subSistema));
    }
    
    return './' + partes.join('/');
  }

  /**
   * Crea las carpetas jerrquicas automticamente si no existen
   */
  async crearCarpetasJerarquicas(ubicacion) {
    console.log(' Creando carpetas jerrquicas...', ubicacion);
    
    // VALIDACIN: Verificar que fsManager existe y est inicializado
    if (!this.fsManager) {
      console.error(' this.fsManager es undefined');
      throw new Error('FileSystemManager no est inicializado');
    }
    
    if (!this.fsManager.rootFolder) {
      console.error(' this.fsManager.rootFolder es undefined');
      console.error('   this.fsManager:', this.fsManager);
      throw new Error('Root folder no est disponible. Conectaste la carpeta?');
    }
    
    try {
      // Obtener carpeta base de imgenes
      let carpetaActual = await this.fsManager.rootFolder.getDirectoryHandle('imagenes', { create: true });
      
      // Nivel 1: rea General
      const areaGeneral = ubicacion.areaGeneral && ubicacion.areaGeneral.trim() !== '' 
        ? this.normalizarNombreCarpeta(ubicacion.areaGeneral)
        : '_SIN_UBICACION';
      
      carpetaActual = await carpetaActual.getDirectoryHandle(areaGeneral, { create: true });
      console.log(`   Carpeta creada/verificada: ${areaGeneral}`);
      
      // Nivel 2: Sistema/Equipo (opcional)
      if (this.nivelJerarquiaImagenes >= 2 && ubicacion.sistemaEquipo && ubicacion.sistemaEquipo.trim() !== '') {
        const sistema = this.normalizarNombreCarpeta(ubicacion.sistemaEquipo);
        carpetaActual = await carpetaActual.getDirectoryHandle(sistema, { create: true });
        console.log(`   Subcarpeta creada/verificada: ${sistema}`);
      }
      
      // Nivel 3: Sub-Sistema (opcional)
      if (this.nivelJerarquiaImagenes >= 3 && ubicacion.subSistema && ubicacion.subSistema.trim() !== '') {
        const subSistema = this.normalizarNombreCarpeta(ubicacion.subSistema);
        carpetaActual = await carpetaActual.getDirectoryHandle(subSistema, { create: true });
        console.log(`   Subcarpeta creada/verificada: ${subSistema}`);
      }
      
      return carpetaActual;
      
    } catch (error) {
      console.error(' Error creando carpetas:', error);
      // Si falla, devolver carpeta raz de imgenes
      return await this.fsManager.rootFolder.getDirectoryHandle('imagenes', { create: true });
    }
  }

  /**
   * Navega a una carpeta por su ruta completa
   */
  async navegarACarpeta(ruta) {
    const partes = ruta.replace('./', '').split('/');
    let carpeta = this.fsManager.rootFolder;
    
    for (const parte of partes) {
      carpeta = await carpeta.getDirectoryHandle(parte);
    }
    
    return carpeta;
  }

  /**
   * Limpia carpetas vacas (sin archivos)
   */
  async limpiarCarpetasVacias() {
    console.log(' Limpiando carpetas vacas...');
    
    try {
      const carpetaImagenes = await this.fsManager.rootFolder.getDirectoryHandle('imagenes');
      
      // Obtener todas las subcarpetas (reas)
      for await (const [nombre, handle] of carpetaImagenes.entries()) {
        if (handle.kind !== 'directory') continue;
        
        // Contar archivos en la carpeta
        let tieneArchivos = false;
        const carpeta = await carpetaImagenes.getDirectoryHandle(nombre);
        
        for await (const entry of carpeta.values()) {
          if (entry.kind === 'file') {
            tieneArchivos = true;
            break;
          }
        }
        
        // Si est vaca, eliminarla
        if (!tieneArchivos) {
          await carpetaImagenes.removeEntry(nombre, { recursive: true });
          console.log(`   Carpeta vaca eliminada: ${nombre}`);
        }
      }
      
      console.log(' Limpieza completada');
    } catch (error) {
      console.error(' Error limpiando carpetas:', error);
    }
  }

  /**
   * Mueve imgenes a nueva carpeta si cambi la ubicacin del repuesto
   */
  async moverImagenSiCambiaUbicacion(repuesto, ubicacionesAntiguas, ubicacionesNuevas) {
    if (!fsManager || !fsManager.isFileSystemMode) return;
    if (!ubicacionesAntiguas || !ubicacionesNuevas) return;
    if (ubicacionesAntiguas.length === 0 || ubicacionesNuevas.length === 0) return;
    
    console.log(' Verificando si hay que mover imgenes...');
    
    // Comparar primera ubicacin (la principal)
    const ubicacionAntigua = ubicacionesAntiguas[0];
    const ubicacionNueva = ubicacionesNuevas[0];
    
    // Verificar si cambi el rea general
    const areaAntiguaNorm = this.normalizarNombreCarpeta(ubicacionAntigua.areaGeneral || '');
    const areaNuevaNorm = this.normalizarNombreCarpeta(ubicacionNueva.areaGeneral || '');
    
    if (areaAntiguaNorm === areaNuevaNorm) {
      console.log('   rea no cambi, no es necesario mover imgenes');
      return; // No cambi, no hacer nada
    }
    
    console.log(`   rea cambi: ${areaAntiguaNorm}  ${areaNuevaNorm}`);
    
    // Mover cada imagen
    let imagenesMovidas = 0;
    for (const media of repuesto.multimedia || []) {
      if (media.type !== 'image' || !media.isFileSystem) continue;
      
      try {
        // 1. Obtener nombre del archivo de la URL
        const nombreArchivo = media.url.split('/').pop();
        
        // 2. Obtener archivo de ubicacin antigua
        const rutaAntigua = this.generarRutaImagen(ubicacionAntigua);
        const carpetaAntigua = await this.navegarACarpeta(rutaAntigua);
        const fileHandle = await carpetaAntigua.getFileHandle(nombreArchivo);
        const file = await fileHandle.getFile();
        
        // 3. Crear carpeta nueva (si no existe)
        const carpetaNueva = await this.crearCarpetasJerarquicas(ubicacionNueva);
        
        // 4. Copiar archivo a nueva ubicacin
        const result = await this.fsManager.saveImageJerarquica(file, nombreArchivo, carpetaNueva);
        
        if (result) {
          // 5. Actualizar ruta en objeto multimedia
          const rutaNueva = this.generarRutaImagen(ubicacionNueva);
          media.url = `${rutaNueva}/${nombreArchivo}`;
          
          // 6. (Opcional) Eliminar archivo antiguo
          if (this.eliminarImagenAntiguaAlMover) {
            await carpetaAntigua.removeEntry(nombreArchivo);
            console.log(`   Archivo antiguo eliminado: ${nombreArchivo}`);
          }
          
          imagenesMovidas++;
          console.log(`   Imagen movida: ${nombreArchivo}`);
        }
        
      } catch (error) {
        console.error(`   Error moviendo imagen:`, error);
        // Continuar con las dems imgenes
      }
    }
    
    if (imagenesMovidas > 0) {
      console.log(` Total de imgenes movidas: ${imagenesMovidas}`);
      this.showToast(` ${imagenesMovidas} imagen(es) movida(s) a nueva ubicacin`, 'success');
      
      // Limpiar carpetas vacas
      await this.limpiarCarpetasVacias();
    }
  }

  // ========================================================================
  //  MTODO CENTRALIZADO DE CONEXIN - PUNTO NICO DE ENTRADA
  // ========================================================================
  /**
   * Conecta la carpeta de trabajo y sincroniza TODOS los sistemas
   * Este es el NICO mtodo que debe usarse para conectar la carpeta
   * 
   * @param {boolean} isReconnect - true si es una reconexin automtica
   * @param {boolean} promptUser - true si debe mostrar el selector de carpeta
   * @returns {Promise<boolean>} - true si la conexin fue exitosa
   */
  async connectWorkspace(isReconnect = false, promptUser = false) {
    try {
      console.log(`\n${''.repeat(60)}`);
      console.log(` CONEXIN CENTRALIZADA ${isReconnect ? '(AUTO-RECONEXIN)' : '(MANUAL)'}`);
      console.log(`${''.repeat(60)}\n`);
      
      let connected = false;
      
      // PASO 1: Conectar FileSystemManager
      if (promptUser) {
        // Usuario selecciona carpeta manualmente
        connected = await fsManager.selectFolder();
      } else {
        // Intentar reconectar automticamente
        connected = await fsManager.restoreFromPreviousSession();
      }
      
      if (!connected) {
        console.log(' No se pudo conectar FileSystem');
        this.updateAllConnectionBadges(false);
        return false;
      }
      
      console.log(' FileSystem conectado:', fsManager.folderPath);
      
      // PASO 2: Inicializar MapStorage (si no est inicializado)
      if (typeof mapStorage !== 'undefined' && !mapStorage.initialized) {
        try {
          await mapStorage.init({ autoReconnect: false });
          console.log(' MapStorage inicializado');
        } catch (error) {
          console.warn(' Error inicializando MapStorage:', error);
        }
      }
      
      // PASO 3: Actualizar TODOS los badges de conexin
      this.updateAllConnectionBadges(true);
      
      // PASO 4: Cargar datos (solo si es primera conexin o si no hay datos)
      const needsDataLoad = !isReconnect || !this.repuestos || this.repuestos.length === 0;
      
      if (needsDataLoad) {
        console.log(' Cargando datos desde carpeta...');
        await this.loadData();
        await this.render();
        // Solo campana, no toast
        window.addNotificationToCampana(' Carpeta conectada y datos cargados', 'success');
      } else {
        console.log(' Reconexin - Datos preservados en memoria');
        // Solo campana, no toast
        window.addNotificationToCampana(' Carpeta reconectada - Datos preservados', 'success');
      }
      
      console.log(`\n${''.repeat(60)}`);
      console.log(' CONEXIN COMPLETADA');
      console.log(`    Carpeta: ${fsManager.folderPath}`);
      console.log(`    Repuestos: ${this.repuestos.length}`);
      console.log(`    MapStorage: ${mapStorage?.initialized ? 'Inicializado' : 'No inicializado'}`);
      console.log(`${''.repeat(60)}\n`);
      
      return true;
      
    } catch (error) {
      console.error(' Error en connectWorkspace:', error);
      this.updateAllConnectionBadges(false);
      this.showToast(' Error al conectar carpeta: ' + error.message, 'error');
      return false;
    }
  }

  /**
   * Actualiza TODOS los badges de conexin en la UI
   * @param {boolean} connected - Estado de conexin
   */
  updateAllConnectionBadges(connected) {
    const folderPath = connected ? (fsManager.folderPath || 'Conectada') : '';
    
    // 1. Badge del header principal (updateStatusIndicator de fsManager)
    if (typeof fsManager.updateStatusIndicator === 'function') {
      fsManager.updateStatusIndicator(connected, folderPath);
    }
    
    // 2. Badge de la pestaa Mapas (updateConnectionBadge de mapController)
    if (typeof mapController !== 'undefined' && mapController.updateConnectionBadge) {
      mapController.updateConnectionBadge();
      
      //  IMPORTANTE: Si MapStorage est inicializado, cargar datos del mdulo de mapas
      if (connected && mapStorage?.initialized) {
        setTimeout(() => {
          mapController.loadData({ force: true }).catch(err => {
            console.warn(' Error cargando datos de mapas:', err);
          });
        }, 300);
      }
    }
    
    // 3. Badge de la pestaa Configuracin (actualizarEstadoUI)
    // IMPORTANTE: setTimeout para asegurar que el HTML ya est renderizado
    if (typeof configuracion !== 'undefined' && configuracion.actualizarEstadoUI) {
      setTimeout(() => {
        configuracion.actualizarEstadoUI();
      }, 200); // Esperar 200ms para que renderStorageUI haya terminado
    }
    
    // 4. Cualquier otro badge que se agregue en el futuro
    // (centralizado aqu para fcil mantenimiento)
    
    console.log(` Badges actualizados: ${connected ? ' CONECTADO' : ' DESCONECTADO'}`);
  }

  // ============================================================================
  // HELPERS MULTIMEDIA - Sistema de eliminación diferida
  // ============================================================================

  /**
   * Resetear input file para permitir seleccionar archivos nuevamente
   * Llámalo después de agregar/eliminar imágenes
   */
  resetFileInput() {
    const imagenInput = document.getElementById('imagenFile');
    if (imagenInput) {
      imagenInput.value = '';
      console.log(' [RESET] Input de imagen reseteado');
    }
    
    const documentInput = document.getElementById('documentosFile');
    if (documentInput) {
      documentInput.value = '';
      console.log(' [RESET] Input de documentos reseteado');
    }
  }

  /**
   * Inicializar estado multimedia al abrir modal
   * Carga multimedia existente si es modo edición
   */
  initMultimediaState(repuestoId = null) {
    console.log(' [MULTIMEDIA] Inicializando estado...');
    
    this.currentMultimedia = [];
    this.currentDocuments = [];
    this.pendingDeletions = [];
    this.originalMultimedia = [];
    
    if (repuestoId) {
      const repuesto = this.repuestos.find(r => r.id === repuestoId);
      if (repuesto && repuesto.multimedia) {
        // Copiar profundo para evitar mutaciones
        this.currentMultimedia = JSON.parse(JSON.stringify(repuesto.multimedia));
        this.originalMultimedia = JSON.parse(JSON.stringify(repuesto.multimedia));
        console.log(` [MULTIMEDIA] Cargadas ${this.currentMultimedia.length} imágenes existentes`);
      }
    }
    
    this.resetFileInput();
  }

  /**
   * Limpiar estado multimedia al cerrar modal
   */
  resetMultimediaState() {
    console.log(' [MULTIMEDIA] Limpiando estado...');
    
    this.currentMultimedia = [];
    this.currentDocuments = [];
    this.pendingDeletions = [];
    this.originalMultimedia = [];
    
    this.resetFileInput();
  }

  // ============================================================================

  async init() {
    this.showBrowserWarning();
    
    //  Limpiar backups obsoletos del sistema antiguo
    try {
      localStorage.removeItem('inventario_backups_marcadores');
      console.log(' Limpieza: Backups antiguos de marcadores eliminados');
    } catch (e) {
      // Silenciar error
    }
    
    // Renderizar UI de almacenamiento segn plataforma (PC o mvil)
    if (typeof configuracion !== 'undefined') {
      setTimeout(() => {
        configuracion.renderStorageUI();
        configuracion.loadICloudPathConfig(); // Cargar ruta iCloud guardada
      }, 100);
    }
    
    await this.loadData();
    this.setupEvents();
    this.setupDelegatedEvents(); // Event delegation para botones con data-attributes
    this.setupPhotoInputs(); // NUEVO: Configurar inputs de foto segn plataforma
    this.applyViewModeStyles(); // Aplicar modo de visualizacin guardado
    this.updateViewModeInfo(); // Actualizar info del modo
    await this.render();
    this.renderFilters();
    
    // Cargar datos de autocompletado guardados o generar desde repuestos
    const savedAutocomplete = localStorage.getItem('autocompleteData');
    if (savedAutocomplete) {
      try {
        this.autocompleteData = JSON.parse(savedAutocomplete);
      } catch (e) {
        console.warn('Error cargando autocomplete guardado, regenerando...', e);
        this.updateAutocompleteData();
      }
    } else {
      this.updateAutocompleteData();
    }
    
    this.setupAutocomplete();
    
    //  CARGAR JERARQUA desde localStorage
    const savedJerarquia = localStorage.getItem('jerarquiaLevels');
    if (savedJerarquia) {
      try {
        this.jerarquiaData = JSON.parse(savedJerarquia);
        console.log(' Jerarqua cargada:', this.jerarquiaData);
      } catch (e) {
        console.warn('Error cargando jerarqua, inicializando vaca...', e);
        this.jerarquiaData = {
          nivel1: [], nivel2: [], nivel3: [], nivel4: [],
          nivel5: [], nivel6: [], nivel7: [], nivel8: []
        };
      }
    } else {
      // Inicializar estructura vaca con datos de ejemplo
      this.jerarquiaData = {
        nivel1: [
          { id: '1', name: 'Planta Principal', description: 'Sede central', timestamp: Date.now() }
        ],
        nivel2: [
          { id: '2', name: 'Produccin', description: '', timestamp: Date.now() },
          { id: '3', name: 'Mantenimiento', description: '', timestamp: Date.now() }
        ],
        nivel3: [
          { id: '4', name: 'Lnea 1', description: '', timestamp: Date.now() },
          { id: '5', name: 'Lnea 2', description: '', timestamp: Date.now() }
        ],
        nivel4: [
          { id: '6', name: 'Mquina A', description: '', timestamp: Date.now() },
          { id: '7', name: 'Mquina B', description: '', timestamp: Date.now() }
        ],
        nivel5: [],
        nivel6: [],
        nivel7: [],
        nivel8: []
      };
      // Guardar datos de ejemplo
      localStorage.setItem('jerarquiaLevels', JSON.stringify(this.jerarquiaData));
      console.log(' Jerarqua inicializada con datos de ejemplo');
    }
    
    // Setup listener para cambio de equipo (cargar sistemas)
    const equipoInput = document.getElementById('equipo');
    if (equipoInput) {
      equipoInput.addEventListener('blur', () => {
        const equipo = equipoInput.value.trim();
        if (equipo) {
          this.cargarSistemasPorEquipo(equipo);
        }
      });
    }
    
    // Log de plataforma y optimizaciones
    console.log(`\n${'='.repeat(60)}`);
    console.log(` PLATAFORMA: ${this.isMobile ? 'MVIL' : 'PC'}`);
    console.log(` ALMACENAMIENTO: ${this.storageMode.toUpperCase()}`);
    console.log(` File System API: ${this.hasFileSystemAPI ? ' Disponible' : ' No disponible'}`);
    
    if (this.isEdge) {
      if (this.isEdgeIOS) {
        console.log(` NAVEGADOR: Microsoft Edge iOS (Modo Mvil)`);
        console.log(' Caractersticas activas:');
        console.log('   IndexedDB para imgenes (~50-100MB)');
        console.log('   Captura de cmara directa');
        console.log('   Seleccin de galera/iCloud Photos');
        console.log('   Sincronizacin va JSON');
        console.log('   WebKit (limitado por Apple, no Chromium)');
      } else {
        console.log(` NAVEGADOR: Microsoft Edge (Optimizado)`);
        console.log(' Optimizaciones activadas:');
        console.log('   CSS Grid avanzado');
        console.log('   Backdrop filters');
        console.log('   Container queries');
        console.log('   Scroll snap');
        if (this.hasFileSystemAPI) {
          console.log('   File System Access API completa');
        }
      }
    } else {
      console.log(` NAVEGADOR: ${this.getBrowserName()} (No optimizado)`);
    }
    console.log(`${'='.repeat(60)}\n`);
    
    //  Inicializar sistema de notificaciones (al final para asegurar DOM cargado)
    setTimeout(() => {
      this.initNotificationSystem();
    }, 100);
  }

  // NUEVO: Configurar inputs de fotos segn plataforma (mvil o PC)
  setupPhotoInputs() {
    const mobileButtons = document.getElementById('mobile-photo-buttons');
    const galleryInput = document.getElementById('galleryInput');
    const oldInput = document.getElementById('imagenFile');
    const multimediaSection = document.querySelector('.multimedia-section');
    
    // MVIL SIN FILESYSTEM: Ocultar toda la seccin de multimedia
    if (this.isMobile && !this.hasFileSystemAPI) {
      console.log(' Modo Mvil Simplificado - Multimedia DESACTIVADA');
      
      // Ocultar toda la seccin de multimedia
      if (multimediaSection) {
        multimediaSection.style.display = 'none';
      }
      
      // Crear mensaje informativo
      const multimediaParent = multimediaSection ? multimediaSection.parentElement : null;
      if (multimediaParent) {
        const existingMessage = document.getElementById('mobile-no-photos-message');
        if (!existingMessage) {
          const messageDiv = document.createElement('div');
          messageDiv.id = 'mobile-no-photos-message';
          messageDiv.style.cssText = `
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1));
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid var(--info);
            margin: 16px 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
          `;
          messageDiv.innerHTML = `
            <strong style="color: var(--info); display: block; margin-bottom: 6px;"> Modo Mvil Simplificado</strong>
            Las fotos no estn disponibles en dispositivos mviles.<br>
            <strong>Funciones activas:</strong> Ver, Agregar, Editar, Eliminar, Conteo.
            <br><br>
             <strong>Para fotos:</strong> Usa la versin de PC con todas las funcionalidades.
          `;
          multimediaSection.parentNode.insertBefore(messageDiv, multimediaSection);
        }
      }
      
      return; // Salir - no configurar inputs de fotos
    }
    
    // MVIL CON FILESYSTEM (no debera pasar, pero por si acaso)
    if (this.isMobile && this.hasFileSystemAPI) {
      // MVIL: Mostrar botones cmara + galera
      if (mobileButtons) {
        mobileButtons.style.display = 'flex';
      }
      if (galleryInput) {
        galleryInput.style.display = 'none'; // Ocultar input directo
      }
      if (oldInput) {
        oldInput.style.display = 'none';
      }
      if (multimediaSection) {
        multimediaSection.style.display = 'block';
      }
      console.log(' Inputs de foto configurados para MVIL (Cmara + Galera)');
    } 
    // PC: Mostrar todo normalmente
    else {
      // PC: Mostrar solo input de galera (sin botones)
      if (mobileButtons) {
        mobileButtons.style.display = 'none';
      }
      if (galleryInput) {
        galleryInput.style.display = 'block'; // Mostrar input directo
      }
      if (oldInput) {
        oldInput.style.display = 'none';
      }
      if (multimediaSection) {
        multimediaSection.style.display = 'block';
      }
      console.log(' Inputs de foto configurados para PC (Galera)');
    }
  }

  // Event delegation para manejar todos los clicks en botones con data-action
  setupDelegatedEvents() {
    // Evitar registrar múltiples veces
    if (this._delegatedEventsSetup) return;
    this._delegatedEventsSetup = true;
    
    // Clicks en botones
    document.addEventListener('click', (e) => {
      const target = e.target.closest('[data-action]');
      if (!target) return;
      
      const action = target.dataset.action;
      const id = target.dataset.id;
      
      if (action === 'edit') {
        this.openModal('edit', id);
      } else if (action === 'delete') {
        if (confirm('Eliminar este repuesto?')) {
          this.deleteRepuesto(id);
        }
      } else if (action === 'lightbox') {
        console.log(' Abriendo lightbox para ID:', id);
        this.openLightbox(id);
      } else if (action === 'contar') {
        this.abrirModalConteoIndividual(id);
      } else if (action === 'goto-card') {
        this.irATarjeta(id);
      } else if (action === 'verMapa') {
        //  ETAPA 5: Ver repuesto en mapa
        this.verRepuestoEnMapa(id);
      }
    });

    // Change events en inputs (conteo)
    document.addEventListener('change', (e) => {
      const target = e.target;
      if (!target.dataset || !target.dataset.action) return;
      
      const action = target.dataset.action;
      const id = target.dataset.id;
      
      if (action === 'update-conteo') {
        this.updateConteo(id, target.value);
      }
    });

    // Listener para teclado - controles del lightbox
    document.addEventListener('keydown', (e) => {
      const lightbox = document.getElementById('lightbox');
      const isLightboxActive = lightbox && lightbox.classList.contains('active');
      
      if (!isLightboxActive) return;
      
      // ESC - Cerrar lightbox
      if (e.key === 'Escape' || e.key === 'Esc') {
        console.log(' ESC presionado - cerrando lightbox');
        this.closeLightbox();
        return;
      }
      
      // Flecha IZQUIERDA - Imagen anterior
      if (e.key === 'ArrowLeft' || e.key === 'Left') {
        console.log('  Flecha izquierda - imagen anterior');
        e.preventDefault(); // Evitar scroll de pgina
        this.lightboxPrev();
        return;
      }
      
      // Flecha DERECHA - Imagen siguiente
      if (e.key === 'ArrowRight' || e.key === 'Right') {
        console.log('  Flecha derecha - imagen siguiente');
        e.preventDefault(); // Evitar scroll de pgina
        this.lightboxNext();
        return;
      }
    });
  }

  // ===============================================
  //  WIZARD DE PASOS (LAYOUT 8)
  // ===============================================
  initWizard(options = {}) {
    const { initialStep = 1, focusFirstField = false } = options;

    const timeline = document.getElementById('wizardTimeline');
    const stepsContainer = document.querySelector('.wizard-step-container');

    if (!timeline || !stepsContainer) {
      console.warn(' Wizard UI no disponible an.');
      return;
    }

    const steps = Array.from(stepsContainer.querySelectorAll('.wizard-step'));
    const indicators = Array.from(timeline.querySelectorAll('.wizard-step-indicator'));

    this.wizardState.steps = steps;
    this.wizardState.indicators = indicators;
    this.wizardState.timeline = timeline;
    this.wizardState.container = stepsContainer;
    this.wizardState.totalSteps = steps.length;
    this.wizardState.currentStep = Math.min(initialStep, steps.length || initialStep);
    this.wizardState.maxCompletedStep = this.wizardState.currentStep;
    this.wizardState.stepsVisited = new Set([this.wizardState.currentStep]);
    this.wizardState.pendingInvalidField = null;
  this.wizardState.lastValidationError = null;

    this.wizardState.nextBtn = document.querySelector('.btn-next-step');
    this.wizardState.prevBtn = document.querySelector('.btn-prev-step');
    this.wizardState.saveBtn = document.getElementById('btnGuardarRepuesto');

    if (this.wizardState.nextBtn) {
      this.wizardState.nextBtn.removeEventListener('click', this.handleWizardNext);
      this.wizardState.nextBtn.addEventListener('click', this.handleWizardNext);
    }

    if (this.wizardState.prevBtn) {
      this.wizardState.prevBtn.removeEventListener('click', this.handleWizardPrev);
      this.wizardState.prevBtn.addEventListener('click', this.handleWizardPrev);
    }

    // Event listeners para botones Guardar en cada step
    const saveStep1 = document.getElementById('saveRepuestoStep1');
    const saveStep2 = document.getElementById('saveRepuestoStep2');
    const saveStep3 = document.getElementById('saveRepuestoStep3');
    const saveStep4 = document.getElementById('saveRepuestoStep4');
    
    if (saveStep1) {
      saveStep1.addEventListener('click', () => this.saveRepuesto(null, true));
    }
    if (saveStep2) {
      saveStep2.addEventListener('click', () => this.saveRepuesto(null, true));
    }
    if (saveStep3) {
      saveStep3.addEventListener('click', () => this.saveRepuesto(null, true));
    }
    if (saveStep4) {
      saveStep4.addEventListener('click', () => this.saveRepuesto(null, true));
    }

    indicators.forEach((indicator) => {
      indicator.removeEventListener('click', this.handleWizardIndicatorClick);
      indicator.addEventListener('click', this.handleWizardIndicatorClick);
      indicator.classList.remove('is-error');
    });

    steps.forEach(step => step.classList.remove('wizard-step--invalid'));

    this.updateWizardUI();

    if (focusFirstField) {
      this.focusWizardField(this.wizardState.currentStep);
    }

    setTimeout(() => this.ajustarAnchoModal(), 120);
  }

  updateWizardUI() {
    if (!this.wizardState.steps || this.wizardState.steps.length === 0) return;

    const {
      steps,
      indicators,
      currentStep,
      totalSteps,
      nextBtn,
      prevBtn,
      saveBtn
    } = this.wizardState;

    // Mostrar/ocultar pasos
    steps.forEach(stepEl => {
      const stepNumber = Number(stepEl.dataset.step);
      const isActive = stepNumber === currentStep;
      stepEl.classList.toggle('wizard-step--active', isActive);
    });

    //  INDICADORES SIEMPRE HABILITADOS: Todos los pasos son accesibles
    indicators.forEach(indicator => {
      const stepNumber = Number(indicator.dataset.step);
      const isActive = stepNumber === currentStep;

      indicator.classList.toggle('is-active', isActive);
      indicator.classList.toggle('is-completed', stepNumber < currentStep);
      indicator.disabled = false; //  Siempre habilitado
      indicator.classList.remove('is-disabled'); //  Sin estilo disabled
      indicator.setAttribute('aria-current', isActive ? 'step' : 'false');
      indicator.setAttribute('aria-disabled', 'false'); //  Siempre accesible
    });

    if (prevBtn) {
      const isFirstStep = currentStep === 1;
      prevBtn.disabled = isFirstStep;
      prevBtn.setAttribute('aria-disabled', isFirstStep ? 'true' : 'false');
      const prevText = prevBtn.querySelector('.btn-text');
      if (prevText) {
        prevText.textContent = this.getWizardPrevLabel(currentStep);
      }
    }

    if (nextBtn) {
      const isLastStep = currentStep >= totalSteps;
      nextBtn.classList.toggle('is-hidden', isLastStep);
      nextBtn.disabled = isLastStep;
      nextBtn.setAttribute('aria-hidden', isLastStep ? 'true' : 'false');
      nextBtn.setAttribute('aria-disabled', isLastStep ? 'true' : 'false');
      nextBtn.dataset.stepTarget = Math.min(currentStep + 1, totalSteps);
      const nextText = nextBtn.querySelector('.btn-text');
      if (nextText) {
        nextText.textContent = this.getWizardNextLabel(currentStep);
      }
    }

    if (saveBtn) {
      const isFinal = currentStep >= totalSteps;
      saveBtn.classList.toggle('is-visible', isFinal);
      saveBtn.setAttribute('aria-hidden', isFinal ? 'false' : 'true');
      saveBtn.tabIndex = isFinal ? 0 : -1;
    }
  }

  setWizardStep(step, options = {}) {
    if (!this.wizardState.steps || this.wizardState.steps.length === 0) return;

    const { focusFirstField = true } = options;
    const total = this.wizardState.totalSteps || this.wizardState.steps.length;

    if (step < 1 || step > total) return;

    this.wizardState.currentStep = step;

    if (!this.wizardState.stepsVisited) {
      this.wizardState.stepsVisited = new Set();
    }
    this.wizardState.stepsVisited.add(step);

    if (typeof this.wizardState.maxCompletedStep !== 'number') {
      this.wizardState.maxCompletedStep = step;
    } else {
      this.wizardState.maxCompletedStep = Math.max(this.wizardState.maxCompletedStep, step);
    }

    this.updateWizardUI();

    if (focusFirstField) {
      this.focusWizardField(step);
    }

    const pendingField = this.wizardState.pendingInvalidField;
    if (pendingField) {
      const parentStep = pendingField.closest('.wizard-step');
      if (parentStep && Number(parentStep.dataset.step) === Number(step)) {
        const field = pendingField;
        setTimeout(() => {
          if (typeof field.reportValidity === 'function') {
            field.reportValidity();
          }
          if (typeof field.focus === 'function') {
            field.focus();
          }
          this.wizardState.pendingInvalidField = null;
        }, 140);
      } else if (!parentStep) {
        this.wizardState.pendingInvalidField = null;
      }
    }

    setTimeout(() => this.ajustarAnchoModal(), 140);
  }

  focusWizardField(step) {
    if (!this.wizardState.steps || this.wizardState.steps.length === 0) return;

    const stepEl = this.wizardState.steps.find(item => Number(item.dataset.step) === Number(step));
    if (!stepEl) return;

    const primarySelector = 'input:not([type="hidden"]):not([disabled]):not([readonly]), select:not([disabled]), textarea:not([disabled])';
    let focusable = stepEl.querySelector(primarySelector);

    if (!focusable) {
      focusable = stepEl.querySelector('button:not([disabled])');
    }

    if (!focusable) return;

    setTimeout(() => {
      if (typeof focusable.focus === 'function') {
        focusable.focus();
      }
    }, 160);
  }

  getWizardStepName(stepNumber) {
    if (!stepNumber || !this.wizardState.indicators) return `Paso ${stepNumber}`;

    const indicator = this.wizardState.indicators.find(item => Number(item.dataset.step) === Number(stepNumber));
    if (indicator) {
      const label = indicator.querySelector('.wizard-step-label');
      if (label) {
        return label.textContent.trim();
      }
    }

    const fallback = {
      1: 'Identificacin',
      2: 'Stock y polticas',
      3: 'Ubicaciones',
      4: 'Multimedia'
    };

    return fallback[stepNumber] || `Paso ${stepNumber}`;
  }

  getWizardNextLabel(step) {
    const nextName = this.getWizardStepName(step + 1);
    if (!nextName || nextName.startsWith('Paso')) {
      return 'Siguiente paso';
    }
    return `Ir a ${nextName.toLowerCase()}`;
  }

  getWizardPrevLabel(step) {
    if (step <= 1) {
      return ' Anterior';
    }

    const prevName = this.getWizardStepName(step - 1);
    return ` ${prevName}`;
  }

  validateWizardStep(stepNumber, options = {}) {
    if (!this.wizardState.steps || this.wizardState.steps.length === 0) return true;

    const { reportValidity = true } = options;

    const stepEl = this.wizardState.steps.find(item => Number(item.dataset.step) === Number(stepNumber));
    if (!stepEl) return true;

    const indicator = this.wizardState.indicators?.find(item => Number(item.dataset.step) === Number(stepNumber));

    stepEl.classList.remove('wizard-step--invalid');
    indicator?.classList.remove('is-error');
    this.wizardState.lastValidationError = null;

    const fields = stepEl.querySelectorAll('input, select, textarea');
    for (const field of fields) {
      if (field.disabled) continue;

      if (!field.checkValidity()) {
        stepEl.classList.add('wizard-step--invalid');
        indicator?.classList.add('is-error');

        this.wizardState.lastValidationError = {
          step: Number(stepNumber),
          type: 'field-invalid',
          fieldName: field.name || field.id || field.dataset?.field || null
        };

        const isCurrent = this.wizardState.currentStep === Number(stepNumber);

        if (reportValidity && isCurrent && typeof field.reportValidity === 'function') {
          field.reportValidity();
          if (typeof field.focus === 'function') {
            field.focus();
          }
        } else {
          this.wizardState.pendingInvalidField = field;
        }

        return false;
      }
    }

    if (Number(stepNumber) === 3) {
      this.sincronizarUbicacionesDesdeDOM();
      const ubicacionesValidas = (this.ubicacionesActuales || []).filter(ub => ub.areaGeneral && ub.areaGeneral.trim() !== '');
      if (ubicacionesValidas.length === 0) {
        stepEl.classList.add('wizard-step--invalid');
        indicator?.classList.add('is-error');

         this.wizardState.lastValidationError = {
           step: Number(stepNumber),
           type: 'ubicaciones-vacias'
         };

        const areaField = stepEl.querySelector('[data-field="areaGeneral"]');
        if (areaField) {
          this.wizardState.pendingInvalidField = areaField;
        }

        return false;
      }
    }

    if (this.wizardState.pendingInvalidField) {
      const parentStep = this.wizardState.pendingInvalidField.closest('.wizard-step');
      if (!parentStep || Number(parentStep.dataset.step) === Number(stepNumber)) {
        this.wizardState.pendingInvalidField = null;
      }
    }

    return true;
  }

  handleWizardNext(event) {
    if (event) event.preventDefault();

    if (!this.wizardState.totalSteps) return;

    const currentStep = this.wizardState.currentStep || 1;
    if (currentStep >= this.wizardState.totalSteps) return;

    //  NAVEGACIN LIBRE: Avanzar sin validacin
    this.setWizardStep(currentStep + 1);
  }

  handleWizardPrev(event) {
    if (event) event.preventDefault();

    const currentStep = this.wizardState.currentStep || 1;
    if (currentStep <= 1) return;

    this.setWizardStep(currentStep - 1);
  }

  handleWizardIndicatorClick(event) {
    event.preventDefault();

    const button = event.currentTarget;
    if (!button || button.disabled) return;

    const targetStep = Number(button.dataset.step);
    if (!targetStep || !this.wizardState.totalSteps) return;

    const currentStep = this.wizardState.currentStep || 1;
    if (targetStep === currentStep) return;

    //  NAVEGACIN LIBRE: Permitir ir a cualquier paso sin validacin
    this.setWizardStep(targetStep);
  }

  async cleanBase64ImagesFromLocalStorage() {
    // Limpiar imgenes base64 del localStorage cuando estamos en modo FileSystem
    if (!fsManager.isFileSystemMode) return;
    
    try {
      const localData = localStorage.getItem('inventarioData');
      if (!localData) return;
      
      const data = JSON.parse(localData);
      let limpiadas = 0;
      let tamaoAntes = new Blob([localData]).size;
      
      // Eliminar todas las imgenes base64
      data.forEach(item => {
        if (item.multimedia && item.multimedia.length > 0) {
          const multimediaLimpia = item.multimedia.filter(media => {
            const esBase64 = media.url && media.url.startsWith('data:image');
            if (esBase64) {
              limpiadas++;
              console.log(` Limpiando base64 de: ${item.nombre}`);
            }
            return !esBase64; // Mantener solo rutas de FileSystem
          });
          item.multimedia = multimediaLimpia;
        }
      });
      
      if (limpiadas > 0) {
        const datosLimpios = JSON.stringify(data);
        localStorage.setItem('inventarioData', datosLimpios);
        
        const tamaoDespues = new Blob([datosLimpios]).size;
        const liberado = ((tamaoAntes - tamaoDespues) / 1024).toFixed(2);
        
        console.log(` Limpiadas ${limpiadas} imgenes base64 del localStorage (${liberado} KB liberados)`);
      } else {
        console.log(' localStorage ya est limpio (no hay imgenes base64)');
      }
    } catch (error) {
      console.warn(' Error limpiando localStorage:', error);
    }
  }

  //  REPARAR imgenes rotas (rutas que ya no existen)
  async repararImagenesRotas() {
    if (!fsManager.isFileSystemMode || !fsManager.imagesFolder) {
      console.warn(' FileSystem no disponible para reparar imgenes');
      return;
    }

    try {
      console.log(' Iniciando reparacin de imgenes rotas...');
      
      // 1. Obtener TODAS las imgenes disponibles en la carpeta
      const imagenesDisponibles = [];
      for await (const entry of fsManager.imagesFolder.values()) {
        if (entry.kind === 'file') {
          const name = entry.name.toLowerCase();
          if (name.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
            imagenesDisponibles.push(entry.name);
          }
        }
      }
      
      console.log(` Disponibles: ${imagenesDisponibles.length} imgenes en carpeta`);
      
      let reparadas = 0;
      let eliminadas = 0;
      
      // SOLO VERIFICAR Y REPARAR REPUESTOS QUE YA TIENEN IMGENES
      for (const repuesto of this.repuestos) {
        if (!repuesto.multimedia || repuesto.multimedia.length === 0) {
          // No tiene imgenes, NO hacer nada (no vincular automticamente)
          continue;
        }
        
        // Tiene imgenes, verificar si existen
        const multimediaReparada = [];
        
        for (const media of repuesto.multimedia) {
          if (media.type !== 'image') {
            multimediaReparada.push(media); // Mantener documentos sin cambios
            continue;
          }
          
          // Extraer nombre de archivo de la URL
          let nombreArchivo = media.url;
          if (nombreArchivo.startsWith('./imagenes/')) {
            nombreArchivo = nombreArchivo.substring(11);
          } else if (nombreArchivo.startsWith('imagenes/')) {
            nombreArchivo = nombreArchivo.substring(9);
          }
          
          // Verificar si el archivo existe
          try {
            await fsManager.imagesFolder.getFileHandle(nombreArchivo);
            // Existe, mantener
            multimediaReparada.push(media);
          } catch (error) {
            // NO existe, buscar reemplazo
            console.log(`   Imagen rota: ${nombreArchivo}`);
            
            // Buscar imagen similar por nombre de repuesto
            const imagenReemplazo = await this.buscarImagenPorNombre(repuesto.nombre, imagenesDisponibles);
            
            if (imagenReemplazo) {
              const fileHandle = await fsManager.imagesFolder.getFileHandle(imagenReemplazo);
              const file = await fileHandle.getFile();
              
              multimediaReparada.push({
                type: 'image',
                url: `./imagenes/${imagenReemplazo}`,
                name: imagenReemplazo,
                size: file.size,
                isFileSystem: true
              });
              
              reparadas++;
              console.log(`   Reparada: ${nombreArchivo}  ${imagenReemplazo}`);
            } else {
              // NO se encontr reemplazo, eliminar referencia rota
              console.log(`   Eliminando referencia rota: ${nombreArchivo}`);
              eliminadas++;
            }
          }
        }
        
        repuesto.multimedia = multimediaReparada;
      }
      
      console.log(` Reparacin completada:`);
      console.log(`    Imgenes reparadas: ${reparadas}`);
      console.log(`    Referencias rotas eliminadas: ${eliminadas}`);
      
      // Guardar cambios si hubo modificaciones
      if (reparadas > 0 || eliminadas > 0) {
        await this.saveData();
        this.showToast(` ${reparadas} reparadas, ${eliminadas} referencias rotas eliminadas`, 'success');
        this.actualizarVistaActual();
      } else {
        this.showToast(' No se encontraron imgenes rotas', 'info');
      }
      
    } catch (error) {
      console.error(' Error reparando imgenes:', error);
      this.showToast(' Error al reparar imgenes', 'error');
    }
  }

  // Buscar imagen por nombre de repuesto (inteligente)
  async buscarImagenPorNombre(nombreRepuesto, imagenesDisponibles) {
    const nombreNorm = nombreRepuesto.toUpperCase().trim().replace(/\s+/g, '_');
    
    // Estrategia 1: Buscar por nombre exacto
    let encontrada = imagenesDisponibles.find(img => {
      const imgNorm = img.replace(/\.(jpg|jpeg|png|webp|gif)$/i, '').toUpperCase().replace(/\s+/g, '_');
      return imgNorm === nombreNorm;
    });
    
    if (encontrada) return encontrada;
    
    // Estrategia 2: Buscar que contenga el nombre del repuesto
    encontrada = imagenesDisponibles.find(img => {
      const imgNorm = img.toUpperCase();
      // Buscar palabras clave del nombre del repuesto
      const palabras = nombreNorm.split('_').filter(p => p.length > 3);
      return palabras.every(palabra => imgNorm.includes(palabra));
    });
    
    if (encontrada) return encontrada;
    
    // Estrategia 3: Buscar por timestamp ms reciente con coincidencia parcial
    const coincidenciasParciales = imagenesDisponibles.filter(img => {
      const imgNorm = img.toUpperCase();
      const palabras = nombreNorm.split('_').filter(p => p.length > 3);
      return palabras.some(palabra => imgNorm.includes(palabra));
    });
    
    if (coincidenciasParciales.length > 0) {
      // Ordenar por timestamp (ms reciente primero)
      coincidenciasParciales.sort((a, b) => {
        const timestampA = parseInt(a.match(/^(\d+)_/)?.[1] || '0');
        const timestampB = parseInt(b.match(/^(\d+)_/)?.[1] || '0');
        return timestampB - timestampA; // Ms reciente primero
      });
      
      return coincidenciasParciales[0];
    }
    
    return null;
  }

  // Vincular imgenes automticamente SIN confirmacin (versin silenciosa)
  async vincularImagenesSilencioso() {
    // Esta funcin ahora solo repara referencias rotas, NO vincula nuevas imgenes
    // Para vincular nuevas imgenes, usar el botn manual desde CONFIGURACIN
    try {
      await this.repararImagenesRotas();
    } catch (error) {
      console.error('Error en reparacin silenciosa:', error);
      // NO mostrar toast para no molestar al usuario
    }
  }

  async loadData() {
    // PRIORIDAD 1: Intentar cargar desde FileSystem si est activo
    if (fsManager.isFileSystemMode) {
      console.log(' Modo FileSystem activo, intentando cargar desde archivo...');
      try {
        const fileHandle = await fsManager.directoryHandle.getFileHandle('inventario.json');
        const file = await fileHandle.getFile();
        const content = await file.text();
        const rawData = JSON.parse(content);
        
        console.log(` Cargados ${rawData.length} repuestos desde FileSystem`);
        this.repuestos = rawData.map((item, index) => {
          if (!item.id || item.id === 'undefined' || item.id === 'null') {
            item.id = `repuesto-${Date.now()}-${index}`;
          } else {
            item.id = String(item.id);
          }
          if (!item.multimedia || !Array.isArray(item.multimedia)) {
            item.multimedia = [];
          }
          return item;
        });
        
        //  LIMPIEZA AUTOMTICA: Eliminar formato antiguo de ubicaciones si existe el nuevo
        this.limpiarFormatoAntiguoUbicaciones();
        
        //  DIAGNSTICO: Contar repuestos con/sin imgenes
        const conImagenes = this.repuestos.filter(r => r.multimedia && r.multimedia.length > 0).length;
        const sinImagenes = this.repuestos.length - conImagenes;
        console.log(` [DIAGNSTICO] Repuestos CON imgenes: ${conImagenes}`);
        console.log(` [DIAGNSTICO] Repuestos SIN imgenes: ${sinImagenes}`);
        
        //  VINCULACIN AUTOMTICA DESACTIVADA
        // Se ha desactivado la vinculacin automtica de imgenes al cargar
        // para evitar duplicaciones y errores. Usar el botn manual si es necesario.
        
        this.loadMapData();
        return; // Salir, ya cargamos desde FileSystem
      } catch (error) {
        console.warn(' No se pudo cargar desde FileSystem:', error.message);
        console.log('Intentando cargar desde localStorage como fallback...');
      }
    }
    
    // PRIORIDAD 2: MVIL SIN FILESYSTEM - Cargar desde datos embebidos
    if (this.isMobile && !this.hasFileSystemAPI) {
      console.log(' Modo Mvil detectado - Cargando desde datos embebidos...');
      
      // Verificar si hay datos embebidos
      if (typeof EMBEDDED_DATA !== 'undefined' && EMBEDDED_DATA.repuestos && EMBEDDED_DATA.repuestos.length > 0) {
        console.log(` Cargados ${EMBEDDED_DATA.repuestos.length} repuestos desde datos embebidos`);
        
        this.repuestos = EMBEDDED_DATA.repuestos.map((item, index) => {
          if (!item.id || item.id === 'undefined' || item.id === 'null') {
            item.id = `repuesto-${Date.now()}-${index}`;
          } else {
            item.id = String(item.id);
          }
          //  IMPORTANTE: Forzar multimedia vaco en mvil
          item.multimedia = [];
          return item;
        });
        
        //  LIMPIEZA AUTOMTICA: Eliminar formato antiguo de ubicaciones si existe el nuevo
        this.limpiarFormatoAntiguoUbicaciones();
        
        console.log(` Modo Mvil Simplificado: ${this.repuestos.length} repuestos sin multimedia`);
        console.log(` ltima actualizacin: ${EMBEDDED_DATA.lastUpdate || 'Desconocida'}`);
        
        // Guardar en localStorage para ediciones locales
        localStorage.setItem('inventarioData', JSON.stringify(this.repuestos));
        
        this.loadMapData();
        return; // Salir, ya cargamos desde datos embebidos
      } else {
        console.warn(' No hay datos embebidos, intentando localStorage...');
      }
    }
    
    // FALLBACK: Cargar desde localStorage
    const saved = localStorage.getItem('inventarioData');
    if (saved) {
      try {
        const rawData = JSON.parse(saved);
        console.log(`Cargando ${rawData.length} repuestos desde localStorage`);
        
        // NORMALIZAR IDs: Asegurar que todos los repuestos tengan IDs vlidos
        this.repuestos = rawData.map((item, index) => {
          // Si no tiene ID o es invlido, generar uno nuevo
          if (!item.id || item.id === 'undefined' || item.id === 'null') {
            item.id = `repuesto-${Date.now()}-${index}`;
            console.log(` ID generado para "${item.nombre}": ${item.id}`);
          } else {
            // Convertir ID a string para consistencia
            item.id = String(item.id);
          }
          
          // Asegurar que multimedia existe como array
          if (!item.multimedia || !Array.isArray(item.multimedia)) {
            item.multimedia = [];
          }
          
          return item;
        });
        
        console.log(` ${this.repuestos.length} repuestos cargados correctamente`);
        
        //  LIMPIEZA AUTOMTICA: Eliminar formato antiguo de ubicaciones si existe el nuevo
        this.limpiarFormatoAntiguoUbicaciones();
        
        // Verificar IDs nicos
        const idsSet = new Set(this.repuestos.map(r => r.id));
        if (idsSet.size !== this.repuestos.length) {
          console.warn(' Se detectaron IDs duplicados, regenerando...');
          this.repuestos = this.repuestos.map((r, i) => {
            r.id = `repuesto-${Date.now()}-${i}`;
            return r;
          });
          this.saveData(); // Guardar con IDs corregidos
        }
        
      } catch (e) {
        console.error(' Error al cargar datos:', e);
        this.loadDefaultData();
      }
    } else {
      console.log(' Sin datos guardados, iniciando vaco');
      this.loadDefaultData();
    }
    
    this.loadMapData();
  }

  loadMapData() {
    const savedMap = localStorage.getItem('mapData');
    if (savedMap) {
      try {
        this.mapObjects = JSON.parse(savedMap);
      } catch (e) {
        this.mapObjects = [];
      }
    }
    
    const savedMapImage = localStorage.getItem('mapImage');
    if (savedMapImage) {
      this.mapImage = savedMapImage;
    }
  }

  //  NUEVA FUNCIN: Limpiar formato antiguo de ubicaciones para evitar duplicados en mapas
  limpiarFormatoAntiguoUbicaciones() {
    let limpiados = 0;
    
    this.repuestos.forEach(repuesto => {
      // Si tiene ubicaciones[] Y tambin propiedades antiguas, eliminar las antiguas
      if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones) && repuesto.ubicaciones.length > 0) {
        if (repuesto.mapId || repuesto.markerX || repuesto.markerY || repuesto.areaId) {
          console.log(` Limpiando formato antiguo de "${repuesto.nombre}"`);
          delete repuesto.mapId;
          delete repuesto.areaId;
          delete repuesto.markerX;
          delete repuesto.markerY;
          delete repuesto.ubicacionDescripcion;
          limpiados++;
        }
      }
    });
    
    if (limpiados > 0) {
      console.log(` Limpiados ${limpiados} repuestos con formato antiguo duplicado`);
      // Guardar cambios automticamente
      this.saveData().catch(err => console.error('Error guardando limpieza:', err));
    }
  }

  loadDefaultData() {
    //  DATOS DE PRUEBA: 2 repuestos por cada nivel de jerarqua
    this.repuestos = [
      // 
      // NIVEL 1: Solo Planta (mnimo)
      // 
      {
        id: 1,
        nombre: 'Extintor Polvo Qumico ABC 10kg',
        codSAP: 'EXT-001',
        codProv: 'PROV-EXT-001',
        cantidad: 15,
        minimo: 10,
        optimo: 20,
        precio: 45000,
        planta: 'Aquachile Antarfood Chonchi',
        descripcion: 'Extintor tipo ABC para fuegos clase A, B y C',
        multimedia: [],
        ubicaciones: []
      },
      {
        id: 2,
        nombre: 'Botiqun Primeros Auxilios Completo',
        codSAP: 'BOT-001',
        codProv: 'PROV-BOT-001',
        cantidad: 8,
        minimo: 5,
        optimo: 12,
        precio: 35000,
        planta: 'Aquachile Antarfood Chonchi',
        descripcion: 'Botiqun con elementos bsicos de primeros auxilios',
        multimedia: [],
        ubicaciones: []
      },

      // 
      // NIVEL 2: Planta + rea General
      // 
      {
        id: 3,
        nombre: 'Vlvula Mariposa 6 Pulgadas',
        codSAP: 'VAL-MA-006',
        codProv: 'PROV-VAL-006',
        cantidad: 12,
        minimo: 8,
        optimo: 15,
        precio: 125000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        descripcion: 'Vlvula mariposa para control de flujo en tuberas principales',
        multimedia: [],
        ubicaciones: []
      },
      {
        id: 4,
        nombre: 'Sensor de Temperatura PT100',
        codSAP: 'SEN-TMP-100',
        codProv: 'PROV-SEN-100',
        cantidad: 20,
        minimo: 15,
        optimo: 25,
        precio: 28000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        descripcion: 'Sensor de temperatura tipo PT100 rango -50C a +200C',
        multimedia: [],
        ubicaciones: []
      },

      // 
      // NIVEL 3: Planta + rea General + Sub-rea
      // 
      {
        id: 5,
        nombre: 'Filtro de Cartucho 5 Micras',
        codSAP: 'FIL-CAR-005',
        codProv: 'PROV-FIL-005',
        cantidad: 30,
        minimo: 20,
        optimo: 40,
        precio: 15000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        descripcion: 'Cartucho de filtro de 5 micras para agua de proceso',
        multimedia: [],
        ubicaciones: []
      },
      {
        id: 6,
        nombre: 'Bomba Centrfuga 5HP',
        codSAP: 'BOM-CEN-5HP',
        codProv: 'PROV-BOM-5HP',
        cantidad: 4,
        minimo: 2,
        optimo: 6,
        precio: 450000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        descripcion: 'Bomba centrfuga 5HP para recirculacin de agua',
        multimedia: [],
        ubicaciones: []
      },

      // 
      // NIVEL 4: Planta + rea General + Sub-rea + Sistema/Equipo
      // 
      {
        id: 7,
        nombre: 'Rodamiento SKF 6205-2RS',
        codSAP: 'ROD-SKF-6205',
        codProv: 'SKF-6205-2RS',
        cantidad: 25,
        minimo: 15,
        optimo: 30,
        precio: 18500,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        descripcion: 'Rodamiento rgido de bolas con sellos de goma',
        multimedia: [],
        ubicaciones: []
      },
      {
        id: 8,
        nombre: 'Sello Mecnico 25mm',
        codSAP: 'SEL-MEC-025',
        codProv: 'PROV-SEL-025',
        cantidad: 8,
        minimo: 5,
        optimo: 12,
        precio: 65000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        descripcion: 'Sello mecnico para eje de 25mm en bombas',
        multimedia: [],
        ubicaciones: []
      },

      // 
      // NIVEL 5: Planta + rea General + Sub-rea + Sistema/Equipo + Sub-Sistema
      // 
      {
        id: 9,
        nombre: 'Impulsor de Bomba Acero Inox',
        codSAP: 'IMP-BOM-INOX',
        codProv: 'PROV-IMP-INOX',
        cantidad: 6,
        minimo: 3,
        optimo: 8,
        precio: 185000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        descripcion: 'Impulsor de acero inoxidable 316L para bomba centrfuga',
        multimedia: [],
        ubicaciones: []
      },
      {
        id: 10,
        nombre: 'Carcasa de Bomba Con Bridas',
        codSAP: 'CAR-BOM-BRID',
        codProv: 'PROV-CAR-BRID',
        cantidad: 3,
        minimo: 2,
        optimo: 5,
        precio: 320000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        descripcion: 'Carcasa de bomba centrfuga con bridas de conexin',
        multimedia: [],
        ubicaciones: []
      },

      // 
      // NIVEL 6: Planta + rea General + Sub-rea + Sistema/Equipo + Sub-Sistema + Seccin
      // 
      {
        id: 11,
        nombre: 'O-Ring Viton 25x3mm',
        codSAP: 'ORI-VIT-25X3',
        codProv: 'PROV-ORI-25X3',
        cantidad: 50,
        minimo: 30,
        optimo: 60,
        precio: 3500,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        seccion: 'Seccin de Sellado',
        descripcion: 'O-Ring de Viton para sellado de alta temperatura',
        multimedia: [],
        ubicaciones: []
      },
      {
        id: 12,
        nombre: 'Junta Tapa Bomba Tefln',
        codSAP: 'JUN-TAP-TEF',
        codProv: 'PROV-JUN-TEF',
        cantidad: 15,
        minimo: 10,
        optimo: 20,
        precio: 8500,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        seccion: 'Seccin de Sellado',
        descripcion: 'Junta de tefln para tapa de bomba centrfuga',
        multimedia: [],
        ubicaciones: []
      },

      // 
      // NIVEL 7: Todos los campos (Jerarqua Completa)
      // 
      {
        id: 13,
        nombre: 'Tornillo Allen M8x40 Inox A4',
        codSAP: 'TOR-ALL-M8X40',
        codProv: 'DIN912-M8X40-A4',
        cantidad: 100,
        minimo: 50,
        optimo: 150,
        precio: 450,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        seccion: 'Seccin de Sellado',
        detalle: 'Conjunto de Fijacin',
        descripcion: 'Tornillo allen cabeza cilndrica M8x40mm acero inox A4-70',
        multimedia: [],
        ubicaciones: []
      },
      {
        id: 14,
        nombre: 'Arandela Presin M8 Inox',
        codSAP: 'ARA-PRE-M8',
        codProv: 'DIN127-M8-INOX',
        cantidad: 150,
        minimo: 80,
        optimo: 200,
        precio: 150,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        seccion: 'Seccin de Sellado',
        detalle: 'Conjunto de Fijacin',
        descripcion: 'Arandela de presin (grower) M8 acero inoxidable',
        multimedia: [],
        ubicaciones: []
      }
    ];

    console.log(' Datos de prueba cargados: 14 repuestos con jerarqua completa');
    console.log(' Cobertura: 2 repuestos por cada nivel (1-7)');
  }

  //  Cargar datos de prueba para visualizar jerarqua en PDF
  async cargarDatosPrueba() {
    if (!confirm(' AGREGAR DATOS DE PRUEBA\n\nDeseas agregar 14 repuestos de prueba a tus datos existentes?\n\nTus ' + this.repuestos.length + ' repuestos actuales NO se borrarn.\n\nLos datos de prueba tendrn IDs desde 9000 en adelante para fcil identificacin.')) {
      return;
    }

    // Obtener el siguiente ID disponible (usar serie 9000 para identificar datos de prueba)
    const testIdBase = 9000;
    
    // Crear datos de prueba con IDs nicos
    const datosPrueba = [
      // 
      // NIVEL 1: Solo Planta (mnimo)
      // 
      {
        id: testIdBase + 1,
        nombre: ' Extintor Polvo Qumico ABC 10kg',
        codSAP: 'TEST-EXT-001',
        codProv: 'TEST-PROV-EXT-001',
        cantidad: 15,
        minimo: 10,
        optimo: 20,
        precio: 45000,
        planta: 'Aquachile Antarfood Chonchi',
        descripcion: ' TEST - Extintor tipo ABC para fuegos clase A, B y C',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/FF6B35/FFFFFF?text=Extintor+ABC',
          nombre: 'extintor_test.jpg'
        }],
        ubicaciones: []
      },
      {
        id: testIdBase + 2,
        nombre: ' Botiqun Primeros Auxilios Completo',
        codSAP: 'TEST-BOT-001',
        codProv: 'TEST-PROV-BOT-001',
        cantidad: 8,
        minimo: 5,
        optimo: 12,
        precio: 35000,
        planta: 'Aquachile Antarfood Chonchi',
        descripcion: ' TEST - Botiqun con elementos bsicos de primeros auxilios',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/4ECDC4/FFFFFF?text=Botiquin',
          nombre: 'botiquin_test.jpg'
        }],
        ubicaciones: []
      },

      // 
      // NIVEL 2: Planta + rea General
      // 
      {
        id: testIdBase + 3,
        nombre: ' Vlvula Mariposa 6 Pulgadas',
        codSAP: 'TEST-VAL-MA-006',
        codProv: 'TEST-PROV-VAL-006',
        cantidad: 12,
        minimo: 8,
        optimo: 15,
        precio: 125000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        descripcion: ' TEST - Vlvula mariposa para control de flujo',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/F7B731/FFFFFF?text=Valvula+Mariposa',
          nombre: 'valvula_test.jpg'
        }],
        ubicaciones: []
      },
      {
        id: testIdBase + 4,
        nombre: ' Sensor de Temperatura PT100',
        codSAP: 'TEST-SEN-TMP-100',
        codProv: 'TEST-PROV-SEN-100',
        cantidad: 20,
        minimo: 15,
        optimo: 25,
        precio: 28000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        descripcion: ' TEST - Sensor PT100 rango -50C a +200C',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/5F27CD/FFFFFF?text=Sensor+PT100',
          nombre: 'sensor_test.jpg'
        }],
        ubicaciones: []
      },

      // 
      // NIVEL 3: Planta + rea General + Sub-rea
      // 
      {
        id: testIdBase + 5,
        nombre: ' Filtro de Cartucho 5 Micras',
        codSAP: 'TEST-FIL-CAR-005',
        codProv: 'TEST-PROV-FIL-005',
        cantidad: 30,
        minimo: 20,
        optimo: 40,
        precio: 15000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        descripcion: ' TEST - Cartucho de filtro de 5 micras',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/00B894/FFFFFF?text=Filtro+5um',
          nombre: 'filtro_test.jpg'
        }],
        ubicaciones: []
      },
      {
        id: testIdBase + 6,
        nombre: ' Bomba Centrfuga 5HP',
        codSAP: 'TEST-BOM-CEN-5HP',
        codProv: 'TEST-PROV-BOM-5HP',
        cantidad: 4,
        minimo: 2,
        optimo: 6,
        precio: 450000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        descripcion: ' TEST - Bomba centrfuga 5HP',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/0984E3/FFFFFF?text=Bomba+5HP',
          nombre: 'bomba_test.jpg'
        }],
        ubicaciones: []
      },

      // 
      // NIVEL 4: Planta + rea General + Sub-rea + Sistema/Equipo
      // 
      {
        id: testIdBase + 7,
        nombre: ' Rodamiento SKF 6205-2RS',
        codSAP: 'TEST-ROD-SKF-6205',
        codProv: 'TEST-SKF-6205-2RS',
        cantidad: 25,
        minimo: 15,
        optimo: 30,
        precio: 18500,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        descripcion: ' TEST - Rodamiento rgido de bolas',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/6C5CE7/FFFFFF?text=Rodamiento+SKF',
          nombre: 'rodamiento_test.jpg'
        }],
        ubicaciones: []
      },
      {
        id: testIdBase + 8,
        nombre: ' Sello Mecnico 25mm',
        codSAP: 'TEST-SEL-MEC-025',
        codProv: 'TEST-PROV-SEL-025',
        cantidad: 8,
        minimo: 5,
        optimo: 12,
        precio: 65000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        descripcion: ' TEST - Sello mecnico para eje 25mm',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/FD79A8/FFFFFF?text=Sello+Mecanico',
          nombre: 'sello_test.jpg'
        }],
        ubicaciones: []
      },

      // 
      // NIVEL 5: Planta + rea General + Sub-rea + Sistema/Equipo + Sub-Sistema
      // 
      {
        id: testIdBase + 9,
        nombre: ' Impulsor de Bomba Acero Inox',
        codSAP: 'TEST-IMP-BOM-INOX',
        codProv: 'TEST-PROV-IMP-INOX',
        cantidad: 6,
        minimo: 3,
        optimo: 8,
        precio: 185000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        descripcion: ' TEST - Impulsor acero inoxidable 316L',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/A29BFE/FFFFFF?text=Impulsor+Inox',
          nombre: 'impulsor_test.jpg'
        }],
        ubicaciones: []
      },
      {
        id: testIdBase + 10,
        nombre: ' Carcasa de Bomba Con Bridas',
        codSAP: 'TEST-CAR-BOM-BRID',
        codProv: 'TEST-PROV-CAR-BRID',
        cantidad: 3,
        minimo: 2,
        optimo: 5,
        precio: 320000,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        descripcion: ' TEST - Carcasa con bridas de conexin',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/74B9FF/FFFFFF?text=Carcasa+Bomba',
          nombre: 'carcasa_test.jpg'
        }],
        ubicaciones: []
      },

      // 
      // NIVEL 6: Planta + rea General + Sub-rea + Sistema/Equipo + Sub-Sistema + Seccin
      // 
      {
        id: testIdBase + 11,
        nombre: ' O-Ring Viton 25x3mm',
        codSAP: 'TEST-ORI-VIT-25X3',
        codProv: 'TEST-PROV-ORI-25X3',
        cantidad: 50,
        minimo: 30,
        optimo: 60,
        precio: 3500,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        seccion: 'Seccin de Sellado',
        descripcion: ' TEST - O-Ring Viton alta temperatura',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/55EFC4/000000?text=O-Ring+Viton',
          nombre: 'oring_test.jpg'
        }],
        ubicaciones: []
      },
      {
        id: testIdBase + 12,
        nombre: ' Junta Tapa Bomba Tefln',
        codSAP: 'TEST-JUN-TAP-TEF',
        codProv: 'TEST-PROV-JUN-TEF',
        cantidad: 15,
        minimo: 10,
        optimo: 20,
        precio: 8500,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        seccion: 'Seccin de Sellado',
        descripcion: ' TEST - Junta de tefln para tapa',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/FFEAA7/000000?text=Junta+Teflon',
          nombre: 'junta_test.jpg'
        }],
        ubicaciones: []
      },

      // 
      // NIVEL 7: Todos los campos (Jerarqua Completa)
      // 
      {
        id: testIdBase + 13,
        nombre: ' Tornillo Allen M8x40 Inox A4',
        codSAP: 'TEST-TOR-ALL-M8X40',
        codProv: 'TEST-DIN912-M8X40-A4',
        cantidad: 100,
        minimo: 50,
        optimo: 150,
        precio: 450,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        seccion: 'Seccin de Sellado',
        detalle: 'Conjunto de Fijacin',
        descripcion: ' TEST - Tornillo allen M8x40mm inox A4-70',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/DFE6E9/000000?text=Tornillo+M8x40',
          nombre: 'tornillo_test.jpg'
        }],
        ubicaciones: []
      },
      {
        id: testIdBase + 14,
        nombre: ' Arandela Presin M8 Inox',
        codSAP: 'TEST-ARA-PRE-M8',
        codProv: 'TEST-DIN127-M8-INOX',
        cantidad: 150,
        minimo: 80,
        optimo: 200,
        precio: 150,
        planta: 'Aquachile Antarfood Chonchi',
        areaGeneral: 'rea de Produccin',
        subArea: 'Sistema de Agua',
        sistemaEquipo: 'Bomba Principal BP-01',
        subSistema: 'Sistema Hidrulico',
        seccion: 'Seccin de Sellado',
        detalle: 'Conjunto de Fijacin',
        descripcion: ' TEST - Arandela grower M8 inoxidable',
        multimedia: [{
          tipo: 'imagen',
          url: 'https://via.placeholder.com/400x300/B2BEC3/000000?text=Arandela+M8',
          nombre: 'arandela_test.jpg'
        }],
        ubicaciones: []
      }
    ];

    // Agregar datos de prueba a los existentes
    this.repuestos.push(...datosPrueba);
    
    // Guardar automticamente
    await this.saveData();
    
    // Renderizar
    this.renderRepuestos();
    
    // Mostrar confirmacin
    this.mostrarToast(' 14 repuestos de prueba agregados con xito\n\n Bscalos con el emoji  o con IDs 9001-9014\n Datos guardados automticamente', 'success', 6000);
    
    console.log(' Datos de prueba agregados. Total repuestos:', this.repuestos.length);
    console.log(' IDs de prueba: 9001-9014');
  }

  async saveData() {
    //  Mostrar indicador de guardado
    const toastId = this.showToast(' Guardando...', 'info', 10000);
    
    try {
      //  MVIL: Actualizar EMBEDDED_DATA automticamente
      if (this.isMobile && !this.hasFileSystemAPI && typeof EMBEDDED_DATA !== 'undefined') {
        console.log(' Actualizando EMBEDDED_DATA en memoria...');
        EMBEDDED_DATA.repuestos = this.repuestos.map(r => {
          const { multimedia, ...sinMultimedia } = r;
          return sinMultimedia;
        });
        EMBEDDED_DATA.lastUpdate = new Date().toISOString();
        console.log(' EMBEDDED_DATA actualizado:', EMBEDDED_DATA.repuestos.length, 'repuestos');
      }

      // MODO FILESYSTEM: Guardar en archivo
      if (fsManager.isFileSystemMode) {
        console.log('Guardando en FileSystem...');
        const success = await fsManager.saveJSON(this.repuestos);
        if (success !== false) {
          this.showToast('Guardado en carpeta (sin lmites)', 'success', 2000);
          console.log(' Datos guardados en FileSystem');
          
          //  MARCAR QUE HAY CAMBIOS PENDIENTES DE BACKUP (no crear backup inmediatamente)
          if (configuracion && configuracion.backupManager) {
            configuracion.backupManager.marcarCambiosPendientes();
          }
          
          return true;
        }
        // Si falla FileSystem, continuar con localStorage como fallback
        console.warn(' FileSystem fall, usando localStorage como fallback');
      }
      
      // MODO LOCALSTORAGE: Guardar en navegador
      const dataString = JSON.stringify(this.repuestos);
      const sizeInMB = (dataString.length / (1024 * 1024)).toFixed(2);
      
      console.log('Intentando guardar en localStorage:', sizeInMB, 'MB');
      
      // Verificar si excede lmite ANTES de intentar guardar
      if (sizeInMB > 9) {
        console.error(` Archivo demasiado grande: ${sizeInMB}MB (lmite: ~10MB)`);
        this.showToast(` DATOS NO GUARDADOS: ${sizeInMB}MB excede lmite de navegador (10MB)`, 'error', 8000);
        
        // Mostrar dilogo con opciones
        const opciones = confirm(
          ` PROBLEMA CRTICO\n\n` +
          ` Tamao: ${sizeInMB}MB\n` +
          ` Lmite navegador: ~10MB\n` +
          ` Repuestos: ${this.repuestos.length}\n\n` +
          ` TUS CAMBIOS SE PERDERN AL REFRESCAR\n\n` +
          `SOLUCIONES:\n` +
          `1. Activar " Modo Carpeta" (capacidad ilimitada)\n` +
          `2. Exportar JSON sin imgenes\n` +
          `3. Reducir cantidad de repuestos\n\n` +
          `Exportar AHORA los datos actuales (sin imgenes)?`
        );
        
        if (opciones) {
          this.exportJSONSinImagenes();
        }
        return false; // Indicar que NO se guard
      }
      
      localStorage.setItem('inventarioData', dataString);
      
      // Advertencias por tamao
      if (sizeInMB > 7) {
        this.showToast(` ADVERTENCIA: ${sizeInMB}MB/10MB - Activa " Modo Carpeta" para sin lmites`, 'warning', 6000);
      } else if (sizeInMB > 4) {
        this.showToast(`Guardado: ${sizeInMB}MB`, 'info', 3000);
      }
      
      console.log(' Datos guardados en localStorage');
      return true; // Indicar xito
    } catch (error) {
      if (error.name === 'QuotaExceededError') {
        const sizeInMB = (JSON.stringify(this.repuestos).length / (1024 * 1024)).toFixed(2);
        this.showToast(` LMITE EXCEDIDO (${sizeInMB}MB). Activa " Modo Carpeta"!`, 'error', 10000);
        console.error(' LocalStorage lleno. Tamao:', sizeInMB, 'MB');
      } else {
        this.showToast(' Error al guardar: ' + error.message, 'error');
        console.error('Error guardando:', error);
      }
      return false;
    }
  }

  //  NUEVO: Calcular tiempo transcurrido en formato legible
  calcularTiempoTranscurrido(timestamp) {
    const ahora = Date.now();
    const diferencia = ahora - timestamp;
    
    const segundos = Math.floor(diferencia / 1000);
    const minutos = Math.floor(segundos / 60);
    const horas = Math.floor(minutos / 60);
    const dias = Math.floor(horas / 24);
    
    if (dias > 0) return `${dias} da${dias === 1 ? '' : 's'}`;
    if (horas > 0) return `${horas} hora${horas === 1 ? '' : 's'}`;
    if (minutos > 0) return `${minutos} minuto${minutos === 1 ? '' : 's'}`;
    return 'menos de 1 minuto';
  }

  setupEvents() {
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
    });

    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => this.switchView(btn.dataset.view));
    });

    document.getElementById('searchInput')?.addEventListener('input', () => {
      this.currentPage = 1;
      this.renderInventario();
    });

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('filter-chip')) {
        document.querySelectorAll('.filter-chip').forEach(f => f.classList.remove('active'));
        e.target.classList.add('active');
        this.currentPage = 1;
        this.renderInventario();
      }
    });

    document.getElementById('btnIniciarConteo')?.addEventListener('click', () => this.iniciarConteo());
    document.getElementById('btnFinalizarConteo')?.addEventListener('click', () => this.finalizarConteo());

    // Listener para resize - Recalcular paginacin en modo auto
    let resizeTimeout;
    window.addEventListener('resize', () => {
      // Solo recalcular si estamos en modo auto (tanto viewMode como itemsPerPage)
      if (this.viewMode === 'auto' && this.itemsPerPage === 'auto') {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          console.log(' Recalculando paginacin responsive...');
          this.updateViewModeInfo(); // Actualizar info de dispositivo detectado
          this.currentPage = 1; // Resetear a primera pgina
          this.renderInventario();
        }, 500); // Debounce de 500ms
      }
    });

    this.setupCanvas();
  }

  setupCanvas() {
    this.canvas = document.getElementById('mapCanvas');
    if (!this.canvas) return;
    
    this.ctx = this.canvas.getContext('2d');
    
    const resize = () => {
      this.canvas.width = this.canvas.offsetWidth;
      this.canvas.height = this.canvas.offsetHeight;
      this.renderMap();
    };
    
    resize();
    window.addEventListener('resize', resize);
    
    this.canvas.addEventListener('click', (e) => this.handleMapClick(e));
  }

  //  Toggle secciones colapsables del panel de mapas
  toggleMapSection(headerElement) {
    const section = headerElement.closest('.map-section');
    section.classList.toggle('map-section--collapsed');
    
    // Guardar estado en localStorage
    const sectionTitle = headerElement.querySelector('h3').textContent.trim();
    const collapsed = section.classList.contains('map-section--collapsed');
    const collapsedSections = JSON.parse(localStorage.getItem('mapCollapsedSections') || '[]');
    
    if (collapsed) {
      if (!collapsedSections.includes(sectionTitle)) {
        collapsedSections.push(sectionTitle);
      }
    } else {
      const index = collapsedSections.indexOf(sectionTitle);
      if (index > -1) {
        collapsedSections.splice(index, 1);
      }
    }
    
    localStorage.setItem('mapCollapsedSections', JSON.stringify(collapsedSections));
  }

  //  Restaurar estado de secciones colapsadas
  restoreMapSectionsState() {
    const collapsedSections = JSON.parse(localStorage.getItem('mapCollapsedSections') || '[]');
    const sections = document.querySelectorAll('.map-section');
    
    sections.forEach(section => {
      const title = section.querySelector('.map-section-header h3').textContent.trim();
      if (collapsedSections.includes(title)) {
        section.classList.add('map-section--collapsed');
      }
    });
  }

  switchTab(tab) {
    console.log('Cambiando a pestaa:', tab);
    
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.getElementById(tab).style.display = 'block';
    
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    
    this.currentTab = tab;
    
    if (tab === 'jerarquia') {
      // 🌲 Renderizar árbol visual de jerarquía
      setTimeout(() => {
        this.renderJerarquiaTree();
        this.initJerarquiaSearch();
      }, 100);
    } else if (tab === 'stats') {
      this.renderStats();
    } else if (tab === 'valores') {
      this.renderValores();
    } else if (tab === 'okr') {
      okrModule.renderDashboard();
    } else if (tab === 'configuracion') {
      this.renderListasGestion();
      // Actualizar badge de conexin cuando se abre la pestaa
      if (typeof configuracion !== 'undefined' && configuracion.actualizarEstadoUI) {
        // setTimeout para asegurar que el HTML est renderizado
        setTimeout(() => configuracion.actualizarEstadoUI(), 50);
      }
      // Actualizar estado del backup manager
      if (typeof backupManager !== 'undefined' && backupManager.actualizarUI) {
        setTimeout(() => backupManager.actualizarUI(), 100);
      }
      //  Inicializar acorden de configuracin
      setTimeout(() => initConfigSections(), 150);
    } else if (tab === 'mapa') {
      // Dar tiempo para que el canvas se renderice antes de dibujar
      setTimeout(() => {
        //  Restaurar estado de secciones colapsadas independientemente del modo
        this.restoreMapSectionsState();

        // 🎨 Actualizar UI de Mapas
        if (window.MapasUI) {
          window.MapasUI.updateStats();
          window.MapasUI.initializeSubsections();
          
          // Renderizar jerarquía si HierarchySync está disponible
          if (window.HierarchySync) {
            const container = document.getElementById('hierarchy-tree-container');
            if (container) {
              window.HierarchySync.render(container);
            }
          }
          
          // Renderizar lista de mapas
          if (window.mapStorage && window.mapStorage.state && window.mapStorage.state.mapas) {
            window.MapasUI.renderMapasList(window.mapStorage.state.mapas);
            window.MapasUI.renderPendientes();
            window.MapasUI.renderEstadisticas();
          }
          
          console.log('✅ Tab Mapas UI actualizado');
        }

        const hasMapController = typeof window !== 'undefined'
          && window.mapController
          && mapController.elements
          && mapController.elements.canvas;

        if (hasMapController) {
          try {
            // Ajustar canvas y volver a dibujar con el nuevo controlador
            if (typeof mapController.handleResize === 'function') {
              mapController.handleResize();
            } else if (typeof mapController.resizeCanvas === 'function') {
              mapController.resizeCanvas();
            }

            if (!mapController.state.currentMapId) {
              const loadPromise = mapController.loadData?.();
              if (loadPromise && typeof loadPromise.catch === 'function') {
                loadPromise.catch((err) => console.warn('mapController.loadData() falló al volver a la pestaña mapa:', err));
              }
            } else if (typeof mapController.draw === 'function') {
              mapController.draw();
            }
          } catch (error) {
            console.warn('Error reactivando mapController al volver a la pestaña mapa:', error);
          }
          return;
        }

        //  MODO LEGACY: usar el renderizador original solo si mapController no existe
        if (!this.canvas || !this.ctx) {
          console.log('Inicializando canvas del mapa (legacy)...');
          this.setupCanvas();
        }
        this.renderMap();
      }, 100);
    } else if (tab === 'conteo') {
      this.renderConteo();
    }
  }

  switchView(view) {
    this.currentView = view;
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-view="${view}"]`).classList.add('active');
    this.renderInventario();
  }

  // Calcula items por pgina segn el tamao de pantalla (responsive) y modo de visualizacin
  calculateAutoItemsPerPage() {
    // Si hay modo forzado, usar valores predeterminados
    if (this.viewMode === 'mobile') {
      return 10; // Modo mvil forzado: siempre 10 items
    }
    if (this.viewMode === 'desktop') {
      return 21; // Modo PC forzado: siempre 21 items
    }
    
    // Modo auto: detectar tamao de pantalla
    const width = window.innerWidth;
    
    // Calcular columnas segn breakpoints del CSS (con tarjetas ms anchas ~280-300px)
    let columns;
    if (width < 768) {
      columns = 1; // Mvil: 1 columna
    } else if (width < 1200) {
      columns = 2; // Tablet: ~2 columnas (300px cada una)
    } else if (width < 1600) {
      columns = 4; // Desktop: ~4 columnas (280px cada una)
    } else if (width < 1920) {
      columns = 5; // Ultra-wide: ~5 columnas (270px cada una)
    } else {
      columns = 6; // 4K: ~6 columnas (260px cada una)
    }
    
    // Calcular filas visibles (aproximado)
    const rows = width < 768 ? 10 : 3; // Mvil muestra ms items verticalmente
    
    return columns * rows;
  }

  // Obtiene el nmero de items por pgina (auto o manual)
  getItemsPerPage() {
    if (this.itemsPerPage === 'auto') {
      return this.calculateAutoItemsPerPage();
    }
    return parseInt(this.itemsPerPage) || this.itemsPerPageManual;
  }

  // Cambia los items por pgina
  changeItemsPerPage(value) {
    this.itemsPerPage = value;
    if (value !== 'auto') {
      this.itemsPerPageManual = parseInt(value);
    }
    this.currentPage = 1; // Resetear a primera pgina
    this.renderInventario();
  }

  // Cambia el modo de visualizacin (auto/mobile/desktop)
  changeViewMode(mode) {
    console.log(' Cambiando modo de visualizacin a:', mode);
    this.viewMode = mode;
    localStorage.setItem('viewMode', mode);
    
    // Aplicar estilos CSS segn el modo
    this.applyViewModeStyles();
    
    // Actualizar info visual
    this.updateViewModeInfo();
    
    // Re-renderizar inventario
    this.currentPage = 1;
    this.renderInventario();
  }

  // Aplica estilos CSS dinmicos segn el modo
  applyViewModeStyles() {
    // Remover clases anteriores
    document.body.classList.remove('force-mobile', 'force-desktop');
    
    // Aplicar clase segn modo
    if (this.viewMode === 'mobile') {
      document.body.classList.add('force-mobile');
      console.log(' Modo Mvil activado');
    } else if (this.viewMode === 'desktop') {
      document.body.classList.add('force-desktop');
      console.log(' Modo PC activado');
    } else {
      console.log(' Modo Auto activado');
    }
  }

  // Actualiza la informacin del modo actual
  updateViewModeInfo() {
    const select = document.getElementById('viewModeSelect');
    const textEl = document.getElementById('currentViewModeText');
    
    if (select) {
      select.value = this.viewMode;
    }
    
    if (textEl) {
      const width = window.innerWidth;
      let info = '';
      
      if (this.viewMode === 'auto') {
        const deviceType = width < 768 ? 'Mvil' : width < 1200 ? 'Tablet' : 'Desktop';
        info = ` Auto - Detectado: ${deviceType} (${width}px)`;
      } else if (this.viewMode === 'mobile') {
        info = ` Modo Mvil Forzado (1 columna, botones grandes)`;
      } else if (this.viewMode === 'desktop') {
        info = ` Modo PC Forzado (5-8 columnas, mxima densidad)`;
      }
      
      textEl.textContent = info;
    }

    // Actualizar banner de Edge
    this.updateEdgeBanner();
  }

  // Actualiza el banner de Edge en configuracin
  updateEdgeBanner() {
    const badge = document.getElementById('edgeStatusBadge');
    const downloadSection = document.getElementById('edgeDownloadSection');
    
    if (badge) {
      if (this.isEdge) {
        badge.textContent = ' EDGE DETECTADO';
        badge.style.background = 'rgba(16, 185, 129, 0.3)';
      } else {
        badge.textContent = ' NO EDGE';
        badge.style.background = 'rgba(220, 38, 38, 0.3)';
      }
    }
    
    if (downloadSection) {
      downloadSection.style.display = this.isEdge ? 'none' : 'block';
    }
  }

  render() {
    this.renderInventario();
    this.renderFilters();
  }

  renderFilters() {
    const areasGenerales = [...new Set(this.repuestos.map(r => r.areaGeneral || r.area).filter(a => a))].sort();
    const sistemasEquipos = [...new Set(this.repuestos.map(r => r.sistemaEquipo || r.equipo).filter(e => e))].sort();
    const tipos = [...new Set(this.repuestos.map(r => r.tipo).filter(t => t))].sort();
    
    const filterArea = document.getElementById('filterArea');
    const filterEquipo = document.getElementById('filterEquipo');
    const filterTipo = document.getElementById('filterTipo');
    
    if (filterArea) {
      filterArea.innerHTML = '<option value="">Todas las reas</option>' +
        areasGenerales.map(a => `<option value="${a}">${a}</option>`).join('');
    }
    
    if (filterEquipo) {
      filterEquipo.innerHTML = '<option value="">Todos los Sistemas/Equipos</option>' +
        sistemasEquipos.map(e => `<option value="${e}">${e}</option>`).join('');
    }
    
    if (filterTipo) {
      filterTipo.innerHTML = '<option value="">Todos los Tipos</option>' +
        tipos.map(t => `<option value="${t}">${t}</option>`).join('');
    }
  }

  applyFilters() {
    this.currentPage = 1;
    this.renderInventario();
  }

  getFilteredRepuestos() {
    const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const filterArea = document.getElementById('filterArea')?.value || '';
    const filterEquipo = document.getElementById('filterEquipo')?.value || '';
    const filterTipo = document.getElementById('filterTipo')?.value || '';
    const filterStock = document.getElementById('filterStock')?.value || '';

    //  DEBUG: Ver si hay filtros jerrquicos activos
    if (this.filtrosJerarquicosActivos) {
      console.log(' Filtros Jerrquicos Activos:', this.filtrosJerarquicosActivos);
    }

    return this.repuestos.filter(r => {
      const matchSearch = !search || 
        (r.codSAP && r.codSAP.toLowerCase().includes(search)) ||
        (r.nombre && r.nombre.toLowerCase().includes(search)) ||
        (r.tipo && r.tipo.toLowerCase().includes(search)) ||
        (r.codProv && r.codProv.toLowerCase().includes(search)) ||
        // BUSCAR EN NUEVA JERARQUA DE 7 NIVELES
        (r.planta && r.planta.toLowerCase().includes(search)) ||
        (r.areaGeneral && r.areaGeneral.toLowerCase().includes(search)) ||
        (r.subArea && r.subArea.toLowerCase().includes(search)) ||
        (r.sistemaEquipo && r.sistemaEquipo.toLowerCase().includes(search)) ||
        (r.subSistema && r.subSistema.toLowerCase().includes(search)) ||
        (r.seccion && r.seccion.toLowerCase().includes(search)) ||
        (r.detalle && r.detalle.toLowerCase().includes(search)) ||
        // COMPATIBILIDAD CON FORMATO ANTIGUO
        (r.area && r.area.toLowerCase().includes(search)) ||
        (r.equipo && r.equipo.toLowerCase().includes(search)) ||
        (r.sistema && r.sistema.toLowerCase().includes(search)) ||
        (r.detalleUbicacion && r.detalleUbicacion.toLowerCase().includes(search));

      // Filtros de rea y Equipo con compatibilidad
      const matchArea = !filterArea || r.areaGeneral === filterArea || r.area === filterArea;
      const matchEquipo = !filterEquipo || r.sistemaEquipo === filterEquipo || r.equipo === filterEquipo;
      const matchTipo = !filterTipo || r.tipo === filterTipo;
      
      // Filtros jerrquicos desde pestaa JERARQUA
      let matchJerarquia = true;
      if (this.filtrosJerarquicosActivos) {
        const fj = this.filtrosJerarquicosActivos;
        
        //  DEBUG
        console.log('Evaluando repuesto:', r.nombre, {
          repuesto: { planta: r.planta, area: r.areaGeneral, subArea: r.subArea, sistema: r.sistemaEquipo, subSistema: r.subSistema },
          filtros: fj
        });
        
        // Si hay un ID de repuesto especfico, solo mostrar ese
        if (fj.repuestoId) {
          matchJerarquia = r.id === fj.repuestoId;
        } else {
          // Filtrado por niveles jerrquicos
          if (fj.planta && r.planta !== fj.planta) matchJerarquia = false;
          if (fj.areaGeneral && r.areaGeneral !== fj.areaGeneral) matchJerarquia = false;
          if (fj.subArea && r.subArea !== fj.subArea) matchJerarquia = false;
          if (fj.sistemaEquipo && r.sistemaEquipo !== fj.sistemaEquipo) matchJerarquia = false;
          if (fj.subSistema && r.subSistema !== fj.subSistema) matchJerarquia = false;
          if (fj.seccion && r.seccion !== fj.seccion) matchJerarquia = false;
          if (fj.detalle && r.detalle !== fj.detalle) matchJerarquia = false;
        }
        
        console.log('Match:', matchJerarquia);
      }
      
      let matchStock = true;
      const minimo = r.minimo || r.stockMinimo || 5;
      const optimo = r.optimo || minimo * 2;
      if (filterStock === 'agotado') {
        matchStock = r.cantidad === 0;
      } else if (filterStock === 'critico') {
        matchStock = r.cantidad > 0 && r.cantidad < minimo;
      } else if (filterStock === 'adecuado') {
        matchStock = r.cantidad >= minimo && r.cantidad < optimo;
      } else if (filterStock === 'optimo') {
        matchStock = r.cantidad >= optimo;
      }

      return matchSearch && matchArea && matchEquipo && matchTipo && matchStock && matchJerarquia;
    });
  }

  async renderInventario() {
    this.filteredRepuestos = this.getFilteredRepuestos();
    
    //  MODO MVIL: Vista simplificada sin paginacin
    if (this.isMobile && !this.hasFileSystemAPI) {
      await this.renderMobileListView(this.filteredRepuestos);
      return;
    }
    
    // PC: Vista normal con paginacin
    const itemsPerPage = this.getItemsPerPage();
    const totalPages = Math.ceil(this.filteredRepuestos.length / itemsPerPage);
    if (this.currentPage > totalPages) this.currentPage = totalPages || 1;
    
    const startIndex = (this.currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedRepuestos = this.filteredRepuestos.slice(startIndex, endIndex);
    
    if (this.currentView === 'cards') {
      await this.renderCards(paginatedRepuestos);
    } else {
      await this.renderList(paginatedRepuestos);
    }
    
    this.updatePagination();
  }

  async renderCards(repuestos) {
    const grid = document.getElementById('cardsGrid');
    const list = document.getElementById('listView');
    grid.style.display = 'grid';
    list.style.display = 'none';

    if (repuestos.length === 0) {
      grid.innerHTML = '<div class="text-center" style="grid-column: 1/-1; padding: 60px; color: var(--gray-500);">No se encontraron repuestos</div>';
      return;
    }

    // Cargar URLs de imgenes en paralelo
    const repuestosWithImages = await Promise.all(repuestos.map(async (r) => {
      const multimedia = r.multimedia || [];
      const imageUrl = await this.getFirstImage(multimedia); // Cargar desde FileSystem si es necesario
      return { ...r, imageUrl };
    }));

    grid.innerHTML = repuestosWithImages.map(r => {
      const multimedia = r.multimedia || [];
      const imageUrl = r.imageUrl;
      
      const minimo = r.minimo || r.stockMinimo || 5;
      const cantidad = r.cantidad || 0;
      const optimo = r.optimo || 10; // Usar stock ptimo manual
      
      // Calcular porcentaje RELATIVO al mnimo (ms intuitivo)
      let porcentaje = 0;
      let porcentajeBarra = 0;
      
      if (minimo > 0) {
        if (cantidad < minimo) {
          // Crtico: porcentaje negativo (ej: 4/5 = -20%)
          porcentaje = ((cantidad - minimo) / minimo) * 100;
          porcentajeBarra = (cantidad / minimo) * 50; // Barra hasta 50%
        } else {
          // Bajo o Normal: porcentaje positivo sobre el mnimo (ej: 6/5 = +20%)
          porcentaje = ((cantidad - minimo) / minimo) * 100;
          
          if (cantidad < optimo) {
            // Bajo: de 50% a 100% de la barra
            const progreso = ((cantidad - minimo) / (optimo - minimo));
            porcentajeBarra = 50 + (progreso * 50);
          } else {
            // Normal: barra completa al 100%
            porcentajeBarra = 100;
          }
        }
      }
      
      // Determinar estado y color basado en mnimo (Paleta Niebla y Bosque)
      let stockStatus = 'ok';
      let stockColor = '#6B8E7F'; // Verde bosque suave
      let stockText = 'Stock Normal';
      
      if (cantidad === 0) {
        stockStatus = 'cero';
        stockColor = '#C76B6B'; // Rojo suave (alta legibilidad)
        stockText = 'Sin Stock';
      } else if (cantidad < minimo) {
        stockStatus = 'critico';
        stockColor = '#D4976C'; // Naranja tierra clido
        stockText = 'Stock Crtico';
      } else if (cantidad >= minimo && cantidad < optimo) {
        stockStatus = 'bajo';
        stockColor = '#5B7C99'; // Azul-gris brumoso
        stockText = 'Stock Bajo';
      } else {
        // cantidad >= optimo
        stockStatus = 'ok';
        stockColor = '#6B8E7F'; // Verde bosque suave
        stockText = 'Stock Normal';
      }
      
      console.log(` [TARJETA] Renderizando repuesto: ${r.nombre}`);
      console.log(`   imageUrl:`, imageUrl);
      console.log(`   multimedia:`, multimedia);
      
      return `
      <div class="repuesto-card">
        <div class="card-image" data-action="lightbox" data-id="${r.id}" style="cursor: pointer; position: relative;">
          ${imageUrl ? `<img src="${imageUrl}" alt="${r.nombre}" data-blob-url="${imageUrl}" onload="console.log(' Imagen cargada en DOM:', this.alt)" onerror="console.error(' ERROR onerror - Imagen fall en DOM:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="no-image" style="display:none;">Sin imagen</div>` : '<div class="no-image">Sin imagen</div>'}
          ${multimedia.length > 1 ? `<div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">+${multimedia.length - 1}</div>` : ''}
        </div>
        <div class="card-content">
          <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 6px;">
            <h3 style="margin: 0; font-weight: 500; color: var(--text-primary); font-size: 1rem;">${r.nombre}</h3>
            <div style="display: flex; gap: 6px; width: 100%;">
              <button class="btn-add-location" onclick="app.agregarUbicacionMapa('${r.id}')" title="Aadir nueva ubicacin en el mapa">
                Aadir Ubicacin
              </button>
              <button class="btn-view-map" onclick="app.verRepuestoEnMapa('${r.id}')" title="Ver ubicaciones en el mapa">
                Ver en Mapa
              </button>
            </div>
          </div>
          <div class="card-info">
            ${r.codSAP ? `<div class="info-row"><span class="info-label">Cd. SAP:</span><span class="info-value" style="font-weight: 500; color: var(--primary);">${r.codSAP}</span></div>` : ''}
            ${r.codProv ? `<div class="info-row"><span class="info-label">Cd. Proveedor:</span><span class="info-value" style="font-weight: 500; color: var(--text-secondary);">${r.codProv}</span></div>` : ''}
          </div>
          ${r.tipo ? `<div class="info-row"><span class="info-label">Tipo:</span><span class="info-value">${r.tipo}</span></div>` : ''}
          ${r.categoria ? `<div class="info-row"><span class="info-label">Categora:</span><span class="info-value" style="font-weight: 500; font-size: 0.85rem; padding: 2px 8px; border-radius: 4px; display: inline-block; background: rgba(91, 139, 180, 0.15); color: var(--primary); border: 1px solid rgba(91, 139, 180, 0.3);">${r.categoria}</span></div>` : ''}
          
          <!-- Datos Tcnicos (si existen) -->
          ${r.datosTecnicos ? `
            <div style="background: rgba(91, 139, 180, 0.08); border-left: 2px solid var(--primary); padding: 8px 10px; border-radius: 4px; margin: 8px 0;">
              <div style="font-size: 0.7rem; font-weight: 600; color: var(--primary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                Datos Tcnicos
              </div>
              <div style="font-size: 0.78rem; color: var(--text-primary); line-height: 1.5; font-family: 'Segoe UI', Arial, sans-serif; white-space: pre-line; word-break: break-word;">${r.datosTecnicos}</div>
            </div>
          ` : ''}
          
          <div class="card-info">
            ${this.showPrecio && r.precio > 0 ? `<div class="info-row precio-info"><span class="info-label">Precio:</span><span class="info-value">$${r.precio.toFixed(2)}</span></div>` : ''}
            
            <div style="background: rgba(51, 65, 85, 0.6); padding: 6px; border-radius: 4px; margin-top: 6px; border-left: 2px solid ${stockColor};">
              
              <!-- Texto descriptivo del estado -->
              <div style="
                font-size: 0.68rem;
                color: ${stockColor};
                font-weight: 500;
                margin-bottom: 5px;
                line-height: 1.3;
              ">
                ${(() => {
                  if (cantidad === 0) {
                    return `Stock agotado. Requiere reposicin urgente.`;
                  } else if (cantidad < minimo) {
                    const faltante = minimo - cantidad;
                    return `Stock insuficiente: ${cantidad} de ${minimo} unid. mnimas. Faltan ${faltante} unid.`;
                  } else if (cantidad >= minimo && cantidad < optimo) {
                    const exceso = cantidad - minimo;
                    return `Stock adecuado: ${cantidad} unid. disponibles (+${exceso} sobre mnimo).`;
                  } else {
                    const exceso = cantidad - optimo;
                    return `Stock ptimo: ${cantidad} unid. disponibles (+${exceso} sobre ptimo).`;
                  }
                })()}
              </div>
              
              <!-- BARRA VISUAL DE STOCK SIMPLIFICADA -->
              <div style="
                position: relative;
                width: 100%;
                height: 20px;
                background: rgba(15, 23, 42, 0.8);
                border-radius: 4px;
                overflow: hidden;
                margin-bottom: 4px;
                border: 1px solid ${stockColor}40;
              ">
                <!-- Barra de progreso sin gradiente -->
                <div style="
                  position: absolute;
                  left: 0;
                  top: 0;
                  height: 100%;
                  width: ${porcentajeBarra}%;
                  background: ${stockColor};
                  transition: width 0.3s ease;
                "></div>
                
                <!-- Contenido superpuesto -->
                <div style="
                  position: absolute;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  padding: 0 10px;
                  z-index: 3;
                ">
                  <!-- Centro: Unidades -->
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 0.85rem; font-weight: 600; color: white;">${cantidad}</span>
                    <span style="font-size: 0.65rem; color: rgba(255,255,255,0.65);">/</span>
                    <span style="font-size: 0.75rem; font-weight: 500; color: rgba(255,255,255,0.85);">${minimo}</span>
                    <span style="font-size: 0.65rem; color: rgba(255,255,255,0.75); font-weight: 400;">unid.</span>
                  </div>
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: repeat(${r.cantidadInstalada > 0 ? '4' : '3'}, 1fr); gap: 4px; margin-bottom: 4px;">
                ${r.cantidadInstalada > 0 ? `
                <div style="text-align: center; background: rgba(91, 155, 122, 0.12); padding: 2px; border-radius: 3px; border: 1px solid rgba(91, 155, 122, 0.25);">
                  <div style="font-size: 0.5rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 1px;">En Uso</div>
                  <div style="font-size: 0.7rem; font-weight: 600; color: var(--success);">${r.cantidadInstalada}</div>
                </div>
                ` : ''}
                <div style="text-align: center;">
                  <div style="font-size: 0.5rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 1px;">Mnimo</div>
                  <div style="font-size: 0.7rem; font-weight: 600; color: var(--warning);">${minimo}</div>
                </div>
                <div style="text-align: center; background: rgba(91, 139, 180, 0.15); padding: 2px; border-radius: 3px; border: 1px solid rgba(91, 139, 180, 0.25);">
                  <div style="font-size: 0.5rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 1px;">Stock</div>
                  <div style="font-size: 0.75rem; font-weight: 700; color: ${stockColor};">${cantidad}</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 0.5rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 1px;">ptimo</div>
                  <div style="font-size: 0.7rem; font-weight: 600; color: var(--success);">${optimo}</div>
                </div>
              </div>
              
              <!-- Informacin de ltimo conteo -->
              <div style="
                font-size: 0.6rem;
                color: var(--text-secondary);
                padding: 4px 5px;
                background: rgba(15, 23, 42, 0.4);
                border-radius: 3px;
                margin-top: 4px;
                text-align: center;
              ">
                ${r.ultimoConteo ? `
                  <span style="color: rgba(255,255,255,0.75); font-size: 0.65rem;">ltima verificacin: ${new Date(r.ultimoConteo).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' })} - ${new Date(r.ultimoConteo).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
                ` : `
                  <span style="color: var(--warning); font-size: 0.65rem;">Pendiente de verificacin</span>
                `}
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer" style="display: flex; justify-content: center; align-items: center; gap: 8px; padding: 8px 12px;">
          <button class="card-btn" style="
            background: var(--primary);
            color: white;
            border: 1px solid rgba(91, 139, 180, 0.3);
            padding: 8px 14px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            max-width: 90px;
          " data-action="edit" data-id="${r.id}" 
          onmouseover="this.style.background='#6a9dc4'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.15)';"
          onmouseout="this.style.background='var(--primary)'; this.style.boxShadow='none';">
            Editar
          </button>
          
          <button class="card-btn" style="
            background: var(--success);
            color: white;
            border: 1px solid rgba(91, 155, 122, 0.3);
            padding: 8px 14px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            max-width: 90px;
          " data-action="contar" data-id="${r.id}"
          onmouseover="this.style.background='#6bae89'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.15)';"
          onmouseout="this.style.background='var(--success)'; this.style.boxShadow='none';">
            Contar
          </button>
          
          <button class="card-btn" style="
            background: var(--danger);
            color: white;
            border: 1px solid rgba(184, 107, 107, 0.3);
            padding: 8px 14px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            max-width: 90px;
          " data-action="delete" data-id="${r.id}"
          onmouseover="this.style.background='#c88080'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.15)';"
          onmouseout="this.style.background='var(--danger)'; this.style.boxShadow='none';">
            Eliminar
          </button>
        </div>
      </div>
      `;
    }).join('');

    // Ya no activamos zoom en tarjetas - el zoom es solo en el modal
  }

  renderList(repuestos) {
    const grid = document.getElementById('cardsGrid');
    const list = document.getElementById('listView');
    grid.style.display = 'none';
    list.style.display = 'block';

    if (repuestos.length === 0) {
      list.innerHTML = '<div class="text-center" style="padding: 60px; color: var(--gray-500);">No se encontraron repuestos</div>';
      return;
    }

    // Obtener orden actual
    const sortField = this.listSortField || 'codSAP';
    const sortOrder = this.listSortOrder || 'asc';
    
    //  Definir orden de niveles jerrquicos (8 niveles)
    const nivelOrder = { 'N1': 1, 'N2': 2, 'N3': 3, 'N4': 4, 'N5': 5, 'N6': 6, 'N7': 7, 'N8': 8 };
    
    // Ordenar repuestos
    const sortedRepuestos = [...repuestos].sort((a, b) => {
      //  PRIMERO: Ordenar por nivel jerrquico (N1 primero, N8 ltimo)
      const nivelA = nivelOrder[a.nivelJerarquico] || 8; // Por defecto N8
      const nivelB = nivelOrder[b.nivelJerarquico] || 8;
      
      if (nivelA !== nivelB) {
        return nivelA - nivelB; // Ascendente siempre (N1  N8)
      }
      
      // SEGUNDO: Si tienen el mismo nivel, ordenar por el campo seleccionado
      let valA, valB;
      
      if (sortField === 'stock') {
        valA = a.cantidad || 0;
        valB = b.cantidad || 0;
      } else if (sortField === 'stockPercent') {
        const minimoA = a.minimo || 5;
        const minimoB = b.minimo || 5;
        const optimoA = minimoA * 2;
        const optimoB = minimoB * 2;
        valA = ((a.cantidad || 0) / optimoA) * 100;
        valB = ((b.cantidad || 0) / optimoB) * 100;
      } else {
        valA = (a[sortField] || '').toString().toLowerCase();
        valB = (b[sortField] || '').toString().toLowerCase();
      }
      
      if (sortOrder === 'asc') {
        return valA > valB ? 1 : valA < valB ? -1 : 0;
      } else {
        return valA < valB ? 1 : valA > valB ? -1 : 0;
      }
    });

    const getSortIcon = (field) => {
      if (sortField !== field) return '';
      return sortOrder === 'asc' ? '' : '';
    };

    list.innerHTML = `
      <div class="list-header" id="listHeader">
        <div class="list-header-cell ${sortField === 'codSAP' ? 'active' : ''}" onclick="app.sortList('codSAP')" style="min-width: 50px;" data-col="0">
          <span>Ub.</span>
          <div class="resize-handle" data-col="0"></div>
        </div>
        <div class="list-header-cell ${sortField === 'codSAP' ? 'active' : ''}" onclick="app.sortList('codSAP')" data-col="1">
          <span>Cdigos</span>
          <span class="sort-icon">${getSortIcon('codSAP')}</span>
          <div class="resize-handle" data-col="1"></div>
        </div>
        <div class="list-header-cell ${sortField === 'nombre' ? 'active' : ''}" onclick="app.sortList('nombre')" data-col="2">
          <span>Nombre</span>
          <span class="sort-icon">${getSortIcon('nombre')}</span>
          <div class="resize-handle" data-col="2"></div>
        </div>
        <div class="list-header-cell ${sortField === 'stock' || sortField === 'stockPercent' ? 'active' : ''}" onclick="app.sortList('stock')" data-col="3">
          <span>Stock (Mn/Act/pt)</span>
          <span class="sort-icon">${getSortIcon('stock')}</span>
          <div class="resize-handle" data-col="3"></div>
        </div>
        <div data-col="4">Acciones</div>
      </div>
      ${sortedRepuestos.map(r => {
        const minimo = r.minimo || r.stockMinimo || 5;
        const cantidad = r.cantidad || 0;
        const optimo = r.optimo || 10; // Usar stock ptimo manual
        const porcentaje = Math.min((cantidad / optimo) * 100, 100);
        
        // Determinar color del stock (Paleta Niebla y Bosque)
        let stockColor = '#6B8E7F'; // Verde bosque suave
        let stockText = 'Normal';
        if (cantidad === 0) {
          stockColor = '#C76B6B'; // Rojo suave (alta legibilidad)
          stockText = 'Sin Stock';
        } else if (cantidad < minimo) {
          stockColor = '#D4976C'; // Naranja tierra clido
          stockText = 'Crtico';
        } else if (cantidad <= optimo) {
          stockColor = '#5B7C99'; // Azul-gris brumoso
          stockText = 'Bajo';
        }
        
        // Preparar texto de cdigos ultra-compacto con etiquetas
        let codigosHTML = '';
        if (r.codSAP) {
          codigosHTML += `<div style="font-weight: 600; color: #718096; font-size: 0.7rem; display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
            <span style="color: var(--text-secondary); font-weight: 500; font-size: 0.65rem;">SAP:</span>
            <span style="color: #5B7C99; font-weight: 700; font-size: 0.8rem;">${r.codSAP}</span>
          </div>`;
        }
        if (r.codProv) {
          codigosHTML += `<div style="font-weight: 600; color: #718096; font-size: 0.7rem; display: flex; align-items: center; gap: 4px;">
            <span style="color: var(--text-secondary); font-weight: 500; font-size: 0.65rem;">Proveedor:</span>
            <span style="color: #7A9AB8;">${r.codProv}</span>
          </div>`;
        }
        if (!codigosHTML) {
          codigosHTML = '<span style="color: var(--gray-400); font-size: 0.65rem;">Sin cdigo</span>';
        }
        
        // Preparar jerarqua de ubicacin completa (7 niveles)
        const ubicacionParts = [];
        const colors = {
          planta: '#D4976C',
          areaGeneral: '#5B7C99',
          subArea: '#718096',
          sistemaEquipo: '#7A9AB8',
          subSistema: '#8B9AAA',
          seccion: '#9AABB8',
          detalle: '#6B8E7F'
        };
        
        const planta = r.planta || this.plantaBase;
        if (planta) {
          ubicacionParts.push(`<span style="color: ${colors.planta};">${planta}</span>`);
        }
        
        this.jerarquiaNiveles.forEach(nivel => {
          if (nivel.id === 'planta') return;
          
          let valor = r[nivel.id];
          if (!valor && nivel.id === 'areaGeneral') valor = r.area;
          if (!valor && nivel.id === 'sistemaEquipo') valor = r.equipo;
          if (!valor && nivel.id === 'subSistema') valor = r.sistema;
          if (!valor && nivel.id === 'detalle') valor = r.detalleUbicacion;
          
          if (valor) {
            const color = colors[nivel.id] || '#718096';
            ubicacionParts.push(`<span style="color: ${color};">${valor}</span>`);
          }
        });
        
        const ubicacionHTML = ubicacionParts.length > 0 
          ? ubicacionParts.join('<span style="color: var(--primary); margin: 0 4px;"></span>')
          : '<span style="color: var(--text-secondary); font-size: 0.7rem;">Sin ubicacin</span>';
        
        return `
        <div class="list-row">
          <div data-label="Ubicacin" style="display: flex; align-items: center; justify-content: center;">
            <button class="btn-hierarchy" onclick="app.mostrarJerarquia('${r.id}')" title="Ver jerarqua completa" style="width: auto; padding: 4px 8px; font-size: 0.7rem;">
              Ver
            </button>
          </div>
          <div data-label="Cdigos" style="line-height: 1.2;">
            ${codigosHTML}
          </div>
          <div data-label="Nombre" style="line-height: 1.2;">
            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">
              ${r.nivelJerarquico ? `<span style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; font-size: 0.6rem; font-weight: 700; padding: 2px 6px; border-radius: 3px; letter-spacing: 0.5px;">${r.nivelJerarquico}</span>` : ''}
              <div style="font-weight: 600; color: var(--text-primary); font-size: 0.8rem;">${r.nombre}</div>
            </div>
            ${r.tipo ? `<div style="color: var(--text-secondary); font-size: 0.65rem; margin-top: 1px;"><span style="font-weight: 600;">Tipo:</span> ${r.tipo}</div>` : ''}
          </div>
          <div data-label="Stock (Mn/Act/pt)" class="stock-visual">
            <div style="display: flex; gap: 4px; align-items: center; justify-content: space-around; margin-bottom: 2px; padding: 0;">
              <div style="text-align: center; flex: 1;">
                <div style="font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0px;">Mn</div>
                <div style="font-weight: 700; font-size: 0.75rem; color: #D4976C; line-height: 1;">${minimo}</div>
              </div>
              <div style="text-align: center; background: rgba(91, 124, 153, 0.25); padding: 3px 6px; border-radius: 3px; flex: 1;">
                <div style="font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0px;">Act</div>
                <div style="font-weight: 700; font-size: 0.85rem; color: ${stockColor}; line-height: 1;">${cantidad}</div>
              </div>
              <div style="text-align: center; flex: 1;">
                <div style="font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0px;">pt</div>
                <div style="font-weight: 700; font-size: 0.75rem; color: #6B8E7F; line-height: 1;">${optimo}</div>
              </div>
            </div>
            
            ${(() => {
              // Calcular barra termmetro compacta
              let barraAncho = 0;
              let barraColor = '#C76B6B';
              
              if (cantidad === 0) {
                barraAncho = 0;
                barraColor = '#C76B6B';
              } else if (cantidad < minimo) {
                barraAncho = (cantidad / minimo) * 50;
                barraColor = '#D4976C';
              } else if (cantidad >= minimo && cantidad < optimo) {
                const progreso = ((cantidad - minimo) / (optimo - minimo));
                barraAncho = 50 + (progreso * 50);
                barraColor = '#5B7C99';
              } else {
                barraAncho = 100;
                barraColor = '#6B8E7F';
              }
              
              return `
              <div style="margin: 2px 0 2px 0;">
                <div style="position: relative; width: 100%; height: 4px; background: rgba(100, 116, 139, 0.2); border-radius: 2px; overflow: visible;">
                  <div style="
                    position: absolute;
                    left: 0;
                    top: 0;
                    height: 100%;
                    width: ${barraAncho}%;
                    background: ${barraColor};
                    border-radius: 2px;
                    transition: width 0.4s ease;
                    box-shadow: 0 0 4px ${barraColor}80;
                  "></div>
                  
                  <div style="
                    position: absolute;
                    left: 50%;
                    top: 0px;
                    width: 1px;
                    height: 4px;
                    background: #D4976C;
                    transform: translateX(-50%);
                    z-index: 2;
                  "></div>
                  
                  <div style="
                    position: absolute;
                    right: 0;
                    top: 0px;
                    width: 1px;
                    height: 4px;
                    background: #6B8E7F;
                    z-index: 2;
                  "></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; font-size: 0.45rem; color: var(--text-secondary); margin-top: 1px;">
                  <span>0</span>
                  <span style="color: #D4976C; font-weight: 600;">Mn</span>
                  <span style="color: #6B8E7F; font-weight: 600;">pt</span>
                </div>
              </div>
              `;
            })()}
            
            <div style="font-size: 0.6rem; color: ${stockColor}; font-weight: 600; text-align: center; margin-top: 0px; line-height: 1;">${stockText}</div>
          </div>
          <div class="list-actions">
            <button class="btn" style="
              background: #557566;
              color: white;
              border: 1px solid #6B8E7F;
              padding: 6px 8px;
              font-size: 0.65rem;
              border-radius: 4px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
              box-shadow: 0 1px 3px rgba(0,0,0,0.15);
              white-space: nowrap;
              line-height: 1.1;
              width: 55px;
              flex: 0 0 55px;
            " data-action="contar" data-id="${r.id}"
            onmouseover="this.style.background='#6B8E7F'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'"
            onmouseout="this.style.background='#557566'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.15)'">
              Contar
            </button>
            <button class="btn" style="
              background: #4A6278;
              color: white;
              border: 1px solid #5B7C99;
              padding: 6px 8px;
              font-size: 0.65rem;
              border-radius: 4px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
              box-shadow: 0 1px 3px rgba(0,0,0,0.15);
              white-space: nowrap;
              line-height: 1.1;
              width: 55px;
              flex: 0 0 55px;
            " data-action="edit" data-id="${r.id}"
            onmouseover="this.style.background='#5B7C99'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'"
            onmouseout="this.style.background='#4A6278'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.15)'">
              Editar
            </button>
            <button class="btn" style="
              background: #A85555;
              color: white;
              border: 1px solid #C76B6B;
              padding: 6px 8px;
              font-size: 0.65rem;
              border-radius: 4px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
              box-shadow: 0 1px 3px rgba(0,0,0,0.15);
              white-space: nowrap;
              line-height: 1.1;
              width: 55px;
              flex: 0 0 55px;
            " data-action="delete" data-id="${r.id}"
            onmouseover="this.style.background='#C76B6B'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'"
            onmouseout="this.style.background='#A85555'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.15)'">
              Eliminar
            </button>
          </div>
        </div>
        `;
      }).join('')}
    `;

    // Configurar resize de columnas despus de renderizar
    setTimeout(() => {
      this.applyColumnWidths();
      this.setupColumnResize();
    }, 100);
  }
  
  // Aplicar anchos de columna guardados
  applyColumnWidths() {
    const listHeader = document.getElementById('listHeader');
    if (!listHeader) return;
    
    const gridTemplate = this.columnWidths.join(' ');
    listHeader.style.gridTemplateColumns = gridTemplate;
    
    // Aplicar a todas las filas tambin
    document.querySelectorAll('.list-row').forEach(row => {
      row.style.gridTemplateColumns = gridTemplate;
    });
  }

  //  NUEVA FUNCIN: Vista de lista mvil limpia (sin tarjetas ni imgenes)
  async renderMobileListView(repuestos) {
    const grid = document.getElementById('cardsGrid');
    const list = document.getElementById('listView');
    grid.style.display = 'none';
    list.style.display = 'block';

    if (repuestos.length === 0) {
      list.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);"> No se encontraron repuestos</div>';
      return;
    }

    // Calcular totales
    const totalItems = repuestos.length;
    const totalCantidad = repuestos.reduce((sum, r) => sum + (r.cantidad || 0), 0);
    const stockBajo = repuestos.filter(r => {
      const minimo = r.minimo || r.stockMinimo || 5;
      return r.cantidad > 0 && r.cantidad <= minimo;
    }).length;
    const sinStock = repuestos.filter(r => r.cantidad === 0).length;

    list.innerHTML = `
      <!-- HEADER STICKY CON TOTALES - CORPORATIVO -->
      <div style="
        position: sticky;
        top: 0;
        z-index: 100;
        background: linear-gradient(135deg, #003B5C 0%, #004d73 100%);
        backdrop-filter: blur(10px);
        padding: 16px;
        margin: -16px -16px 16px -16px;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        border-bottom: 3px solid #C75300;
      ">
        <div style="display: flex; justify-content: space-between; align-items: center; color: white; margin-bottom: 12px;">
          <div style="font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
            <span style="display: inline-block; width: 8px; height: 8px; background: #0095DA; border-radius: 50%;"></span>
            ${totalItems} Repuestos
          </div>
          <div style="font-size: 0.9rem; font-weight: 600; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 6px;">
            ${totalCantidad} unid.
          </div>
        </div>
        <div style="display: flex; gap: 8px; font-size: 0.75rem; flex-wrap: wrap;">
          ${sinStock > 0 ? `<span style="background: rgba(139, 90, 90, 0.9); padding: 5px 10px; border-radius: 6px; font-weight: 600; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${sinStock} sin stock</span>` : ''}
          ${stockBajo > 0 ? `<span style="background: rgba(199, 83, 0, 0.9); padding: 5px 10px; border-radius: 6px; font-weight: 600; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${stockBajo} bajo</span>` : ''}
          <span style="background: rgba(82, 120, 83, 0.9); padding: 5px 10px; border-radius: 6px; font-weight: 600; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${totalItems - sinStock - stockBajo} OK</span>
        </div>
      </div>

      <!-- LISTA DE REPUESTOS -->
      <div style="display: flex; flex-direction: column; gap: 12px;">
        ${repuestos.map(r => {
          const minimo = r.minimo || r.stockMinimo || 5;
          const cantidad = r.cantidad || 0;
          const optimo = r.optimo || 10; // Usar stock ptimo manual
          const porcentaje = Math.min((cantidad / optimo) * 100, 100);
          
          // Determinar color y estado (Paleta Niebla y Bosque)
          let stockColor = '#6B8E7F'; // Verde bosque suave
          let stockBg = 'rgba(107, 142, 127, 0.15)';
          let stockText = 'OK';
          
          if (cantidad === 0) {
            stockColor = '#C76B6B'; // Rojo suave (alta legibilidad)
            stockBg = 'rgba(199, 107, 107, 0.15)';
            stockText = 'Sin Stock';
          } else if (cantidad < minimo) {
            stockColor = '#D4976C'; // Naranja tierra clido
            stockBg = 'rgba(212, 151, 108, 0.15)';
            stockText = 'Crtico';
          } else if (cantidad < optimo) {
            stockColor = '#5B7C99'; // Azul-gris brumoso
            stockBg = 'rgba(91, 124, 153, 0.15)';
            stockText = 'Bajo';
          }
          
          return `
            <div style="
              background: var(--bg-secondary);
              border: 2px solid var(--border-color);
              border-left: 4px solid ${stockColor};
              border-radius: 12px;
              padding: 12px;
              transition: all 0.2s ease;
            " ontouchstart="this.style.transform='scale(0.98)'" ontouchend="this.style.transform='scale(1)'">
              
              <!-- HEADER: Nombre y Stock -->
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; gap: 12px;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 700; font-size: 0.95rem; color: var(--text-primary); margin-bottom: 4px; word-wrap: break-word;">
                    ${r.nombre}
                  </div>
                  ${r.tipo ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${r.tipo}</div>` : ''}
                </div>
                <!-- Stock 3 valores: Mnimo/Actual/ptimo -->
                <div style="
                  background: #334155;
                  border-left: 3px solid ${stockColor};
                  border-radius: 6px;
                  padding: 8px;
                  min-width: 160px;
                ">
                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; text-align: center;">
                    <div>
                      <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-secondary);">Mn</div>
                      <div style="font-weight: 700; color: #C75300; font-size: 0.95rem;">${minimo}</div>
                    </div>
                    <div style="background: rgba(91,124,153,0.2); padding: 4px; border-radius: 4px;">
                      <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-secondary);">Act</div>
                      <div style="font-weight: 700; color: ${stockColor}; font-size: 1.1rem;">${cantidad}</div>
                    </div>
                    <div>
                      <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-secondary);">pt</div>
                      <div style="font-weight: 700; color: #527853; font-size: 0.95rem;">${optimo}</div>
                    </div>
                  </div>
                  <div style="font-size: 0.65rem; color: ${stockColor}; font-weight: 600; margin-top: 4px; text-align: center;">${stockText}</div>
                </div>
              </div>

              <!-- BARRA DE PROGRESO -->
              <div style="
                width: 100%;
                height: 6px;
                background: rgba(100, 116, 139, 0.2);
                border-radius: 3px;
                overflow: hidden;
                margin-bottom: 10px;
              ">
                <div style="
                  width: ${porcentaje}%;
                  height: 100%;
                  background: ${stockColor};
                  transition: width 0.3s ease;
                "></div>
              </div>

              <!-- INFO: Cdigos y Ubicacin -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; font-size: 0.8rem;">
                <div style="background: var(--bg-primary); padding: 6px 8px; border-radius: 6px;">
                  <div style="color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 2px;">Cd. SAP</div>
                  <div style="font-weight: 600; color: var(--primary);">${r.codSAP || 'N/A'}</div>
                </div>
                <div style="background: var(--bg-primary); padding: 6px 8px; border-radius: 6px;">
                  <div style="color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 2px;">Cd. Prov</div>
                  <div style="font-weight: 600; color: var(--info);">${r.codProv || 'N/A'}</div>
                </div>
              </div>

              <div style="display: flex; gap: 6px; margin-bottom: 12px; font-size: 0.75rem; flex-wrap: wrap;">
                <span style="background: var(--bg-primary); padding: 4px 8px; border-radius: 6px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px;">
                  <span style="display: inline-block; width: 6px; height: 6px; background: #5B7C99; border-radius: 50%;"></span>
                  ${r.area || 'Sin rea'}
                </span>
                <span style="background: var(--bg-primary); padding: 4px 8px; border-radius: 6px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px;">
                  <span style="display: inline-block; width: 6px; height: 6px; background: #C75300; border-radius: 50%;"></span>
                  ${r.equipo || 'Sin equipo'}
                </span>
                ${r.ultimoConteo ? `
                <span style="background: var(--bg-primary); padding: 4px 8px; border-radius: 6px; color: var(--text-secondary); font-size: 0.7rem;">
                  Contado: ${new Date(r.ultimoConteo).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' })}
                </span>
                ` : ''}
              </div>

              <!-- BOTONES DE ACCIN CORPORATIVOS -->
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                <button 
                  onclick="app.abrirModalConteoIndividual('${r.id}')"
                  style="
                    background: linear-gradient(135deg, #527853, #3d5a3e);
                    color: white;
                    border: none;
                    padding: 12px 8px;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 0.85rem;
                    cursor: pointer;
                    transition: all 0.2s;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                  "
                  ontouchstart="this.style.transform='scale(0.95)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'"
                  ontouchend="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'"
                >
                  Contar
                </button>
                <button 
                  onclick="app.editarRepuesto('${r.id}')"
                  style="
                    background: linear-gradient(135deg, #004d73, #003B5C);
                    color: white;
                    border: none;
                    padding: 12px 8px;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 0.85rem;
                    cursor: pointer;
                    transition: all 0.2s;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                  "
                  ontouchstart="this.style.transform='scale(0.95)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'"
                  ontouchend="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'"
                >
                  Editar
                </button>
                <button 
                  onclick="app.deleteRepuesto('${r.id}')"
                  style="
                    background: linear-gradient(135deg, #8B5A5A, #6B4444);
                    color: white;
                    border: none;
                    padding: 12px 8px;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 0.85rem;
                    cursor: pointer;
                    transition: all 0.2s;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                  "
                  ontouchstart="this.style.transform='scale(0.95)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'"
                  ontouchend="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'"
                >
                  Eliminar
                </button>
              </div>

              ${r.ultimoConteo ? `
                <div style="
                  margin-top: 10px;
                  padding: 6px 8px;
                  background: rgba(59, 130, 246, 0.1);
                  border-radius: 6px;
                  font-size: 0.7rem;
                  color: var(--text-secondary);
                  text-align: center;
                ">
                   ltimo conteo: ${new Date(r.ultimoConteo).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' })}
                  ${new Date(r.ultimoConteo).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
                </div>
              ` : `
                <div style="
                  margin-top: 10px;
                  padding: 6px 8px;
                  background: rgba(245, 158, 11, 0.1);
                  border-radius: 6px;
                  font-size: 0.7rem;
                  color: var(--warning);
                  text-align: center;
                ">
                   An no se ha contado este repuesto
                </div>
              `}
            </div>
          `;
        }).join('')}
      </div>
    `;
    
    // Ocultar paginacin en mvil
    const pagination = document.getElementById('pagination');
    if (pagination) pagination.style.display = 'none';
  }

  sortList(field) {
    // Si ya estamos ordenando por este campo, invertir orden
    if (this.listSortField === field) {
      this.listSortOrder = this.listSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
      // Nuevo campo, orden ascendente por defecto
      this.listSortField = field;
      this.listSortOrder = 'asc';
    }
    
    // Re-renderizar
    this.render();
    
    // Toast informativo
    const orderText = this.listSortOrder === 'asc' ? 'Ascendente ' : 'Descendente ';
    const fieldText = {
      'codSAP': 'Cdigos',
      'nombre': 'Nombre',
      'area': 'rea',
      'equipo': 'Equipo',
      'stock': 'Stock',
      'stockPercent': 'Stock %'
    }[field] || field;
    
    this.showToast(`Ordenando por: ${fieldText} (${orderText})`, 'info', 2000);
  }

  // Configurar resize de columnas arrastrables
  setupColumnResize() {
    const listHeader = document.getElementById('listHeader');
    if (!listHeader) return;

    const handles = listHeader.querySelectorAll('.resize-handle');
    let isResizing = false;
    let currentHandle = null;
    let startX = 0;
    let startWidth = 0;
    let currentCol = null;
    let colIndex = null;

    // Cargar anchos guardados o usar valores por defecto
    const savedWidths = localStorage.getItem('inventario_columnWidths');
    if (savedWidths) {
      try {
        this.columnWidths = JSON.parse(savedWidths);
      } catch (e) {
        console.warn('Error cargando anchos de columnas guardados:', e);
      }
    }

    handles.forEach(handle => {
      handle.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        isResizing = true;
        currentHandle = handle;
        colIndex = parseInt(handle.dataset.col);
        currentCol = listHeader.children[colIndex];
        startX = e.pageX;
        startWidth = currentCol.offsetWidth;
        
        listHeader.classList.add('resizing');
        handle.classList.add('resizing');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
      });
    });

    const mouseMoveHandler = (e) => {
      if (!isResizing) return;
      
      const diff = e.pageX - startX;
      const newWidth = Math.max(50, startWidth + diff); // Mnimo 50px
      
      // Actualizar solo la columna que se est redimensionando
      this.columnWidths[colIndex] = `${newWidth}px`;
      
      // Aplicar nuevo grid template
      const newGridTemplate = this.columnWidths.join(' ');
      listHeader.style.gridTemplateColumns = newGridTemplate;
      
      // Aplicar a todas las filas tambin
      document.querySelectorAll('.list-row').forEach(row => {
        row.style.gridTemplateColumns = newGridTemplate;
      });
    };

    const mouseUpHandler = () => {
      if (isResizing) {
        isResizing = false;
        listHeader.classList.remove('resizing');
        if (currentHandle) {
          currentHandle.classList.remove('resizing');
        }
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        
        // Guardar anchos en localStorage
        try {
          localStorage.setItem('inventario_columnWidths', JSON.stringify(this.columnWidths));
          console.log(' Anchos de columnas guardados:', this.columnWidths);
        } catch (e) {
          console.warn('Error guardando anchos de columnas:', e);
        }
        
        currentHandle = null;
        currentCol = null;
        colIndex = null;
      }
    };

    document.addEventListener('mousemove', mouseMoveHandler);
    document.addEventListener('mouseup', mouseUpHandler);
  }

  updatePagination() {
    const itemsPerPage = this.getItemsPerPage();
    const totalPages = Math.ceil(this.filteredRepuestos.length / itemsPerPage);
    const totalItems = this.filteredRepuestos.length;
    const startItem = ((this.currentPage - 1) * itemsPerPage) + 1;
    const endItem = Math.min(this.currentPage * itemsPerPage, totalItems);
    
    const pagination = document.getElementById('pagination');
    const pageNumbers = document.getElementById('pageNumbers');
    const btnPrev = document.getElementById('btnPrevPage');
    const btnNext = document.getElementById('btnNextPage');
    const btnFirst = document.getElementById('btnFirstPage');
    const btnLast = document.getElementById('btnLastPage');
    const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
    const itemsPerPageInfo = document.getElementById('itemsPerPageInfo');
    const jumpToPageInput = document.getElementById('jumpToPage');
    
    // Actualizar el input de salto de pgina
    if (jumpToPageInput) {
      jumpToPageInput.max = totalPages;
      jumpToPageInput.placeholder = `1-${totalPages}`;
    }
    
    // Actualizar el selector con el valor actual
    if (itemsPerPageSelect) {
      itemsPerPageSelect.value = this.itemsPerPage;
    }
    
    // Mostrar info del modo auto
    if (itemsPerPageInfo && this.itemsPerPage === 'auto') {
      const width = window.innerWidth;
      let deviceType = width < 768 ? 'Mvil' : width < 1200 ? 'Tablet' : width < 1600 ? 'Desktop' : width < 1920 ? 'Ultra-wide' : '4K';
      itemsPerPageInfo.textContent = `(${itemsPerPage} items - ${deviceType})`;
      itemsPerPageInfo.style.display = 'inline';
    } else if (itemsPerPageInfo) {
      itemsPerPageInfo.style.display = 'none';
    }
    
    // Mostrar paginacin siempre (es til ver los controles de items por pgina)
    if (pagination) {
      pagination.style.display = 'flex';
    }
    
    if (!pageNumbers) return;
    
    // Deshabilitar botones segn pgina actual
    if (btnPrev) btnPrev.disabled = this.currentPage === 1;
    if (btnNext) btnNext.disabled = this.currentPage === totalPages;
    if (btnFirst) btnFirst.disabled = this.currentPage === 1;
    if (btnLast) btnLast.disabled = this.currentPage === totalPages;
    
    // Generar nmeros de pginas
    let pages = [];
    const maxVisible = 7; // Mximo de nmeros visibles
    
    if (totalPages <= maxVisible) {
      // Mostrar todas las pginas
      pages = Array.from({length: totalPages}, (_, i) => i + 1);
    } else {
      // Mostrar pginas con elipsis
      if (this.currentPage <= 4) {
        pages = [1, 2, 3, 4, 5, '...', totalPages];
      } else if (this.currentPage >= totalPages - 3) {
        pages = [1, '...', totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
      } else {
        pages = [1, '...', this.currentPage - 1, this.currentPage, this.currentPage + 1, '...', totalPages];
      }
    }
    
    pageNumbers.innerHTML = pages.map(page => {
      if (page === '...') {
        return `<span style="color: var(--text-secondary); padding: 0 12px; opacity: 0.6; font-weight: 600;"></span>`;
      }
      
      const isActive = page === this.currentPage;
      return `
        <button 
          onclick="app.goToPage(${page})" 
          class="btn page-number-btn ${isActive ? 'btn-primary page-active' : 'btn-secondary'}"
          ${isActive ? 'disabled' : ''}
        >
          ${page}
        </button>
      `;
    }).join('') + `
      <span class="pagination-status">
        ${startItem}-${endItem} de ${totalItems}
      </span>
    `;
  }

  goToPage(page) {
    const itemsPerPage = this.getItemsPerPage();
    const totalPages = Math.ceil(this.filteredRepuestos.length / itemsPerPage);
    if (page === 'last') {
      this.currentPage = totalPages;
    } else {
      this.currentPage = Math.max(1, Math.min(page, totalPages));
    }
    this.renderInventario();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  nextPage() {
    const itemsPerPage = this.getItemsPerPage();
    const totalPages = Math.ceil(this.filteredRepuestos.length / itemsPerPage);
    if (this.currentPage < totalPages) {
      this.currentPage++;
      this.renderInventario();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  previousPage() {
    if (this.currentPage > 1) {
      this.currentPage--;
      this.renderInventario();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  jumpToPage() {
    const input = document.getElementById('jumpToPage');
    const pageNumber = parseInt(input.value);
    
    if (!pageNumber || isNaN(pageNumber)) {
      alert('Por favor ingresa un nmero de pgina vlido');
      return;
    }
    
    const itemsPerPage = this.getItemsPerPage();
    const totalPages = Math.ceil(this.filteredRepuestos.length / itemsPerPage);
    
    if (pageNumber < 1 || pageNumber > totalPages) {
      alert(`El nmero de pgina debe estar entre 1 y ${totalPages}`);
      return;
    }
    
    this.currentPage = pageNumber;
    this.renderInventario();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    input.value = ''; // Limpiar el input
  }

  /**
   * Obtiene el nodo jerárquico completo de un repuesto
   * Prioridad: nivel5 > nivel4 > nivel3 > nivel2 > nivel1
   */
  getNodoJerarquicoCompleto(repuesto) {
    if (!repuesto) return null;
    
    // Buscar el nivel más específico no vacío
    const niveles = ['nivel5', 'nivel4', 'nivel3', 'nivel2', 'nivel1'];
    for (const nivel of niveles) {
      const valor = repuesto[nivel];
      if (valor && valor.trim() !== '') {
        return valor.trim();
      }
    }
    
    return null;
  }

  async openModal(mode, id = null) {
    console.log(`\n ========== ABRIENDO MODAL ==========`);
    console.log(`Modo: ${mode}`);
    console.log(`ID recibido: ${id} (tipo: ${typeof id})`);
    console.log(`Total repuestos en memoria: ${this.repuestos.length}`);
    
    this.currentEditingId = id;
    
    // Inicializar estado multimedia con nuevo sistema
    this.initMultimediaState(id);

    // Header eliminado - sin necesidad de actualizar títulos
    // Actualizar badge multimedia si existe
    this.refreshModalMultimediaBadge();
    document.getElementById('repuestoForm').reset();
    this.initWizard({ focusFirstField: false });
    
    //  LIMPIEZA PROFUNDA: Asegurar que no queden vistas previas residuales
    const imagePreview = document.getElementById('imagePreview');
    const documentsList = document.getElementById('documentsList');
    
    if (imagePreview) {
      imagePreview.innerHTML = '';
      // Forzar un pequeo delay para asegurar que el DOM se actualice
      setTimeout(() => { imagePreview.innerHTML = ''; }, 10);
    }
    
    if (documentsList) {
      documentsList.innerHTML = '';
      setTimeout(() => { documentsList.innerHTML = ''; }, 10);
    }
    
    //  RESETEAR BOTN DE GUARDAR (evitar que quede en estado "Guardando...")
    const btnGuardar = document.getElementById('btnGuardarRepuesto');
    const btnText = btnGuardar?.querySelector('.btn-text');
    const btnLoading = btnGuardar?.querySelector('.btn-loading');
    
    if (btnGuardar && btnText && btnLoading) {
      btnGuardar.disabled = false;
      btnGuardar.style.opacity = '1';
      btnGuardar.style.cursor = 'pointer';
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
    
    // Inicializar ubicaciones mltiples
    this.ubicacionesActuales = [];
    
    const formatDateTime = (value) => {
      if (!value) return null;
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return null;
      return date.toLocaleString('es-CL', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    };

    if (mode === 'edit' && id) {
      console.log(`\n Buscando repuesto con ID: "${id}" (tipo: ${typeof id})`);
      console.log(`Primeros 5 IDs disponibles:`, this.repuestos.slice(0, 5).map(r => `"${r.id}" (${typeof r.id})`));
      
      // BSQUEDA MULTI-FORMATO: Probar diferentes comparaciones
      let repuesto = this.repuestos.find(r => {
        // Normalizar ambos IDs a string para comparar
        const idStr = String(id).trim();
        const rIdStr = String(r.id).trim();
        
        // Comparacin estricta
        if (r.id === id) return true;
        
        // Comparacin tipo-flexible
        if (r.id == id) return true;
        
        // Comparacin de strings
        if (rIdStr === idStr) return true;
        
        // Comparacin sin espacios/caracteres especiales
        if (rIdStr.replace(/\s+/g, '') === idStr.replace(/\s+/g, '')) return true;
        
        return false;
      });
      
      // Si no se encuentra, intentar bsqueda por ndice (ltimo recurso)
      if (!repuesto && this.repuestos.length < 100) {
        console.warn(` ID no encontrado, mostrando todos los IDs disponibles:`);
        this.repuestos.forEach((r, idx) => {
          console.log(`  [${idx}] ID: "${r.id}" (${typeof r.id}) - ${r.nombre}`);
        });
      }
      
      if (repuesto) {
        console.log(` REPUESTO ENCONTRADO!`);
        console.log(`   Nombre: ${repuesto.nombre}`);
        console.log(`   ID: ${repuesto.id}`);
        console.log(`   Multimedia: ${repuesto.multimedia?.length || 0} items`);
        
        document.getElementById('repuestoId').value = repuesto.id;
        document.getElementById('codSAP').value = repuesto.codSAP || '';
        document.getElementById('codProv').value = repuesto.codProv || '';
        document.getElementById('tipo').value = repuesto.tipo || '';
        document.getElementById('categoria').value = repuesto.categoria || '';
        document.getElementById('nombre').value = repuesto.nombre || '';
        
        // 📍 CARGAR UBICACIONES del repuesto (si existen)
        if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones) && repuesto.ubicaciones.length > 0) {
          console.log('  📍 Cargando ubicaciones existentes:', repuesto.ubicaciones);
          this.ubicacionesActuales = repuesto.ubicaciones.map(ub => ({
            id: Date.now() + Math.random(),
            areaGeneral: ub.areaGeneral || '',
            subArea: ub.subArea || '',
            sistemaEquipo: ub.sistemaEquipo || '',
            subSistema: ub.subSistema || '',
            seccion: ub.seccion || '',
            subSeccion: ub.subSeccion || '',
            cantidadEnUbicacion: ub.cantidadEnUbicacion || 1
          }));
          // Renderizar ubicaciones asignadas
          this.renderUbicacionesAsignadas();
        } else {
          // Si no tiene ubicaciones, iniciar vacío
          console.log('  👁️ Sin ubicaciones - iniciar vacío');
          this.ubicacionesActuales = [];
        }
        
        // Renderizar árbol de jerarquía (con ubicación si existe)
        this.renderUbicacionesTreeSelector();
        
        document.getElementById('cantidad').value = repuesto.cantidad || 0;
        document.getElementById('cantidadInstalada').value = repuesto.cantidadInstalada || 0;
        document.getElementById('minimo').value = repuesto.minimo || repuesto.stockMinimo || 5;
        document.getElementById('optimo').value = repuesto.optimo || 10;
        document.getElementById('precio').value = repuesto.precio || 0;
        document.getElementById('datosTecnicos').value = repuesto.datosTecnicos || '';
        
        const multimediaOriginal = repuesto.multimedia || [];
        console.log(` [MODAL EDIT] Multimedia original:`, multimediaOriginal);
        
        if (multimediaOriginal.length > 0) {
          const multimediaNormalizada = multimediaOriginal.map((media, index) => this.normalizeMultimediaItem(media, index));
          repuesto.multimedia = multimediaNormalizada;
          
          console.log(` [MODAL EDIT] Multimedia normalizada:`, multimediaNormalizada);

          const isFileSystemMode = fsManager && fsManager.isFileSystemMode;
          
          this.currentMultimedia = multimediaNormalizada.filter(m => {
            if (!m || !m.type) return false;
            const tipo = m.type.toLowerCase();
            if (tipo !== 'image' && tipo !== 'video') return false;
            
            if (isFileSystemMode && typeof m.url === 'string' && m.url.startsWith('data:image')) {
              console.log(` Filtrando base64 antiguo de: ${repuesto.nombre}`);
              return false;
            }
            
            return true;
          });
          
          this.currentDocuments = multimediaNormalizada.filter(m => {
            if (!m || !m.type) return false;
            return m.type.toLowerCase() === 'document';
          });
          
          console.log(` Cargados: ${this.currentMultimedia.length} imgenes, ${this.currentDocuments.length} documentos`);
          console.log(` [MODAL EDIT] currentMultimedia:`, this.currentMultimedia);

          this.refreshModalMultimediaBadge();
          
          if (isFileSystemMode && this.currentMultimedia.length === 0 && multimediaNormalizada.some(m => m.type === 'image')) {
            console.log('INFO Todas las imgenes eran base64 y fueron filtradas. Agrega nuevas imgenes.');
          }
          
          await this.updateMultimediaPreview();
        } else {
          console.log(' Sin multimedia existente');
          this.refreshModalMultimediaBadge();
        }
      } else {
        console.error(` REPUESTO NO ENCONTRADO!`);
        console.error(`   ID buscado: "${id}" (tipo: ${typeof id})`);
        console.error(`   IDs existentes (primeros 10):`, this.repuestos.slice(0, 10).map(r => `"${r.id}" (${typeof r.id})`));
        this.showToast(' Error: Repuesto no encontrado', 'error');
      }
    } else {
      console.log(' Modo AGREGAR nuevo repuesto');
      // Inicializar con una ubicacin vaca
      this.agregarUbicacion();
      this.refreshModalMultimediaBadge();
    }
    
    document.getElementById('modal').classList.add('active');
    this.addEscapeListener();
    this.setupEnterNavigation();
    
    // Inicializar modal redimensionable y arrastrable
    setTimeout(() => {
      const modalContent = document.querySelector('.modal-content');
      if (modalContent && window.ModalResizable) {
        // Agregar clase para activar estilos de posicionamiento fijo
        modalContent.classList.add('is-resizable');
        
        this.modalResizableInstance = ModalResizable.init(modalContent, {
          minWidth: 900,
          minHeight: 500,
          draggable: true,
          resizable: true,
          persist: true,
          storageKey: 'modal-repuesto-state',
          onResize: (size) => {
            console.log('Modal redimensionado:', size);
          },
          onMove: (pos) => {
            console.log('Modal movido:', pos);
          }
        });
      }
    }, 50);
    
    // Ajustar ancho del modal segn ubicaciones (dar tiempo a que se renderice)
    setTimeout(() => {
      this.ajustarAnchoModal();
      // Inicializar wizard despus de que todo est renderizado
      this.setWizardStep(1, { focusFirstField: false });
    }, 120);
    
    // 🔄 SINCRONIZACIÓN: Emitir evento cuando se selecciona un repuesto
    if (mode === 'edit' && id && repuesto) {
      const nodoJerarquia = this.getNodoJerarquicoCompleto(repuesto);
      if (window.appEvents && nodoJerarquia) {
        window.appEvents.dispatchEvent(new CustomEvent('inventario-item-selected', {
          detail: { 
            equipoId: id,
            nodoJerarquia: nodoJerarquia,
            repuesto: repuesto
          }
        }));
        console.log(`📤 Evento emitido: inventario-item-selected (${nodoJerarquia})`);
      }
    }
    
    console.log('========== MODAL ABIERTO ==========\n');
  }

  closeModal() {
    // Limpiar estado multimedia al cerrar
    this.resetMultimediaState();
    
    // Destruir instancia de modal redimensionable si existe
    if (this.modalResizableInstance) {
      this.modalResizableInstance.destroy();
      this.modalResizableInstance = null;
    }
    
    // Remover clase de resizable
    const modalContent = document.querySelector('.modal-content');
    if (modalContent) {
      modalContent.classList.remove('is-resizable');
    }
    
    document.getElementById('modal').classList.remove('active');
    this.removeEscapeListener();
    this.removeEnterNavigation();
  }
  
  setupEnterNavigation() {
    const form = document.getElementById('repuestoForm');
    if (!form) return;
    
    // Obtener todos los elementos focusables del formulario
    const getFocusableElements = () => {
      return Array.from(form.querySelectorAll(
        'input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled])'
      )).filter(el => el.offsetParent !== null); // Solo elementos visibles
    };
    
    // Handler para Enter
    this.enterNavigationHandler = (e) => {
      // Solo actuar si es la tecla Enter
      if (e.key !== 'Enter') return;
      
      // Si es un textarea, permitir saltos de lnea con Enter
      if (e.target.tagName === 'TEXTAREA') return;
      
      // Prevenir el submit del formulario
      e.preventDefault();
      
      const focusableElements = getFocusableElements();
      const currentIndex = focusableElements.indexOf(e.target);
      
      if (currentIndex > -1 && currentIndex < focusableElements.length - 1) {
        // Ir al siguiente elemento
        focusableElements[currentIndex + 1].focus();
      } else {
        // Si es el ltimo campo, mantener el foco (no hacer submit)
        e.target.blur();
      }
    };
    
    // Agregar listener al formulario
    form.addEventListener('keydown', this.enterNavigationHandler);
  }
  
  removeEnterNavigation() {
    const form = document.getElementById('repuestoForm');
    if (form && this.enterNavigationHandler) {
      form.removeEventListener('keydown', this.enterNavigationHandler);
    }
  }

  // 
  // FUNCIN ELIMINADA: mostrarJerarquia() VIEJA + construirUbicacionCompleta()
  // Ahora se usa la versin con dendrograma SVG (lnea ~6577)
  // 

  // Actualizar preview de ubicacin en el formulario
  updateUbicacionPreview() {
    const area = document.getElementById('area').value.trim();
    const equipo = document.getElementById('equipo').value.trim();
    const sistema = document.getElementById('sistema').value;
    const detalle = document.getElementById('detalleUbicacion').value.trim();

    const preview = document.getElementById('ubicacionPreview');
    const previewText = document.getElementById('ubicacionPreviewText');

    const partes = [];
    if (area) partes.push(area);
    if (equipo) partes.push(equipo);
    if (sistema) partes.push(sistema);
    if (detalle) partes.push(detalle);

    if (partes.length > 0) {
      previewText.innerHTML = partes.map((parte, index) => {
        const icons = ['', '', '', ''];
        const icon = icons[index] || '';
        return `<span style="display: inline-flex; align-items: center; gap: 4px;"><span>${icon}</span><span>${parte}</span></span>`;
      }).join(' <span style="color: var(--primary); font-weight: bold;"></span> ');
      preview.style.display = 'block';
    } else {
      preview.style.display = 'none';
    }
  }

  // Cargar sistemas segn el equipo seleccionado (predefinidos + personalizados)
  cargarSistemasPorEquipo(equipo) {
    const datalist = document.getElementById('sistemaDatalist');
    if (!datalist) return;

    // Obtener sistemas predefinidos del catlogo
    let predefinidos = this.sistemaPorEquipo[equipo] || this.sistemaPorEquipo['default'];
    
    // Obtener sistemas personalizados del equipo (si existen)
    let personalizados = this.customSistemas[equipo] || [];
    
    // Combinar ambos arrays y eliminar duplicados
    let sistemasCompletos = [...predefinidos, ...personalizados];
    sistemasCompletos = [...new Set(sistemasCompletos)]; // Eliminar duplicados
    
    // Ordenar alfabticamente (opcional, mantiene "Otro" al final si existe)
    sistemasCompletos.sort((a, b) => {
      if (a === 'Otro') return 1;
      if (b === 'Otro') return -1;
      return a.localeCompare(b, 'es');
    });

    // Limpiar y llenar opciones del datalist
    datalist.innerHTML = '';
    sistemasCompletos.forEach(sistema => {
      const option = document.createElement('option');
      option.value = sistema;
      datalist.appendChild(option);
    });
    
    console.log(` Sistemas cargados para ${equipo}: ${sistemasCompletos.length} (${predefinidos.length} predefinidos + ${personalizados.length} personalizados)`);
  }

  async compressImageToBlob(file, maxWidth = 800, quality = 0.85) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          if (width > maxWidth || height > maxWidth) {
            if (width > height) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            } else {
              width = (width * maxWidth) / height;
              height = maxWidth;
            }
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, width, height);
          ctx.drawImage(img, 0, 0, width, height);

          // Convertir a Blob WebP
          canvas.toBlob((blob) => {
            if (blob) {
              console.log(`Blob WebP creado: ${(blob.size / 1024).toFixed(1)}KB`);
              resolve(blob);
            } else {
              console.error('Error creando blob');
              resolve(null);
            }
          }, 'image/webp', quality);
        };
        img.onerror = () => {
          console.error('Error cargando imagen para comprimir');
          resolve(null);
        };
        img.src = e.target.result;
      };
      reader.onerror = () => {
        console.error('Error leyendo archivo');
        resolve(null);
      };
      reader.readAsDataURL(file);
    });
  }

  async compressImage(file, maxWidth = 800, quality = 0.85) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          // Redimensionar manteniendo aspecto
          if (width > maxWidth || height > maxWidth) {
            if (width > height) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            } else {
              width = (width * maxWidth) / height;
              height = maxWidth;
            }
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          
          // MEJORA 1: Optimizacin de renderizado
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          
          // MEJORA 2: Fondo blanco para transparencias
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, width, height);
          
          // MEJORA 3: Dibujar imagen con suavizado
          ctx.drawImage(img, 0, 0, width, height);

          // MEJORA 4: Intentar WebP primero (mejor compresin)
          let compressedUrl = null;
          let format = 'webp';
          
          // Detectar soporte de WebP
          try {
            compressedUrl = canvas.toDataURL('image/webp', quality);
            
            // Si WebP no funciona o es muy grande, probar JPEG
            if (!compressedUrl.startsWith('data:image/webp') || compressedUrl.length > 120000) {
              format = 'jpeg';
              compressedUrl = canvas.toDataURL('image/jpeg', quality);
            }
          } catch (e) {
            // Fallback a JPEG si WebP no est soportado
            format = 'jpeg';
            compressedUrl = canvas.toDataURL('image/jpeg', quality);
          }

          // MEJORA 5: Optimizacin adaptativa de calidad
          let currentQuality = quality;
          let iterations = 0;
          const targetSize = 100000; // ~100KB objetivo
          
          while (compressedUrl.length > targetSize && currentQuality > 0.5 && iterations < 5) {
            currentQuality -= 0.08; // Reduccin ms gradual
            compressedUrl = canvas.toDataURL(`image/${format}`, currentQuality);
            iterations++;
          }
          
          // Log para debugging
          const finalSizeKB = (compressedUrl.length / 1024).toFixed(1);
          console.log(`Imagen comprimida: ${format.toUpperCase()}, ${finalSizeKB}KB, calidad: ${(currentQuality * 100).toFixed(0)}%`);

          resolve(compressedUrl);
        };
        img.onerror = () => {
          console.error('Error cargando imagen para comprimir');
          resolve(null);
        };
        img.src = e.target.result;
      };
      reader.onerror = () => {
        console.error('Error leyendo archivo');
        resolve(null);
      };
      reader.readAsDataURL(file);
    });
  }

  // ========================================
  // OPTIMIZADOR DE IMGENES INTERACTIVO
  // ========================================
  currentImageFile = null;
  currentOptimizeSize = 1200;
  currentQuality = 0.85;
  
  async handleImageWithOptimizer(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    // Si hay mltiples archivos, procesarlos uno por uno
    for (const file of files) {
      await this.showOptimizerModal(file);
    }
    
    // Limpiar el input para permitir seleccionar las mismas imgenes
    this.resetFileInput();
  }
  
  async showOptimizerModal(file) {
    this.currentImageFile = file;
    
    return new Promise((resolve) => {
      const modal = document.getElementById('optimizerModal');
      const originalImg = document.getElementById('optimizerOriginal');
      const optimizedImg = document.getElementById('optimizerOptimized');
      const originalSize = document.getElementById('originalSize');
      const originalDimensions = document.getElementById('originalDimensions');
      
      modal.classList.add('active');
      
      // Cargar imagen original
      const reader = new FileReader();
      reader.onload = async (e) => {
        const img = new Image();
        img.onload = async () => {
          originalImg.src = e.target.result;
          originalSize.textContent = `Tamao: ${(file.size / 1024).toFixed(1)} KB`;
          originalDimensions.textContent = `${img.width}  ${img.height} px`;
          
          // Generar preview optimizada inicial
          await this.updateOptimizedPreview(e.target.result, img.width, img.height);
          
          this.optimizerResolve = resolve;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  }
  
  async updateOptimizedPreview(originalDataUrl, originalWidth, originalHeight) {
    const optimizedImg = document.getElementById('optimizerOptimized');
    const optimizedSize = document.getElementById('optimizedSize');
    const optimizedDimensions = document.getElementById('optimizedDimensions');
    const savingsBadge = document.getElementById('savingsBadge');
    
    // Crear canvas
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      // Calcular nuevas dimensiones
      let width = originalWidth;
      let height = originalHeight;
      
      if (this.currentOptimizeSize !== 'original') {
        const maxSize = this.currentOptimizeSize;
        if (width > maxSize || height > maxSize) {
          if (width > height) {
            height = (height / width) * maxSize;
            width = maxSize;
          } else {
            width = (width / height) * maxSize;
            height = maxSize;
          }
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      
      // Convertir a WebP con calidad especificada
      const optimizedDataUrl = canvas.toDataURL('image/webp', this.currentQuality);
      optimizedImg.src = optimizedDataUrl;
      
      // Calcular tamaos
      const optimizedSizeBytes = optimizedDataUrl.length * 0.75; // Aproximado
      const originalSizeBytes = this.currentImageFile.size;
      const savings = ((originalSizeBytes - optimizedSizeBytes) / originalSizeBytes * 100).toFixed(1);
      
      optimizedSize.textContent = `Tamao: ${(optimizedSizeBytes / 1024).toFixed(1)} KB`;
      optimizedDimensions.textContent = `${Math.round(width)}  ${Math.round(height)} px`;
      savingsBadge.innerHTML = `Ahorro: <strong>${savings}%</strong>`;
      savingsBadge.style.background = savings > 50 ? 'var(--success)' : savings > 30 ? 'var(--warning)' : 'var(--danger)';
      
      // Guardar para uso posterior
      this.currentOptimizedDataUrl = optimizedDataUrl;
    };
    
    img.src = originalDataUrl;
  }
  
  setOptimizeSize(size) {
    this.currentOptimizeSize = size;
    
    // Actualizar botones activos
    document.querySelectorAll('.size-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.size == size) {
        btn.classList.add('active');
      }
    });
    
    // Regenerar preview
    const originalImg = document.getElementById('optimizerOriginal');
    if (originalImg.src) {
      const img = new Image();
      img.onload = () => {
        this.updateOptimizedPreview(originalImg.src, img.width, img.height);
      };
      img.src = originalImg.src;
    }
  }
  
  updateQuality(value) {
    this.currentQuality = value / 100;
    document.getElementById('qualityValue').textContent = value + '%';
    
    // Regenerar preview
    const originalImg = document.getElementById('optimizerOriginal');
    if (originalImg.src) {
      const img = new Image();
      img.onload = () => {
        this.updateOptimizedPreview(originalImg.src, img.width, img.height);
      };
      img.src = originalImg.src;
    }
  }
  
  async applyOptimization() {
    const modal = document.getElementById('optimizerModal');
    modal.classList.remove('active');
    
    // Convertir dataURL a Blob
    const blob = await this.dataURLtoBlob(this.currentOptimizedDataUrl);
    
    // Agregar a multimedia
    if (!this.currentMultimedia) this.currentMultimedia = [];
    
    //  CORRECCIN: Usar la variable global fsManager
    const isFileSystemMode = fsManager && fsManager.isFileSystemMode;
    
    console.log(` [OPTIMIZER] isFileSystemMode: ${isFileSystemMode}`);
    console.log(` [OPTIMIZER] currentMultimedia.length: ${this.currentMultimedia.length}`);
    
    if (isFileSystemMode) {
      // Guardar en FileSystem
      const timestamp = Date.now();
      const codSAP = document.getElementById('codSAP')?.value || 'SAP';
      const nombreRepuesto = document.getElementById('nombre')?.value || 'REPUESTO';
      const imageIndex = this.currentMultimedia.length + 1;
      
      const cleanCodSAP = codSAP.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
      const cleanNombre = nombreRepuesto.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
      const filename = `${timestamp}_${cleanCodSAP}_${cleanNombre}_foto${imageIndex}.webp`;
      
      console.log(` Guardando en FileSystem: ${filename}`);
      const imagePath = await fsManager.saveImage(blob, filename);
      
      if (imagePath) {
        const newImage = {
          type: 'image',
          url: imagePath,
          name: this.currentImageFile.name,
          size: blob.size,
          isFileSystem: true
        };
        console.log(` Imagen guardada en: ${imagePath}`);
        console.log(` Objeto a agregar:`, newImage);
        this.currentMultimedia.push(newImage);
      } else {
        console.error(' fsManager.saveImage retorn null/undefined');
      }
    } else {
      // Guardar en IndexedDB o memoria
      console.log(` Guardando en memoria/IndexedDB`);
      const blobUrl = URL.createObjectURL(blob);
      const newImage = {
        type: 'image',
        url: this.currentOptimizedDataUrl,
        name: this.currentImageFile.name,
        size: blob.size,
        blob: blob
      };
      console.log(` Imagen en memoria, agregando a currentMultimedia:`, newImage);
      this.currentMultimedia.push(newImage);
    }
    
    console.log(` Total imgenes en currentMultimedia: ${this.currentMultimedia.length}`);
    console.log(` Actualizando preview...`);
    await this.updateMultimediaPreview();
    this.showToast(`Imagen optimizada agregada (${(blob.size / 1024).toFixed(1)} KB)`, 'success');
    
    // ℹ️ La sincronización se hará al guardar el repuesto (botón Guardar)
    
    if (this.optimizerResolve) {
      this.optimizerResolve();
    }
  }
  
  skipOptimization() {
    const modal = document.getElementById('optimizerModal');
    modal.classList.remove('active');
    
    // Usar imagen original sin optimizar
    const reader = new FileReader();
    reader.onload = async (e) => {
      if (!this.currentMultimedia) this.currentMultimedia = [];
      
      const isFileSystemMode = fsManager && fsManager.isFileSystemMode;
      
      if (isFileSystemMode) {
        const timestamp = Date.now();
        const codSAP = document.getElementById('codSAP')?.value || 'SAP';
        const nombreRepuesto = document.getElementById('nombre')?.value || 'REPUESTO';
        const imageIndex = this.currentMultimedia.length + 1;
        
        const cleanCodSAP = codSAP.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
        const cleanNombre = nombreRepuesto.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
        const ext = this.currentImageFile.name.split('.').pop();
        const filename = `${timestamp}_${cleanCodSAP}_${cleanNombre}_foto${imageIndex}.${ext}`;
        
        const imagePath = await fsManager.saveImage(this.currentImageFile, filename);
        
        if (imagePath) {
          this.currentMultimedia.push({
            type: 'image',
            url: imagePath,
            name: this.currentImageFile.name,
            size: this.currentImageFile.size,
            isFileSystem: true
          });
        }
      } else {
        this.currentMultimedia.push({
          type: 'image',
          url: e.target.result,
          name: this.currentImageFile.name,
          size: this.currentImageFile.size,
          blob: this.currentImageFile
        });
      }
      
      await this.updateMultimediaPreview();
      this.showToast('Imagen original agregada', 'info');
      
      // ℹ️ La sincronización se hará al guardar el repuesto (botón Guardar)
      
      if (this.optimizerResolve) {
        this.optimizerResolve();
      }
    };
    reader.readAsDataURL(this.currentImageFile);
  }
  
  closeOptimizer() {
    const modal = document.getElementById('optimizerModal');
    modal.classList.remove('active');
    
    if (this.optimizerResolve) {
      this.optimizerResolve();
    }
  }
  
  dataURLtoBlob(dataURL) {
    return new Promise((resolve) => {
      const arr = dataURL.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      resolve(new Blob([u8arr], { type: mime }));
    });
  }
  
  // updateImagePreview() ELIMINADA - Usar updateMultimediaPreview() en su lugar

  async handleMultimedia(event, type) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    if (type === 'image') {
      if (!this.currentMultimedia) this.currentMultimedia = [];
      
      const preview = document.getElementById('imagePreview');
      const isFileSystemMode = fsManager && fsManager.isFileSystemMode;
      const isMobileMode = this.storageMode === 'indexeddb';
      
      // Mensaje segn el modo de almacenamiento
      let modeMessage = 'Optimizando imgenes...';
      if (isFileSystemMode) modeMessage = 'Guardando en carpeta...';
      else if (isMobileMode) modeMessage = ' Guardando en IndexedDB...';
      
      preview.innerHTML = `<div style="padding: 16px; color: var(--primary); font-weight: 600;"> ${modeMessage}</div>`;

      if (files.length > 5) {
        this.showToast(`Procesando ${files.length} imgenes...`, 'info');
      }

      console.log(`\n${'='.repeat(60)}`);
      console.log(` Procesando ${files.length} imgenes nuevas`);
      console.log(` Modo de almacenamiento: ${this.storageMode.toUpperCase()}`);
      console.log(` FileSystem activo: ${isFileSystemMode ? 'S' : 'NO'}`);
      console.log(` Imgenes existentes: ${this.currentMultimedia.length}`);

      let totalOriginalSize = 0;
      let totalCompressedSize = 0;
      let successCount = 0;

      for (const file of files) {
        try {
          console.log(` ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
          totalOriginalSize += file.size;
          
          // ===================================================================
          // MODO 1: FILESYSTEM (PC con Edge - Almacenamiento ilimitado)
          // SIMPLIFICADO: Todo en carpeta plana con nombres descriptivos
          // ===================================================================
          if (isFileSystemMode) {
            const compressedBlob = await this.compressImageToBlob(file);
            if (compressedBlob) {
              // Generar nombre descriptivo
              const timestamp = Date.now();
              const codSAP = document.getElementById('codSAP')?.value || 'SAP';
              const nombreRepuesto = document.getElementById('nombre')?.value || 'REPUESTO';
              const imageIndex = this.currentMultimedia.length + 1;
              
              // Nombre: timestamp_CODSAP_nombre_foto1.webp
              const cleanCodSAP = codSAP.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
              const cleanNombre = nombreRepuesto.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
              const filename = `${timestamp}_${cleanCodSAP}_${cleanNombre}_foto${imageIndex}.webp`;
              
              // Guardar directamente en carpeta raz de imgenes
              const imagePath = await this.fsManager.saveImage(compressedBlob, filename);
              console.log(` FileSystem: ${filename} (${(compressedBlob.size / 1024).toFixed(0)}KB)`);
              
              let fullPath = imagePath;
              
              if (imagePath) {
                //  EVITAR DUPLICADOS: Verificar si la imagen ya existe de forma ms robusta
                const yaExiste = this.currentMultimedia.some(img => {
                  // Comparar por nombre de archivo (principal)
                  if (img.name === file.name) return true;
                  
                  // Comparar por ruta para FileSystem
                  if (img.url === imagePath) return true;
                  
                  // Comparar por tamao y nombre base (backup)
                  const sameSize = Math.abs(img.size - compressedBlob.size) < 1000; // tolerancia 1KB
                  const sameName = img.name && file.name && 
                    img.name.toLowerCase().replace(/\.[^/.]+$/, "") === file.name.toLowerCase().replace(/\.[^/.]+$/, "");
                  
                  return sameSize && sameName;
                });
                
                if (!yaExiste) {
                  this.currentMultimedia.push({
                    type: 'image',
                    url: imagePath,
                    name: file.name,
                    size: compressedBlob.size,
                    isFileSystem: true
                  });
                  totalCompressedSize += compressedBlob.size;
                  successCount++;
                  console.log(` Imagen agregada: ${imagePath}`);
                } else {
                  console.log(` Imagen ya existe, ignorando: ${imagePath}`);
                }
              }
            }
          } 
          // ===================================================================
          // MODO 2: INDEXEDDB (Mvil - Lmite ~50-100MB)
          // ===================================================================
          else if (isMobileMode) {
            const compressedBlob = await this.compressImageToBlob(file);
            if (compressedBlob) {
              const timestamp = Date.now();
              const cleanName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
              const imageId = `img_${timestamp}_${cleanName}`;
              const repuestoId = this.currentEditingId || 'temp';
              
              // Guardar en IndexedDB
              await indexedDBManager.saveImage(imageId, repuestoId, compressedBlob);
              
              //  EVITAR DUPLICADOS: Verificar si la imagen ya existe de forma ms robusta
              const yaExiste = this.currentMultimedia.some(img => {
                // Comparar por ID de IndexedDB
                if (img.url === imageId) return true;
                
                // Comparar por nombre de archivo
                if (img.name === file.name) return true;
                
                // Comparar por tamao y nombre base (backup)
                const sameSize = Math.abs(img.size - compressedBlob.size) < 1000; // tolerancia 1KB
                const sameName = img.name && file.name && 
                  img.name.toLowerCase().replace(/\.[^/.]+$/, "") === file.name.toLowerCase().replace(/\.[^/.]+$/, "");
                
                return sameSize && sameName;
              });
              
              if (!yaExiste) {
                this.currentMultimedia.push({
                  type: 'image',
                  url: imageId, // ID para recuperar de IndexedDB
                  name: file.name,
                  size: compressedBlob.size,
                  isIndexedDB: true
                });
                totalCompressedSize += compressedBlob.size;
                successCount++;
                console.log(` IndexedDB: ${imageId} (${(compressedBlob.size / 1024).toFixed(0)}KB)`);
              } else {
                console.log(` Imagen ya existe en IndexedDB, ignorando: ${imageId}`);
              }
            }
          } 
          // ===================================================================
          // MODO 3: LOCALSTORAGE (Fallback - Lmite ~5-10MB)
          // ===================================================================
          else {
            const compressedUrl = await this.compressImage(file);
            
            if (compressedUrl) {
              //  EVITAR DUPLICADOS: Verificar si la imagen ya existe de forma ms robusta
              const yaExiste = this.currentMultimedia.some(img => {
                // Comparar por nombre de archivo (principal para localStorage)
                if (img.name === file.name) return true;
                
                // Comparar por tamao similar (para detectar misma imagen comprimida)
                const sameSize = Math.abs((img.size || 0) - compressedUrl.length) < 5000; // tolerancia 5KB
                const sameName = img.name && file.name && 
                  img.name.toLowerCase().replace(/\.[^/.]+$/, "") === file.name.toLowerCase().replace(/\.[^/.]+$/, "");
                
                return sameSize && sameName;
              });
              
              if (!yaExiste) {
                totalCompressedSize += compressedUrl.length;
                
                this.currentMultimedia.push({
                  type: 'image',
                  url: compressedUrl,
                  name: file.name,
                  size: compressedUrl.length
                });
                successCount++;
                console.log(` LocalStorage: ${(compressedUrl.length / 1024).toFixed(0)}KB`);
              } else {
                console.log(` Imagen ya existe en LocalStorage, ignorando: ${file.name}`);
              }
            }
          }
        } catch (error) {
          console.error(' Error procesando imagen:', error);
          this.showToast(` Error con ${file.name}`, 'error');
        }
      }
      
      // Calcular reduccin de tamao
      const reduction = ((1 - totalCompressedSize / totalOriginalSize) * 100).toFixed(0);
      const finalSizeMB = (totalCompressedSize / (1024 * 1024)).toFixed(2);
      
      console.log(` ${(totalOriginalSize / (1024 * 1024)).toFixed(2)}MB  ${finalSizeMB}MB (-${reduction}%)`);
      console.log(` ${successCount}/${files.length} guardadas - Total: ${this.currentMultimedia.length}`);
      console.log(`${'='.repeat(60)}\n`);
      
      // Limpiar input para permitir mismos archivos
      this.resetFileInput();
      
      await this.updateMultimediaPreview();
      
      const modeLabel = isMobileMode ? ' Mvil' : isFileSystemMode ? ' PC' : ' Local';
      this.showToast(` ${successCount} imagen(es) guardadas [${modeLabel}] - Total: ${this.currentMultimedia.length}`, 'success');
    } else if (type === 'document') {
      if (!this.currentDocuments) this.currentDocuments = [];
      
      console.log(`Procesando ${files.length} documentos`);
      console.log(` Documentos existentes: ${this.currentDocuments.length}`);
      
      let pendingLoads = files.length;
      let addedCount = 0;
      
      files.forEach(file => {
        if (file.size > 4 * 1024 * 1024) {
          this.showToast(` ${file.name} muy grande (mx 4MB)`, 'error');
          pendingLoads--;
          if (pendingLoads === 0) {
            this.refreshModalMultimediaBadge();
          }
          return;
        }

        console.log(` ${file.name} (${(file.size / 1024).toFixed(0)}KB)`);
        const reader = new FileReader();
        reader.onload = (e) => {
          this.currentDocuments.push({
            type: 'document',
            url: e.target.result,
            name: file.name,
            size: file.size,
            mimeType: file.type
          });
          addedCount++;
          console.log(` Documento agregado: ${file.name}`);
          pendingLoads--;
          
          if (pendingLoads === 0) {
            console.log(` Total: ${this.currentDocuments.length} documentos`);
            this.showToast(` ${addedCount} documento(s) agregado(s) - Total: ${this.currentDocuments.length}`, 'success');
            this.refreshModalMultimediaBadge();
          }
        };
        reader.readAsDataURL(file);
      });
      
      if (pendingLoads <= 0) {
        this.refreshModalMultimediaBadge();
      }

      // Limpiar input
      this.resetFileInput();
    }
  }

  refreshModalMultimediaBadge() {
    const badge = document.getElementById('modalMultimediaCount');
    if (!badge) return;

    const images = (this.currentMultimedia || []).filter(media => media.type === 'image').length;
    const documents = (this.currentDocuments || []).length;
    const total = images + documents;

    if (total === 0) {
      badge.textContent = 'Sin archivos';
      badge.classList.add('sap-meta-chip--empty');
      return;
    }

    const detail = [];
    if (images) detail.push(`${images} img`);
    if (documents) detail.push(`${documents} doc`);

    let label;
    if (total === 1) {
      label = images ? '1 archivo (1 img)' : '1 archivo (1 doc)';
    } else {
      label = `${total} archivos`;
      if (detail.length) {
        label += ` (${detail.join('  ')})`;
      }
    }

    badge.textContent = label;
    badge.classList.remove('sap-meta-chip--empty');
  }

  async updateMultimediaPreview(message = null) {
    const preview = document.getElementById('imagePreview');
    if (!preview) {
      console.warn(' Elemento imagePreview no encontrado');
      return;
    }

    if (message) {
      preview.innerHTML = `<div style="padding: 16px; color: var(--primary); font-weight: 600;"> ${message}</div>`;
      return;
    }

    if (!this.currentMultimedia || this.currentMultimedia.length === 0) {
      console.log(' No hay imgenes para mostrar');
      preview.innerHTML = '<div style="padding: 16px; color: var(--text-secondary); font-size: 0.85rem;"> No hay imgenes cargadas. Usa el botn "Click para seleccionar imgenes" arriba.</div>';
      this.refreshModalMultimediaBadge();
      return;
    }

    console.log(` [PREVIEW] Mostrando ${this.currentMultimedia.length} imgenes`);

    //  DEDUPLICAR
    const multimediaUnica = [];
    const urlsVistas = new Set();
    
    this.currentMultimedia.forEach(media => {
      const key = media.url || media.name || Math.random();
      if (!urlsVistas.has(key)) {
        urlsVistas.add(key);
        multimediaUnica.push(media);
      }
    });
    
    this.currentMultimedia = multimediaUnica;

    //  CARGAR IMGENES CON MEJOR MANEJO DE ERRORES
    const imageCards = [];
    
    for (let idx = 0; idx < this.currentMultimedia.length; idx++) {
      const media = this.currentMultimedia[idx];
      console.log(` [${idx}] Procesando:`, {
        type: media.type,
        url: media.url?.substring(0, 60) + '...',
        isFileSystem: media.isFileSystem,
        name: media.name
      });
      
      try {
        const imageUrl = await this.getImageUrl(media);
        
        if (!imageUrl) {
          console.warn(` [${idx}] No se obtuvo URL`);
          imageCards.push(`
            <div style="position: relative; display: inline-block; margin: 5px; width: 120px; height: 120px; background: rgba(255,0,0,0.1); border-radius: 8px; border: 2px dashed var(--danger); display: flex; align-items: center; justify-content: center;">
              <div style="text-align: center; font-size: 0.7rem; color: var(--danger);">
                <div style="font-size: 1.5rem;"></div>
                <div>Error</div>
              </div>
            </div>
          `);
          continue;
        }
        
        console.log(` [${idx}] URL obtenida: ${imageUrl.substring(0, 50)}...`);
        
        const sizeKB = media.size ? (media.size / 1024).toFixed(0) : '??';
        const format = imageUrl.includes('.webp') || imageUrl.startsWith('data:image/webp') || imageUrl.startsWith('blob:') ? 'WebP' : 'JPEG';
        const badgeColor = format === 'WebP' ? 'var(--success)' : 'var(--info)';
        
        imageCards.push(`
          <div style="position: relative; display: inline-block; margin: 5px;">
            <img src="${imageUrl}" 
                 style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid var(--gray-300); box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                 onload="console.log(' [IMG] Cargada en DOM: ${media.name || 'img-' + idx}')"
                 onerror="console.error(' [IMG] Error en DOM:', this.src.substring(0,50)); this.style.border='2px solid red';">
            <button onclick="app.removeMultimedia(${idx})" type="button" 
                    style="position: absolute; top: 4px; right: 4px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); line-height: 1;"></button>
            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 4px 6px; border-radius: 4px; font-size: 0.7rem; display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: 600;">${sizeKB}KB</span>
              <span style="background: ${badgeColor}; padding: 2px 6px; border-radius: 3px; font-size: 0.65rem; font-weight: 700;">${format}</span>
            </div>
          </div>
        `);
        
      } catch (error) {
        console.error(` [${idx}] Error procesando imagen:`, error);
        // No mostrar card de error, simplemente omitir la imagen
      }
    }

    if (imageCards.length === 0) {
      preview.innerHTML = '<div style="padding: 16px; color: var(--danger); font-size: 0.85rem;"> No se pudieron cargar las imgenes.</div>';
      console.error(' [PREVIEW] Ninguna imagen pudo ser cargada');
    } else {
      preview.innerHTML = imageCards.join('');
      console.log(` [PREVIEW] Actualizado con ${imageCards.length} imgenes`);
    }

    this.refreshModalMultimediaBadge();
  }

  // ====================================================================
  // SISTEMA DE SINCRONIZACIÓN MULTIMEDIA ENTRE PESTAÑAS
  // ====================================================================
  
  /**
   * Despacha evento de cambio de multimedia para sincronizar entre pestañas
   * @param {string} repuestoId - ID del repuesto modificado
   * @param {string} action - 'add' | 'remove' | 'update'
   * @param {Array} multimedia - Array actualizado de multimedia
   */
  dispatchMultimediaChange(repuestoId, action, multimedia) {
    console.log(` [SYNC] Despachando evento multimedia-changed:`, { repuestoId, action, count: multimedia.length });
    
    const event = new CustomEvent('multimedia-changed', {
      detail: {
        repuestoId,
        action,
        multimedia: JSON.parse(JSON.stringify(multimedia)), // Clone profundo
        timestamp: Date.now()
      },
      bubbles: true
    });
    
    document.dispatchEvent(event);
  }

  /**
   * Sincroniza multimedia en todas las pestañas cuando hay un cambio
   * @param {string} repuestoId - ID del repuesto a actualizar
   * @param {Array} nuevoArrayMultimedia - Nuevo array de multimedia
   */
  async syncMultimediaAcrossTabs(repuestoId, nuevoArrayMultimedia) {
    if (!repuestoId) {
      console.warn(` [SYNC] No se puede sincronizar sin repuestoId`);
      return;
    }

    console.log(` [SYNC] Sincronizando multimedia para repuesto ${repuestoId} en todas las pestañas`);
    
    // 1. Actualizar en el array principal de repuestos
    const repuesto = this.repuestos.find(r => r.id === repuestoId);
    if (repuesto) {
      repuesto.multimedia = JSON.parse(JSON.stringify(nuevoArrayMultimedia));
      console.log(` [SYNC] Actualizado array principal: ${repuesto.multimedia.length} imágenes`);
    }

    // 2. Actualizar TAB INVENTARIO (cards grid)
    await this.syncInventarioTab(repuestoId, nuevoArrayMultimedia);

    // 3. Actualizar TAB JERARQUÍA (árbol)
    await this.syncJerarquiaTab(repuestoId, nuevoArrayMultimedia);

    // 4. Actualizar TAB MAPA (marcadores)
    await this.syncMapaTab(repuestoId, nuevoArrayMultimedia);
    
    console.log(` [SYNC] Sincronización completada para ${repuestoId}`);
  }

  /**
   * Actualiza el card específico en la pestaña Inventario sin re-renderizar todo
   */
  async syncInventarioTab(repuestoId, multimedia) {
    const card = document.querySelector(`.repuesto-card [data-id="${repuestoId}"]`)?.closest('.repuesto-card');
    if (!card) {
      console.log(` [SYNC-INV] Card no visible actualmente (paginación)`);
      return;
    }

    console.log(` [SYNC-INV] Actualizando card para ${repuestoId}`);
    
    // Actualizar imagen principal
    const cardImage = card.querySelector('.card-image img');
    const noImageDiv = card.querySelector('.card-image .no-image');
    const counterBadge = card.querySelector('.card-image > div[style*="position: absolute"]');
    
    if (multimedia.length > 0) {
      const firstImageUrl = await this.getFirstImage(multimedia);
      if (firstImageUrl && cardImage) {
        cardImage.src = firstImageUrl;
        cardImage.style.display = 'block';
        if (noImageDiv) noImageDiv.style.display = 'none';
      }
      
      // Actualizar contador
      if (multimedia.length > 1) {
        if (counterBadge) {
          counterBadge.textContent = `+${multimedia.length - 1}`;
        } else {
          // Crear contador si no existe
          const badge = document.createElement('div');
          badge.style = 'position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;';
          badge.textContent = `+${multimedia.length - 1}`;
          card.querySelector('.card-image').appendChild(badge);
        }
      } else if (counterBadge) {
        counterBadge.remove();
      }
    } else {
      // Sin imágenes
      if (cardImage) cardImage.style.display = 'none';
      if (noImageDiv) noImageDiv.style.display = 'flex';
      if (counterBadge) counterBadge.remove();
    }
    
    console.log(` [SYNC-INV] Card actualizado: ${multimedia.length} imágenes`);
  }

  /**
   * Actualiza contador de imágenes en nodos del árbol de jerarquía
   * Y expande/resalta el nodo si se guardó una ubicación
   */
  async syncJerarquiaTab(repuestoId, multimedia, ubicaciones = null) {
    console.log(` [SYNC-JER] Sincronizando Tab Jerarquía - ${repuestoId}: ${multimedia?.length || 0} imágenes`);
    
    // Si la pestaña Jerarquía está activa, forzar re-renderizado
    if (this.currentTab === 'jerarquia') {
      console.log(` [SYNC-JER] Pestaña Jerarquía activa, re-renderizando árbol...`);
      try {
        if (typeof this.renderJerarquiaTree === 'function') {
          await this.renderJerarquiaTree();
          console.log(` [SYNC-JER] Árbol actualizado correctamente`);
          
          // Si hay ubicaciones, expandir y resaltar el nodo
          if (ubicaciones && ubicaciones.length > 0) {
            this.expandAndHighlightJerarquiaNode(ubicaciones[0]);
          }
        }
      } catch (error) {
        console.error(` [SYNC-JER] Error actualizando árbol:`, error);
      }
    } else {
      console.log(` [SYNC-JER] El árbol se actualizará al cambiar a la pestaña Jerarquía`);
    }
  }
  
  /**
   * Expande el árbol de jerarquía hasta el nodo especificado y lo resalta temporalmente
   */
  expandAndHighlightJerarquiaNode(ubicacion) {
    console.log('🎯 [JERARQUIA] Expandiendo y resaltando nodo:', ubicacion);
    
    const container = document.getElementById('jerarquiaTreeContainer');
    if (!container) {
      console.warn('❌ Container jerarquiaTreeContainer no encontrado');
      return;
    }
    
    // Construir path de nombres a expandir
    const pathToExpand = [];
    if (ubicacion.areaGeneral) pathToExpand.push(ubicacion.areaGeneral);
    if (ubicacion.subArea) pathToExpand.push(ubicacion.subArea);
    if (ubicacion.sistemaEquipo) pathToExpand.push(ubicacion.sistemaEquipo);
    if (ubicacion.subSistema) pathToExpand.push(ubicacion.subSistema);
    if (ubicacion.seccion) pathToExpand.push(ubicacion.seccion);
    
    console.log('  📍 Path a expandir:', pathToExpand);
    
    if (pathToExpand.length === 0) {
      console.warn('  ⚠️ No hay path para expandir');
      return;
    }
    
    const lastInPath = pathToExpand[pathToExpand.length - 1];
    
    // Expandir todos los nodos del path
    pathToExpand.forEach(nodeName => {
      const nodes = container.querySelectorAll('.jerarquia-node-name');
      nodes.forEach(nameElement => {
        if (nameElement.textContent.trim() === nodeName) {
          const nodeContent = nameElement.closest('.jerarquia-node-content');
          if (!nodeContent) return;
          
          const toggle = nodeContent.querySelector('.jerarquia-node-toggle');
          const treeNode = nodeContent.closest('.jerarquia-tree-node');
          if (!treeNode) return;
          
          const children = treeNode.querySelector('.jerarquia-node-children');
          
          if (children && toggle) {
            // Expandir nodo
            children.style.display = 'block';
            toggle.textContent = '▼';
            console.log(`    ✅ Expandido: ${nodeName}`);
            
            // Si es el último nodo del path, resaltarlo temporalmente
            if (nodeName === lastInPath) {
              console.log(`    🎯 Resaltando nodo final: ${nodeName}`);
              
              // Agregar clase de resaltado
              nodeContent.classList.add('node-just-saved');
              
              // Scroll para hacer visible el nodo
              setTimeout(() => {
                nodeContent.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 100);
              
              // Remover resaltado después de 2 segundos
              setTimeout(() => {
                nodeContent.classList.remove('node-just-saved');
                console.log(`    ✨ Resaltado removido de: ${nodeName}`);
              }, 2000);
            }
          }
        }
      });
    });
  }

  /**
   * Actualiza tooltips/info de marcadores en el mapa
   */
  async syncMapaTab(repuestoId, multimedia) {
    console.log(` [SYNC-MAP] Multimedia actualizada para ${repuestoId}: ${multimedia.length} imágenes`);
    
    // Si la pestaña Mapa está activa, actualizar marcadores visibles
    if (this.currentTab === 'mapa') {
      console.log(` [SYNC-MAP] Pestaña Mapa activa, actualizando marcadores...`);
      try {
        // Verificar si mapManager existe y tiene método de actualización
        if (typeof mapManager !== 'undefined' && typeof mapManager.redrawCanvas === 'function') {
          mapManager.redrawCanvas();
          console.log(` [SYNC-MAP] Marcadores actualizados correctamente`);
        }
      } catch (error) {
        console.error(` [SYNC-MAP] Error actualizando marcadores:`, error);
      }
    } else {
      console.log(` [SYNC-MAP] Los marcadores se actualizarán al cambiar a la pestaña Mapa`);
    }
  }

  async removeMultimedia(index) {
    if (!this.currentMultimedia || !this.currentMultimedia[index]) {
      console.warn(` [REMOVE] Índice inválido: ${index}`);
      return;
    }

    const media = this.currentMultimedia[index];
    console.log(` [REMOVE] Marcando imagen para eliminación:`, media.name || media.url?.substring(0, 50));
    
    // Si es imagen existente en FileSystem, marcar para eliminación física
    if (media.isFileSystem && media.url) {
      this.pendingDeletions.push(media.url);
      console.log(` [REMOVE] Agregada a pendingDeletions: ${media.url}`);
      console.log(` [REMOVE] Total pendientes: ${this.pendingDeletions.length}`);
    }
    
    // Eliminar del array temporal
    this.currentMultimedia.splice(index, 1);
    console.log(` [REMOVE] Eliminada de currentMultimedia. Total: ${this.currentMultimedia.length}`);
    
    // Actualizar preview visual
    await this.updateMultimediaPreview();
    
    // Resetear input para permitir agregar nuevas imágenes
    this.resetFileInput();
    
    // ℹ️ La sincronización se hará al guardar el repuesto (botón Guardar)
    // NO guardar ni eliminar archivo físico aún - esperar botón "Guardar"
    this.showToast(' Imagen marcada para eliminar (presiona Guardar para confirmar)', 'info');
  }

  sincronizarUbicacionesDesdeDOM() {
    if (!Array.isArray(this.ubicacionesActuales)) return;

    console.debug(' Sincronizando ubicaciones con el DOM (wizard)...');

    this.ubicacionesActuales.forEach((ubicacion, idx) => {
      if (!ubicacion || !ubicacion.id) return;

      const inputs = document.querySelectorAll(`[data-ubicacion-id="${ubicacion.id}"]`);
      inputs.forEach(input => {
        const field = input.dataset.field;
        if (!field) return;
        ubicacion[field] = input.value;
        console.debug(`   Ubicacin ${idx + 1} - ${field}: "${input.value}"`);
      });
    });
  }

  async saveRepuesto(e, forceValidation = false) {
    // preventDefault solo si el evento existe (form submit vs click)
    if (e && e.preventDefault) {
      e.preventDefault();
    }
    
    // 🔴 Si forceValidation=true, saltar wizard y guardar inmediatamente (desde botones Steps)
    if (forceValidation) {
      console.log('💾 [SAVE] Guardado forzado desde Step - saltando validación wizard');
      // Continuar al código de guardado (saltar validación wizard)
    } else if (this.wizardState && this.wizardState.totalSteps) {
      const totalWizardSteps = this.wizardState.totalSteps;
      const currentWizardStep = this.wizardState.currentStep || 1;

      if (currentWizardStep < totalWizardSteps) {
        if (this.validateWizardStep(currentWizardStep)) {
          this.setWizardStep(currentWizardStep + 1);
        } else {
          const errorInfo = this.wizardState.lastValidationError;
          if (errorInfo?.type === 'ubicaciones-vacias') {
            this.showToast('Agrega al menos una ubicacin corporativa antes de continuar.', 'warning');
          } else {
            this.showToast('Completa los campos obligatorios antes de continuar.', 'warning');
          }
        }
        return;
      }

      for (let step = 1; step <= totalWizardSteps; step++) {
        const shouldReport = step === currentWizardStep;
        if (!this.validateWizardStep(step, { reportValidity: shouldReport })) {
          const pasoPendiente = this.getWizardStepName(step);
          this.setWizardStep(step, { focusFirstField: true });
          const errorInfo = this.wizardState.lastValidationError;
          if (errorInfo?.type === 'ubicaciones-vacias') {
            this.showToast('Define al menos un rea General antes de guardar.', 'warning');
          } else {
            this.showToast(`Revisa los pendientes en "${pasoPendiente}".`, 'warning');
          }
          return;
        }
      }
    }  // 🔴 Fin del else if (wizard validation)

    // 🟢 INICIO DEL CÓDIGO DE GUARDADO (se ejecuta si forceValidation=true O si pasó validación wizard)
    
    //  BLOQUEAR BOTN Y MOSTRAR LOADING
    const btnGuardar = document.getElementById('btnGuardarRepuesto');
    const btnText = btnGuardar?.querySelector('.btn-text');
    const btnLoading = btnGuardar?.querySelector('.btn-loading');
    
    if (btnGuardar) {
      btnGuardar.disabled = true;
      btnGuardar.style.opacity = '0.7';
      btnGuardar.style.cursor = 'wait';
    }
    if (btnText) btnText.style.display = 'none';
    if (btnLoading) {
      btnLoading.style.display = 'inline-flex';
      btnLoading.style.alignItems = 'center';
    }
    
    try {
      console.log('\n ========== GUARDANDO REPUESTO ==========');
      const id = this.currentEditingId || Date.now().toString() + Math.random();
      
      const multimediaTotal = [...(this.currentMultimedia || []), ...(this.currentDocuments || [])];
      console.log(` Multimedia a guardar: ${multimediaTotal.length} items (${this.currentMultimedia?.length || 0} imgenes, ${this.currentDocuments?.length || 0} documentos)`);
      
      //  GUARDAR UBICACIONES ANTIGUAS (para detectar cambios y mover imgenes)
      let ubicacionesAntiguas = null;
      if (this.currentEditingId) {
        const repuestoAnterior = this.repuestos.find(r => r.id === this.currentEditingId);
        if (repuestoAnterior && repuestoAnterior.ubicaciones) {
          ubicacionesAntiguas = JSON.parse(JSON.stringify(repuestoAnterior.ubicaciones));
          console.log(' Ubicaciones antiguas guardadas:', ubicacionesAntiguas[0]?.areaGeneral);
        }
      }
    
    //  ACTUALIZAR ubicacionesActuales desde el DOM (por si los listeners fallaron)
    this.sincronizarUbicacionesDesdeDOM();
    
    // DEBUG: Mostrar ubicaciones antes de validar
    console.log('\n UBICACIONES ACTUALES DESPUS DE SINCRONIZAR:');
    this.ubicacionesActuales.forEach((ub, idx) => {
      console.log(`  Ubicacin ${idx + 1}:`, {
        areaGeneral: ub.areaGeneral,
        subArea: ub.subArea,
        sistemaEquipo: ub.sistemaEquipo,
        subSistema: ub.subSistema,
        seccion: ub.seccion,
        detalle: ub.detalle
      });
    });
    
    // VALIDAR QUE HAY AL MENOS UNA UBICACIN CON REA GENERAL
    const ubicacionesValidas = this.ubicacionesActuales.filter(ub => ub.areaGeneral && ub.areaGeneral.trim() !== '');
    console.log(`\n Ubicaciones vlidas: ${ubicacionesValidas.length} de ${this.ubicacionesActuales.length}`);
    
    if (ubicacionesValidas.length === 0) {
      //  RE-HABILITAR BOTN SI HAY ERROR
      btnGuardar.disabled = false;
      btnGuardar.style.opacity = '1';
      btnGuardar.style.cursor = 'pointer';
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      
      this.showToast(' Debes especificar al menos un rea General', 'error');
      return;
    }
    
    // Limpiar ubicaciones (remover campos vacos)
    let ubicacionesLimpias = ubicacionesValidas.map((ub, idx) => {
      const ubicacion = {};
      console.log(` Limpiando ubicacin ${idx + 1}:`);
      if (ub.areaGeneral) {
        ubicacion.areaGeneral = ub.areaGeneral.trim();
        console.log(`   areaGeneral: "${ubicacion.areaGeneral}"`);
      }
      if (ub.subArea && ub.subArea.trim()) {
        ubicacion.subArea = ub.subArea.trim();
        console.log(`   subArea: "${ubicacion.subArea}"`);
      }
      if (ub.sistemaEquipo && ub.sistemaEquipo.trim()) {
        ubicacion.sistemaEquipo = ub.sistemaEquipo.trim();
        console.log(`   sistemaEquipo: "${ubicacion.sistemaEquipo}"`);
      }
      if (ub.subSistema && ub.subSistema.trim()) {
        ubicacion.subSistema = ub.subSistema.trim();
        console.log(`   subSistema: "${ubicacion.subSistema}"`);
      }
      if (ub.seccion && ub.seccion.trim()) {
        ubicacion.seccion = ub.seccion.trim();
        console.log(`   seccion: "${ubicacion.seccion}"`);
      }
      if (ub.subSeccion && ub.subSeccion.trim()) {
        ubicacion.subSeccion = ub.subSeccion.trim();
        console.log(`   subSeccion: "${ubicacion.subSeccion}"`);
      }
      if (ub.detalle && ub.detalle.trim()) {
        ubicacion.detalle = ub.detalle.trim();
        console.log(`   detalle: "${ubicacion.detalle}"`);
      }
      
      //  CRTICO: Preservar datos del mapa si existen
      if (ub.mapId) {
        ubicacion.mapId = ub.mapId;
        console.log(`   mapId preservado: ${ubicacion.mapId}`);
      }
      if (ub.areaId) {
        ubicacion.areaId = ub.areaId;
        console.log(`   areaId preservado: ${ubicacion.areaId}`);
      }
      if (ub.markerX !== undefined) {
        ubicacion.markerX = ub.markerX;
        console.log(`   markerX preservado: ${ubicacion.markerX}`);
      }
      if (ub.markerY !== undefined) {
        ubicacion.markerY = ub.markerY;
        console.log(`   markerY preservado: ${ubicacion.markerY}`);
      }
      if (ub.descripcion && ub.descripcion.trim()) {
        ubicacion.descripcion = ub.descripcion.trim();
        console.log(`   descripcion preservada: "${ubicacion.descripcion}"`);
      }
      
      // 📊 CANTIDAD EN UBICACIÓN: Persistir cantidad específica por ubicación
      ubicacion.cantidadEnUbicacion = ub.cantidadEnUbicacion || 1;
      console.log(`   cantidadEnUbicacion: ${ubicacion.cantidadEnUbicacion}`);
      
      return ubicacion;
    });
    
        console.log(' UBICACIONES LIMPIAS A GUARDAR:', JSON.stringify(ubicacionesLimpias, null, 2));

        //  REGISTRO CENTRALIZADO: Garantiza que todas las ubicaciones queden en la jerarqua unificada
        if (typeof this.registerJerarquiaPath === 'function') {
          ubicacionesLimpias = ubicacionesLimpias.map((ubicacion, index) => {
            let jerarquiaPath = [];
            try {
              jerarquiaPath = this.registerJerarquiaPath({
                planta: this.plantaBase,
                areaGeneral: ubicacion.areaGeneral,
                subArea: ubicacion.subArea,
                sistemaEquipo: ubicacion.sistemaEquipo,
                subSistema: ubicacion.subSistema,
                seccion: ubicacion.seccion,
                subSeccion: ubicacion.subSeccion,
                detalle: ubicacion.detalle
              }, {
                source: 'repuesto-ubicacion',
                entityId: id,
                meta: {
                  ubicacionIndex: index
                }
              }) || [];
            } catch (error) {
              console.error(' Error registrando jerarqua desde repuesto:', error);
            }

            return {
              ...ubicacion,
              jerarquiaPath
            };
          });
        }
    
    //  SINCRONIZACIN AUTOMTICA: Agregar ubicaciones al rbol de jerarqua
    this.sincronizarJerarquiaDesdeUbicaciones(ubicacionesLimpias);
    
    //  SINCRONIZACIN: Aprender tambin campos de autocomplete (tipo, codProv)
    const tipoValue = document.getElementById('tipo').value.trim();
    const codProvValue = document.getElementById('codProv').value.trim();
    
    if (tipoValue && !this.autocompleteData.tipo.includes(tipoValue)) {
      this.autocompleteData.tipo.push(tipoValue);
      this.autocompleteData.tipo.sort();
      localStorage.setItem('autocompleteData', JSON.stringify(this.autocompleteData));
      console.log(` Nuevo tipo aprendido: ${tipoValue}`);
      
      // Actualizar UI si configuracin est visible
      if (this.currentTab === 'configuracion') {
        this.renderListasGestion();
        console.log(` UI de configuracin actualizada automticamente`);
      }
    }
    
    if (codProvValue && !this.autocompleteData.codProv.includes(codProvValue)) {
      this.autocompleteData.codProv.push(codProvValue);
      this.autocompleteData.codProv.sort();
      localStorage.setItem('autocompleteData', JSON.stringify(this.autocompleteData));
      console.log(` Nuevo cdigo proveedor aprendido: ${codProvValue}`);
      
      // Actualizar UI si configuracin est visible
      if (this.currentTab === 'configuracion') {
        this.renderListasGestion();
        console.log(` UI de configuracin actualizada automticamente`);
      }
    }
    
    const data = {
      id: id,
      codSAP: document.getElementById('codSAP').value,
      codProv: document.getElementById('codProv').value,
      tipo: document.getElementById('tipo').value,
      categoria: document.getElementById('categoria').value,
      nombre: document.getElementById('nombre').value,
      
      // UBICACIONES MLTIPLES (nuevo sistema)
      ubicaciones: ubicacionesLimpias,
      planta: this.plantaBase, // Empresa siempre fija
      
      // COMPATIBILIDAD: Guardar primera ubicacin en formato antiguo
      areaGeneral: ubicacionesLimpias[0].areaGeneral || '',
      subArea: ubicacionesLimpias[0].subArea || '',
      sistemaEquipo: ubicacionesLimpias[0].sistemaEquipo || '',
      subSistema: ubicacionesLimpias[0].subSistema || '',
      seccion: ubicacionesLimpias[0].seccion || '',
      detalle: ubicacionesLimpias[0].detalle || '',
      area: ubicacionesLimpias[0].areaGeneral || '',
      equipo: ubicacionesLimpias[0].sistemaEquipo || '',
      sistema: ubicacionesLimpias[0].subSistema || '',
      detalleUbicacion: ubicacionesLimpias[0].detalle || '',
      
      cantidad: parseInt(document.getElementById('cantidad').value) || 0,
      cantidadInstalada: parseInt(document.getElementById('cantidadInstalada').value) || 0,
      minimo: parseInt(document.getElementById('minimo').value) || 5,
      optimo: parseInt(document.getElementById('optimo').value) || 10,
      precio: parseFloat(document.getElementById('precio').value) || 0,
      datosTecnicos: document.getElementById('datosTecnicos').value.trim() || '',
      multimedia: multimediaTotal,
      ultimaModificacion: new Date().toISOString(),
      ultimoConteo: null
    };
    
    console.log(` Guardando ${ubicacionesLimpias.length} ubicacin(es) para: ${data.nombre}`);

    if (this.currentEditingId) {
      const index = this.repuestos.findIndex(r => r.id === this.currentEditingId);
      if (index !== -1) {
        console.log(` Actualizando repuesto existente: ${data.nombre}`);
        // Preservar fecha de ltimo conteo si existe
        const repuestoAnterior = this.repuestos[index];
        data.ultimoConteo = repuestoAnterior.ultimoConteo || null;
        
        // Guardar estado para deshacer (copia del original y editado)
        saveState('edit', {
          original: JSON.parse(JSON.stringify(repuestoAnterior)),
          edited: JSON.parse(JSON.stringify(data))
        });
        
        this.repuestos[index] = data;

        const ubicacionesAfectadas = ubicacionesLimpias.length === 1
          ? '1 ubicacin afectada'
          : `${ubicacionesLimpias.length} ubicaciones afectadas`;
        const multimediaResumen = multimediaTotal.length === 0
          ? 'sin adjuntos'
          : `${multimediaTotal.length} adjunto${multimediaTotal.length === 1 ? '' : 's'}`;
        this.showToast(` Repuesto actualizado  ${ubicacionesAfectadas}  ${multimediaResumen}`, 'success');
        
        //  MOVER IMGENES SI CAMBI LA UBICACIN
        if (ubicacionesAntiguas && fsManager.isFileSystemMode && this.renombrarImagenesAutomaticamente) {
          const areaAntigua = ubicacionesAntiguas[0]?.areaGeneral;
          const areaNueva = ubicacionesLimpias[0]?.areaGeneral;
          
          if (areaAntigua && areaNueva && areaAntigua !== areaNueva) {
            console.log(` Detectado cambio de rea: "${areaAntigua}"  "${areaNueva}"`);
            console.log('   Iniciando movimiento automtico de imgenes...');
            await this.moverImagenSiCambiaUbicacion(data, ubicacionesAntiguas, ubicacionesLimpias);
            // Actualizar repuesto con URLs nuevas
            this.repuestos[index] = data;
            await this.saveData();
          }
        }
      }
    } else {
      console.log(` Agregando nuevo repuesto: ${data.nombre}`);
      
      // Guardar estado para deshacer
      saveState('add', JSON.parse(JSON.stringify(data)));
      
      this.repuestos.unshift(data); // Agregar al inicio para que aparezca primero
      const ubicacionesDefinidas = ubicacionesLimpias.length === 1
        ? '1 ubicacin definida'
        : `${ubicacionesLimpias.length} ubicaciones definidas`;
      const multimediaResumen = multimediaTotal.length === 0
        ? 'sin adjuntos'
        : `${multimediaTotal.length} adjunto${multimediaTotal.length === 1 ? '' : 's'}`;
      this.showToast(` Repuesto agregado  ${ubicacionesDefinidas}  ${multimediaResumen}`, 'success');
    }

    //  ESPERAR a que se guarde en disco antes de continuar
    await this.saveData();
    
    // 🔥 SINCRONIZACIÓN MULTIMEDIA: Actualizar todas las pestañas después de guardar
    console.log('\n [SYNC] Iniciando sincronización multimedia después de guardar...');
    if (data.id && multimediaTotal.length >= 0) {
      try {
        await this.syncMultimediaAcrossTabs(data.id, multimediaTotal);
        this.dispatchMultimediaChange(data.id, this.currentEditingId ? 'update' : 'add', multimediaTotal);
        console.log(` [SYNC] Multimedia sincronizada: ${multimediaTotal.length} items`);
      } catch (syncError) {
        console.error(' [SYNC] Error en sincronización:', syncError);
        // No bloquear el guardado si falla la sincronización
      }
    }
    
    // 🎯 SINCRONIZACIÓN JERARQUÍA: Expandir y resaltar nodo si Tab está activo
    if (ubicacionesLimpias && ubicacionesLimpias.length > 0) {
      console.log('\n🌳 [SYNC] Sincronizando Tab Jerarquía con ubicación guardada...');
      try {
        await this.syncJerarquiaTab(data.id, multimediaTotal, ubicacionesLimpias);
        console.log(` [SYNC] Jerarquía sincronizada con ubicación: ${ubicacionesLimpias[0].areaGeneral}`);
      } catch (syncError) {
        console.error(' [SYNC] Error sincronizando jerarquía:', syncError);
      }
    }
    
    this.updateAutocompleteData();
    await this.render();
    this.renderFilters();
    this.closeModal();
    console.log(' Guardado completo\n');
    
    } catch (error) {
      console.error(' Error guardando repuesto:', error);
      this.showToast(' Error al guardar: ' + error.message, 'error');
      
      //  RE-HABILITAR BOTN EN CASO DE ERROR
      btnGuardar.disabled = false;
      btnGuardar.style.opacity = '1';
      btnGuardar.style.cursor = 'pointer';
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
  }

  async deleteRepuesto(id) {
    if (!confirm('Eliminar este repuesto?')) return;
    
    //  Buscar el repuesto para eliminar sus imgenes fsicas
    const repuesto = this.repuestos.find(r => r.id === id);
    
    if (!repuesto) return;
    
    // Guardar estado para deshacer
    saveState('delete', JSON.parse(JSON.stringify(repuesto)));
    
    if (repuesto.multimedia && fsManager.isFileSystemMode) {
      // Filtrar solo imgenes de FileSystem
      const imagenesFileSystem = repuesto.multimedia
        .filter(m => m.type === 'image' && m.isFileSystem && m.url)
        .map(m => m.url);
      
      if (imagenesFileSystem.length > 0) {
        console.log(` Eliminando ${imagenesFileSystem.length} imgenes del producto "${repuesto.nombre}"...`);
        const result = await fsManager.deleteMultipleImages(imagenesFileSystem);
        console.log(` Limpieza completada: ${result.deleted} eliminadas, ${result.failed} fallidas`);
      }
    }
    
    // Eliminar repuesto del array
    this.repuestos = this.repuestos.filter(r => r.id !== id);
    await this.saveData();
    await this.render();
    this.renderFilters();
    this.showToast(' Repuesto e imgenes eliminados', 'success');
  }

  updateAutocompleteData() {
    const codProvs = new Set();
    const tipos = new Set();
    const areasGenerales = new Set();
    const subAreas = new Set();
    const sistemasEquipos = new Set();
    const subSistemas = new Set();
    const secciones = new Set();
    const subSecciones = new Set();
    const detalles = new Set();

    this.repuestos.forEach(r => {
      if (r.codProv) codProvs.add(r.codProv);
      if (r.tipo) tipos.add(r.tipo);
      
      const areaGeneral = r.areaGeneral || r.area;
      if (areaGeneral) areasGenerales.add(areaGeneral);
      
      if (r.subArea) subAreas.add(r.subArea);
      
      const sistemaEquipo = r.sistemaEquipo || r.equipo;
      if (sistemaEquipo) sistemasEquipos.add(sistemaEquipo);
      
      const subSistema = r.subSistema || r.sistema;
      if (subSistema) subSistemas.add(subSistema);
      
      if (r.seccion) secciones.add(r.seccion);
      
      if (r.subSeccion) subSecciones.add(r.subSeccion);
      
      const detalle = r.detalle || r.detalleUbicacion;
      if (detalle) detalles.add(detalle);
    });

    this.autocompleteData = {
      codProv: Array.from(codProvs).sort(),
      tipo: Array.from(tipos).sort(),
      areaGeneral: Array.from(areasGenerales).sort(),
      subArea: Array.from(subAreas).sort(),
      sistemaEquipo: Array.from(sistemasEquipos).sort(),
      subSistema: Array.from(subSistemas).sort(),
      seccion: Array.from(secciones).sort(),
      subSeccion: Array.from(subSecciones).sort(),
      detalle: Array.from(detalles).sort()
    };
    
    // Actualizar vista de listas en configuracin si est visible
    this.renderListasGestion();
  }

  renderListasGestion() {
    const listas = [
      { id: 'tipo', nombre: 'Tipo', field: 'tipo', esJerarquia: false }
    ];

    listas.forEach(lista => {
      const container = document.getElementById(`lista${lista.id.charAt(0).toUpperCase() + lista.id.slice(1)}`);
      if (!container) return;
      
      // Obtener datos de la fuente correcta
      const datos = lista.esJerarquia 
        ? (this.opcionesJerarquia[lista.field] || [])
        : (this.autocompleteData[lista.field] || []);
      
      if (datos.length === 0) {
        container.innerHTML = `<div style="text-align: center; color: var(--text-secondary); padding: 10px;">No hay ${lista.nombre.toLowerCase()}s registrados</div>`;
      } else {
        container.innerHTML = datos.map((item, index) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--bg-secondary); margin-bottom: 4px; border-radius: 4px;">
            <span style="color: var(--text-primary); font-size: 0.9rem; flex: 1;">${item}</span>
            <div style="display: flex; gap: 4px;">
              <button onclick="app.editarItemLista('${lista.field}', ${index}, '${item.replace(/'/g, "\\'")}')" 
                      style="background: var(--info); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                Editar
              </button>
              <button onclick="app.eliminarItemLista('${lista.field}', '${item.replace(/'/g, "\\'")}')" 
                      style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                Eliminar
              </button>
            </div>
          </div>
        `).join('');
      }
    });

    //  NUEVO: Renderizar categoras de reas del mapa
    this.renderCategoriasAreasConfig();
    
    //  Renderizar rbol jerrquico organizacional
    this.renderJerarquiaTree();
  }

  //  NUEVO: Renderizar categoras de reas en configuracin
  renderCategoriasAreasConfig() {
    const container = document.getElementById('listaCategoriasAreas');
    const mensajeVacio = document.getElementById('mensajeNoCategoriasAreas');
    if (!container) return;

    // Obtener categoras desde mapController
    const categorias = typeof mapController !== 'undefined' && mapController.categories 
      ? mapController.categories 
      : {};

    const categoriasArray = Object.entries(categorias).map(([key, value]) => ({
      id: key,
      icon: value.icon,
      name: value.name,
      color: value.color,
      description: value.description
    }));

    if (categoriasArray.length === 0) {
      container.style.display = 'none';
      if (mensajeVacio) mensajeVacio.style.display = 'block';
    } else {
      container.style.display = 'grid';
      if (mensajeVacio) mensajeVacio.style.display = 'none';
      
      container.innerHTML = categoriasArray.map(cat => `
        <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid ${cat.color}; transition: all 0.2s; position: relative; overflow: hidden;">
          <!-- Fondo con color de categora (sutil) -->
          <div style="position: absolute; top: 0; right: 0; bottom: 0; width: 60px; background: linear-gradient(90deg, transparent, ${cat.color}20); pointer-events: none;"></div>
          
          <!-- Icono y color -->
          <div style="display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 60px; position: relative; z-index: 1;">
            <span style="font-size: 2rem; line-height: 1;">${cat.icon}</span>
            <div style="width: 40px; height: 24px; background: ${cat.color}; border-radius: 6px; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
          </div>
          
          <!-- Informacin -->
          <div style="flex: 1; min-width: 0; position: relative; z-index: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <span style="color: var(--text-primary); font-weight: 700; font-size: 1rem;">${cat.name}</span>
              <span style="color: var(--text-muted); font-size: 0.7rem; font-family: monospace; background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">${cat.color}</span>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.8rem; margin: 0; line-height: 1.4;">${cat.description}</p>
          </div>
          
          <!-- Botones de accin -->
          <div style="display: flex; gap: 6px; position: relative; z-index: 1;">
            <button onclick="app.editarCategoria('${cat.id}')" 
                    title="Editar categora"
                    style="background: var(--info); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
              <span></span> Editar
            </button>
            <button onclick="app.eliminarCategoria('${cat.id}')" 
                    title="Eliminar categora"
                    style="background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
              <span></span> Eliminar
            </button>
          </div>
        </div>
      `).join('');
    }
  }

  agregarItemLista(tipo) {
    const nombres = {
      'tipo': 'Tipo',
      'areaGeneral': 'AreaGeneral',
      'subArea': 'SubArea',
      'sistemaEquipo': 'SistemaEquipo',
      'subSistema': 'SubSistema',
      'seccion': 'Seccion',
      'detalle': 'Detalle'
    };

    const jerarquiaManaged = ['areaGeneral', 'subArea', 'sistemaEquipo', 'subSistema', 'seccion', 'subSeccion'];
    if (jerarquiaManaged.includes(tipo)) {
      this.showToast(' Administra este nivel desde la pestana Jerarquia > Arbol corporativo.', 'info');
      return;
    }
    
    const inputId = 'nuevo' + nombres[tipo];
    const input = document.getElementById(inputId);
    
    if (!input) return;
    
    const valor = input.value.trim();
    if (!valor) {
      this.showToast(' Ingresa un valor', 'error');
      return;
    }

    // Para otros tipos (como 'tipo'), usar el sistema anterior
    const lista = this.autocompleteData[tipo] || [];
    if (lista.includes(valor)) {
      this.showToast(' Este valor ya existe', 'warning');
      return;
    }

    if (!this.autocompleteData[tipo]) {
      this.autocompleteData[tipo] = [];
    }
    this.autocompleteData[tipo].push(valor);
    this.autocompleteData[tipo].sort();
    
    localStorage.setItem('autocompleteData', JSON.stringify(this.autocompleteData));
    
    input.value = '';
    this.renderListasGestion();
    this.showToast(` ${valor} agregado correctamente`, 'success');
  }

  editarItemLista(tipo, index, valorActual) {
    const nuevoValor = prompt(`Editar valor:`, valorActual);
    
    if (!nuevoValor || nuevoValor.trim() === '') {
      return;
    }

    const valorTrim = nuevoValor.trim();
    const jerarquiaManaged = ['areaGeneral', 'subArea', 'sistemaEquipo', 'subSistema', 'seccion', 'subSeccion'];
    
    if (jerarquiaManaged.includes(tipo)) {
      this.showToast(' Este nivel se edita desde Jerarquia > Arbol corporativo.', 'info');
      return;
    }
    
    // Para otros tipos (tipo, codProv, etc.)
    if (this.autocompleteData[tipo].includes(valorTrim) && valorTrim !== valorActual) {
      this.showToast(' Este valor ya existe', 'warning');
      return;
    }

    this.autocompleteData[tipo][index] = valorTrim;
    this.autocompleteData[tipo].sort();
    
    localStorage.setItem('autocompleteData', JSON.stringify(this.autocompleteData));
    
    this.renderListasGestion();
    this.showToast(` Valor actualizado: ${valorTrim}`, 'success');
  }

  eliminarItemLista(tipo, valor) {
    const nombres = {
      'tipo': 'Tipos',
      'areaGeneral': 'reas Generales',
      'subArea': 'Sub-reas',
      'sistemaEquipo': 'Sistemas/Equipos',
      'subSistema': 'Sub-Sistemas',
      'seccion': 'Secciones',
      'detalle': 'Detalles'
    };

    if (!confirm(`Eliminar "${valor}" de la lista de ${nombres[tipo]}?\n\n Esta opcin tambin se eliminar de todos los repuestos que la usen.`)) {
      return;
    }

    const jerarquiaManaged = ['areaGeneral', 'subArea', 'sistemaEquipo', 'subSistema', 'seccion', 'subSeccion'];
    if (jerarquiaManaged.includes(tipo)) {
      this.showToast(' Este nivel se elimina desde la pestana Jerarquia.', 'info');
      return;
    }

    // Para otros tipos (como 'tipo'), usar el sistema anterior
    const index = this.autocompleteData[tipo].indexOf(valor);
    if (index > -1) {
      this.autocompleteData[tipo].splice(index, 1);
    }

    localStorage.setItem('autocompleteData', JSON.stringify(this.autocompleteData));
    
    this.renderListasGestion();
    this.showToast(` ${valor} eliminado`, 'success');
  }

  //  ========================================
  // FUNCIONES DE GESTIN DE JERARQUA ANIDADA (v5.4 MIGRADO)
  // ========================================
  
  renderJerarquiaTree() {
    const container = document.getElementById('jerarquiaTreeContainer');

    if (!container) {
      console.error('❌ No se encontró el contenedor jerarquiaTreeContainer');
      return;
    }
    
    if (!this.jerarquiaAnidada) {
      console.error('❌ jerarquiaAnidada no está definida');
      container.innerHTML = '<p style="color: var(--danger); padding: 20px;">Error: No se pudo cargar la jerarquía. Usa el botón "Guardar Cambios" en Configuración.</p>';
      return;
    }
    
    console.log('🌲 Renderizando árbol visual de jerarquía');
    
    try {
      container.classList.add('jerarquia-tree-restoring');
      container.classList.remove('jerarquia-tree-ready');
      // Aplicar estilos del contenedor visual
      container.style.setProperty('background', '#1e2229');
      container.style.setProperty('padding', '40px');
      container.style.setProperty('overflow', 'visible');
      container.style.setProperty('min-height', '600px');
      container.style.setProperty('height', 'auto');
      
      // Usar SIEMPRE el renderizador visual
      const html = this.buildTreeHTML_Visual();
      container.innerHTML = html;
      
      // 🔄 Restaurar estados de expansión guardados (con delay para asegurar DOM)
      setTimeout(() => {
        try {
          this.restoreExpandStates();
        } finally {
          requestAnimationFrame(() => {
            container.classList.remove('jerarquia-tree-restoring');
            container.classList.add('jerarquia-tree-ready');
          });
        }
      }, 100);
      
      console.log('✅ Árbol visual renderizado correctamente');
      
      // Reconstruir índice de búsqueda
      if (typeof this.buildJerarquiaSearchIndex === 'function') {
        this.buildJerarquiaSearchIndex();
        
        // Mantener búsqueda activa si había una
        const searchInput = document.getElementById('jerarquiaTreeSearchInput');
        const currentQuery = searchInput ? searchInput.value.trim() : '';
        if (currentQuery) {
          const hadFilter = this.jerarquiaSearchState?.isFilterActive;
          const previousMatch = this.jerarquiaSearchState?.activeMatch;
          this.performJerarquiaSearch(currentQuery);
          if (hadFilter && previousMatch) {
            this.focusJerarquiaSearchResult(previousMatch);
          }
        } else {
          if (typeof this.clearJerarquiaSearchHighlights === 'function') {
            this.clearJerarquiaSearchHighlights();
          }
          this.resetJerarquiaTreeView();
          this.updateJerarquiaSearchStatus('');
        }
      }

      // Actualizar estado de botones undo/redo
      this.updateUndoRedoButtons();
    } catch (error) {
      console.error('❌ Error renderizando árbol:', error);
      container.innerHTML = `<p style="color: var(--danger); padding: 20px;">Error renderizando árbol: ${error.message}</p>`;
    }
  }
  
  buildTreeHTML() {
    if (!this.jerarquiaAnidada) {
      console.error(' jerarquiaAnidada es null o undefined');
      return '<p>Error: No hay datos de jerarqua</p>';
    }
    
    const { empresa, areas } = this.jerarquiaAnidada;
    
    if (!empresa || !areas) {
      console.error(' Faltan propiedades en jerarquiaAnidada:', this.jerarquiaAnidada);
      return '<p>Error: Estructura de jerarqua incompleta</p>';
    }
    
    console.log(' Construyendo HTML con:', { empresa: empresa.nombre, numAreas: areas.length });
    
    // Helper para escapar HTML
    const escapeHtml = (text) => {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };
    
    let html = '<div class="jerarquia-tree-sap">';
    
    // N1: Empresa (raz, siempre visible)
    html += `
      <div class="sap-node sap-node-empresa">
        <div class="sap-node-content">
          <span class="sap-node-id">${escapeHtml(empresa.id || 'EMP-01')}</span>
          <span class="sap-node-name">${escapeHtml(empresa.nombre)}</span>
          <div class="sap-node-actions">
            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('empresa')" title="Editar empresa">
              Editar Empresa
            </button>
          </div>
        </div>
      </div>
    `;
    
    // N2: reas
    if (areas && areas.length > 0) {
      const empresaId = empresa.id || 'EMP-01';
      html += areas.map((area, aIdx) => this.buildAreaHTML(area, aIdx, empresaId, escapeHtml)).join('');
    }
    
    // Botn agregar rea
    html += `
      <div class="sap-add-root">
        <button class="sap-btn sap-btn-add" onclick="app.agregarNodoJerarquia('area')">
          + Nueva rea
        </button>
      </div>
    `;
    
    // Botones flotantes de Undo/Redo
    html += `
      <div class="undo-redo-controls">
        <button class="undo-redo-btn undo-btn" onclick="app.undo()" title="Deshacer (Ctrl+Z)" id="sap-undo-btn">
          ↶
        </button>
        <button class="undo-redo-btn redo-btn" onclick="app.redo()" title="Rehacer (Ctrl+Y)" id="sap-redo-btn">
          ↷
        </button>
      </div>
    `;
    
    html += '</div>';
    return html;
  }
  
  // ============================================================
  // RENDERIZADOR PARA VISTA 3: ÁRBOL VISUAL (jerarquia_visual_dependencias)
  // ============================================================

  getVisualTypeOrder() {
    return ['area', 'subArea', 'sistema', 'subSistema', 'seccion', 'subSeccion'];
  }

  getVisualChildKeyMap() {
    return {
      empresa: 'areas',
      area: 'subAreas',
      subArea: 'sistemas',
      sistema: 'subSistemas',
      subSistema: 'secciones',
      seccion: 'subSecciones',
      subSeccion: null
    };
  }

  getVisualChildTypeMap() {
    return {
      area: 'subArea',
      subArea: 'sistema',
      sistema: 'subSistema',
      subSistema: 'seccion',
      seccion: 'subSeccion',
      subSeccion: null
    };
  }

  getVisualDisplayLabels() {
    return {
      empresa: 'Empresa',
      area: 'Área',
      subArea: 'Sub-Área',
      sistema: 'Sistema',
      subSistema: 'Sub-Sistema',
      seccion: 'Sección',
      subSeccion: 'Sub-Sección'
    };
  }

  getVisualParentMap() {
    return {
      area: 'empresa',
      subArea: 'area',
      sistema: 'subArea',
      subSistema: 'sistema',
      seccion: 'subSistema',
      subSeccion: 'seccion'
    };
  }

  sanitizeVisualText(value, fallback = '') {
    const text = value ?? fallback;
    return this.escapeHtml ? this.escapeHtml(String(text)) : String(text);
  }

  getVisualFallbackId(type, indices = []) {
    const labels = this.getVisualDisplayLabels();
    const normalized = Array.isArray(indices) && indices.length > 0
      ? indices.map((idx) => (Number.isFinite(idx) ? idx + 1 : idx)).join('.')
      : '1';
    return `${labels[type] || 'Nodo'}-${normalized}`;
  }

  getLegacyNodeId(type, indexPath) {
    if (!type) return null;
    if (Array.isArray(indexPath)) {
      return `${type}_${indexPath.join(',')}`;
    }
    if (typeof indexPath === 'number' && Number.isFinite(indexPath)) {
      return `${type}_${indexPath}`;
    }
    if (typeof indexPath === 'string' && indexPath.trim() !== '') {
      return `${type}_${indexPath}`;
    }
    return `${type}_root`;
  }

  getLegacyIdFromNodeContent(nodeContent) {
    if (!nodeContent) return null;
    const explicitLegacy = nodeContent.getAttribute('data-legacy-id');
    if (explicitLegacy) return explicitLegacy;
    const treeNode = nodeContent.closest('.tree-node');
    if (!treeNode) return null;
    const nodeType = treeNode.getAttribute('data-node-type');
    const nodeIndex = treeNode.getAttribute('data-node-index');
    if (!nodeType) return null;
    if (!nodeIndex || nodeIndex.trim() === '') {
      return `${nodeType}_root`;
    }
    return `${nodeType}_${nodeIndex}`;
  }

  isLegacyNodeId(nodeId) {
    if (typeof nodeId !== 'string') {
      return false;
    }
    return /^(empresa|area|subArea|sistema|subSistema|seccion|subSeccion)_[0-9]+(?:,[0-9]+)*$/.test(nodeId);
  }

  buildTreeHTML_Visual() {
    if (!this.jerarquiaAnidada) {
      console.error('🔴 jerarquiaAnidada es null o undefined');
      return '<p>Error: No hay datos de jerarquía</p>';
    }

    const { empresa, areas } = this.jerarquiaAnidada;

    if (!empresa || !areas) {
      console.error('🔴 Faltan propiedades en jerarquiaAnidada:', this.jerarquiaAnidada);
      return '<p>Error: Estructura de jerarquía incompleta</p>';
    }

    const labels = this.getVisualDisplayLabels();
    const escape = (value, fallback = '') => {
      const text = value ?? fallback;
      return this.escapeHtml ? this.escapeHtml(String(text)) : String(text);
    };

    let html = '<div class="visual-v2-tree-container"><div class="tree-container"><div class="tree-node" data-node-type="empresa">';

    // ID único para la empresa
    const empresaNodeId = `empresa_${escape(empresa.id, 'EMP-01')}`;
    const empresaLegacyId = this.getLegacyNodeId('empresa', escape(empresa.id, 'EMP-01'));
    const empresaExpanded = this.getNodeExpandState(empresaNodeId, empresaLegacyId);
    const empresaToggleClass = empresaExpanded ? 'expanded' : 'collapsed';

    html += `
      <div class="node-content" data-level="1" data-node-id="${empresaNodeId}" data-legacy-id="${empresaLegacyId}">
        <span class="node-toggle ${empresaToggleClass}" onclick="app.toggleVisualNodeChildren(this)">›</span>
        <span class="node-id">${escape(empresa.id, 'EMP-01')}</span>
        <span class="node-name">${escape(empresa.nombre, 'Empresa')}</span>
        <span class="node-level">${labels.empresa}</span>
        <div class="node-actions">
          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('empresa')" title="Editar empresa">Editar</button>
          <button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('area')" title="Agregar área">+ Área</button>
        </div>
      </div>
    `;

    if (Array.isArray(areas) && areas.length > 0) {
      const empresaChildrenDisplay = empresaExpanded ? 'block' : 'none';
      html += `<div class="tree-children" style="display: ${empresaChildrenDisplay};">`;
      areas.forEach((area, index) => {
        html += this.buildVisualAreaNode(area, index, empresaNodeId, {});
      });
      html += '</div>';
    }

    html += '</div></div></div>';
    return html;
  }
  
  buildVisualAreaNode(area, index, parentNodeId, parentPath = {}) {
    const labels = this.getVisualDisplayLabels();
    const childTypeMap = this.getVisualChildTypeMap();
    const childType = childTypeMap.area;
    const childLabel = childType ? labels[childType] : null;
    const hasChildren = Array.isArray(area && area.subAreas) && area.subAreas.length > 0;
    const toggleIcon = hasChildren ? '›' : '';
    const safeId = this.sanitizeVisualText(area && area.id ? area.id : null, this.getVisualFallbackId('area', [index]));
    const safeName = this.sanitizeVisualText(area && area.nombre ? area.nombre : null, `${labels.area} ${index + 1}`);
    const indexPath = `${index}`;
    
    // Path completo para filtrar repuestos
    const currentPath = { ...parentPath, areaGeneral: safeName };
    
    // 📦 Pre-calcular si tiene repuestos
    const repuestosEnAreaPreview = this.getRepuestosDeNodoExacto(currentPath);
    const hasRepuestos = repuestosEnAreaPreview.length > 0;
    
    // ID único y estado de expansión
    const areaNodeId = `${parentNodeId}_area_${index}`;
    const areaLegacyId = this.getLegacyNodeId('area', indexPath);
    const areaExpanded = this.getNodeExpandState(areaNodeId, areaLegacyId);
    const areaToggleClass = areaExpanded ? 'expanded' : 'collapsed';
    
    // Estado de repuestos
    const repuestosExpanded = this.getRepuestosExpandState(areaNodeId);
    const repuestosToggleClass = repuestosExpanded ? 'expanded' : 'collapsed';

    let html = `<div class="tree-node" data-node-type="area" data-node-index="${indexPath}">`;

    html += `
      <div class="node-content" data-level="2" data-node-id="${areaNodeId}" data-legacy-id="${areaLegacyId}">
        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('area', '${indexPath}')" title="Mover nodo">⠿</span>
        ${hasChildren ? `<span class="node-toggle ${areaToggleClass}" onclick="app.toggleVisualNodeChildren(this)">${toggleIcon}</span>` : '<span style="width: 16px; display: inline-block;"></span>'}
        <span class="node-id">${safeId}</span>
        <span class="node-name">${safeName}</span>
        ${hasRepuestos ? `<span class="node-repuestos-toggle ${repuestosToggleClass}" onclick="event.stopPropagation(); app.toggleRepuestosList('${areaNodeId}')" title="Mostrar/Ocultar repuestos (${repuestosEnAreaPreview.length})">📦</span>` : ''}
        <span class="node-level">${labels.area}</span>
        <div class="node-actions">
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('area', '${indexPath}', -1)" title="Subir">↑</button>
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('area', '${indexPath}', 1)" title="Bajar">↓</button>
          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('area', ${index})" title="Editar área">Editar</button>
          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('area', ${index})" title="Eliminar área">Eliminar</button>
          ${childType && childLabel ? `<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${childType}', ${index})" title="Agregar ${childLabel}">+ ${childLabel}</button>` : ''}
        </div>
      </div>
    `;

    if (hasChildren) {
      const areaChildrenDisplay = areaExpanded ? 'block' : 'none';
      html += `<div class="tree-children" style="display: ${areaChildrenDisplay};">`;
      area.subAreas.forEach((subArea, subIndex) => {
        html += this.buildVisualSubAreaNode(subArea, index, subIndex, areaNodeId, currentPath);
      });
      html += '</div>';
    }
    
    // 📦 REPUESTOS: Solo mostrar repuestos asignados EXACTAMENTE a este nivel (sin hijos)
    const repuestosEnArea = this.getRepuestosDeNodoExacto(currentPath);
    const repuestosListId = `repuestos-list-${areaNodeId}`;
    const hasRepuestosArea = repuestosEnArea.length > 0;
    
    if (hasRepuestosArea && areaExpanded) {
      const repuestosExpanded = this.getRepuestosExpandState(areaNodeId);
      const repuestosDisplay = repuestosExpanded ? 'block' : 'none';
      const repuestosHTML = this.renderRepuestosEnNodo(repuestosEnArea, 2, currentPath);
      
      html += `<div id="${repuestosListId}" class="node-repuestos-wrapper" style="display: ${repuestosDisplay};">${repuestosHTML}</div>`;
    }

    html += '</div>';
    return html;
  }

  buildVisualSubAreaNode(subArea, areaIndex, subIndex, parentNodeId, parentPath = {}) {
    const labels = this.getVisualDisplayLabels();
    const childTypeMap = this.getVisualChildTypeMap();
    const childType = childTypeMap.subArea;
    const childLabel = childType ? labels[childType] : null;
    const hasChildren = Array.isArray(subArea && subArea.sistemas) && subArea.sistemas.length > 0;
    const toggleIcon = hasChildren ? '›' : '';
    const safeId = this.sanitizeVisualText(subArea && subArea.id ? subArea.id : null, this.getVisualFallbackId('subArea', [areaIndex, subIndex]));
    const safeName = this.sanitizeVisualText(subArea && subArea.nombre ? subArea.nombre : null, `${labels.subArea} ${subIndex + 1}`);
    const indexPath = `${areaIndex},${subIndex}`;
    
    // Path completo para filtrar repuestos
    const currentPath = { ...parentPath, subArea: safeName };
    
    // 📦 Pre-calcular si tiene repuestos
    const repuestosEnSubAreaPreview = this.getRepuestosDeNodoExacto(currentPath);
    const hasRepuestosSubArea = repuestosEnSubAreaPreview.length > 0;
    
    // ID único y estado
    const nodeId = `${parentNodeId}_subarea_${subIndex}`;
    const legacyNodeId = this.getLegacyNodeId('subArea', indexPath);
    const expanded = this.getNodeExpandState(nodeId, legacyNodeId);
    const toggleClass = expanded ? 'expanded' : 'collapsed';
    
    // Estado de repuestos
    const repuestosExpandedSubArea = this.getRepuestosExpandState(nodeId);
    const repuestosToggleClassSubArea = repuestosExpandedSubArea ? 'expanded' : 'collapsed';

    let html = `<div class="tree-node" data-node-type="subArea" data-node-index="${indexPath}">`;

    html += `
      <div class="node-content" data-level="3" data-node-id="${nodeId}" data-legacy-id="${legacyNodeId}">
        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('subArea', '${indexPath}')" title="Mover nodo">⠿</span>
        ${hasChildren ? `<span class="node-toggle ${toggleClass}" onclick="app.toggleVisualNodeChildren(this)">${toggleIcon}</span>` : '<span style="width: 16px; display: inline-block;"></span>'}
        <span class="node-id">${safeId}</span>
        <span class="node-name">${safeName}</span>
        ${hasRepuestosSubArea ? `<span class="node-repuestos-toggle ${repuestosToggleClassSubArea}" onclick="event.stopPropagation(); app.toggleRepuestosList('${nodeId}')" title="Mostrar/Ocultar repuestos (${repuestosEnSubAreaPreview.length})">📦</span>` : ''}
        <span class="node-level">${labels.subArea}</span>
        <div class="node-actions">
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subArea', '${indexPath}', -1)" title="Subir">↑</button>
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subArea', '${indexPath}', 1)" title="Bajar">↓</button>
          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('subArea', ${areaIndex}, ${subIndex})" title="Editar sub-área">Editar</button>
          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('subArea', ${areaIndex}, ${subIndex})" title="Eliminar sub-área">Eliminar</button>
          ${childType && childLabel ? `<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${childType}', ${areaIndex}, ${subIndex})" title="Agregar ${childLabel}">+ ${childLabel}</button>` : ''}
        </div>
      </div>
    `;

    if (hasChildren) {
      const childrenDisplay = expanded ? 'block' : 'none';
      html += `<div class="tree-children" style="display: ${childrenDisplay};">`;
      subArea.sistemas.forEach((sistema, sisIndex) => {
        html += this.buildVisualSistemaNode(sistema, areaIndex, subIndex, sisIndex, nodeId, currentPath);
      });
      html += '</div>';
    }
    
    // 📦 REPUESTOS: Solo mostrar repuestos asignados EXACTAMENTE a este nivel
    const repuestosEnSubArea = this.getRepuestosDeNodoExacto(currentPath);
    const repuestosListIdSubArea = `repuestos-list-${nodeId}`;
    
    if (repuestosEnSubArea.length > 0 && expanded) {
      const repuestosExpandedSubArea2 = this.getRepuestosExpandState(nodeId);
      const repuestosDisplaySubArea = repuestosExpandedSubArea2 ? 'block' : 'none';
      const repuestosHTMLSubArea = this.renderRepuestosEnNodo(repuestosEnSubArea, 3, currentPath);
      
      html += `<div id="${repuestosListIdSubArea}" class="node-repuestos-wrapper" style="display: ${repuestosDisplaySubArea};">${repuestosHTMLSubArea}</div>`;
    }

    html += '</div>';
    return html;
  }

  buildVisualSistemaNode(sistema, areaIndex, subIndex, sisIndex, parentNodeId, parentPath = {}) {
    const labels = this.getVisualDisplayLabels();
    const childTypeMap = this.getVisualChildTypeMap();
    const childType = childTypeMap.sistema;
    const childLabel = childType ? labels[childType] : null;
    const hasChildren = Array.isArray(sistema && sistema.subSistemas) && sistema.subSistemas.length > 0;
    const toggleIcon = hasChildren ? '›' : '';
    const safeId = this.sanitizeVisualText(sistema && sistema.id ? sistema.id : null, this.getVisualFallbackId('sistema', [areaIndex, subIndex, sisIndex]));
    const safeName = this.sanitizeVisualText(sistema && sistema.nombre ? sistema.nombre : null, `${labels.sistema} ${sisIndex + 1}`);
    const indexPath = `${areaIndex},${subIndex},${sisIndex}`;
    
    // Path completo para filtrar repuestos
    const currentPath = { ...parentPath, sistemaEquipo: safeName };
    
    // 📦 Pre-calcular si tiene repuestos
    const repuestosEnSistemaPreview = this.getRepuestosDeNodoExacto(currentPath);
    const hasRepuestosSistema = repuestosEnSistemaPreview.length > 0;

    const nodeId = `${parentNodeId}_sistema_${sisIndex}`;
    const legacyNodeId = this.getLegacyNodeId('sistema', indexPath);
    const expanded = this.getNodeExpandState(nodeId, legacyNodeId);
    const toggleClass = expanded ? 'expanded' : 'collapsed';
    const childrenDisplay = expanded ? 'block' : 'none';
    
    // Estado de repuestos
    const repuestosExpandedSistema = this.getRepuestosExpandState(nodeId);
    const repuestosToggleClassSistema = repuestosExpandedSistema ? 'expanded' : 'collapsed';

    let html = `<div class="tree-node" data-node-type="sistema" data-node-index="${indexPath}">`;

    html += `
      <div class="node-content" data-level="4" data-node-id="${nodeId}" data-legacy-id="${legacyNodeId}">
        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('sistema', '${indexPath}')" title="Mover nodo">⠿</span>
        ${hasChildren ? `<span class="node-toggle ${toggleClass}" onclick="app.toggleVisualNodeChildren(this)">${toggleIcon}</span>` : '<span style="width: 16px; display: inline-block;"></span>'}
        <span class="node-id">${safeId}</span>
        <span class="node-name">${safeName}</span>
        ${hasRepuestosSistema ? `<span class="node-repuestos-toggle ${repuestosToggleClassSistema}" onclick="event.stopPropagation(); app.toggleRepuestosList('${nodeId}')" title="Mostrar/Ocultar repuestos (${repuestosEnSistemaPreview.length})">📦</span>` : ''}
        <span class="node-level">${labels.sistema}</span>
        <div class="node-actions">
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('sistema', '${indexPath}', -1)" title="Subir">↑</button>
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('sistema', '${indexPath}', 1)" title="Bajar">↓</button>
          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('sistema', ${areaIndex}, ${subIndex}, ${sisIndex})" title="Editar sistema">Editar</button>
          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('sistema', ${areaIndex}, ${subIndex}, ${sisIndex})" title="Eliminar sistema">Eliminar</button>
          ${childType && childLabel ? `<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${childType}', ${areaIndex}, ${subIndex}, ${sisIndex})" title="Agregar ${childLabel}">+ ${childLabel}</button>` : ''}
        </div>
      </div>
    `;

    if (hasChildren) {
      html += `<div class="tree-children" style="display: ${childrenDisplay};">`;
      sistema.subSistemas.forEach((subSistema, subSisIndex) => {
        html += this.buildVisualSubSistemaNode(subSistema, areaIndex, subIndex, sisIndex, subSisIndex, nodeId, currentPath);
      });
      html += '</div>';
    }
    
    // 📦 REPUESTOS: Solo mostrar repuestos asignados EXACTAMENTE a este sistema (con path completo)
    const repuestosEnSistema = this.getRepuestosDeNodoExacto(currentPath);
    const repuestosListIdSistema = `repuestos-list-${nodeId}`;
    
    if (repuestosEnSistema.length > 0 && expanded) {
      const repuestosExpandedSistema2 = this.getRepuestosExpandState(nodeId);
      const repuestosDisplaySistema = repuestosExpandedSistema2 ? 'block' : 'none';
      const repuestosHTMLSistema = this.renderRepuestosEnNodo(repuestosEnSistema, 4, currentPath);
      
      html += `<div id="${repuestosListIdSistema}" class="node-repuestos-wrapper" style="display: ${repuestosDisplaySistema};">${repuestosHTMLSistema}</div>`;
    }

    html += '</div>';
    return html;
  }

  buildVisualSubSistemaNode(subSistema, areaIndex, subIndex, sisIndex, subSisIndex, parentNodeId, parentPath = {}) {
    const labels = this.getVisualDisplayLabels();
    const childTypeMap = this.getVisualChildTypeMap();
    const childType = childTypeMap.subSistema;
    const childLabel = childType ? labels[childType] : null;
    const hasChildren = Array.isArray(subSistema && subSistema.secciones) && subSistema.secciones.length > 0;
    const toggleIcon = hasChildren ? '›' : '';
    const safeId = this.sanitizeVisualText(subSistema && subSistema.id ? subSistema.id : null, this.getVisualFallbackId('subSistema', [areaIndex, subIndex, sisIndex, subSisIndex]));
    const safeName = this.sanitizeVisualText(subSistema && subSistema.nombre ? subSistema.nombre : null, `${labels.subSistema} ${subSisIndex + 1}`);
    const indexPath = `${areaIndex},${subIndex},${sisIndex},${subSisIndex}`;
    
    // Path completo para filtrar repuestos
    const currentPath = { ...parentPath, subSistema: safeName };
    
    // 📦 Pre-calcular si tiene repuestos
    const repuestosEnSubSistemaPreview = this.getRepuestosDeNodoExacto(currentPath);
    const hasRepuestosSubSistema = repuestosEnSubSistemaPreview.length > 0;

    const nodeId = `${parentNodeId}_subSistema_${subSisIndex}`;
    const legacyNodeId = this.getLegacyNodeId('subSistema', indexPath);
    const expanded = this.getNodeExpandState(nodeId, legacyNodeId);
    const toggleClass = expanded ? 'expanded' : 'collapsed';
    const childrenDisplay = expanded ? 'block' : 'none';
    
    // Estado de repuestos
    const repuestosExpandedSubSistema = this.getRepuestosExpandState(nodeId);
    const repuestosToggleClassSubSistema = repuestosExpandedSubSistema ? 'expanded' : 'collapsed';

    let html = `<div class="tree-node" data-node-type="subSistema" data-node-index="${indexPath}">`;

    html += `
      <div class="node-content" data-level="5" data-node-id="${nodeId}" data-legacy-id="${legacyNodeId}">
        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('subSistema', '${indexPath}')" title="Mover nodo">⠿</span>
        ${hasChildren ? `<span class="node-toggle ${toggleClass}" onclick="app.toggleVisualNodeChildren(this)">${toggleIcon}</span>` : '<span style="width: 16px; display: inline-block;"></span>'}
        <span class="node-id">${safeId}</span>
        <span class="node-name">${safeName}</span>
        ${hasRepuestosSubSistema ? `<span class="node-repuestos-toggle ${repuestosToggleClassSubSistema}" onclick="event.stopPropagation(); app.toggleRepuestosList('${nodeId}')" title="Mostrar/Ocultar repuestos (${repuestosEnSubSistemaPreview.length})">📦</span>` : ''}
        <span class="node-level">${labels.subSistema}</span>
        <div class="node-actions">
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subSistema', '${indexPath}', -1)" title="Subir">↑</button>
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subSistema', '${indexPath}', 1)" title="Bajar">↓</button>
          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('subSistema', ${areaIndex}, ${subIndex}, ${sisIndex}, ${subSisIndex})" title="Editar sub-sistema">Editar</button>
          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('subSistema', ${areaIndex}, ${subIndex}, ${sisIndex}, ${subSisIndex})" title="Eliminar sub-sistema">Eliminar</button>
          ${childType && childLabel ? `<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${childType}', ${areaIndex}, ${subIndex}, ${sisIndex}, ${subSisIndex})" title="Agregar ${childLabel}">+ ${childLabel}</button>` : ''}
        </div>
      </div>
    `;

    if (hasChildren) {
      html += `<div class="tree-children" style="display: ${childrenDisplay};">`;
      subSistema.secciones.forEach((seccion, secIndex) => {
        html += this.buildVisualSeccionNode(seccion, areaIndex, subIndex, sisIndex, subSisIndex, secIndex, nodeId);
      });
      html += '</div>';
    }
    
    // 📦 REPUESTOS: Mostrar repuestos asignados EXACTAMENTE a este subSistema
    const repuestosEnSubSistema = this.getRepuestosDeNodoExacto(currentPath);
    const repuestosListIdSubSistema = `repuestos-list-${nodeId}`;
    
    if (repuestosEnSubSistema.length > 0 && expanded) {
      const repuestosExpandedSubSistema2 = this.getRepuestosExpandState(nodeId);
      const repuestosDisplaySubSistema = repuestosExpandedSubSistema2 ? 'block' : 'none';
      const repuestosHTMLSubSistema = this.renderRepuestosEnNodo(repuestosEnSubSistema, 5, currentPath);
      
      html += `<div id="${repuestosListIdSubSistema}" class="node-repuestos-wrapper" style="display: ${repuestosDisplaySubSistema};">${repuestosHTMLSubSistema}</div>`;
    }

    html += '</div>';
    return html;
  }

  buildVisualSeccionNode(seccion, areaIndex, subIndex, sisIndex, subSisIndex, secIndex, parentNodeId) {
    const labels = this.getVisualDisplayLabels();
    const childTypeMap = this.getVisualChildTypeMap();
    const childType = childTypeMap.seccion;
    const childLabel = childType ? labels[childType] : null;
    const hasChildren = Array.isArray(seccion && seccion.subSecciones) && seccion.subSecciones.length > 0;
    const toggleIcon = hasChildren ? '›' : '';
    const safeId = this.sanitizeVisualText(seccion && seccion.id ? seccion.id : null, this.getVisualFallbackId('seccion', [areaIndex, subIndex, sisIndex, subSisIndex, secIndex]));
    const safeName = this.sanitizeVisualText(seccion && seccion.nombre ? seccion.nombre : null, `${labels.seccion} ${secIndex + 1}`);
    const indexPath = `${areaIndex},${subIndex},${sisIndex},${subSisIndex},${secIndex}`;

    const nodeId = `${parentNodeId}_seccion_${secIndex}`;
    const legacyNodeId = this.getLegacyNodeId('seccion', indexPath);
    const expanded = this.getNodeExpandState(nodeId, legacyNodeId);
    const toggleClass = expanded ? 'expanded' : 'collapsed';
    const childrenDisplay = expanded ? 'block' : 'none';

    let html = `<div class="tree-node" data-node-type="seccion" data-node-index="${indexPath}">`;

    html += `
      <div class="node-content" data-level="6" data-node-id="${nodeId}" data-legacy-id="${legacyNodeId}">
        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('seccion', '${indexPath}')" title="Mover nodo">⠿</span>
        ${hasChildren ? `<span class="node-toggle ${toggleClass}" onclick="app.toggleVisualNodeChildren(this)">${toggleIcon}</span>` : '<span style="width: 16px; display: inline-block;"></span>'}
        <span class="node-id">${safeId}</span>
        <span class="node-name">${safeName}</span>
        <span class="node-level">${labels.seccion}</span>
        <div class="node-actions">
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('seccion', '${indexPath}', -1)" title="Subir">↑</button>
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('seccion', '${indexPath}', 1)" title="Bajar">↓</button>
          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('seccion', ${areaIndex}, ${subIndex}, ${sisIndex}, ${subSisIndex}, ${secIndex})" title="Editar sección">Editar</button>
          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('seccion', ${areaIndex}, ${subIndex}, ${sisIndex}, ${subSisIndex}, ${secIndex})" title="Eliminar sección">Eliminar</button>
          ${childType && childLabel ? `<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${childType}', ${areaIndex}, ${subIndex}, ${sisIndex}, ${subSisIndex}, ${secIndex})" title="Agregar ${childLabel}">+ ${childLabel}</button>` : ''}
        </div>
      </div>
    `;

    if (hasChildren) {
      html += `<div class="tree-children" style="display: ${childrenDisplay};">`;
      seccion.subSecciones.forEach((subSeccion, subSecIndex) => {
        html += this.buildVisualSubSeccionNode(subSeccion, areaIndex, subIndex, sisIndex, subSisIndex, secIndex, subSecIndex, nodeId);
      });
      html += '</div>';
    }

    html += '</div>';
    return html;
  }

  buildVisualSubSeccionNode(subSeccion, areaIndex, subIndex, sisIndex, subSisIndex, secIndex, subSecIndex, parentNodeId) {
    const labels = this.getVisualDisplayLabels();
    const childTypeMap = this.getVisualChildTypeMap();
    const childType = childTypeMap.subSeccion;
    const childLabel = childType ? labels[childType] : null;
    const safeId = this.sanitizeVisualText(subSeccion && subSeccion.id ? subSeccion.id : null, this.getVisualFallbackId('subSeccion', [areaIndex, subIndex, sisIndex, subSisIndex, secIndex, subSecIndex]));
    const safeName = this.sanitizeVisualText(subSeccion && subSeccion.nombre ? subSeccion.nombre : null, `${labels.subSeccion} ${subSecIndex + 1}`);
    const indexPath = `${areaIndex},${subIndex},${sisIndex},${subSisIndex},${secIndex},${subSecIndex}`;

    const nodeId = `${parentNodeId}_subSeccion_${subSecIndex}`;
    const legacyNodeId = this.getLegacyNodeId('subSeccion', indexPath);

    let html = `<div class="tree-node" data-node-type="subSeccion" data-node-index="${indexPath}">`;

    html += `
      <div class="node-content" data-level="7" data-node-id="${nodeId}" data-legacy-id="${legacyNodeId}">
        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('subSeccion', '${indexPath}')" title="Mover nodo">⠿</span>
        <span style="width: 16px; display: inline-block;"></span>
        <span class="node-id">${safeId}</span>
        <span class="node-name">${safeName}</span>
        <span class="node-level">${labels.subSeccion}</span>
        <div class="node-actions">
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subSeccion', '${indexPath}', -1)" title="Subir">↑</button>
          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subSeccion', '${indexPath}', 1)" title="Bajar">↓</button>
          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('subSeccion', ${areaIndex}, ${subIndex}, ${sisIndex}, ${subSisIndex}, ${secIndex}, ${subSecIndex})" title="Editar sub-sección">Editar</button>
          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('subSeccion', ${areaIndex}, ${subIndex}, ${sisIndex}, ${subSisIndex}, ${secIndex}, ${subSecIndex})" title="Eliminar sub-sección">Eliminar</button>
          ${childType && childLabel ? `<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${childType}', ${areaIndex}, ${subIndex}, ${sisIndex}, ${subSisIndex}, ${secIndex}, ${subSecIndex})" title="Agregar ${childLabel}">+ ${childLabel}</button>` : ''}
        </div>
      </div>
    `;

    html += '</div>';
    return html;
  }

  getVisualCollectionInfo(type, indices) {
    if (!this.jerarquiaAnidada) return null;

    if (type === 'area') {
      return {
        collection: Array.isArray(this.jerarquiaAnidada.areas) ? this.jerarquiaAnidada.areas : [],
        parentNode: this.jerarquiaAnidada,
        parentType: 'empresa',
        parentIndices: []
      };
    }

    const parentMap = this.getVisualParentMap();
    const parentType = parentMap[type];
    if (!parentType) return null;

    const parentIndices = Array.isArray(indices) && indices.length > 0 ? indices.slice(0, -1) : [];
    const parentNode = parentType === 'empresa'
      ? this.jerarquiaAnidada.empresa
      : this.getVisualNodeByTypeAndIndices(parentType, parentIndices);

    if (!parentNode) return null;

    const childKeyMap = this.getVisualChildKeyMap();
    const childKey = childKeyMap[parentType];
    if (!childKey) return null;

    if (!Array.isArray(parentNode[childKey])) {
      parentNode[childKey] = [];
    }

    return {
      collection: parentNode[childKey],
      parentNode,
      parentType,
      parentIndices
    };
  }

  getVisualNodeByTypeAndIndices(type, indices) {
    if (!this.jerarquiaAnidada) return null;
    if (type === 'empresa') {
      return this.jerarquiaAnidada.empresa || null;
    }

    const pathIndices = Array.isArray(indices) ? indices.map((value) => Number(value)) : [];
    const childKeyMap = this.getVisualChildKeyMap();
    const typeOrder = this.getVisualTypeOrder();

    if (!Array.isArray(this.jerarquiaAnidada.areas)) {
      return null;
    }

    let currentCollection = this.jerarquiaAnidada.areas;
    let currentNode = null;

    for (let depth = 0; depth < typeOrder.length; depth++) {
      const currentType = typeOrder[depth];
      const indexValue = pathIndices[depth];

      if (!Number.isFinite(indexValue)) {
        return null;
      }

      if (!Array.isArray(currentCollection) || indexValue < 0 || indexValue >= currentCollection.length) {
        return null;
      }

      currentNode = currentCollection[indexValue];

      if (currentType === type) {
        return currentNode || null;
      }

      const childKey = childKeyMap[currentType];
      if (!childKey) {
        return null;
      }

      currentCollection = currentNode ? currentNode[childKey] : null;
    }

    return null;
  }

  reordenarVisualNodo(type, indicesPath, direction) {
    if (!direction || typeof direction !== 'number') {
      return;
    }

    let indices = [];
    if (Array.isArray(indicesPath)) {
      indices = indicesPath.map((value) => Number(value));
    } else if (typeof indicesPath === 'number') {
      indices = [Number(indicesPath)];
    } else if (typeof indicesPath === 'string' && indicesPath.trim() !== '') {
      indices = indicesPath.split(',').map((value) => Number(value.trim())).filter((value) => !Number.isNaN(value));
    }

    if (indices.some((value) => Number.isNaN(value))) {
      console.warn('[VISUAL] Índices no válidos para reordenar:', indicesPath);
      this.showMoveNotification('Movimiento inválido ✗', true);
      return;
    }

    if (indices.length === 0 && type !== 'area') {
      console.warn('[VISUAL] Faltan índices para reordenar', type, indicesPath);
      this.showMoveNotification('No se pudo mover el elemento ✗', true);
      return;
    }

    const info = this.getVisualCollectionInfo(type, indices);
    if (!info || !Array.isArray(info.collection)) {
      console.warn('[VISUAL] No se encontró la colección para', type, indices);
      this.showMoveNotification('Movimiento no disponible ✗', true);
      return;
    }

    const currentIndex = indices.length > 0 ? indices[indices.length - 1] : 0;
    const targetIndex = currentIndex + direction;

    if (targetIndex < 0 || targetIndex >= info.collection.length) {
      this.showMoveNotification(direction < 0 ? 'Ya está en la parte superior ✗' : 'Ya está en la parte inferior ✗', true);
      return;
    }

    const fromIndices = [...indices];
    const toIndices = [...indices];
    if (toIndices.length === 0) {
      toIndices[0] = targetIndex;
    } else {
      toIndices[toIndices.length - 1] = targetIndex;
    }

    this.moveOrReorderSAPNodes(type, fromIndices, toIndices, true);
  }

  openVisualMoveModal(type, indicesPath) {
    console.log('[VISUAL] Solicitud de mover nodo', { type, indicesPath });
    this.showMoveNotification('Mover nodo (modal en desarrollo)', true);
  }
  
  toggleVisualNodeChildren(toggleElement) {
    const nodeContent = toggleElement.closest('.node-content');
    const treeNode = nodeContent.closest('.tree-node');
    const children = treeNode.querySelector(':scope > .tree-children');
    
    if (!children) return;
    
    // Obtener o generar ID único del nodo para persistencia
    let nodeId = nodeContent.getAttribute('data-node-id');
    
    // Si no tiene ID, generarlo ahora
    if (!nodeId) {
      const nodeType = treeNode.getAttribute('data-node-type') || 'node';
      const nodeIndex = treeNode.getAttribute('data-node-index') || 'unknown';
      nodeId = `${nodeType}_${nodeIndex}`;
      nodeContent.setAttribute('data-node-id', nodeId);
    }
    
    // Si no tiene style.display o está vacío, se considera visible (display: block por defecto en CSS)
    const isCurrentlyHidden = children.style.display === 'none';
    
    const legacyNodeId = this.getLegacyIdFromNodeContent(nodeContent);

    if (isCurrentlyHidden) {
      // Mostrar
      children.style.display = 'block';
      toggleElement.textContent = '›';
      toggleElement.classList.remove('collapsed');
      toggleElement.classList.add('expanded');
      
      // Guardar estado expandido
      this.saveNodeExpandState(nodeId, true, legacyNodeId);
    } else {
      // Ocultar
      children.style.display = 'none';
      toggleElement.textContent = '›';
      toggleElement.classList.remove('expanded');
      toggleElement.classList.add('collapsed');
      
      // Guardar estado contraído
      this.saveNodeExpandState(nodeId, false, legacyNodeId);
    }
  }
  
  // Restaurar estados de expansión de todos los nodos
  restoreExpandStates() {
    console.log('🔄 [RESTORE] Iniciando restauración de estados...');
    try {
      const stateKey = 'jerarquia_expand_state';
      const state = JSON.parse(localStorage.getItem(stateKey) || '{}');
      const stateCount = Object.keys(state).length;
      
      console.log(`📦 [RESTORE] Estados en localStorage:`, state);
      console.log(`📊 [RESTORE] Total estados guardados: ${stateCount}`);
      
      if (stateCount === 0) {
        console.log('ℹ️  [RESTORE] No hay estados guardados para restaurar');
        return;
      }
      
      let restored = 0;
      let skipped = 0;
      let notFound = 0;
      
      // Buscar TODOS los nodos en el DOM actual
      const allNodes = document.querySelectorAll('.node-content[data-node-id]');
      console.log(`🌲 [RESTORE] Nodos encontrados en DOM: ${allNodes.length}`);
      
      // Listar todos los IDs encontrados
      const foundIds = [];
      allNodes.forEach(node => {
        const id = node.getAttribute('data-node-id');
        if (id) foundIds.push(id);
      });
      console.log(`🏷️  [RESTORE] IDs en DOM:`, foundIds);
      
      // Verificar coincidencias entre localStorage y DOM
      const stateIds = Object.keys(state);
      const missingInDom = stateIds.filter(id => !foundIds.includes(id));
      const missingInState = foundIds.filter(id => !stateIds.includes(id));
      
      let legacyCleanupList = [];
      if (missingInDom.length > 0) {
        console.warn(`⚠️  [RESTORE] IDs en localStorage pero NO en DOM:`, missingInDom);
        legacyCleanupList = missingInDom.filter((id) => this.isLegacyNodeId(id));
      }
      if (missingInState.length > 0) {
        console.log(`ℹ️  [RESTORE] IDs en DOM pero NO en localStorage (nuevos nodos):`, missingInState);
      }
      
      // Restaurar estados
      let migrated = 0;
      let stateDirty = false;

      allNodes.forEach((nodeContent, index) => {
        const nodeId = nodeContent.getAttribute('data-node-id');
        let savedState = state[nodeId];
        let usedLegacyFallback = false;
        const legacyNodeId = this.getLegacyIdFromNodeContent(nodeContent);
        if (savedState === undefined && legacyNodeId && state[legacyNodeId] !== undefined) {
          savedState = state[legacyNodeId];
          state[nodeId] = savedState;
          if (legacyNodeId !== nodeId) {
            delete state[legacyNodeId];
            migrated++;
            stateDirty = true;
            usedLegacyFallback = true;
          }
        }
        
        console.log(`🔍 [RESTORE ${index}] Procesando nodo: ${nodeId}`);
        
        // Si no hay estado guardado para este nodo, skip
        if (savedState === undefined) {
          console.log(`   ⏭️  Sin estado guardado (será expandido por defecto)`);
          notFound++;
          return;
        }
        
        const treeNode = nodeContent.closest('.tree-node');
        const toggle = nodeContent.querySelector('.node-toggle');
        const children = treeNode ? treeNode.querySelector(':scope > .tree-children') : null;
        
        console.log(`   🔎 Toggle: ${toggle ? 'Sí' : 'No'}, Children: ${children ? 'Sí' : 'No'}`);
        
        // Si el nodo no tiene children o toggle, skip silenciosamente (es un nodo hoja)
        if (!children || !toggle) {
          console.log(`   🍃 Nodo hoja (sin children) - ignorado`);
          skipped++;
          return;
        }
        
        // Restaurar el estado
        const willBeExpanded = savedState === true;
        console.log(`   🎯 Aplicando estado: ${willBeExpanded ? 'EXPANDIDO' : 'CONTRAÍDO'}`);
        
        if (willBeExpanded) {
          // Expandido
          children.style.display = 'block';
          toggle.classList.remove('collapsed');
          toggle.classList.add('expanded');
          console.log(`   ✅ Expandido aplicado`);
        } else {
          // Contraído
          children.style.display = 'none';
          toggle.classList.remove('expanded');
          toggle.classList.add('collapsed');
          console.log(`   ✅ Contraído aplicado`);
        }
        
        restored++;
        if (usedLegacyFallback) {
          console.log('   ♻️ Estado migrado desde ID legacy');
        }
      });

      if (legacyCleanupList.length > 0) {
        const removed = legacyCleanupList.filter((id) => state[id] !== undefined);
        removed.forEach((id) => {
          delete state[id];
        });
        if (removed.length > 0) {
          console.log(`🧹 [RESTORE] Eliminados ${removed.length} IDs legacy huérfanos`);
          stateDirty = true;
        }
      }

      if (migrated > 0 || stateDirty) {
        localStorage.setItem(stateKey, JSON.stringify(state));
        console.log(`♻️ [RESTORE] Estados sincronizados (migrados: ${migrated}, limpieza: ${stateDirty ? 'sí' : 'no'})`);
      }
      
      console.log(`\n📈 [RESTORE] RESUMEN:`);
      console.log(`   ✅ Restaurados: ${restored}`);
      console.log(`   🍃 Hojas ignoradas: ${skipped}`);
      console.log(`   ⏭️  Sin estado previo: ${notFound}`);
      console.log(`   📊 Total procesados: ${allNodes.length}`);
      
    } catch (e) {
      console.error('❌ [RESTORE] Error restaurando estados:', e);
      console.error('Stack:', e.stack);
    }
  }
  
  // Guardar estado de expansión de un nodo
  saveNodeExpandState(nodeId, isExpanded, legacyNodeId = null) {
    try {
      const stateKey = 'jerarquia_expand_state';
      let state = JSON.parse(localStorage.getItem(stateKey) || '{}');
      state[nodeId] = isExpanded;
      if (legacyNodeId && legacyNodeId !== nodeId && state[legacyNodeId] !== undefined) {
        delete state[legacyNodeId];
      }
      localStorage.setItem(stateKey, JSON.stringify(state));
      console.log(`💾 [SAVE] ${nodeId} = ${isExpanded ? 'EXPANDIDO' : 'CONTRAÍDO'} (Total: ${Object.keys(state).length} estados)`);
      
      // Verificar que se guardó correctamente
      const verified = localStorage.getItem(stateKey);
      if (!verified) {
        console.error('❌ [SAVE] Error: No se pudo guardar en localStorage');
      }
    } catch (e) {
      console.error('❌ Error guardando estado de nodo:', e);
    }
  }
  
  // Obtener estado de expansión de un nodo
  getNodeExpandState(nodeId, legacyNodeId = null) {
    try {
      const stateKey = 'jerarquia_expand_state';
      const state = JSON.parse(localStorage.getItem(stateKey) || '{}');
      let savedState = state[nodeId];
      if (savedState === undefined && legacyNodeId && state[legacyNodeId] !== undefined) {
        savedState = state[legacyNodeId];
        state[nodeId] = savedState;
        if (legacyNodeId !== nodeId) {
          delete state[legacyNodeId];
        }
        localStorage.setItem(stateKey, JSON.stringify(state));
        console.log(`♻️ [GET] Migrado estado desde legacy ${legacyNodeId} -> ${nodeId}`);
      }
      // Por defecto, retornar true (expandido) si no hay estado guardado
      const result = savedState !== undefined ? savedState : true;
      console.log(`📖 [GET] ${nodeId} = ${result ? 'EXPANDIDO' : 'CONTRAÍDO'} (${savedState !== undefined ? 'guardado' : 'default'})`);
      return result;
    } catch (e) {
      console.error('❌ Error obteniendo estado de nodo:', e);
      return true; // Por defecto expandido
    }
  }
  
  // 📦 Obtener estado de expansión de lista de repuestos
  getRepuestosExpandState(nodeId) {
    try {
      const stateKey = 'jerarquia_repuestos_expand_state';
      const state = JSON.parse(localStorage.getItem(stateKey) || '{}');
      // Por defecto, expandido
      return state[nodeId] !== undefined ? state[nodeId] : true;
    } catch (e) {
      console.error('❌ Error obteniendo estado de repuestos:', e);
      return true;
    }
  }
  
  // 📦 Toggle de lista de repuestos
  toggleRepuestosList(nodeId) {
    try {
      const stateKey = 'jerarquia_repuestos_expand_state';
      const state = JSON.parse(localStorage.getItem(stateKey) || '{}');
      
      // Toggle del estado
      const currentState = state[nodeId] !== undefined ? state[nodeId] : true;
      const newState = !currentState;
      state[nodeId] = newState;
      
      localStorage.setItem(stateKey, JSON.stringify(state));
      console.log(`📦 Toggle repuestos ${nodeId}: ${newState ? 'EXPANDIDO' : 'CONTRAÍDO'}`);
      
      // Actualizar UI
      const listElement = document.getElementById(`repuestos-list-${nodeId}`);
      if (listElement) {
        listElement.style.display = newState ? 'block' : 'none';
      }
      
      // Actualizar ícono del toggle
      const toggleElements = document.querySelectorAll(`.node-repuestos-toggle`);
      toggleElements.forEach(el => {
        const onclick = el.getAttribute('onclick');
        if (onclick && onclick.includes(nodeId)) {
          if (newState) {
            el.classList.remove('collapsed');
            el.classList.add('expanded');
          } else {
            el.classList.remove('expanded');
            el.classList.add('collapsed');
          }
        }
      });
      
    } catch (e) {
      console.error('❌ Error toggle repuestos:', e);
    }
  }
  
  // Limpiar todos los estados guardados
  clearNodeExpandStates() {
    try {
      localStorage.removeItem('jerarquia_expand_state');
      localStorage.removeItem('jerarquia_repuestos_expand_state');
      console.log('🗑️ Estados de expansión limpiados');
    } catch (e) {
      console.error('Error limpiando estados:', e);
    }
  }
  
  // ============================================================
  // FIN RENDERIZADOR VISTA 3
  // ============================================================
  
  buildAreaHTML(area, aIdx, empresaId, escapeHtml) {
    const childrenId = `area_children_${aIdx}`;
    const isOpen = this.getTreeNodeState(childrenId) === 'open';
    const expandIcon = isOpen ? '\u2228' : '\u203A';
    const areaId = area.id || `AREA-${aIdx + 1}`;
    const fullId = `${empresaId}-${areaId}`;

    const childrenHtml = Array.isArray(area.subAreas) && area.subAreas.length > 0
      ? area.subAreas.map((subArea, saIdx) => this.buildSubAreaHTML(subArea, aIdx, saIdx, fullId, escapeHtml)).join('')
      : '<div class="sap-empty">Sin sub-areas</div>';

    return `
  <div class="sap-node" draggable="true" data-node-type="area" data-node-index="${aIdx}"
           ondragstart="app.onDragStartSAP(event, 'area', ${aIdx})"
           ondragover="app.onDragOverSAP(event)"
           ondragleave="app.onDragLeaveSAP(event)"
           ondrop="app.onDropSAP(event, 'area', ${aIdx})"
           ondragend="app.onDragEndSAP(event)">
        <div class="sap-node-content">
          <span class="sap-node-drag-handle">⠿</span>
          <span class="sap-node-expand" onclick="app.toggleTreeChildren('${childrenId}')">${expandIcon}</span>
          <span class="sap-node-id">${escapeHtml(fullId)}</span>
          <span class="sap-node-name" onclick="app.toggleTreeChildren('${childrenId}')">${escapeHtml(area.nombre || 'Sin nombre')}</span>
          <div class="sap-node-actions">
            <button class="sap-btn sap-btn-subnivel" onclick="app.agregarNodoJerarquia('subArea', ${aIdx})" title="Agregar sub-área">+ Sub-Área</button>
            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('area', ${aIdx})" title="Editar area">Editar</button>
            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('area', ${aIdx})" title="Eliminar area">Eliminar</button>
          </div>
        </div>
        <div id="${childrenId}" class="sap-children" style="display: ${isOpen ? 'block' : 'none'};">
          ${childrenHtml}
        </div>
      </div>
    `;
  }

  buildSubAreaHTML(subArea, aIdx, saIdx, areaFullId, escapeHtml) {
    const childrenId = `subarea_children_${aIdx}_${saIdx}`;
    const isOpen = this.getTreeNodeState(childrenId) === 'open';
    const expandIcon = isOpen ? '\u2228' : '\u203A';
    const subAreaId = subArea.id || `SUBA-${saIdx + 1}`;
    const fullId = `${areaFullId}-${subAreaId}`;

    const childrenHtml = Array.isArray(subArea.sistemas) && subArea.sistemas.length > 0
      ? subArea.sistemas.map((sistema, sIdx) => this.buildSistemaHTML(sistema, aIdx, saIdx, sIdx, fullId, escapeHtml)).join('')
      : '<div class="sap-empty">Sin sistemas</div>';

    return `
  <div class="sap-node" draggable="true" data-node-type="subArea" data-node-index="${aIdx},${saIdx}"
           ondragstart="app.onDragStartSAP(event, 'subArea', ${aIdx}, ${saIdx})"
           ondragover="app.onDragOverSAP(event)"
           ondragleave="app.onDragLeaveSAP(event)"
           ondrop="app.onDropSAP(event, 'subArea', ${aIdx}, ${saIdx})"
           ondragend="app.onDragEndSAP(event)">
        <div class="sap-node-content">
          <span class="sap-node-drag-handle">⠿</span>
          <span class="sap-node-expand" onclick="app.toggleTreeChildren('${childrenId}')">${expandIcon}</span>
          <span class="sap-node-id">${escapeHtml(fullId)}</span>
          <span class="sap-node-name" onclick="app.toggleTreeChildren('${childrenId}')">${escapeHtml(subArea.nombre || 'Sin nombre')}</span>
          <div class="sap-node-actions">
            <button class="sap-btn sap-btn-subnivel" onclick="app.agregarNodoJerarquia('sistema', ${aIdx}, ${saIdx})" title="Agregar sistema">+ Sistema</button>
            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('subArea', ${aIdx}, ${saIdx})" title="Editar sub-area">Editar</button>
            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('subArea', ${aIdx}, ${saIdx})" title="Eliminar sub-area">Eliminar</button>
          </div>
        </div>
        <div id="${childrenId}" class="sap-children" style="display: ${isOpen ? 'block' : 'none'};">
          ${childrenHtml}
        </div>
      </div>
    `;
  }

  buildSistemaHTML(sistema, aIdx, saIdx, sIdx, subAreaFullId, escapeHtml) {
    const childrenId = `sistema_children_${aIdx}_${saIdx}_${sIdx}`;
    const isOpen = this.getTreeNodeState(childrenId) === 'open';
    const expandIcon = isOpen ? '\u2228' : '\u203A';
    const sistemaId = sistema.id || `SIS-${sIdx + 1}`;
    const fullId = `${subAreaFullId}-${sistemaId}`;

    const childrenHtml = Array.isArray(sistema.subSistemas) && sistema.subSistemas.length > 0
      ? sistema.subSistemas.map((subSistema, ssIdx) => this.buildSubSistemaHTML(subSistema, aIdx, saIdx, sIdx, ssIdx, fullId, escapeHtml)).join('')
      : '<div class="sap-empty">Sin sub-sistemas</div>';

    return `
  <div class="sap-node" draggable="true" data-node-type="sistema" data-node-index="${aIdx},${saIdx},${sIdx}"
           ondragstart="app.onDragStartSAP(event, 'sistema', ${aIdx}, ${saIdx}, ${sIdx})"
           ondragover="app.onDragOverSAP(event)"
           ondragleave="app.onDragLeaveSAP(event)"
           ondrop="app.onDropSAP(event, 'sistema', ${aIdx}, ${saIdx}, ${sIdx})"
           ondragend="app.onDragEndSAP(event)">
        <div class="sap-node-content">
          <span class="sap-node-drag-handle">⠿</span>
          <span class="sap-node-expand" onclick="app.toggleTreeChildren('${childrenId}')">${expandIcon}</span>
          <span class="sap-node-id">${escapeHtml(fullId)}</span>
          <span class="sap-node-name" onclick="app.toggleTreeChildren('${childrenId}')">${escapeHtml(sistema.nombre || 'Sin nombre')}</span>
          <div class="sap-node-actions">
            <button class="sap-btn sap-btn-subnivel" onclick="app.agregarNodoJerarquia('subSistema', ${aIdx}, ${saIdx}, ${sIdx})" title="Agregar sub-sistema">+ Sub-Sistema</button>
            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('sistema', ${aIdx}, ${saIdx}, ${sIdx})" title="Editar sistema">Editar</button>
            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('sistema', ${aIdx}, ${saIdx}, ${sIdx})" title="Eliminar sistema">Eliminar</button>
          </div>
        </div>
        <div id="${childrenId}" class="sap-children" style="display: ${isOpen ? 'block' : 'none'};">
          ${childrenHtml}
        </div>
      </div>
    `;
  }

  buildSubSistemaHTML(subSistema, aIdx, saIdx, sIdx, ssIdx, sistemaFullId, escapeHtml) {
    const childrenId = `subsistema_children_${aIdx}_${saIdx}_${sIdx}_${ssIdx}`;
    const isOpen = this.getTreeNodeState(childrenId) === 'open';
    const expandIcon = isOpen ? '\u2228' : '\u203A';
    const subSistemaId = subSistema.id || `SS-${ssIdx + 1}`;
    const fullId = `${sistemaFullId}-${subSistemaId}`;

    const childrenHtml = Array.isArray(subSistema.secciones) && subSistema.secciones.length > 0
      ? subSistema.secciones.map((seccion, secIdx) => this.buildSeccionHTML(seccion, aIdx, saIdx, sIdx, ssIdx, secIdx, fullId, escapeHtml)).join('')
      : '<div class="sap-empty">Sin secciones</div>';

    return `
  <div class="sap-node" draggable="true" data-node-type="subSistema" data-node-index="${aIdx},${saIdx},${sIdx},${ssIdx}"
           ondragstart="app.onDragStartSAP(event, 'subSistema', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx})"
           ondragover="app.onDragOverSAP(event)"
           ondragleave="app.onDragLeaveSAP(event)"
           ondrop="app.onDropSAP(event, 'subSistema', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx})"
           ondragend="app.onDragEndSAP(event)">
        <div class="sap-node-content">
          <span class="sap-node-drag-handle">⠿</span>
          <span class="sap-node-expand" onclick="app.toggleTreeChildren('${childrenId}')">${expandIcon}</span>
          <span class="sap-node-id">${escapeHtml(fullId)}</span>
          <span class="sap-node-name" onclick="app.toggleTreeChildren('${childrenId}')">${escapeHtml(subSistema.nombre || 'Sin nombre')}</span>
          <div class="sap-node-actions">
            <button class="sap-btn sap-btn-subnivel" onclick="app.agregarNodoJerarquia('seccion', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx})" title="Agregar sección">+ Sección</button>
            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('subSistema', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx})" title="Editar sub-sistema">Editar</button>
            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('subSistema', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx})" title="Eliminar sub-sistema">Eliminar</button>
          </div>
        </div>
        <div id="${childrenId}" class="sap-children" style="display: ${isOpen ? 'block' : 'none'};">
          ${childrenHtml}
        </div>
      </div>
    `;
  }

  buildSeccionHTML(seccion, aIdx, saIdx, sIdx, ssIdx, secIdx, subSistemaFullId, escapeHtml) {
    const childrenId = `seccion_children_${aIdx}_${saIdx}_${sIdx}_${ssIdx}_${secIdx}`;
    const isOpen = this.getTreeNodeState(childrenId) === 'open';
    const expandIcon = isOpen ? '\u2228' : '\u203A';
    const seccionId = seccion.id || `SEC-${secIdx + 1}`;
    const fullId = `${subSistemaFullId}-${seccionId}`;

    const childrenHtml = Array.isArray(seccion.subSecciones) && seccion.subSecciones.length > 0
      ? seccion.subSecciones.map((subSeccion, sSecIdx) => this.buildSubSeccionHTML(subSeccion, aIdx, saIdx, sIdx, ssIdx, secIdx, sSecIdx, fullId, escapeHtml)).join('')
      : '<div class="sap-empty">Sin sub-secciones</div>';

    return `
  <div class="sap-node" draggable="true" data-node-type="seccion" data-node-index="${aIdx},${saIdx},${sIdx},${ssIdx},${secIdx}"
           ondragstart="app.onDragStartSAP(event, 'seccion', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx}, ${secIdx})"
           ondragover="app.onDragOverSAP(event)"
           ondragleave="app.onDragLeaveSAP(event)"
           ondrop="app.onDropSAP(event, 'seccion', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx}, ${secIdx})"
           ondragend="app.onDragEndSAP(event)">
        <div class="sap-node-content">
          <span class="sap-node-drag-handle">⠿</span>
          <span class="sap-node-expand" onclick="app.toggleTreeChildren('${childrenId}')">${expandIcon}</span>
          <span class="sap-node-id">${escapeHtml(fullId)}</span>
          <span class="sap-node-name" onclick="app.toggleTreeChildren('${childrenId}')">${escapeHtml(seccion.nombre || 'Sin nombre')}</span>
          <div class="sap-node-actions">
            <button class="sap-btn sap-btn-subnivel" onclick="app.agregarNodoJerarquia('subSeccion', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx}, ${secIdx})" title="Agregar sub-sección">+ Sub-Sección</button>
            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('seccion', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx}, ${secIdx})" title="Editar seccion">Editar</button>
            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('seccion', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx}, ${secIdx})" title="Eliminar seccion">Eliminar</button>
          </div>
        </div>
        <div id="${childrenId}" class="sap-children" style="display: ${isOpen ? 'block' : 'none'};">
          ${childrenHtml}
        </div>
      </div>
    `;
  }

  buildSubSeccionHTML(subSeccion, aIdx, saIdx, sIdx, ssIdx, secIdx, sSecIdx, seccionFullId, escapeHtml) {
    const subSeccionId = subSeccion.id || `SSEC-${sSecIdx + 1}`;
    const fullId = `${seccionFullId}-${subSeccionId}`;

    return `
  <div class="sap-node sap-node-leaf" draggable="true" data-node-type="subSeccion" data-node-index="${aIdx},${saIdx},${sIdx},${ssIdx},${secIdx},${sSecIdx}"
           ondragstart="app.onDragStartSAP(event, 'subSeccion', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx}, ${secIdx}, ${sSecIdx})"
           ondragover="app.onDragOverSAP(event)"
           ondragleave="app.onDragLeaveSAP(event)"
           ondrop="app.onDropSAP(event, 'subSeccion', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx}, ${secIdx}, ${sSecIdx})"
           ondragend="app.onDragEndSAP(event)">
        <div class="sap-node-content">
          <span class="sap-node-drag-handle">⠿</span>
          <span class="sap-node-spacer"></span>
          <span class="sap-node-id">${escapeHtml(fullId)}</span>
          <span class="sap-node-name">${escapeHtml(subSeccion.nombre || 'Sin nombre')}</span>
          <div class="sap-node-actions">
            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('subSeccion', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx}, ${secIdx}, ${sSecIdx})" title="Editar sub-seccion">Editar</button>
            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('subSeccion', ${aIdx}, ${saIdx}, ${sIdx}, ${ssIdx}, ${secIdx}, ${sSecIdx})" title="Eliminar sub-seccion">Eliminar</button>
          </div>
        </div>
      </div>
    `;
  }
  
  toggleTreeNode(nodeId) {
    const node = document.getElementById(nodeId);
    if (!node) return;
    
    const toggle = document.querySelector(`[onclick*="'${nodeId}'"]`);
    if (node.style.display === 'none') {
      node.style.display = 'block';
      if (toggle) toggle.textContent = '';
    } else {
      node.style.display = 'none';
      if (toggle) toggle.textContent = '';
    }
  }
  
  toggleTreeChildren(childrenId) {
    const children = document.getElementById(childrenId);
    if (!children) return;
    
    // Encontrar el botn de expansin correspondiente
    const expandBtn = document.querySelector(`[onclick*="${childrenId}"]`);
    
    if (children.style.display === 'none') {
      children.style.display = 'block';
      if (expandBtn && expandBtn.classList.contains('sap-node-expand')) {
        expandBtn.textContent = '\u2228';
      }
      localStorage.setItem('tree-' + childrenId, 'open');
    } else {
      children.style.display = 'none';
      if (expandBtn && expandBtn.classList.contains('sap-node-expand')) {
        expandBtn.textContent = '\u203A';
      }
      localStorage.setItem('tree-' + childrenId, 'closed');
    }
  }
  
  /**
   * [SYNC] SINCRONIZA JERARQUIA DESDE UBICACIONES
   * Agrega nodos al arbol cuando se guardan repuestos con nuevas rutas
   */
  sincronizarJerarquiaDesdeUbicaciones(ubicaciones) {
    if (!Array.isArray(ubicaciones) || ubicaciones.length === 0) {
      console.log('[WARN] No hay ubicaciones para sincronizar');
      return;
    }

    if (!this.jerarquiaAnidada || !Array.isArray(this.jerarquiaAnidada.areas)) {
      console.log('[WARN] jerarquiaAnidada no esta inicializada');
      return;
    }

    console.log('[SYNC] Iniciando sincronizacion de jerarquia...', ubicaciones);
    let cambiosRealizados = false;

    ubicaciones.forEach((ubicacion, idx) => {
      console.log(`\n[UBICACION] Procesando ubicacion ${idx + 1}:`, ubicacion);

      // Nivel 2: Area general (obligatorio)
      if (!ubicacion.areaGeneral) {
        console.log('  [WARN] Sin area general, se omite la ubicacion');
        return;
      }

      let area = this.jerarquiaAnidada.areas.find(a => a.nombre === ubicacion.areaGeneral);
      if (!area) {
        area = {
          id: `area_${Date.now()}_${Math.random()}`,
          nombre: ubicacion.areaGeneral,
          subAreas: []
        };
        this.jerarquiaAnidada.areas.push(area);
        console.log(`  [OK] Area creada: "${ubicacion.areaGeneral}"`);
        cambiosRealizados = true;
      } else {
        console.log(`  [INFO] Area ya existe: "${ubicacion.areaGeneral}"`);
      }

      // Nivel 3: Sub-area (opcional)
      if (!ubicacion.subArea) {
        console.log('  [INFO] Sin sub-area, fin del proceso para esta ubicacion');
        return;
      }

      if (!Array.isArray(area.subAreas)) area.subAreas = [];
      let subArea = area.subAreas.find(sa => sa.nombre === ubicacion.subArea);
      if (!subArea) {
        subArea = {
          id: `subarea_${Date.now()}_${Math.random()}`,
          nombre: ubicacion.subArea,
          sistemas: []
        };
        area.subAreas.push(subArea);
        console.log(`  [OK] Sub-area creada: "${ubicacion.subArea}"`);
        cambiosRealizados = true;
      } else {
        console.log(`  [INFO] Sub-area ya existe: "${ubicacion.subArea}"`);
      }

      // Nivel 4: Sistema (opcional)
      if (!ubicacion.sistemaEquipo) {
        console.log('  [INFO] Sin sistema, fin del proceso para esta ubicacion');
        return;
      }

      if (!Array.isArray(subArea.sistemas)) subArea.sistemas = [];
      let sistema = subArea.sistemas.find(s => s.nombre === ubicacion.sistemaEquipo);
      if (!sistema) {
        sistema = {
          id: `sistema_${Date.now()}_${Math.random()}`,
          nombre: ubicacion.sistemaEquipo,
          subSistemas: []
        };
        subArea.sistemas.push(sistema);
        console.log(`  [OK] Sistema creado: "${ubicacion.sistemaEquipo}"`);
        cambiosRealizados = true;
      } else {
        console.log(`  [INFO] Sistema ya existe: "${ubicacion.sistemaEquipo}"`);
      }

      // Nivel 5: Sub-sistema (opcional)
      if (!ubicacion.subSistema) {
        console.log('  [INFO] Sin sub-sistema, fin del proceso para esta ubicacion');
        return;
      }

      if (!Array.isArray(sistema.subSistemas)) sistema.subSistemas = [];
      let subSistema = sistema.subSistemas.find(ss => ss.nombre === ubicacion.subSistema);
      if (!subSistema) {
        subSistema = {
          id: `subsistema_${Date.now()}_${Math.random()}`,
          nombre: ubicacion.subSistema,
          secciones: []
        };
        sistema.subSistemas.push(subSistema);
        console.log(`  [OK] Sub-sistema creado: "${ubicacion.subSistema}"`);
        cambiosRealizados = true;
      } else {
        console.log(`  [INFO] Sub-sistema ya existe: "${ubicacion.subSistema}"`);
      }

      // Nivel 6: Seccion (opcional)
      if (!ubicacion.seccion) {
        console.log('  [INFO] Sin seccion, fin del proceso para esta ubicacion');
        return;
      }

      if (!Array.isArray(subSistema.secciones)) subSistema.secciones = [];
      let seccion = subSistema.secciones.find(sec => sec.nombre === ubicacion.seccion);
      if (!seccion) {
        seccion = {
          id: `seccion_${Date.now()}_${Math.random()}`,
          nombre: ubicacion.seccion,
          subSecciones: []
        };
        subSistema.secciones.push(seccion);
        console.log(`  [OK] Seccion creada: "${ubicacion.seccion}"`);
        cambiosRealizados = true;
      } else {
        console.log(`  [INFO] Seccion ya existe: "${ubicacion.seccion}"`);
      }

      // Nivel 7: Sub-seccion (opcional)
      if (!ubicacion.subSeccion) {
        console.log('  [INFO] Sin sub-seccion, fin del proceso para esta ubicacion');
        return;
      }

      if (!Array.isArray(seccion.subSecciones)) seccion.subSecciones = [];
      let subSeccion = seccion.subSecciones.find(ssec => ssec.nombre === ubicacion.subSeccion);
      if (!subSeccion) {
        subSeccion = {
          id: `subseccion_${Date.now()}_${Math.random()}`,
          nombre: ubicacion.subSeccion
        };
        seccion.subSecciones.push(subSeccion);
        console.log(`  [OK] Sub-seccion creada: "${ubicacion.subSeccion}"`);
        cambiosRealizados = true;
      } else {
        console.log(`  [INFO] Sub-seccion ya existe: "${ubicacion.subSeccion}"`);
      }
    });

    if (cambiosRealizados) {
      this.saveJerarquiaAnidada({
        reason: 'sincronizar-desde-ubicaciones',
        meta: {
          origen: 'sincronizarJerarquiaDesdeUbicaciones'
        }
      });
      console.log('[SAVE] Jerarquia sincronizada y guardada');

      if (this.currentTab === 'configuracion') {
        this.renderJerarquiaTree();
        console.log('[SYNC] Arbol de jerarquia actualizado en la interfaz');
      }
    } else {
      console.log('[INFO] No se realizaron cambios; todos los nodos ya existian');
    }
  }

  /**
   * Obtiene el estado guardado de un nodo del rbol
   * Por defecto retorna 'closed' (colapsado)
   */
  getTreeNodeState(childrenId) {
    return localStorage.getItem('tree-' + childrenId) || 'closed';
  }
  
  setTreeNodeState(childrenId, state) {
    if (!childrenId) return;
    localStorage.setItem('tree-' + childrenId, state);
  }
  
  // ===== DRAG & DROP PARA ÁRBOL SAP =====
  
  draggedSAPNode = null;
  
  onDragStartSAP(event, type, ...indices) {
    this.draggedSAPNode = { type, indices };
    const draggedElement = event.target.closest('.sap-node');
    draggedElement.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/html', event.target.innerHTML);
    
    // Crear indicador de drop si no existe
    if (!document.getElementById('sap-drop-indicator')) {
      const indicator = document.createElement('div');
      indicator.id = 'sap-drop-indicator';
      indicator.className = 'sap-drop-indicator';
      document.body.appendChild(indicator);
    }
    
    // Resaltar en verde todos los nodos del mismo tipo (válidos para drop)
    document.querySelectorAll('.sap-node').forEach(node => {
      const nodeType = node.dataset.nodeType || this.getNodeTypeFromElement(node);
      if (nodeType === type && node !== draggedElement) {
        node.classList.add('valid-drop-target');
      }
    });
  }

  onDragOverSAP(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    
    const target = event.target.closest('.sap-node');
    if (!target || target.classList.contains('dragging')) {
      this.hideDropIndicator();
      return;
    }
    
    // Validar si es un drop válido
    const isValid = this.isValidDropTarget(target);
    
    // Agregar clase según validez
    if (isValid) {
      target.classList.add('drag-valid');
      target.classList.remove('drag-invalid');
      target.classList.add('drag-over');
      
      // Mostrar línea de inserción
      this.showDropIndicator(target, event);
    } else {
      target.classList.add('drag-invalid');
      target.classList.remove('drag-valid', 'drag-over');
      this.hideDropIndicator();
    }
  }
  
  isValidDropTarget(targetElement) {
    if (!this.draggedSAPNode) return false;
    
    const dragType = this.draggedSAPNode.type;
    const targetType = targetElement.dataset.nodeType || this.getNodeTypeFromElement(targetElement);
    
    // Permitir drop en el mismo tipo de nodo (CAMBIO: ahora permite diferentes contenedores)
    // O permitir drop en el contenedor padre para mover entre contenedores
    return dragType === targetType;
  }
  
  getNodeTypeFromElement(element) {
    // Extraer tipo del nodo desde los atributos ondragstart
    const dragStartAttr = element.getAttribute('ondragstart');
    if (!dragStartAttr) return null;
    
    const match = dragStartAttr.match(/onDragStartSAP\(event,\s*'(\w+)'/);
    return match ? match[1] : null;
  }
  
  showDropIndicator(targetElement, event) {
    const indicator = document.getElementById('sap-drop-indicator');
    if (!indicator) return;
    
    const rect = targetElement.getBoundingClientRect();
    const mouseY = event.clientY;
    const midpoint = rect.top + rect.height / 2;
    
    // Determinar si insertar arriba o abajo
    const insertBefore = mouseY < midpoint;
    
    indicator.style.top = insertBefore ? `${rect.top + window.scrollY}px` : `${rect.bottom + window.scrollY}px`;
    indicator.style.left = `${rect.left}px`;
    indicator.style.width = `${rect.width}px`;
    indicator.classList.add('active');
    
    // Guardar posición para el drop
    this.dropPosition = insertBefore ? 'before' : 'after';
  }
  
  hideDropIndicator() {
    const indicator = document.getElementById('sap-drop-indicator');
    if (indicator) {
      indicator.classList.remove('active');
    }
  }

  onDragLeaveSAP(event) {
    const target = event.target.closest('.sap-node');
    if (target) {
      target.classList.remove('drag-over', 'drag-valid', 'drag-invalid');
    }
  }

  onDropSAP(event, targetType, ...targetIndices) {
    event.preventDefault();
    event.stopPropagation();
    
    console.log('[DROP] Evento drop disparado');
    console.log('[DROP] Target type:', targetType);
    console.log('[DROP] Target indices:', targetIndices);
    console.log('[DROP] Drop position:', this.dropPosition);
    
    const target = event.target.closest('.sap-node');
    if (target) {
      target.classList.remove('drag-over', 'drag-valid', 'drag-invalid');
    }
    
    this.hideDropIndicator();

    if (!this.draggedSAPNode) {
      console.log('[DROP] No hay nodo siendo arrastrado');
      return;
    }
    
    const { type: dragType, indices: dragIndices } = this.draggedSAPNode;
    
    console.log('[DROP] Drag type:', dragType);
    console.log('[DROP] Drag indices:', dragIndices);
    
    // No permitir soltar sobre sí mismo
    if (dragType === targetType && JSON.stringify(dragIndices) === JSON.stringify(targetIndices)) {
      console.log('[DROP] ⚠️ No puedes mover un elemento sobre sí mismo');
      return;
    }

    // Solo permitir reordenar elementos del mismo tipo
    if (dragType !== targetType) {
      console.log('[DROP] ⚠️ Solo puedes reordenar elementos del mismo tipo');
      return;
    }

    // Calcular el índice ajustado según la posición (before/after)
    let adjustedTargetIndices = [...targetIndices];
    const lastIdx = adjustedTargetIndices.length - 1;
    
    // Si insertamos "after", incrementamos el último índice
    if (this.dropPosition === 'after') {
      adjustedTargetIndices[lastIdx]++;
      console.log('[DROP] Ajustando para "after", nuevo índice:', adjustedTargetIndices[lastIdx]);
    }
    
    // NUEVO: Detectar si es mismo contenedor o movimiento entre contenedores
    const sameContainer = JSON.stringify(dragIndices.slice(0, -1)) === JSON.stringify(targetIndices.slice(0, -1));
    
    if (sameContainer) {
      // Mismo contenedor: ajustar por splice
      if (dragIndices[dragIndices.length - 1] < adjustedTargetIndices[lastIdx]) {
        adjustedTargetIndices[lastIdx]--;
        console.log('[DROP] Ajustando por splice (mismo contenedor), nuevo índice:', adjustedTargetIndices[lastIdx]);
      }
    } else {
      console.log('[DROP] Movimiento entre contenedores detectado');
    }

    console.log('[DROP] Índices ajustados finales:', adjustedTargetIndices);

    // Implementar lógica de movimiento/reordenamiento según el tipo
    this.moveOrReorderSAPNodes(dragType, dragIndices, adjustedTargetIndices, sameContainer);
  }

  onDragEndSAP(event) {
    const draggedElement = event.target.closest('.sap-node');
    if (draggedElement) {
      draggedElement.classList.remove('dragging');
    }
    this.draggedSAPNode = null;
    this.dropPosition = null;
    
    // Limpiar todas las clases drag
    document.querySelectorAll('.drag-over, .drag-valid, .drag-invalid, .valid-drop-target').forEach(el => {
      el.classList.remove('drag-over', 'drag-valid', 'drag-invalid', 'valid-drop-target');
    });
    
    // Ocultar indicador
    this.hideDropIndicator();
  }

  moveOrReorderSAPNodes(type, fromIndices, toIndices, sameContainer) {
    const hierarquia = this.jerarquiaAnidada;
    
    console.log(`[MOVE/REORDER] Tipo: ${type}`);
    console.log('[MOVE/REORDER] From:', fromIndices);
    console.log('[MOVE/REORDER] To:', toIndices);
    console.log('[MOVE/REORDER] Mismo contenedor:', sameContainer);
    
    // GUARDAR ESTADO PARA UNDO antes de hacer cambios
    this.saveHistoryState(sameContainer ? 'reorder-' + type : 'move-' + type);
    
    try {
      switch (type) {
        case 'area':
          const [fromAreaIdx] = fromIndices;
          const [toAreaIdx] = toIndices;
          
          if (fromAreaIdx === toAreaIdx) {
            console.log('[MOVE/REORDER] Mismo índice, cancelando');
            return;
          }
          
          console.log(`[MOVE/REORDER] Moviendo área de índice ${fromAreaIdx} a ${toAreaIdx}`);
          const area = hierarquia.areas.splice(fromAreaIdx, 1)[0];
          hierarquia.areas.splice(toAreaIdx, 0, area);
          break;
          
        case 'subArea':
          const [aIdx1, fromSubAreaIdx] = fromIndices;
          const [aIdx2, toSubAreaIdx] = toIndices;
          
          if (sameContainer) {
            // Mismo contenedor: reordenar dentro de la misma área
            console.log(`[MOVE/REORDER] Reordenando sub-área dentro del área ${aIdx1}`);
            const subArea = hierarquia.areas[aIdx1].subAreas.splice(fromSubAreaIdx, 1)[0];
            hierarquia.areas[aIdx1].subAreas.splice(toSubAreaIdx, 0, subArea);
          } else {
            // Diferente contenedor: mover sub-área de un área a otra
            console.log(`[MOVE/REORDER] Moviendo sub-área del área ${aIdx1} al área ${aIdx2}`);
            const subArea = hierarquia.areas[aIdx1].subAreas.splice(fromSubAreaIdx, 1)[0];
            hierarquia.areas[aIdx2].subAreas.splice(toSubAreaIdx, 0, subArea);
          }
          break;
          
        case 'sistema':
          const [a1, sa1, fromSistemaIdx] = fromIndices;
          const [a2, sa2, toSistemaIdx] = toIndices;
          
          if (sameContainer) {
            // Mismo contenedor: reordenar dentro de la misma sub-área
            console.log(`[MOVE/REORDER] Reordenando sistema dentro de área ${a1}, sub-área ${sa1}`);
            const sistema = hierarquia.areas[a1].subAreas[sa1].sistemas.splice(fromSistemaIdx, 1)[0];
            hierarquia.areas[a1].subAreas[sa1].sistemas.splice(toSistemaIdx, 0, sistema);
          } else {
            // Diferente contenedor: mover sistema de una sub-área a otra
            console.log(`[MOVE/REORDER] Moviendo sistema de área ${a1}/sub-área ${sa1} a área ${a2}/sub-área ${sa2}`);
            const sistema = hierarquia.areas[a1].subAreas[sa1].sistemas.splice(fromSistemaIdx, 1)[0];
            if (!hierarquia.areas[a2].subAreas[sa2].sistemas) {
              hierarquia.areas[a2].subAreas[sa2].sistemas = [];
            }
            hierarquia.areas[a2].subAreas[sa2].sistemas.splice(toSistemaIdx, 0, sistema);
          }
          break;
          
        case 'subSistema':
          const [a3, sa3, s3, fromSubSistemaIdx] = fromIndices;
          const [a4, sa4, s4, toSubSistemaIdx] = toIndices;
          
          if (sameContainer) {
            // Mismo contenedor: reordenar dentro del mismo sistema
            console.log(`[MOVE/REORDER] Reordenando sub-sistema dentro del sistema`);
            const subSistema = hierarquia.areas[a3].subAreas[sa3].sistemas[s3].subSistemas.splice(fromSubSistemaIdx, 1)[0];
            hierarquia.areas[a3].subAreas[sa3].sistemas[s3].subSistemas.splice(toSubSistemaIdx, 0, subSistema);
          } else {
            // Diferente contenedor: mover sub-sistema de un sistema a otro
            console.log(`[MOVE/REORDER] Moviendo sub-sistema entre sistemas`);
            const subSistema = hierarquia.areas[a3].subAreas[sa3].sistemas[s3].subSistemas.splice(fromSubSistemaIdx, 1)[0];
            if (!hierarquia.areas[a4].subAreas[sa4].sistemas[s4].subSistemas) {
              hierarquia.areas[a4].subAreas[sa4].sistemas[s4].subSistemas = [];
            }
            hierarquia.areas[a4].subAreas[sa4].sistemas[s4].subSistemas.splice(toSubSistemaIdx, 0, subSistema);
          }
          break;
          
        case 'seccion':
          const [a5, sa5, s5, ss5, fromSeccionIdx] = fromIndices;
          const [a6, sa6, s6, ss6, toSeccionIdx] = toIndices;
          
          if (sameContainer) {
            // Mismo contenedor: reordenar dentro del mismo sub-sistema
            console.log(`[MOVE/REORDER] Reordenando sección dentro del sub-sistema`);
            const seccion = hierarquia.areas[a5].subAreas[sa5].sistemas[s5].subSistemas[ss5].secciones.splice(fromSeccionIdx, 1)[0];
            hierarquia.areas[a5].subAreas[sa5].sistemas[s5].subSistemas[ss5].secciones.splice(toSeccionIdx, 0, seccion);
          } else {
            // Diferente contenedor: mover sección de un sub-sistema a otro
            console.log(`[MOVE/REORDER] Moviendo sección entre sub-sistemas`);
            const seccion = hierarquia.areas[a5].subAreas[sa5].sistemas[s5].subSistemas[ss5].secciones.splice(fromSeccionIdx, 1)[0];
            if (!hierarquia.areas[a6].subAreas[sa6].sistemas[s6].subSistemas[ss6].secciones) {
              hierarquia.areas[a6].subAreas[sa6].sistemas[s6].subSistemas[ss6].secciones = [];
            }
            hierarquia.areas[a6].subAreas[sa6].sistemas[s6].subSistemas[ss6].secciones.splice(toSeccionIdx, 0, seccion);
          }
          break;
          
        case 'subSeccion':
          const [a7, sa7, s7, ss7, sec7, fromSubSeccionIdx] = fromIndices;
          const [a8, sa8, s8, ss8, sec8, toSubSeccionIdx] = toIndices;
          
          if (sameContainer) {
            // Mismo contenedor: reordenar dentro de la misma sección
            console.log(`[MOVE/REORDER] Reordenando sub-sección dentro de la sección`);
            const subSeccion = hierarquia.areas[a7].subAreas[sa7].sistemas[s7].subSistemas[ss7].secciones[sec7].subSecciones.splice(fromSubSeccionIdx, 1)[0];
            hierarquia.areas[a7].subAreas[sa7].sistemas[s7].subSistemas[ss7].secciones[sec7].subSecciones.splice(toSubSeccionIdx, 0, subSeccion);
          } else {
            // Diferente contenedor: mover sub-sección de una sección a otra
            console.log(`[MOVE/REORDER] Moviendo sub-sección entre secciones`);
            const subSeccion = hierarquia.areas[a7].subAreas[sa7].sistemas[s7].subSistemas[ss7].secciones[sec7].subSecciones.splice(fromSubSeccionIdx, 1)[0];
            if (!hierarquia.areas[a8].subAreas[sa8].sistemas[s8].subSistemas[ss8].secciones[sec8].subSecciones) {
              hierarquia.areas[a8].subAreas[sa8].sistemas[s8].subSistemas[ss8].secciones[sec8].subSecciones = [];
            }
            hierarquia.areas[a8].subAreas[sa8].sistemas[s8].subSistemas[ss8].secciones[sec8].subSecciones.splice(toSubSeccionIdx, 0, subSeccion);
          }
          break;
          
        default:
          console.log('[MOVE/REORDER] ⚠️ Tipo de elemento no soportado');
          return;
      }
      
      // Guardar y actualizar
      localStorage.setItem('jerarquiaAnidada', JSON.stringify(hierarquia));
      console.log('[MOVE/REORDER] ✅ Operación exitosa - ' + (sameContainer ? 'Reordenado' : 'Movido entre contenedores'));
      
      // Mostrar notificación visual de éxito
      this.showMoveNotification(sameContainer ? 'Elemento reordenado ✓' : 'Elemento movido entre contenedores ✓');
      
      this.renderJerarquiaTree();
      
    } catch (error) {
      console.error('[MOVE/REORDER] Error:', error);
      this.showMoveNotification('Error al mover elemento ✗', true);
    }
  }
  
  showMoveNotification(message, isError = false) {
    // Crear notificación temporal
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${isError ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'};
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 10000;
      font-weight: 600;
      animation: slideInRight 0.3s ease-out;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Remover después de 2 segundos
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease-out';
      setTimeout(() => notification.remove(), 300);
    }, 2000);
  }

  // ========== SISTEMA UNDO/REDO ==========
  
  saveHistoryState(action = 'drag-drop') {
    // Guardar copia profunda del estado actual
    const currentState = {
      action,
      timestamp: Date.now(),
      jerarquia: JSON.parse(JSON.stringify(this.jerarquiaAnidada))
    };
    
    this.historyStack.push(currentState);
    
    // Limitar tamaño del historial
    if (this.historyStack.length > this.maxHistorySize) {
      this.historyStack.shift();
    }
    
    // Limpiar redo stack cuando se hace una nueva acción
    this.redoStack = [];
    
    this.updateUndoRedoButtons();
    console.log(`[HISTORY] Estado guardado: ${action} (stack: ${this.historyStack.length})`);
  }
  
  undo() {
    if (this.historyStack.length === 0) {
      console.log('[UNDO] No hay acciones para deshacer');
      return;
    }
    
    // Guardar estado actual en redo stack
    const currentState = {
      action: 'current',
      timestamp: Date.now(),
      jerarquia: JSON.parse(JSON.stringify(this.jerarquiaAnidada))
    };
    this.redoStack.push(currentState);
    
    // Restaurar estado anterior
    const previousState = this.historyStack.pop();
    this.jerarquiaAnidada = previousState.jerarquia;
    
    // Actualizar UI y storage
    localStorage.setItem('jerarquiaAnidada', JSON.stringify(this.jerarquiaAnidada));
    this.renderJerarquiaTree();
    this.updateUndoRedoButtons();
    
    console.log(`[UNDO] Acción deshecha: ${previousState.action}`);
  }
  
  redo() {
    if (this.redoStack.length === 0) {
      console.log('[REDO] No hay acciones para rehacer');
      return;
    }
    
    // Guardar estado actual en history stack
    const currentState = {
      action: 'before-redo',
      timestamp: Date.now(),
      jerarquia: JSON.parse(JSON.stringify(this.jerarquiaAnidada))
    };
    this.historyStack.push(currentState);
    
    // Restaurar estado siguiente
    const nextState = this.redoStack.pop();
    this.jerarquiaAnidada = nextState.jerarquia;
    
    // Actualizar UI y storage
    localStorage.setItem('jerarquiaAnidada', JSON.stringify(this.jerarquiaAnidada));
    this.renderJerarquiaTree();
    this.updateUndoRedoButtons();
    
    console.log(`[REDO] Acción rehecha`);
  }
  
  updateUndoRedoButtons() {
    const undoBtn = document.getElementById('undo-btn');
    const redoBtn = document.getElementById('redo-btn');
    
    if (undoBtn) {
      undoBtn.disabled = this.historyStack.length === 0;
      undoBtn.setAttribute('data-tooltip', 
        this.historyStack.length > 0 
          ? `Deshacer (${this.historyStack.length})`
          : 'No hay acciones'
      );
    }
    
    if (redoBtn) {
      redoBtn.disabled = this.redoStack.length === 0;
      redoBtn.setAttribute('data-tooltip', 
        this.redoStack.length > 0 
          ? `Rehacer (${this.redoStack.length})`
          : 'No hay acciones'
      );
    }

    if (this.visualV2 && typeof this.visualV2.setUndoRedoState === 'function') {
      this.visualV2.setUndoRedoState({
        canUndo: this.historyStack.length > 0,
        canRedo: this.redoStack.length > 0
      });
    }
  }
  
  initUndoRedoKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      // Ctrl+Z o Cmd+Z para Undo
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        this.undo();
      }
      // Ctrl+Y o Ctrl+Shift+Z o Cmd+Shift+Z para Redo
      else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'z'))) {
        e.preventDefault();
        this.redo();
      }
    });
  }

  /**
   * Genera una abreviatura inteligente de 3-4 letras a partir de un nombre
   */
  generarAbreviatura(nombre) {
    if (!nombre || nombre.trim() === '') return '';
    
    // Limpiar y normalizar
    let texto = nombre.trim().toUpperCase();
    
    // Remover artículos, preposiciones y palabras comunes
    const palabrasIgnorar = ['DE', 'DEL', 'LA', 'EL', 'LOS', 'LAS', 'Y', 'A', 'EN', 'CON', 'PARA', 'POR'];
    let palabras = texto.split(/[\s\-_]+/).filter(p => p && !palabrasIgnorar.includes(p));
    
    if (palabras.length === 0) {
      palabras = texto.split(/[\s\-_]+/).filter(p => p);
    }
    
    // Estrategia 1: Si es una palabra, tomar primeras 3-4 letras
    if (palabras.length === 1) {
      const palabra = palabras[0];
      if (palabra.length <= 4) return palabra;
      return palabra.substring(0, 4);
    }
    
    // Estrategia 2: Tomar iniciales de cada palabra
    let abrev = palabras.map(p => p[0]).join('');
    if (abrev.length >= 3 && abrev.length <= 4) return abrev;
    
    // Estrategia 3: Si hay muchas palabras, tomar las más significativas
    if (abrev.length > 4) {
      return abrev.substring(0, 4);
    }
    
    // Estrategia 4: Si solo 2 palabras, tomar 2 letras de cada una
    if (palabras.length === 2 && abrev.length < 3) {
      return (palabras[0].substring(0, 2) + palabras[1].substring(0, 2));
    }
    
    // Estrategia 5: Tomar consonantes principales
    let consonantes = texto.replace(/[AEIOUÁÉÍÓÚ\s\-_]/g, '');
    if (consonantes.length >= 3) {
      return consonantes.substring(0, 4);
    }
    
    // Fallback: primeras 4 letras
    return texto.replace(/[\s\-_]/g, '').substring(0, 4);
  }

  async agregarNodoJerarquia(tipo, ...indices) {
    const labels = {
      area: 'Nueva area (N2)',
      subArea: 'Nueva Sub-area (N3)',
      sistema: 'Nuevo Sistema (N4)',
      subSistema: 'Nuevo Sub-Sistema (N5)',
      seccion: 'Nueva Seccion (N6)',
      subSeccion: 'Nueva Sub-Seccion (N7)'
    };
    
    const ejemplos = {
      area: 'Ejemplo: AREA-01, PLANT-PRIN',
      subArea: 'Ejemplo: EVIS, FILET, EMPAR',
      sistema: 'Ejemplo: GRAD, GEA, BOMB-01',
      subSistema: 'Ejemplo: CINTA-L, MOT-PRIN',
      seccion: 'Ejemplo: SIST-ELEC, SIST-MEC',
      subSeccion: 'Ejemplo: PANEL-CTL, CABLEADO'
    };
    
    const label = labels[tipo] || 'Nuevo Elemento';
    const ejemplo = ejemplos[tipo] || '';
    
    const resultado = await this.showDualInputModalWithAbbrev(
      `Agregar ${label}`,
      'Codigo/ID abreviado:',
      '',
      ejemplo,
      'Nombre completo:',
      '',
      true // Habilitar auto-generación de abreviatura
    );
    
    if (resultado === null || resultado.input1.trim() === '' || resultado.input2.trim() === '') {
  this.showToast('Operacion cancelada', 'warning');
      return;
    }
    
    const nuevoNodo = {
      id: resultado.input1.trim().toUpperCase(),
      nombre: resultado.input2.trim()
    };
    
    // Agregar arrays hijos segn el tipo
    if (tipo === 'area') nuevoNodo.subAreas = [];
    if (tipo === 'subArea') nuevoNodo.sistemas = [];
    if (tipo === 'sistema') nuevoNodo.subSistemas = [];
    if (tipo === 'subSistema') nuevoNodo.secciones = [];
    if (tipo === 'seccion') nuevoNodo.subSecciones = [];
    
    // Insertar en la ubicacin correcta
    try {
      if (tipo === 'area') {
        this.jerarquiaAnidada.areas.push(nuevoNodo);
      } else if (tipo === 'subArea') {
        const [aIdx] = indices;
        this.jerarquiaAnidada.areas[aIdx].subAreas.push(nuevoNodo);
      } else if (tipo === 'sistema') {
        const [aIdx, saIdx] = indices;
        this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas.push(nuevoNodo);
      } else if (tipo === 'subSistema') {
        const [aIdx, saIdx, sIdx] = indices;
        this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas.push(nuevoNodo);
      } else if (tipo === 'seccion') {
        const [aIdx, saIdx, sIdx, ssIdx] = indices;
        this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas[ssIdx].secciones.push(nuevoNodo);
      } else if (tipo === 'subSeccion') {
        const [aIdx, saIdx, sIdx, ssIdx, secIdx] = indices;
        this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas[ssIdx].secciones[secIdx].subSecciones.push(nuevoNodo);
      }
      
      this.saveJerarquiaAnidada({
        reason: 'agregar-nodo',
        meta: {
          tipo,
          indices
        }
      });
      this.renderJerarquiaTree();
      this.showToast(` ${label} agregado: ${resultado.input2}`, 'success');
    } catch (error) {
      console.error('Error agregando nodo:', error);
      this.showToast(' Error al agregar elemento', 'error');
    }
  }
  
  async editarNodoJerarquia(tipo, ...indices) {
    try {
      let nodo;
      let label = 'Elemento';
      let ejemploID = '';
      
      if (tipo === 'empresa') {
        nodo = this.jerarquiaAnidada.empresa;
        label = 'Empresa (N1)';
        ejemploID = 'Ejemplo: AQ-IN-CHO (Empresa-Tipo-Ubicacin)';
      } else if (tipo === 'area') {
        const [aIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx];
        label = 'rea (N2)';
        ejemploID = 'Ejemplo: AREA-01, PLANT-PRIN';
      } else if (tipo === 'subArea') {
        const [aIdx, saIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx];
        label = 'Sub-rea (N3)';
        ejemploID = 'Ejemplo: EVIS, FILET, EMPAR';
      } else if (tipo === 'sistema') {
        const [aIdx, saIdx, sIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx];
        label = 'Sistema (N4)';
        ejemploID = 'Ejemplo: GRAD, GEA, BOMB-01';
      } else if (tipo === 'subSistema') {
        const [aIdx, saIdx, sIdx, ssIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas[ssIdx];
        label = 'Sub-Sistema (N5)';
        ejemploID = 'Ejemplo: CINTA-L, MOT-PRIN';
      } else if (tipo === 'seccion') {
        const [aIdx, saIdx, sIdx, ssIdx, secIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas[ssIdx].secciones[secIdx];
        label = 'Seccin (N6)';
        ejemploID = 'Ejemplo: SIST-ELEC, SIST-MEC';
      } else if (tipo === 'subSeccion') {
        const [aIdx, saIdx, sIdx, ssIdx, secIdx, subSecIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas[ssIdx].secciones[secIdx].subSecciones[subSecIdx];
        label = 'Sub-Seccin (N7)';
        ejemploID = 'Ejemplo: PANEL-CTL, CABLEADO';
      }
      
      if (!nodo) {
        this.showToast(' Elemento no encontrado', 'error');
        return;
      }
      
      // Modal con dos campos: ID y Nombre
      const resultado = await this.showDualInputModalWithAbbrev(
        `Editar ${label}`,
        'Cdigo/ID abreviado:',
        nodo.id || '',
        ejemploID,
        'Nombre completo:',
        nodo.nombre,
        false // No auto-generar si ya existe
      );
      
      if (resultado === null) {
        this.showToast(' Operacin cancelada', 'warning');
        return;
      }
      
      if (resultado.input1.trim() === '') {
        this.showToast(' El cdigo/ID no puede estar vaco', 'warning');
        return;
      }
      
      if (resultado.input2.trim() === '') {
        this.showToast(' El nombre no puede estar vaco', 'warning');
        return;
      }
      
      nodo.id = resultado.input1.trim().toUpperCase();
      nodo.nombre = resultado.input2.trim();
      this.saveJerarquiaAnidada({
        reason: 'editar-nodo',
        meta: {
          tipo,
          indices
        }
      });
      this.renderJerarquiaTree();
      this.showToast(` ${label} actualizado`, 'success');
      
    } catch (error) {
      console.error('Error editando nodo:', error);
      this.showToast(' Error al editar elemento', 'error');
    }
  }
  
  async eliminarNodoJerarquia(tipo, ...indices) {
    try {
      let nodo, label, tieneHijos = false;
      
      if (tipo === 'empresa') {
        this.showToast(' No se puede eliminar la empresa raz', 'warning');
        return;
      } else if (tipo === 'area') {
        const [aIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx];
        label = 'rea';
        tieneHijos = nodo.subAreas && nodo.subAreas.length > 0;
      } else if (tipo === 'subArea') {
        const [aIdx, saIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx];
        label = 'Sub-rea';
        tieneHijos = nodo.sistemas && nodo.sistemas.length > 0;
      } else if (tipo === 'sistema') {
        const [aIdx, saIdx, sIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx];
        label = 'Sistema';
        tieneHijos = nodo.subSistemas && nodo.subSistemas.length > 0;
      } else if (tipo === 'subSistema') {
        const [aIdx, saIdx, sIdx, ssIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas[ssIdx];
        label = 'Sub-Sistema';
        tieneHijos = nodo.secciones && nodo.secciones.length > 0;
      } else if (tipo === 'seccion') {
        const [aIdx, saIdx, sIdx, ssIdx, secIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas[ssIdx].secciones[secIdx];
        label = 'Seccin';
        tieneHijos = nodo.subSecciones && nodo.subSecciones.length > 0;
      } else if (tipo === 'subSeccion') {
        const [aIdx, saIdx, sIdx, ssIdx, secIdx, subSecIdx] = indices;
        nodo = this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas[ssIdx].secciones[secIdx].subSecciones[subSecIdx];
        label = 'Sub-Seccin';
        tieneHijos = false;
      }
      
      if (!nodo) {
        this.showToast(' Elemento no encontrado', 'error');
        return;
      }
      
      if (tieneHijos) {
        this.showToast(` No se puede eliminar "${nodo.nombre}" porque tiene elementos hijos. Elimina primero los hijos.`, 'warning');
        return;
      }
      
      const confirmar = await this.showConfirmModal(`Est seguro de eliminar "${nodo.nombre}"?\n\nEsta accin no se puede deshacer.`);
      
      if (!confirmar) {
        this.showToast(' Operacin cancelada', 'warning');
        return;
      }
      
      // Eliminar el nodo
      if (tipo === 'area') {
        const [aIdx] = indices;
        this.jerarquiaAnidada.areas.splice(aIdx, 1);
      } else if (tipo === 'subArea') {
        const [aIdx, saIdx] = indices;
        this.jerarquiaAnidada.areas[aIdx].subAreas.splice(saIdx, 1);
      } else if (tipo === 'sistema') {
        const [aIdx, saIdx, sIdx] = indices;
        this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas.splice(sIdx, 1);
      } else if (tipo === 'subSistema') {
        const [aIdx, saIdx, sIdx, ssIdx] = indices;
        this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas.splice(ssIdx, 1);
      } else if (tipo === 'seccion') {
        const [aIdx, saIdx, sIdx, ssIdx, secIdx] = indices;
        this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas[ssIdx].secciones.splice(secIdx, 1);
      } else if (tipo === 'subSeccion') {
        const [aIdx, saIdx, sIdx, ssIdx, secIdx, subSecIdx] = indices;
        this.jerarquiaAnidada.areas[aIdx].subAreas[saIdx].sistemas[sIdx].subSistemas[ssIdx].secciones[secIdx].subSecciones.splice(subSecIdx, 1);
      }
      
      this.saveJerarquiaAnidada({
        reason: 'eliminar-nodo',
        meta: {
          tipo,
          indices,
          nombre: nodo?.nombre || null
        }
      });
      this.renderJerarquiaTree();
      this.showToast(` ${label} eliminado: ${nodo.nombre}`, 'success');
      
    } catch (error) {
      console.error('Error eliminando nodo:', error);
      this.showToast(' Error al eliminar elemento', 'error');
    }
  }
  
  guardarCambiosJerarquia() {
    this.saveJerarquiaAnidada({
      reason: 'guardar-manual',
      meta: {
        origen: 'boton-guardar-jerarquia'
      }
    });
    this.showToast(' Jerarqua guardada correctamente', 'success');
    document.getElementById('btnGuardarJerarquia').style.display = 'none';
  }
  
  marcarCambiosPendientesJerarquia() {
    const btn = document.getElementById('btnGuardarJerarquia');
    if (btn) btn.style.display = 'block';
  }

  //  NUEVO: Agregar nueva categora de rea
  agregarNuevaCategoria() {
    const modal = document.getElementById('modal');
    const modalContent = document.querySelector('.modal-content');
    
    if (!modal || !modalContent) {
      console.error('Modal no encontrado');
      return;
    }

    modalContent.innerHTML = `
      <span class="close" onclick="app.cerrarModalCategoria()">&times;</span>
      <h2 style="color: var(--primary); margin-bottom: 20px; font-size: 1.5rem;"> Nueva Categora de rea</h2>
      <form id="formNuevaCategoria" style="display: flex; flex-direction: column; gap: 16px;">
        
        <div>
          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">
            ID de la Categora *
          </label>
          <input type="text" id="categoriaId" required 
                 placeholder="ej: plataforma, tanque, bomba"
                 style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.95rem;">
          <small style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-top: 4px;">
            Solo minsculas, sin espacios ni caracteres especiales
          </small>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
          <div>
            <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">
              Icono * (Emoji)
            </label>
            <input type="text" id="categoriaIcon" required maxlength="2"
                   placeholder=""
                   style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1.5rem; text-align: center;">
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">
              Nombre *
            </label>
            <input type="text" id="categoriaName" required 
                   placeholder="ej: Plataforma"
                   style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.95rem;">
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">
            Color *
          </label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="color" id="categoriaColor" required value="#3b82f6"
                   style="width: 60px; height: 40px; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; background: none;">
            <input type="text" id="categoriaColorHex" value="#3b82f6" pattern="^#[0-9A-Fa-f]{6}$"
                   placeholder="#3b82f6"
                   style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-family: monospace; font-size: 0.95rem;">
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">
            Descripcin *
          </label>
          <textarea id="categoriaDescription" required rows="2"
                    placeholder="Descripcin breve de esta categora"
                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.9rem; resize: vertical; font-family: inherit;"></textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button type="submit" 
                  style="flex: 1; background: var(--success); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem;">
             Crear Categora
          </button>
          <button type="button" onclick="app.cerrarModalCategoria()" 
                  style="flex: 1; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem;">
             Cancelar
          </button>
        </div>
      </form>
    `;

    modal.style.display = 'block';

    // Sincronizar color picker con input hex
    setTimeout(() => {
      const colorInput = document.getElementById('categoriaColor');
      const hexInput = document.getElementById('categoriaColorHex');
      
      if (colorInput && hexInput) {
        colorInput.addEventListener('input', () => {
          hexInput.value = colorInput.value;
        });
        
        hexInput.addEventListener('input', () => {
          if (/^#[0-9A-Fa-f]{6}$/.test(hexInput.value)) {
            colorInput.value = hexInput.value;
          }
        });
      }

      // Manejar envo del formulario
      const form = document.getElementById('formNuevaCategoria');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          this.guardarNuevaCategoria();
        });
      }
    }, 100);
  }

  //  NUEVO: Guardar nueva categora
  guardarNuevaCategoria() {
    const id = document.getElementById('categoriaId').value.trim().toLowerCase();
    const icon = document.getElementById('categoriaIcon').value.trim();
    const name = document.getElementById('categoriaName').value.trim();
    const color = document.getElementById('categoriaColor').value;
    const description = document.getElementById('categoriaDescription').value.trim();

    // Validar ID
    if (!/^[a-z0-9_]+$/.test(id)) {
      this.showToast(' El ID solo puede contener letras minsculas, nmeros y guiones bajos', 'error');
      return;
    }

    // Verificar si ya existe
    if (mapController.categories[id]) {
      this.showToast(' Ya existe una categora con este ID', 'error');
      return;
    }

    // Agregar nueva categora
    mapController.categories[id] = {
      icon: icon,
      name: name,
      color: color,
      description: description
    };

    // Guardar en localStorage
    localStorage.setItem('mapCategories', JSON.stringify(mapController.categories));

    this.showToast(` Categora "${name}" creada exitosamente`, 'success');
    this.renderCategoriasAreasConfig();
    mapController.renderAreasList(); // Actualizar lista de reas
    this.cerrarModalCategoria();
  }

  //  NUEVO: Cerrar modal de categoras
  cerrarModalCategoria() {
    const modal = document.getElementById('modal');
    if (modal) {
      modal.style.display = 'none';
      const modalContent = document.querySelector('.modal-content');
      if (modalContent) {
        modalContent.innerHTML = '';
      }
    }
  }

  //  NUEVO: Editar categora existente
  editarCategoria(categoryId) {
    const category = mapController.categories[categoryId];
    if (!category) return;

    const modal = document.getElementById('modal');
    const modalContent = document.querySelector('.modal-content');
    
    if (!modal || !modalContent) {
      console.error('Modal no encontrado');
      return;
    }

    modalContent.innerHTML = `
      <span class="close" onclick="app.cerrarModalCategoria()">&times;</span>
      <h2 style="color: var(--primary); margin-bottom: 20px; font-size: 1.5rem;"> Editar Categora: ${category.name}</h2>
      <form id="formEditarCategoria" style="display: flex; flex-direction: column; gap: 16px;">
        
        <div>
          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">
            ID de la Categora
          </label>
          <input type="text" value="${categoryId}" disabled
                 style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-muted); font-size: 0.95rem; cursor: not-allowed;">
          <small style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-top: 4px;">
            El ID no se puede modificar
          </small>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
          <div>
            <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">
              Icono * (Emoji)
            </label>
            <input type="text" id="editCategoriaIcon" required maxlength="2" value="${category.icon}"
                   style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1.5rem; text-align: center;">
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">
              Nombre *
            </label>
            <input type="text" id="editCategoriaName" required value="${category.name}"
                   style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.95rem;">
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">
            Color *
          </label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="color" id="editCategoriaColor" required value="${category.color}"
                   style="width: 60px; height: 40px; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; background: none;">
            <input type="text" id="editCategoriaColorHex" value="${category.color}" pattern="^#[0-9A-Fa-f]{6}$"
                   style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-family: monospace; font-size: 0.95rem;">
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">
            Descripcin *
          </label>
          <textarea id="editCategoriaDescription" required rows="2"
                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.9rem; resize: vertical; font-family: inherit;">${category.description}</textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button type="submit" 
                  style="flex: 1; background: var(--info); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem;">
             Guardar Cambios
          </button>
          <button type="button" onclick="app.cerrarModalCategoria()" 
                  style="flex: 1; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem;">
             Cancelar
          </button>
        </div>
      </form>
    `;

    modal.style.display = 'block';

    // Sincronizar color picker con input hex
    setTimeout(() => {
      const colorInput = document.getElementById('editCategoriaColor');
      const hexInput = document.getElementById('editCategoriaColorHex');
      
      if (colorInput && hexInput) {
        colorInput.addEventListener('input', () => {
          hexInput.value = colorInput.value;
        });
        
        hexInput.addEventListener('input', () => {
          if (/^#[0-9A-Fa-f]{6}$/.test(hexInput.value)) {
            colorInput.value = hexInput.value;
          }
        });
      }

      // Manejar envo del formulario
      const form = document.getElementById('formEditarCategoria');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          app.actualizarCategoria('${categoryId}');
        });
      }
    }, 100);
  }

  //  NUEVO: Actualizar categora
  actualizarCategoria(categoryId) {
    const icon = document.getElementById('editCategoriaIcon').value.trim();
    const name = document.getElementById('editCategoriaName').value.trim();
    const color = document.getElementById('editCategoriaColor').value;
    const description = document.getElementById('editCategoriaDescription').value.trim();

    // Actualizar categora
    mapController.categories[categoryId] = {
      icon: icon,
      name: name,
      color: color,
      description: description
    };

    // Guardar en localStorage
    localStorage.setItem('mapCategories', JSON.stringify(mapController.categories));

    // Actualizar todas las reas que usan esta categora (para reflejar cambios de color)
    mapController.state.areas.forEach(area => {
      if (area.category === categoryId) {
        area.color = color;
      }
    });
    mapController.saveAreas();
    mapController.draw();

    this.showToast(` Categora "${name}" actualizada exitosamente`, 'success');
    this.renderCategoriasAreasConfig();
    mapController.renderAreasList();
    this.cerrarModalCategoria();
  }

  //  NUEVO: Eliminar categora
  eliminarCategoria(categoryId) {
    const category = mapController.categories[categoryId];
    if (!category) return;

    // Contar reas que usan esta categora
    const areasUsandoCategoria = mapController.state.areas.filter(a => a.category === categoryId).length;

    let mensaje = `Eliminar la categora "${category.name}"?`;
    if (areasUsandoCategoria > 0) {
      mensaje += `\n\n ADVERTENCIA: ${areasUsandoCategoria} rea(s) del mapa usan esta categora.\nSe restablecern a la categora por defecto "rea".`;
    }

    if (!confirm(mensaje)) return;

    // Restablecer categora en reas afectadas
    if (areasUsandoCategoria > 0) {
      mapController.state.areas.forEach(area => {
        if (area.category === categoryId) {
          area.category = 'area';
          area.color = mapController.categories.area.color;
        }
      });
      mapController.saveAreas();
      mapController.draw();
      mapController.renderAreasList();
    }

    // Eliminar categora
    delete mapController.categories[categoryId];
    localStorage.setItem('mapCategories', JSON.stringify(mapController.categories));

    this.showToast(` Categora "${category.name}" eliminada`, 'success');
    this.renderCategoriasAreasConfig();
  }

  setupAutocomplete() {
    ['codProv', 'tipo', 'area', 'equipo'].forEach(field => {
      const input = document.getElementById(field);
      const list = document.getElementById(`autocomplete-${field}`);
      
      if (!input || !list) return;

      input.addEventListener('input', () => {
        const value = input.value.trim();
        if (!value) {
          list.classList.remove('active');
          return;
        }

        const suggestions = this.autocompleteData[field].filter(item =>
          item.toLowerCase().includes(value.toLowerCase())
        );

        if (suggestions.length === 0) {
          list.classList.remove('active');
          return;
        }

        list.innerHTML = suggestions.map(item => `
          <div class="autocomplete-item" onclick="app.selectAutocomplete('${field}', '${item.replace(/'/g, "\\'")}')">
            ${item}
          </div>
        `).join('');
        list.classList.add('active');
      });

      input.addEventListener('blur', () => {
        setTimeout(() => list.classList.remove('active'), 200);
      });
    });
  }

  selectAutocomplete(field, value) {
    document.getElementById(field).value = value;
    document.getElementById(`autocomplete-${field}`).classList.remove('active');
  }

  async openLightbox(id) {
    console.log(' openLightbox llamado con ID:', id);
    
    const repuesto = this.repuestos.find(r => r.id === id);
    console.log(' Repuesto encontrado:', repuesto ? repuesto.nombre : 'NO ENCONTRADO');
    
    if (!repuesto) {
      console.error(' No se encontr el repuesto con ID:', id);
      return;
    }
    
    if (!repuesto.multimedia || repuesto.multimedia.length === 0) {
      console.warn(' El repuesto no tiene multimedia');
      return;
    }
    
    this.lightboxMedias = repuesto.multimedia.filter(m => m.type === 'image' || m.type === 'video');
    console.log(' Medios encontrados:', this.lightboxMedias.length);
    
    if (this.lightboxMedias.length === 0) {
      console.warn(' No hay imgenes o videos para mostrar');
      return;
    }
    
    this.lightboxIndex = 0;
    
    // Mostrar lightbox primero
    const lightbox = document.getElementById('lightbox');
    console.log(' Activando lightbox...');
    lightbox.classList.add('active');
    
    // Luego cargar la imagen
    console.log(' Cargando imagen...');
    await this.showLightbox();
    console.log(' Lightbox mostrado');
  }

  async showLightbox() {
    const media = this.lightboxMedias[this.lightboxIndex];
    const content = document.getElementById('lightboxContent');
    
    // Mostrar loading mientras se carga
    content.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">Cargando...</div>';
    
    if (media.type === 'video') {
      content.innerHTML = `<video src="${media.url}" controls autoplay style="max-width: 100%; max-height: 90vh;"></video>`;
    } else {
      // Si es FileSystem, la URL ya es un Blob URL generado por getFirstImage
      // Solo necesitamos usarla directamente
      let imageUrl = media.url;
      
      // Si la imagen est en FileSystem pero no tiene Blob URL, cargarla
      if (media.isFileSystem && fsManager.isFileSystemMode && !imageUrl.startsWith('blob:')) {
        try {
          console.log(' Cargando imagen desde FileSystem:', media.url);
          // Cargar el archivo desde la carpeta
          const filename = media.url.replace('./imagenes/', '');
          const fileHandle = await fsManager.imagesFolder.getFileHandle(filename);
          const file = await fileHandle.getFile();
          imageUrl = URL.createObjectURL(file);
          console.log(' Blob URL creado:', imageUrl);
        } catch (error) {
          console.error(' Error cargando imagen para lightbox:', error);
          content.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">Error al cargar la imagen</div>';
          return;
        }
      }
      
      content.innerHTML = `<img id="lightboxImage" src="${imageUrl}" style="max-width: 100%; max-height: 90vh; transition: transform 0.2s ease; cursor: grab;" alt="Imagen ampliada">`;
      
      //  AGREGAR ZOOM CON SCROLL
      setTimeout(() => {
        const img = document.getElementById('lightboxImage');
        if (img) {
          let scale = 1;
          let isDragging = false;
          let startX = 0, startY = 0;
          let translateX = 0, translateY = 0;
          
          // Zoom con scroll
          content.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            scale = Math.max(1, Math.min(5, scale + delta));
            
            if (scale === 1) {
              translateX = 0;
              translateY = 0;
              img.style.cursor = 'grab';
            } else {
              img.style.cursor = scale > 1 ? 'grab' : 'default';
            }
            
            img.style.transform = `translate(${translateX / scale}px, ${translateY / scale}px) scale(${scale})`;
          }, { passive: false });
          
          // Arrastre
          img.addEventListener('mousedown', (e) => {
            if (scale > 1) {
              e.preventDefault();
              isDragging = true;
              startX = e.clientX - translateX;
              startY = e.clientY - translateY;
              img.style.cursor = 'grabbing';
            }
          });
          
          document.addEventListener('mousemove', (e) => {
            if (isDragging) {
              translateX = e.clientX - startX;
              translateY = e.clientY - startY;
              img.style.transform = `translate(${translateX / scale}px, ${translateY / scale}px) scale(${scale})`;
            }
          });
          
          document.addEventListener('mouseup', () => {
            if (isDragging) {
              isDragging = false;
              img.style.cursor = scale > 1 ? 'grab' : 'default';
            }
          });
          
          // Resetear con doble click
          img.addEventListener('dblclick', (e) => {
            e.preventDefault();
            scale = 1;
            translateX = 0;
            translateY = 0;
            img.style.cursor = 'grab';
            img.style.transform = 'translate(0px, 0px) scale(1)';
          });
        }
      }, 100);
    }
    
    document.getElementById('lightboxCounter').textContent = `${this.lightboxIndex + 1} / ${this.lightboxMedias.length}`;
  }

  closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
  }

  async lightboxPrev() {
    this.lightboxIndex = (this.lightboxIndex - 1 + this.lightboxMedias.length) % this.lightboxMedias.length;
    await this.showLightbox();
  }

  async lightboxNext() {
    this.lightboxIndex = (this.lightboxIndex + 1) % this.lightboxMedias.length;
    await this.showLightbox();
  }

  // RENDERIZAR PESTAA DE VALORES
  renderValores() {
    const resumen = document.getElementById('valoresResumen');
    const content = document.getElementById('valoresTabContent');
    
    // Calcular estadsticas generales
    const valorTotal = this.repuestos.reduce((sum, r) => sum + ((r.precio || 0) * (r.cantidad || 0)), 0);
    const valorPromedio = this.repuestos.length > 0 ? valorTotal / this.repuestos.length : 0;
    
    // Calcular valores por rea
    const areaStats = {};
    this.repuestos.forEach(r => {
      const area = r.area || 'Sin rea';
      if (!areaStats[area]) {
        areaStats[area] = { cantidad: 0, valor: 0, repuestos: [] };
      }
      const valorItem = (r.precio || 0) * (r.cantidad || 0);
      areaStats[area].cantidad++;
      areaStats[area].valor += valorItem;
      areaStats[area].repuestos.push({
        nombre: r.nombre,
        codSAP: r.codSAP,
        cantidad: r.cantidad,
        precio: r.precio || 0,
        valor: valorItem
      });
    });
    
    // Calcular valores por equipo
    const equipoStats = {};
    this.repuestos.forEach(r => {
      const equipo = r.equipo || 'Sin Equipo';
      if (!equipoStats[equipo]) {
        equipoStats[equipo] = { cantidad: 0, valor: 0 };
      }
      equipoStats[equipo].cantidad++;
      equipoStats[equipo].valor += (r.precio || 0) * (r.cantidad || 0);
    });
    
    // Calcular valores por tipo
    const tipoStats = {};
    this.repuestos.forEach(r => {
      const tipo = r.tipo || 'Sin Tipo';
      if (!tipoStats[tipo]) {
        tipoStats[tipo] = { cantidad: 0, valor: 0 };
      }
      tipoStats[tipo].cantidad++;
      tipoStats[tipo].valor += (r.precio || 0) * (r.cantidad || 0);
    });
    
    // Top 10 repuestos ms valiosos
    const topValiosos = this.repuestos
      .map(r => ({
        nombre: r.nombre,
        codSAP: r.codSAP || '',
        area: r.area,
        cantidad: r.cantidad,
        precio: r.precio || 0,
        valor: (r.precio || 0) * (r.cantidad || 0)
      }))
      .filter(r => r.valor > 0)
      .sort((a, b) => b.valor - a.valor)
      .slice(0, 10);
    
    // Construir HTML del resumen
    resumen.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
        <div>
          <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 4px; color: #94a3b8;">$${valorTotal.toLocaleString('es-ES', {minimumFractionDigits: 2})}</div>
          <div style="opacity: 0.85; font-size: 1.1rem; color: var(--text-secondary);">Valor Total del Inventario</div>
        </div>
        <div>
          <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 4px; color: #94a3b8;">$${valorPromedio.toLocaleString('es-ES', {minimumFractionDigits: 2})}</div>
          <div style="opacity: 0.85; font-size: 1.1rem; color: var(--text-secondary);">Valor Promedio por Repuesto</div>
        </div>
        <div>
          <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 4px; color: #94a3b8;">${this.repuestos.length}</div>
          <div style="opacity: 0.85; font-size: 1.1rem; color: var(--text-secondary);">Total de Repuestos</div>
        </div>
      </div>
    `;
    
    // Guardar datos para tabs
    this.valoresData = { areaStats, equipoStats, tipoStats, topValiosos, valorTotal };
    
    // Mostrar tab inicial
    this.switchValoresTab('area');
  }
  
  switchValoresTab(tab) {
    // Actualizar botones
    document.querySelectorAll('.tab-valores').forEach(btn => {
      btn.style.background = 'var(--bg-primary)';
      btn.style.color = 'var(--text-secondary)';
      btn.style.border = '1px solid var(--border-color)';
      btn.style.boxShadow = 'none';
    });
    const activeBtn = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
    activeBtn.style.background = 'var(--primary)';
    activeBtn.style.color = 'white';
    activeBtn.style.border = 'none';
    activeBtn.style.boxShadow = '0 0 15px rgba(59, 130, 246, 0.5)';
    
    const content = document.getElementById('valoresTabContent');
    const data = this.valoresData;
    let html = '';
    
    if (tab === 'area') {
      // Desglose por rea
      const sortedAreas = Object.entries(data.areaStats).sort((a, b) => b[1].valor - a[1].valor);
      sortedAreas.forEach(([area, stats]) => {
        const porcentaje = ((stats.valor / data.valorTotal) * 100).toFixed(1);
        const top5 = stats.repuestos.sort((a, b) => b.valor - a.valor).slice(0, 5);
        
        html += `
          <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h3 style="margin: 0; color: var(--primary); font-size: 1.2rem;">${area}</h3>
              <div style="text-align: right;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #7A9AB8;">$${stats.valor.toLocaleString('es-ES', {minimumFractionDigits: 2})}</div>
                <div style="font-size: 0.85rem; color: var(--gray-500);">${porcentaje}% del total</div>
              </div>
            </div>
            <div style="display: flex; gap: 20px; margin-bottom: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px;">
              <div><strong>${stats.cantidad}</strong> repuestos</div>
              <div><strong>$${(stats.valor / stats.cantidad).toLocaleString('es-ES', {minimumFractionDigits: 2})}</strong> promedio</div>
            </div>
            <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Top 5 ms valiosos:</div>
            <div style="display: grid; gap: 6px;">
              ${top5.map((r, i) => `
                <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-primary); border-radius: 6px; font-size: 0.9rem;">
                  <span><strong>${i + 1}.</strong> ${r.nombre} ${r.codSAP ? `(${r.codSAP})` : ''}</span>
                  <span style="font-weight: 600; color: #7A9AB8;">$${r.valor.toLocaleString('es-ES', {minimumFractionDigits: 2})}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
    } else if (tab === 'equipo') {
      // Desglose por Equipo
      const sortedEquipos = Object.entries(data.equipoStats).sort((a, b) => b[1].valor - a[1].valor);
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">';
      sortedEquipos.forEach(([equipo, stats]) => {
        const porcentaje = ((stats.valor / data.valorTotal) * 100).toFixed(1);
        html += `
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; border-left: 4px solid var(--info); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h4 style="margin: 0 0 12px 0; color: var(--info);">${equipo}</h4>
            <div style="font-size: 1.3rem; font-weight: bold; color: #7A9AB8; margin-bottom: 4px;">$${stats.valor.toLocaleString('es-ES', {minimumFractionDigits: 2})}</div>
            <div style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 8px;">${porcentaje}% del total</div>
            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--gray-200); font-size: 0.9rem;">
              <span>${stats.cantidad} repuestos</span>
              <span>$${(stats.valor / stats.cantidad).toFixed(2)} prom.</span>
            </div>
          </div>
        `;
      });
      html += '</div>';
    } else if (tab === 'tipo') {
      // Desglose por Tipo
      const sortedTipos = Object.entries(data.tipoStats).sort((a, b) => b[1].valor - a[1].valor);
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">';
      sortedTipos.forEach(([tipo, stats]) => {
        const porcentaje = ((stats.valor / data.valorTotal) * 100).toFixed(1);
        html += `
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; border-left: 4px solid var(--secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h4 style="margin: 0 0 12px 0; color: var(--secondary);">${tipo}</h4>
            <div style="font-size: 1.3rem; font-weight: bold; color: #7A9AB8; margin-bottom: 4px;">$${stats.valor.toLocaleString('es-ES', {minimumFractionDigits: 2})}</div>
            <div style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 8px;">${porcentaje}% del total</div>
            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--gray-200); font-size: 0.9rem;">
              <span>${stats.cantidad} repuestos</span>
              <span>$${(stats.valor / stats.cantidad).toFixed(2)} prom.</span>
            </div>
          </div>
        `;
      });
      html += '</div>';
    } else if (tab === 'top') {
      // Top 10 Ms Valiosos
      html += `
        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 16px 0; color: var(--primary);">Top 10 Repuestos Ms Valiosos</h3>
          <div style="display: grid; gap: 12px;">
            ${data.topValiosos.map((r, i) => {
              const posicion = i + 1;
              const bgPodium = i < 3 ? 'linear-gradient(135deg, rgba(91, 124, 153, 0.15) 0%, rgba(122, 154, 184, 0.15) 100%)' : 'var(--bg-primary)';
              const borderPodium = i < 3 ? 'var(--primary)' : 'var(--border-color)';
              return `
                <div style="display: grid; grid-template-columns: 40px 1fr auto; gap: 12px; align-items: center; padding: 12px; background: ${bgPodium}; border-radius: 8px; border-left: 4px solid ${borderPodium}; border: 1px solid var(--border-color);">
                  <div style="font-size: 1.5rem; text-align: center; font-weight: 700; color: var(--primary);">${posicion}</div>
                  <div>
                    <div style="font-weight: 600; color: var(--text-primary);">${r.nombre}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                      ${r.codSAP}  ${r.area}  ${r.cantidad} unidades
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 1.3rem; font-weight: bold; color: #7A9AB8;">$${r.valor.toLocaleString('es-ES', {minimumFractionDigits: 2})}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">$${r.precio.toFixed(2)} c/u</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    content.innerHTML = html;
  }

  iniciarConteo() {
    this.conteoActivo = true;
    this.conteoData = {};
    this.conteoFiltros = { search: '', estado: 'todos', area: 'todas', orden: 'codigo' };
    this.conteoAgrupadoPorArea = false;
    
    this.repuestos.forEach(r => {
      this.conteoData[r.id] = { original: r.cantidad, nuevo: r.cantidad, contado: false };
    });
    
    // Llenar select de reas
    const areas = [...new Set(this.repuestos.map(r => r.area || 'Sin rea'))].sort();
    const areaSelect = document.getElementById('conteoFilterArea');
    areaSelect.innerHTML = '<option value="todas">Todas las reas</option>' + 
      areas.map(a => `<option value="${a}">${a}</option>`).join('');
    
    // Eventos de filtros
    document.getElementById('conteoSearch').addEventListener('input', (e) => {
      this.conteoFiltros.search = e.target.value.toLowerCase();
      this.renderConteo();
    });
    document.getElementById('conteoFilterEstado').addEventListener('change', (e) => {
      this.conteoFiltros.estado = e.target.value;
      this.renderConteo();
    });
    document.getElementById('conteoFilterArea').addEventListener('change', (e) => {
      this.conteoFiltros.area = e.target.value;
      this.renderConteo();
    });
    document.getElementById('conteoOrden').addEventListener('change', (e) => {
      this.conteoFiltros.orden = e.target.value;
      this.renderConteo();
    });
    
    document.getElementById('btnIniciarConteo').style.display = 'none';
    document.getElementById('btnFinalizarConteo').style.display = 'block';
    document.getElementById('conteoFilters').style.display = 'block';
    document.getElementById('conteoProgress').style.display = 'block';
    
    this.renderConteo();
  }

  finalizarConteo() {
    // Calcular resumen de cambios
    const cambios = [];
    const grandesDiferencias = [];
    let totalContados = 0;
    let sinContar = 0;
    
    Object.keys(this.conteoData).forEach(id => {
      const conteo = this.conteoData[id];
      if (conteo.contado) {
        totalContados++;
        const diferencia = conteo.nuevo - conteo.original;
        if (diferencia !== 0) {
          const repuesto = this.repuestos.find(r => r.id === id);
          cambios.push({ repuesto, diferencia });
          
          // Diferencias mayores al 20%
          if (Math.abs(diferencia / (conteo.original || 1)) > 0.2) {
            grandesDiferencias.push({ repuesto, diferencia, porcentaje: (diferencia / (conteo.original || 1) * 100).toFixed(1) });
          }
        }
      } else {
        sinContar++;
      }
    });
    
    // Modal de confirmacin
    let mensaje = `<div style="text-align: left; max-height: 400px; overflow-y: auto;">
      <h3 style="color: var(--primary); margin-bottom: 16px;">Resumen del Conteo</h3>
      <div style="display: grid; gap: 12px; margin-bottom: 20px;">
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
          <strong>Total contados:</strong> ${totalContados} de ${this.repuestos.length}
        </div>
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
          <strong>Sin contar:</strong> ${sinContar} productos (mantendrn cantidad actual)
        </div>
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
          <strong>Con diferencias:</strong> ${cambios.length} productos
        </div>
      </div>`;
    
    if (grandesDiferencias.length > 0) {
      mensaje += `<div style="padding: 12px; background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 8px; margin-bottom: 16px;">
        <strong style="color: #ef4444;"> Diferencias Grandes (>20%):</strong>
        <ul style="margin-top: 8px;">
          ${grandesDiferencias.slice(0, 5).map(gd => 
            `<li>${gd.repuesto.codSAP}: ${gd.diferencia > 0 ? '+' : ''}${gd.diferencia} (${gd.porcentaje}%)</li>`
          ).join('')}
          ${grandesDiferencias.length > 5 ? `<li>...y ${grandesDiferencias.length - 5} ms</li>` : ''}
        </ul>
      </div>`;
    }
    
    mensaje += `<p style="margin-top: 16px;"><strong>Deseas aplicar estos cambios?</strong></p></div>`;
    
    if (!confirm(mensaje)) return;
    
    // Aplicar cambios solo a productos contados
    Object.keys(this.conteoData).forEach(id => {
      const conteo = this.conteoData[id];
      if (conteo.contado) {
        const repuesto = this.repuestos.find(r => r.id === id);
        if (repuesto) {
          repuesto.cantidad = conteo.nuevo;
        }
      }
    });
    
    // Guardar en historial
    this.guardarHistorialConteo({
      fecha: new Date().toISOString(),
      totalContados,
      sinContar,
      cambios: cambios.length,
      grandesDiferencias: grandesDiferencias.length
    });
    
    this.conteoActivo = false;
    this.saveData();
    this.render();
    
    document.getElementById('btnIniciarConteo').style.display = 'block';
    document.getElementById('btnFinalizarConteo').style.display = 'none';
    document.getElementById('conteoFilters').style.display = 'none';
    document.getElementById('conteoProgress').style.display = 'none';
    
    this.showToast(` Conteo aplicado: ${cambios.length} cambios, ${sinContar} sin modificar`, 'success');
  }

  renderConteo() {
    const grid = document.getElementById('conteoGrid');
    
    if (!this.conteoActivo) {
      const totalRepuestos = this.repuestos.length;
      const sinStock = this.repuestos.filter(r => r.cantidad === 0).length;
      const bajoStock = this.repuestos.filter(r => r.cantidad > 0 && r.cantidad <= (r.minimo || 5)).length;
      
      const bgCard = '#0f172a';
      const textPrimary = '#f8fafc';
      const textSecondary = '#cbd5e1';
      const borderColor = '#334155';
      
      grid.innerHTML = `
        <div style="max-width: 600px; margin: 0 auto; padding: 40px 20px; text-align: center;">
          <div style="font-size: 4rem; margin-bottom: 20px;"></div>
          <h2 style="color: #60a5fa; margin-bottom: 16px;">Conteo de Inventario</h2>
          <p style="color: ${textSecondary}; margin-bottom: 32px; line-height: 1.8;">
            Inicia un conteo fsico para actualizar las cantidades reales de los repuestos
          </p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 32px;">
            <div style="background: ${bgCard}; padding: 20px; border-radius: 12px; border: 1px solid ${borderColor};">
              <div style="font-size: 2rem; font-weight: 700; color: #60a5fa;">${totalRepuestos}</div>
              <div style="font-size: 0.9rem; color: ${textSecondary}; margin-top: 4px;">Total Repuestos</div>
            </div>
            <div style="background: ${bgCard}; padding: 20px; border-radius: 12px; border: 1px solid ${borderColor};">
              <div style="font-size: 2rem; font-weight: 700; color: #fbbf24;">${bajoStock}</div>
              <div style="font-size: 0.9rem; color: ${textSecondary}; margin-top: 4px;">Stock Bajo</div>
            </div>
            <div style="background: ${bgCard}; padding: 20px; border-radius: 12px; border: 1px solid ${borderColor};">
              <div style="font-size: 2rem; font-weight: 700; color: #f87171;">${sinStock}</div>
              <div style="font-size: 0.9rem; color: ${textSecondary}; margin-top: 4px;">Sin Stock</div>
            </div>
          </div>
          
          <div style="background: #0f172a; color: #22d3ee; padding: 16px; border-radius: 12px; margin-bottom: 24px; border: 1px solid #334155;">
            <strong> Consejo:</strong> Usa la cmara de tu mvil para escanear cdigos mientras cuentas
          </div>
          
          <button class="btn btn-success" style="font-size: 1.1rem; padding: 16px 32px;" onclick="app.iniciarConteo()">
            Iniciar Conteo
          </button>
        </div>
      `;
      return;
    }

    // Filtrar repuestos
    let repuestosFiltrados = this.repuestos.filter(r => {
      const conteo = this.conteoData[r.id];
      const search = this.conteoFiltros.search;
      const estado = this.conteoFiltros.estado;
      const area = this.conteoFiltros.area;
      
      // Filtro de bsqueda
      if (search) {
        const matchSearch = r.codSAP.toLowerCase().includes(search) || 
                           r.nombre.toLowerCase().includes(search) ||
                           (r.area || '').toLowerCase().includes(search);
        if (!matchSearch) return false;
      }
      
      // Filtro de estado
      if (estado === 'contados' && !conteo.contado) return false;
      if (estado === 'no-contados' && conteo.contado) return false;
      if (estado === 'diferencias' && conteo.nuevo === conteo.original) return false;
      
      // Filtro de rea
      if (area !== 'todas' && (r.area || 'Sin rea') !== area) return false;
      
      return true;
    });

    // Ordenar
    const orden = this.conteoFiltros.orden;
    repuestosFiltrados.sort((a, b) => {
      if (orden === 'codigo') return a.codSAP.localeCompare(b.codSAP);
      if (orden === 'nombre') return a.nombre.localeCompare(b.nombre);
      if (orden === 'area') return (a.area || '').localeCompare(b.area || '');
      if (orden === 'diferencia') {
        const difA = Math.abs(this.conteoData[a.id].nuevo - this.conteoData[a.id].original);
        const difB = Math.abs(this.conteoData[b.id].nuevo - this.conteoData[b.id].original);
        return difB - difA;
      }
      if (orden === 'no-contados') {
        const aContado = this.conteoData[a.id].contado ? 1 : 0;
        const bContado = this.conteoData[b.id].contado ? 1 : 0;
        return aContado - bContado;
      }
      return 0;
    });

    // Actualizar progreso
    const totalContados = Object.values(this.conteoData).filter(c => c.contado).length;
    const total = this.repuestos.length;
    const progress = (totalContados / total * 100).toFixed(0);
    
    document.getElementById('conteoProgressBar').style.width = `${progress}%`;
    document.getElementById('conteoProgressText').textContent = `${totalContados} de ${total} repuestos contados (${progress}%)  Mostrando ${repuestosFiltrados.length}`;

    // Renderizar
    if (this.conteoAgrupadoPorArea) {
      grid.innerHTML = this.renderConteoAgrupado(repuestosFiltrados);
    } else {
      grid.innerHTML = repuestosFiltrados.map(r => {
        const conteo = this.conteoData[r.id];
        const diferencia = conteo.nuevo - conteo.original;
        const multimedia = r.multimedia || [];
        const primeraImagen = multimedia.find(m => m.type === 'image');
        const porcentajeDif = conteo.original > 0 ? ((diferencia / conteo.original) * 100).toFixed(1) : 0;
        const granDiferencia = Math.abs(porcentajeDif) > 20;
        
        return `
        <div class="conteo-card-responsive ${granDiferencia ? 'conteo-alerta' : ''}">
          ${primeraImagen ? `
            <div class="conteo-img-wrapper">
              <img src="${primeraImagen.url}" class="conteo-img" alt="${r.nombre}">
            </div>
          ` : ''}
          
          <div class="conteo-info">
            <div class="conteo-header">
              <div>
                <strong class="conteo-codigo">${r.codSAP}</strong>
                <span class="conteo-nombre">${r.nombre}</span>
                ${r.area ? `<span class="conteo-area">${r.area}</span>` : ''}
              </div>
            </div>
            
            <div class="conteo-stats">
              <div class="conteo-stat-item">
                <span class="conteo-stat-label">En Sistema:</span>
                <span class="conteo-stat-value">${conteo.original}</span>
              </div>
              ${diferencia !== 0 ? `
                <div class="conteo-stat-item">
                  <span class="conteo-stat-label">Diferencia:</span>
                  <span class="conteo-diferencia ${diferencia > 0 ? 'positiva' : 'negativa'}">
                    ${diferencia > 0 ? '+' : ''}${diferencia} (${porcentajeDif}%)
                  </span>
                </div>
              ` : '<div class="conteo-stat-item"><span class="conteo-igual"> Igual</span></div>'}
              ${granDiferencia ? '<div class="conteo-revisar"> REVISAR</div>' : ''}
            </div>
          </div>
          
          <div class="conteo-control">
            <label class="conteo-label">Cantidad Fsica:</label>
            <div class="conteo-input-group">
              <button class="conteo-btn-minus" onclick="app.ajustarConteo('${r.id}', -1)" type="button">
                <span class="btn-symbol"></span>
              </button>
              <input 
                type="number" 
                class="conteo-input-number" 
                value="${conteo.nuevo}" 
                min="0"
                id="conteo-${r.id}"
                data-action="update-conteo" 
                data-id="${r.id}"
                placeholder="0"
              >
              <button class="conteo-btn-plus" onclick="app.ajustarConteo('${r.id}', 1)" type="button">
                <span class="btn-symbol">+</span>
              </button>
            </div>
          </div>
        </div>
        `;
      }).join('');
    }
  }

  renderConteoAgrupado(repuestos) {
    const porArea = {};
    repuestos.forEach(r => {
      const area = r.area || 'Sin rea';
      if (!porArea[area]) porArea[area] = [];
      porArea[area].push(r);
    });

    return Object.keys(porArea).sort().map(area => {
      const items = porArea[area];
      const contados = items.filter(r => this.conteoData[r.id].contado).length;
      const areaId = 'conteo-area-' + area.replace(/\s/g, '-');
      
      return `
        <div style="margin-bottom: 24px; border: 2px solid var(--border-color); border-radius: 12px; overflow: hidden;">
          <div onclick="app.toggleConteoArea('${areaId}')" 
            style="background: var(--bg-secondary); padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
            <div>
              <h3 style="margin: 0; color: var(--primary); font-size: 1.1rem;">
                <span id="${areaId}-icon" style="display: inline-block; transition: transform 0.3s;"></span>
                ${area}
              </h3>
            </div>
            <div style="text-align: right; font-size: 0.9rem; color: var(--text-secondary);">
              <strong style="color: var(--success);">${contados}/${items.length}</strong> contados
            </div>
          </div>
          <div id="${areaId}" style="padding: 12px;">
            ${items.map(r => {
              const conteo = this.conteoData[r.id];
              const diferencia = conteo.nuevo - conteo.original;
              const multimedia = r.multimedia || [];
              const primeraImagen = multimedia.find(m => m.type === 'image');
              
              return `
                <div class="conteo-item" style="display: grid; grid-template-columns: ${primeraImagen ? 'auto 1fr' : '1fr'}; gap: 12px; margin-bottom: 12px;">
                  ${primeraImagen ? `<img src="${primeraImagen.url}" style="width: 70px; height: 70px; object-fit: cover; border-radius: 8px;">` : ''}
                  <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                      <div>
                        <strong style="color: var(--primary);">${r.codSAP}</strong><br>
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">${r.nombre}</span>
                      </div>
                      <div style="text-align: right; font-size: 0.85rem;">
                        <div>Sistema: ${conteo.original}</div>
                        ${diferencia !== 0 ? `<div style="font-weight: 700; color: ${diferencia > 0 ? 'var(--success)' : 'var(--danger)'};">${diferencia > 0 ? '+' : ''}${diferencia}</div>` : ''}
                      </div>
                    </div>
                    <input type="number" class="conteo-input" value="${conteo.nuevo}" min="0" 
                      data-action="update-conteo" data-id="${r.id}" placeholder="Cantidad fsica"
                      style="width: 100%; padding: 10px; font-size: 1.1rem; text-align: center; font-weight: 700;">
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }).join('');
  }

  toggleConteoArea(areaId) {
    const content = document.getElementById(areaId);
    const icon = document.getElementById(areaId + '-icon');
    if (content.style.display === 'none') {
      content.style.display = 'block';
      icon.style.transform = 'rotate(0deg)';
      icon.textContent = '';
    } else {
      content.style.display = 'none';
      icon.style.transform = 'rotate(-90deg)';
      icon.textContent = '';
    }
  }

  updateConteo(id, valor) {
    if (this.conteoData[id]) {
      const nuevoValor = parseInt(valor) || 0;
      this.conteoData[id].nuevo = nuevoValor;
      this.conteoData[id].contado = true; // Marcar como contado cuando se edita
      this.renderConteo();
    }
  }

  // Ajustar conteo con botones +/-
  ajustarConteo(id, delta) {
    const input = document.getElementById(`conteo-${id}`);
    if (!input) return;
    
    const valorActual = parseInt(input.value) || 0;
    const nuevoValor = Math.max(0, valorActual + delta);
    
    input.value = nuevoValor;
    this.updateConteo(id, nuevoValor);
  }

  // Modal de conteo individual desde las tarjetas
  abrirModalConteoIndividual(id) {
    const repuesto = this.repuestos.find(r => r.id === id);
    if (!repuesto) {
      this.showToast(' Repuesto no encontrado', 'error');
      return;
    }

    //  PALETA NIEBLA Y BOSQUE (Nueva paleta minimalista)
    const NIEBLA_CARBON = '#4A5568';              // Gris oscuro carbn
    const NIEBLA_MEDIO = '#5A6778';               // Gris medio
    const NIEBLA_AZUL = '#5B7C99';                // Azul-gris brumoso
    const BOSQUE_VERDE = '#6B8E7F';               // Verde bosque suave
    const TIERRA_NARANJA = '#D4976C';             // Naranja tierra clido
    const ROJO_SUAVE = '#C76B6B';                 // Rojo suave
    
    // Calcular estadsticas y estado del stock
    const minimo = repuesto.minimo || repuesto.stockMinimo || 5;
    const cantidadActual = repuesto.cantidad || 0;
    const estadoStock = cantidadActual === 0 ? 'AGOTADO' : cantidadActual <= minimo ? 'BAJO' : 'OK';
    const colorEstado = cantidadActual === 0 ? ROJO_SUAVE : cantidadActual <= minimo ? TIERRA_NARANJA : BOSQUE_VERDE;
    const iconoEstado = cantidadActual === 0 ? '' : cantidadActual <= minimo ? '' : '';
    
    // Crear el contenido del modal con diseo minimalista y corporativo
    const modalHTML = `
      <div class="modal-backdrop-custom" id="modalConteoIndividual">
        <div class="modal-dialog-custom" style="max-width: 540px; animation: slideUp 0.3s ease-out;">
          <div class="modal-content-custom" style="border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid ${NIEBLA_CARBON};">
            
            <!-- HEADER MINIMALISTA CON NUEVA PALETA -->
            <div class="modal-header-custom" style="background: ${NIEBLA_CARBON}; color: #F7FAFC; padding: 20px 24px; border-bottom: 3px solid ${NIEBLA_AZUL};">
              <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                <span style="font-size: 1.8rem; opacity: 0.9;"></span>
                <div>
                  <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: white;">Conteo Individual</h3>
                  <p style="margin: 4px 0 0 0; opacity: 0.7; font-size: 0.8rem;">Actualiza la cantidad fsica en inventario</p>
                </div>
              </div>
              <button class="close-btn" onclick="app.cerrarModalConteoIndividual()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 32px; height: 32px; border-radius: 6px; font-size: 1.3rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'"></button>
            </div>
            
            <div class="modal-body-custom" style="padding: 24px;">
              
              <!-- CARD DE INFORMACIN DEL PRODUCTO - MINIMALISTA -->
              <div style="background: #1e293b; border: 1px solid #334155; padding: 16px; border-radius: 8px; margin-bottom: 18px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                  <h4 style="margin: 0; font-size: 1rem; color: #e2e8f0; font-weight: 600; max-width: 70%;">${repuesto.nombre}</h4>
                  <span style="background: ${colorEstado}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; opacity: 0.95;">${iconoEstado} ${estadoStock}</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.8rem; color: #A0AEC0;">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="color: ${NIEBLA_AZUL}; opacity: 0.8;"></span>
                    <span><strong style="color: #F7FAFC;">rea:</strong> ${repuesto.area || 'N/A'}</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="color: ${NIEBLA_AZUL}; opacity: 0.8;"></span>
                    <span><strong style="color: #F7FAFC;">Equipo:</strong> ${repuesto.equipo || 'N/A'}</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="color: ${NIEBLA_AZUL}; opacity: 0.8;"></span>
                    <span><strong style="color: #F7FAFC;">SAP:</strong> ${repuesto.codSAP || 'N/A'}</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="color: ${NIEBLA_AZUL}; opacity: 0.8;"></span>
                    <span><strong style="color: #F7FAFC;">Tipo:</strong> ${repuesto.tipo || 'N/A'}</span>
                  </div>
                </div>
              </div>

              <!-- CANTIDAD ACTUAL EN SISTEMA - PALETA NIEBLA -->
              <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 14px; margin-bottom: 20px; align-items: center;">
                <div style="background: ${NIEBLA_CARBON}; padding: 14px; border-radius: 8px; text-align: center; border-left: 3px solid ${NIEBLA_AZUL};">
                  <div style="font-size: 0.75rem; color: #A0AEC0; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;"> En Sistema</div>
                  <div style="font-size: 2.2rem; color: ${NIEBLA_AZUL}; font-weight: 700; line-height: 1;">${cantidadActual}</div>
                  <div style="font-size: 0.7rem; color: #718096; margin-top: 4px;">unidades</div>
                </div>
                
                <div style="font-size: 1.5rem; color: ${NIEBLA_MEDIO}; opacity: 0.6;"></div>
                
                <div style="background: ${NIEBLA_CARBON}; padding: 14px; border-radius: 8px; text-align: center; border-left: 3px solid ${TIERRA_NARANJA};">
                  <div style="font-size: 0.75rem; color: #A0AEC0; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;"> Mnimo</div>
                  <div style="font-size: 2.2rem; color: ${TIERRA_NARANJA}; font-weight: 700; line-height: 1;">${minimo}</div>
                  <div style="font-size: 0.7rem; color: #718096; margin-top: 4px;">requerido</div>
                </div>
              </div>

              <!-- INFORMACIN DE LTIMO CONTEO - MINIMALISTA -->
              ${repuesto.ultimoConteo ? `
                <div style="background: #1e293b; padding: 10px 14px; border-radius: 6px; margin-bottom: 18px; border-left: 3px solid #527853; display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 1.2rem; opacity: 0.8;"></span>
                  <div>
                    <div style="font-size: 0.75rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">ltimo conteo</div>
                    <div style="font-size: 0.85rem; color: #cbd5e1; font-weight: 600; margin-top: 3px;">
                      ${new Date(repuesto.ultimoConteo).toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </div>
                  </div>
                </div>
              ` : `
                <div style="background: #1e293b; padding: 10px 14px; border-radius: 6px; margin-bottom: 18px; border-left: 3px solid #8B5A5A; display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 1.2rem; opacity: 0.8;"></span>
                  <div>
                    <div style="font-size: 0.75rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Sin conteo previo</div>
                    <div style="font-size: 0.8rem; color: #cbd5e1; margin-top: 3px;">Este es el primer conteo que se registrar</div>
                  </div>
                </div>
              `}

              <!-- SECCIN DE CONTEO - MINIMALISTA -->
              <div style="margin-bottom: 18px;">
                <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 12px; color: #cbd5e1; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                  <span style="font-size: 1.1rem; opacity: 0.8;"></span>
                  Nueva Cantidad Fsica:
                </label>
                
                <!-- CONTADOR MINIMALISTA CON BOTONES +/- -->
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 14px;">
                  <button 
                    class="btn" 
                    onclick="const input = document.getElementById('inputConteoIndividual'); input.value = Math.max(0, parseInt(input.value || 0) - 1); input.focus();" 
                    style="background: ${ROJO_SUAVE}; color: #F7FAFC; font-size: 2rem; font-weight: 700; padding: 0; min-width: 65px; height: 65px; border-radius: 8px; border: 1px solid #A85555; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;"
                    onmouseover="this.style.background='#A85555'"
                    onmouseout="this.style.background='${ROJO_SUAVE}'"
                    title="Disminuir cantidad">
                    
                  </button>
                  
                  <input 
                    type="number" 
                    id="inputConteoIndividual" 
                    class="form-control" 
                    value="${cantidadActual}" 
                    min="0" 
                    style="font-size: 2.2rem; text-align: center; font-weight: 700; flex: 1; height: 65px; border: 2px solid ${NIEBLA_AZUL}; border-radius: 8px; background: #3A4556; color: #F7FAFC; transition: all 0.2s;"
                    onfocus="this.style.borderColor='${NIEBLA_AZUL}'; this.style.background='${NIEBLA_CARBON}'"
                    onblur="this.style.borderColor='${NIEBLA_MEDIO}'; this.style.background='#3A4556'"
                    autofocus
                  />
                  
                  <button 
                    class="btn" 
                    onclick="const input = document.getElementById('inputConteoIndividual'); input.value = parseInt(input.value || 0) + 1; input.focus();" 
                    style="background: ${BOSQUE_VERDE}; color: #F7FAFC; font-size: 2rem; font-weight: 700; padding: 0; min-width: 65px; height: 65px; border-radius: 8px; border: 1px solid #557566; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;"
                    onmouseover="this.style.background='#557566'"
                    onmouseout="this.style.background='${BOSQUE_VERDE}'"
                    title="Aumentar cantidad">
                    +
                  </button>
                </div>
                
                <!-- BOTONES RPIDOS MINIMALISTAS -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                  <button class="btn btn-sm" onclick="document.getElementById('inputConteoIndividual').value = 0; document.getElementById('inputConteoIndividual').focus();" 
                    style="background: ${NIEBLA_CARBON}; color: #F7FAFC; padding: 10px 8px; border-radius: 6px; border: 1px solid #5A6778; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.background='${ROJO_SUAVE}'; this.style.borderColor='#A85555'"
                    onmouseout="this.style.background='${NIEBLA_CARBON}'; this.style.borderColor='#5A6778'">
                     Vaco (0)
                  </button>
                  <button class="btn btn-sm" onclick="document.getElementById('inputConteoIndividual').value = ${cantidadActual}; document.getElementById('inputConteoIndividual').focus();" 
                    style="background: ${NIEBLA_CARBON}; color: #F7FAFC; padding: 10px 8px; border-radius: 6px; border: 1px solid #5A6778; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.background='${NIEBLA_AZUL}'; this.style.borderColor='#4A6278'"
                    onmouseout="this.style.background='${NIEBLA_CARBON}'; this.style.borderColor='#5A6778'">
                     = Sistema
                  </button>
                  <button class="btn btn-sm" onclick="document.getElementById('inputConteoIndividual').value = ${minimo}; document.getElementById('inputConteoIndividual').focus();" 
                    style="background: ${NIEBLA_CARBON}; color: #F7FAFC; padding: 10px 8px; border-radius: 6px; border: 1px solid #5A6778; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.background='${TIERRA_NARANJA}'; this.style.borderColor='#B8825A'"
                    onmouseout="this.style.background='${NIEBLA_CARBON}'; this.style.borderColor='#5A6778'">
                     = Mnimo
                  </button>
                </div>
              </div>

              <!-- NOTA INFORMATIVA CON NUEVA PALETA -->
              <div style="background: #3A4556; padding: 12px 14px; border-radius: 6px; border-left: 3px solid ${NIEBLA_MEDIO}; font-size: 0.8rem; color: #A0AEC0; display: flex; gap: 10px; align-items: start;">
                <span style="font-size: 1.1rem; line-height: 1; opacity: 0.7;"></span>
                <div>
                  <strong style="display: block; margin-bottom: 3px; color: #cbd5e1; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Nota:</strong>
                  Se actualizar la cantidad y se registrar la fecha/hora del conteo automticamente.
                </div>
              </div>
            </div>

            <!-- FOOTER CON NUEVA PALETA -->
            <div class="modal-footer-custom" style="display: flex; gap: 10px; justify-content: flex-end; padding: 16px 24px; background: #2D3748; border-top: 1px solid ${NIEBLA_CARBON};">
              <button class="btn" onclick="app.cerrarModalConteoIndividual()" 
                style="background: ${NIEBLA_CARBON}; color: #F7FAFC; padding: 10px 24px; font-weight: 600; border-radius: 6px; border: 1px solid #5A6778; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;"
                onmouseover="this.style.background='#5A6778'"
                onmouseout="this.style.background='${NIEBLA_CARBON}'">
                 Cancelar
              </button>
              <button class="btn" onclick="app.guardarConteoIndividual('${id}')" 
                style="background: ${BOSQUE_VERDE}; color: #F7FAFC; padding: 10px 28px; font-weight: 600; border-radius: 6px; border: 1px solid #557566; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;"
                onmouseover="this.style.background='#557566'"
                onmouseout="this.style.background='${BOSQUE_VERDE}'">
                 Guardar Conteo
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <style>
        @keyframes slideUp {
          from {
            opacity: 0;
            transform: translateY(30px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
      </style>
    `;

    // Inyectar el modal en el body
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);

    // Focus en el input despus de un pequeo delay
    setTimeout(() => {
      const input = document.getElementById('inputConteoIndividual');
      if (input) {
        input.focus();
        input.select();
      }
    }, 100);

    // Cerrar con ESC
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        this.cerrarModalConteoIndividual();
        document.removeEventListener('keydown', handleEsc);
      }
    };
    document.addEventListener('keydown', handleEsc);

    // Guardar con Enter
    const handleEnter = (e) => {
      if (e.key === 'Enter' && e.target.id === 'inputConteoIndividual') {
        this.guardarConteoIndividual(id);
        document.removeEventListener('keydown', handleEnter);
      }
    };
    document.addEventListener('keydown', handleEnter);
  }

  cerrarModalConteoIndividual() {
    const modal = document.getElementById('modalConteoIndividual');
    if (modal) {
      modal.parentElement.remove();
    }
  }

  async guardarConteoIndividual(id) {
    const input = document.getElementById('inputConteoIndividual');
    if (!input) return;

    const nuevaCantidad = parseInt(input.value) || 0;
    const repuesto = this.repuestos.find(r => r.id === id);
    
    if (!repuesto) {
      this.showToast(' Error: Repuesto no encontrado', 'error');
      return;
    }

    const cantidadAnterior = repuesto.cantidad;

    //  CERRAR MODAL INMEDIATAMENTE (antes de guardar)
    this.cerrarModalConteoIndividual();

    // Actualizar cantidad y fecha de conteo
    repuesto.cantidad = nuevaCantidad;
    repuesto.ultimoConteo = new Date().toISOString();
    repuesto.ultimaModificacion = new Date().toISOString();

    console.log(' Guardando conteo individual:', {
      id: repuesto.id,
      nombre: repuesto.nombre,
      cantidadAnterior,
      nuevaCantidad,
      ultimoConteo: repuesto.ultimoConteo
    });

    //  GUARDAR USANDO saveData() para actualizar EMBEDDED_DATA automticamente
    const guardadoExitoso = await this.saveData();
    
    if (!guardadoExitoso) {
      this.showToast(' Error al guardar el conteo', 'error');
      // Revertir cambios si fall
      repuesto.cantidad = cantidadAnterior;
      return;
    }

    console.log(' Conteo guardado exitosamente (EMBEDDED_DATA actualizado)');

    // Mostrar notificacin con diferencia y fecha/hora
    const diferencia = nuevaCantidad - cantidadAnterior;
    const textoDiferencia = diferencia !== 0 ? ` (${diferencia > 0 ? '+' : ''}${diferencia})` : '';
    const fechaHora = new Date().toLocaleString('es-ES', { 
      day: '2-digit', 
      month: '2-digit', 
      year: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    this.showToast(
      `Conteo guardado: <strong>${repuesto.nombre}</strong><br>${cantidadAnterior}  ${nuevaCantidad}${textoDiferencia}<br>${fechaHora}`,
      'success',
      4000
    );

    // Re-renderizar la vista completa para actualizar (mvil o PC)
    await this.renderInventario();
  }

  accionMasivaConteo(accion) {
    if (accion === 'copiar-sistema') {
      if (!confirm('Copiar las cantidades del sistema a todos los productos fsicos?')) return;
      Object.keys(this.conteoData).forEach(id => {
        this.conteoData[id].nuevo = this.conteoData[id].original;
        this.conteoData[id].contado = true;
      });
      this.showToast(' Cantidades del sistema copiadas', 'success');
    } else if (accion === 'resetear') {
      if (!confirm('Resetear todo el conteo? Se perdern los cambios.')) return;
      Object.keys(this.conteoData).forEach(id => {
        this.conteoData[id].nuevo = this.conteoData[id].original;
        this.conteoData[id].contado = false;
      });
      this.showToast(' Conteo reseteado', 'info');
    } else if (accion === 'aplicar-no-contados') {
      let noContados = 0;
      Object.keys(this.conteoData).forEach(id => {
        if (!this.conteoData[id].contado) {
          this.conteoData[id].nuevo = this.conteoData[id].original;
          noContados++;
        }
      });
      this.showToast(` Cantidad del sistema aplicada a ${noContados} productos no contados`, 'success');
    }
    this.renderConteo();
  }

  toggleAgruparPorArea() {
    this.conteoAgrupadoPorArea = !this.conteoAgrupadoPorArea;
    document.getElementById('btnAgruparTexto').textContent = this.conteoAgrupadoPorArea ? 'Vista Normal' : 'Agrupar por rea';
    this.renderConteo();
  }

  guardarHistorialConteo(datos) {
    const historial = JSON.parse(localStorage.getItem('historialConteos') || '[]');
    historial.unshift(datos);
    if (historial.length > 20) historial.pop(); // Mantener solo 20
    localStorage.setItem('historialConteos', JSON.stringify(historial));
  }

  async exportarJSON() {
    if (!this.fsManager.directoryHandle) {
      this.showToast(' Primero debes seleccionar una carpeta', 'warning');
      return;
    }

    try {
      // Preparar datos solo SIN multimedia (las imgenes quedan en FileSystem)
      const exportData = {
        version: '2.4',
        exportDate: new Date().toISOString(),
        repuestos: this.repuestos.map(r => ({
          id: r.id,
          codSAP: r.codSAP,
          codProv: r.codProv,
          tipo: r.tipo,
          nombre: r.nombre,
          area: r.area,
          equipo: r.equipo,
          cantidad: r.cantidad,
          minimo: r.minimo,
          precio: r.precio,
          // multimedia queda vaco - las imgenes estn en FileSystem
          multimedia: []
        })),
        mapa: this.mapObjects || []
      };

      const jsonString = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });

      // Guardar en INVENTARIO_STORAGE/repuestos.json
      const fileName = 'repuestos.json';
      const fileHandle = await this.fsManager.directoryHandle.getFileHandle(fileName, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();

      // Registrar en historial
      this.registrarSincronizacion({
        tipo: 'exportacion',
        fecha: new Date().toISOString(),
        productos: this.repuestos.length,
        archivo: fileName,
        tamao: (blob.size / 1024).toFixed(2) + ' KB'
      });

      this.showToast(` JSON exportado: ${fileName} (${(blob.size / 1024).toFixed(2)} KB)`, 'success');
    } catch (error) {
      console.error('Error exportando JSON:', error);
      this.showToast(' Error al exportar: ' + error.message, 'error');
    }
  }

  async importarJSON() {
    if (!this.fsManager.directoryHandle) {
      this.showToast(' Primero debes seleccionar una carpeta', 'warning');
      return;
    }

    try {
      // Leer repuestos.json de la carpeta
      const fileHandle = await this.fsManager.directoryHandle.getFileHandle('repuestos.json');
      const file = await fileHandle.getFile();
      const content = await file.text();
      const data = JSON.parse(content);

      const cantidadImportada = data.repuestos?.length || 0;
      
      const accion = confirm(
        ` Archivo encontrado: repuestos.json\n\n` +
        `Productos en archivo: ${cantidadImportada}\n` +
        `Productos actuales: ${this.repuestos.length}\n\n` +
        `Cmo deseas importar?\n\n` +
        ` ACEPTAR = FUSIONAR (actualizar datos, mantener imgenes locales)\n` +
        ` CANCELAR = Cancelar operacin`
      );

      if (!accion) {
        this.showToast('Importacin cancelada', 'info');
        return;
      }

      // FUSIN INTELIGENTE
      const nuevosRepuestos = data.repuestos.map(importado => {
        // Buscar si ya existe por ID o cdigo SAP
        const existente = this.repuestos.find(r => 
          r.id === importado.id || r.codSAP === importado.codSAP
        );

        if (existente) {
          // ACTUALIZAR: Mantener multimedia local, actualizar resto de datos
          return {
            ...importado,
            multimedia: existente.multimedia || [] // Preservar imgenes locales
          };
        } else {
          // NUEVO: Agregar sin multimedia
          return {
            ...importado,
            multimedia: []
          };
        }
      });

      const productosNuevos = nuevosRepuestos.length - this.repuestos.length;
      const productosActualizados = Math.min(nuevosRepuestos.length, this.repuestos.length);

      this.repuestos = nuevosRepuestos;

      // Importar mapa si existe
      if (data.mapa) {
        this.mapObjects = data.mapa;
        localStorage.setItem('mapData', JSON.stringify(this.mapObjects));
      }

      this.saveData();
      this.updateAutocompleteData();
      this.render();
      this.renderFilters();

      // Registrar en historial
      this.registrarSincronizacion({
        tipo: 'importacion',
        fecha: new Date().toISOString(),
        productos: nuevosRepuestos.length,
        nuevos: productosNuevos > 0 ? productosNuevos : 0,
        actualizados: productosActualizados,
        archivo: 'repuestos.json',
        tamao: (file.size / 1024).toFixed(2) + ' KB'
      });

      this.showToast(
        ` Importacin completa: ${productosActualizados} actualizados, ${productosNuevos > 0 ? productosNuevos : 0} nuevos`,
        'success'
      );
    } catch (error) {
      if (error.name === 'NotFoundError') {
        this.showToast(' No se encontr repuestos.json en la carpeta', 'warning');
      } else {
        console.error('Error importando JSON:', error);
        this.showToast(' Error al importar: ' + error.message, 'error');
      }
    }
  }

  registrarSincronizacion(datos) {
    const historial = JSON.parse(localStorage.getItem('historialSincronizaciones') || '[]');
    historial.unshift(datos);
    if (historial.length > 50) historial.pop(); // Mantener 50 registros
    localStorage.setItem('historialSincronizaciones', JSON.stringify(historial));
  }

  verHistorialSincronizaciones() {
    const historial = JSON.parse(localStorage.getItem('historialSincronizaciones') || '[]');
    
    if (historial.length === 0) {
      this.showToast(' No hay sincronizaciones registradas', 'info');
      return;
    }

    const html = `
      <div style="max-height: 500px; overflow-y: auto;">
        <h3 style="color: var(--primary); margin-bottom: 16px;"> Historial de Sincronizaciones</h3>
        <div style="display: grid; gap: 12px;">
          ${historial.slice(0, 20).map((sync, i) => {
            const fecha = new Date(sync.fecha);
            const icono = sync.tipo === 'exportacion' ? '' : '';
            const color = sync.tipo === 'exportacion' ? 'var(--success)' : 'var(--info)';
            
            return `
              <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${color};">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <strong style="color: ${color};">${icono} ${sync.tipo.toUpperCase()}</strong>
                  <span style="font-size: 0.85rem; color: var(--text-secondary);">
                    ${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString()}
                  </span>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                   Productos: ${sync.productos} |  ${sync.archivo} (${sync.tamao})
                  ${sync.nuevos ? `<br> Nuevos: ${sync.nuevos} |  Actualizados: ${sync.actualizados}` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
        ${historial.length > 20 ? `<div style="text-align: center; padding: 12px; color: var(--text-secondary);">... y ${historial.length - 20} ms</div>` : ''}
      </div>
    `;

    // Mostrar en modal (reutilizar el modal existente)
    const modal = document.getElementById('modal');
    const modalContent = modal.querySelector('.modal-content');
    const oldContent = modalContent.innerHTML;
    modalContent.innerHTML = html + `<div style="text-align: center; margin-top: 20px;"><button class="btn btn-secondary" onclick="document.getElementById('modal').style.display='none'">Cerrar</button></div>`;
    modal.style.display = 'flex';
  }

  // ========================================
  //  MTODOS DE JERARQUA ELIMINADOS
  // ========================================
  // Se eliminaron ~5,300 lneas de cdigo antiguo de jerarqua
  // Ahora se usa SOLO el rbol SAP PM (ver mtodos ms abajo)
  
  // ========================================
  //  MTODOS AUXILIARES PARA FILTROS EN CASCADA
  // ========================================
  
  /**
   * Actualiza los selectores de filtros en cascada cuando cambia un filtro
   */
  filtrarEscalonado(nivel, valor) {
    const filtroPlanta = document.getElementById('filtro_planta');
    const filtroArea = document.getElementById('filtro_area');
    const filtroSubArea = document.getElementById('filtro_subarea');
    const filtroSistema = document.getElementById('filtro_sistemaEquipo');
    const filtroSubSistema = document.getElementById('filtro_subsistema');
    const filtroSeccion = document.getElementById('filtro_seccion');
    const filtroDetalle = document.getElementById('filtro_detalle');
    const btnLimpiar = document.getElementById('btnLimpiarFiltros');
    
    // Mostrar botn limpiar si hay algn filtro activo
    const hayFiltros = filtroPlanta.value || filtroArea.value || filtroSubArea.value || 
                       filtroSistema.value || filtroSubSistema.value || filtroSeccion.value || filtroDetalle.value;
    btnLimpiar.style.display = hayFiltros ? 'inline-block' : 'none';
    
    if (nivel === 1 && valor) {
      // Planta seleccionada  mostrar reas
      filtroArea.style.display = 'block';
      const areas = [...new Set(
        this.repuestos
          .filter(r => r.planta === valor && r.areaGeneral)
          .map(r => r.areaGeneral)
      )].sort();
      
      filtroArea.innerHTML = '<option value=""> Todas las reas</option>';
      areas.forEach(a => {
        filtroArea.innerHTML += `<option value="${a}">${a}</option>`;
      });
      
      // Ocultar niveles siguientes
      filtroSubArea.style.display = 'none';
      filtroSubArea.value = '';
      filtroSistema.style.display = 'none';
      filtroSistema.value = '';
      filtroSubSistema.style.display = 'none';
      filtroSubSistema.value = '';
      filtroSeccion.style.display = 'none';
      filtroSeccion.value = '';
      filtroDetalle.style.display = 'none';
      filtroDetalle.value = '';
      
    } else if (nivel === 2 && valor) {
      // rea seleccionada  mostrar sub-reas
      filtroSubArea.style.display = 'block';
      const subareas = [...new Set(
        this.repuestos
          .filter(r => r.planta === filtroPlanta.value && r.areaGeneral === valor && r.subArea)
          .map(r => r.subArea)
      )].sort();
      
      filtroSubArea.innerHTML = '<option value=""> Todas las sub-reas</option>';
      subareas.forEach(s => {
        filtroSubArea.innerHTML += `<option value="${s}">${s}</option>`;
      });
      
      // Ocultar niveles siguientes
      filtroSistema.style.display = 'none';
      filtroSistema.value = '';
      filtroSubSistema.style.display = 'none';
      filtroSubSistema.value = '';
      filtroSeccion.style.display = 'none';
      filtroSeccion.value = '';
      filtroDetalle.style.display = 'none';
      filtroDetalle.value = '';
      
    } else if (nivel === 3 && valor) {
      // Sub-rea seleccionada  mostrar sistemas
      filtroSistema.style.display = 'block';
      const sistemas = [...new Set(
        this.repuestos
          .filter(r => 
            r.planta === filtroPlanta.value && 
            r.areaGeneral === filtroArea.value && 
            r.subArea === valor && 
            r.sistemaEquipo
          )
          .map(r => r.sistemaEquipo)
      )].sort();
      
      filtroSistema.innerHTML = '<option value=""> Todos los sistemas</option>';
      sistemas.forEach(s => {
        filtroSistema.innerHTML += `<option value="${s}">${s}</option>`;
      });
      
      // Ocultar niveles siguientes
      filtroSubSistema.style.display = 'none';
      filtroSubSistema.value = '';
      filtroSeccion.style.display = 'none';
      filtroSeccion.value = '';
      filtroDetalle.style.display = 'none';
      filtroDetalle.value = '';
      
    } else if (nivel === 4 && valor) {
      // Sistema seleccionado  mostrar sub-sistemas
      filtroSubSistema.style.display = 'block';
      const subsistemas = [...new Set(
        this.repuestos
          .filter(r => 
            r.planta === filtroPlanta.value && 
            r.areaGeneral === filtroArea.value && 
            r.subArea === filtroSubArea.value && 
            r.sistemaEquipo === valor && 
            r.subSistema
          )
          .map(r => r.subSistema)
      )].sort();
      
      filtroSubSistema.innerHTML = '<option value=""> Todos los sub-sistemas</option>';
      subsistemas.forEach(s => {
        filtroSubSistema.innerHTML += `<option value="${s}">${s}</option>`;
      });
      
      // Ocultar niveles siguientes
      filtroSeccion.style.display = 'none';
      filtroSeccion.value = '';
      filtroDetalle.style.display = 'none';
      filtroDetalle.value = '';
      
    } else if (nivel === 5 && valor) {
      // Sub-sistema seleccionado  mostrar secciones
      filtroSeccion.style.display = 'block';
      const secciones = [...new Set(
        this.repuestos
          .filter(r => 
            r.planta === filtroPlanta.value && 
            r.areaGeneral === filtroArea.value && 
            r.subArea === filtroSubArea.value && 
            r.sistemaEquipo === filtroSistema.value && 
            r.subSistema === valor && 
            r.seccion
          )
          .map(r => r.seccion)
      )].sort();
      
      filtroSeccion.innerHTML = '<option value=""> Todas las secciones</option>';
      secciones.forEach(s => {
        filtroSeccion.innerHTML += `<option value="${s}">${s}</option>`;
      });
      
      // Ocultar nivel siguiente
      filtroDetalle.style.display = 'none';
      filtroDetalle.value = '';
      
    } else if (nivel === 6 && valor) {
      // Seccin seleccionada  mostrar detalles
      filtroDetalle.style.display = 'block';
      const detalles = [...new Set(
        this.repuestos
          .filter(r => 
            r.planta === filtroPlanta.value && 
            r.areaGeneral === filtroArea.value && 
            r.subArea === filtroSubArea.value && 
            r.sistemaEquipo === filtroSistema.value && 
            r.subSistema === filtroSubSistema.value && 
            r.seccion === valor && 
            r.detalle
          )
          .map(r => r.detalle)
      )].sort();
      
      filtroDetalle.innerHTML = '<option value=""> Todos los detalles</option>';
      detalles.forEach(d => {
        filtroDetalle.innerHTML += `<option value="${d}">${d}</option>`;
      });
    }
    
    // Actualizar breadcrumb y renderizar rbol
    this.actualizarBreadcrumbFiltros();
    this.renderSAPTree();
  }
  
  /**
   * Actualiza el breadcrumb visual de filtros activos
   */
  actualizarBreadcrumbFiltros() {
    const breadcrumb = document.getElementById('filtrosBreadcrumb');
    const breadcrumbPath = document.getElementById('breadcrumbPath');
    
    const filtroPlanta = document.getElementById('filtro_planta')?.value || '';
    const filtroArea = document.getElementById('filtro_area')?.value || '';
    const filtroSubArea = document.getElementById('filtro_subarea')?.value || '';
    const filtroSistema = document.getElementById('filtro_sistemaEquipo')?.value || '';
    const filtroSubSistema = document.getElementById('filtro_subsistema')?.value || '';
    const filtroSeccion = document.getElementById('filtro_seccion')?.value || '';
    const filtroDetalle = document.getElementById('filtro_detalle')?.value || '';
    
    // Si no hay filtros activos, ocultar breadcrumb
    if (!filtroPlanta && !filtroArea && !filtroSubArea && !filtroSistema && !filtroSubSistema && !filtroSeccion && !filtroDetalle) {
      breadcrumb.style.display = 'none';
      return;
    }
    
    // Construir ruta visual
    let ruta = [];
    
    if (filtroPlanta) {
      ruta.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroPlanta}</span>`);
    }
    if (filtroArea) {
      ruta.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroArea}</span>`);
    }
    if (filtroSubArea) {
      ruta.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroSubArea}</span>`);
    }
    if (filtroSistema) {
      ruta.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroSistema}</span>`);
    }
    if (filtroSubSistema) {
      ruta.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroSubSistema}</span>`);
    }
    if (filtroSeccion) {
      ruta.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroSeccion}</span>`);
    }
    if (filtroDetalle) {
      ruta.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroDetalle}</span>`);
    }
    
    // Unir con flechas
    breadcrumbPath.innerHTML = ruta.join(' <span style="opacity: 0.6;"></span> ');
    
    // Mostrar breadcrumb
    breadcrumb.style.display = 'flex';
  }
  
  /**
   * Limpia todos los filtros en cascada
   */
  limpiarFiltrosJerarquia() {
    document.getElementById('filtro_planta').value = '';
    document.getElementById('filtro_area').value = '';
    document.getElementById('filtro_area').style.display = 'none';
    document.getElementById('filtro_subarea').value = '';
    document.getElementById('filtro_subarea').style.display = 'none';
    document.getElementById('filtro_sistemaEquipo').value = '';
    document.getElementById('filtro_sistemaEquipo').style.display = 'none';
    document.getElementById('filtro_subsistema').value = '';
    document.getElementById('filtro_subsistema').style.display = 'none';
    document.getElementById('filtro_seccion').value = '';
    document.getElementById('filtro_seccion').style.display = 'none';
    document.getElementById('filtro_detalle').value = '';
    document.getElementById('filtro_detalle').style.display = 'none';
    document.getElementById('btnLimpiarFiltros').style.display = 'none';
    
    // Ocultar breadcrumb
    document.getElementById('filtrosBreadcrumb').style.display = 'none';
    
    // Renderizar rbol completo
    this.renderSAPTree();
  }
  
  /**
   * ============================================================
   * GESTIN DE JERARQUA - MODAL Y FUNCIONES CRUD
   * ============================================================
   */

  /**
   * Estructura de datos para niveles jerrquicos
   */
  jerarquiaData = {
    nivel1: [], // Planta
    nivel2: [], // rea General
    nivel3: [], // Sub rea
    nivel4: [], // Sistema/Equipo
    nivel5: [], // Sub Sistema
    nivel6: [], // Seccin
    nivel7: [], // Detalle
    nivel8: []  // Componente
  };

  jerarquiaCurrentLevel = 1;
  jerarquiaEditingId = null;
  jerarquiaSearchTerm = '';
  jerarquiaCollapsedState = {};

  /**
   * Abre el modal de gestin de jerarqua
   */
  openJerarquiaModal() {
    // Cargar datos desde localStorage
    const savedData = localStorage.getItem('jerarquiaLevels');
    if (savedData) {
      try {
        this.jerarquiaData = JSON.parse(savedData);
      } catch (e) {
        console.error('Error al cargar datos de jerarqua:', e);
      }
    }

    // Mostrar modal
    const modal = document.getElementById('modalJerarquia');
    modal.style.display = 'flex';

    this.jerarquiaSearchTerm = '';
    const searchInput = document.getElementById('jerarquiaSearchInput');
    if (searchInput) {
      searchInput.value = '';
    }
    this.updateJerarquiaSearchVisualState();
    const summaryEl = document.getElementById('jerarquiaResultsSummary');
    if (summaryEl) {
      summaryEl.textContent = '';
    }

    // Cargar primer nivel por defecto
    this.switchJerarquiaLevel(1);
  }

  /**
   * Cierra el modal de gestin de jerarqua
   */
  closeJerarquiaModal() {
    const modal = document.getElementById('modalJerarquia');
    modal.style.display = 'none';
    this.jerarquiaEditingId = null;
    this.cancelJerarquiaItem();
  }

  /**
   * Cambia entre niveles jerrquicos
   */
  switchJerarquiaLevel(level) {
    this.jerarquiaCurrentLevel = level;
    this.jerarquiaEditingId = null;

    // Actualizar tabs activos
    const tabs = document.querySelectorAll('.jerarquia-tab');
    tabs.forEach(tab => {
      if (parseInt(tab.getAttribute('data-level')) === level) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });

    // Actualizar título con badges coloreados
    const titles = [
      { text: 'N1 - Empresa', icon: '🏢', color: '#3b82f6' },
      { text: 'N2 - Área', icon: '🏭', color: '#10b981' },
      { text: 'N3 - Sub-área', icon: '📍', color: '#8b5cf6' },
      { text: 'N4 - Sistema', icon: '⚙️', color: '#f59e0b' },
      { text: 'N5 - Sub-sistema', icon: '🔧', color: '#ef4444' },
      { text: 'N6 - Sección', icon: '📦', color: '#ec4899' },
      { text: 'N7 - Sub-sección', icon: '🔩', color: '#6366f1' }
    ];
    const titleInfo = titles[level - 1];
    const titleEl = document.getElementById('jerarquiaLevelTitle');
    if (titleEl && titleInfo) {
      titleEl.innerHTML = `<span style="display: inline-flex; align-items: center; gap: 8px;">
        <span style="font-size: 1.5rem;">${titleInfo.icon}</span>
        <span>${titleInfo.text}</span>
        <span style="display: inline-block; padding: 2px 8px; background: ${titleInfo.color}20; color: ${titleInfo.color}; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">Nivel ${level}</span>
      </span>`;
    }

    // Ocultar formulario
    document.getElementById('jerarquiaForm').style.display = 'none';

    // Renderizar lista de items
    this.renderJerarquiaList();
  }

  /**
   * Renderiza la lista de items del nivel actual
   */
  renderJerarquiaList() {
    const level = this.jerarquiaCurrentLevel;
    const levelKey = `nivel${level}`;
    const items = this.jerarquiaData[levelKey] || [];
    const listContainer = document.getElementById('jerarquiaList');
    if (!listContainer) return;

    const searchTermRaw = (this.jerarquiaSearchTerm || '').trim();
    const searchTerm = searchTermRaw.toLowerCase();

    const escapeRegex = (value) => value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    const highlightMatch = (text = '') => {
      const safeText = this.escapeHtml(text || '');
      if (!searchTermRaw) {
        return safeText;
      }
      try {
        const regex = new RegExp(escapeRegex(searchTermRaw), 'gi');
        return safeText.replace(regex, (match) => `<mark>${match}</mark>`);
      } catch (error) {
        console.warn('Regex highlight fall:', error);
        return safeText;
      }
    };

    const matchesSearch = (item, term) => {
      if (!term) return true;
      const base = `${item.name || ''} ${item.description || ''}`.toLowerCase();
      if (base.includes(term)) {
        return true;
      }
      if (Array.isArray(item.subitems)) {
        return item.subitems.some(sub => matchesSearch(sub, term));
      }
      return false;
    };

    const getVisibleSubitems = (item) => {
      if (!Array.isArray(item.subitems)) {
        return [];
      }
      if (!searchTerm) {
        return item.subitems;
      }
      return item.subitems.filter(sub => matchesSearch(sub, searchTerm));
    };

    const filteredItems = searchTerm
      ? items.filter(item => matchesSearch(item, searchTerm))
      : items;

    this.updateJerarquiaResultsSummary({
      total: items.length,
      filtered: filteredItems.length,
      searchTerm: searchTermRaw,
      level
    });

    if (filteredItems.length === 0) {
      const emptyMessage = searchTerm
        ? `No encontramos resultados para "${this.escapeHtml(this.jerarquiaSearchTerm)}" en este nivel.`
        : 'No hay elementos en este nivel';
      listContainer.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
          <p>${emptyMessage}</p>
          ${searchTerm ? `
            <button class="jerarquia-toolbar-btn" style="margin-top: 12px;" onclick="app.clearJerarquiaSearch()">Limpiar bsqueda</button>
          ` : `
            <p style="font-size: 0.9rem; margin-top: 8px;">Haz clic en " Agregar Nuevo" para crear el primero</p>
          `}
        </div>
      `;
      return;
    }

    const renderItem = (item, isSubitem = false) => {
      const timestamp = new Date(item.timestamp).toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const visibleSubitems = getVisibleSubitems(item);
      const hasSubitems = visibleSubitems.length > 0;
      const itemClass = isSubitem ? 'jerarquia-subitem' : 'jerarquia-item';
      const headerClass = isSubitem ? 'jerarquia-subitem-header' : 'jerarquia-item-header';
      const nameClass = isSubitem ? 'jerarquia-subitem-name' : 'jerarquia-item-name';
      const isCollapsed = searchTerm ? false : this.isJerarquiaItemCollapsed(level, item.id);
      const subitemsExpanded = searchTerm ? true : !isCollapsed;
      const toggleTitle = isCollapsed ? 'Expandir subniveles' : 'Colapsar subniveles';

      let html = `
        <div class="${itemClass}" draggable="true" data-item-id="${item.id}"
             ondragstart="app.onDragStart(event, '${item.id}')"
             ondragover="app.onDragOver(event)"
             ondragleave="app.onDragLeave(event)"
             ondrop="app.onDrop(event, '${item.id}')"
             ondragend="app.onDragEnd(event)">
          <div class="${headerClass}">
            <div class="jerarquia-item-info">
              ${hasSubitems ? `
                <button class="jerarquia-item-toggle ${isCollapsed ? 'collapsed' : ''}" data-toggle-id="${item.id}" onclick="app.toggleSubitems('${item.id}', event)" title="${toggleTitle}" aria-expanded="${subitemsExpanded}">
                  ▼
                </button>
              ` : '<span style="width: 28px;"></span>'}
              <div class="jerarquia-item-content">
                <div class="${nameClass}" onclick="app.toggleSubitems('${item.id}', event)">${highlightMatch(item.name)}</div>
                ${item.description ? `<div class="jerarquia-item-desc">${highlightMatch(item.description)}</div>` : ''}
                ${!isSubitem ? `<div class="jerarquia-item-meta">Creado: ${timestamp}</div>` : ''}
              </div>
            </div>
            <div class="jerarquia-item-actions">
              ${!isSubitem ? `
                <button class="jerarquia-item-btn jerarquia-item-btn-subnivel" onclick="app.addSubnivel('${item.id}')">
                  ➕ Subnivel
                </button>
              ` : ''}
              <button class="jerarquia-item-btn jerarquia-item-btn-edit" onclick="app.editJerarquiaItem('${item.id}', ${isSubitem})">
                ✏️ Editar
              </button>
              <button class="jerarquia-item-btn jerarquia-item-btn-delete" onclick="app.deleteJerarquiaItem('${item.id}', ${isSubitem})">
                🗑️ Eliminar
              </button>
            </div>
          </div>
      `;

      // Renderizar subitems si existen
      if (hasSubitems) {
        html += `<div class="jerarquia-subitems ${subitemsExpanded ? 'expanded' : ''}" id="subitems-${item.id}">`;
        visibleSubitems.forEach(subitem => {
          html += renderItem(subitem, true);
        });
        html += `</div>`;
      }

      html += `</div>`;
      return html;
    };

    listContainer.innerHTML = filteredItems.map(item => renderItem(item, false)).join('');
  }

  updateJerarquiaResultsSummary({ total, filtered, searchTerm, level }) {
    const summary = document.getElementById('jerarquiaResultsSummary');
    const pills = document.getElementById('jerarquiaStatsPills');
    if (!summary) return;

    const levelLabels = [
      'Nivel 1 · Planta',
      'Nivel 2 · rea general',
      'Nivel 3 · Sub rea',
      'Nivel 4 · Sistema/Equipo',
      'Nivel 5 · Sub Sistema',
      'Nivel 6 · Seccin',
      'Nivel 7 · Detalle',
      'Nivel 8 · Componente'
    ];
    const levelLabel = levelLabels[level - 1] || `Nivel ${level}`;

    const matchesText = total === 0
      ? 'Sin registros'
      : filtered === total
        ? `${total} registro${total !== 1 ? 's' : ''}`
        : `${filtered} coincidencia${filtered !== 1 ? 's' : ''} de ${total}`;

    const tag = searchTerm ? 'Bsqueda activa' : 'Explorando';
    const parts = [`<span class="jerarquia-results-tag">${tag} · ${levelLabel}</span>`];

    if (searchTerm) {
      parts.push(`<span class="jerarquia-results-highlight">“${this.escapeHtml(searchTerm)}”</span>`);
    }

    parts.push(`<span>${matchesText}</span>`);
    summary.innerHTML = parts.join('');

    if (!pills) return;

    const levelKey = `nivel${level}`;
    const items = this.jerarquiaData[levelKey] || [];

    const withChildren = items.filter(item => Array.isArray(item.subitems) && item.subitems.length > 0).length;
    const withoutDescription = items.filter(item => !(item.description || '').trim()).length;

    pills.innerHTML = `
      <div class="jerarquia-stat-pill" title="Registros totales en ${levelLabel}">
        <span class="pill-label">Registros</span>
        <strong>${items.length}</strong>
      </div>
      <div class="jerarquia-stat-pill" title="Elementos que ya tienen subniveles">
        <span class="pill-label">Con subniveles</span>
        <strong>${withChildren}</strong>
      </div>
      <div class="jerarquia-stat-pill" title="Elementos sin descripcin">
        <span class="pill-label">Sin descripcin</span>
        <strong>${withoutDescription}</strong>
      </div>
    `;
  }

  /**
   * Muestra el formulario para agregar nuevo item
   */
  addJerarquiaItem() {
    this.jerarquiaEditingId = null;
    const form = document.getElementById('jerarquiaForm');
    form.style.display = 'block';

    // Limpiar campos
    document.getElementById('jerarquiaItemName').value = '';
    document.getElementById('jerarquiaItemDesc').value = '';

    // Scroll al formulario
    form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  /**
   * Guarda un item (nuevo o editado)
   */
  saveJerarquiaItem() {
    const name = document.getElementById('jerarquiaItemName').value.trim();
    const description = document.getElementById('jerarquiaItemDesc').value.trim();

    if (!name) {
      this.mostrarToast(' El nombre es obligatorio', 'warning');
      return;
    }

    const level = this.jerarquiaCurrentLevel;
    const levelKey = `nivel${level}`;

    if (this.jerarquiaEditingId) {
      // Editar existente
      const itemIndex = this.jerarquiaData[levelKey].findIndex(item => item.id === this.jerarquiaEditingId);
      if (itemIndex !== -1) {
        this.jerarquiaData[levelKey][itemIndex].name = name;
        this.jerarquiaData[levelKey][itemIndex].description = description;
        this.mostrarToast(' Item actualizado exitosamente', 'success');
      }
    } else {
      // Crear nuevo
      const newItem = {
        id: Date.now().toString(),
        name: name,
        description: description,
        timestamp: Date.now()
      };
      this.jerarquiaData[levelKey].push(newItem);
      this.mostrarToast(' Item creado exitosamente', 'success');
    }

    // Guardar en localStorage
    localStorage.setItem('jerarquiaLevels', JSON.stringify(this.jerarquiaData));

    //  SINCRONIZAR: Actualizar listas de autocompletado
    this.sincronizarJerarquiaConAutocompletado();

    // Actualizar vista
    this.cancelJerarquiaItem();
    this.renderJerarquiaList();

    // Actualizar rbol SAP si est visible
    if (document.getElementById('jerarquia').style.display !== 'none') {
      this.renderSAPTree();
    }

    // Actualizar rbol en Configuracin si est visible
    const configTree = document.getElementById('jerarquiaTreeContainer');
    if (configTree && configTree.offsetParent !== null) {
      this.renderJerarquiaTree();
    }
  }

  /**
   * Cancela la edicin/creacin de item
   */
  cancelJerarquiaItem() {
    this.jerarquiaEditingId = null;
    const form = document.getElementById('jerarquiaForm');
    form.style.display = 'none';
    document.getElementById('jerarquiaItemName').value = '';
    document.getElementById('jerarquiaItemDesc').value = '';
  }

  /**
   * Toggle para mostrar/ocultar subitems
   */
  toggleSubitems(itemId) {
    const subitemsContainer = document.getElementById(`subitems-${itemId}`);
    const toggleButton = event.target;
    
    if (subitemsContainer) {
      subitemsContainer.classList.toggle('expanded');
      if (toggleButton && toggleButton.classList.contains('jerarquia-item-toggle')) {
        toggleButton.classList.toggle('collapsed');
      }
    }
  }

  /**
   * Agrega un subnivel a un item existente
   */
  addSubnivel(parentId) {
    const level = this.jerarquiaCurrentLevel;
    const levelKey = `nivel${level}`;
    const parentItem = this.jerarquiaData[levelKey].find(i => i.id === parentId);

    if (!parentItem) {
      this.mostrarToast('⚠️ Item padre no encontrado', 'error');
      return;
    }

    // Pedir nombre del subnivel
    const name = prompt('Nombre del subnivel:');
    if (!name || !name.trim()) {
      return;
    }

    const description = prompt('Descripción (opcional):') || '';

    // Inicializar array de subitems si no existe
    if (!parentItem.subitems) {
      parentItem.subitems = [];
    }

    // Crear subnivel
    const newSubitem = {
      id: `${parentId}-${Date.now()}`,
      name: name.trim(),
      description: description.trim(),
      timestamp: Date.now()
    };

    parentItem.subitems.push(newSubitem);

    // Guardar en localStorage
    localStorage.setItem('jerarquiaLevels', JSON.stringify(this.jerarquiaData));

    this.mostrarToast('✅ Subnivel creado exitosamente', 'success');

    // Actualizar vista
    this.renderJerarquiaList();
  }

  /**
   * Edita un item o subitem existente
   */
  editJerarquiaItem(itemId, isSubitem = false) {
    const level = this.jerarquiaCurrentLevel;
    const levelKey = `nivel${level}`;
    
    let item = null;
    
    if (isSubitem) {
      // Buscar en subitems
      for (const parentItem of this.jerarquiaData[levelKey]) {
        if (parentItem.subitems) {
          item = parentItem.subitems.find(s => s.id === itemId);
          if (item) break;
        }
      }
    } else {
      // Buscar en items principales
      item = this.jerarquiaData[levelKey].find(i => i.id === itemId);
    }

    if (!item) {
      this.mostrarToast('⚠️ Item no encontrado', 'error');
      return;
    }

    // Pedir nuevo nombre
    const newName = prompt('Editar nombre:', item.name);
    if (newName === null) return; // Usuario canceló
    
    if (!newName.trim()) {
      this.mostrarToast('⚠️ El nombre no puede estar vacío', 'warning');
      return;
    }

    const newDesc = prompt('Editar descripción:', item.description || '');
    if (newDesc === null) return; // Usuario canceló

    // Actualizar item
    item.name = newName.trim();
    item.description = newDesc.trim();

    // Guardar en localStorage
    localStorage.setItem('jerarquiaLevels', JSON.stringify(this.jerarquiaData));

    //  SINCRONIZAR: Actualizar listas de autocompletado
    this.sincronizarJerarquiaConAutocompletado();

    this.mostrarToast('✅ Item actualizado exitosamente', 'success');

    // Actualizar vista
    this.renderJerarquiaList();
  }

  /**
   * Elimina un item o subitem con confirmación
   */
  deleteJerarquiaItem(itemId, isSubitem = false) {
    const level = this.jerarquiaCurrentLevel;
    const levelKey = `nivel${level}`;
    
    let item = null;
    let parentItem = null;
    
    if (isSubitem) {
      // Buscar en subitems
      for (const parent of this.jerarquiaData[levelKey]) {
        if (parent.subitems) {
          item = parent.subitems.find(s => s.id === itemId);
          if (item) {
            parentItem = parent;
            break;
          }
        }
      }
    } else {
      // Buscar en items principales
      item = this.jerarquiaData[levelKey].find(i => i.id === itemId);
    }

    if (!item) {
      this.mostrarToast('⚠️ Item no encontrado', 'error');
      return;
    }

    if (!confirm(`¿Eliminar "${item.name}"?\n\nEsta acción no se puede deshacer.`)) {
      return;
    }

    // Eliminar item
    if (isSubitem && parentItem) {
      parentItem.subitems = parentItem.subitems.filter(s => s.id !== itemId);
    } else {
      this.jerarquiaData[levelKey] = this.jerarquiaData[levelKey].filter(i => i.id !== itemId);
    }

    // Guardar en localStorage
    localStorage.setItem('jerarquiaLevels', JSON.stringify(this.jerarquiaData));

    //  SINCRONIZAR: Actualizar listas de autocompletado
    this.sincronizarJerarquiaConAutocompletado();

    this.mostrarToast('✅ Item eliminado exitosamente', 'success');

    // Actualizar vista
    this.renderJerarquiaList();

    // Actualizar árbol SAP si está visible
    if (document.getElementById('jerarquia').style.display !== 'none') {
      this.renderSAPTree();
    }

    // Actualizar árbol en Configuración si está visible
    const configTree = document.getElementById('jerarquiaTreeContainer');
    if (configTree && configTree.offsetParent !== null) {
      this.renderJerarquiaTree();
    }
  }

  // ===== DRAG & DROP FUNCTIONS =====
  
  draggedItemId = null;

  onDragStart(event, itemId) {
    this.draggedItemId = itemId;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/html', event.target.innerHTML);
  }

  onDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    
    const target = event.target.closest('.jerarquia-item, .jerarquia-subitem');
    if (target && !target.classList.contains('dragging')) {
      target.classList.add('drag-over');
    }
  }

  onDragLeave(event) {
    const target = event.target.closest('.jerarquia-item, .jerarquia-subitem');
    if (target) {
      target.classList.remove('drag-over');
    }
  }

  onDrop(event, targetItemId) {
    event.preventDefault();
    event.stopPropagation();
    
    const target = event.target.closest('.jerarquia-item, .jerarquia-subitem');
    if (target) {
      target.classList.remove('drag-over');
    }

    if (this.draggedItemId === targetItemId) {
      return; // No hacer nada si se suelta sobre sí mismo
    }

    const level = this.jerarquiaCurrentLevel;
    const levelKey = `nivel${level}`;
    const items = this.jerarquiaData[levelKey];

    // Encontrar índices
    const draggedIndex = items.findIndex(i => i.id === this.draggedItemId);
    const targetIndex = items.findIndex(i => i.id === targetItemId);

    if (draggedIndex !== -1 && targetIndex !== -1) {
      // Reordenar array
      const draggedItem = items[draggedIndex];
      items.splice(draggedIndex, 1);
      items.splice(targetIndex, 0, draggedItem);

      // Guardar en localStorage
      localStorage.setItem('jerarquiaLevels', JSON.stringify(this.jerarquiaData));

      this.mostrarToast('✅ Orden actualizado', 'success');

      // Actualizar vista
      this.renderJerarquiaList();
    }
  }

  onDragEnd(event) {
    event.target.classList.remove('dragging');
    this.draggedItemId = null;
    
    // Limpiar todas las clases drag-over
    document.querySelectorAll('.drag-over').forEach(el => {
      el.classList.remove('drag-over');
    });
  }

  /**
   *  Sincroniza la estructura jerrquica con las listas de autocompletado
   */
  sincronizarJerarquiaConAutocompletado() {
    // Mapeo de niveles a campos de autocompletado
    const levelMapping = {
      nivel1: 'planta',
      nivel2: 'area',
      nivel3: 'subarea',
      nivel4: 'sistema',
      nivel5: 'subsistema',
      nivel6: 'seccion',
      nivel7: 'detalle',
      nivel8: 'ubicacion'
    };

    // Actualizar cada lista
    Object.keys(levelMapping).forEach(levelKey => {
      const fieldKey = levelMapping[levelKey];
      const items = this.jerarquiaData[levelKey] || [];
      
      // Extraer solo los nombres
      this.autocompleteData[fieldKey] = items.map(item => item.name);
    });

    // Guardar en localStorage
    localStorage.setItem('autocompleteData', JSON.stringify(this.autocompleteData));
    
    console.log(' Jerarqua sincronizada con autocompletado:', this.autocompleteData);
  }

  /**
   * Escapa caracteres HTML para prevenir XSS
   */
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  /**
   * Inicializa las opciones de los filtros en cascada (solo plantas al inicio)
   */
  inicializarFiltrosJerarquia() {
    // Cargar plantas disponibles
    const plantas = [...new Set(this.repuestos.map(r => r.planta).filter(Boolean))].sort();
    const selectPlanta = document.getElementById('filtro_planta');
    if (selectPlanta) {
      selectPlanta.innerHTML = '<option value=""> Todas las plantas</option>';
      plantas.forEach(p => {
        selectPlanta.innerHTML += `<option value="${p}">${p}</option>`;
      });
    }
  }
  
  // ========================================
  //  HELPERS Y UTILIDADES
  // ========================================
  
  formatNumber(value, options = {}) {
    const number = Number(value);
    if (!Number.isFinite(number)) return '0';
    return number.toLocaleString('es-ES', options);
  }
  formatDecimal(value, digits = 0) {
    const number = Number(value);
    if (!Number.isFinite(number)) return (digits === 0 ? '0' : Number(0).toFixed(digits));
    return number.toLocaleString('es-ES', { minimumFractionDigits: digits, maximumFractionDigits: digits });
  }
  escapeHtml(value) {
    if (value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
  
  // ========================================
  //  RBOL JERRQUICO ESTILO SAP PM
  // ========================================
  
  /**
   * Renderiza el rbol jerrquico estilo SAP PM
   *  SINCRONIZADO: Usa jerarquiaData del modal de gestin
   */
  renderSAPTree() {
    console.log(' renderSAPTree() llamado');
    console.log('  jerarquiaData:', this.jerarquiaData);
    
    const container = document.getElementById('sapTreeContainer');
    if (!container) {
      console.warn(' No se encontr el contenedor del rbol SAP');
      return;
    }
    
    //  USAR ESTRUCTURA JERRQUICA DEL MODAL
    if (!this.jerarquiaData) {
      console.warn(' jerarquiaData no definido, mostrando mensaje');
      container.innerHTML = '<div class="sap-tree-empty">No hay estructura jerrquica configurada. <br>Usa el botn " Gestionar Niveles" para crear la jerarqua.</div>';
      this.updateSAPTreeCount(0);
      return;
    }

    console.log(' Construyendo rbol...');
    // Construir rbol desde jerarquiaData
    const treeHTML = this.buildJerarquiaTreeHTML();
    container.innerHTML = treeHTML;

    // Contar elementos totales
    let totalItems = 0;
    Object.keys(this.jerarquiaData).forEach(level => {
      totalItems += (this.jerarquiaData[level] || []).length;
    });
    
    this.updateSAPTreeCount(totalItems);
    console.log(' rbol SAP renderizado desde jerarquiaData:', totalItems, 'elementos');
  }

  /**
   * Construye el HTML del rbol jerrquico desde jerarquiaData
   */
  buildJerarquiaTreeHTML() {
    const plantas = this.jerarquiaData.nivel1 || [];
    
    if (plantas.length === 0) {
      return '<div class="sap-tree-empty">No hay plantas configuradas. <br>Usa " Gestionar Niveles" para agregar elementos.</div>';
    }

    let html = '<div class="sap-tree">';
    
    plantas.forEach((planta, pIndex) => {
      html += `
        <div class="sap-node sap-node-level-1" data-id="${planta.id}">
          <div class="sap-node-header" onclick="app.sapTreeToggleNode('planta_${pIndex}')">
            <span class="sap-node-icon"></span>
            <span class="sap-node-label">${this.escapeHtml(planta.name)}</span>
            ${planta.description ? `<span class="sap-node-desc">(${this.escapeHtml(planta.description)})</span>` : ''}
            <span class="sap-node-toggle"></span>
          </div>
          <div class="sap-node-children" id="planta_${pIndex}">
            ${this.buildNivel2HTML(pIndex)}
          </div>
        </div>
      `;
    });

    html += '</div>';
    return html;
  }

  buildNivel2HTML(pIndex) {
    const areas = this.jerarquiaData.nivel2 || [];
    if (areas.length === 0) {
      return '<div class="sap-tree-empty-child">Sin reas generales</div>';
    }

    let html = '';
    areas.forEach((area, aIndex) => {
      html += `
        <div class="sap-node sap-node-level-2" data-id="${area.id}">
          <div class="sap-node-header" onclick="app.sapTreeToggleNode('area_${pIndex}_${aIndex}')">
            <span class="sap-node-icon"></span>
            <span class="sap-node-label">${this.escapeHtml(area.name)}</span>
            <span class="sap-node-toggle"></span>
          </div>
          <div class="sap-node-children" id="area_${pIndex}_${aIndex}">
            ${this.buildNivel3HTML(pIndex, aIndex)}
          </div>
        </div>
      `;
    });
    return html;
  }

  buildNivel3HTML(pIndex, aIndex) {
    const subareas = this.jerarquiaData.nivel3 || [];
    if (subareas.length === 0) {
      return '<div class="sap-tree-empty-child">Sin sub-reas</div>';
    }

    let html = '';
    subareas.forEach((subarea, sIndex) => {
      html += `
        <div class="sap-node sap-node-level-3" data-id="${subarea.id}">
          <div class="sap-node-header" onclick="app.sapTreeToggleNode('subarea_${pIndex}_${aIndex}_${sIndex}')">
            <span class="sap-node-icon"></span>
            <span class="sap-node-label">${this.escapeHtml(subarea.name)}</span>
            <span class="sap-node-toggle"></span>
          </div>
          <div class="sap-node-children" id="subarea_${pIndex}_${aIndex}_${sIndex}">
            ${this.buildNivel4HTML(pIndex, aIndex, sIndex)}
          </div>
        </div>
      `;
    });
    return html;
  }

  buildNivel4HTML(pIndex, aIndex, sIndex) {
    const sistemas = this.jerarquiaData.nivel4 || [];
    if (sistemas.length === 0) {
      return '<div class="sap-tree-empty-child">Sin sistemas/equipos</div>';
    }

    let html = '';
    sistemas.forEach((sistema, siIndex) => {
      html += `
        <div class="sap-node sap-node-level-4" data-id="${sistema.id}">
          <div class="sap-node-header" onclick="app.sapTreeToggleNode('sistema_${pIndex}_${aIndex}_${sIndex}_${siIndex}')">
            <span class="sap-node-icon"></span>
            <span class="sap-node-label">${this.escapeHtml(sistema.name)}</span>
            <span class="sap-node-toggle"></span>
          </div>
          <div class="sap-node-children" id="sistema_${pIndex}_${aIndex}_${sIndex}_${siIndex}">
            <div class="sap-tree-empty-child"> Sub-sistemas,  Secciones y  Detalles disponibles...</div>
          </div>
        </div>
      `;
    });
    return html;
  }

  /**
   * Toggle de nodos del rbol
   */
  sapTreeToggleNode(nodeId) {
    const node = document.getElementById(nodeId);
    if (!node) return;

    const isVisible = node.style.display !== 'none';
    node.style.display = isVisible ? 'none' : 'block';

    // Cambiar icono del toggle
    const header = node.previousElementSibling;
    if (header) {
      const toggle = header.querySelector('.sap-node-toggle');
      if (toggle) {
        toggle.textContent = isVisible ? '' : '';
      }
    }
  }

  /**
   * BACKUP: Funcin original (ahora deprecated)
   */
  renderSAPTree_OLD() {
    const container = document.getElementById('sapTreeContainer');
    if (!container) {
      console.warn(' No se encontr el contenedor del rbol SAP');
      return;
    }
    
    // Obtener datos filtrados
    const data = this.getFilteredJerarquiaData();
    if (!data || data.length === 0) {
      container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No hay datos para mostrar</div>';
      this.updateSAPTreeCount(0);
      return;
    }
    
    // Construir rbol jerrquico
    const tree = this.buildTreeStructure(data);
    
    // Renderizar HTML
    container.innerHTML = this.renderTreeNodes(tree, 0);
    
    // Actualizar contador
    this.updateSAPTreeCount(data.length);
    
    console.log(' rbol SAP renderizado:', data.length, 'elementos');
  }
  
  /**
   * Obtiene datos filtrados segn los filtros activos en cascada
   */
  getFilteredJerarquiaData() {
    //  USAR DATOS REALES DE REPUESTOS
    const filtroPlanta = document.getElementById('filtro_planta')?.value || '';
    const filtroArea = document.getElementById('filtro_area')?.value || '';
    const filtroSubArea = document.getElementById('filtro_subarea')?.value || '';
    const filtroSistema = document.getElementById('filtro_sistemaEquipo')?.value || '';
    const filtroSubSistema = document.getElementById('filtro_subsistema')?.value || '';
    const filtroSeccion = document.getElementById('filtro_seccion')?.value || '';
    const filtroDetalle = document.getElementById('filtro_detalle')?.value || '';
    
    // Filtrar repuestos segn criterios activos
    let repuestosFiltrados = this.repuestos.filter(r => {
      if (filtroPlanta && r.planta !== filtroPlanta) return false;
      if (filtroArea && r.areaGeneral !== filtroArea) return false;
      if (filtroSubArea && r.subArea !== filtroSubArea) return false;
      if (filtroSistema && r.sistemaEquipo !== filtroSistema) return false;
      if (filtroSubSistema && r.subSistema !== filtroSubSistema) return false;
      if (filtroSeccion && r.seccion !== filtroSeccion) return false;
      if (filtroDetalle && r.detalle !== filtroDetalle) return false;
      return true;
    });
    
    return repuestosFiltrados;
  }
  
  /**
   * Construye la estructura jerrquica en forma de rbol desde los datos planos
   * @param {Array} data - Array de repuestos filtrados
   * @returns {Object} - Objeto jerrquico anidado
   */
  buildTreeStructure(data) {
    const tree = {};
    
    data.forEach(r => {
      // Nivel 1: Planta
      const planta = r.planta || 'Sin Planta';
      if (!tree[planta]) tree[planta] = { _count: 0, _children: {} };
      tree[planta]._count++;
      
      // Nivel 2: rea General
      const area = r.areaGeneral || 'Sin rea';
      if (!tree[planta]._children[area]) tree[planta]._children[area] = { _count: 0, _children: {} };
      tree[planta]._children[area]._count++;
      
      // Nivel 3: Sub-rea
      const subarea = r.subArea || 'Sin Sub-rea';
      if (!tree[planta]._children[area]._children[subarea]) tree[planta]._children[area]._children[subarea] = { _count: 0, _children: {} };
      tree[planta]._children[area]._children[subarea]._count++;
      
      // Nivel 4: Sistema
      const sistema = r.sistemaEquipo || 'Sin Sistema';
      if (!tree[planta]._children[area]._children[subarea]._children[sistema]) {
        tree[planta]._children[area]._children[subarea]._children[sistema] = { _count: 0, _children: {} };
      }
      tree[planta]._children[area]._children[subarea]._children[sistema]._count++;
      
      // Nivel 5: Sub-Sistema
      const subsistema = r.subSistema || 'Sin Sub-Sistema';
      if (!tree[planta]._children[area]._children[subarea]._children[sistema]._children[subsistema]) {
        tree[planta]._children[area]._children[subarea]._children[sistema]._children[subsistema] = { _count: 0, _children: {} };
      }
      tree[planta]._children[area]._children[subarea]._children[sistema]._children[subsistema]._count++;
      
      // Nivel 6: Seccin
      const seccion = r.seccion || 'Sin Seccin';
      if (!tree[planta]._children[area]._children[subarea]._children[sistema]._children[subsistema]._children[seccion]) {
        tree[planta]._children[area]._children[subarea]._children[sistema]._children[subsistema]._children[seccion] = { _count: 0, _children: {} };
      }
      tree[planta]._children[area]._children[subarea]._children[sistema]._children[subsistema]._children[seccion]._count++;
      
      // Nivel 7: Detalle
      const detalle = r.detalle || 'Sin Detalle';
      if (!tree[planta]._children[area]._children[subarea]._children[sistema]._children[subsistema]._children[seccion]._children[detalle]) {
        tree[planta]._children[area]._children[subarea]._children[sistema]._children[subsistema]._children[seccion]._children[detalle] = { _count: 0, _items: [] };
      }
      tree[planta]._children[area]._children[subarea]._children[sistema]._children[subsistema]._children[seccion]._children[detalle]._count++;
      tree[planta]._children[area]._children[subarea]._children[sistema]._children[subsistema]._children[seccion]._children[detalle]._items.push(r);
    });
    
    return tree;
  }
  
  /**
   * Renderiza recursivamente los nodos del rbol
   * @param {Object} nodes - Nodos del nivel actual
   * @param {Number} level - Nivel actual (0-6)
   * @param {Object} parentPath - Ruta jerrquica del padre
   * @returns {String} - HTML del rbol
   */
  renderTreeNodes(nodes, level, parentPath = {}) {
    const icons = ['', '', '', '', '', '', ''];
    const icon = icons[level] || '';
    const levelNames = ['planta', 'areaGeneral', 'subArea', 'sistemaEquipo', 'subSistema', 'seccion', 'detalle'];
    const levelName = levelNames[level];
    
    let html = '';
    let nodeId = 0;
    
    Object.keys(nodes).sort().forEach(key => {
      const node = nodes[key];
      const currentId = `node-${level}-${nodeId++}`;
      const hasChildren = node._children && Object.keys(node._children).length > 0;
      const hasItems = node._items && node._items.length > 0;
      
      // Construir ruta actual
      const currentPath = { ...parentPath, [levelName]: key };
      const pathStr = JSON.stringify(currentPath).replace(/"/g, '&quot;');
      
      html += `
        <div class="sap-tree-item" data-level="${level}">
          <div class="sap-tree-item-content">
            ${hasChildren || hasItems ? `<span class="sap-tree-toggle" onclick="app.sapTreeToggleNode('${currentId}')"></span>` : '<span style="width:16px;display:inline-block;"></span>'}
            <span class="sap-tree-icon">${icon}</span>
            <span class="sap-tree-label" onclick='app.sapTreeSelectNode("${currentId}", "${key}", "node", ${level}, ${pathStr})'>${key}</span>
            <span class="sap-tree-badge">${node._count || 0}</span>
          </div>
          <div class="sap-tree-children" id="${currentId}" style="display:none;">
      `;
      
      if (hasChildren) {
        html += this.renderTreeNodes(node._children, level + 1, currentPath);
      }
      
      if (hasItems) {
        node._items.forEach(item => {
          const itemName = (item.nombre || 'Sin nombre').replace(/"/g, '&quot;');
          html += `
            <div class="sap-tree-item sap-tree-leaf" data-level="${level + 1}">
              <div class="sap-tree-item-content">
                <span style="width:16px;display:inline-block;"></span>
                <span class="sap-tree-icon"></span>
                <span class="sap-tree-label" onclick="app.sapTreeSelectNode('item-${item.id}', '${item.codSAP || 'N/A'} - ${itemName}', 'item')">${item.codSAP || 'N/A'} - ${item.nombre}</span>
                <span class="sap-tree-badge">${item.cantidad || 0}</span>
              </div>
            </div>
          `;
        });
      }
      
      html += `
          </div>
        </div>
      `;
    });
    
    return html;
  }
  
  /**
   * Toggle (expandir/contraer) un nodo del rbol
   */
  sapTreeToggleNode(nodeId) {
    const node = document.getElementById(nodeId);
    const toggle = node?.previousElementSibling?.querySelector('.sap-tree-toggle');
    
    if (node && toggle) {
      if (node.style.display === 'none') {
        node.style.display = 'block';
        toggle.textContent = '';
      } else {
        node.style.display = 'none';
        toggle.textContent = '';
      }
    }
  }
  
  /**
   * Selecciona un nodo del rbol y filtra el inventario
   */
  sapTreeSelectNode(nodeId, label, type, level, path) {
    // Quitar seleccin previa
    document.querySelectorAll('.sap-tree-item.selected').forEach(el => el.classList.remove('selected'));
    
    // Agregar seleccin al nodo clickeado
    const targetNode = document.querySelector(`[onclick*="${nodeId}"]`)?.closest('.sap-tree-item');
    if (targetNode) {
      targetNode.classList.add('selected');
    }
    
    // Si es un item (repuesto), abrir el modal de edicin
    if (type === 'item') {
      const itemId = nodeId.replace('item-', '');
      this.openModal('edit', itemId);
      return;
    }
    
    // Si es un nodo, filtrar inventario y cambiar a la pestaa de inventario
    if (type === 'node' && path) {
      this.aplicarFiltroJerarquico(path);
      this.showToast(` Filtrando por: ${label}`, 'info', 2000);
      
      // Cambiar a pestaa inventario para ver resultados
      setTimeout(() => {
        document.querySelector('[data-tab="inventario"]')?.click();
      }, 500);
    }
  }
  
  /**
   * Aplica filtro jerrquico al inventario desde el rbol SAP
   */
  aplicarFiltroJerarquico(path) {
    // path es un objeto con la ruta jerrquica: { planta, areaGeneral, subArea, etc. }
    this.filtrosJerarquicosActivos = path;
    
    // 🔄 SINCRONIZACIÓN: Emitir evento cuando se selecciona nodo en jerarquía
    const nodeName = this.getLastNonEmptyLevel(path);
    if (window.appEvents && nodeName) {
      window.appEvents.dispatchEvent(new CustomEvent('jerarquia-node-clicked', {
        detail: { 
          nodeName: nodeName,
          path: path
        }
      }));
      console.log(`📤 Evento emitido: jerarquia-node-clicked (${nodeName})`);
    }
    
    // Cambiar a pestaa inventario
    this.switchTab('inventario');
    
    // Renderizar inventario filtrado
    this.applyFilters();
  }
  
  /**
   * Obtiene el último nivel no vacío del path jerárquico
   */
  getLastNonEmptyLevel(path) {
    const niveles = ['nivel5', 'nivel4', 'nivel3', 'nivel2', 'nivel1'];
    for (const nivel of niveles) {
      if (path[nivel] && path[nivel].trim() !== '') {
        return path[nivel].trim();
      }
    }
    return null;
  }
  
  /**
   * Expandir todos los nodos del rbol
   */
  sapTreeExpandAll() {
    document.querySelectorAll('.sap-tree-children').forEach(el => el.style.display = 'block');
    document.querySelectorAll('.sap-tree-toggle').forEach(el => el.textContent = '');
  }
  
  /**
   * Contraer todos los nodos del rbol
   */
  sapTreeCollapseAll() {
    document.querySelectorAll('.sap-tree-children').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.sap-tree-toggle').forEach(el => el.textContent = '');
  }
  
  /**
   * Refrescar el rbol (re-renderizar)
   */
  sapTreeRefresh() {
    this.renderSAPTree();
    this.showToast(' rbol actualizado', 'success', 1500);
  }
  
  /**
   * Buscar en el rbol SAP
   */
  sapTreeSearch(query) {
    const tree = document.getElementById('sapTreeContainer');
    if (!tree) return;
    
    query = query.toLowerCase().trim();
    
    // Si no hay bsqueda, mostrar todo
    if (!query) {
      document.querySelectorAll('.sap-tree-item').forEach(item => {
        item.style.display = '';
        item.classList.remove('search-highlight');
      });
      return;
    }
    
    // Buscar y resaltar coincidencias
    let foundCount = 0;
    document.querySelectorAll('.sap-tree-item').forEach(item => {
      const label = item.querySelector('.sap-tree-label');
      if (label) {
        const text = label.textContent.toLowerCase();
        if (text.includes(query)) {
          item.style.display = '';
          item.classList.add('search-highlight');
          foundCount++;
          
          // Expandir padres
          let parent = item.parentElement;
          while (parent) {
            if (parent.classList && parent.classList.contains('sap-tree-children')) {
              parent.style.display = 'block';
              const toggle = parent.previousElementSibling?.querySelector('.sap-tree-toggle');
              if (toggle) toggle.textContent = '';
            }
            parent = parent.parentElement;
          }
        } else {
          item.style.display = 'none';
          item.classList.remove('search-highlight');
        }
      }
    });
    
    if (foundCount === 0) {
      this.showToast(' No se encontraron resultados', 'warning', 2000);
    } else {
      this.showToast(` ${foundCount} resultado(s) encontrado(s)`, 'success', 1500);
    }
  }
  
  /**
   * Limpiar bsqueda del rbol
   */
  sapTreeClearSearch() {
    const input = document.getElementById('sapTreeSearch');
    if (input) {
      input.value = '';
      this.sapTreeSearch('');
    }
  }
  
  /**
   * Actualizar el contador de elementos en el header
   */
  updateSAPTreeCount(count) {
    const counter = document.getElementById('sapTreeCount');
    if (counter) {
      counter.textContent = count;
    }
  }
  
  // ========================================
  //  HELPERS Y UTILIDADES
  // ========================================

  renderJerarquia() {
    // Reutiliza el render filtrado para mantener compatibilidad con la vista antigua
    this.renderJerarquiaFiltrada(this.repuestos);
    this.actualizarContadorJerarquia();
  }

  toggleTree(id) {
    const element = document.getElementById(id);
    const toggle = document.getElementById(`${id}-toggle`);

    if (!element || !toggle) {
      return;
    }

    const isExpanded = element.classList.toggle('expanded');
    if (isExpanded) {
      toggle.classList.add('expanded');
      toggle.textContent = '';
    } else {
      toggle.classList.remove('expanded');
      toggle.textContent = '';
    }
  }

  toggleAllTree() {
    const nodes = document.querySelectorAll('.tree-children');
    const toggles = document.querySelectorAll('.tree-toggle');
    const icon = document.getElementById('toggleAllIcon');
    const text = document.getElementById('toggleAllText');

    if (!nodes.length) {
      return;
    }

    const anyExpanded = Array.from(nodes).some(node => node.classList.contains('expanded'));

    if (anyExpanded) {
      nodes.forEach(node => node.classList.remove('expanded'));
      toggles.forEach(toggle => {
        toggle.classList.remove('expanded');
        toggle.textContent = '';
      });
      if (icon) icon.textContent = '';
      if (text) text.textContent = 'Expandir Todo';
    } else {
      nodes.forEach(node => node.classList.add('expanded'));
      toggles.forEach(toggle => {
        toggle.classList.add('expanded');
        toggle.textContent = '';
      });
      if (icon) icon.textContent = '';
      if (text) text.textContent = 'Contraer Todo';
    }
  }

  // Inicializar opciones de filtros escalonados
  inicializarFiltrosJerarquia() {
    // Cargar opciones de plantas
    const plantas = [...new Set(this.repuestos.map(r => r.planta).filter(Boolean))].sort();
    const selectPlanta = document.getElementById('filtro_planta');
    selectPlanta.innerHTML = '<option value=""> Todas las plantas</option>';
    plantas.forEach(p => {
      selectPlanta.innerHTML += `<option value="${p}">${p}</option>`;
    });
  }

  // Filtrado escalonado por jerarqua
  filtrarEscalonado(nivel, valor) {
    const filtroPlanta = document.getElementById('filtro_planta');
    const filtroArea = document.getElementById('filtro_area');
    const filtroSubArea = document.getElementById('filtro_subarea');
    const filtroSistema = document.getElementById('filtro_sistema');
    const filtroSubSistema = document.getElementById('filtro_subsistema');
    const filtroSeccion = document.getElementById('filtro_seccion');
    const filtroDetalle = document.getElementById('filtro_detalle');
    const btnLimpiar = document.getElementById('btnLimpiarFiltros');
    
    // Construir filtros actuales
    const filtros = {
      planta: filtroPlanta.value,
      area: filtroArea.value,
      subarea: filtroSubArea.value,
      sistema: filtroSistema.value,
      subsistema: filtroSubSistema.value,
      seccion: filtroSeccion.value,
      detalle: filtroDetalle.value
    };
    
    // Si se selecciona un nivel, actualizar los siguientes
    if (nivel === 1 && valor) {
      // Planta seleccionada  mostrar reas
      filtroArea.style.display = 'block';
      btnLimpiar.style.display = 'block';
      
      // Cargar opciones de reas para esta planta
      const areas = [...new Set(
        this.repuestos
          .filter(r => r.planta === valor && r.areaGeneral)
          .map(r => r.areaGeneral)
      )].sort();
      
      filtroArea.innerHTML = '<option value=""> Todas las reas</option>';
      areas.forEach(a => {
        filtroArea.innerHTML += `<option value="${a}">${a}</option>`;
      });
      
      // Ocultar niveles siguientes
      filtroSubArea.style.display = 'none';
      filtroSubArea.value = '';
      filtroSistema.style.display = 'none';
      filtroSistema.value = '';
      filtroSubSistema.style.display = 'none';
      filtroSubSistema.value = '';
      filtroSeccion.style.display = 'none';
      filtroSeccion.value = '';
      filtroDetalle.style.display = 'none';
      filtroDetalle.value = '';
      
    } else if (nivel === 2 && valor) {
      // rea seleccionada  mostrar sub-reas
      filtroSubArea.style.display = 'block';
      
      const subareas = [...new Set(
        this.repuestos
          .filter(r => r.planta === filtros.planta && r.areaGeneral === valor && r.subArea)
          .map(r => r.subArea)
      )].sort();
      
      filtroSubArea.innerHTML = '<option value=""> Todas las sub-reas</option>';
      subareas.forEach(s => {
        filtroSubArea.innerHTML += `<option value="${s}">${s}</option>`;
      });
      
      // Ocultar niveles siguientes
      filtroSistema.style.display = 'none';
      filtroSistema.value = '';
      filtroSubSistema.style.display = 'none';
      filtroSubSistema.value = '';
      filtroSeccion.style.display = 'none';
      filtroSeccion.value = '';
      filtroDetalle.style.display = 'none';
      filtroDetalle.value = '';
      
    } else if (nivel === 3 && valor) {
      // Sub-rea seleccionada  mostrar sistemas
      filtroSistema.style.display = 'block';
      
      const sistemas = [...new Set(
        this.repuestos
          .filter(r => 
            r.planta === filtros.planta && 
            r.areaGeneral === filtros.area && 
            r.subArea === valor && 
            r.sistemaEquipo
          )
          .map(r => r.sistemaEquipo)
      )].sort();
      
      filtroSistema.innerHTML = '<option value=""> Todos los sistemas</option>';
      sistemas.forEach(s => {
        filtroSistema.innerHTML += `<option value="${s}">${s}</option>`;
      });
      
      // Ocultar niveles siguientes
      filtroSubSistema.style.display = 'none';
      filtroSubSistema.value = '';
      filtroSeccion.style.display = 'none';
      filtroSeccion.value = '';
      filtroDetalle.style.display = 'none';
      filtroDetalle.value = '';
      
    } else if (nivel === 4 && valor) {
      // Sistema seleccionado  mostrar sub-sistemas
      filtroSubSistema.style.display = 'block';
      
      const subsistemas = [...new Set(
        this.repuestos
          .filter(r => 
            r.planta === filtroPlanta.value && 
            r.areaGeneral === filtroArea.value && 
            r.subArea === filtroSubArea.value && 
            r.sistemaEquipo === valor && 
            r.subSistema
          )
          .map(r => r.subSistema)
      )].sort();
      
      filtroSubSistema.innerHTML = '<option value=""> Todos los sub-sistemas</option>';
      subsistemas.forEach(s => {
        filtroSubSistema.innerHTML += `<option value="${s}">${s}</option>`;
      });
      
      // Ocultar niveles siguientes
      filtroSeccion.style.display = 'none';
      filtroSeccion.value = '';
      filtroDetalle.style.display = 'none';
      filtroDetalle.value = '';
      
    } else if (nivel === 5 && valor) {
      // Sub-sistema seleccionado  mostrar secciones
      filtroSeccion.style.display = 'block';
      
      const secciones = [...new Set(
        this.repuestos
          .filter(r => 
            r.planta === filtroPlanta.value && 
            r.areaGeneral === filtroArea.value && 
            r.subArea === filtroSubArea.value && 
            r.sistemaEquipo === filtroSistema.value && 
            r.subSistema === valor && 
            r.seccion
          )
          .map(r => r.seccion)
      )].sort();
      
      filtroSeccion.innerHTML = '<option value=""> Todas las secciones</option>';
      secciones.forEach(s => {
        filtroSeccion.innerHTML += `<option value="${s}">${s}</option>`;
      });
      
      // Ocultar nivel siguiente
      filtroDetalle.style.display = 'none';
      filtroDetalle.value = '';
      
    } else if (nivel === 6 && valor) {
      // Seccin seleccionada  mostrar detalles
      filtroDetalle.style.display = 'block';
      
      const detalles = [...new Set(
        this.repuestos
          .filter(r => 
            r.planta === filtroPlanta.value && 
            r.areaGeneral === filtroArea.value && 
            r.subArea === filtroSubArea.value && 
            r.sistemaEquipo === filtroSistema.value && 
            r.subSistema === filtroSubSistema.value && 
            r.seccion === valor && 
            r.detalle
          )
          .map(r => r.detalle)
      )].sort();
      
      filtroDetalle.innerHTML = '<option value=""> Todos los detalles</option>';
      detalles.forEach(d => {
        filtroDetalle.innerHTML += `<option value="${d}">${d}</option>`;
      });
    }
    
    // Actualizar breadcrumb visual
    this.actualizarBreadcrumbFiltros();
    
    // Aplicar filtros y renderizar
    this.aplicarFiltrosJerarquia();
  }

  // Actualizar breadcrumb visual de filtros activos
  actualizarBreadcrumbFiltros() {
    const breadcrumb = document.getElementById('filtrosBreadcrumb');
    const breadcrumbPath = document.getElementById('breadcrumbPath');
    
    const filtroPlanta = document.getElementById('filtro_planta').value;
    const filtroArea = document.getElementById('filtro_area').value;
    const filtroSubArea = document.getElementById('filtro_subarea').value;
    const filtroSistema = document.getElementById('filtro_sistema').value;
    const filtroSubSistema = document.getElementById('filtro_subsistema').value;
    const filtroSeccion = document.getElementById('filtro_seccion').value;
    const filtroDetalle = document.getElementById('filtro_detalle').value;
    
    // Si no hay filtros activos, ocultar breadcrumb
    if (!filtroPlanta && !filtroArea && !filtroSubArea && !filtroSistema && !filtroSubSistema && !filtroSeccion && !filtroDetalle) {
      breadcrumb.style.display = 'none';
      return;
    }
    
    // Construir ruta visual
    let ruta = [];
    
    if (filtroPlanta) {
      ruta.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroPlanta}</span>`);
    }
    
    if (filtroArea) {
      ruta.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroArea}</span>`);
    }
    
    if (filtroSubArea) {
      ruta.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroSubArea}</span>`);
    }
    
    if (filtroSistema) {
      ruta.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroSistema}</span>`);
    }
    
    if (filtroSubSistema) {
      ruta.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroSubSistema}</span>`);
    }
    
    if (filtroSeccion) {
      ruta.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroSeccion}</span>`);
    }
    
    if (filtroDetalle) {
      ruta.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${filtroDetalle}</span>`);
    }
    
    // Unir con flechas
    breadcrumbPath.innerHTML = ruta.join(' <span style="opacity: 0.6;"></span> ');
    
    // Mostrar breadcrumb
    breadcrumb.style.display = 'flex';
  }

  // Aplicar filtros actuales y renderizar
  aplicarFiltrosJerarquia() {
    const filtroPlanta = document.getElementById('filtro_planta').value;
    const filtroArea = document.getElementById('filtro_area').value;
    const filtroSubArea = document.getElementById('filtro_subarea').value;
    const filtroSistema = document.getElementById('filtro_sistema').value;
    const filtroSubSistema = document.getElementById('filtro_subsistema').value;
    const filtroSeccion = document.getElementById('filtro_seccion').value;
    const filtroDetalle = document.getElementById('filtro_detalle').value;
    
    // Si no hay filtros, mostrar todo
    if (!filtroPlanta && !filtroArea && !filtroSubArea && !filtroSistema && !filtroSubSistema && !filtroSeccion && !filtroDetalle) {
      this.renderJerarquia();
      return;
    }
    
    // Filtrar repuestos segn criterios
    const repuestosFiltrados = this.repuestos.filter(r => {
      if (filtroPlanta && r.planta !== filtroPlanta) return false;
      if (filtroArea && r.areaGeneral !== filtroArea) return false;
      if (filtroSubArea && r.subArea !== filtroSubArea) return false;
      if (filtroSistema && r.sistemaEquipo !== filtroSistema) return false;
      if (filtroSubSistema && r.subSistema !== filtroSubSistema) return false;
      if (filtroSeccion && r.seccion !== filtroSeccion) return false;
      if (filtroDetalle && r.detalle !== filtroDetalle) return false;
      return true;
    });
    
    // Actualizar contador
    document.getElementById('repuestosVisibles').textContent = repuestosFiltrados.length;
    
    // Renderizar rbol filtrado (antiguo)
    this.renderJerarquiaFiltrada(repuestosFiltrados);
    
    //  Renderizar rbol estilo SAP PM
    this.renderSAPTree();
  }

  // Limpiar todos los filtros
  limpiarFiltrosJerarquia() {
    document.getElementById('filtro_planta').value = '';
    document.getElementById('filtro_area').value = '';
    document.getElementById('filtro_area').style.display = 'none';
    document.getElementById('filtro_subarea').value = '';
    document.getElementById('filtro_subarea').style.display = 'none';
    document.getElementById('filtro_sistema').value = '';
    document.getElementById('filtro_sistema').style.display = 'none';
    document.getElementById('filtro_subsistema').value = '';
    document.getElementById('filtro_subsistema').style.display = 'none';
    document.getElementById('filtro_seccion').value = '';
    document.getElementById('filtro_seccion').style.display = 'none';
    document.getElementById('filtro_detalle').value = '';
    document.getElementById('filtro_detalle').style.display = 'none';
    document.getElementById('btnLimpiarFiltros').style.display = 'none';
    
    // Ocultar breadcrumb
    document.getElementById('filtrosBreadcrumb').style.display = 'none';
    
    // Renderizar todo
    this.renderJerarquia();
    
    //  Renderizar rbol estilo SAP PM
    this.renderSAPTree();
  }

  // Ir a inventario con filtros desde un nodo jerrquico
  irAInventarioConFiltro(filtros) {
    console.log(' irAInventarioConFiltro llamado con:', filtros);
    
    // Aplicar filtros jerrquicos PRIMERO
    this.filtrosJerarquicosActivos = filtros;
    
    console.log(' Filtros guardados en this.filtrosJerarquicosActivos:', this.filtrosJerarquicosActivos);
    
    // Mostrar botn para quitar filtros
    const btnQuitar = document.getElementById('quitarFiltrosJerarquicosBtn');
    if (btnQuitar) {
      btnQuitar.style.display = 'inline-block';
      console.log(' Botn "Quitar Filtros" mostrado');
    }
    
    // Cambiar a pestaa inventario (esto llamar a renderInventario)
    this.switchTab('inventario');
    
    // FORZAR re-renderizado despus de cambiar de pestaa para asegurar que los filtros se apliquen
    setTimeout(() => {
      console.log(' Re-renderizando inventario con filtros...');
      this.renderInventario();
    }, 50);
    
    // Mostrar toast informativo con el nivel MS ESPECFICO
    const nivelNombres = {
      planta: ' Planta',
      areaGeneral: ' rea',
      subArea: ' Sub-rea',
      sistemaEquipo: ' Sistema',
      subSistema: ' Sub-Sistema',
      seccion: ' Seccin',
      detalle: ' Detalle'
    };
    
    // Buscar el nivel ms profundo (el ltimo con valor)
    const ordenNiveles = ['detalle', 'seccion', 'subSistema', 'sistemaEquipo', 'subArea', 'areaGeneral', 'planta'];
    const filtroActivo = ordenNiveles.find(k => filtros[k]);
    
    if (filtroActivo) {
      this.showToast(` Filtrando por ${nivelNombres[filtroActivo]}: ${filtros[filtroActivo]}`, 'info');
    }
  }

  // Ir a inventario mostrando solo un repuesto especfico
  irAInventarioConRepuesto(repuestoId, ubicacionIndex = null, numeroInstancia = null) {
    console.log('🔍 irAInventarioConRepuesto llamado con:', { repuestoId, ubicacionIndex, numeroInstancia });
    
    // Buscar el repuesto para obtener su nombre
    const repuesto = this.repuestos.find(r => r.id === repuestoId);
    if (!repuesto) {
      console.error('❌ Repuesto no encontrado:', repuestoId);
      return;
    }
    
    // Aplicar filtro por ID de repuesto
    this.filtrosJerarquicosActivos = { 
      repuestoId: repuestoId,
      ubicacionIndex: ubicacionIndex,
      numeroInstancia: numeroInstancia
    };
    
    console.log('✅ Filtro de repuesto guardado:', this.filtrosJerarquicosActivos);
    
    // Mostrar botn para quitar filtros
    const btnQuitar = document.getElementById('quitarFiltrosJerarquicosBtn');
    if (btnQuitar) {
      btnQuitar.style.display = 'inline-block';
      console.log('✅ Botn "Quitar Filtros" mostrado');
    }
    
    // Cambiar a pestaa inventario
    this.switchTab('inventario');
    
    // FORZAR re-renderizado
    setTimeout(() => {
      console.log(' Re-renderizando inventario con filtro de repuesto...');
      this.renderInventario();
    }, 50);
    
    // Mostrar toast informativo con el nombre del repuesto
    const nombreRepuesto = repuesto.nombre || repuesto.codSAP || 'Repuesto';
    this.showToast(` Mostrando repuesto: ${nombreRepuesto}`, 'info');
  }

  // Buscar en jerarqua (niveles y repuestos)
  buscarEnJerarquia(query) {
    const resultsContainer = document.getElementById('searchResultsJerarquia');
    
    if (!query || query.trim().length < 2) {
      resultsContainer.style.display = 'none';
      return;
    }
    
    const searchTerm = query.toLowerCase().trim();
    const results = [];
    
    // Buscar SOLO en repuestos por cdigo o nombre
    this.repuestos.forEach(r => {
      const matches = 
        (r.codSAP && r.codSAP.toLowerCase().includes(searchTerm)) ||
        (r.nombre && r.nombre.toLowerCase().includes(searchTerm));
      
      if (matches) {
        results.push({
          tipo: 'repuesto',
          id: r.id,
          nombre: r.nombre,
          codSAP: r.codSAP,
          stock: r.cantidad,
          ubicacion: [r.planta, r.areaGeneral, r.sistemaEquipo].filter(x => x).join(' > ')
        });
      }
    });
    
    // Buscar en niveles jerrquicos Y contar repuestos de cada nivel
    const nivelesMap = new Map();
    
    this.repuestos.forEach(r => {
      // Nivel 1: Planta
      if (r.planta && r.planta.toLowerCase().includes(searchTerm)) {
        const key = JSON.stringify({ tipo: 'planta', valor: r.planta, nivel: 'Planta' });
        if (!nivelesMap.has(key)) {
          nivelesMap.set(key, { data: JSON.parse(key), count: 0 });
        }
        nivelesMap.get(key).count++;
      }
      
      // Nivel 2: rea General
      if (r.areaGeneral && r.areaGeneral.toLowerCase().includes(searchTerm)) {
        const key = JSON.stringify({ 
          tipo: 'areaGeneral', 
          valor: r.areaGeneral, 
          nivel: 'rea',
          planta: r.planta 
        });
        if (!nivelesMap.has(key)) {
          nivelesMap.set(key, { data: JSON.parse(key), count: 0 });
        }
        nivelesMap.get(key).count++;
      }
      
      // Nivel 3: Sub-rea
      if (r.subArea && r.subArea.toLowerCase().includes(searchTerm)) {
        const key = JSON.stringify({ 
          tipo: 'subArea', 
          valor: r.subArea, 
          nivel: 'Sub-rea',
          planta: r.planta,
          areaGeneral: r.areaGeneral
        });
        if (!nivelesMap.has(key)) {
          nivelesMap.set(key, { data: JSON.parse(key), count: 0 });
        }
        nivelesMap.get(key).count++;
      }
      
      // Nivel 4: Sistema/Equipo
      if (r.sistemaEquipo && r.sistemaEquipo.toLowerCase().includes(searchTerm)) {
        const key = JSON.stringify({ 
          tipo: 'sistemaEquipo', 
          valor: r.sistemaEquipo, 
          nivel: 'Sistema',
          planta: r.planta,
          areaGeneral: r.areaGeneral,
          subArea: r.subArea
        });
        if (!nivelesMap.has(key)) {
          nivelesMap.set(key, { data: JSON.parse(key), count: 0 });
        }
        nivelesMap.get(key).count++;
      }
      
      // Nivel 5: Sub-Sistema
      if (r.subSistema && r.subSistema.toLowerCase().includes(searchTerm)) {
        const key = JSON.stringify({ 
          tipo: 'subSistema', 
          valor: r.subSistema, 
          nivel: 'Sub-Sistema',
          planta: r.planta,
          areaGeneral: r.areaGeneral,
          subArea: r.subArea,
          sistemaEquipo: r.sistemaEquipo
        });
        if (!nivelesMap.has(key)) {
          nivelesMap.set(key, { data: JSON.parse(key), count: 0 });
        }
        nivelesMap.get(key).count++;
      }
      
      // Nivel 6: Seccin
      if (r.seccion && r.seccion.toLowerCase().includes(searchTerm)) {
        const key = JSON.stringify({ 
          tipo: 'seccion', 
          valor: r.seccion, 
          nivel: 'Seccin',
          planta: r.planta,
          areaGeneral: r.areaGeneral,
          subArea: r.subArea,
          sistemaEquipo: r.sistemaEquipo,
          subSistema: r.subSistema
        });
        if (!nivelesMap.has(key)) {
          nivelesMap.set(key, { data: JSON.parse(key), count: 0 });
        }
        nivelesMap.get(key).count++;
      }
      
      // Nivel 7: Detalle
      if (r.detalle && r.detalle.toLowerCase().includes(searchTerm)) {
        const key = JSON.stringify({ 
          tipo: 'detalle', 
          valor: r.detalle, 
          nivel: 'Detalle',
          planta: r.planta,
          areaGeneral: r.areaGeneral,
          subArea: r.subArea,
          sistemaEquipo: r.sistemaEquipo,
          subSistema: r.subSistema,
          seccion: r.seccion
        });
        if (!nivelesMap.has(key)) {
          nivelesMap.set(key, { data: JSON.parse(key), count: 0 });
        }
        nivelesMap.get(key).count++;
      }
    });
    
    // Convertir niveles a array de objetos
    const nivelesArray = Array.from(nivelesMap.values());
    
    // Renderizar resultados
    let html = '';
    
    if (nivelesArray.length === 0 && results.length === 0) {
      html = '<div style="padding: 16px; text-align: center; color: var(--gray-500);">No se encontraron resultados</div>';
    } else {
      // Mostrar niveles jerrquicos primero
      if (nivelesArray.length > 0) {
        html += '<div style="padding: 8px; background: var(--bg-light); border-bottom: 1px solid var(--border-color); font-weight: bold; color: var(--primary-color);"> Niveles Jerrquicos</div>';
        nivelesArray.slice(0, 10).forEach(nivelObj => {
          const nivel = nivelObj.data;
          const count = nivelObj.count;
          
          const filtros = {};
          if (nivel.planta) filtros.planta = nivel.planta;
          if (nivel.areaGeneral) filtros.areaGeneral = nivel.areaGeneral;
          if (nivel.subArea) filtros.subArea = nivel.subArea;
          if (nivel.sistemaEquipo) filtros.sistemaEquipo = nivel.sistemaEquipo;
          if (nivel.subSistema) filtros.subSistema = nivel.subSistema;
          if (nivel.seccion) filtros.seccion = nivel.seccion;
          if (nivel.detalle) filtros.detalle = nivel.detalle;
          
          const filtrosStr = JSON.stringify(filtros).replace(/"/g, '&quot;');
          
          html += `
            <div 
              onclick="app.irAInventarioConFiltro(${filtrosStr}); document.getElementById('searchJerarquia').value = ''; app.buscarEnJerarquia('');" 
              style="
                padding: 12px;
                border-bottom: 1px solid var(--border-color);
                cursor: pointer;
                transition: background 0.2s;
                background: var(--bg-primary);
              "
              onmouseover="this.style.background='var(--bg-secondary)'"
              onmouseout="this.style.background='var(--bg-primary)'"
            >
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: 600; color: var(--text-primary);">
                  ${nivel.nivel}: ${nivel.valor}
                </div>
                <div style="background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                  ${count} repuesto${count !== 1 ? 's' : ''}
                </div>
              </div>
              <div style="font-size: 0.85rem; color: var(--gray-500); margin-top: 4px;">
                ${[nivel.planta, nivel.areaGeneral, nivel.subArea].filter(x => x).join(' > ')}
              </div>
            </div>
          `;
        });
      }
      
      // Mostrar repuestos
      if (results.length > 0) {
        html += '<div style="padding: 8px; background: var(--bg-light); border-bottom: 1px solid var(--border-color); font-weight: bold; color: var(--primary-color);"> Repuestos</div>';
        results.slice(0, 15).forEach(r => {
          html += `
            <div 
              onclick="app.irAInventarioConRepuesto('${r.id}'); document.getElementById('searchJerarquia').value = ''; app.buscarEnJerarquia('');" 
              style="
                padding: 12px;
                border-bottom: 1px solid var(--border-color);
                cursor: pointer;
                transition: background 0.2s;
                background: var(--bg-primary);
              "
              onmouseover="this.style.background='var(--bg-secondary)'"
              onmouseout="this.style.background='var(--bg-primary)'"
            >
              <div style="font-weight: 600; color: var(--text-primary);">
                ${r.codSAP || 'N/A'} - ${r.nombre}
              </div>
              <div style="font-size: 0.85rem; color: var(--gray-500); margin-top: 4px; display: flex; justify-content: space-between;">
                <span>${r.ubicacion || 'Sin ubicacin'}</span>
                <span style="color: var(--primary-color);">Stock: ${r.stock}</span>
              </div>
            </div>
          `;
        });
      }
      
      if (nivelesArray.length + results.length > 25) {
        html += '<div style="padding: 8px; text-align: center; color: var(--gray-500); font-size: 0.85rem;">Mostrando primeros 25 resultados...</div>';
      }
    }
    
    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
  }

  // Renderizar jerarqua con repuestos filtrados
  renderJerarquiaFiltrada(repuestosFiltrados) {
    const tree = {};
    
    // Construir rbol con repuestos filtrados
    repuestosFiltrados.forEach(r => {
      const planta = r.planta || 'Sin Clasificar';
      if (!tree[planta]) tree[planta] = {};
      
      const areaGeneral = r.areaGeneral || ' Inventario General';
      if (!tree[planta][areaGeneral]) tree[planta][areaGeneral] = {};
      
      const subArea = r.subArea || 'Sin Sub-rea';
      if (!tree[planta][areaGeneral][subArea]) tree[planta][areaGeneral][subArea] = {};
      
      const sistemaEquipo = r.sistemaEquipo || 'Sin Sistema';
      if (!tree[planta][areaGeneral][subArea][sistemaEquipo]) tree[planta][areaGeneral][subArea][sistemaEquipo] = {};
      
      const subSistema = r.subSistema || 'Sin Sub-Sistema';
      if (!tree[planta][areaGeneral][subArea][sistemaEquipo][subSistema]) tree[planta][areaGeneral][subArea][sistemaEquipo][subSistema] = {};
      
      const seccion = r.seccion || 'Sin Seccin';
      if (!tree[planta][areaGeneral][subArea][sistemaEquipo][subSistema][seccion]) tree[planta][areaGeneral][subArea][sistemaEquipo][subSistema][seccion] = {};
      
      const detalle = r.detalle || 'Repuestos';
      if (!tree[planta][areaGeneral][subArea][sistemaEquipo][subSistema][seccion][detalle]) {
        tree[planta][areaGeneral][subArea][sistemaEquipo][subSistema][seccion][detalle] = [];
      }
      
      tree[planta][areaGeneral][subArea][sistemaEquipo][subSistema][seccion][detalle].push(r);
    });

    const container = document.getElementById('treeContainer');
    
    if (repuestosFiltrados.length === 0) {
      container.innerHTML = '<div class="text-center" style="padding: 60px; color: var(--gray-500);">No hay repuestos en este nivel</div>';
      return;
    }

    let html = '';
    let nodeCounter = 0;
    const getNodeId = () => `node-${nodeCounter++}`;
    
    // Renderizar rbol simplificado (igual que renderJerarquia pero con datos filtrados)
    Object.keys(tree).sort().forEach(planta => {
      const plantaId = getNodeId();
      html += `
        <div class="tree-node tree-area">
          <div class="tree-item" onclick="app.toggleTree('${plantaId}')">
            <span class="tree-toggle expanded" id="${plantaId}-toggle"></span>
            <span> ${planta}</span>
          </div>
          <div class="tree-children expanded" id="${plantaId}">
      `;
      
      // Recolectar y mostrar todos los repuestos bajo esta planta
      const collectAllRepuestos = (obj, repuestos = []) => {
        if (Array.isArray(obj)) {
          repuestos.push(...obj);
        } else {
          Object.values(obj).forEach(val => collectAllRepuestos(val, repuestos));
        }
        return repuestos;
      };
      
      const repuestos = collectAllRepuestos(tree[planta]);
      repuestos.forEach(r => {
        html += `
          <div class="tree-node tree-repuesto">
            <div class="tree-item" style="display: flex; align-items: center; gap: 8px; padding-left: 40px;">
              <span style="flex: 1;"> ${r.codSAP || 'N/A'} - ${r.nombre}</span>
              <span style="font-size: 0.85rem; color: var(--gray-500);">Stock: ${r.cantidad}</span>
              <button onclick="app.irAInventarioConRepuesto('${r.id}')" style="
                padding: 4px 12px;
                font-size: 0.8rem;
                background: var(--primary-color);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              " title="Ver en inventario"> Ver</button>
            </div>
          </div>
        `;
      });
      
      html += '</div></div>';
    });
    
    container.innerHTML = html;
  }

  // Actualizar contador de repuestos visibles
  actualizarContadorJerarquia() {
    const counter = document.getElementById('repuestosVisibles');
    if (counter) {
      counter.textContent = this.repuestos.length;
    }
  }

  // Ir a tarjeta desde jerarqua (con opcin de filtros)
  irATarjeta(id, aplicarFiltrosJerarquicos = false) {
    // Si se solicita aplicar filtros jerrquicos, obtenerlos del repuesto
    if (aplicarFiltrosJerarquicos) {
      const repuesto = this.repuestos.find(r => r.id === id);
      if (repuesto) {
        this.aplicarFiltrosDesdeJerarquia(repuesto);
      }
    }
    
    // Cambiar al tab de inventario
    this.switchTab('inventario');
    
    // Esperar a que se renderice el tab
    setTimeout(() => {
      // Buscar la tarjeta del producto
      const card = document.querySelector(`[data-id="${id}"]`)?.closest('.repuesto-card');
      
      if (card) {
        // Hacer scroll suave a la tarjeta
        card.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
        // Destacar la tarjeta temporalmente
        card.style.transition = 'all 0.3s ease';
        card.style.transform = 'scale(1.05)';
        card.style.boxShadow = '0 0 30px rgba(59, 130, 246, 0.6)';
        card.style.borderColor = '#3b82f6';
        
        setTimeout(() => {
          card.style.transform = '';
          card.style.boxShadow = '';
          card.style.borderColor = '';
        }, 2000);
        
        this.showToast(' Producto localizado', 'success');
      } else {
        this.showToast(' Producto no encontrado en vista actual', 'warning');
      }
    }, 300);
  }

  // Aplicar filtros de jerarqua en inventario
  aplicarFiltrosDesdeJerarquia(repuesto) {
    // Guardar los filtros jerrquicos activos
    this.filtrosJerarquicosActivos = {
      planta: repuesto.planta,
      areaGeneral: repuesto.areaGeneral,
      subArea: repuesto.subArea,
      sistemaEquipo: repuesto.sistemaEquipo,
      subSistema: repuesto.subSistema,
      seccion: repuesto.seccion
    };
    
    // Mostrar botn para quitar filtros
    const btnQuitar = document.getElementById('quitarFiltrosJerarquicosBtn');
    if (btnQuitar) {
      btnQuitar.style.display = 'inline-block';
    }
    
    // Re-renderizar inventario con filtros aplicados
    this.renderInventario();
  }

  // Quitar filtros jerrquicos aplicados desde jerarqua
  quitarFiltrosJerarquicos() {
    this.filtrosJerarquicosActivos = null;
    
    // Ocultar botn
    const btnQuitar = document.getElementById('quitarFiltrosJerarquicosBtn');
    if (btnQuitar) {
      btnQuitar.style.display = 'none';
    }
    
    // Re-renderizar inventario sin filtros jerrquicos
    this.renderInventario();
    this.showToast(' Filtros jerrquicos eliminados', 'success');
  }

  //  ETAPA 5: Ver repuesto en mapa
  //  NUEVA FUNCIN: Agregar ubicacin en mapa (siempre abre modal para nueva ubicacin)
  async agregarUbicacionMapa(id) {
    console.log(' Agregar nueva ubicacin en mapa:', id);
    
    //  Verificar conexin y conectar si es necesario
    if (!fsManager.isConnected) {
      this.showToast(' Conectando al sistema de archivos...', 'info');
      const connected = await LoadingModal.runTask(
        () => app.connectWorkspace(false, true),
        {
          startMessage: 'Conectando para mapas...',
          statusMessage: 'Buscando carpeta INVENTARIO_STORAGE...',
          successMessage: 'Conectado',
          errorMessage: 'No se pudo conectar',
          autoHide: false,
          tips: [
            'La carpeta debe contener la subcarpeta mapas/.',
            'Si cambiaste de PC, asegúrate de seleccionar la carpeta correcta.'
          ]
        }
      );
      
      if (!connected) {
        this.showToast(' No se pudo conectar al sistema de archivos', 'error');
        this.switchTab('configuracion');
        LoadingModal.finish({
          message: 'Sin conexión',
          status: 'Acción requerida',
          tip: 'Selecciona una carpeta válida para acceder al mapa.',
          delay: 600
        });
        return;
      }

      LoadingModal.finish({
        message: 'Carpeta lista',
        status: 'Mapas disponibles',
        tip: 'Ya puedes vincular ubicaciones.',
        delay: 400
      });
    }
    
    if (!mapStorage.initialized) {
      this.showToast(' Error: Sistema de mapas no inicializado', 'error');
      return;
    }
    
    const repuesto = this.repuestos.find(r => String(r.id) === String(id));
    
    if (!repuesto) {
      this.showToast(' Repuesto no encontrado', 'error');
      return;
    }
    
    // Siempre abrir modal para agregar nueva ubicacin
    this.abrirModalAsignarAreaMapa(id, repuesto);
  }

  async verRepuestoEnMapa(id) {
    console.log(' Ver repuesto en mapa:', id);
    
    //  Verificar conexin y conectar si es necesario (USANDO MTODO CENTRALIZADO)
    if (!fsManager.isConnected) {
      this.showToast(' Conectando al sistema de archivos...', 'info');
      const connected = await LoadingModal.runTask(
        () => app.connectWorkspace(false, true), // Pedir al usuario seleccionar carpeta
        {
          startMessage: 'Conectando para mapas...',
          statusMessage: 'Cargando rutas y planos...',
          successMessage: 'Conectado',
          errorMessage: 'No se pudo conectar',
          autoHide: false,
          tips: [
            'Autoriza el acceso para poder ver las ubicaciones.',
            'Puedes cancelar con Esc si deseas seleccionar otra carpeta.'
          ]
        }
      );
      
      if (!connected) {
        this.showToast(' No se pudo conectar al sistema de archivos', 'error');
        this.switchTab('configuracion');
        LoadingModal.finish({
          message: 'Conexión cancelada',
          status: 'Mapas no disponibles',
          tip: 'Selecciona la carpeta correcta para continuar.',
          delay: 600
        });
        return;
      }

      LoadingModal.finish({
        message: 'Listo para mostrar mapas',
        status: 'Datos sincronizados',
        tip: 'Buscando ubicaciones del repuesto...',
        delay: 300
      });
    }
    
    // mapStorage ya debera estar inicializado por connectWorkspace
    if (!mapStorage.initialized) {
      this.showToast(' Error: Sistema de mapas no inicializado', 'error');
      return;
    }
    
    // Buscar el repuesto
    const repuesto = this.repuestos.find(r => String(r.id) === String(id));
    
    if (!repuesto) {
      this.showToast(' Repuesto no encontrado', 'error');
      return;
    }
    
    // Obtener todas las ubicaciones
    let ubicaciones = [];
    
    if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones) && repuesto.ubicaciones.length > 0) {
      ubicaciones = repuesto.ubicaciones.filter(ub => ub.mapId && ub.areaId);
      
      //  LIMPIEZA: Si hay formato nuevo, eliminar propiedades antiguas para evitar duplicados
      if (repuesto.mapId || repuesto.markerX || repuesto.markerY) {
        console.log(` Limpiando formato antiguo de "${repuesto.nombre}" (ya tiene ubicaciones[])`);
        delete repuesto.mapId;
        delete repuesto.areaId;
        delete repuesto.markerX;
        delete repuesto.markerY;
        delete repuesto.ubicacionDescripcion;
        // Guardar cambio para persistir la limpieza
        this.saveData().catch(err => console.error('Error guardando limpieza:', err));
      }
    } else if (repuesto.mapId && repuesto.areaId) {
      // Formato antiguo - convertir a array
      ubicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY,
        descripcion: repuesto.ubicacionDescripcion
      }];
    }
    
    console.log(' Ubicaciones encontradas:', ubicaciones.length);
    
    //  Si NO tiene ubicaciones, informar al usuario
    if (ubicaciones.length === 0) {
      this.showToast(' Este repuesto no tiene ubicaciones. Usa " Aadir Ubicacin" para agregarlo al mapa.', 'info', 4000);
      return;
    }
    
    //  SIEMPRE mostrar modal, incluso con 1 ubicacin (para consistencia y opciones)
    this.mostrarModalSeleccionUbicacion(repuesto, ubicaciones);
  }

  //  NUEVA FUNCIN: Modal para seleccionar entre mltiples ubicaciones
  mostrarModalSeleccionUbicacion(repuesto, ubicaciones) {
    console.log(' Mostrar modal de seleccin de ubicacin');
    console.log(`   Repuesto: ${repuesto.nombre}`);
    console.log(`   Ubicaciones recibidas: ${ubicaciones.length}`);
    
    //  FIX BUG 1: Eliminar TODOS los modales existentes antes de crear uno nuevo
    const modalesExistentes = document.querySelectorAll('#modalSeleccionUbicacion');
    if (modalesExistentes.length > 0) {
      console.log(`    Limpiando ${modalesExistentes.length} modal(es) antiguo(s)...`);
      modalesExistentes.forEach(modal => modal.remove());
    }
    
    // Crear HTML de las ubicaciones con checkbox
    let ubicacionesHTML = '';
    ubicaciones.forEach((ub, index) => {
      const mapa = mapStorage.maps.find(m => m.id === ub.mapId);
      const area = mapStorage.areas.find(a => a.id === ub.areaId);
      
      const mapaNombre = mapa ? mapa.name : 'Mapa desconocido';
      const areaNombre = area ? area.name : 'rea desconocida';
      const icono = area && mapController?.categories?.[area.category]?.icon || '';
      const descripcion = ub.descripcion || '';
      
      ubicacionesHTML += `
        <div style="
          padding: 16px;
          background: var(--bg-secondary);
          border: 2px solid var(--border-color);
          border-radius: 12px;
          margin-bottom: 12px;
          transition: all 0.3s ease;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        " 
        class="ubicacion-item" 
        data-index="${index}"
        onmouseenter="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"
        onmouseleave="this.style.borderColor='var(--border-color)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">
          
          <div style="display: flex; align-items: start; gap: 14px;">
            <!-- Checkbox -->
            <input type="checkbox" 
                   id="ubicacion-check-${index}" 
                   class="ubicacion-checkbox"
                   style="
                     margin-top: 6px; 
                     width: 20px; 
                     height: 20px; 
                     cursor: pointer;
                     accent-color: var(--primary);
                   "
                   onchange="app.toggleUbicacionSeleccion(${index})">
            
            <!-- Contenido principal -->
            <div style="flex: 1;">
              <!-- Encabezado con cono y nombre -->
              <div style="
                display: flex; 
                align-items: center; 
                gap: 8px;
                font-weight: 700; 
                font-size: 1.05rem;
                margin-bottom: 8px;
                color: var(--text-primary);
              ">
                <span style="font-size: 1.4rem;">${icono}</span>
                <span>${areaNombre}</span>
              </div>
              
              <!-- Nombre del mapa -->
              <div style="
                font-size: 0.9rem; 
                color: var(--text-secondary); 
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <span style="opacity: 0.7;"></span>
                <span>${mapaNombre}</span>
              </div>
              
              <!-- Descripcin -->
              ${descripcion ? `
                <div style="
                  font-size: 0.9rem; 
                  color: var(--text-primary);
                  background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
                  padding: 10px 14px;
                  border-radius: 8px;
                  margin: 10px 0;
                  border-left: 4px solid var(--primary);
                  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                  line-height: 1.5;
                ">
                  <div style="font-weight: 600; font-size: 0.75rem; color: var(--primary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                     Descripcin
                  </div>
                  ${descripcion}
                </div>
              ` : `
                <div style="
                  font-size: 0.85rem; 
                  color: var(--text-muted);
                  font-style: italic;
                  margin: 8px 0;
                  padding: 8px;
                  background: var(--bg-tertiary);
                  border-radius: 6px;
                  text-align: center;
                ">
                  Sin descripcin personalizada
                </div>
              `}
              
              <!-- Coordenadas -->
              ${ub.markerX && ub.markerY ? `
                <div style="
                  font-size: 0.8rem; 
                  color: var(--text-muted); 
                  margin-top: 8px;
                  font-family: 'Courier New', monospace;
                  background: var(--bg-tertiary);
                  display: inline-block;
                  padding: 4px 10px;
                  border-radius: 4px;
                ">
                   (${Math.round(ub.markerX)}, ${Math.round(ub.markerY)})
                </div>
              ` : ''}
              
              <!-- Botones de accin -->
              <div style="
                display: grid; 
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 8px; 
                margin-top: 14px;
              ">
                <button onclick="app.verUbicacionIndividual('${repuesto.id}', ${index})" style="
                  padding: 10px 14px;
                  background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 0.85rem;
                  cursor: pointer;
                  font-weight: 600;
                  transition: all 0.2s ease;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                "
                onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                   Ver en Mapa
                </button>
                
                <button onclick="app.editarDescripcionUbicacion('${repuesto.id}', ${index})" style="
                  padding: 10px 14px;
                  background: linear-gradient(135deg, var(--info) 0%, #117a8b 100%);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 0.85rem;
                  cursor: pointer;
                  font-weight: 600;
                  transition: all 0.2s ease;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                "
                onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                   Editar Nota
                </button>
                
                <button onclick="app.editarUbicacionRepuesto('${repuesto.id}', ${index})" style="
                  padding: 10px 14px;
                  background: linear-gradient(135deg, var(--warning) 0%, #d39e00 100%);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 0.85rem;
                  cursor: pointer;
                  font-weight: 600;
                  transition: all 0.2s ease;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                "
                onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                   Mover Pin
                </button>
                
                <button onclick="app.eliminarUbicacionRepuesto('${repuesto.id}', ${index})" style="
                  padding: 10px 14px;
                  background: linear-gradient(135deg, var(--danger) 0%, #bd2130 100%);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 0.85rem;
                  cursor: pointer;
                  font-weight: 600;
                  transition: all 0.2s ease;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                "
                onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                   Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    });
    
    const modalHTML = `
      <div class="modal active" id="modalSeleccionUbicacion" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 700px;">
          <button class="modal-close" onclick="document.getElementById('modalSeleccionUbicacion').remove()"></button>
          
          <!-- Ttulo del modal -->
          <div class="modal-title" style="
            background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%);
            color: white;
            padding: 20px 24px;
            margin: -20px -24px 20px;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          ">
            <div style="font-size: 1.4rem; font-weight: 700; margin-bottom: 6px;">
               Ubicaciones del Repuesto
            </div>
            <div style="font-size: 1.1rem; opacity: 0.95;">
              ${repuesto.nombre}
            </div>
          </div>
          
          <div style="padding: 0 24px 24px;">
            <!-- Contador de ubicaciones -->
            <div style="
              margin-bottom: 20px; 
              padding: 14px 18px;
              background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
              border-radius: 10px;
              border-left: 4px solid var(--accent);
              box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            ">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.8rem;"></span>
                <div>
                  <div style="font-weight: 600; font-size: 1.05rem;">
                    ${ubicaciones.length} ${ubicaciones.length === 1 ? 'Ubicacin' : 'Ubicaciones'} Registradas
                  </div>
                  <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 2px;">
                    Selecciona una o varias ubicaciones para visualizar
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Lista de ubicaciones -->
            <div style="max-height: 450px; overflow-y: auto; margin-bottom: 20px; padding-right: 8px;">
              ${ubicacionesHTML}
            </div>
            
            <!-- Botones principales -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <button onclick="app.verTodasLasUbicaciones('${repuesto.id}')" class="btn btn-primary" style="
                padding: 14px 20px;
                background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
              "
              onmouseenter="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)';"
              onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';">
                 Ver Todas en Mapa
              </button>
              
              <button id="btnVerSeleccionadas" onclick="app.verUbicacionesSeleccionadas('${repuesto.id}')" class="btn btn-accent" style="
                padding: 14px 20px;
                background: linear-gradient(135deg, var(--accent) 0%, #218838 100%);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                opacity: 0.5;
              "
              disabled
              onmouseenter="if(!this.disabled) { this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'; }"
              onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';">
                 Ver Seleccionadas (<span id="countSeleccionadas">0</span>)
              </button>
            </div>
            
            <!-- Botn cerrar -->
            <button onclick="document.getElementById('modalSeleccionUbicacion').remove()" class="btn btn-secondary" style="
              width: 100%; 
              padding: 12px;
              background: var(--bg-tertiary);
              color: var(--text-primary);
              border: 2px solid var(--border-color);
              border-radius: 8px;
              font-size: 0.95rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s ease;
            "
            onmouseenter="this.style.background='var(--bg-secondary)'; this.style.borderColor='var(--text-muted)';"
            onmouseleave="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border-color)';">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    `;
    
    const modalAnterior = document.getElementById('modalSeleccionUbicacion');
    if (modalAnterior) modalAnterior.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Inicializar estado de seleccin
    window._ubicacionesSeleccionadas = new Set();
  }

  //  NUEVA FUNCIN: Toggle seleccin de ubicacin con checkbox
  toggleUbicacionSeleccion(indice) {
    if (!window._ubicacionesSeleccionadas) {
      window._ubicacionesSeleccionadas = new Set();
    }
    
    const checkbox = document.getElementById(`ubicacion-check-${indice}`);
    
    if (checkbox.checked) {
      window._ubicacionesSeleccionadas.add(indice);
    } else {
      window._ubicacionesSeleccionadas.delete(indice);
    }
    
    // Actualizar contador y estado del botn
    const count = window._ubicacionesSeleccionadas.size;
    const countSpan = document.getElementById('countSeleccionadas');
    const btnSeleccionadas = document.getElementById('btnVerSeleccionadas');
    
    if (countSpan) countSpan.textContent = count;
    if (btnSeleccionadas) {
      btnSeleccionadas.disabled = count === 0;
      // Cambiar opacidad segn estado
      btnSeleccionadas.style.opacity = count === 0 ? '0.5' : '1';
      btnSeleccionadas.style.cursor = count === 0 ? 'not-allowed' : 'pointer';
    }
  }

  //  NUEVA FUNCIN: Ver una ubicacin individual en el mapa
  verUbicacionIndividual(repuestoId, indice) {
    const repuesto = this.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    let ubicaciones = repuesto.ubicaciones || [];
    if (ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
      ubicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY,
        descripcion: repuesto.ubicacionDescripcion
      }];
    }
    
    const ubicacion = ubicaciones[indice];
    if (!ubicacion) return;
    
    // Cerrar modal
    const modal = document.getElementById('modalSeleccionUbicacion');
    if (modal) modal.remove();
    
    //  FIX BUG 2: Llamar directamente a moverMarcador para activar el pin naranja + modal flotante
    console.log(' Ver en Mapa  Activando moverMarcador para activar modo edicin');
    
    // Cambiar a tab de mapa primero
    this.switchTab('mapa');
    
    // Esperar a que el tab se active y luego llamar a moverMarcador
    setTimeout(() => {
      if (typeof mapController !== 'undefined' && mapController.moverMarcador) {
        mapController.moverMarcador(repuestoId, indice);
      } else {
        console.error(' mapController.moverMarcador no disponible');
        this.showToast(' Sistema de mapas no disponible', 'error');
      }
    }, 300);
  }

  //  NUEVA FUNCIN: Ver todas las ubicaciones en el mapa
  verTodasLasUbicaciones(repuestoId) {
    const repuesto = this.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    let ubicaciones = repuesto.ubicaciones || [];
    if (ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
      ubicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY,
        descripcion: repuesto.ubicacionDescripcion
      }];
    }
    
    // Cerrar modal
    const modal = document.getElementById('modalSeleccionUbicacion');
    if (modal) modal.remove();
    
    // Cambiar a tab de mapa
    this.switchTab('mapa');
    
    // Resaltar todas las ubicaciones
    this.showToast(` Mostrando ${ubicaciones.length} ubicaciones de "${repuesto.nombre}"`, 'info');
    
    setTimeout(() => {
      if (mapController && mapController.mostrarMultiplesUbicaciones) {
        mapController.mostrarMultiplesUbicaciones(ubicaciones, repuesto);
      }
    }, 300);
  }

  //  NUEVA FUNCIN: Ver ubicaciones seleccionadas
  verUbicacionesSeleccionadas(repuestoId) {
    if (!window._ubicacionesSeleccionadas || window._ubicacionesSeleccionadas.size === 0) {
      this.showToast(' Selecciona al menos una ubicacin', 'warning');
      return;
    }
    
    const repuesto = this.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    let todasUbicaciones = repuesto.ubicaciones || [];
    if (todasUbicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
      todasUbicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY,
        descripcion: repuesto.ubicacionDescripcion
      }];
    }
    
    // Filtrar solo las seleccionadas
    const ubicacionesSeleccionadas = Array.from(window._ubicacionesSeleccionadas)
      .map(index => todasUbicaciones[index])
      .filter(ub => ub);
    
    // Cerrar modal
    const modal = document.getElementById('modalSeleccionUbicacion');
    if (modal) modal.remove();
    
    // Cambiar a tab de mapa
    this.switchTab('mapa');
    
    this.showToast(` Mostrando ${ubicacionesSeleccionadas.length} ubicaciones seleccionadas`, 'info');
    
    setTimeout(() => {
      if (mapController && mapController.mostrarMultiplesUbicaciones) {
        mapController.mostrarMultiplesUbicaciones(ubicacionesSeleccionadas, repuesto);
      }
    }, 300);
  }

  //  NUEVA FUNCIN: Editar descripcin de ubicacin
  async editarDescripcionUbicacion(repuestoId, indice) {
    const repuesto = this.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    let ubicaciones = repuesto.ubicaciones || [];
    if (ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
      ubicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY,
        descripcion: repuesto.ubicacionDescripcion || ''
      }];
      repuesto.ubicaciones = ubicaciones;
      delete repuesto.mapId;
      delete repuesto.areaId;
      delete repuesto.markerX;
      delete repuesto.markerY;
      delete repuesto.ubicacionDescripcion;
    }
    
    const ubicacion = ubicaciones[indice];
    if (!ubicacion) return;
    
    const area = mapStorage.areas.find(a => a.id === ubicacion.areaId);
    const areaNombre = area ? area.name : 'ubicacin';
    
    const descripcionActual = ubicacion.descripcion || '';
    const nuevaDescripcion = prompt(
      `Descripcin para "${areaNombre}":\n\nEjemplo: "Al lado de la mquina BAADER 200, tercer estante"`,
      descripcionActual
    );
    
    if (nuevaDescripcion === null) return; // Usuario cancel
    
    // Actualizar descripcin
    ubicacion.descripcion = nuevaDescripcion.trim();
    
    try {
      await this.saveData();
      this.showToast(' Descripcin actualizada', 'success');
      
      //  Refrescar modal de ubicaciones
      this.refrescarModalUbicaciones(repuestoId);
    } catch (error) {
      console.error('Error guardando descripcin:', error);
      this.showToast(' Error al guardar', 'error');
    }
  }
  
  //  NUEVA FUNCIN: Refrescar modal de ubicaciones despus de cambios
  refrescarModalUbicaciones(repuestoId) {
    const repuesto = this.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    let ubicaciones = repuesto.ubicaciones || [];
    if (ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
      ubicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY,
        descripcion: repuesto.ubicacionDescripcion
      }];
    }
    
    //  FIX BUG 1: Eliminar TODOS los modales duplicados antes de recrear
    console.log(' Refrescando modal de ubicaciones...');
    const modalesAntiguos = document.querySelectorAll('#modalSeleccionUbicacion');
    modalesAntiguos.forEach((modal, index) => {
      console.log(`   Eliminando modal duplicado ${index + 1}/${modalesAntiguos.length}`);
      modal.remove();
    });
    
    // Si ya no hay ubicaciones, solo cerrar
    if (ubicaciones.length === 0) {
      this.showToast(' El repuesto ya no tiene ubicaciones', 'info');
      return;
    }
    
    // Reabrir con datos actualizados (esperar para asegurar limpieza del DOM)
    setTimeout(() => {
      console.log(`   Recreando modal con ${ubicaciones.length} ubicacin(es)`);
      this.mostrarModalSeleccionUbicacion(repuesto, ubicaciones);
    }, 150);
  }

  //  NUEVA FUNCIN: Seleccionar y mostrar una ubicacin especfica
  seleccionarYMostrarUbicacion(repuestoId, indice) {
    const repuesto = this.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    let ubicaciones = repuesto.ubicaciones || [];
    if (ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
      ubicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY
      }];
    }
    
    const ubicacion = ubicaciones[indice];
    if (!ubicacion) return;
    
    // Cerrar modal
    const modal = document.getElementById('modalSeleccionUbicacion');
    if (modal) modal.remove();
    
    // Mostrar en mapa
    this.mostrarRepuestoEnMapa(ubicacion, repuesto);
  }

  //  NUEVA FUNCIN: Editar ubicacin de repuesto
  async editarUbicacionRepuesto(repuestoId, indice) {
    const repuesto = this.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    let ubicaciones = repuesto.ubicaciones || [];
    if (ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
      ubicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY
      }];
      // Convertir formato antiguo a nuevo
      repuesto.ubicaciones = ubicaciones;
      delete repuesto.mapId;
      delete repuesto.areaId;
      delete repuesto.markerX;
      delete repuesto.markerY;
    }
    
    const ubicacion = ubicaciones[indice];
    if (!ubicacion) return;
    
    const area = mapStorage.areas.find(a => a.id === ubicacion.areaId);
    const areaNombre = area ? area.name : 'el rea';
    
    // Cerrar modal de seleccin
    const modalSeleccion = document.getElementById('modalSeleccionUbicacion');
    if (modalSeleccion) modalSeleccion.remove();
    
    // Guardar ndice para actualizar la ubicacin correcta
    if (!window._editandoUbicacion) window._editandoUbicacion = {};
    window._editandoUbicacion.repuestoId = repuestoId;
    window._editandoUbicacion.indice = indice;
    window._editandoUbicacion.modoEdicion = true;
    
    // Cambiar a tab de mapa
    this.switchTab('mapa');
    this.showToast(` Editando ubicacin... Cargando mapa`, 'info');
    
    // Cargar mapa y activar modo edicin
    setTimeout(() => {
      if (mapController && mapController.loadMap) {
        mapController.loadMap(ubicacion.mapId);
      }
      
      setTimeout(() => {
        // Hacer zoom al rea
        if (mapController && mapController.zoomToArea) {
          mapController.zoomToArea(ubicacion.areaId);
        }
        
        // Resaltar rea
        setTimeout(() => {
          if (mapController && mapController.flashArea) {
            mapController.flashArea(ubicacion.areaId, 3);
          } else if (mapController && mapController.highlightArea) {
            mapController.highlightArea(ubicacion.areaId);
          }
          
          // Activar modo marcador para reubicar
          if (mapController && mapController.activarModoMarcador) {
            mapController.activarModoMarcador(repuestoId, ubicacion.mapId, ubicacion.areaId, true); // true = modo edicin
          }
          
          setTimeout(() => {
            this.showToast(` Haz click en "${areaNombre}" para cambiar la posicin del marcador`, 'info', 6000);
          }, 1000);
        }, 600);
      }, 500);
    }, 300);
  }

  //  NUEVA FUNCIN: Eliminar ubicacin de repuesto
  async eliminarUbicacionRepuesto(repuestoId, indice) {
    const repuesto = this.repuestos.find(r => String(r.id) === String(repuestoId));
    if (!repuesto) return;
    
    let ubicaciones = repuesto.ubicaciones || [];
    if (ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
      ubicaciones = [{
        mapId: repuesto.mapId,
        areaId: repuesto.areaId,
        markerX: repuesto.markerX,
        markerY: repuesto.markerY
      }];
      repuesto.ubicaciones = ubicaciones;
      delete repuesto.mapId;
      delete repuesto.areaId;
      delete repuesto.markerX;
      delete repuesto.markerY;
    }
    
    if (indice < 0 || indice >= ubicaciones.length) return;
    
    const ubicacion = ubicaciones[indice];
    const area = mapStorage.areas.find(a => a.id === ubicacion.areaId);
    const areaNombre = area ? area.name : 'desconocida';
    
    const confirmacion = confirm(`Eliminar la ubicacin en "${areaNombre}"?\n\nEsta accin no se puede deshacer.`);
    
    if (!confirmacion) return;
    
    // Eliminar ubicacin del array
    ubicaciones.splice(indice, 1);
    
    // Si ya no quedan ubicaciones, eliminar el array
    if (ubicaciones.length === 0) {
      delete repuesto.ubicaciones;
    }
    
    // Guardar cambios
    try {
      await this.saveData();
      this.showToast(` Ubicacin eliminada de "${repuesto.nombre}"`, 'success');
      
      //  Refrescar modal de ubicaciones (o cerrar si ya no hay ubicaciones)
      this.refrescarModalUbicaciones(repuestoId);
      
      // Re-renderizar mapa para reflejar cambios
      if (mapController && mapController.draw) {
        mapController.draw();
      }
    } catch (error) {
      console.error('Error eliminando ubicacin:', error);
      this.showToast(' Error al eliminar ubicacin', 'error');
    }
  }

  //  NUEVA FUNCIN: Mostrar repuesto en mapa (cuando ya tiene ubicacin)
  mostrarRepuestoEnMapa(ubicacionConMapa, repuesto) {
    // Cambiar al tab de mapa
    this.switchTab('mapa');
    
    // Esperar a que el tab de mapa se active
    setTimeout(() => {
      // Verificar si mapController est disponible
      if (typeof mapController === 'undefined' || !mapController) {
        this.showToast(' Sistema de mapas no disponible', 'error');
        return;
      }
      
      // Cargar el mapa correspondiente
      if (mapController.loadMap) {
        mapController.loadMap(ubicacionConMapa.mapId);
      }
      
      // Esperar a que se cargue el mapa y luego resaltar el rea
      setTimeout(() => {
        // Resaltar el rea
        if (mapController.highlightArea) {
          mapController.highlightArea(ubicacionConMapa.areaId);
        }
        
        // Hacer zoom al rea
        if (mapController.zoomToArea) {
          mapController.zoomToArea(ubicacionConMapa.areaId);
        }
        
        // Animacin de pulsacin
        if (mapController.pulseArea) {
          mapController.pulseArea(ubicacionConMapa.areaId);
        }
        
        //  Si tiene marcador especfico, mostrarlo
        if (ubicacionConMapa.markerX && ubicacionConMapa.markerY && mapController.showMarker) {
          mapController.showMarker(ubicacionConMapa.markerX, ubicacionConMapa.markerY, repuesto.nombre);
        }
        
        this.showToast(` Ubicacin de "${repuesto.nombre}" mostrada en el mapa`, 'success');
      }, 500);
    }, 300);
  }

  //  NUEVA FUNCIN: Modal para asignar rea en mapa
  abrirModalAsignarAreaMapa(repuestoId, repuesto) {
    console.log(' Abrir modal de asignacin de rea para:', repuesto.nombre);
    
    // Verificar si hay mapas disponibles
    if (typeof mapStorage === 'undefined' || !mapStorage) {
      this.showToast(' Sistema de mapas no disponible', 'error');
      return;
    }
    
    const mapas = mapStorage.maps || [];
    if (!mapas || mapas.length === 0) {
      this.showToast(' No hay mapas creados. Crea un mapa primero en la pestaa "MAPA"', 'warning');
      return;
    }
    
    // Obtener todas las reas
    const todasLasAreas = mapStorage.areas || [];
    
    if (!todasLasAreas || todasLasAreas.length === 0) {
      this.showToast(' No hay reas creadas en los mapas. Dibuja reas primero en la pestaa "MAPA"', 'warning');
      return;
    }
    
    // Agrupar reas por mapa
    const areasPorMapa = {};
    todasLasAreas.forEach(area => {
      if (!areasPorMapa[area.mapId]) {
        const mapa = mapas.find(m => m.id === area.mapId);
        areasPorMapa[area.mapId] = {
          mapa: mapa,
          areas: []
        };
      }
      areasPorMapa[area.mapId].areas.push(area);
    });
    
    let opcionesHTML = '';
    Object.values(areasPorMapa).forEach(grupo => {
      opcionesHTML += `<optgroup label=" ${grupo.mapa.name}">`;
      grupo.areas.forEach(area => {
        const icono = mapController && mapController.categories && mapController.categories[area.category] 
          ? mapController.categories[area.category].icon 
          : '';
        opcionesHTML += `<option value="${area.mapId}|${area.id}">${icono} ${area.name}</option>`;
      });
      opcionesHTML += `</optgroup>`;
    });
    
    // Crear modal personalizado
    const modalHTML = `
      <div class="modal active" id="modalAsignarArea" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 600px;">
          <button class="modal-close" onclick="document.getElementById('modalAsignarArea').remove()"></button>
          <div class="modal-title"> Asignar ubicacin en mapa: ${repuesto.nombre}</div>
          
          <div style="padding: 20px;">
            <p style="margin-bottom: 20px; color: var(--text-secondary); line-height: 1.6;">
              Selecciona el rea donde se encuentra <strong>"${repuesto.nombre}"</strong>. 
              Luego podrs colocar un marcador en el lugar exacto dentro del rea.
            </p>
            
            <div class="form-group">
              <label style="font-weight: 600; margin-bottom: 8px; display: block;">rea del mapa:</label>
              <select id="areaMapaSelect" style="
                width: 100%;
                padding: 12px;
                font-size: 1rem;
                border: 2px solid var(--border);
                border-radius: 8px;
                background: var(--surface);
                color: var(--text);
              ">
                <option value="">-- Selecciona un rea --</option>
                ${opcionesHTML}
              </select>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button onclick="document.getElementById('modalAsignarArea').remove()" class="btn btn-secondary" style="flex: 1;">
                Cancelar
              </button>
              <button onclick="app.confirmarAsignacionArea('${repuestoId}')" class="btn btn-primary" style="flex: 1;">
                Siguiente: Colocar Marcador 
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Remover modal anterior si existe
    const modalAnterior = document.getElementById('modalAsignarArea');
    if (modalAnterior) modalAnterior.remove();
    
    // Agregar nuevo modal al body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  //  NUEVA FUNCIN: Confirmar rea y pasar a colocar marcador
  async confirmarAsignacionArea(repuestoId) {
    const select = document.getElementById('areaMapaSelect');
    const valor = select.value;
    
    if (!valor) {
      this.showToast(' Selecciona un rea', 'warning');
      return;
    }
    
    const [mapId, areaId] = valor.split('|').map(v => parseInt(v));
    
    // Obtener nombre del rea para el mensaje
    const area = mapStorage.areas.find(a => a.id === areaId);
    const areaName = area ? area.name : 'el rea seleccionada';
    
    // Cerrar modal personalizado
    const modalAsignar = document.getElementById('modalAsignarArea');
    if (modalAsignar) modalAsignar.remove();
    
    // Cambiar al tab de mapa
    this.switchTab('mapa');
    
    // Mostrar mensaje instructivo
    this.showToast(` Cargando mapa... Haz click DENTRO de "${areaName}" para marcar la ubicacin`, 'info', 6000);
    
    // Esperar y cargar el mapa
    setTimeout(() => {
      if (mapController && mapController.loadMap) {
        mapController.loadMap(mapId);
      }
      
      setTimeout(() => {
        // Hacer zoom PRIMERO (para que se vea bien el rea)
        if (mapController && mapController.zoomToArea) {
          mapController.zoomToArea(areaId);
        }
        
        // Despus de hacer zoom, hacer parpadear el rea para que sea MUY visible
        setTimeout(() => {
          if (mapController && mapController.flashArea) {
            mapController.flashArea(areaId, 3); // Parpadear 3 veces
          } else if (mapController && mapController.highlightArea) {
            mapController.highlightArea(areaId);
          }
          
          // Activar modo de colocacin de marcador
          if (mapController && mapController.activarModoMarcador) {
            mapController.activarModoMarcador(repuestoId, mapId, areaId);
          }
          
          // Mensaje final claro
          setTimeout(() => {
            this.showToast(` Haz click DENTRO del rea "${areaName}" (resaltada) para colocar el marcador`, 'info', 8000);
          }, 1500);
        }, 600);
      }, 500);
    }, 300);
  }

  selectTool(tool) {
    this.mapTool = tool;
    document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-tool="${tool}"]`)?.classList.add('active');
  }

  loadMapImage(event) {
    const file = event.target.files[0];
    if (!file) {
      console.log('No se seleccion archivo');
      return;
    }
    
    console.log('Cargando imagen de mapa:', file.name, file.size);
    this.showToast(' Cargando imagen...', 'info');
    
    const reader = new FileReader();
    reader.onerror = (e) => {
      console.error('Error leyendo archivo:', e);
      this.showToast(' Error al leer archivo', 'error');
    };
    reader.onload = (e) => {
      try {
        this.mapImage = e.target.result;
        localStorage.setItem('mapImage', this.mapImage);
        console.log('Imagen guardada, tamao:', this.mapImage.length);
        this.renderMap();
        this.showToast(' Imagen de mapa cargada', 'success');
      } catch (error) {
        console.error('Error guardando imagen:', error);
        this.showToast(' Error al guardar imagen', 'error');
      }
    };
    reader.readAsDataURL(file);
    
    // Limpiar el input para permitir recargar la misma imagen
    event.target.value = '';
  }

  handleMapClick(e) {
    const rect = this.canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    //  PRIORIDAD: Si estamos en modo marcador, colocar el marcador
    if (mapController && mapController.state && mapController.state.modoMarcador) {
      // Convertir coordenadas de pantalla a coordenadas del mapa
      const mapX = (x - mapController.state.offsetX) / mapController.state.scale;
      const mapY = (y - mapController.state.offsetY) / mapController.state.scale;
      mapController.colocarMarcador(mapX, mapY);
      return;
    }

    if (this.mapTool === 'rect') {
      const name = prompt('Nombre del rea:');
      if (name) {
        this.mapObjects.push({ type: 'rect', x, y, w: 150, h: 100, name });
        this.renderMap();
        this.saveMap();
      }
    } else if (this.mapTool === 'circle') {
      const name = prompt('Nombre del rea:');
      if (name) {
        this.mapObjects.push({ type: 'circle', x, y, r: 60, name });
        this.renderMap();
        this.saveMap();
      }
    } else if (this.mapTool === 'machine') {
      const name = prompt('Nombre de la mquina:');
      if (name) {
        this.mapObjects.push({ type: 'machine', x, y, name });
        this.renderMap();
        this.saveMap();
      }
    }
  }

  renderMap() {
    if (!this.ctx) {
      setTimeout(() => this.setupCanvas(), 100);
      return;
    }
    
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    
    // Fondo del canvas
    this.ctx.fillStyle = '#0f172a';
    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
    
    if (this.mapImage) {
      const img = new Image();
      img.onerror = () => {
        console.error('Error al cargar imagen del mapa');
        this.showToast(' Error al cargar imagen', 'error');
        this.drawMapObjects();
      };
      img.onload = () => {
        try {
          // Calcular proporcin para mantener aspecto
          const scale = Math.min(
            this.canvas.width / img.width,
            this.canvas.height / img.height
          );
          const x = (this.canvas.width - img.width * scale) / 2;
          const y = (this.canvas.height - img.height * scale) / 2;
          
          this.ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
          this.drawMapObjects();
        } catch (e) {
          console.error('Error dibujando imagen:', e);
          this.drawMapObjects();
        }
      };
      img.src = this.mapImage;
    } else {
      // Mostrar mensaje cuando no hay imagen
      this.ctx.fillStyle = '#94a3b8';
      this.ctx.font = '20px sans-serif';
      this.ctx.textAlign = 'center';
      this.ctx.fillText('Carga una imagen de fondo', this.canvas.width / 2, this.canvas.height / 2);
      this.drawMapObjects();
    }
  }

  drawMapObjects() {
    this.mapObjects.forEach(obj => {
      this.ctx.fillStyle = 'rgba(99, 102, 241, 0.3)';
      this.ctx.strokeStyle = '#6366f1';
      this.ctx.lineWidth = 3;

      if (obj.type === 'rect') {
        this.ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
        this.ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
      } else if (obj.type === 'circle') {
        this.ctx.beginPath();
        this.ctx.arc(obj.x, obj.y, obj.r, 0, Math.PI * 2);
        this.ctx.fill();
        this.ctx.stroke();
      } else if (obj.type === 'machine') {
        this.ctx.fillStyle = '#ef4444';
        this.ctx.fillRect(obj.x - 15, obj.y - 15, 30, 30);
      }

      this.ctx.fillStyle = '#1f2937';
      this.ctx.font = 'bold 14px sans-serif';
      this.ctx.fillText(obj.name, obj.x + 5, obj.y - 10);
    });
  }

  saveMap() {
    localStorage.setItem('mapData', JSON.stringify(this.mapObjects));
    this.showToast('Mapa guardado', 'success');
  }

  renderStats() {
    const total = this.repuestos.length;
    const sinStock = this.repuestos.filter(r => r.cantidad === 0).length;
    const bajoStock = this.repuestos.filter(r => r.cantidad > 0 && r.cantidad <= (r.minimo || r.stockMinimo || 5)).length;
    const stockOk = total - sinStock - bajoStock;
    const valorTotal = this.repuestos.reduce((sum, r) => sum + (r.precio * r.cantidad), 0);
    const valorPromedio = total > 0 ? valorTotal / total : 0;
    const conMultimedia = this.repuestos.filter(r => r.multimedia && r.multimedia.length > 0).length;
    const areas = new Set(this.repuestos.map(r => r.area)).size;
    const equipos = new Set(this.repuestos.map(r => r.equipo)).size;
    const tipos = new Set(this.repuestos.map(r => r.tipo).filter(t => t)).size;
    
    // Mtricas de salud
    const saludStock = total > 0 ? ((stockOk / total) * 100).toFixed(1) : 0;
    const cobertura = conMultimedia > 0 ? ((conMultimedia / total) * 100).toFixed(1) : 0;
    const criticidad = sinStock + bajoStock;
    const nivelAlerta = criticidad > total * 0.3 ? 'ALTO' : criticidad > total * 0.15 ? 'MEDIO' : 'BAJO';
    const colorAlerta = criticidad > total * 0.3 ? 'var(--danger)' : criticidad > total * 0.15 ? 'var(--warning)' : 'var(--success)';

    document.getElementById('statsGrid').innerHTML = `
      <div class="stats-card" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none;">
        <div class="stat-value">${total}</div>
        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Total Repuestos</div>
      </div>
      <div class="stats-card" style="border-left-color: var(--danger);">
        <div class="stat-value" style="color: var(--danger);">${sinStock}</div>
        <div class="stat-label">Sin Stock</div>
        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">${(sinStock/total*100).toFixed(1)}% del total</div>
      </div>
      <div class="stats-card" style="border-left-color: var(--warning);">
        <div class="stat-value" style="color: var(--warning);">${bajoStock}</div>
        <div class="stat-label">Stock Bajo</div>
        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">${(bajoStock/total*100).toFixed(1)}% del total</div>
      </div>
      <div class="stats-card" style="border-left-color: var(--success);">
        <div class="stat-value" style="color: var(--success);">${stockOk}</div>
        <div class="stat-label">Stock OK</div>
        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--success);">${saludStock}% saludable</div>
      </div>
      <div class="stats-card" style="border-left-color: ${colorAlerta};">
        <div class="stat-value" style="color: ${colorAlerta};">${nivelAlerta}</div>
        <div class="stat-label">Nivel de Alerta</div>
        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">${criticidad} crticos</div>
      </div>
      <div class="stats-card" style="border-left-color: var(--success);">
        <div class="stat-value" style="color: var(--success);">$${valorTotal.toLocaleString('es-ES', {minimumFractionDigits: 2})}</div>
        <div class="stat-label">Valor Inventario</div>
        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">
           Ver pestaa "Valores" para desglose
        </div>
      </div>
      <div class="stats-card" style="border-left-color: var(--info);">
        <div class="stat-value" style="color: var(--info);">${cobertura}%</div>
        <div class="stat-label">Cobertura Multimedia</div>
        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">${conMultimedia} de ${total}</div>
      </div>
      <div class="stats-card">
        <div class="stat-value">${areas + equipos + tipos}</div>
        <div class="stat-label">Clasificaciones</div>
        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">${areas} reas, ${equipos} equipos, ${tipos} tipos</div>
      </div>
    `;

    // Detalle por reas con grfico de barras
    const areaStats = {};
    this.repuestos.forEach(r => {
      if (!areaStats[r.area]) areaStats[r.area] = { total: 0, valor: 0, sinStock: 0, bajoStock: 0, ok: 0 };
      areaStats[r.area].total++;
      areaStats[r.area].valor += r.precio * r.cantidad;
      const minimo = r.minimo || r.stockMinimo || 5;
      if (r.cantidad === 0) areaStats[r.area].sinStock++;
      else if (r.cantidad <= minimo) areaStats[r.area].bajoStock++;
      else areaStats[r.area].ok++;
    });

    const bgCard = '#1e293b';
    const borderCard = '#334155';
    const bgSection = '#0f172a';
    const textPrimary = '#60a5fa';
    const textSecondary = '#cbd5e1';
    const borderAccent = '#3b82f6';
    
    let detailsHtml = `<div style="background: ${bgCard}; border: 1px solid ${borderCard}; padding: 24px; border-radius: 12px; box-shadow: var(--card-shadow); margin-top: 20px;">`;
    detailsHtml += `<h3 style="margin-bottom: 20px; color: ${textPrimary}; display: flex; align-items: center; gap: 10px;"><span style="font-size: 1.5rem;"></span> Dashboard por rea</h3>`;
    detailsHtml += '<div style="display: grid; gap: 16px;">';

    Object.keys(areaStats).sort().forEach(area => {
      const stats = areaStats[area];
      const porcOk = (stats.ok / stats.total * 100).toFixed(0);
      const porcBajo = (stats.bajoStock / stats.total * 100).toFixed(0);
      const porcCero = (stats.sinStock / stats.total * 100).toFixed(0);
      
      detailsHtml += `
        <div style="padding: 20px; background: ${bgSection}; border-radius: 12px; border-left: 4px solid ${borderAccent}; border: 1px solid ${borderCard};">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
              <strong style="color: ${textPrimary}; font-size: 1.1rem;">${area}</strong>
              <div style="font-size: 0.85rem; color: ${textSecondary}; margin-top: 4px;">
                ${stats.total} repuestos | Valor: $${stats.valor.toLocaleString('es-ES', {minimumFractionDigits: 2})}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 700; font-size: 1.2rem; color: ${textPrimary};">${porcOk}%</div>
              <div style="font-size: 0.75rem; color: ${textSecondary};">saludable</div>
            </div>
          </div>
          
          <div style="display: flex; gap: 2px; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 8px;">
            <div style="flex: ${stats.ok}; background: var(--success);" title="Stock OK: ${stats.ok}"></div>
            <div style="flex: ${stats.bajoStock}; background: var(--warning);" title="Stock Bajo: ${stats.bajoStock}"></div>
            <div style="flex: ${stats.sinStock}; background: var(--danger);" title="Sin Stock: ${stats.sinStock}"></div>
          </div>
          
          <div style="display: flex; gap: 16px; font-size: 0.85rem;">
            <span style="color: var(--success);">${stats.ok} OK</span>
            <span style="color: var(--warning);">${stats.bajoStock} Bajo</span>
            <span style="color: var(--danger);">${stats.sinStock} Sin stock</span>
          </div>
        </div>
      `;
    });

    detailsHtml += '</div></div>';
    document.getElementById('statsDetails').innerHTML = detailsHtml;
  }

  exportJSON() {
    if (this.repuestos.length === 0) {
      this.showToast(' No hay datos para exportar', 'warning');
      return;
    }

    try {
      const data = {
        repuestos: this.repuestos,
        mapa: this.mapObjects,
        fecha: new Date().toISOString(),
        version: '2.0'
      };

      console.log('Exportando JSON con', this.repuestos.length, 'repuestos');
      
      const jsonString = JSON.stringify(data, null, 2);
      const sizeInMB = (jsonString.length / (1024 * 1024)).toFixed(2);
      
      console.log('Tamao del archivo:', sizeInMB, 'MB');
      
      // Mostrar informacin sobre el tamao
      if (parseFloat(sizeInMB) > 10) {
        this.showToast(`Exportando archivo grande (${sizeInMB}MB)...`, 'info');
      }
      
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inventario_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      setTimeout(() => URL.revokeObjectURL(url), 100);

      this.showToast(`JSON exportado (${sizeInMB}MB)`, 'success');
      console.log('Exportacin completada:', sizeInMB, 'MB');
    } catch (error) {
      console.error('Error exportando JSON:', error);
      this.showToast(' Error al exportar: ' + error.message, 'error');
    }
  }

  exportJSONSinImagenes() {
    if (this.repuestos.length === 0) {
      this.showToast(' No hay datos para exportar', 'warning');
      return;
    }

    try {
      // Crear copia de repuestos SIN multimedia
      const repuestosSinImagenes = this.repuestos.map(r => ({
        id: r.id,
        codSAP: r.codSAP,
        codProv: r.codProv,
        tipo: r.tipo,
        nombre: r.nombre,
        area: r.area,
        equipo: r.equipo,
        cantidad: r.cantidad,
        minimo: r.minimo,
        precio: r.precio,
        multimedia: [] // Vaco - sin imgenes
      }));

      const data = {
        repuestos: repuestosSinImagenes,
        mapa: this.mapObjects,
        fecha: new Date().toISOString(),
        version: '2.0',
        nota: ' EXPORTACIN SIN IMGENES - Datos reducidos para navegador'
      };

      const jsonString = JSON.stringify(data, null, 2);
      const sizeInMB = (jsonString.length / (1024 * 1024)).toFixed(2);
      
      console.log('Exportando SIN imgenes:', sizeInMB, 'MB');
      
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inventario_SIN_IMAGENES_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      setTimeout(() => URL.revokeObjectURL(url), 100);

      this.showToast(` JSON sin imgenes exportado (${sizeInMB}MB) - ${this.repuestos.length} repuestos`, 'success', 6000);
      console.log(' Exportacin SIN imgenes completada:', sizeInMB, 'MB');
    } catch (error) {
      console.error('Error exportando JSON sin imgenes:', error);
      this.showToast(' Error al exportar: ' + error.message, 'error');
    }
  }

  importJSON(event) {
    const file = event.target.files[0];
    if (!file) {
      console.log('No se seleccion archivo para importar');
      return;
    }

    console.log('Importando archivo:', file.name, file.size);
    
    const fileSizeInMB = (file.size / (1024 * 1024)).toFixed(2);
    
    // Advertencia informativa pero no bloqueante
    if (fileSizeInMB > 50) {
      if (!confirm(`Archivo muy grande (${fileSizeInMB}MB).\n\n Esto podra tardar varios segundos.\n\n El sistema soporta archivos grandes.\n\nContinuar con la importacin?`)) {
        event.target.value = '';
        return;
      }
    } else if (fileSizeInMB > 10) {
      this.showToast(`Importando ${fileSizeInMB}MB - Puede tardar unos segundos...`, 'info');
    }

    this.showToast(' Importando datos...', 'info');
    
    const reader = new FileReader();
    reader.onerror = (e) => {
      console.error('Error leyendo archivo:', e);
      this.showToast(' Error al leer archivo', 'error');
      event.target.value = '';
    };
    reader.onload = (e) => {
      try {
        console.log('Parseando JSON...');
        const data = JSON.parse(e.target.result);
        
        let repuestosList = [];
        if (data.repuestos && Array.isArray(data.repuestos)) {
          repuestosList = data.repuestos;
          console.log('Formato: objeto con propiedad repuestos');
        } else if (Array.isArray(data)) {
          repuestosList = data;
          console.log('Formato: array directo');
        } else {
          console.error('Formato no reconocido:', typeof data);
          this.showToast(' Formato invlido', 'warning');
          event.target.value = '';
          return;
        }

        console.log('Repuestos encontrados:', repuestosList.length);

        if (!confirm(`Importar ${repuestosList.length} repuestos? Esto reemplazar los datos actuales.`)) {
          event.target.value = '';
          return;
        }

        this.repuestos = repuestosList.map((item, index) => {
          const repuesto = {
            id: item.id || `imported-${Date.now()}-${index}`,
            codSAP: item.codSAP || '',
            codProv: item.codProv || '',
            tipo: item.tipo || '',
            nombre: item.nombre || item.tipo || '',
            area: item.area || 'General',
            equipo: item.equipo || 'Sin equipo',
            cantidad: parseInt(item.cantidad) || 0,
            minimo: parseInt(item.minimo || item.stockMinimo) || 5,
            precio: parseFloat(item.precio) || 0,
            multimedia: item.multimedia || []
          };
          
          console.log(` Item ${index + 1}: ${repuesto.nombre} (ID: ${repuesto.id}, Multimedia: ${repuesto.multimedia.length})`);
          return repuesto;
        });

        if (data.mapa && Array.isArray(data.mapa)) {
          this.mapObjects = data.mapa;
          localStorage.setItem('mapData', JSON.stringify(this.mapObjects));
          console.log('Objetos de mapa importados:', this.mapObjects.length);
        }

        console.log('Guardando datos...');
        this.saveData();
        this.updateAutocompleteData();
        this.render();
        this.renderFilters();
        
        console.log('Importacin completada exitosamente');
        this.showToast(` ${this.repuestos.length} repuestos importados`, 'success');
      } catch (error) {
        console.error('Error durante importacin:', error);
        this.showToast(' Error al importar: ' + error.message, 'error');
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  }

  exportExcel() {
    if (this.repuestos.length === 0) {
      this.showToast(' No hay datos para exportar', 'warning');
      return;
    }

    try {
      console.log('Exportando Excel profesional con', this.repuestos.length, 'repuestos');
      
      // HOJA 1: INVENTARIO COMPLETO
      const inventarioData = this.repuestos.map(r => ({
        'Cdigo SAP': r.codSAP || '',
        ' Cdigo Proveedor': r.codProv || '',
        'Tipo': r.tipo || '',
        'Nombre': r.nombre || '',
        'rea': r.area || '',
        'Equipo': r.equipo || '',
        'Cantidad': r.cantidad || 0,
        ' Stock Mnimo': r.minimo || 5,
        'Precio Unitario': r.precio || 0,
        ' Valor Total': (r.precio || 0) * (r.cantidad || 0),
        ' Estado': r.cantidad === 0 ? 'SIN STOCK' : 
                     r.cantidad <= (r.minimo || 5) ? 'STOCK BAJO' : 'OK',
        ' Multimedia': (r.multimedia || []).length,
        'Documentos': (r.multimedia || []).filter(m => m.type === 'document').length
      }));

      // HOJA 2: RESUMEN Y ESTADSTICAS
      const sinStock = this.repuestos.filter(r => r.cantidad === 0).length;
      const stockBajo = this.repuestos.filter(r => r.cantidad > 0 && r.cantidad <= (r.minimo || 5)).length;
      const stockOk = this.repuestos.length - sinStock - stockBajo;
      const valorTotal = this.repuestos.reduce((sum, r) => sum + ((r.precio || 0) * (r.cantidad || 0)), 0);
      
      const resumenData = [
        { 'Indicador': 'Total Repuestos', 'Valor': this.repuestos.length },
        { 'Indicador': ' Stock OK', 'Valor': stockOk },
        { 'Indicador': ' Stock Bajo', 'Valor': stockBajo },
        { 'Indicador': ' Sin Stock', 'Valor': sinStock },
        { 'Indicador': '', 'Valor': '' },
        { 'Indicador': 'Valor Total Inventario', 'Valor': `$${valorTotal.toFixed(2)}` },
        { 'Indicador': 'Valor Promedio por Repuesto', 'Valor': `$${(valorTotal / this.repuestos.length).toFixed(2)}` },
        { 'Indicador': '', 'Valor': '' },
        { 'Indicador': ' Fecha de Exportacin', 'Valor': new Date().toLocaleDateString('es-ES', { 
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
          hour: '2-digit', minute: '2-digit' 
        }) }
      ];

      //  HOJA 3: REPUESTOS POR REA
      const areaStats = {};
      this.repuestos.forEach(r => {
        if (!areaStats[r.area]) {
          areaStats[r.area] = { cantidad: 0, valor: 0, sinStock: 0 };
        }
        areaStats[r.area].cantidad++;
        areaStats[r.area].valor += (r.precio || 0) * (r.cantidad || 0);
        if (r.cantidad === 0) areaStats[r.area].sinStock++;
      });
      
      const areaData = Object.entries(areaStats).map(([area, stats]) => ({
        'rea': area,
        'Total Repuestos': stats.cantidad,
        ' Sin Stock': stats.sinStock,
        'Valor Total': `$${stats.valor.toFixed(2)}`
      }));

      // HOJA 4: REPUESTOS POR EQUIPO
      const equipoStats = {};
      this.repuestos.forEach(r => {
        if (!equipoStats[r.equipo]) {
          equipoStats[r.equipo] = { cantidad: 0, valor: 0, stockBajo: 0 };
        }
        equipoStats[r.equipo].cantidad++;
        equipoStats[r.equipo].valor += (r.precio || 0) * (r.cantidad || 0);
        if (r.cantidad <= (r.minimo || 5)) equipoStats[r.equipo].stockBajo++;
      });
      
      const equipoData = Object.entries(equipoStats).map(([equipo, stats]) => ({
        'Equipo': equipo,
        'Total Repuestos': stats.cantidad,
        ' Stock Bajo/Sin Stock': stats.stockBajo,
        'Valor Total': `$${stats.valor.toFixed(2)}`
      }));

      //  HOJA 5: ALERTAS (Sin Stock y Stock Bajo)
      const alertasData = this.repuestos
        .filter(r => r.cantidad <= (r.minimo || 5))
        .map(r => ({
          ' Prioridad': r.cantidad === 0 ? 'CRTICA' : 'MEDIA',
          'Cdigo SAP': r.codSAP || '',
          'Nombre': r.nombre,
          'Stock Actual': r.cantidad,
          ' Stock Mnimo': r.minimo || 5,
          ' Dficit': (r.minimo || 5) - r.cantidad,
          'rea': r.area,
          'Equipo': r.equipo
        }))
        .sort((a, b) => a['Stock Actual'] - b['Stock Actual']);

      //  CREAR LIBRO DE EXCEL
      const wb = XLSX.utils.book_new();
      
      // Agregar hojas
      const ws1 = XLSX.utils.json_to_sheet(inventarioData);
      const ws2 = XLSX.utils.json_to_sheet(resumenData);
      const ws3 = XLSX.utils.json_to_sheet(areaData);
      const ws4 = XLSX.utils.json_to_sheet(equipoData);
      const ws5 = XLSX.utils.json_to_sheet(alertasData);
      
      // Configurar anchos de columnas
      ws1['!cols'] = [
        { wch: 15 }, { wch: 18 }, { wch: 15 }, { wch: 30 }, { wch: 15 },
        { wch: 20 }, { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 12 },
        { wch: 12 }, { wch: 10 }, { wch: 10 }
      ];
      ws2['!cols'] = [{ wch: 35 }, { wch: 25 }];
      ws3['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 12 }, { wch: 15 }];
      ws4['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 20 }, { wch: 15 }];
      ws5['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 30 }, { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 20 }];
      
      //  HOJA 6: ESTADO DEL STOCK (Grfico Circular)
      const grafEstadoStock = [
        { 'Categora': 'Stock OK', 'Cantidad': stockOk, 'Porcentaje': parseFloat(((stockOk / this.repuestos.length) * 100).toFixed(1)) },
        { 'Categora': 'Stock Bajo', 'Cantidad': stockBajo, 'Porcentaje': parseFloat(((stockBajo / this.repuestos.length) * 100).toFixed(1)) },
        { 'Categora': 'Sin Stock', 'Cantidad': sinStock, 'Porcentaje': parseFloat(((sinStock / this.repuestos.length) * 100).toFixed(1)) }
      ];
      
      const ws6 = XLSX.utils.json_to_sheet(grafEstadoStock);
      ws6['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 12 }];
      
      //  HOJA 7: TOP REAS (Grfico de Barras)
      const topAreas = Object.entries(areaStats)
        .sort((a, b) => b[1].cantidad - a[1].cantidad)
        .slice(0, 10)
        .map(([area, stats]) => ({
          'rea': area,
          'Total Repuestos': stats.cantidad,
          'Sin Stock': stats.sinStock,
          'Valor': parseFloat(stats.valor.toFixed(2))
        }));
      
      const ws7 = XLSX.utils.json_to_sheet(topAreas);
      ws7['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 12 }, { wch: 15 }];
      
      //  HOJA 8: TOP EQUIPOS (Grfico de Barras Horizontal)
      const topEquipos = Object.entries(equipoStats)
        .sort((a, b) => b[1].valor - a[1].valor)
        .slice(0, 10)
        .map(([equipo, stats]) => ({
          'Equipo': equipo,
          'Valor Total': parseFloat(stats.valor.toFixed(2)),
          'Cantidad': stats.cantidad,
          'Alertas': stats.stockBajo
        }));
      
      const ws8 = XLSX.utils.json_to_sheet(topEquipos);
      ws8['!cols'] = [{ wch: 30 }, { wch: 15 }, { wch: 12 }, { wch: 12 }];
      
      //  HOJA 9: DISTRIBUCIN POR TIPO (Grfico Circular)
      const tipoStats = {};
      this.repuestos.forEach(r => {
        const tipo = r.tipo || 'Sin Tipo';
        if (!tipoStats[tipo]) {
          tipoStats[tipo] = { cantidad: 0, valor: 0 };
        }
        tipoStats[tipo].cantidad++;
        tipoStats[tipo].valor += (r.precio || 0) * (r.cantidad || 0);
      });
      
      const grafTipos = Object.entries(tipoStats)
        .sort((a, b) => b[1].cantidad - a[1].cantidad)
        .map(([tipo, stats]) => ({
          'Tipo': tipo,
          'Cantidad': stats.cantidad,
          'Porcentaje': parseFloat(((stats.cantidad / this.repuestos.length) * 100).toFixed(1)),
          'Valor': parseFloat(stats.valor.toFixed(2))
        }));
      
      const ws9 = XLSX.utils.json_to_sheet(grafTipos);
      ws9['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 15 }];
      
      //  HOJA 10: TOP REPUESTOS MS VALIOSOS (Grfico de Barras)
      const topValiosos = this.repuestos
        .map(r => ({
          nombre: r.nombre,
          codSAP: r.codSAP || '',
          valor: (r.precio || 0) * (r.cantidad || 0),
          cantidad: r.cantidad,
          precio: r.precio || 0
        }))
        .filter(r => r.valor > 0) // Solo los que tienen valor
        .sort((a, b) => b.valor - a.valor)
        .slice(0, 15)
        .map(r => ({
          'Repuesto': r.nombre.substring(0, 35),
          'Cdigo SAP': r.codSAP,
          'Valor Total': parseFloat(r.valor.toFixed(2)),
          'Cantidad': r.cantidad,
          'Precio Unit': parseFloat(r.precio.toFixed(2))
        }));
      
      const ws10 = XLSX.utils.json_to_sheet(topValiosos);
      ws10['!cols'] = [{ wch: 35 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 12 }];
      
      XLSX.utils.book_append_sheet(wb, ws1, 'Inventario');
      XLSX.utils.book_append_sheet(wb, ws2, 'Resumen');
      XLSX.utils.book_append_sheet(wb, ws3, ' Por rea');
      XLSX.utils.book_append_sheet(wb, ws4, 'Por Equipo');
      XLSX.utils.book_append_sheet(wb, ws5, ' Alertas');
      XLSX.utils.book_append_sheet(wb, ws6, ' Graf-Estado Stock');
      XLSX.utils.book_append_sheet(wb, ws7, ' Graf-Top reas');
      XLSX.utils.book_append_sheet(wb, ws8, ' Graf-Top Equipos');
      XLSX.utils.book_append_sheet(wb, ws9, ' Graf-Por Tipo');
      XLSX.utils.book_append_sheet(wb, ws10, ' Graf-Top Valiosos');
      
      // Generar archivo
      const fechaHora = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
      const filename = `Inventario_${fechaHora}.xlsx`;
      
      XLSX.writeFile(wb, filename);
      
      this.showToast(` Excel exportado con 10 hojas: ${filename}`, 'success', 4000);
      console.log(' Exportacin Excel completada:', filename);
      console.log(`   Inventario: ${inventarioData.length} repuestos`);
      console.log(`   Resumen: KPIs generales`);
      console.log(`    Por rea: ${areaData.length} reas`);
      console.log(`   Por Equipo: ${equipoData.length} equipos`);
      console.log(`    Alertas: ${alertasData.length} alertas`);
      console.log(`    Grficos: 5 hojas listas para visualizar`);
      
    } catch (error) {
      console.error(' Error exportando Excel:', error);
      this.showToast(' Error al exportar: ' + error.message, 'error');
    }
  }

  togglePrecio() {
    const btn = document.getElementById('togglePrecioBtn');
    this.showPrecio = !this.showPrecio;
    
    if (this.showPrecio) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
    
    this.render();
  }

  toggleView(btn, view) {
    // Remover active de todos los botones del toggle
    const parent = btn.parentElement;
    parent.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // Cambiar vista
    this.currentView = view;
    console.log('Vista cambiada a:', view);
    this.render();
  }

  updateConnectionStatus() {
    const btn = document.getElementById('connectionBtn');
    if (!btn) return;

    // Detectar si está en modo FileSystem
    const isConnected = fsManager && fsManager.isFileSystemMode;
    
    if (isConnected) {
      btn.classList.remove('disconnected');
      btn.classList.add('connected');
      btn.textContent = 'Conectado';
    } else {
      btn.classList.remove('connected');
      btn.classList.add('disconnected');
      btn.textContent = 'Desconectado';
    }
  }

  startConnectionMonitoring() {
    // Actualizar estado inicial
    this.updateConnectionStatus();
    
    // Monitorear cambios cada 2 segundos
    setInterval(() => {
      this.updateConnectionStatus();
    }, 2000);
  }

  showStorageInfo() {
    const dataString = JSON.stringify(this.repuestos);
    const sizeInMB = (dataString.length / (1024 * 1024)).toFixed(2);
    const totalImages = this.repuestos.reduce((sum, r) => sum + (r.multimedia ? r.multimedia.filter(m => m.type === 'image').length : 0), 0);
    const totalDocs = this.repuestos.reduce((sum, r) => sum + (r.multimedia ? r.multimedia.filter(m => m.type === 'document').length : 0), 0);
    
    // Detectar si est en modo FileSystem
    const isFileSystemMode = fsManager && fsManager.isFileSystemMode;
    
    const bgCard = '#1e293b';
    const textColor = '#f8fafc';
    const borderColor = '#334155';
    const bgSection = '#0f172a';
    const textSecondary = '#cbd5e1';
    
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
    
    modal.innerHTML = `
      <div style="background: ${bgCard}; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 32px; border: 2px solid ${borderColor};">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="color: #60a5fa; margin: 0;">Informacin de Almacenamiento</h2>
          <button onclick="this.closest('div[style*=fixed]').remove()" style="background: #334155; border: none; font-size: 1.5rem; cursor: pointer; color: ${textColor}; width: 36px; height: 36px; border-radius: 8px; transition: all 0.2s;"></button>
        </div>
        
        ${isFileSystemMode ? `
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);">
          <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 2rem;"></span> MODO CARPETA ACTIVO
          </div>
          <div style="font-size: 0.95rem; opacity: 0.95;"> Carpeta: ${fsManager.folderPath || 'Conectada'}</div>
          <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 6px;"> Capacidad ilimitada | Datos en disco</div>
        </div>
        
        <div style="background: ${bgSection}; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #10b981;">
          <div style="font-size: 1.2rem; font-weight: 600; color: ${textColor}; margin-bottom: 4px;">Solo Metadata en Memoria</div>
          <div style="font-size: 2rem; font-weight: 700; color: #10b981;">${sizeInMB} MB</div>
          <div style="color: ${textSecondary}; font-size: 0.85rem; margin-top: 4px;">Las imgenes NO cuentan para este tamao</div>
        </div>
        ` : `
        <div style="background: ${bgSection}; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
          <div style="font-size: 2.5rem; font-weight: 700; color: #60a5fa; margin-bottom: 8px;">${sizeInMB} MB</div>
          <div style="color: ${textColor}; font-size: 1.1rem; font-weight: 600;">Tamao en LocalStorage</div>
          <div style="color: ${textSecondary}; font-size: 0.85rem; margin-top: 4px;"> Lmite: ~10MB | Incluye imgenes en base64</div>
        </div>
        `}
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div style="background: ${bgSection}; padding: 16px; border-radius: 12px; text-align: center; border: 1px solid ${borderColor};">
            <div style="font-size: 1.8rem; font-weight: 700; color: #60a5fa;">${this.repuestos.length}</div>
            <div style="color: ${textColor}; font-size: 0.9rem; margin-top: 4px;">Repuestos</div>
          </div>
          <div style="background: ${bgSection}; padding: 16px; border-radius: 12px; text-align: center; border: 1px solid ${borderColor};">
            <div style="font-size: 1.8rem; font-weight: 700; color: #22d3ee;">${totalImages}</div>
            <div style="color: ${textColor}; font-size: 0.9rem; margin-top: 4px;">Imgenes</div>
          </div>
          <div style="background: ${bgSection}; padding: 16px; border-radius: 12px; text-align: center; border: 1px solid ${borderColor};">
            <div style="font-size: 1.8rem; font-weight: 700; color: #fbbf24;">${totalDocs}</div>
            <div style="color: ${textColor}; font-size: 0.9rem; margin-top: 4px;">Documentos</div>
          </div>
        </div>
        
        ${isFileSystemMode ? `
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;"> MODO CARPETA - SIN LMITES</div>
          <div style="font-size: 0.95rem; line-height: 1.6;">
             <strong>Capacidad ilimitada:</strong> 1,000+ imgenes sin problema<br>
             <strong>Almacenamiento:</strong> inventario.json + carpeta imagenes/<br>
            <strong>Portable:</strong> Copia la carpeta completa a otro PC<br>
            <strong>Imgenes:</strong> Archivos WebP en disco (no en memoria)<br>
             <strong>Sin lmites:</strong> Solo depende del espacio en disco
          </div>
        </div>
        
        <div style="background: var(--info); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;">Cmo llevar tu inventario a otro PC?</div>
          <div style="font-size: 0.95rem; line-height: 1.6;">
            <strong>1.</strong> Copia la carpeta completa donde seleccionaste guardar<br>
            <strong>2.</strong> Llvala a otro PC (USB, nube, red)<br>
            <strong>3.</strong> Abre este HTML y activa "Modo Carpeta"<br>
            <strong>4.</strong> Selecciona la carpeta copiada<br>
            <strong>5.</strong> Listo! Todo tu inventario estar disponible
          </div>
        </div>
        ` : `
        <div style="background: var(--info); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;">INFO Lmites del Sistema</div>
          <div style="font-size: 0.95rem; line-height: 1.6;">
             LocalStorage: ~5-10MB segn navegador<br>
             Archivos JSON: Sin lmite (exportar/importar)<br>
             <strong>Imgenes: Formato WebP</strong> (mejor que JPEG)<br>
             Compresin inteligente: 800px, calidad 85%, ~100KB<br>
             Sistema optimizado para 500+ repuestos con fotos
          </div>
        </div>
        
        <div style="background: var(--success); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;"> Tecnologa de Compresin</div>
          <div style="font-size: 0.95rem; line-height: 1.6;">
            <strong>WebP:</strong> 30% ms ligero que JPEG con mejor calidad<br>
            <strong>Fallback:</strong> JPEG de alta calidad si WebP no disponible<br>
            <strong>Optimizacin:</strong> 800px mx, calidad adaptativa 85-50%<br>
            <strong>Resultado:</strong> Imgenes ntidas de ~100KB<br>
            <strong>Reduccin tpica:</strong> 80-95% del tamao original
          </div>
        </div>
        
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;"> Muchas imgenes? Activa MODO CARPETA</div>
          <div style="font-size: 0.95rem; line-height: 1.6;">
            Click en <strong>" Modo Carpeta"</strong> (esquina inferior derecha)<br>
             Capacidad ILIMITADA | Portable | Sin lmites de 10MB
          </div>
        </div>
        `}
        
        <div style="background: var(--warning); color: white; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;"> Tip Profesional</div>
          <div style="font-size: 0.95rem; line-height: 1.6;">
            <strong>Para archivos muy grandes (>50MB):</strong><br>
             El sistema los soporta sin problemas<br>
             La importacin puede tardar 5-10 segundos<br>
             Todo se mantiene embebido en el HTML+JSON<br>
             Puedes tener cientos de fotos sin problema<br>
             Solo el LocalStorage temporal tiene lmite
          </div>
        </div>
        
        <div style="display: flex; gap: 12px;">
          <button onclick="app.exportJSON(); this.closest('div[style*=fixed]').remove();" style="flex: 1; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
            Exportar Ahora
          </button>
          <button onclick="this.closest('div[style*=fixed]').remove();" style="flex: 1; padding: 14px; background: #334155; color: ${textColor}; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.2s;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#334155'">
            Cerrar
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  }

  diagnosticIDs() {
    console.log('\n========== DIAGNSTICO DE IDs ==========');
    console.log(`Total de repuestos: ${this.repuestos.length}\n`);
    
    const problemas = [];
    const idsMap = new Map();
    
    this.repuestos.forEach((r, index) => {
      const idInfo = {
        index: index,
        id: r.id,
        tipo: typeof r.id,
        nombre: r.nombre || 'Sin nombre',
        codSAP: r.codSAP || 'Sin cdigo',
        multimedia: r.multimedia?.length || 0
      };
      
      console.log(`[${index}] ID: "${r.id}" (${typeof r.id})`);
      console.log(`     ${r.codSAP} - ${r.nombre}`);
      console.log(`     Multimedia: ${r.multimedia?.length || 0} items`);
      
      // Detectar problemas
      if (!r.id) {
        problemas.push(` Repuesto ${index} sin ID: ${r.nombre}`);
      } else if (r.id === 'undefined' || r.id === 'null') {
        problemas.push(` Repuesto ${index} con ID invlido: ${r.id}`);
      } else if (idsMap.has(r.id)) {
        problemas.push(` ID duplicado "${r.id}": ndices ${idsMap.get(r.id)} y ${index}`);
      }
      
      idsMap.set(r.id, index);
    });
    
    console.log('\nRESUMEN:');
    console.log(` IDs nicos: ${idsMap.size}`);
    console.log(`Total repuestos: ${this.repuestos.length}`);
    console.log(` Problemas encontrados: ${problemas.length}`);
    
    if (problemas.length > 0) {
      console.log('\n PROBLEMAS DETECTADOS:');
      problemas.forEach(p => console.log(p));
      
      const fixear = confirm(`Se encontraron ${problemas.length} problema(s) con los IDs.\n\nQuieres regenerar todos los IDs automticamente?\n\n(Esto solucionar los problemas pero cambiar los IDs)`);
      
      if (fixear) {
        console.log('\nRegenerando IDs...');
        this.repuestos = this.repuestos.map((r, i) => {
          const oldId = r.id;
          r.id = `repuesto-${Date.now()}-${i}`;
          console.log(`  "${oldId}"  "${r.id}"`);
          return r;
        });
        
        this.saveData();
        this.render();
        this.showToast(' IDs regenerados correctamente', 'success');
        console.log(' IDs regenerados y guardados');
      }
    } else {
      console.log(' No se encontraron problemas');
      this.showToast(' Todos los IDs estn correctos', 'success');
    }
    
    console.log('========== FIN DIAGNSTICO ==========\n');
  }

  showExportMenu() {
    const menu = document.createElement('div');
    menu.style.cssText = 'position: fixed; top: 80px; right: 20px; background: var(--bg-secondary); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.5), 0 0 20px rgba(59, 130, 246, 0.3); padding: 8px; z-index: 10000; min-width: 220px; border: 1px solid var(--border-color);';
    
    const btnStyle = `width: 100%; padding: 12px; background: transparent; border: none; text-align: left; cursor: pointer; border-radius: 8px; font-weight: 600; color: var(--text-primary); transition: all 0.2s;`;
    const hoverBg = 'var(--bg-tertiary)';
    
    // Mostrar opcin de limpieza solo si FileSystem est activo
    const cleanBtn = fsManager.isFileSystemMode ? `
      <div style="border-top: 1px solid var(--border-color); margin: 4px 0; padding-top: 4px;">
        <button onclick="app.cleanOrphanImages(); this.parentElement.parentElement.remove();" style="${btnStyle} color: #f59e0b;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">
           Limpiar Imgenes Hurfanas
        </button>
      </div>
    ` : '';
    
    menu.innerHTML = `
      <button onclick="app.exportJSON(); this.parentElement.remove();" style="${btnStyle}" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">
         Exportar JSON
      </button>
      <button onclick="app.exportExcel(); this.parentElement.remove();" style="${btnStyle}" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='transparent'">
         Exportar Excel
      </button>
      ${cleanBtn}
    `;
    
    document.body.appendChild(menu);
    
    setTimeout(() => {
      document.addEventListener('click', function closeMenu(e) {
        if (!menu.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', closeMenu);
        }
      });
    }, 100);
  }

  async cleanOrphanImages() {
    if (!fsManager.isFileSystemMode) {
      this.showToast(' Funcin solo disponible en modo FileSystem', 'warning');
      return;
    }
    
    const confirm1 = confirm(
      ' Limpieza de Imgenes Hurfanas\n\n' +
      'Esta funcin buscar y eliminar imgenes que estn en la carpeta\n' +
      'pero que ya no estn vinculadas a ningn producto.\n\n' +
      ' Esta accin NO se puede deshacer.\n\n' +
      'Deseas continuar?'
    );
    
    if (!confirm1) return;
    
    this.showToast(' Analizando carpeta de imgenes...', 'info', 3000);
    
    try {
      const result = await fsManager.cleanOrphanImages(this.repuestos);
      
      if (result.orphans === 0) {
        this.showToast(' No se encontraron imgenes hurfanas. Carpeta limpia.', 'success', 5000);
        return;
      }
      
      const sizeMB = (result.size / 1024 / 1024).toFixed(2);
      
      const message = 
        ` Limpieza completada:\n\n` +
        ` Imgenes hurfanas: ${result.orphans}\n` +
        ` Eliminadas exitosamente: ${result.deleted}\n` +
        ` Errores: ${result.failed}\n` +
        ` Espacio liberado: ${sizeMB} MB\n\n` +
        ` Tu carpeta est ms limpia y optimizada.`;
      
      alert(message);
      this.showToast(` ${result.deleted} imgenes hurfanas eliminadas (${sizeMB} MB liberados)`, 'success', 6000);
      
    } catch (error) {
      console.error('Error en limpieza:', error);
      this.showToast(' Error durante la limpieza: ' + error.message, 'error');
    }
  }

  showToast(msg, type = 'info', customDuration = null) {
    //  INTERCEPTAR Y REDIRIGIR A CAMPANA SEGN IMPORTANCIA
    
    // Lista de mensajes que van SOLO a la campana (sin toast emergente)
    const campanaOnly = [
      'Carpeta conectada',
      'Carpeta reconectada', 
      'Modo Carpeta DESACTIVADO',
      'Repuesto actualizado',
      'Jerarqua actualizada',
      'Modo edicin',
      'Posicin actualizada',
      'Filtro limpiado',
      'datos cargados'
    ];
    
    const shouldGoToCampana = campanaOnly.some(keyword => msg.includes(keyword));
    
    if (shouldGoToCampana) {
      // Solo a la campana, sin toast emergente
      console.log(' Redirigiendo a campana (sin toast):', msg);
      if (typeof window.addNotificationToCampana === 'function') {
        window.addNotificationToCampana(msg, type);
      }
      return null; // No crear toast visual
    } else {
      // Mensajes menos importantes: Pueden seguir siendo toasts normales
      console.log(` Toast normal permitido: [${type.toUpperCase()}] ${msg}`);
      // Aqu puedes decidir si permitir algunos toasts o enviar todo a campana
      
      // Por ahora, enviar todo a campana para limpieza total
      if (typeof window.addNotificationToCampana === 'function') {
        window.addNotificationToCampana(msg, type);
      }
      return null; // No crear elementos visuales
    }
  }

  //  SISTEMA DE NOTIFICACIONES PERSISTENTE - IMPLEMENTACION ROTA (DESHABILITADA)
  initNotificationSystem_ROTO() {
    // Esta funcin se llama desde el constructor
    // La implementacin real est ms abajo en el cdigo
    return;
  }

  //  FORZAR INICIALIZACIN CORRECTA DEL SISTEMA
  initNotificationSystem() {
    console.log(' FORZANDO INICIALIZACIN...');
    
    // CREAR FUNCIN GLOBAL SIMPLE QUE FUNCIONE S O S
    window.toggleCampana = function() {
      console.log(' FUNCIN GLOBAL EJECUTADA!');
      
      const panel = document.getElementById('notificationPanel');
      if (!panel) {
        console.error(' Panel no encontrado');
        return;
      }
      
      if (panel.classList.contains('active')) {
        panel.classList.remove('active');
        console.log(' Panel CERRADO');
      } else {
        panel.classList.add('active');
        console.log(' Panel ABIERTO');
      }
    };
    
    // Tambin configurar click fuera
    document.addEventListener('click', function(e) {
      const panel = document.getElementById('notificationPanel');
      const bell = document.getElementById('notificationBell');
      
      if (panel && bell && !panel.contains(e.target) && !bell.contains(e.target)) {
        if (panel.classList.contains('active')) {
          panel.classList.remove('active');
          console.log(' Panel cerrado por click fuera');
        }
      }
    });
    
    console.log(' Funcin global window.toggleCampana() creada');
    console.log(' Sistema sper simple listo');
  }

  //  DIAGNSTICO COMPLETO DEL SISTEMA DE CAMPANA
  diagnosticoCampana() {
    console.log(' === DIAGNSTICO COMPLETO DE CAMPANA ===');
    
    // 1. Verificar elementos HTML
    const bell = document.getElementById('notificationBell');
    const panel = document.getElementById('notificationPanel');
    
    console.log(' 1. ELEMENTOS HTML:');
    console.log('Bell encontrada:', !!bell, bell);
    console.log('Panel encontrado:', !!panel, panel);
    
    if (!bell || !panel) {
      console.error(' ELEMENTOS NO ENCONTRADOS - Sistema no puede funcionar');
      return;
    }
    
    // 2. Verificar propiedades de la app
    console.log(' 2. PROPIEDADES APP:');
    console.log('this.notificationBell:', !!this.notificationBell, this.notificationBell);
    console.log('this.notificationPanel:', !!this.notificationPanel, this.notificationPanel);
    console.log('this.notifications:', this.notifications);
    
    // 3. Verificar event listeners
    console.log(' 3. EVENT LISTENERS:');
    const events = getEventListeners ? getEventListeners(bell) : 'No disponible en esta consola';
    console.log('Event listeners en campana:', events);
    
    // 4. Verificar CSS
    console.log(' 4. CSS STYLES:');
    const bellStyle = window.getComputedStyle(bell);
    const panelStyle = window.getComputedStyle(panel);
    console.log('Bell display:', bellStyle.display);
    console.log('Bell visibility:', bellStyle.visibility);
    console.log('Panel display:', panelStyle.display);
    console.log('Panel opacity:', panelStyle.opacity);
    
    // 5. Test manual de toggle
    console.log(' 5. TEST MANUAL:');
    console.log('Intentando toggle manual...');
    
    try {
      if (panel.classList.contains('active')) {
        panel.classList.remove('active');
        console.log(' Panel cerrado manualmente');
      } else {
        panel.classList.add('active');
        console.log(' Panel abierto manualmente');
      }
    } catch (error) {
      console.error(' Error en toggle manual:', error);
    }
    
    // 6. Aadir listener temporal
    console.log(' 6. LISTENER TEMPORAL:');
    bell.addEventListener('click', function tempListener(e) {
      console.log(' CLICK TEMPORAL DETECTADO!', e);
      bell.removeEventListener('click', tempListener);
    });
    
    console.log(' === FIN DIAGNSTICO ===');
    console.log(' Ahora haz click en la campana para ver si el listener temporal funciona');
  }

  //  TOAST HUB - Sistema de gestin centralizada
  initializeToastHub() {
    if (this.toastHubHistory) return; // Ya inicializado
    
    this.toastHubHistory = [];
    this.createToastHubElements();
  }

  createToastHubElements() {
    // Crear overlay
    const overlay = document.createElement('div');
    overlay.className = 'toast-hub-overlay';
    overlay.addEventListener('click', () => this.closeToastHub());
    document.body.appendChild(overlay);
    
    // Crear hub principal
    const hub = document.createElement('div');
    hub.className = 'toast-hub';
    hub.innerHTML = `
      <div class="toast-hub-header">
        <h3 class="toast-hub-title">
           Notificaciones
          <span class="toast-hub-counter">0</span>
        </h3>
        <button class="toast-hub-close" onclick="app.closeToastHub()"></button>
      </div>
      <div class="toast-hub-content" id="toastHubContent">
        <div style="text-align: center; padding: 40px 20px; color: #64748b;">
          No hay notificaciones
        </div>
      </div>
    `;
    document.body.appendChild(hub);
    
    // Crear botn flotante
    const trigger = document.createElement('button');
    trigger.className = 'toast-hub-trigger';
    trigger.innerHTML = `
      
      <span class="toast-hub-trigger-badge">0</span>
    `;
    trigger.addEventListener('click', () => this.openToastHub());
    document.body.appendChild(trigger);
    
    this.toastHubElements = {
      overlay,
      hub,
      trigger,
      content: hub.querySelector('#toastHubContent'),
      counter: hub.querySelector('.toast-hub-counter'),
      badge: trigger.querySelector('.toast-hub-trigger-badge')
    };
  }

  addToToastHub(msg, type) {
    this.initializeToastHub();
    
    const timestamp = new Date();
    const toastItem = {
      id: Date.now() + Math.random(),
      message: msg,
      type: type,
      timestamp: timestamp,
      timeString: timestamp.toLocaleTimeString('es-ES', { 
        hour: '2-digit', 
        minute: '2-digit' 
      })
    };
    
    this.toastHubHistory.unshift(toastItem); // Agregar al inicio
    
    // Limitar historial a 20 elementos
    if (this.toastHubHistory.length > 20) {
      this.toastHubHistory = this.toastHubHistory.slice(0, 20);
    }
    
    this.updateToastHubTrigger();
  }

  updateToastHubTrigger() {
    if (!this.toastHubElements) return;
    
    const count = this.toastHubHistory.length;
    const activeToasts = document.querySelectorAll('.toast').length;
    
    if (count > 0 || activeToasts >= 3) {
      this.toastHubElements.trigger.classList.add('active');
      this.toastHubElements.badge.textContent = count;
      this.toastHubElements.counter.textContent = count;
    } else {
      this.toastHubElements.trigger.classList.remove('active');
    }
  }

  openToastHub() {
    this.initializeToastHub();
    
    // Pausar todos los toasts activos
    document.querySelectorAll('.toast').forEach(toast => {
      toast.style.animationPlayState = 'paused';
    });
    
    this.renderToastHubContent();
    this.toastHubElements.overlay.classList.add('active');
    this.toastHubElements.hub.classList.add('active');
  }

  closeToastHub() {
    if (!this.toastHubElements) return;
    
    // Reanudar todos los toasts activos
    document.querySelectorAll('.toast').forEach(toast => {
      toast.style.animationPlayState = 'running';
    });
    
    this.toastHubElements.overlay.classList.remove('active');
    this.toastHubElements.hub.classList.remove('active');
  }

  renderToastHubContent() {
    if (!this.toastHubElements || !this.toastHubHistory.length) {
      if (this.toastHubElements) {
        this.toastHubElements.content.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: #64748b;">
            No hay notificaciones
          </div>
        `;
      }
      return;
    }
    
    const content = this.toastHubHistory.map(item => {
      const typeConfig = {
        success: { accent: '#059669', icon: '' },
        error: { accent: '#dc2626', icon: '' },
        warning: { accent: '#d97706', icon: '' },
        info: { accent: '#2563eb', icon: '' }
      };
      
      const config = typeConfig[item.type] || typeConfig.info;
      
      return `
        <div class="toast-hub-item toast-hub-item-${item.type}" 
             style="--toast-accent: ${config.accent}">
          <div class="toast-hub-item-content">
            ${item.message}
          </div>
          <div class="toast-hub-item-icon">${config.icon}</div>
          <div class="toast-hub-item-time">${item.timeString}</div>
          <button class="toast-hub-item-delete" 
                  onclick="app.removeFromToastHub('${item.id}')"
                  title="Eliminar notificacin"></button>
        </div>
      `;
    }).join('');
    
    this.toastHubElements.content.innerHTML = content;
  }

  removeFromToastHub(itemId) {
    this.toastHubHistory = this.toastHubHistory.filter(item => item.id != itemId);
    this.renderToastHubContent();
    this.updateToastHubTrigger();
  }

  clearToastHub() {
    this.toastHubHistory = [];
    this.renderToastHubContent();
    this.updateToastHubTrigger();
  }

  //  Toast avanzado con botones de accin
  showActionToast(msg, type = 'info', actions = [], duration = null) {
    const toast = this.showToast(msg, type, duration || 8000);
    
    if (actions.length > 0) {
      const actionsContainer = document.createElement('div');
      actionsContainer.style.cssText = `
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.1);
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      `;
      
      actions.forEach(action => {
        const button = document.createElement('button');
        button.textContent = action.label;
        button.style.cssText = `
          background: ${action.primary ? 'rgba(255,255,255,0.2)' : 'transparent'};
          color: white;
          border: 1px solid rgba(255,255,255,0.3);
          border-radius: 6px;
          padding: 6px 12px;
          font-size: 0.8rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        `;
        
        button.addEventListener('mouseenter', () => {
          button.style.background = action.primary ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)';
          button.style.borderColor = 'rgba(255,255,255,0.5)';
        });
        
        button.addEventListener('mouseleave', () => {
          button.style.background = action.primary ? 'rgba(255,255,255,0.2)' : 'transparent';
          button.style.borderColor = 'rgba(255,255,255,0.3)';
        });
        
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          if (typeof action.onClick === 'function') {
            action.onClick();
          }
          // Cerrar toast despus de la accin
          setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 400);
          }, 100);
        });
        
        actionsContainer.appendChild(button);
      });
      
      toast.querySelector('div').appendChild(actionsContainer);
    }
    
    return toast;
  }

  //  DEMO: Funcin para probar los nuevos toasts (solo para testing)
  demoToasts() {
    console.log(' Demostrando sistema Toast Hub corporativo...');
    
    // Limpiar historial previo
    this.clearToastHub();
    
    // Secuencia de demos
    setTimeout(() => {
      this.showToast(' Sistema Toast Hub activado - Colores corporativos sutiles', 'info');
    }, 500);
    
    setTimeout(() => {
      this.showToast(' Hover sobre cualquier toast pausar TODOS automticamente', 'success');
    }, 1500);
    
    setTimeout(() => {
      this.showToast(' Cuando hay ms de 3 toasts, aparece botn flotante ', 'warning');
    }, 2500);
    
    setTimeout(() => {
      this.showToast(' Toast #4 - Ahora debe aparecer el botn flotante', 'info');
    }, 3500);
    
    setTimeout(() => {
      this.showToast(' Toast #5 - Shift+Click abre Toast Hub centralizado', 'error');
    }, 4500);
    
    setTimeout(() => {
      this.showToast(' Toast #6 - Click normal cierra, Shift+Click abre hub', 'info');
    }, 5500);
    
    setTimeout(() => {
      console.log(' INSTRUCCIONES:');
      console.log(' Hover en cualquier toast  Pausa TODOS');
      console.log(' Click  Cerrar individual');
      console.log(' Shift+Click  Abrir Toast Hub');
      console.log(' Botn flotante   Gestin centralizada');
    }, 6500);
  }

  //  DEMO: Funcin para probar toasts con acciones usando colores sutiles
  demoActionToasts() {
    this.showActionToast(
      ' Quieres activar el modo Toast Hub como predeterminado?',
      'info',
      [
        { label: 'Ms tarde', onClick: () => this.showToast(' Configuracin pospuesta', 'info') },
        { label: 'Activar', primary: true, onClick: () => this.showToast(' Toast Hub activado por defecto', 'success') }
      ]
    );
  }

  //  DEMO: Funcin para testing especfico del Toast Hub
  demoToastHub() {
    console.log(' Testing del Toast Hub...');
    
    // Crear mltiples toasts para activar el botn flotante
    for (let i = 1; i <= 6; i++) {
      setTimeout(() => {
        this.showToast(` Toast de prueba ${i}/6 - Diseo corporativo`, 
                       i % 2 === 0 ? 'success' : 'info');
      }, i * 800);
    }
    
    // Mostrar instrucciones despus
    setTimeout(() => {
      console.log(' PRUEBA ESTAS FUNCIONES:');
      console.log(' Botn flotante   Abrir Toast Hub');
      console.log(' Shift+Click en toast  Abrir hub tambin');
      console.log(' Hover en cualquier toast  Pausa todos');
      console.log(' En el hub: Ver historial y gestionar');
    }, 5000);
  }

  //  Toast de confirmacin rpida
  showConfirmToast(msg, onConfirm, onCancel = null) {
    return this.showActionToast(msg, 'warning', [
      {
        label: 'Cancelar',
        onClick: onCancel || (() => {})
      },
      {
        label: 'Confirmar',
        primary: true,
        onClick: onConfirm
      }
    ], 10000);
  }

  repositionToasts() {
    const toasts = document.querySelectorAll('.toast');
    let offset = 20;
    
    toasts.forEach((toast, index) => {
      // Animacin suave de reposicionamiento
      toast.style.transition = 'bottom 0.3s cubic-bezier(0.16, 1, 0.3, 1)';
      toast.style.bottom = `${offset}px`;
      
      const height = toast.offsetHeight || 70;
      offset += height + 16;
      
      // Actualizar contador si es necesario
      const counter = toast.querySelector('.toast-counter');
      if (counter) {
        counter.textContent = index + 1;
        // Ocultar contador si ya no hay muchos toasts
        counter.style.display = toasts.length >= 3 ? 'flex' : 'none';
      }
      
      // Remover transicin despus de la animacin
      setTimeout(() => {
        toast.style.transition = 'all 0.3s cubic-bezier(0.16, 1, 0.3, 1)';
      }, 300);
    });
  }

  //  SISTEMA DE NOTIFICACIONES PERSISTENTE - IMPLEMENTACIN CORRECTA
  
  initNotificationSystemCORRECTO() {
    try {
      console.log(' Iniciando sistema de notificaciones...');
      
      this.notificationBell = document.getElementById('notificationBell');
      this.notificationPanel = document.getElementById('notificationPanel');
      
      console.log(' Elementos encontrados:', {
        bell: !!this.notificationBell,
        panel: !!this.notificationPanel
      });
      
      if (!this.notificationBell || !this.notificationPanel) {
        console.error(' Elementos de notificacin no encontrados');
        console.error('Bell:', this.notificationBell);
        console.error('Panel:', this.notificationPanel);
        return;
      }
      
      // Event listeners
      this.notificationBell.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log(' Click en campana detectado');
        this.toggleNotificationPanel();
      });
      
      // Cerrar panel al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!this.notificationPanel.contains(e.target) && 
            !this.notificationBell.contains(e.target)) {
          this.closeNotificationPanel();
        }
      });
      
      // Cargar notificaciones existentes
      this.updateUnreadCount();
      this.renderNotifications();
      
      console.log(' Sistema de notificaciones inicializado correctamente');
    } catch (error) {
      console.error(' Error inicializando notificaciones:', error);
    }
  }
  
  addNotification(message, type = 'info') {
    const notification = {
      id: Date.now() + Math.random(),
      message: message,
      type: type,
      timestamp: new Date().toISOString(),
      read: false,
      icon: this.getNotificationIcon(type)
    };
    
    // Agregar al principio del array
    this.notifications.unshift(notification);
    
    // Limitar a 50 notificaciones mximo
    if (this.notifications.length > 50) {
      this.notifications = this.notifications.slice(0, 50);
    }
    
    // Guardar en localStorage
    this.saveNotifications();
    
    // Actualizar UI
    this.updateUnreadCount();
    this.renderNotifications();
    
    return notification;
  }
  
  getNotificationIcon(type) {
    const icons = {
      'info': '',
      'success': '', 
      'warning': '',
      'error': ''
    };
    return icons[type] || '';
  }
  
  updateUnreadCount() {
    try {
      this.unreadNotifications = this.notifications ? this.notifications.filter(n => !n.read).length : 0;
      
      const counter = document.getElementById('notificationCounter');
      const bell = this.notificationBell;
      
      if (!counter || !bell) {
        console.warn(' Elementos de UI no encontrados para updateUnreadCount');
        return;
      }
      
      if (this.unreadNotifications > 0) {
        // Mostrar contador y activar indicador
        counter.textContent = this.unreadNotifications;
        counter.classList.add('active');
        bell.classList.add('has-unread');
      } else {
        // Ocultar contador y desactivar indicador
        counter.classList.remove('active');
        bell.classList.remove('has-unread');
      }
    } catch (error) {
      console.error(' Error en updateUnreadCount:', error);
    }
  }
  
  toggleNotificationPanel() {
    try {
      console.log(' Toggling notification panel...');
      
      if (!this.notificationPanel) {
        console.error(' Panel de notificaciones no disponible');
        return;
      }
      
      const isActive = this.notificationPanel.classList.contains('active');
      console.log(' Panel state:', isActive ? 'abierto' : 'cerrado');
      
      if (isActive) {
        this.closeNotificationPanel();
      } else {
        this.openNotificationPanel();
      }
    } catch (error) {
      console.error(' Error en toggleNotificationPanel:', error);
    }
  }
  
  openNotificationPanel() {
    try {
      console.log(' Abriendo panel de notificaciones...');
      
      if (!this.notificationPanel) {
        console.error(' Panel no disponible');
        return;
      }
      
      this.notificationPanel.classList.add('active');
      
      // Marcar todas las notificaciones como ledas al abrir
      if (this.notifications && Array.isArray(this.notifications)) {
        this.notifications.forEach(n => n.read = true);
        this.saveNotifications();
        this.updateUnreadCount();
        this.renderNotifications();
      }
      
      console.log(' Panel abierto correctamente');
    } catch (error) {
      console.error(' Error abriendo panel:', error);
    }
  }
  
  closeNotificationPanel() {
    try {
      if (!this.notificationPanel) {
        return;
      }
      
      this.notificationPanel.classList.remove('active');
      console.log(' Panel cerrado');
    } catch (error) {
      console.error(' Error cerrando panel:', error);
    }
  }
  
  renderNotifications() {
    const listContainer = document.getElementById('notificationList');
    
    if (this.notifications.length === 0) {
      listContainer.innerHTML = `
        <div class="notification-empty">
          <div class="notification-empty-icon"></div>
          <div class="notification-empty-text">No hay notificaciones</div>
        </div>
      `;
      return;
    }
    
    listContainer.innerHTML = this.notifications.map(notification => `
      <div class="notification-item ${!notification.read ? 'unread' : ''}" data-id="${notification.id}">
        <div class="notification-item-icon">${notification.icon}</div>
        <div class="notification-item-content">
          <div class="notification-item-message">${notification.message}</div>
          <div class="notification-item-time">
            <span></span>
            <span>${this.formatNotificationTime(notification.timestamp)}</span>
          </div>
        </div>
        <button class="notification-item-delete" onclick="app.deleteNotification('${notification.id}')" title="Eliminar">
          
        </button>
      </div>
    `).join('');
  }
  
  formatNotificationTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'Ahora';
    if (diffMins < 60) return `${diffMins}m`;
    if (diffHours < 24) return `${diffHours}h`;
    if (diffDays < 7) return `${diffDays}d`;
    
    return date.toLocaleDateString('es-ES', { 
      day: '2-digit', 
      month: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  deleteNotification(id) {
    this.notifications = this.notifications.filter(n => n.id != id);
    this.saveNotifications();
    this.updateUnreadCount();
    this.renderNotifications();
  }
  
  markAllNotificationsAsRead() {
    this.notifications.forEach(n => n.read = true);
    this.saveNotifications();
    this.updateUnreadCount();
    this.renderNotifications();
    this.showToast(' Todas las notificaciones marcadas como ledas', 'success');
  }
  
  clearAllNotifications() {
    if (this.notifications.length === 0) {
      this.showToast(' No hay notificaciones para limpiar', 'info');
      return;
    }
    
    this.notifications = [];
    this.saveNotifications();
    this.updateUnreadCount();
    this.renderNotifications();
    this.showToast(' Todas las notificaciones eliminadas', 'success');
  }
  
  saveNotifications() {
    try {
      localStorage.setItem('notifications', JSON.stringify(this.notifications));
    } catch (error) {
      console.error('Error guardando notificaciones:', error);
    }
  }

  //  Modal personalizado para input (reemplazo de prompt)
  showInputModal(title, defaultValue = '') {
    return new Promise((resolve) => {
      // Helper para escapar HTML
      const escapeHtml = (text) => {
        if (!text) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      };
      
      const overlay = document.createElement('div');
      overlay.className = 'custom-modal-overlay';
      
      overlay.innerHTML = `
        <div class="custom-modal">
          <div class="custom-modal-title">${escapeHtml(title)}</div>
          <input type="text" class="custom-modal-input" value="${escapeHtml(defaultValue)}" autofocus>
          <div class="custom-modal-buttons">
            <button class="custom-modal-btn custom-modal-btn-secondary" data-action="cancel">Cancelar</button>
            <button class="custom-modal-btn custom-modal-btn-primary" data-action="accept">Aceptar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const input = overlay.querySelector('.custom-modal-input');
      const acceptBtn = overlay.querySelector('[data-action="accept"]');
      const cancelBtn = overlay.querySelector('[data-action="cancel"]');
      
      // Focus en el input y seleccionar texto
      setTimeout(() => {
        input.focus();
        input.select();
      }, 100);
      
      const close = (value) => {
        overlay.remove();
        resolve(value);
      };
      
      acceptBtn.onclick = () => close(input.value);
      cancelBtn.onclick = () => close(null);
      
      // Enter para aceptar, Escape para cancelar
      input.onkeydown = (e) => {
        if (e.key === 'Enter') close(input.value);
        if (e.key === 'Escape') close(null);
      };
      
      // Click fuera del modal para cancelar
      overlay.onclick = (e) => {
        if (e.target === overlay) close(null);
      };
    });
  }

  //  Modal con dos inputs (para ID y Nombre)
  showDualInputModal(title, label1, defaultValue1 = '', placeholder1 = '', label2, defaultValue2 = '', placeholder2 = '') {
    return new Promise((resolve) => {
      const escapeHtml = (text) => {
        if (!text) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      };
      
      const overlay = document.createElement('div');
      overlay.className = 'custom-modal-overlay';
      
      overlay.innerHTML = `
        <div class="custom-modal" style="min-width: 450px;">
          <div class="custom-modal-title">${escapeHtml(title)}</div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">
              ${escapeHtml(label1)}
            </label>
            <input type="text" class="custom-modal-input" id="modal-input-1" value="${escapeHtml(defaultValue1)}" placeholder="${escapeHtml(placeholder1)}" style="text-transform: uppercase;">
            ${placeholder1 ? `<small style="display: block; margin-top: 4px; color: var(--text-muted); font-size: 11px;">${escapeHtml(placeholder1)}</small>` : ''}
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">
              ${escapeHtml(label2)}
            </label>
            <input type="text" class="custom-modal-input" id="modal-input-2" value="${escapeHtml(defaultValue2)}" placeholder="${escapeHtml(placeholder2)}">
          </div>
          <div class="custom-modal-buttons">
            <button class="custom-modal-btn custom-modal-btn-secondary" data-action="cancel">Cancelar</button>
            <button class="custom-modal-btn custom-modal-btn-primary" data-action="accept">Guardar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const input1 = overlay.querySelector('#modal-input-1');
      const input2 = overlay.querySelector('#modal-input-2');
      const acceptBtn = overlay.querySelector('[data-action="accept"]');
      const cancelBtn = overlay.querySelector('[data-action="cancel"]');
      
      setTimeout(() => {
        input1.focus();
        input1.select();
      }, 100);
      
      const close = (value) => {
        overlay.remove();
        resolve(value);
      };
      
      acceptBtn.onclick = () => close({ input1: input1.value, input2: input2.value });
      cancelBtn.onclick = () => close(null);
      
      // Tab para cambiar entre inputs
      input1.onkeydown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          input2.focus();
          input2.select();
        }
        if (e.key === 'Escape') close(null);
      };
      
      input2.onkeydown = (e) => {
        if (e.key === 'Enter') close({ input1: input1.value, input2: input2.value });
        if (e.key === 'Escape') close(null);
      };
      
      overlay.onclick = (e) => {
        if (e.target === overlay) close(null);
      };
    });
  }

  /**
   * Modal con generación automática de abreviaturas
   */
  showDualInputModalWithAbbrev(title, label1, defaultValue1 = '', placeholder1 = '', label2, defaultValue2 = '', placeholder2 = '', autoGenerate = true) {
    return new Promise((resolve) => {
      const escapeHtml = (text) => {
        if (!text) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      };
      
      const overlay = document.createElement('div');
      overlay.className = 'custom-modal-overlay';
      
      overlay.innerHTML = `
        <div class="custom-modal" style="min-width: 450px;">
          <div class="custom-modal-title">${escapeHtml(title)}</div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">
              ${escapeHtml(label2)}
            </label>
            <input type="text" class="custom-modal-input" id="modal-input-2" value="${escapeHtml(defaultValue2)}" placeholder="${escapeHtml(placeholder2 || 'Ingrese el nombre completo')}" autofocus>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">
              ${escapeHtml(label1)}
              ${autoGenerate ? '<span style="color: var(--info); font-size: 11px; font-weight: normal;"> (se sugiere automáticamente)</span>' : ''}
            </label>
            <input type="text" class="custom-modal-input" id="modal-input-1" value="${escapeHtml(defaultValue1)}" placeholder="${escapeHtml(placeholder1)}" style="text-transform: uppercase;">
            ${placeholder1 ? `<small style="display: block; margin-top: 4px; color: var(--text-muted); font-size: 11px;">${escapeHtml(placeholder1)}</small>` : ''}
          </div>
          <div class="custom-modal-buttons">
            <button class="custom-modal-btn custom-modal-btn-secondary" data-action="cancel">Cancelar</button>
            <button class="custom-modal-btn custom-modal-btn-primary" data-action="accept">Guardar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const input1 = overlay.querySelector('#modal-input-1');
      const input2 = overlay.querySelector('#modal-input-2');
      const acceptBtn = overlay.querySelector('[data-action="accept"]');
      const cancelBtn = overlay.querySelector('[data-action="cancel"]');
      
      // Auto-generar abreviatura mientras se escribe el nombre
      let userEditedAbbrev = !!defaultValue1; // Si ya tiene valor, el usuario lo editó
      
      if (autoGenerate) {
        input2.addEventListener('input', () => {
          if (!userEditedAbbrev) {
            const abrev = this.generarAbreviatura(input2.value);
            input1.value = abrev;
          }
        });
        
        input1.addEventListener('input', () => {
          userEditedAbbrev = true; // Usuario editó manualmente
        });
      }
      
      setTimeout(() => {
        input2.focus();
        input2.select();
      }, 100);
      
      const close = (value) => {
        overlay.remove();
        resolve(value);
      };
      
      acceptBtn.onclick = () => close({ input1: input1.value, input2: input2.value });
      cancelBtn.onclick = () => close(null);
      
      input2.onkeydown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          input1.focus();
          input1.select();
        }
        if (e.key === 'Escape') close(null);
      };
      
      input1.onkeydown = (e) => {
        if (e.key === 'Enter') close({ input1: input1.value, input2: input2.value });
        if (e.key === 'Escape') close(null);
      };
      
      overlay.onclick = (e) => {
        if (e.target === overlay) close(null);
      };
    });
  }

  //  Modal personalizado para confirmacin (reemplazo de confirm)
  showConfirmModal(message) {
    return new Promise((resolve) => {
      // Helper para escapar HTML
      const escapeHtml = (text) => {
        if (!text) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      };
      
      const overlay = document.createElement('div');
      overlay.className = 'custom-modal-overlay';
      
      overlay.innerHTML = `
        <div class="custom-modal">
          <div class="custom-modal-title">Confirmar accin</div>
          <div class="custom-modal-message">${escapeHtml(message).replace(/\n/g, '<br>')}</div>
          <div class="custom-modal-buttons">
            <button class="custom-modal-btn custom-modal-btn-secondary" data-action="cancel">Cancelar</button>
            <button class="custom-modal-btn custom-modal-btn-primary" data-action="accept">Aceptar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const acceptBtn = overlay.querySelector('[data-action="accept"]');
      const cancelBtn = overlay.querySelector('[data-action="cancel"]');
      
      const close = (value) => {
        overlay.remove();
        resolve(value);
      };
      
      acceptBtn.onclick = () => close(true);
      cancelBtn.onclick = () => close(false);
      
      // Escape para cancelar
      document.addEventListener('keydown', function escapeHandler(e) {
        if (e.key === 'Escape') {
          close(false);
          document.removeEventListener('keydown', escapeHandler);
        }
      });
      
      // Click fuera del modal para cancelar
      overlay.onclick = (e) => {
        if (e.target === overlay) close(false);
      };
    });
  }
}

console.log('=== INVENTARIO PRO - INICIANDO ===');
console.log('Versin: 2.0');

const okrModule = {
  state: {
    objectives: [],
    keyResults: [],
    initiatives: [],
    filters: {
      cycle: 'all',
      owner: 'all',
      status: 'all',
      tag: 'all',
      search: ''
    },
    dataLoaded: false
  },
  elements: {},
  headerAliasList: [
    { key: 'objective', aliases: ['objective', 'objetivo', 'okr objetivo', 'objective name'] },
    { key: 'cycle', aliases: ['cycle', 'ciclo', 'quarter', 'periodo', 'period'] },
    { key: 'objectiveOwner', aliases: ['objective owner', 'owner objetivo', 'dueno objetivo', 'responsable objetivo', 'lider objetivo'] },
    { key: 'owner', aliases: ['owner', 'responsable', 'lider', 'lead'] },
    { key: 'team', aliases: ['team', 'equipo', 'area'] },
    { key: 'objectiveStatus', aliases: ['objective status', 'estado objetivo', 'status objetivo', 'estado general'] },
    { key: 'objectiveProgress', aliases: ['objective progress', 'progreso objetivo', 'avance objetivo', 'progress objetivo'] },
    { key: 'objectiveCategory', aliases: ['category', 'categoria', 'pilar', 'tema'] },
    { key: 'objectiveNotes', aliases: ['objective notes', 'notas objetivo', 'descripcion objetivo', 'descripcion general'] },
    { key: 'keyResult', aliases: ['key result', 'resultado clave', 'kr', 'resultado okr'] },
    { key: 'krOwner', aliases: ['kr owner', 'responsable rc', 'responsable resultado', 'dueno rc', 'owner rc'] },
    { key: 'krMetric', aliases: ['metric', 'metrica', 'indicador', 'measure'] },
    { key: 'krBaseline', aliases: ['baseline', 'linea base', 'valor inicial'] },
    { key: 'krTarget', aliases: ['target', 'meta', 'objetivo kr', 'expected'] },
    { key: 'krCurrent', aliases: ['current', 'actual', 'valor actual', 'resultado actual'] },
    { key: 'krProgress', aliases: ['kr progress', 'progreso kr', 'avance kr', 'progress rc'] },
    { key: 'krConfidence', aliases: ['kr confidence', 'confidence', 'confianza', 'confidence level'] },
    { key: 'krStatus', aliases: ['kr status', 'estado kr', 'estado rc', 'status rc'] },
    { key: 'initiatives', aliases: ['initiatives', 'iniciativas', 'initiative', 'iniciativa'] },
    { key: 'initiativeOwner', aliases: ['initiative owner', 'owner iniciativa', 'responsable iniciativa', 'lider iniciativa'] },
    { key: 'initiativeStatus', aliases: ['initiative status', 'estado iniciativa', 'status iniciativa'] },
    { key: 'initiativeDue', aliases: ['due date', 'fecha objetivo', 'fecha limite', 'deadline', 'fecha compromiso'] },
    { key: 'confidence', aliases: ['confidence global', 'confianza global'] },
    { key: 'tags', aliases: ['tags', 'etiquetas', 'labels', 'temas'] },
    { key: 'alignment', aliases: ['alignment', 'alineacion', 'alineacion estrategica', 'pillar'] },
    { key: 'priority', aliases: ['priority', 'prioridad'] },
    { key: 'notes', aliases: ['notes', 'notas', 'comentarios', 'observaciones'] }
  ],
  statusAliasMap: {
    on_track: ['on track', 'en curso', 'en marcha', 'a tiempo', 'verde', 'cumpliendo'],
    at_risk: ['at risk', 'con riesgo', 'riesgo', 'amarillo', 'alerta'],
    off_track: ['off track', 'retrasado', 'fuera de plan', 'rojo', 'bloqueado', 'critico', 'crtico'],
    completed: ['completed', 'completado', 'alcanzado', 'logrado', 'finalizado', 'cerrado'],
    not_started: ['not started', 'sin iniciar', 'pendiente', 'por iniciar', 'no iniciado'],
    paused: ['paused', 'pausado', 'en pausa', 'aplazado']
  },
  init() {
    this.cacheElements();
    if (!this.elements.container) {
      console.warn('[OKR] Contenedor no encontrado, se omite inicializacin.');
      return;
    }
    this.bindEvents();
    this.renderEmptyState();
  },
  cacheElements() {
    this.elements = {
      container: document.getElementById('okr'),
      summary: document.getElementById('okrSummary'),
      filters: document.getElementById('okrFilters'),
      dropzone: document.getElementById('okrDropzone'),
      fileInput: document.getElementById('okrExcelInput'),
      filterCycle: document.getElementById('okrFilterCycle'),
      filterOwner: document.getElementById('okrFilterOwner'),
      filterStatus: document.getElementById('okrFilterStatus'),
      filterTag: document.getElementById('okrFilterTag'),
      searchInput: document.getElementById('okrSearchInput'),
      resetFilters: document.getElementById('okrResetFilters'),
      objectives: document.getElementById('okrObjectives'),
      insights: document.getElementById('okrInsights'),
      keyResults: document.getElementById('okrKeyResults'),
      initiatives: document.getElementById('okrInitiatives'),
      templateBtn: document.getElementById('okrDownloadTemplate'),
      demoBtn: document.getElementById('okrLoadDemo')
    };
  },
  bindEvents() {
    const els = this.elements;
    if (!els.container) return;

    if (els.fileInput) {
      els.fileInput.addEventListener('change', (event) => {
        this.handleFileList(event.target.files);
        event.target.value = '';
      });
    }

    if (els.dropzone) {
      const prevent = (event) => {
        event.preventDefault();
        event.stopPropagation();
      };
      ['dragenter', 'dragover'].forEach(evt => {
        els.dropzone.addEventListener(evt, (event) => {
          prevent(event);
          els.dropzone.classList.add('is-dragover');
        });
      });
      ['dragleave', 'dragend', 'drop'].forEach(evt => {
        els.dropzone.addEventListener(evt, (event) => {
          prevent(event);
          if (evt === 'drop') {
            this.handleFileList(event.dataTransfer?.files);
          }
          els.dropzone.classList.remove('is-dragover');
        });
      });
      els.dropzone.addEventListener('click', () => {
        els.fileInput?.click();
      });
    }

    const filterSelects = [
      { el: els.filterCycle, key: 'cycle' },
      { el: els.filterOwner, key: 'owner' },
      { el: els.filterStatus, key: 'status' },
      { el: els.filterTag, key: 'tag' }
    ];
    filterSelects.forEach(({ el, key }) => {
      if (!el) return;
      el.addEventListener('change', (event) => {
        this.state.filters[key] = event.target.value;
        this.renderDashboard();
      });
    });

    if (els.searchInput) {
      let searchTimeout;
      els.searchInput.addEventListener('input', (event) => {
        clearTimeout(searchTimeout);
        const value = event.target.value;
        searchTimeout = setTimeout(() => {
          this.state.filters.search = value;
          this.renderDashboard();
        }, 180);
      });
    }

    if (els.resetFilters) {
      els.resetFilters.addEventListener('click', () => this.resetFilters());
    }

    if (els.templateBtn) {
      els.templateBtn.addEventListener('click', () => this.downloadTemplate());
    }

    if (els.demoBtn) {
      els.demoBtn.addEventListener('click', () => this.loadDemoData());
    }
  },
  async handleFileList(fileList) {
    if (!fileList || !fileList.length) {
      this.showToast('No se detect archivo para importar.', 'warning', 2500);
      return;
    }
    const file = fileList[0];
    try {
      const workbook = await this.readWorkbookFromFile(file);
      const dataset = this.parseWorkbook(workbook);
      this.setData(dataset);
      this.showToast(`OKR importados desde ${file.name}`, 'success', 3200);
    } catch (error) {
      console.error('[OKR] Error importando Excel:', error);
      this.showToast(`Error al procesar el archivo: ${error.message}`, 'error', 4800);
    }
  },
  readWorkbookFromFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error('No se pudo leer el archivo'));
      reader.onload = (event) => {
        try {
          const data = event.target?.result;
          const workbook = XLSX.read(data, { type: 'array' });
          resolve(workbook);
        } catch (error) {
          reject(error);
        }
      };
      reader.readAsArrayBuffer(file);
    });
  },
  parseWorkbook(workbook) {
    if (!workbook || !workbook.SheetNames?.length) {
      throw new Error('El archivo no contiene hojas vlidas.');
    }
    const firstSheet = workbook.SheetNames[0];
    const sheet = workbook.Sheets[firstSheet];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
    if (!rows.length) {
      throw new Error('La hoja seleccionada est vaca.');
    }

    const headerRow = rows[0].map(cell => this.normalizeHeader(cell));
    const headerKeys = headerRow.map(header => this.resolveHeaderAlias(header));

    const dataRows = rows.slice(1);
    const normalizedRows = [];
    let lastObjective = '';

    dataRows.forEach((row) => {
      if (!row || row.every(cell => cell === null || cell === undefined || String(cell).trim() === '')) {
        return;
      }
      const record = {};
      headerKeys.forEach((key, index) => {
        if (!key) return;
        record[key] = row[index];
      });

      if (!record.objective || !String(record.objective).trim()) {
        record.objective = lastObjective;
      }

      if (!record.objective || !String(record.objective).trim()) {
        return;
      }

      lastObjective = record.objective;
      normalizedRows.push(record);
    });

    if (!normalizedRows.length) {
      throw new Error('No se encontraron filas con objetivos vlidos.');
    }

    return this.transformRows(normalizedRows, true);
  },
  normalizeHeader(value) {
    return String(value || '')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, ' ')
      .trim();
  },
  resolveHeaderAlias(normalized) {
    if (!normalized) return null;
    for (const entry of this.headerAliasList) {
      if (entry.aliases.includes(normalized)) {
        return entry.key;
      }
      if (entry.aliases.some(alias => normalized.startsWith(alias))) {
        return entry.key;
      }
    }
    return null;
  },
  transformRows(rows, alreadyNormalized = false) {
    const objectivesMap = new Map();
    const keyResults = [];
    const initiatives = [];
    let objectiveCounter = 0;
    let krCounter = 0;

    rows.forEach((rawRow) => {
      if (!rawRow) return;
      const row = alreadyNormalized ? { ...rawRow } : { ...rawRow };

      if (!row.objective || !String(row.objective).trim()) {
        return;
      }
      const objectiveName = String(row.objective).trim();
      const objectiveKey = objectiveName.toLowerCase();

      if (!objectivesMap.has(objectiveKey)) {
        objectiveCounter += 1;
        objectivesMap.set(objectiveKey, {
          id: `obj-${objectiveCounter}`,
          name: objectiveName,
          owner: row.objectiveOwner || row.owner || '',
          team: row.team || '',
          cycle: row.cycle || '',
          status: this.normalizeStatus(row.objectiveStatus || row.status || null, 'objective'),
          progress: this.clampProgress(this.parsePercent(row.objectiveProgress ?? row.progress)),
          confidence: null,
          category: row.objectiveCategory || '',
          tags: this.parseTags(row.tags),
          notes: row.objectiveNotes || row.notes || '',
          alignment: row.alignment || '',
          priority: row.priority || '',
          keyResults: []
        });
      }

      const objective = objectivesMap.get(objectiveKey);

      if (row.cycle && !objective.cycle) objective.cycle = row.cycle;
      if (row.objectiveOwner) objective.owner = row.objectiveOwner;
      if (row.team && !objective.team) objective.team = row.team;
      if (row.objectiveStatus) objective.status = this.normalizeStatus(row.objectiveStatus, 'objective');
      if (row.objectiveProgress !== undefined && row.objectiveProgress !== null && row.objectiveProgress !== '') {
        objective.progress = this.clampProgress(this.parsePercent(row.objectiveProgress));
      }
      if (row.alignment) objective.alignment = row.alignment;
      if (row.priority) objective.priority = row.priority;
      if (row.objectiveNotes) objective.notes = row.objectiveNotes;
      if (row.tags) {
        const merged = new Set([...objective.tags, ...this.parseTags(row.tags)]);
        objective.tags = Array.from(merged);
      }

      const krNameRaw = row.keyResult || row.kr || row.resultadoClave;
      const krName = krNameRaw ? String(krNameRaw).trim() : '';
      const metric = row.krMetric || row.metric || '';
      const baseline = this.parseNumber(row.krBaseline ?? row.baseline);
      const target = this.parseNumber(row.krTarget ?? row.target);
      const current = this.parseNumber(row.krCurrent ?? row.current);
      const progressFromRow = this.parsePercent(row.krProgress);
      let krProgress = progressFromRow !== null ? progressFromRow : null;

      if (krProgress === null && target !== null && current !== null) {
        if (baseline !== null && target !== baseline) {
          krProgress = ((current - baseline) / (target - baseline)) * 100;
        } else if (target !== 0) {
          krProgress = (current / target) * 100;
        }
      }

      const krStatus = this.normalizeStatus(row.krStatus || row.status || null, 'kr');
      const krConfidence = this.parseNumber(row.krConfidence ?? row.confidence);
      const krOwner = row.krOwner || row.owner || objective.owner;

      if (krName) {
        krCounter += 1;
        const kr = {
          id: `kr-${krCounter}`,
          objectiveId: objective.id,
          objectiveName: objective.name,
          name: krName,
          owner: krOwner,
          metric,
          baseline,
          target,
          current,
          progress: krProgress !== null ? this.clampProgress(krProgress) : null,
          status: krStatus,
          confidence: Number.isFinite(krConfidence) ? krConfidence : null,
          tags: this.parseTags(row.tags),
          notes: row.notes || ''
        };
        objective.keyResults.push(kr);
        keyResults.push(kr);

        const initiativesRaw = this.splitText(row.initiatives || row.initiative);
        if (initiativesRaw.length) {
          initiativesRaw.forEach((title) => {
            if (!title) return;
            const dueDate = this.parseDate(row.initiativeDue);
            initiatives.push({
              id: `init-${initiatives.length + 1}`,
              title,
              owner: row.initiativeOwner || krOwner || objective.owner,
              status: this.normalizeStatus(row.initiativeStatus || row.krStatus || null, 'initiative'),
              due: dueDate,
              dueLabel: dueDate ? this.formatDate(dueDate) : '',
              objectiveId: objective.id,
              objectiveName: objective.name,
              keyResultId: kr.id,
              keyResultName: kr.name,
              cycle: objective.cycle,
              tags: this.parseTags(row.tags)
            });
          });
        }
      }
    });

    const objectives = Array.from(objectivesMap.values()).map((objective) => {
      const validProgress = objective.keyResults
        .map(kr => kr.progress)
        .filter(value => typeof value === 'number' && !Number.isNaN(value));
      if ((!Number.isFinite(objective.progress) || objective.progress === null) && validProgress.length) {
        const avg = validProgress.reduce((sum, value) => sum + value, 0) / validProgress.length;
        objective.progress = this.clampProgress(avg);
      }
      if (!Number.isFinite(objective.progress)) {
        objective.progress = 0;
      }
      const confidences = objective.keyResults
        .map(kr => kr.confidence)
        .filter(value => typeof value === 'number' && !Number.isNaN(value));
      objective.confidence = confidences.length
        ? Number((confidences.reduce((sum, value) => sum + value, 0) / confidences.length).toFixed(1))
        : null;
      return objective;
    });

    return { objectives, keyResults, initiatives };
  },
  parseNumber(value) {
    if (value === null || value === undefined || value === '') return null;
    if (typeof value === 'number' && !Number.isNaN(value)) return value;
    const normalized = String(value)
      .replace(/\s/g, '')
      .replace(/%/g, '')
      .replace(/,/g, '.')
      .replace(/[^0-9.+\-]/g, '');
    if (!normalized) return null;
    const number = parseFloat(normalized);
    return Number.isFinite(number) ? number : null;
  },
  parsePercent(value) {
    if (value === null || value === undefined || value === '') return null;
    const number = this.parseNumber(value);
    if (number === null) return null;
    const raw = String(value).trim();
    if (raw.includes('%')) {
      return number;
    }
    if (Math.abs(number) <= 1 && /[.,]\d+/.test(raw)) {
      return number * 100;
    }
    return number;
  },
  clampProgress(value) {
    if (!Number.isFinite(value)) return 0;
    return Math.max(0, Math.min(150, Number(value)));
  },
  parseDate(value) {
    if (value === null || value === undefined || value === '') return null;
    if (value instanceof Date && !Number.isNaN(value.getTime())) {
      return value;
    }
    if (typeof value === 'number' && typeof XLSX !== 'undefined' && XLSX?.SSF?.parse_date_code) {
      const parsed = XLSX.SSF.parse_date_code(value);
      if (parsed) {
        return new Date(parsed.y, parsed.m - 1, parsed.d);
      }
    }
    const str = String(value).trim();
    if (!str) return null;
    const date = new Date(str);
    if (!Number.isNaN(date.getTime())) return date;

    const normalized = str.replace(/-/g, '/');
    const parts = normalized.split('/');
    if (parts.length === 3) {
      if (parts[0].length === 4) {
        const dateFromIso = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
        if (!Number.isNaN(dateFromIso.getTime())) return dateFromIso;
      } else {
        const day = Number(parts[0]);
        const month = Number(parts[1]) - 1;
        const year = Number(parts[2].length === 2 ? `20${parts[2]}` : parts[2]);
        const parsedDate = new Date(year, month, day);
        if (!Number.isNaN(parsedDate.getTime())) return parsedDate;
      }
    }
    return null;
  },
  formatDate(date) {
    if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
    return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
  },
  parseTags(value) {
    if (value === null || value === undefined || value === '') return [];
    if (Array.isArray(value)) {
      return value.map(tag => String(tag).trim()).filter(Boolean);
    }
    return String(value)
      .split(/[,;|]/)
      .map(tag => tag.trim())
      .filter(Boolean);
  },
  splitText(value) {
    if (!value && value !== 0) return [];
    if (Array.isArray(value)) {
      return value.map(item => String(item).trim()).filter(Boolean);
    }
    return String(value)
      .split(/[\n;|]/)
      .map(item => item.trim())
      .filter(Boolean);
  },
  normalizeStatus(value, scope = 'objective') {
    if (value === null || value === undefined || value === '') {
      return scope === 'initiative' ? 'not_started' : 'on_track';
    }
    const normalized = this.normalizeHeader(value);
    if (!normalized) {
      return scope === 'initiative' ? 'not_started' : 'on_track';
    }
    for (const [status, aliases] of Object.entries(this.statusAliasMap)) {
      if (aliases.includes(normalized) || aliases.some(alias => normalized.startsWith(alias))) {
        return status;
      }
    }
    if (scope === 'objective' && /100/.test(String(value))) {
      return 'completed';
    }
    return scope === 'initiative' ? 'not_started' : 'on_track';
  },
  getStatusColor(status) {
    const palette = {
      on_track: 'var(--success)',
      at_risk: 'var(--warning)',
      off_track: 'var(--danger)',
      completed: 'var(--primary-light)',
      not_started: 'var(--text-muted)',
      paused: 'var(--secondary)'
    };
    return palette[status] || 'var(--primary-light)';
  },
  formatStatusLabel(status) {
    switch (status) {
      case 'on_track':
        return 'En curso';
      case 'at_risk':
        return 'Con riesgo';
      case 'off_track':
        return 'Fuera de plan';
      case 'completed':
        return 'Completado';
      case 'paused':
        return 'Pausado';
      case 'not_started':
      default:
        return 'Pendiente';
    }
  },
  setData(dataset) {
    if (!dataset || !Array.isArray(dataset.objectives)) {
      throw new Error('Dataset OKR invlido.');
    }
    this.state.objectives = dataset.objectives;
    this.state.keyResults = dataset.keyResults || [];
    this.state.initiatives = dataset.initiatives || [];
    this.state.dataLoaded = true;
    this.resetFilters(false);
    this.updateFilterOptions();
    this.renderDashboard();
  },
  resetFilters(shouldRender = true) {
    this.state.filters = {
      cycle: 'all',
      owner: 'all',
      status: 'all',
      tag: 'all',
      search: ''
    };
    if (this.elements.filterCycle) this.elements.filterCycle.value = 'all';
    if (this.elements.filterOwner) this.elements.filterOwner.value = 'all';
    if (this.elements.filterStatus) this.elements.filterStatus.value = 'all';
    if (this.elements.filterTag) this.elements.filterTag.value = 'all';
    if (this.elements.searchInput) this.elements.searchInput.value = '';
    if (shouldRender) {
      this.renderDashboard();
    }
  },
  updateFilterOptions() {
    if (!this.elements.container || !this.state.objectives.length) {
      return;
    }
    const cycles = new Set();
    const owners = new Set();
    const statuses = new Set();
    const tags = new Set();

    this.state.objectives.forEach((obj) => {
      if (obj.cycle) cycles.add(obj.cycle);
      if (obj.owner) owners.add(obj.owner);
      if (obj.status) statuses.add(obj.status);
      (obj.tags || []).forEach(tag => tags.add(tag));
    });

    this.populateSelect(this.elements.filterCycle, cycles, 'Todos');
    this.populateSelect(this.elements.filterOwner, owners, 'Todos');
    this.populateSelect(this.elements.filterStatus, statuses, 'Todos', { isStatus: true });
    this.populateSelect(this.elements.filterTag, tags, 'Todas');
  },
  populateSelect(select, values, placeholder, options = {}) {
    if (!select) return;
    const currentValue = select.value || 'all';
    const sorted = Array.from(values)
      .filter(Boolean)
      .sort((a, b) => String(a).localeCompare(String(b), 'es', { sensitivity: 'base' }));
    let html = `<option value="all">${placeholder}</option>`;
    sorted.forEach((value) => {
      const label = options.isStatus ? this.formatStatusLabel(value) : value;
      html += `<option value="${this.escapeHtml(value)}">${this.escapeHtml(label)}</option>`;
    });
    select.innerHTML = html;
    if (sorted.includes(currentValue)) {
      select.value = currentValue;
    } else {
      select.value = 'all';
    }
  },
  applyFilters() {
    if (!this.state.objectives.length) return [];
    const { cycle, owner, status, tag, search } = this.state.filters;
    const term = (search || '').trim().toLowerCase();
    return this.state.objectives.filter((obj) => {
      if (cycle !== 'all' && obj.cycle !== cycle) return false;
      if (owner !== 'all' && obj.owner !== owner) return false;
      if (status !== 'all' && obj.status !== status) return false;
      if (tag !== 'all' && !(obj.tags || []).includes(tag)) return false;
      if (term) {
        const haystack = [
          obj.name,
          obj.owner,
          obj.cycle,
          obj.team,
          (obj.tags || []).join(' '),
          obj.keyResults.map(kr => `${kr.name} ${kr.owner} ${kr.metric}`).join(' ')
        ].join(' ').toLowerCase();
        if (!haystack.includes(term)) {
          return false;
        }
      }
      return true;
    });
  },
  renderDashboard() {
    if (!this.elements.container) return;
    if (!this.state.objectives.length) {
      this.renderEmptyState();
      return;
    }
    const filteredObjectives = this.applyFilters();
    this.lastFilteredIds = new Set(filteredObjectives.map(obj => obj.id));

    this.toggleFilters(true);
    this.toggleInsights(true);
    this.renderSummary(filteredObjectives);
    this.renderObjectives(filteredObjectives);
    this.renderKeyResults(filteredObjectives);
    this.renderInitiatives(filteredObjectives);
  },
  renderSummary(objectives) {
    const summaryEl = this.elements.summary;
    if (!summaryEl) return;
    if (!this.state.objectives.length) {
      summaryEl.classList.remove('is-visible');
      summaryEl.innerHTML = '';
      return;
    }

    summaryEl.classList.add('is-visible');

    if (!objectives.length) {
      summaryEl.innerHTML = `
        <div class="okr-empty-panel">
          <strong>Sin coincidencias con los filtros aplicados.</strong>
          <span>Ajusta los criterios para visualizar tus OKR.</span>
        </div>
      `;
      return;
    }

    const totalObjectives = objectives.length;
    const relatedKeyResults = this.state.keyResults.filter(kr => this.lastFilteredIds.has(kr.objectiveId));
    const avgProgress = totalObjectives
      ? objectives.reduce((sum, obj) => sum + (Number.isFinite(obj.progress) ? obj.progress : 0), 0) / totalObjectives
      : 0;
    const validConfidences = relatedKeyResults.filter(kr => Number.isFinite(kr.confidence));
    const avgConfidence = validConfidences.length
      ? validConfidences.reduce((sum, kr) => sum + kr.confidence, 0) / validConfidences.length
      : null;

    const atRisk = objectives.filter(obj => obj.status === 'at_risk').length;
    const offTrack = objectives.filter(obj => obj.status === 'off_track').length;
    const completed = objectives.filter(obj => obj.status === 'completed').length;
    const initiatives = this.state.initiatives.filter(init => this.lastFilteredIds.has(init.objectiveId));
    const upcoming = initiatives
      .filter(init => init.due)
      .sort((a, b) => a.due - b.due)
      .slice(0, 1);
    const nextMilestone = upcoming[0]?.dueLabel || 'Sin hitos prximos';
    const riskKRs = relatedKeyResults.filter(kr => kr.status === 'at_risk' || kr.status === 'off_track').length;

    summaryEl.innerHTML = `
      <div class="okr-summary-grid">
        <article class="okr-summary-card">
          <span class="okr-summary-label">Objetivos activos</span>
          <span class="okr-summary-value">${this.formatNumber(totalObjectives)}</span>
          <span class="okr-summary-sub">${this.formatNumber(relatedKeyResults.length)} resultados clave</span>
        </article>
        <article class="okr-summary-card">
          <span class="okr-summary-label">Avance promedio</span>
          <span class="okr-summary-value">${this.formatDecimal(avgProgress, 0)}%</span>
          <span class="okr-summary-sub">${avgConfidence === null ? 'Sin dato de confianza' : `Confianza media ${this.formatDecimal(avgConfidence, 1)}/10`}</span>
        </article>
        <article class="okr-summary-card">
          <span class="okr-summary-label">Estado del portfolio</span>
          <span class="okr-summary-value">${this.formatNumber(completed)} </span>
          <span class="okr-summary-sub">${this.formatNumber(atRisk)} con riesgo  ${this.formatNumber(offTrack)} fuera de plan</span>
        </article>
        <article class="okr-summary-card">
          <span class="okr-summary-label">Prximo hito</span>
          <span class="okr-summary-value">${this.escapeHtml(nextMilestone)}</span>
          <span class="okr-summary-sub">${riskKRs ? `${this.formatNumber(riskKRs)} resultados clave necesitan foco` : 'Sin alertas'}</span>
        </article>
      </div>
    `;
  },
  renderObjectives(objectives) {
    const container = this.elements.objectives;
    if (!container) return;
    if (!this.state.objectives.length) {
      container.innerHTML = '';
      return;
    }
    if (!objectives.length) {
      container.innerHTML = `
        <div class="okr-empty">
          <h3>No hay resultados para los filtros actuales</h3>
          <p>Ampla la bsqueda o restablece los filtros para visualizar tus OKR.</p>
        </div>
      `;
      return;
    }
    container.innerHTML = objectives.map(obj => this.renderObjectiveCard(obj)).join('');
  },
  renderObjectiveCard(objective) {
    const progress = Number.isFinite(objective.progress) ? Math.round(objective.progress) : 0;
    const progressDeg = Math.max(0, Math.min(100, progress)) * 3.6;
    const color = this.getStatusColor(objective.status);
    const tags = (objective.tags || []).length
      ? `<div class="okr-tags">${objective.tags.map(tag => `<span class="okr-chip tag">${this.escapeHtml(tag)}</span>`).join('')}</div>`
      : '';
    const metaLine = [
      objective.alignment ? `<span class="okr-meta-item">Alinea: ${this.escapeHtml(objective.alignment)}</span>` : '',
      Number.isFinite(objective.confidence) ? `<span class="okr-meta-item">Confianza ${this.formatDecimal(objective.confidence, 1)}/10</span>` : '',
      objective.priority ? `<span class="okr-meta-item">Prioridad ${this.escapeHtml(objective.priority)}</span>` : ''
    ].filter(Boolean).join('');

    const keyResults = objective.keyResults.length
      ? objective.keyResults.map(kr => this.renderKeyResultChip(kr)).join('')
      : `<div class="okr-empty-panel">Agrega resultados clave para este objetivo.</div>`;

    return `
      <article class="okr-card" data-okr-objective="${objective.id}">
        <header class="okr-card-header">
          <div class="okr-progress-ring" style="--progress:${progressDeg}; --progress-color:${color};">
            <span>${this.formatDecimal(progress, 0)}%</span>
          </div>
          <div class="okr-card-title">
            <h3>${this.escapeHtml(objective.name)}</h3>
            <div class="okr-card-meta">
              <span class="okr-chip status status-${objective.status}">${this.formatStatusLabel(objective.status)}</span>
              ${objective.cycle ? `<span class="okr-chip muted">${this.escapeHtml(objective.cycle)}</span>` : ''}
              ${objective.owner ? `<span class="okr-chip muted"> ${this.escapeHtml(objective.owner)}</span>` : ''}
              ${objective.team ? `<span class="okr-chip muted"> ${this.escapeHtml(objective.team)}</span>` : ''}
            </div>
          </div>
        </header>
        <div class="okr-card-body">
          ${objective.notes ? `<p class="okr-card-notes">${this.escapeHtml(objective.notes)}</p>` : ''}
          ${metaLine ? `<div class="okr-metadata-line">${metaLine}</div>` : ''}
          <div class="okr-kr-list">
            ${keyResults}
          </div>
          ${tags}
        </div>
      </article>
    `;
  },
  renderKeyResultChip(kr) {
    const progress = Number.isFinite(kr.progress) ? `${this.formatDecimal(kr.progress, 0)}%` : '--';
    const metricSegments = [];
    if (Number.isFinite(kr.current)) metricSegments.push(`Actual ${this.formatDecimal(kr.current, 1)}`);
    if (Number.isFinite(kr.target)) metricSegments.push(`Meta ${this.formatDecimal(kr.target, 1)}`);
    const metricLine = metricSegments.length ? metricSegments.join('  ') : (kr.metric ? this.escapeHtml(kr.metric) : '');
    const confidence = Number.isFinite(kr.confidence)
      ? `<span class="okr-chip mini muted">Confianza ${this.formatDecimal(kr.confidence, 1)}</span>`
      : '';

    return `
      <div class="okr-kr-card">
        <div class="okr-kr-top">
          <span class="okr-kr-name">${this.escapeHtml(kr.name)}</span>
          <span class="okr-kr-progress" style="color:${this.getStatusColor(kr.status)};">${progress}</span>
        </div>
        ${metricLine ? `<div class="okr-kr-meta">${metricLine}</div>` : ''}
        <div class="okr-kr-footer">
          ${kr.owner ? `<span class="okr-chip mini muted"> ${this.escapeHtml(kr.owner)}</span>` : ''}
          <span class="okr-chip mini status status-${kr.status || 'on_track'}">${this.formatStatusLabel(kr.status)}</span>
          ${confidence}
        </div>
      </div>
    `;
  },
  renderKeyResults(objectives) {
    const listEl = this.elements.keyResults;
    if (!listEl) return;
    if (!this.state.objectives.length) {
      listEl.innerHTML = '';
      return;
    }
    if (!objectives.length) {
      listEl.innerHTML = `<div class="okr-empty-panel">No hay resultados clave para los filtros actuales.</div>`;
      return;
    }

    const keyResults = this.state.keyResults.filter(kr => this.lastFilteredIds.has(kr.objectiveId));
    if (!keyResults.length) {
      listEl.innerHTML = `<div class="okr-empty-panel">Agrega resultados clave para ver mtricas de foco.</div>`;
      return;
    }

    const focusList = [...keyResults]
      .sort((a, b) => {
        const weight = (status) => {
          switch (status) {
            case 'off_track':
              return 0;
            case 'at_risk':
              return 1;
            case 'not_started':
              return 2;
            case 'on_track':
              return 3;
            case 'completed':
              return 4;
            default:
              return 5;
          }
        };
        const diff = weight(a.status) - weight(b.status);
        if (diff !== 0) return diff;
        const progressA = Number.isFinite(a.progress) ? a.progress : 101;
        const progressB = Number.isFinite(b.progress) ? b.progress : 101;
        return progressA - progressB;
      })
      .slice(0, 6);

    listEl.innerHTML = focusList.map((kr) => {
      const progress = Number.isFinite(kr.progress) ? `${this.formatDecimal(kr.progress, 0)}%` : '--';
      return `
        <div class="okr-kr-row">
          <div class="okr-row-top">
            <span class="okr-row-title">${this.escapeHtml(kr.name)}</span>
            <span class="okr-kr-progress">${progress}</span>
          </div>
          <div class="okr-row-meta">
            <span>${this.escapeHtml(kr.objectiveName)}</span>
            ${kr.owner ? `<span> ${this.escapeHtml(kr.owner)}</span>` : ''}
            <span>${this.formatStatusLabel(kr.status)}</span>
            ${Number.isFinite(kr.confidence) ? `<span>Confianza ${this.formatDecimal(kr.confidence, 1)}</span>` : ''}
          </div>
        </div>
      `;
    }).join('');
  },
  renderInitiatives(objectives) {
    const container = this.elements.initiatives;
    if (!container) return;
    if (!this.state.objectives.length) {
      container.innerHTML = '';
      return;
    }
    if (!objectives.length) {
      container.innerHTML = `<div class="okr-empty-panel">No hay iniciativas para los filtros aplicados.</div>`;
      return;
    }
    const initiatives = this.state.initiatives.filter(init => this.lastFilteredIds.has(init.objectiveId));
    if (!initiatives.length) {
      container.innerHTML = `<div class="okr-empty-panel">Registra iniciativas con fechas objetivo para planificar.</div>`;
      return;
    }
    const sorted = initiatives
      .slice()
      .sort((a, b) => {
        if (a.due && b.due) return a.due - b.due;
        if (a.due) return -1;
        if (b.due) return 1;
        return a.title.localeCompare(b.title, 'es', { sensitivity: 'base' });
      })
      .slice(0, 6);

    container.innerHTML = sorted.map((init) => `
      <div class="okr-initiative-row">
        <div class="okr-row-top">
          <span class="okr-row-title">${this.escapeHtml(init.title)}</span>
          <span class="okr-chip mini status status-${init.status || 'not_started'}">${this.formatStatusLabel(init.status)}</span>
        </div>
        <div class="okr-row-meta">
          <span>Objetivo: ${this.escapeHtml(init.objectiveName)}</span>
          ${init.owner ? `<span> ${this.escapeHtml(init.owner)}</span>` : ''}
          <span>${init.dueLabel ? `Fecha: ${this.escapeHtml(init.dueLabel)}` : 'Sin fecha'}</span>
        </div>
      </div>
    `).join('');
  },
  renderEmptyState() {
    if (!this.elements.container) return;
    this.toggleFilters(false);
    this.toggleInsights(false);
    if (this.elements.summary) {
      this.elements.summary.classList.remove('is-visible');
      this.elements.summary.innerHTML = '';
    }
    if (this.elements.objectives) {
      this.elements.objectives.innerHTML = `
        <div class="okr-empty">
          <h3>Importa tus OKR para empezar</h3>
          <p>Descarga la plantilla de Excel o arrastra tu archivo existente para visualizar objetivos, resultados clave e iniciativas.</p>
          <ul>
            <li>Una fila por Resultado Clave asociado a su Objetivo.</li>
            <li>Incluye columnas de mtrica, meta, actual y confianza.</li>
            <li>Opcional: iniciativas, fecha objetivo, etiquetas y notas.</li>
          </ul>
        </div>
      `;
    }
    if (this.elements.keyResults) {
      this.elements.keyResults.innerHTML = `<div class="okr-empty-panel">Aqu vers los resultados clave que requieren atencin.</div>`;
    }
    if (this.elements.initiatives) {
      this.elements.initiatives.innerHTML = `<div class="okr-empty-panel">Registra iniciativas para seguir los hitos crticos.</div>`;
    }
  },
  toggleFilters(visible) {
    if (this.elements.filters) {
      this.elements.filters.classList.toggle('is-active', Boolean(visible));
    }
  },
  toggleInsights(visible) {
    if (this.elements.insights) {
      this.elements.insights.classList.toggle('okr-hidden', !visible);
    }
  },
  showToast(message, type = 'info', duration = 3200) {
    if (typeof app !== 'undefined' && typeof app.showToast === 'function') {
      app.showToast(message, type, duration);
    } else {
      console.log(`[OKR] ${type.toUpperCase()}: ${message}`);
    }
  },
  downloadTemplate() {
    try {
      const headers = [
        'Ciclo',
        'Objetivo',
        'Dueo Objetivo',
        'Estado Objetivo',
        'Progreso Objetivo',
        'Resultado Clave',
        'Dueo RC',
        'Mtrica',
        'Lnea Base',
        'Meta',
        'Actual',
        'Confianza',
        'Estado RC',
        'Iniciativa',
        'Dueo Iniciativa',
        'Estado Iniciativa',
        'Fecha Objetivo',
        'Etiquetas',
        'Notas'
      ];
      const sample = [
        ['Q1 2026', 'Incrementar conversin web', 'Marketing', 'En curso', '35', 'Aumentar conversin del 1,8% al 2,5%', 'Camila Soto', '% conversin', '1.8', '2.5', '2.1', '6', 'Con riesgo', 'Optimizar flujo de compra', 'UX Team', 'En curso', '2026-02-15', 'Growth;Web', 'Prioridad mobile'],
        ['Q1 2026', 'Incrementar conversin web', '', '', '', 'Reducir tiempo de carga a 2s', 'TI', 'Segundos', '3.8', '2', '2.6', '7', 'En curso', 'Auditora de performance', 'TI', 'En curso', '2026-01-30', 'Tecnologa', ''],
        ['Q1 2026', 'Incrementar conversin web', '', '', '', 'Generar 300 leads va referidos', 'Growth', 'Leads', '0', '300', '120', '5', 'En riesgo', 'Disear incentivos', 'Growth', 'Pendiente', '2026-03-10', 'Alianzas', '']
      ];
      const worksheet = XLSX.utils.aoa_to_sheet([headers, ...sample]);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'OKR');
      XLSX.writeFile(workbook, 'plantilla_OKR_visual.xlsx');
      this.showToast('Plantilla OKR descargada.', 'success', 2800);
    } catch (error) {
      console.error('[OKR] Error generando plantilla:', error);
      this.showToast('No se pudo generar la plantilla', 'error', 3200);
    }
  },
  loadDemoData() {
    try {
      const rows = this.buildDemoRows();
      const dataset = this.transformRows(rows, true);
      this.setData(dataset);
      this.showToast('Demo OKR cargada.', 'success', 2800);
    } catch (error) {
      console.error('[OKR] Error cargando demo:', error);
      this.showToast('No se pudo cargar la demo', 'error', 3200);
    }
  },
  buildDemoRows() {
    return [
      {
        objective: 'Incrementar conversin web',
        cycle: 'Q1 2026',
        objectiveOwner: 'Marketing',
        objectiveStatus: 'En curso',
        objectiveProgress: '35%',
        keyResult: 'Aumentar la tasa de conversin del 1,8% al 2,5%',
        krOwner: 'Camila Soto',
        krMetric: '% conversin',
        krBaseline: '1.8',
        krTarget: '2.5',
        krCurrent: '2.1',
        krConfidence: '6',
        krStatus: 'Con riesgo',
        initiatives: 'Optimizar flujo de compra;Validar mensajes clave',
        initiativeOwner: 'UX Team',
        initiativeStatus: 'En curso',
        initiativeDue: '2026-02-15',
        tags: 'Growth;Web',
        notes: 'Prioridad mobile'
      },
      {
        objective: 'Incrementar conversin web',
        cycle: 'Q1 2026',
        objectiveOwner: 'Marketing',
        keyResult: 'Reducir tiempo de carga promedio a 2 segundos',
        krOwner: 'Equipo TI',
        krMetric: 'Segundos / pgina',
        krBaseline: '3.8',
        krTarget: '2',
        krCurrent: '2.6',
        krConfidence: '7',
        krStatus: 'En curso',
        initiatives: 'Auditora de performance;Implementar CDN',
        initiativeOwner: 'Equipo TI',
        initiativeStatus: 'En curso',
        initiativeDue: '2026-01-30',
        tags: 'Tecnologa;Performance'
      },
      {
        objective: 'Incrementar conversin web',
        cycle: 'Q1 2026',
        objectiveOwner: 'Marketing',
        keyResult: 'Generar 300 leads nuevos va programa de referidos',
        krOwner: 'Growth',
        krMetric: 'Leads',
        krTarget: '300',
        krCurrent: '120',
        krConfidence: '5',
        krStatus: 'Con riesgo',
        initiatives: 'Disear incentivos referidos',
        initiativeOwner: 'Growth',
        initiativeStatus: 'Pendiente',
        initiativeDue: '2026-03-10',
        tags: 'Alianzas'
      },
      {
        objective: 'Reducir churn de clientes enterprise',
        cycle: 'Q1 2026',
        objectiveOwner: 'Customer Success',
        objectiveStatus: 'Con riesgo',
        objectiveProgress: '48%',
        keyResult: 'Reducir el churn del 8% al 5%',
        krOwner: 'Ana Villar',
        krMetric: '% churn',
        krBaseline: '8',
        krTarget: '5',
        krCurrent: '6.1',
        krConfidence: '4',
        krStatus: 'Con riesgo',
        initiatives: 'Implementar programa de health checks',
        initiativeOwner: 'Customer Success',
        initiativeStatus: 'En curso',
        initiativeDue: '2026-02-05',
        tags: 'Retention;Clientes',
        notes: 'Enfoque en cuentas clave'
      },
      {
        objective: 'Reducir churn de clientes enterprise',
        cycle: 'Q1 2026',
        objectiveOwner: 'Customer Success',
        keyResult: 'Lograr NPS promedio de 45 puntos',
        krOwner: 'Equipo CX',
        krMetric: 'NPS',
        krBaseline: '32',
        krTarget: '45',
        krCurrent: '41',
        krConfidence: '7',
        krStatus: 'En curso',
        initiatives: 'Disear playbook de onboarding avanzado',
        initiativeOwner: 'Equipo CX',
        initiativeStatus: 'En curso',
        initiativeDue: '2026-02-20',
        tags: 'Experiencia'
      },
      {
        objective: 'Escalar plataforma de datos',
        cycle: 'Q1 2026',
        objectiveOwner: 'Tecnologa',
        objectiveStatus: 'En curso',
        keyResult: 'Migrar 80% de cargas a arquitectura evento-driven',
        krOwner: 'Data Engineering',
        krMetric: '% workloads',
        krTarget: '80',
        krCurrent: '52',
        krConfidence: '8',
        krStatus: 'En curso',
        initiatives: 'Habilitar bus de eventos para facturacin',
        initiativeOwner: 'Data Engineering',
        initiativeStatus: 'En curso',
        initiativeDue: '2026-02-28',
        tags: 'Plataforma;Data',
        alignment: 'Eficiencia operacional'
      }
    ];
  },
  formatNumber(value, options = {}) {
    const number = Number(value);
    if (!Number.isFinite(number)) return '0';
    return number.toLocaleString('es-ES', options);
  },
  formatDecimal(value, digits = 0) {
    const number = Number(value);
    if (!Number.isFinite(number)) return (digits === 0 ? '0' : Number(0).toFixed(digits));
    return number.toLocaleString('es-ES', { minimumFractionDigits: digits, maximumFractionDigits: digits });
  },
  escapeHtml(value) {
    if (value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  },
  
  // ========================================
  //  RBOL JERRQUICO ESTILO SAP PM
  // ========================================
  
  /**
   * Renderiza el rbol jerrquico estilo SAP PM
   * Convierte la estructura plana en rbol anidado con conos, colores corporativos beige/cream
   */
  renderSAPTree() {
    const container = document.getElementById('sapTreeContainer');
    if (!container) {
      console.warn(' No se encontr el contenedor del rbol SAP');
      return;
    }
    
    // Obtener datos filtrados
    const data = this.getFilteredJerarquiaData();
    if (!data || data.length === 0) {
      container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No hay datos para mostrar</div>';
      this.updateSAPTreeCount(0);
      return;
    }
    
    // Construir rbol jerrquico
    const tree = this.buildTreeStructure(data);
    
    // Renderizar HTML
    container.innerHTML = this.renderTreeNodes(tree, 0);
    
    // Actualizar contador
    this.updateSAPTreeCount(data.length);
    
    console.log(' rbol SAP renderizado:', data.length, 'elementos');
  },
  
  /**
   * Obtiene datos filtrados segn los filtros activos en cascada
   */
  getFilteredJerarquiaData() {
    //  USAR DATOS REALES DE REPUESTOS
    const filtroPlanta = document.getElementById('filtro_planta')?.value || '';
    const filtroArea = document.getElementById('filtro_area')?.value || '';
    const filtroSubArea = document.getElementById('filtro_subarea')?.value || '';
    const filtroSistema = document.getElementById('filtro_sistemaEquipo')?.value || '';
    const filtroSubSistema = document.getElementById('filtro_subsistema')?.value || '';
    const filtroSeccion = document.getElementById('filtro_seccion')?.value || '';
    const filtroDetalle = document.getElementById('filtro_detalle')?.value || '';
    
    // Filtrar repuestos segn criterios activos
    let repuestosFiltrados = this.repuestos.filter(r => {
      if (filtroPlanta && r.planta !== filtroPlanta) return false;
      if (filtroArea && r.areaGeneral !== filtroArea) return false;
      if (filtroSubArea && r.subArea !== filtroSubArea) return false;
      if (filtroSistema && r.sistemaEquipo !== filtroSistema) return false;
      if (filtroSubSistema && r.subSistema !== filtroSubSistema) return false;
      if (filtroSeccion && r.seccion !== filtroSeccion) return false;
      if (filtroDetalle && r.detalle !== filtroDetalle) return false;
      return true;
    });
    
    // Convertir a estructura de datos para el rbol SAP
    const dataMap = new Map();
    
    repuestosFiltrados.forEach(r => {
      // Crear clave nica para cada nivel jerrquico
      const planta = r.planta || 'Sin Planta';
      const area = r.areaGeneral || 'Sin rea';
      const subarea = r.subArea || 'Sin Sub-rea';
      const sistema = r.sistemaEquipo || 'Sin Sistema';
      const subsistema = r.subSistema || 'Sin Sub-Sistema';
      const seccion = r.seccion || '';
      const detalle = r.detalle || '';
      
      // Construir jerarqua completa segn niveles disponibles
      let nivelMasBajo = `${planta}|${area}|${subarea}|${sistema}`;
      
      if (subsistema && subsistema !== 'Sin Sub-Sistema') {
        nivelMasBajo += `|${subsistema}`;
        
        if (seccion) {
          nivelMasBajo += `|${seccion}`;
          
          if (detalle) {
            nivelMasBajo += `|${detalle}`;
          }
        }
      }
      
      // Contar repuestos por nivel
      if (!dataMap.has(nivelMasBajo)) {
        dataMap.set(nivelMasBajo, {
          planta,
          area,
          subarea,
          sistema,
          subsistema: subsistema !== 'Sin Sub-Sistema' ? subsistema : null,
          seccion: seccion || null,
          detalle: detalle || null,
          count: 0,
          repuestos: []
        });
      }
      
      const entry = dataMap.get(nivelMasBajo);
      entry.count++;
      entry.repuestos.push(r);
    });
    
    return Array.from(dataMap.values());
  },
  
  /**
   * Construye estructura de rbol anidado desde datos planos
   */
  buildTreeStructure(data) {
    const tree = {};
    
    data.forEach(item => {
      // Nivel 1: Planta 
      if (!tree[item.planta]) {
        tree[item.planta] = { 
          label: item.planta, 
          type: 'planta',
          children: {},
          count: 0,
          repuestos: []
        };
      }
      tree[item.planta].count += item.count;
      
      // Nivel 2: rea 
      const areaKey = item.area;
      if (!tree[item.planta].children[areaKey]) {
        tree[item.planta].children[areaKey] = {
          label: item.area,
          type: 'area',
          children: {},
          count: 0,
          repuestos: []
        };
      }
      tree[item.planta].children[areaKey].count += item.count;
      
      // Nivel 3: Sub-rea 
      const subareaKey = item.subarea;
      if (!tree[item.planta].children[areaKey].children[subareaKey]) {
        tree[item.planta].children[areaKey].children[subareaKey] = {
          label: item.subarea,
          type: 'subarea',
          children: {},
          count: 0,
          repuestos: []
        };
      }
      tree[item.planta].children[areaKey].children[subareaKey].count += item.count;
      
      // Nivel 4: Sistema 
      const sistemaKey = item.sistema;
      if (!tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey]) {
        tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey] = {
          label: item.sistema,
          type: 'sistema',
          children: {},
          count: 0,
          repuestos: []
        };
      }
      tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].count += item.count;
      
      // Nivel 5: Sub-Sistema  (opcional)
      if (item.subsistema) {
        const subsistemaKey = item.subsistema;
        if (!tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].children[subsistemaKey]) {
          tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].children[subsistemaKey] = {
            label: item.subsistema,
            type: 'subsistema',
            children: {},
            count: 0,
            repuestos: []
          };
        }
        tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].children[subsistemaKey].count += item.count;
        
        // Nivel 6: Seccin  (opcional)
        if (item.seccion) {
          const seccionKey = item.seccion;
          if (!tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].children[subsistemaKey].children[seccionKey]) {
            tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].children[subsistemaKey].children[seccionKey] = {
              label: item.seccion,
              type: 'seccion',
              children: {},
              count: 0,
              repuestos: []
            };
          }
          tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].children[subsistemaKey].children[seccionKey].count += item.count;
          
          // Nivel 7: Detalle  (opcional - hoja final)
          if (item.detalle) {
            const detalleKey = item.detalle;
            tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].children[subsistemaKey].children[seccionKey].children[detalleKey] = {
              label: item.detalle,
              type: 'detalle',
              count: item.count,
              repuestos: item.repuestos || []
            };
          } else {
            // Si no hay detalle, los repuestos van en la seccin
            tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].children[subsistemaKey].children[seccionKey].repuestos.push(...(item.repuestos || []));
          }
        } else {
          // Si no hay seccin, los repuestos van en el subsistema
          tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].children[subsistemaKey].repuestos.push(...(item.repuestos || []));
        }
      } else {
        // Si no hay subsistema, los repuestos van en el sistema
        tree[item.planta].children[areaKey].children[subareaKey].children[sistemaKey].repuestos.push(...(item.repuestos || []));
      }
    });
    
    return tree;
  },
  
  /**
   * Renderiza nodos del rbol recursivamente con estilo SAP PM
   */
  renderTreeNodes(nodes, level) {
    let html = '';
    
    Object.keys(nodes).forEach(key => {
      const node = nodes[key];
      const hasChildren = node.children && Object.keys(node.children).length > 0;
      const nodeId = `sap-node-${Math.random().toString(36).substr(2, 9)}`;
      
      // Determinar cono segn tipo (estilo SAP PM)
      let icon = ''; // Por defecto
      if (node.type === 'planta') icon = '';
      else if (node.type === 'area') icon = '';
      else if (node.type === 'subarea') icon = '';
      else if (node.type === 'sistema') icon = '';
      else if (node.type === 'subsistema') icon = '';
      else if (node.type === 'seccion') icon = '';
      else if (node.type === 'detalle') icon = '';
      
      // Clase CSS segn nivel de indentacin
      const indent = level > 7 ? 7 : level;
      const indentSpacing = 8 + (indent * 20);

      const rawLabel = node.label || key || '';
      const parts = rawLabel.split(' - ');
      const displayCode = parts.length > 1 ? parts.shift()?.trim() || rawLabel : (key || rawLabel);
      const displayName = parts.length ? parts.join(' - ').trim() : rawLabel;
      const safeCode = this.escapeHtml(displayCode);
      const safeName = this.escapeHtml(displayName);
      const labelForJs = (rawLabel || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
      const typeForJs = (node.type || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
      
      html += `
        <div class="sap-tree-node" data-level="${indent}">
          <div class="sap-tree-item indent-${indent}" data-node-id="${nodeId}" data-type="${node.type}" style="--indent:${indentSpacing}px">
            ${hasChildren ? `
              <span class="sap-tree-toggle" onclick="app.sapTreeToggleNode('${nodeId}')"></span>
            ` : `
              <span class="sap-tree-toggle-placeholder" style="width: 16px; display: inline-block;"></span>
            `}
            <span class="sap-tree-icon">${icon}</span>
            <span class="sap-tree-code">${safeCode}</span>
            <span class="sap-tree-label" onclick="app.sapTreeSelectNode('${nodeId}', '${labelForJs}', '${typeForJs}')">${safeName}</span>
            ${node.count > 0 ? `<span class="sap-tree-badge">${node.count}</span>` : ''}
          </div>
          ${hasChildren ? `
            <div class="sap-tree-children" data-parent="${nodeId}" style="display: none;">
              ${this.renderTreeNodes(node.children, level + 1)}
            </div>
          ` : ''}
        </div>
      `;
    });
    
    return html;
  },
  
  /**
   * Alterna expansin/colapso de un nodo
   */
  sapTreeToggleNode(nodeId) {
    const item = document.querySelector(`[data-node-id="${nodeId}"]`);
    const children = document.querySelector(`[data-parent="${nodeId}"]`);
    const toggle = item?.querySelector('.sap-tree-toggle');
    
    if (!children || !toggle) return;
    
    const isExpanded = children.style.display !== 'none';
    
    if (isExpanded) {
      children.style.display = 'none';
      toggle.textContent = '';
      item.classList.remove('expanded');
    } else {
      children.style.display = 'block';
      toggle.textContent = '';
      item.classList.add('expanded');
    }
  },
  
  /**
   * Selecciona un nodo (resalta con color primario)
   */
  sapTreeSelectNode(nodeId, label, type) {
    // Remover seleccin anterior
    document.querySelectorAll('.sap-tree-item.selected').forEach(el => {
      el.classList.remove('selected');
    });
    
    // Seleccionar nuevo nodo
    const item = document.querySelector(`[data-node-id="${nodeId}"]`);
    if (item) {
      item.classList.add('selected');
      console.log(' Nodo seleccionado:', {
        label,
        type,
        nodeId
      });
      
      // Mostrar notificacin (opcional)
      this.showToast(`Seleccionado: ${label}`, 'info');
    }
  },
  
  /**
   * Expande todos los nodos del rbol
   */
  sapTreeExpandAll() {
    document.querySelectorAll('.sap-tree-children').forEach(el => {
      el.style.display = 'block';
    });
    document.querySelectorAll('.sap-tree-toggle').forEach(el => {
      el.textContent = '';
    });
    document.querySelectorAll('.sap-tree-item').forEach(el => {
      el.classList.add('expanded');
    });
    console.log(' Todos los nodos expandidos');
  },
  
  /**
   * Colapsa todos los nodos del rbol
   */
  sapTreeCollapseAll() {
    document.querySelectorAll('.sap-tree-children').forEach(el => {
      el.style.display = 'none';
    });
    document.querySelectorAll('.sap-tree-toggle').forEach(el => {
      el.textContent = '';
    });
    document.querySelectorAll('.sap-tree-item').forEach(el => {
      el.classList.remove('expanded');
    });
    console.log(' Todos los nodos colapsados');
  },
  
  /**
   * Refresca el rbol (vuelve a renderizar)
   */
  sapTreeRefresh() {
    console.log(' Refrescando rbol SAP...');
    this.renderSAPTree();
  },
  
  /**
   * Actualiza el contador de elementos en el header
   */
  updateSAPTreeCount(count) {
    const counter = document.getElementById('sapTreeCount');
    if (counter) {
      counter.textContent = count;
    }
  }
};

const app = new InventarioCompleto();

// Iniciar monitoreo de conexión
app.startConnectionMonitoring();

// Inicializar atajos de teclado para undo/redo
app.initUndoRedoKeyboardShortcuts();

// ========================================
// LISTENERS DE SINCRONIZACIÓN MULTIMEDIA
// ========================================
// Escuchar cambios de multimedia para sincronizar entre pestañas
document.addEventListener('multimedia-changed', (event) => {
  const { repuestoId, action, multimedia, timestamp } = event.detail;
  console.log(` [LISTENER] Evento multimedia-changed recibido:`, { repuestoId, action, count: multimedia.length, timestamp });
  
  // Los listeners individuales ya están en syncMultimediaAcrossTabs()
  // Este listener global es para logging y debugging
  console.log(` [LISTENER] Multimedia sincronizada automáticamente en todas las pestañas`);
});

console.log(' Sistema de sincronización multimedia inicializado');

// ========================================
// BACKUP MANAGER - Sistema de backups por inactividad
// ========================================
const backupManager = {
  inactivityTimer: null,
  inactivityDelay: 60000, // 1 minuto (60,000 ms)
  hayCambiosPendientes: false,
  backupEnProgreso: false,
  ultimoBackupTimestamp: null,
  inactivityStartTime: null,
  countdownInterval: null,
  
  // Inicializar listeners de actividad
  init() {
    console.log(' Backup Manager inicializado');
    
    // Eventos que detectan actividad del usuario
    const eventos = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart', 'click'];
    
    eventos.forEach(evento => {
      document.addEventListener(evento, () => this.reiniciarTimer(), { passive: true });
    });
    
    // Iniciar timer
    this.reiniciarTimer();
    
    // Actualizar UI cada segundo (para el countdown)
    setInterval(() => this.actualizarUI(), 1000);
    
    // Actualizar UI inicial
    setTimeout(() => this.actualizarUI(), 1000);
  },
  
  // Marcar que hay cambios pendientes de backup
  marcarCambiosPendientes() {
    console.log(' ===== CAMBIOS PENDIENTES MARCADOS =====');
    console.log('   El prximo backup se crear despus de 1 minuto de inactividad');
    this.hayCambiosPendientes = true;
    this.actualizarUI();
  },
  
  // Reiniciar contador de inactividad
  reiniciarTimer() {
    // Cancelar timer anterior
    if (this.inactivityTimer) {
      clearTimeout(this.inactivityTimer);
    }
    
    // Marcar inicio de inactividad
    this.inactivityStartTime = Date.now();
    
    // Crear nuevo timer
    this.inactivityTimer = setTimeout(() => {
      this.ejecutarBackupSiNecesario();
    }, this.inactivityDelay);
  },
  
  // Ejecutar backup si hay cambios pendientes
  async ejecutarBackupSiNecesario() {
    console.log('\n ===== TIMER EXPIRADO - Verificando condiciones para backup =====');
    console.log(` Estado actual:`);
    console.log(`   - hayCambiosPendientes: ${this.hayCambiosPendientes}`);
    console.log(`   - backupEnProgreso: ${this.backupEnProgreso}`);
    console.log(`   - fsManager.isFileSystemMode: ${fsManager.isFileSystemMode}`);
    
    // Verificar condiciones
    if (!this.hayCambiosPendientes) {
      console.log(' BACKUP OMITIDO: No hay cambios pendientes');
      if (app && app.showToast) {
        app.showToast(' No hay cambios para respaldar', 'info', 3000);
      }
      return;
    }
    
    if (this.backupEnProgreso) {
      console.log(' BACKUP OMITIDO: Ya hay un backup en progreso');
      return;
    }
    
    if (!fsManager.isFileSystemMode) {
      console.log(' BACKUP OMITIDO: FileSystem no activo');
      if (app && app.showToast) {
        app.showToast(' FileSystem no conectado - Backup omitido', 'warning', 3000);
      }
      return;
    }
    
    console.log(' TODAS LAS CONDICIONES CUMPLIDAS - Iniciando backup...');
    this.backupEnProgreso = true;
    
    // Mostrar barra de progreso
    this.mostrarBarraProgreso();
    
    try {
      // Crear backup con progreso
      await this.crearBackupConProgreso();
      
      // Marcar como completado
      this.hayCambiosPendientes = false;
      this.ultimoBackupTimestamp = Date.now();
      this.actualizarProgreso(100);
      this.actualizarUI();
      
      // Esperar un momento para que se vea el 100%
      await new Promise(resolve => setTimeout(resolve, 800));
      
      console.log(' Backup automtico completado');
      app.showToast(' Backup automtico creado', 'success', 3000);
      
    } catch (error) {
      console.error(' Error en backup automtico:', error);
      app.showToast(' Error creando backup automtico', 'error');
    } finally {
      this.backupEnProgreso = false;
      this.ocultarBarraProgreso();
    }
  },
  
  // Crear backup con reporte de progreso
  async crearBackupConProgreso() {
    if (!configuracion || typeof configuracion.crearBackupAutomatico !== 'function') {
      throw new Error('Funcin de backup no disponible');
    }
    
    // Simular progreso mientras se ejecuta el backup real
    const progresoSimulado = setInterval(() => {
      const barraFill = document.getElementById('backupProgressFill');
      if (barraFill) {
        const anchoActual = parseFloat(barraFill.style.width) || 0;
        if (anchoActual < 90) {
          this.actualizarProgreso(anchoActual + 10);
        }
      }
    }, 200);
    
    try {
      // Ejecutar backup real
      await configuracion.crearBackupAutomatico();
    } finally {
      clearInterval(progresoSimulado);
    }
  },
  
  // Mostrar barra de progreso
  mostrarBarraProgreso() {
    const barra = document.getElementById('backupProgressBar');
    if (barra) {
      barra.style.display = 'block';
      this.actualizarProgreso(0);
    }
  },
  
  // Ocultar barra de progreso
  ocultarBarraProgreso() {
    const barra = document.getElementById('backupProgressBar');
    if (barra) {
      setTimeout(() => {
        barra.style.display = 'none';
      }, 1000);
    }
  },
  
  // Actualizar progreso visual
  actualizarProgreso(porcentaje) {
    const fill = document.getElementById('backupProgressFill');
    const percent = document.getElementById('backupProgressPercent');
    
    if (fill) fill.style.width = `${porcentaje}%`;
    if (percent) percent.textContent = `${Math.round(porcentaje)}%`;
  },
  
  // Actualizar UI del panel de estado en configuracin
  actualizarUI() {
    const statusIcon = document.getElementById('backupStatusIcon');
    const statusText = document.getElementById('backupStatusText');
    const lastTime = document.getElementById('backupLastTime');
    const nextTime = document.getElementById('backupNextTime');
    const pendingChanges = document.getElementById('backupPendingChanges');
    
    // Si los elementos no existen (usuario no est en configuracin), salir
    if (!statusIcon || !statusText) return;
    
    // Estado del sistema
    if (!fsManager.isFileSystemMode) {
      statusIcon.textContent = '';
      statusText.textContent = 'Sistema desactivado (FileSystem no conectado)';
      statusText.style.color = 'var(--text-secondary)';
      if (lastTime) lastTime.textContent = '---';
      if (nextTime) nextTime.textContent = '---';
      if (pendingChanges) pendingChanges.style.display = 'none';
      return;
    }
    
    if (this.backupEnProgreso) {
      statusIcon.textContent = '';
      statusText.textContent = 'Creando backup...';
      statusText.style.color = 'var(--info)';
    } else if (this.hayCambiosPendientes) {
      statusIcon.textContent = '';
      statusText.textContent = 'Cambios pendientes - Esperando inactividad';
      statusText.style.color = 'var(--warning)';
      if (pendingChanges) pendingChanges.style.display = 'block';
    } else {
      statusIcon.textContent = '';
      statusText.textContent = 'Sistema activo - Todo respaldado';
      statusText.style.color = 'var(--success)';
      if (pendingChanges) pendingChanges.style.display = 'none';
    }
    
    // ltimo backup
    if (lastTime) {
      if (this.ultimoBackupTimestamp) {
        const minutos = Math.floor((Date.now() - this.ultimoBackupTimestamp) / 60000);
        if (minutos === 0) {
          lastTime.textContent = 'Hace menos de 1 min';
        } else if (minutos < 60) {
          lastTime.textContent = `Hace ${minutos} min`;
        } else {
          const horas = Math.floor(minutos / 60);
          lastTime.textContent = `Hace ${horas}h ${minutos % 60}min`;
        }
      } else {
        lastTime.textContent = 'Sin backups an';
      }
    }
    
    // Contador de inactividad
    const countdown = document.getElementById('backupCountdown');
    if (countdown) {
      if (!fsManager.isFileSystemMode) {
        countdown.textContent = '---';
        countdown.style.color = 'var(--text-secondary)';
      } else if (this.backupEnProgreso) {
        countdown.textContent = 'Creando...';
        countdown.style.color = 'var(--info)';
      } else if (!this.hayCambiosPendientes) {
        // Sin cambios pendientes - mostrar estado inactivo
        countdown.textContent = 'Sin cambios';
        countdown.style.color = 'var(--text-secondary)';
      } else if (this.inactivityStartTime) {
        const tiempoTranscurrido = Date.now() - this.inactivityStartTime;
        const tiempoRestante = Math.max(0, this.inactivityDelay - tiempoTranscurrido);
        const segundosRestantes = Math.ceil(tiempoRestante / 1000);
        
        if (segundosRestantes <= 0) {
          countdown.textContent = '0:00';
          countdown.style.color = 'var(--warning)';
        } else {
          const mins = Math.floor(segundosRestantes / 60);
          const secs = segundosRestantes % 60;
          countdown.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
          
          // Cambiar color segn tiempo restante
          if (segundosRestantes <= 10) {
            countdown.style.color = 'var(--error)';
          } else if (segundosRestantes <= 30) {
            countdown.style.color = 'var(--warning)';
          } else {
            countdown.style.color = 'var(--success)';
          }
        }
      } else {
        countdown.textContent = '1:00';
        countdown.style.color = 'var(--text-primary)';
      }
    }
    
    // Prximo backup
    if (nextTime) {
      if (this.hayCambiosPendientes) {
        nextTime.textContent = 'En inactividad (1 min)';
        nextTime.style.color = 'var(--warning)';
      } else {
        nextTime.textContent = 'Al detectar cambios';
        nextTime.style.color = 'var(--text-primary)';
      }
    }
  }
};

// ========================================
// OBJETO CONFIGURACION - Gestin centralizada
// ========================================
const configuracion = {
  // Renderizar UI de almacenamiento segn plataforma
  renderStorageUI() {
    const container = document.getElementById('storage-config-content');
    const isMobile = app.isMobile;
    const hasFileSystem = app.hasFileSystemAPI;
    
    if (hasFileSystem) {
      // Verificar si hay carpeta guardada
      const hasSavedFolder = localStorage.getItem('fsDirectory') === 'enabled';
      
      // UI PARA PC
      container.innerHTML = `
        <h3 style="color: var(--text-primary); margin-bottom: 16px; font-size: 1.1rem; font-weight: 600;">Almacenamiento</h3>
        
        <div style="display: grid; gap: 12px;">
          <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <strong style="color: var(--text-primary); font-size: 0.95rem;">Estado:</strong>
              <span id="config-fs-status" style="padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                ${fsManager.isFileSystemMode ? ' Conectado' : ' No conectado'}
              </span>
            </div>
            <div id="config-fs-path" style="color: var(--text-secondary); font-size: 0.85rem; font-family: monospace; padding: 10px; background: rgba(0,0,0,0.15); border-radius: 6px; min-height: 40px;">
              ${fsManager.folderPath || (hasSavedFolder ? 'Carpeta guardada (click Conectar)' : 'Sistema no configurado')}
            </div>
          </div>
          
          ${hasSavedFolder && !fsManager.isFileSystemMode ? `
            <!-- Botn Conectar cuando hay carpeta guardada pero no est conectado -->
            <button onclick="configuracion.conectarRapido()" class="btn btn-success" style="width: 100%; padding: 14px; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span style="font-size: 1.2rem;"></span>
              <span>Conectar</span>
            </button>
          ` : ''}
          
          ${fsManager.isFileSystemMode ? `
            <!-- Botn Desconectar cuando est conectado -->
            <button onclick="configuracion.desconectar()" class="btn" style="width: 100%; padding: 14px; font-size: 1rem; background: var(--danger); color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span style="font-size: 1.2rem;"></span>
              <span>Desconectar</span>
            </button>
          ` : ''}
          
          <!-- Botn Cambiar Carpeta (siempre visible) -->
          <button onclick="configuracion.seleccionarCarpetaTrabajo()" class="btn ${fsManager.isFileSystemMode ? 'btn-secondary' : 'btn-primary'}" style="width: 100%; padding: ${fsManager.isFileSystemMode ? '12px' : '14px'}; font-size: ${fsManager.isFileSystemMode ? '0.9rem' : '1rem'};">
            ${fsManager.isFileSystemMode ? ' Cambiar Carpeta' : ' Seleccionar Carpeta'}
          </button>
          
          <!-- Opción Auto-reconexión -->
          <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color); margin-top: 8px;">
            <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
              <span style="color: var(--text-primary); font-size: 0.95rem;">
                <strong>Auto-reconexión al cargar</strong>
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                  Restaurar automáticamente la conexión FileSystem
                </div>
              </span>
              <input type="checkbox" id="fs-auto-reconnect-toggle" 
                ${localStorage.getItem('fsAutoReconnect') === 'enabled' ? 'checked' : ''}
                     onchange="configuracion.toggleAutoReconnect(this.checked)"
                     style="width: 20px; height: 20px; cursor: pointer;">
            </label>
          </div>
          
          ${fsManager.isFileSystemMode ? `
            <button onclick="configuracion.vincularImagenesAutomaticamente()" class="btn btn-success" style="width: 100%; padding: 12px; font-size: 0.95rem;">
               Vincular Imgenes
            </button>
          ` : ''}
        </div>
      `;
    } else {
      // UI PARA MVIL
      container.innerHTML = `
        <h3 style="color: var(--text-primary); margin-bottom: 16px; font-size: 1.1rem; font-weight: 600;">Almacenamiento Mvil</h3>
        
        <div style="display: grid; gap: 12px;">
          <div id="mobile-storage-stats" style="background: var(--bg-primary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <strong style="color: var(--text-primary); font-size: 0.95rem;">Almacenamiento:</strong>
              <span id="mobile-storage-size" style="padding: 6px 12px; background: var(--primary); color: white; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                0 MB
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; color: var(--text-secondary); font-size: 0.85rem;">
              <span>Imgenes:</span>
              <strong id="mobile-storage-count" style="color: var(--primary);">0</strong>
            </div>
          </div>
          
          <button onclick="configuracion.actualizarEstadisticasMovil()" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 0.95rem;">
            Actualizar Estadsticas
          </button>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="configuracion.exportarJSONConImagenesMovil()" class="btn btn-success" style="padding: 12px; font-size: 0.85rem;">
              Exportar
            </button>
            <button onclick="configuracion.importarJSONConImagenesMovil()" class="btn btn-primary" style="padding: 12px; font-size: 0.85rem;">
              Importar
            </button>
          </div>
          
          <button onclick="configuracion.limpiarCacheMovil()" class="btn" style="width: 100%; padding: 12px; font-size: 0.9rem; background: var(--danger); color: white;">
            Limpiar Imgenes
          </button>
        </div>
      `;
      
      // Actualizar estadsticas automticamente
      setTimeout(() => this.actualizarEstadisticasMovil(), 500);
    }
  },
  
  // Actualizar estadsticas de almacenamiento mvil
  async actualizarEstadisticasMovil() {
    try {
      const stats = await indexedDBManager.getStorageStats();
      document.getElementById('mobile-storage-size').textContent = stats.sizeFormatted;
      document.getElementById('mobile-storage-count').textContent = stats.count;
      
      console.log(' Estadsticas IndexedDB:', stats);
    } catch (error) {
      console.error('Error obteniendo estadsticas:', error);
    }
  },
  
  // Limpiar cach de imgenes mvil
  async limpiarCacheMovil() {
    const confirmacion = confirm(
      ' ADVERTENCIA\n\n' +
      'Esto eliminar TODAS las imgenes almacenadas en IndexedDB.\n' +
      'Los datos del inventario (nombres, cdigos, etc.) NO se eliminarn.\n\n' +
      'Ests seguro de continuar?'
    );
    
    if (!confirmacion) return;
    
    try {
      await indexedDBManager.clearAll();
      await this.actualizarEstadisticasMovil();
      app.showToast(' Todas las imgenes eliminadas', 'success');
      
      // Recargar inventario para limpiar referencias
      await app.loadData();
      await app.render();
    } catch (error) {
      console.error('Error limpiando cach:', error);
      app.showToast(' Error al limpiar cach', 'error');
    }
  },
  
  // ===================================================================
  // SINCRONIZACIN PC  MVIL
  // ===================================================================
  
  // Exportar JSON con imgenes para mvil (incluye base64)
  async exportarJSONConImagenesMovil() {
    try {
      console.log(' Exportando inventario con imgenes embebidas...');
      
      const exportData = {
        version: '2.5-mobile',
        exportDate: new Date().toISOString(),
        platform: app.isMobile ? 'mobile' : 'desktop',
        storageMode: app.storageMode,
        repuestos: []
      };
      
      // Procesar cada repuesto y cargar sus imgenes
      for (const repuesto of app.repuestos) {
        const repuestoExport = { ...repuesto };
        
        // Si tiene multimedia, convertir a base64
        if (repuesto.multimedia && repuesto.multimedia.length > 0) {
          const multimediaBase64 = [];
          
          for (const media of repuesto.multimedia) {
            if (media.type === 'image') {
              // Si es IndexedDB ID, cargar y convertir
              if (media.isIndexedDB && media.url.startsWith('img_')) {
                try {
                  const imageData = await indexedDBManager.getImage(media.url);
                  if (imageData && imageData.url) {
                    // Convertir Blob URL a base64
                    const response = await fetch(imageData.url);
                    const blob = await response.blob();
                    const base64 = await this.blobToBase64(blob);
                    
                    multimediaBase64.push({
                      type: 'image',
                      url: base64,
                      name: media.name,
                      size: media.size
                    });
                  }
                } catch (err) {
                  console.error(` Error convirtiendo imagen ${media.url}:`, err);
                }
              } 
              // Si ya es base64, mantener
              else if (typeof media.url === 'string' && media.url.startsWith('data:image')) {
                multimediaBase64.push(media);
              }
              // Si es FileSystem path, informar que no se puede exportar
              else if (media.isFileSystem) {
                console.warn(` Imagen FileSystem no exportada: ${media.url}`);
              }
            }
          }
          
          repuestoExport.multimedia = multimediaBase64;
        }
        
        exportData.repuestos.push(repuestoExport);
      }
      
      const jsonString = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const sizeMB = (blob.size / (1024 * 1024)).toFixed(2);
      
      // Descargar archivo
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inventario_movil_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      console.log(` Exportado: ${exportData.repuestos.length} repuestos, ${sizeMB}MB`);
      app.showToast(` Inventario exportado (${sizeMB}MB) con imgenes`, 'success');
    } catch (error) {
      console.error('Error exportando JSON con imgenes:', error);
      app.showToast(' Error al exportar: ' + error.message, 'error');
    }
  },
  
  // Importar JSON con imgenes para mvil
  async importarJSONConImagenesMovil() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        console.log(' Importando inventario con imgenes...');
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (!data.repuestos || !Array.isArray(data.repuestos)) {
          throw new Error('Formato de JSON invlido');
        }
        
        // Obtener ruta iCloud predefinida (si existe)
        const icloudPath = this.getICloudPath();
        console.log(` Ruta iCloud configurada: ${icloudPath || 'Ninguna'}`);
        
        // Procesar cada repuesto e importar imgenes a IndexedDB
        for (const repuesto of data.repuestos) {
          if (repuesto.multimedia && repuesto.multimedia.length > 0) {
            const multimediaIndexedDB = [];
            
            for (const media of repuesto.multimedia) {
              if (media.type === 'image') {
                let imageBlob = null;
                let imageName = media.name || 'imagen.webp';
                
                // CASO 1: Imagen embebida en base64
                if (media.url && media.url.startsWith('data:image')) {
                  imageBlob = await this.base64ToBlob(media.url);
                  console.log(` Imagen base64 embebida: ${imageName}`);
                }
                // CASO 2: Imagen NO embebida - intentar buscar en ruta iCloud
                else if (icloudPath && media.name) {
                  console.log(` Buscando imagen en iCloud: ${icloudPath}/${media.name}`);
                  
                  // NOTA: En iOS, no podemos acceder directamente a archivos por ruta
                  // Esta es una funcionalidad limitada - la imagen debe estar embebida
                  // o el usuario debe seleccionarla manualmente
                  console.warn(` Imagen no embebida: ${media.name}`);
                  console.warn(` iOS no permite acceso directo a carpetas`);
                  console.warn(` Recomendacin: Embeber imgenes en el JSON al exportar`);
                  
                  // Saltar esta imagen - no se puede cargar automticamente en iOS
                  continue;
                }
                
                // Si tenemos un Blob, guardarlo en IndexedDB
                if (imageBlob) {
                  const imageId = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                  await indexedDBManager.saveImage(imageId, repuesto.id, imageBlob);
                  
                  multimediaIndexedDB.push({
                    type: 'image',
                    url: imageId,
                    name: imageName,
                    size: imageBlob.size,
                    isIndexedDB: true
                  });
                  
                  console.log(` Imagen importada a IndexedDB: ${imageId}`);
                }
              }
            }
            
            repuesto.multimedia = multimediaIndexedDB;
          }
        }
        
        // Guardar en localStorage
        app.repuestos = data.repuestos;
        localStorage.setItem('repuestos', JSON.stringify(app.repuestos));
        
        // Actualizar UI
        await app.loadData();
        await app.render();
        await this.actualizarEstadisticasMovil();
        
        app.showToast(` ${data.repuestos.length} repuestos importados`, 'success');
        console.log(` Importacin completada: ${data.repuestos.length} repuestos`);
      } catch (error) {
        console.error('Error importando JSON:', error);
        app.showToast(' Error al importar: ' + error.message, 'error');
      }
    };
    
    input.click();
  },
  
  // Convertir Blob a base64
  blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  },
  
  // Convertir base64 a Blob
  base64ToBlob(base64) {
    return new Promise((resolve) => {
      fetch(base64)
        .then(res => res.blob())
        .then(blob => resolve(blob));
    });
  },

  //  NUEVO: Conectar rpido usando carpeta guardada
  async conectarRapido() {
    try {
      console.log(' Conexin rpida - usando carpeta guardada');
      await LoadingModal.runTask(
        () => app.connectWorkspace(true, false),
        {
          startMessage: 'Conectando carpeta guardada...',
          statusMessage: 'Restaurando permisos...',
          successMessage: 'Carpeta conectada',
          errorMessage: 'Reintentando almacenamiento local',
          autoHide: false,
          tips: [
            'La carpeta debe seguir disponible en el mismo disco.',
            'Si cambiaste la ruta, usa "Cambiar carpeta" para re-seleccionarla.'
          ]
        }
      );
      
      // Actualizar UI
      this.renderStorageUI();
      LoadingModal.finish({
        message: 'Conexión restaurada',
        status: 'Capacidad ilimitada activa',
        tip: 'Continúa trabajando con tu carpeta principal.',
        delay: 400
      });
    } catch (error) {
      console.error('Error en conexin rpida:', error);
      app.showToast(' Error al conectar. Intenta "Cambiar Carpeta".', 'error');
      LoadingModal.finish({
        message: 'No se pudo reconectar',
        status: 'Revisa la carpeta',
        tip: 'Selecciona manualmente la carpeta INVENTARIO_STORAGE.',
        delay: 600
      });
    }
  },

  //  NUEVO: Desconectar
  async desconectar() {
    const confirmar = confirm(
      'Desconectar carpeta INVENTARIO_STORAGE?\n\n' +
      'Los datos no se perdern, pero debers reconectar para continuar trabajando.'
    );
    
    if (!confirmar) return;
    
    try {
      // Limpiar estado de FileSystem
      fsManager.isFileSystemMode = false;
      fsManager.directoryHandle = null;
      fsManager.imagesFolder = null;
      fsManager.folderPath = '';
      
      // NO eliminar localStorage para mantener sesin guardada
      // localStorage.removeItem('fsDirectory');
      
      // Limpiar mapStorage
      if (mapStorage) {
        mapStorage.initialized = false;
        mapStorage.isConnected = false;
      }
      
      // Actualizar badges
      app.updateAllConnectionBadges(false);
      
      // Actualizar UI
      this.renderStorageUI();
      
      app.showToast(' Desconectado - Datos guardados', 'info');
      console.log(' Sistema desconectado');
    } catch (error) {
      console.error('Error al desconectar:', error);
      app.showToast(' Error al desconectar', 'error');
    }
  },
  
  // Toggle Auto-reconexión
  toggleAutoReconnect(enabled) {
    if (enabled) {
      localStorage.setItem('fsAutoReconnect', 'enabled');
      app.showToast('✅ Auto-reconexión activada', 'success');
      console.log('✅ Auto-reconexión habilitada - La app se conectará automáticamente al cargar');
    } else {
      localStorage.setItem('fsAutoReconnect', 'disabled');
      app.showToast('🔒 Auto-reconexión desactivada', 'info');
      console.log('🔒 Auto-reconexión deshabilitada - Deberás conectar manualmente');
    }
  },

  // Seleccionar carpeta de trabajo
  async seleccionarCarpetaTrabajo() {
    //  USAR MTODO CENTRALIZADO
    try {
      console.log(` [DEBUG] Cach global ANTES de reconectar: ${globalBlobCache.size} entradas`);
      
      await LoadingModal.runTask(
        () => app.connectWorkspace(false, true),
        {
          startMessage: 'Seleccionando carpeta...',
          statusMessage: 'Esperando selección del usuario...',
          successMessage: 'Carpeta lista',
          errorMessage: 'Operación incompleta',
          autoHide: false,
          tips: [
            'El explorador del navegador puede abrirse en otra ventana.',
            'Selecciona la carpeta INVENTARIO_STORAGE y presiona "Aceptar".'
          ]
        }
      );
      
      console.log(` [DEBUG] Cach global DESPUS de conectar: ${globalBlobCache.size} entradas`);
      LoadingModal.finish({
        message: 'Carpeta seleccionada',
        status: 'Sincronización en curso',
        tip: 'Actualizando panel de estado...',
        delay: 400
      });
    } catch (error) {
      console.error('Error seleccionando carpeta:', error);
      app.showToast(' Error al seleccionar carpeta', 'error');
      LoadingModal.finish({
        message: 'Selección cancelada',
        status: 'Sin carpeta activa',
        tip: 'Repite la operación y selecciona INVENTARIO_STORAGE.',
        delay: 600
      });
    }
  },

  // Actualizar interfaz de estado
  actualizarEstadoUI() {
    console.log(' actualizarEstadoUI llamado');
    console.log('   fsManager.isFileSystemMode:', fsManager.isFileSystemMode);
    console.log('   fsManager.folderPath:', fsManager.folderPath);
    
    //  NUEVO: Re-renderizar toda la UI para reflejar estado actual
    this.renderStorageUI();
  },

  // Exportar JSON a carpeta
  async exportarJSON() {
    if (!fsManager.isFileSystemMode) {
      app.showToast(' Primero debes seleccionar una carpeta', 'warning');
      return;
    }
    
    try {
      await app.exportarJSON();
      app.showToast(' JSON exportado correctamente a la carpeta', 'success');
    } catch (error) {
      console.error('Error exportando JSON:', error);
      app.showToast(' Error al exportar JSON', 'error');
    }
  },

  // Exportar Excel
  async exportarExcel() {
    try {
      await app.exportarExcel();
      app.showToast(' Excel exportado a Descargas', 'success');
    } catch (error) {
      console.error('Error exportando Excel:', error);
      app.showToast(' Error al exportar Excel', 'error');
    }
  },

  // Exportar JSON ligero (sin multimedia)
  async exportarJSONLigero() {
    try {
      const data = app.repuestos.map(r => {
        const { multimedia, ...resto } = r;
        return resto;
      });
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inventario_sin_imagenes_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      app.showToast(' JSON ligero exportado a Descargas', 'success');
    } catch (error) {
      console.error('Error exportando JSON ligero:', error);
      app.showToast(' Error al exportar JSON ligero', 'error');
    }
  },

  // Importar JSON con fusin
  async importarJSONFusion() {
    if (!fsManager.isFileSystemMode) {
      app.showToast(' Primero debes seleccionar una carpeta', 'warning');
      return;
    }
    
    try {
      await app.importarJSON();
      app.showToast(' Datos fusionados correctamente', 'success');
    } catch (error) {
      console.error('Error importando JSON:', error);
      app.showToast(' Error al importar JSON', 'error');
    }
  },

  // Importar archivo externo
  async importarArchivoExterno() {
    const confirmacion = confirm(
      ' ADVERTENCIA\n\n' +
      'Esta accin REEMPLAZAR completamente el inventario actual.\n' +
      'Se perdern todos los datos y multimedia actuales.\n\n' +
      'Ests seguro de continuar?'
    );
    
    if (!confirmacion) return;
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (!Array.isArray(data)) {
          throw new Error('El archivo no contiene un array vlido');
        }
        
        // Reemplazar datos
        app.repuestos = data.map((item, index) => {
          if (!item.id) {
            item.id = `repuesto-${Date.now()}-${index}`;
          }
          if (!item.multimedia || !Array.isArray(item.multimedia)) {
            item.multimedia = [];
          }
          return item;
        });
        
        // Guardar y renderizar
        await app.saveData();
        await app.render();
        app.renderFilters();
        app.updateAutocompleteData();
        
        app.showToast(` ${data.length} repuestos importados correctamente`, 'success');
      } catch (error) {
        console.error('Error importando archivo:', error);
        app.showToast(' Error al importar archivo: ' + error.message, 'error');
      }
    };
    
    input.click();
  },

  // Convertir imgenes a WebP
  async convertirImagenesWebP() {
    if (!fsManager.isFileSystemMode || !fsManager.imagesFolder) {
      app.showToast(' Primero debes seleccionar una carpeta', 'warning');
      return;
    }
    
    const confirmacion = confirm(
      ' CONVERSIN A WEBP\n\n' +
      'Se convertirn todas las imgenes JPG/PNG a formato WebP.\n' +
      'Los archivos originales se ELIMINARN despus de la conversin.\n\n' +
      'Deseas continuar?'
    );
    
    if (!confirmacion) return;
    
    try {
      const statusDiv = document.getElementById('conversion-status');
      const progressText = document.getElementById('conversion-progress');
      const progressBar = document.getElementById('conversion-bar');
      
      statusDiv.style.display = 'block';
      
      // Obtener todas las imgenes de la carpeta
      const imagenes = [];
      for await (const entry of fsManager.imagesFolder.values()) {
        if (entry.kind === 'file') {
          const name = entry.name.toLowerCase();
          if (name.endsWith('.jpg') || name.endsWith('.jpeg') || name.endsWith('.png')) {
            imagenes.push(entry);
          }
        }
      }
      
      if (imagenes.length === 0) {
        app.showToast(' No se encontraron imgenes JPG/PNG para convertir', 'info');
        statusDiv.style.display = 'none';
        return;
      }
      
      progressText.textContent = `0 / ${imagenes.length}`;
      let convertidas = 0;
      
      for (const fileHandle of imagenes) {
        try {
          const file = await fileHandle.getFile();
          
          // Cargar imagen
          const img = new Image();
          const blob = await file;
          const url = URL.createObjectURL(blob);
          
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = url;
          });
          
          // Convertir a WebP
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          
          const webpBlob = await new Promise(resolve => {
            canvas.toBlob(resolve, 'image/webp', 0.85);
          });
          
          URL.revokeObjectURL(url);
          
          // Guardar WebP
          const newName = file.name.replace(/\.(jpg|jpeg|png)$/i, '.webp');
          const newFileHandle = await fsManager.imagesFolder.getFileHandle(newName, { create: true });
          const writable = await newFileHandle.createWritable();
          await writable.write(webpBlob);
          await writable.close();
          
          // Eliminar original
          await fsManager.imagesFolder.removeEntry(file.name);
          
          // Actualizar referencias en el inventario
          app.repuestos.forEach(repuesto => {
            if (repuesto.multimedia && Array.isArray(repuesto.multimedia)) {
              repuesto.multimedia.forEach(media => {
                if (media.url && media.url.includes(file.name)) {
                  media.url = media.url.replace(/\.(jpg|jpeg|png)$/i, '.webp');
                  media.name = media.name ? media.name.replace(/\.(jpg|jpeg|png)$/i, '.webp') : newName;
                }
              });
            }
          });
          
          convertidas++;
          progressText.textContent = `${convertidas} / ${imagenes.length}`;
          progressBar.style.width = `${(convertidas / imagenes.length) * 100}%`;
          
          console.log(` Convertido: ${file.name}  ${newName}`);
        } catch (error) {
          console.error(` Error convirtiendo ${fileHandle.name}:`, error);
        }
      }
      
      // Guardar cambios en el inventario
      await app.saveData();
      
      app.showToast(` ${convertidas} imgenes convertidas a WebP`, 'success');
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
        progressBar.style.width = '0%';
      }, 3000);
      
    } catch (error) {
      console.error('Error en conversin WebP:', error);
      app.showToast(' Error durante la conversin', 'error');
    }
  },

  // Ver estadsticas de almacenamiento
  async verEstadisticasAlmacenamiento() {
    if (!fsManager.isFileSystemMode || !fsManager.imagesFolder) {
      app.showToast(' Primero debes seleccionar una carpeta', 'warning');
      return;
    }
    
    try {
      let totalImagenes = 0;
      let totalTamano = 0;
      const formatos = {};
      
      for await (const entry of fsManager.imagesFolder.values()) {
        if (entry.kind === 'file') {
          totalImagenes++;
          const file = await entry.getFile();
          totalTamano += file.size;
          
          const ext = file.name.split('.').pop().toLowerCase();
          formatos[ext] = (formatos[ext] || 0) + 1;
        }
      }
      
      const tamanoMB = (totalTamano / (1024 * 1024)).toFixed(2);
      
      //  OBTENER RUTAS COMPLETAS
      let carpetaNombre = localStorage.getItem('fsFolderName') || 'INVENTARIO_PORTABLE';
      
      //  CORREGIR: Si tiene /INVENTARIO_STORAGE, quitarlo (solo queremos el nombre de la carpeta base)
      if (carpetaNombre.includes('INVENTARIO_STORAGE')) {
        carpetaNombre = carpetaNombre.split('/')[0].split('\\')[0];
      }
      
      const rutaBase = ` Carpeta base: ${carpetaNombre}`;
      const rutaStorage = ` Storage: ${carpetaNombre}/INVENTARIO_STORAGE`;
      const rutaImagenes = ` Imgenes: ${carpetaNombre}/INVENTARIO_STORAGE/imagenes/`;
      const rutaJSON = ` JSON: ${carpetaNombre}/INVENTARIO_STORAGE/inventario.json`;
      
      //  VERIFICAR LOCALSTORAGE
      const localStorageData = localStorage.getItem('inventarioData');
      let localStorageMB = 0;
      let imagenesBase64 = 0;
      
      if (localStorageData) {
        localStorageMB = (new Blob([localStorageData]).size / (1024 * 1024)).toFixed(2);
        const data = JSON.parse(localStorageData);
        data.forEach(item => {
          if (item.multimedia && item.multimedia.length > 0) {
            item.multimedia.forEach(media => {
              if (media.url && media.url.startsWith('data:image')) {
                imagenesBase64++;
              }
            });
          }
        });
      }
      
      let mensaje = ` ESTADSTICAS DE ALMACENAMIENTO\n\n`;
      mensaje += `\n`;
      mensaje += ` RUTAS ACTIVAS:\n`;
      mensaje += `\n`;
      mensaje += `${rutaBase}\n`;
      mensaje += `${rutaStorage}\n`;
      mensaje += `${rutaImagenes}\n`;
      mensaje += `${rutaJSON}\n\n`;
      
      mensaje += `\n`;
      mensaje += ` IMGENES EN FILESYSTEM:\n`;
      mensaje += `\n`;
      mensaje += ` Total de archivos: ${totalImagenes}\n`;
      mensaje += ` Espacio ocupado: ${tamanoMB} MB\n`;
      mensaje += ` Sin lmites de almacenamiento\n\n`;
      
      mensaje += ` Por formato:\n`;
      for (const [ext, count] of Object.entries(formatos)) {
        mensaje += `   ${ext.toUpperCase()}: ${count} archivos\n`;
      }
      
      mensaje += `\n\n`;
      mensaje += ` REPUESTOS:\n`;
      mensaje += `\n`;
      mensaje += ` Con imgenes: ${app.repuestos.filter(r => r.multimedia && r.multimedia.length > 0).length}\n`;
      mensaje += ` Sin imgenes: ${app.repuestos.filter(r => !r.multimedia || r.multimedia.length === 0).length}\n`;
      mensaje += ` Total: ${app.repuestos.length}\n\n`;
      
      mensaje += `\n`;
      mensaje += ` LOCALSTORAGE (Solo datos):\n`;
      mensaje += `\n`;
      mensaje += ` Tamao: ${localStorageMB} MB\n`;
      mensaje += ` Imgenes base64 obsoletas: ${imagenesBase64}\n`;
      mensaje += `${imagenesBase64 === 0 ? ' LIMPIO - Solo guarda nombres/precios/cantidades' : ' Usar botn "Limpiar Imgenes localStorage"'}\n\n`;
      
      mensaje += `\n`;
      mensaje += ` RESUMEN:\n`;
      mensaje += `\n`;
      mensaje += ` Todas las referencias desde: ${carpetaNombre}\n`;
      mensaje += ` Imgenes: FileSystem (sin lmites)\n`;
      mensaje += ` Datos: JSON + localStorage (backup)\n`;
      mensaje += ` Sin referencias externas\n`;
      
      // Construir HTML del modal (REEMPLAZANDO ALERT)
      let html = `
        <!-- Seccin Rutas -->
        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--primary);">
          <h3 style="margin: 0 0 16px 0; color: var(--primary); display: flex; align-items: center; gap: 10px; font-size: 1.3rem;">
            <span style="font-size: 1.5rem;"></span>
            <span>Rutas Activas</span>
          </h3>
          <div style="display: grid; gap: 12px; font-size: 0.9rem;">
            
            <!-- Carpeta Base -->
            <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--primary);">
              <div style="display: flex; align-items: start; gap: 12px;">
                <span style="font-size: 1.8rem;"></span>
                <div style="flex: 1;">
                  <strong style="color: var(--primary); font-size: 1.05rem;">Carpeta Base</strong>
                  <div style="font-family: 'Courier New', monospace; color: var(--text-primary); margin: 6px 0; background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 4px;">
                    ${carpetaNombre}
                  </div>
                  <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; margin-top: 8px;">
                     <strong>Carpeta principal del proyecto.</strong> Contiene el archivo HTML de la aplicacin y la carpeta INVENTARIO_STORAGE. Es portable: puedes copiarla a cualquier ubicacin (PC, USB, disco externo).
                  </div>
                </div>
              </div>
            </div>

            <!-- Storage -->
            <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--info);">
              <div style="display: flex; align-items: start; gap: 12px;">
                <span style="font-size: 1.8rem;"></span>
                <div style="flex: 1;">
                  <strong style="color: var(--info); font-size: 1.05rem;">Carpeta Storage</strong>
                  <div style="font-family: 'Courier New', monospace; color: var(--text-primary); margin: 6px 0; background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 4px;">
                    ${carpetaNombre}/INVENTARIO_STORAGE
                  </div>
                  <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; margin-top: 8px;">
                     <strong>Almacenamiento central de datos.</strong> Contiene el archivo JSON con toda la informacin de repuestos (nombres, precios, cantidades, etc.) y la carpeta de imgenes. Se crea automticamente al seleccionar la carpeta base.
                  </div>
                </div>
              </div>
            </div>

            <!-- Imgenes -->
            <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--success);">
              <div style="display: flex; align-items: start; gap: 12px;">
                <span style="font-size: 1.8rem;"></span>
                <div style="flex: 1;">
                  <strong style="color: var(--success); font-size: 1.05rem;">Carpeta Imgenes</strong>
                  <div style="font-family: 'Courier New', monospace; color: var(--text-primary); margin: 6px 0; background: rgba(16, 185, 129, 0.1); padding: 8px 12px; border-radius: 4px;">
                    ${carpetaNombre}/INVENTARIO_STORAGE/imagenes/
                  </div>
                  <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; margin-top: 8px;">
                     <strong>Todas las fotos de repuestos.</strong> Almacenamiento ilimitado usando FileSystem Access API. Las imgenes se guardan como archivos fsicos (JPG, PNG, WebP). El sistema solo guarda las rutas en el JSON, no las imgenes en base64.
                  </div>
                </div>
              </div>
            </div>

            <!-- JSON -->
            <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--warning);">
              <div style="display: flex; align-items: start; gap: 12px;">
                <span style="font-size: 1.8rem;"></span>
                <div style="flex: 1;">
                  <strong style="color: var(--warning); font-size: 1.05rem;">Archivo JSON Principal</strong>
                  <div style="font-family: 'Courier New', monospace; color: var(--text-primary); margin: 6px 0; background: rgba(245, 158, 11, 0.1); padding: 8px 12px; border-radius: 4px;">
                    ${carpetaNombre}/INVENTARIO_STORAGE/inventario.json
                  </div>
                  <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; margin-top: 8px;">
                     <strong>Base de datos completa del inventario.</strong> Contiene: nombres, cdigos SAP, categoras, reas, equipos, cantidades, stock mnimo, precios, historial de conteos y rutas a las imgenes. Se actualiza automticamente cada vez que guardas cambios.
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Grid 2 columnas -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          
          <!-- Imgenes FileSystem -->
          <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); padding: 20px; border-radius: 12px; border: 2px solid var(--success);">
            <h3 style="margin: 0 0 16px 0; color: var(--success); display: flex; align-items: center; gap: 10px; font-size: 1.2rem;">
              <span style="font-size: 1.4rem;"></span>
              <span>Imgenes FileSystem</span>
            </h3>
            
            <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; margin-bottom: 14px;">
              <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6;">
                 <strong>Almacenamiento ilimitado.</strong> Las imgenes se guardan como archivos fsicos en tu disco. No hay lmites de tamao o cantidad. Solo se guardan las rutas en el JSON.
              </div>
            </div>
            
            <div style="display: grid; gap: 12px;">
              <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${totalImagenes}</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">Total de archivos</div>
                <div style="font-size: 0.75rem; color: var(--success); font-weight: 600;"> Sin lmites</div>
              </div>
              
              <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--info);">${tamanoMB} MB</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">Espacio ocupado</div>
                <div style="font-size: 0.75rem; color: var(--info);">Archivos fsicos en disco</div>
              </div>
              
              <div style="background: linear-gradient(135deg, var(--success), #059669); color: white; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 0.95rem;">
                <div style="font-size: 1.5rem; margin-bottom: 4px;"></div>
                <div>Capacidad ilimitada</div>
                <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 4px;">FileSystem Access API</div>
              </div>
            </div>
            
            ${Object.keys(formatos).length > 0 ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
              <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">Por formato:</div>
              <div style="display: grid; gap: 8px;">
                ${Object.entries(formatos).map(([ext, count]) => `
                  <div style="display: flex; justify-content: space-between; background: var(--bg-primary); padding: 8px 12px; border-radius: 6px;">
                    <span style="color: var(--text-primary); font-weight: 500;">${ext.toUpperCase()}</span>
                    <span style="color: var(--success); font-weight: 700;">${count} archivos</span>
                  </div>
                `).join('')}
              </div>
            </div>
            ` : ''}
          </div>

          <!-- Repuestos -->
          <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1)); padding: 20px; border-radius: 12px; border: 2px solid var(--secondary);">
            <h3 style="margin: 0 0 16px 0; color: var(--secondary); display: flex; align-items: center; gap: 10px; font-size: 1.2rem;">
              <span style="font-size: 1.4rem;"></span>
              <span>Repuestos en Inventario</span>
            </h3>
            
            <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; margin-bottom: 14px;">
              <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6;">
                 <strong>Productos registrados en el sistema.</strong> Cada repuesto tiene: nombre, cdigo SAP, categora, rea, equipo, cantidad actual, stock mnimo, precio e historial de conteos.
              </div>
            </div>
            
            <div style="display: grid; gap: 12px;">
              <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${app.repuestos.filter(r => r.multimedia && r.multimedia.length > 0).length}</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;"> Con imgenes</div>
                <div style="font-size: 0.75rem; color: var(--success);">Totalmente identificados</div>
              </div>
              
              <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px;">
                <div style="font-size: 2rem; font-weight: 700; color: ${app.repuestos.filter(r => !r.multimedia || r.multimedia.length === 0).length > 0 ? 'var(--warning)' : 'var(--success)'};">${app.repuestos.filter(r => !r.multimedia || r.multimedia.length === 0).length}</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;"> Sin imgenes</div>
                ${app.repuestos.filter(r => !r.multimedia || r.multimedia.length === 0).length > 0 ? `
                  <div style="font-size: 0.75rem; color: var(--warning);">Pendientes de fotografiar</div>
                ` : `
                  <div style="font-size: 0.75rem; color: var(--success);">Todos tienen fotos</div>
                `}
              </div>
              
              <div style="background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; padding: 14px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; font-weight: 700;">${app.repuestos.length}</div>
                <div style="font-size: 0.85rem; margin-bottom: 4px;"> Total registrados</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">En inventario completo</div>
              </div>
              
              ${app.repuestos.filter(r => !r.multimedia || r.multimedia.length === 0).length > 0 ? `
                <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid var(--warning);">
                  <div style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5;">
                     <strong>Tip:</strong> Usa el botn <strong>"Vincular Imgenes de la Carpeta"</strong> en Configuracin para asociar automticamente las fotos con los repuestos.
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>

        <!-- localStorage -->
        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid ${imagenesBase64 === 0 ? 'var(--success)' : 'var(--warning)'};">
          <h3 style="margin: 0 0 16px 0; color: ${imagenesBase64 === 0 ? 'var(--success)' : 'var(--warning)'}; display: flex; align-items: center; gap: 10px; font-size: 1.2rem;">
            <span style="font-size: 1.4rem;"></span>
            <span>localStorage (Backup del navegador)</span>
          </h3>
          
          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
               <strong>Copia de seguridad automtica en el navegador.</strong> Guarda una copia de los datos (nombres, cdigos, precios, cantidades) como respaldo. Lmite: 5-10 MB. <strong>NO debe contener imgenes</strong> para evitar saturar el espacio.
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; text-align: center;">
              <div style="font-size: 1.8rem; font-weight: 700; color: var(--info);">${localStorageMB} MB</div>
              <div style="font-size: 0.85rem; color: var(--text-secondary);">Tamao usado</div>
              <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">Lmite: ~10 MB</div>
            </div>
            
            <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; text-align: center;">
              <div style="font-size: 1.8rem; font-weight: 700; color: ${imagenesBase64 === 0 ? 'var(--success)' : 'var(--danger)'};">${imagenesBase64}</div>
              <div style="font-size: 0.85rem; color: var(--text-secondary);">Imgenes base64</div>
              <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">Debe ser: 0</div>
            </div>
            
            <div style="background: ${imagenesBase64 === 0 ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 14px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 600; font-size: 0.95rem;">
              <div style="font-size: 1.8rem; margin-bottom: 6px;">${imagenesBase64 === 0 ? '' : ''}</div>
              <div>${imagenesBase64 === 0 ? 'LIMPIO' : 'Necesita limpieza'}</div>
            </div>
          </div>
          
          ${imagenesBase64 === 0 ? `
            <div style="margin-top: 12px; padding: 14px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid var(--success);">
              <div style="color: var(--success); font-weight: 600; margin-bottom: 6px;"> Estado ptimo</div>
              <div style="color: var(--text-secondary); font-size: 0.85rem;">
                Solo contiene datos esenciales (nombres, precios, cantidades). Las imgenes se cargan desde FileSystem, dejando el localStorage libre para su funcin de backup.
              </div>
            </div>
          ` : `
            <div style="margin-top: 12px; padding: 14px; background: rgba(199, 83, 0, 0.15); border-radius: 8px; border-left: 4px solid #C75300;">
              <div style="color: #C75300; font-weight: 600; margin-bottom: 6px;"> Requiere limpieza</div>
              <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 8px;">
                Contiene ${imagenesBase64} imgenes base64 obsoletas que ocupan espacio innecesario.
              </div>
              <div style="background: #334155; padding: 10px; border-radius: 6px; font-size: 0.85rem; color: #cbd5e1; border: 1px solid #475569;">
                <strong style="color: #e2e8f0;"> Solucin:</strong> Ve a <strong style="color: #C75300;">Configuracin  Herramientas Adicionales  Limpiar Imgenes localStorage</strong>
              </div>
            </div>
          `}
        </div>

        <!-- Resumen Final -->
        <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 24px; border-radius: 12px; text-align: center;">
          <h3 style="margin: 0 0 16px 0; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <span style="font-size: 1.6rem;"></span>
            <span>Resumen</span>
          </h3>
          
          <div style="display: grid; gap: 10px; text-align: left; font-size: 1rem;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 1.4rem;"></span>
              <span>Todas las referencias desde: <strong>${carpetaNombre}</strong></span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 1.4rem;"></span>
              <span>Imgenes: <strong>FileSystem (sin lmites)</strong></span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 1.4rem;"></span>
              <span>Datos: <strong>JSON + localStorage (backup)</strong></span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 1.4rem;"></span>
              <span>Sin referencias externas</span>
            </div>
          </div>
        </div>
      `;
      
      // Mostrar modal en lugar de alert
      document.getElementById('estadisticasContent').innerHTML = html;
      document.getElementById('modalEstadisticas').style.display = 'block';
      
    } catch (error) {
      console.error('Error obteniendo estadsticas:', error);
      app.showToast(' Error al obtener estadsticas', 'error');
    }
  },

  // Limpiar cach temporal
  async limpiarCacheTemporal() {
    const confirmacion = confirm(
      ' LIMPIAR CACH\n\n' +
      'Se eliminarn los datos temporales y cach del navegador.\n' +
      'Los datos del inventario NO se vern afectados.\n\n' +
      'Continuar?'
    );
    
    if (!confirmacion) return;
    
    try {
      // Limpiar localStorage temporal (mantener inventario)
      const inventarioBackup = localStorage.getItem('inventarioData');
      const fsBackup = localStorage.getItem('fsDirectory');
      const folderBackup = localStorage.getItem('fsFolderName');
      
      localStorage.clear();
      
      if (inventarioBackup) localStorage.setItem('inventarioData', inventarioBackup);
      if (fsBackup) localStorage.setItem('fsDirectory', fsBackup);
      if (folderBackup) localStorage.setItem('fsFolderName', folderBackup);
      
      app.showToast(' Cach limpiado correctamente', 'success');
    } catch (error) {
      console.error('Error limpiando cach:', error);
      app.showToast(' Error al limpiar cach', 'error');
    }
  },

  // Limpiar imgenes base64 del localStorage
  async limpiarImagenesLocalStorage() {
    const confirmacion = confirm(
      ' LIMPIAR IMGENES DE LOCALSTORAGE\n\n' +
      'Se eliminarn todas las imgenes base64 almacenadas en localStorage.\n' +
      'Esto liberar espacio y evitar conflictos.\n\n' +
      ' Los datos de repuestos NO se borrarn (nombres, precios, cantidades)\n' +
      ' Las imgenes de FileSystem NO se vern afectadas\n\n' +
      'Continuar?'
    );
    
    if (!confirmacion) return;
    
    try {
      const localData = localStorage.getItem('inventarioData');
      
      if (!localData) {
        app.showToast(' No hay datos en localStorage', 'info');
        return;
      }
      
      const data = JSON.parse(localData);
      let imagenesEliminadas = 0;
      let tamaoAntesKB = new Blob([localData]).size / 1024;
      
      // Limpiar imgenes base64 de cada repuesto
      data.forEach(item => {
        if (item.multimedia && item.multimedia.length > 0) {
          const multimediaLimpia = item.multimedia.filter(media => {
            const esBase64 = media.url && media.url.startsWith('data:image');
            if (esBase64) {
              imagenesEliminadas++;
              console.log(` Eliminada imagen base64 de: ${item.nombre}`);
            }
            return !esBase64; // Mantener solo rutas de FileSystem
          });
          
          item.multimedia = multimediaLimpia;
        }
      });
      
      // Guardar datos limpios
      const datosLimpios = JSON.stringify(data);
      localStorage.setItem('inventarioData', datosLimpios);
      
      const tamaoDespuesKB = new Blob([datosLimpios]).size / 1024;
      const espacioLiberadoKB = tamaoAntesKB - tamaoDespuesKB;
      
      const mensaje = 
        ` Limpieza completada:\n\n` +
        ` ${imagenesEliminadas} imgenes base64 eliminadas\n` +
        ` Tamao anterior: ${tamaoAntesKB.toFixed(2)} KB\n` +
        ` Tamao actual: ${tamaoDespuesKB.toFixed(2)} KB\n` +
        ` Espacio liberado: ${espacioLiberadoKB.toFixed(2)} KB\n\n` +
        ` Ahora solo se usan imgenes de FileSystem (sin lmites)`;
      
      alert(mensaje);
      app.showToast(` ${imagenesEliminadas} imgenes eliminadas - ${espacioLiberadoKB.toFixed(0)} KB liberados`, 'success');
      
    } catch (error) {
      console.error('Error limpiando localStorage:', error);
      app.showToast(' Error al limpiar localStorage: ' + error.message, 'error');
    }
  },

  // Vincular automticamente las imgenes de la carpeta a los repuestos
  async vincularImagenesAutomaticamente() {
    if (!fsManager.isFileSystemMode || !fsManager.imagesFolder) {
      app.showToast(' Primero debes seleccionar una carpeta', 'warning');
      return;
    }
    
    const confirmacion = confirm(
      ' REPARAR Y VINCULAR IMGENES\n\n' +
      'Esta funcin har lo siguiente:\n\n' +
      ' Detectar imgenes rotas (archivos que ya no existen)\n' +
      ' Buscar reemplazos automticos por nombre\n' +
      ' Vincular repuestos sin imgenes\n' +
      ' Usa timestamps para encontrar las versiones ms recientes\n\n' +
      ' INTELIGENTE: Busca coincidencias por nombre del repuesto\n\n' +
      'Continuar?'
    );
    
    if (!confirmacion) return;
    
    try {
      app.showToast(' Reparando y vinculando imgenes...', 'info');
      
      // Usar la nueva funcin de reparacin inteligente
      await app.repararImagenesRotas();
      
    } catch (error) {
      console.error(' Error:', error);
      app.showToast(' Error: ' + error.message, 'error');
    }
  },

  // ===================================================================
  // EXPORTAR HTML CON DATOS EMBEBIDOS (PARA SINCRONIZACIN MVIL)
  // ===================================================================
  
  async exportarHTMLConDatosEmbebidos() {
    try {
      console.log(' Exportando HTML con datos embebidos para mvil...');
      
      // 1. Obtener datos actuales SIN multimedia
      const datosParaMovil = app.repuestos.map(repuesto => {
        const { multimedia, ...repuestoSinMultimedia } = repuesto;
        return repuestoSinMultimedia;
      });
      
      console.log(` Preparando ${datosParaMovil.length} repuestos para mvil (sin imgenes)`);
      
      // 2. Leer el archivo HTML actual
      const response = await fetch(window.location.href);
      let htmlContent = await response.text();
      
      // 3. Crear el objeto EMBEDDED_DATA actualizado
      const embeddedDataString = `const EMBEDDED_DATA = {
  version: '1.0-mobile',
  lastUpdate: '${new Date().toISOString()}',
  platform: 'mobile-embedded',
  note: 'Datos sin multimedia - Solo texto y nmeros para mxima compatibilidad',
  repuestos: ${JSON.stringify(datosParaMovil, null, 2)}
};`;
      
      // 4. Reemplazar el EMBEDDED_DATA en el HTML
      const regex = /const EMBEDDED_DATA = \{[\s\S]*?\};/;
      if (regex.test(htmlContent)) {
        htmlContent = htmlContent.replace(regex, embeddedDataString);
        console.log(' EMBEDDED_DATA reemplazado correctamente');
      } else {
        console.error(' No se encontr EMBEDDED_DATA en el HTML');
        app.showToast(' Error: No se encontr EMBEDDED_DATA', 'error');
        return;
      }
      
      // 5. Crear Blob y descargar
      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const sizeMB = (blob.size / (1024 * 1024)).toFixed(2);
      
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inventario_MOVIL_${new Date().toISOString().split('T')[0]}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      const mensaje = 
        ` HTML para mvil exportado:\n\n` +
        ` ${datosParaMovil.length} repuestos incluidos\n` +
        ` Tamao: ${sizeMB} MB\n` +
        ` Fecha: ${new Date().toLocaleString('es-ES')}\n\n` +
        ` Para sincronizar:\n` +
        `1. Copia este HTML al mvil\n` +
        `2. brelo en Edge iOS\n` +
        `3. Listo! Vers todos los datos actualizados\n\n` +
        ` Las fotos NO se incluyen (solo datos)`;
      
      alert(mensaje);
      app.showToast(` HTML mvil exportado: ${datosParaMovil.length} repuestos`, 'success');
      
    } catch (error) {
      console.error('Error exportando HTML:', error);
      app.showToast(' Error al exportar HTML: ' + error.message, 'error');
    }
  },

  // ===================================================================
  // CONFIGURACIN DE RUTA ICLOUD DRIVE (PARA IPHONE)
  // ===================================================================
  
  // Guardar ruta predefinida de iCloud Drive
  saveICloudPath(path) {
    if (!path || path.trim() === '') {
      app.showToast(' Por favor ingresa un nombre de carpeta', 'warning');
      return;
    }
    
    const cleanPath = path.trim();
    localStorage.setItem('icloudImagePath', cleanPath);
    
    // Mostrar confirmacin
    const statusDiv = document.getElementById('icloud-path-status');
    if (statusDiv) {
      statusDiv.style.display = 'block';
      statusDiv.style.background = 'rgba(16, 185, 129, 0.1)';
      statusDiv.style.borderLeft = '4px solid var(--success)';
      statusDiv.style.color = 'var(--success)';
      statusDiv.innerHTML = `
        <strong> Ruta guardada:</strong><br>
        <code style="background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;">
          iCloud Drive/${cleanPath}/
        </code>
      `;
      
      // Ocultar despus de 5 segundos
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    app.showToast(` Ruta iCloud guardada: ${cleanPath}`, 'success');
    console.log(` Ruta iCloud configurada: ${cleanPath}`);
  },
  
  // Borrar ruta predefinida de iCloud Drive
  clearICloudPath() {
    localStorage.removeItem('icloudImagePath');
    
    const input = document.getElementById('icloudImagePath');
    if (input) {
      input.value = '';
    }
    
    const statusDiv = document.getElementById('icloud-path-status');
    if (statusDiv) {
      statusDiv.style.display = 'block';
      statusDiv.style.background = 'rgba(220, 38, 38, 0.1)';
      statusDiv.style.borderLeft = '4px solid var(--danger)';
      statusDiv.style.color = 'var(--danger)';
      statusDiv.innerHTML = `<strong> Ruta eliminada</strong>`;
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }
    
    app.showToast(' Ruta iCloud eliminada', 'info');
    console.log(' Ruta iCloud borrada');
  },
  
  // Obtener ruta predefinida de iCloud Drive
  getICloudPath() {
    return localStorage.getItem('icloudImagePath') || null;
  },
  
  // Cargar configuracin de ruta iCloud en el input
  loadICloudPathConfig() {
    const savedPath = this.getICloudPath();
    const input = document.getElementById('icloudImagePath');
    
    if (input && savedPath) {
      input.value = savedPath;
      console.log(` Ruta iCloud cargada: ${savedPath}`);
    }
  },

  // 
  //  SISTEMA DE BACKUP COMPLETO AUTOMTICO (TODO incluido)
  // 
  
  async crearBackupAutomatico() {
    if (!fsManager.isFileSystemMode || !fsManager.directoryHandle) {
  console.log('[WARN] Backup automtico omitido: No hay FileSystem activo');
      return null;
    }

    try {
      console.log(' Creando backup completo automtico...');
      
      // 1. Obtener/crear carpeta de backups
      const backupsDir = await fsManager.directoryHandle.getDirectoryHandle('backups', { create: true });
      const automaticosDir = await backupsDir.getDirectoryHandle('automaticos', { create: true });
      
      // 2. Obtener lista de backups existentes (ahora son CARPETAS)
      const backups = [];
      for await (const entry of automaticosDir.values()) {
        if (entry.kind === 'directory' && entry.name.startsWith('backup_')) {
          try {
            // Intentar leer datos.json para obtener timestamp
            const datosHandle = await entry.getDirectoryHandle().then(dir => dir.getFileHandle('datos.json', { create: false }));
            const file = await datosHandle.getFile();
            backups.push({
              name: entry.name,
              handle: entry,
              timestamp: file.lastModified
            });
          } catch (e) {
            // Si no tiene datos.json, es un backup corrupto - usar nombre de carpeta
            console.warn(` Backup sin datos.json: ${entry.name}`);
            backups.push({
              name: entry.name,
              handle: entry,
              timestamp: 0 // Lo marcamos como muy antiguo para eliminarlo
            });
          }
        }
      }
      
      // 3. Ordenar por fecha (ms antiguo primero)
      backups.sort((a, b) => a.timestamp - b.timestamp);
      
      // 4. Eliminar backups antiguos si hay 5 o ms (ahora solo elimina la CARPETA completa)
      while (backups.length >= 5) {
        const antiguo = backups.shift();
        try {
          await automaticosDir.removeEntry(antiguo.name, { recursive: true });
          console.log(` Backup completo eliminado: ${antiguo.name}`);
        } catch (e) {
          console.warn(` No se pudo eliminar backup: ${antiguo.name}`, e);
        }
      }
      
      // 5. Crear timestamp para el nuevo backup
      const ahora = new Date();
      const anio = ahora.getFullYear();
      const mes = String(ahora.getMonth() + 1).padStart(2, '0');
      const dia = String(ahora.getDate()).padStart(2, '0');
      const hora = String(ahora.getHours()).padStart(2, '0');
      const minutos = String(ahora.getMinutes()).padStart(2, '0');
      const segundos = String(ahora.getSeconds()).padStart(2, '0');
      const timestamp = `${anio}-${mes}-${dia}_${hora}-${minutos}-${segundos}`;
      const backupFolderName = `backup_${timestamp}`;
      
      // 6. Crear carpeta del backup
      const backupDir = await automaticosDir.getDirectoryHandle(backupFolderName, { create: true });
      console.log(` Carpeta de backup creada: ${backupFolderName}`);
      
      // 7. Obtener mapas y reas si existen
      let mapas = [];
      let areas = [];
      let totalMapas = 0;
      let totalAreas = 0;
      
      if (mapStorage && mapStorage.initialized) {
        try {
          mapas = await mapStorage.getMaps();
          areas = await mapStorage.getAreas();
          totalMapas = mapas.length;
          totalAreas = areas.length;
        } catch (error) {
          console.warn(' No se pudieron cargar mapas/reas:', error);
        }
      }
      
      // 8. Contar ubicaciones de repuestos en mapas
      let totalUbicaciones = 0;
      app.repuestos.forEach(r => {
        if (r.ubicaciones && Array.isArray(r.ubicaciones)) {
          totalUbicaciones += r.ubicaciones.length;
        }
      });
      
      // 9. Recopilar lista de imgenes USADAS (no copiar hurfanas)
      const imagenesUsadas = new Set();
      app.repuestos.forEach(r => {
        if (r.imagen) {
          // Extraer nombre de archivo de la ruta
          const nombreImg = r.imagen.split('/').pop();
          imagenesUsadas.add(nombreImg);
        }
        if (r.multimedia && Array.isArray(r.multimedia)) {
          r.multimedia.forEach(media => {
            if (media.url) {
              const nombreImg = media.url.split('/').pop();
              imagenesUsadas.add(nombreImg);
            }
          });
        }
      });
      
      const totalImagenes = imagenesUsadas.size;
      
      // 10. Crear backup completo con TODO
      const data = {
        timestamp: new Date().toISOString(),
        version: '5.3.2',
        tipo: 'BACKUP_COMPLETO',
        
        // Estadsticas
        estadisticas: {
          totalRepuestos: app.repuestos.length,
          totalMapas: totalMapas,
          totalAreas: totalAreas,
          totalUbicacionesEnMapas: totalUbicaciones,
          totalImagenes: totalImagenes
        },
        
        // Datos completos
        repuestos: app.repuestos,
        mapas: mapas,
        areas: areas,
        
        // Metadata adicional
        metadata: {
          navegador: navigator.userAgent,
          plataforma: navigator.platform,
          idioma: navigator.language
        }
      };
      
      // 11. Guardar datos.json dentro de la carpeta del backup
      const datosHandle = await backupDir.getFileHandle('datos.json', { create: true });
      const writable = await datosHandle.createWritable();
      await writable.write(JSON.stringify(data, null, 2));
      await writable.close();
      console.log(` datos.json creado`);
      
      // 12. COPIAR SOLO IMGENES USADAS al backup
      let imagenesCopied = 0;
      try {
        if (imagenesUsadas.size > 0) {
          // Crear subcarpeta imagenes/ dentro del backup
          const backupImgDir = await backupDir.getDirectoryHandle('imagenes', { create: true });
          
          // Obtener carpeta de imgenes original
          const imagenesDir = await fsManager.directoryHandle.getDirectoryHandle('imagenes', { create: false });
          
          // Copiar SOLO las imgenes que estn siendo usadas
          for (const nombreImagen of imagenesUsadas) {
            try {
              const originalHandle = await imagenesDir.getFileHandle(nombreImagen, { create: false });
              const originalFile = await originalHandle.getFile();
              
              const backupFileHandle = await backupImgDir.getFileHandle(nombreImagen, { create: true });
              const backupWritable = await backupFileHandle.createWritable();
              await backupWritable.write(await originalFile.arrayBuffer());
              await backupWritable.close();
              
              imagenesCopied++;
            } catch (imgError) {
              console.warn(` No se pudo copiar imagen: ${nombreImagen}`, imgError);
            }
          }
          
          console.log(` ${imagenesCopied}/${imagenesUsadas.size} imgenes copiadas al backup`);
        } else {
          console.log(` No hay imgenes para respaldar`);
        }
        
      } catch (imgError) {
        console.warn(' Error al copiar imgenes:', imgError);
        console.log(' El backup de datos se cre correctamente, pero sin imgenes');
      }
      
      console.log(` Backup COMPLETO creado en: ${backupFolderName}/`);
      console.log(` Contenido: ${data.estadisticas.totalRepuestos} repuestos, ${totalMapas} mapas, ${totalAreas} reas`);
      console.log(` Imgenes: ${imagenesCopied} archivos copiados`);
      console.log(` Total de backups: ${backups.length + 1}/5`);
      
      return backupFolderName; // Devolver nombre de la carpeta creada
      
    } catch (error) {
      console.error(' Error creando backup automtico:', error);
      return null;
    }
  },

  // Listar backups completos disponibles
  async listarBackups() {
    if (!fsManager.isFileSystemMode || !fsManager.directoryHandle) {
      app.showToast(' Primero debes seleccionar una carpeta', 'warning');
      return [];
    }

    try {
      const backupsDir = await fsManager.directoryHandle.getDirectoryHandle('backups', { create: true });
      const automaticosDir = await backupsDir.getDirectoryHandle('automaticos', { create: true });
      
      const backups = [];
      for await (const entry of automaticosDir.values()) {
        // Ahora buscamos CARPETAS que empiecen con backup_
        if (entry.kind === 'directory' && entry.name.startsWith('backup_')) {
          try {
            // Leer datos.json de dentro de la carpeta
            const backupDir = await automaticosDir.getDirectoryHandle(entry.name);
            const datosHandle = await backupDir.getFileHandle('datos.json', { create: false });
            const file = await datosHandle.getFile();
            const data = JSON.parse(await file.text());
            
            // Extraer estadsticas del backup completo
            const stats = data.estadisticas || {};
            
            backups.push({
              name: entry.name,
              handle: backupDir, //  FIX: Usar backupDir en lugar de entry
              timestamp: file.lastModified,
              fecha: new Date(file.lastModified).toLocaleString('es-ES'),
              size: (file.size / 1024).toFixed(2) + ' KB',
              
              // Datos completos
              totalRepuestos: stats.totalRepuestos || data.totalRepuestos || data.repuestos?.length || 0,
              totalMapas: stats.totalMapas || 0,
              totalAreas: stats.totalAreas || 0,
              totalUbicaciones: stats.totalUbicacionesEnMapas || 0,
              totalImagenes: stats.totalImagenes || 0,
              
              version: data.version || 'N/A',
              tipo: data.tipo || 'BACKUP'
            });
          } catch (e) {
            console.warn(` No se pudo leer backup: ${entry.name}`, e);
          }
        }
      }
      
      // Ordenar por fecha (ms reciente primero)
      backups.sort((a, b) => b.timestamp - a.timestamp);
      
      return backups;
      
    } catch (error) {
      console.error(' Error listando backups:', error);
      return [];
    }
  },

  // Restaurar desde backup completo
  async restaurarBackup(backupHandle) {
    try {
      // backupHandle ahora es un DirectoryHandle de la carpeta backup_TIMESTAMP
      const backupDir = backupHandle; //  FIX: Usar directamente el handle recibido
      
      // Leer datos.json de dentro de la carpeta
      const datosHandle = await backupDir.getFileHandle('datos.json', { create: false });
      const file = await datosHandle.getFile();
      const data = JSON.parse(await file.text());
      
      //  DEBUG: Ver qu trae el backup
      console.log(' DATOS DEL BACKUP:', {
        totalRepuestos: data.repuestos?.length || 0,
        totalMapas: data.mapas?.length || 0,
        totalAreas: data.areas?.length || 0,
        estadisticas: data.estadisticas
      });
      
      // Contar ubicaciones en el backup
      let ubicacionesEnBackup = 0;
      if (data.repuestos) {
        data.repuestos.forEach(r => {
          if (r.ubicaciones && Array.isArray(r.ubicaciones)) {
            const validas = r.ubicaciones.filter(ub => 
              ub.mapId && ub.markerX !== undefined && ub.markerY !== undefined
            );
            if (validas.length > 0) {
              console.log(` BACKUP: "${r.nombre}" -> ${validas.length} ubicaciones`, validas);
            }
            ubicacionesEnBackup += validas.length;
          }
        });
      }
      console.log(` TOTAL ubicaciones en backup: ${ubicacionesEnBackup}`);
      
      const stats = data.estadisticas || {};
      
      const confirmacion = confirm(
        ` RESTAURAR BACKUP COMPLETO\n\n` +
        ` Backup: ${backupHandle.name}\n` +
        ` Fecha: ${new Date(file.lastModified).toLocaleString('es-ES')}\n` +
        ` Repuestos: ${stats.totalRepuestos || data.repuestos?.length || 0}\n` +
        ` Mapas: ${stats.totalMapas || 0}\n` +
        ` reas: ${stats.totalAreas || 0}\n` +
        ` Ubicaciones en mapas: ${stats.totalUbicaciones || 0}\n` +
        ` Imgenes: ${stats.totalImagenes || 0}\n` +
        ` Versin: ${data.version || 'N/A'}\n\n` +
        ` Esto reemplazar TODOS los datos actuales (repuestos, mapas, reas, imgenes).\n\n` +
        `Continuar con la restauracin completa?`
      );
      
      if (!confirmacion) return;
      
      // Restaurar repuestos
      app.repuestos = data.repuestos || [];
      
      //  DEBUG: Contar ubicaciones ANTES de guardar
      let ubicacionesAntesSave = 0;
      app.repuestos.forEach(r => {
        if (r.ubicaciones && Array.isArray(r.ubicaciones)) {
          const ubicValidas = r.ubicaciones.filter(ub => 
            ub.mapId && ub.markerX !== undefined && ub.markerY !== undefined
          );
          if (ubicValidas.length > 0) {
            console.log(` Repuesto "${r.nombre}" tiene ${ubicValidas.length} ubicaciones:`, ubicValidas);
          }
          ubicacionesAntesSave += ubicValidas.length;
        }
      });
      console.log(` ANTES de saveData(): ${ubicacionesAntesSave} ubicaciones en repuestos`);
      
      await app.saveData();
      
      //  DEBUG: Contar ubicaciones DESPUS de guardar
      let ubicacionesDespuesSave = 0;
      app.repuestos.forEach(r => {
        if (r.ubicaciones && Array.isArray(r.ubicaciones)) {
          const ubicValidas = r.ubicaciones.filter(ub => 
            ub.mapId && ub.markerX !== undefined && ub.markerY !== undefined
          );
          ubicacionesDespuesSave += ubicValidas.length;
        }
      });
      console.log(` DESPUS de saveData(): ${ubicacionesDespuesSave} ubicaciones en repuestos`);
      
      // Restaurar mapas y reas si existen
      if (mapStorage && mapStorage.initialized) {
        if (data.mapas && Array.isArray(data.mapas)) {
          await mapStorage.saveMaps(data.mapas, { action: 'restore_backup', detail: 'Restauracin desde backup' });
          console.log(` ${data.mapas.length} mapas restaurados`);
        }
        
        if (data.areas && Array.isArray(data.areas)) {
          await mapStorage.saveAreas(data.areas, { action: 'restore_backup', detail: 'Restauracin desde backup' });
          console.log(` ${data.areas.length} reas restauradas`);
        }
      }
      
      // RESTAURAR IMGENES desde la subcarpeta imagenes/ del backup
      let imagenesRestauradas = 0;
      try {
        // Intentar obtener subcarpeta imagenes/ del backup
        const backupImgDir = await backupDir.getDirectoryHandle('imagenes', { create: false });
        
        // Obtener/crear carpeta de imgenes destino
        const imagenesDir = await fsManager.directoryHandle.getDirectoryHandle('imagenes', { create: true });
        
        // Copiar todas las imgenes del backup a la carpeta actual
        for await (const entry of backupImgDir.values()) {
          if (entry.kind === 'file') {
            try {
              const backupFile = await entry.getFile();
              const destFileHandle = await imagenesDir.getFileHandle(entry.name, { create: true });
              const destWritable = await destFileHandle.createWritable();
              await destWritable.write(await backupFile.arrayBuffer());
              await destWritable.close();
              imagenesRestauradas++;
            } catch (imgError) {
              console.warn(` No se pudo restaurar imagen: ${entry.name}`, imgError);
            }
          }
        }
        
        console.log(` ${imagenesRestauradas} imgenes restauradas`);
      } catch (imgError) {
        console.warn(' No se pudieron restaurar las imgenes:', imgError);
        console.log(' El backup de datos se restaur correctamente, pero sin imgenes');
      }
      
      await app.render();
      app.renderFilters();
      app.updateAutocompleteData();
      
      //  FIX: Recargar mapas en el controlador despus de restaurar
      if (mapController && typeof mapController.loadData === 'function') {
        await mapController.loadData({ force: true });
        console.log(' Mapas recargados en el controlador');
      }
      
      //  Contar ubicaciones reales restauradas
      let ubicacionesRestauradas = 0;
      app.repuestos.forEach(r => {
        if (r.ubicaciones && Array.isArray(r.ubicaciones)) {
          ubicacionesRestauradas += r.ubicaciones.filter(ub => 
            ub.mapId && ub.markerX !== undefined && ub.markerY !== undefined
          ).length;
        }
      });
      
      const mensaje = ` Backup completo restaurado:\n` +
        ` ${stats.totalRepuestos || 0} repuestos\n` +
        ` ${stats.totalMapas || 0} mapas\n` +
        ` ${stats.totalAreas || 0} reas\n` +
        ` ${ubicacionesRestauradas} ubicaciones en mapas\n` +
        ` ${imagenesRestauradas} imgenes restauradas`;
      
      app.showToast(mensaje, 'success', 8000);
      
    } catch (error) {
      console.error(' Error restaurando backup:', error);
      app.showToast(' Error al restaurar backup: ' + error.message, 'error');
    }
  },

  // Funcin auxiliar para mostrar modal de detalles
  mostrarModal(contenidoHTML) {
    const modal = document.getElementById('modalDetalles');
    const contenido = document.getElementById('modalDetallesContenido');
    
    if (!modal || !contenido) {
      console.error(' Modal de detalles no encontrado');
      return false;
    }
    
    contenido.innerHTML = contenidoHTML;
    modal.style.display = 'block';
    return true;
  },

  // Funcin auxiliar para cerrar modal de detalles
  cerrarModal() {
    const modal = document.getElementById('modalDetalles');
    if (modal) {
      modal.style.display = 'none';
    }
  },

  // Descargar ltimo ZIP al navegador (Downloads)
  async descargarUltimoZip(filename) {
    try {
      const backupsDir = await fsManager.directoryHandle.getDirectoryHandle('backups', { create: false });
      const zipDir = await backupsDir.getDirectoryHandle('zip', { create: false });
      
      const fileHandle = await zipDir.getFileHandle(filename, { create: false });
      const file = await fileHandle.getFile();
      
      // Crear link de descarga
      const url = URL.createObjectURL(file);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      app.showToast(` Descargando ${filename} a la carpeta Downloads del navegador...`, 'success', 4000);
      this.cerrarModal();
      
    } catch (error) {
      console.error('Error descargando ZIP:', error);
      app.showToast(' Error al descargar el archivo ZIP', 'error');
    }
  },

  // Mostrar barra de progreso para PDF
  mostrarProgresoPDF(porcentaje, mensaje) {
    const modal = document.getElementById('modalDetalles');
    const contenido = document.getElementById('modalDetallesContenido');
    
    if (!modal || !contenido) return;
    
    const html = `
      <div class="modal-content" style="max-width: 500px; text-align: center;">
        <h3 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center; gap: 10px; justify-content: center;">
          <span style="font-size: 32px;"></span>
          <span>Generando PDF</span>
        </h3>
        
        <div style="margin: 20px 0;">
          <div style="font-size: 48px; font-weight: bold; color: #2196F3; margin-bottom: 10px;">
            ${Math.round(porcentaje)}%
          </div>
          <div style="color: #666; font-size: 14px; margin-bottom: 20px;">
            ${mensaje}
          </div>
        </div>
        
        <div style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; position: relative;">
          <div style="height: 100%; background: linear-gradient(90deg, #2196F3, #1976D2); width: ${porcentaje}%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
            <span style="color: white; font-size: 12px; font-weight: bold; position: absolute; width: 100%; text-align: center;">
              ${Math.round(porcentaje)}%
            </span>
          </div>
        </div>
        
        <div style="margin-top: 20px; padding: 12px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #2196F3;">
          <p style="margin: 0; font-size: 13px; color: #0d47a1;">
             Por favor espera... Este proceso puede tardar varios minutos dependiendo de la cantidad de repuestos e imgenes.
          </p>
        </div>
      </div>
    `;
    
    contenido.innerHTML = html;
    modal.style.display = 'flex';
  },

  // Mostrar modal de gestin de backups
  async mostrarGestionBackups() {
    const backups = await this.listarBackups();
    
    let html = `
      <div style="max-height: 400px; overflow-y: auto;">
        <h3 style="margin: 0 0 16px 0; color: var(--primary);">
           Historial de Backups (${backups.length}/5)
        </h3>
    `;
    
    if (backups.length === 0) {
      html += `
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
          <div style="font-size: 3rem; margin-bottom: 16px;"></div>
          <p>No hay backups disponibles</p>
          <p style="font-size: 0.9rem; margin-top: 8px;">
            Los backups se crean automticamente al guardar cambios
          </p>
        </div>
      `;
    } else {
      backups.forEach((backup, index) => {
        html += `
          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--primary);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div style="flex: 1;">
                <strong style="color: var(--text-primary);">${backup.name}</strong>
                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">
                   ${backup.fecha}
                </div>
              </div>
              <span style="background: var(--primary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; white-space: nowrap;">
                ${index === 0 ? ' Reciente' : `#${index + 1}`}
              </span>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 10px; font-size: 0.8rem;">
              <div style="background: rgba(59, 130, 246, 0.1); padding: 6px; border-radius: 4px; text-align: center;">
                <div style="color: var(--text-secondary); font-size: 0.7rem;"> Repuestos</div>
                <div style="color: var(--primary); font-weight: 600;">${backup.totalRepuestos}</div>
              </div>
              <div style="background: rgba(16, 185, 129, 0.1); padding: 6px; border-radius: 4px; text-align: center;">
                <div style="color: var(--text-secondary); font-size: 0.7rem;"> Mapas</div>
                <div style="color: #10b981; font-weight: 600;">${backup.totalMapas}</div>
              </div>
              <div style="background: rgba(245, 158, 11, 0.1); padding: 6px; border-radius: 4px; text-align: center;">
                <div style="color: var(--text-secondary); font-size: 0.7rem;"> reas</div>
                <div style="color: #f59e0b; font-weight: 600;">${backup.totalAreas}</div>
              </div>
              <div style="background: rgba(139, 92, 246, 0.1); padding: 6px; border-radius: 4px; text-align: center;">
                <div style="color: var(--text-secondary); font-size: 0.7rem;"> Ubicaciones</div>
                <div style="color: #8b5cf6; font-weight: 600;">${backup.totalUbicaciones}</div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 10px;">
              <span> ${backup.size}</span>
              <span> ${backup.totalImagenes} imgenes</span>
              <span> v${backup.version}</span>
            </div>
            
            <button onclick="configuracion.restaurarBackupPorIndice(${index})" 
                    class="btn btn-primary" 
                    style="width: 100%; padding: 10px; font-size: 0.9rem;">
               Restaurar Este Backup Completo
            </button>
          </div>
        `;
      });
    }
    
    html += `
      </div>
      <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
        <button onclick="configuracion.crearBackupManual()" 
                class="btn btn-success" 
                style="width: 100%; padding: 12px;">
           Crear Backup Manual Ahora
        </button>
      </div>
    `;
    
    this.mostrarModal(html);
  },

  // Crear backup manual
  async crearBackupManual() {
    const backupName = await this.crearBackupAutomatico();
    
    if (backupName) {
      const rutaBackup = `INVENTARIO_STORAGE/backups/automaticos/${backupName}`;
      
      // Obtener estadsticas del ltimo backup
      const backups = await this.listarBackups();
      const ultimoBackup = backups[0]; // El ms reciente
      
      // Mostrar modal con informacin del backup
      const html = `
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 3rem; margin-bottom: 16px;"></div>
          <h3 style="color: var(--success); margin-bottom: 16px;">Backup Completo Creado</h3>
          
          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin: 20px 0; text-align: left;">
            <div style="margin-bottom: 12px;">
              <strong style="color: var(--text-primary);"> Ruta:</strong>
              <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 6px; font-family: monospace; font-size: 0.85rem; color: var(--primary); word-break: break-all;">
                ${rutaBackup}
              </div>
            </div>
            
            <div style="margin-bottom: 12px;">
              <strong style="color: var(--text-primary);"> Fecha:</strong>
              <div style="color: var(--text-secondary); margin-top: 4px;">
                ${new Date().toLocaleString('es-ES')}
              </div>
            </div>
            
            ${ultimoBackup ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
              <strong style="color: var(--text-primary); display: block; margin-bottom: 12px;"> Contenido del Backup:</strong>
              
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                <div style="background: rgba(59, 130, 246, 0.15); padding: 10px; border-radius: 6px; text-align: center;">
                  <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 4px;"> Repuestos</div>
                  <div style="color: var(--primary); font-weight: 700; font-size: 1.2rem;">${ultimoBackup.totalRepuestos}</div>
                </div>
                
                <div style="background: rgba(16, 185, 129, 0.15); padding: 10px; border-radius: 6px; text-align: center;">
                  <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 4px;"> Mapas</div>
                  <div style="color: #10b981; font-weight: 700; font-size: 1.2rem;">${ultimoBackup.totalMapas}</div>
                </div>
                
                <div style="background: rgba(245, 158, 11, 0.15); padding: 10px; border-radius: 6px; text-align: center;">
                  <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 4px;"> reas</div>
                  <div style="color: #f59e0b; font-weight: 700; font-size: 1.2rem;">${ultimoBackup.totalAreas}</div>
                </div>
                
                <div style="background: rgba(139, 92, 246, 0.15); padding: 10px; border-radius: 6px; text-align: center;">
                  <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 4px;"> Ubicaciones</div>
                  <div style="color: #8b5cf6; font-weight: 700; font-size: 1.2rem;">${ultimoBackup.totalUbicaciones}</div>
                </div>
              </div>
              
              <div style="margin-top: 10px; text-align: center; font-size: 0.85rem; color: var(--text-secondary);">
                 ${ultimoBackup.totalImagenes} imgenes   ${ultimoBackup.size}
              </div>
            </div>
            ` : ''}
          </div>
          
          <div style="display: grid; gap: 10px; margin-top: 20px;">
            <button onclick="configuracion.abrirCarpetaBackups()" class="btn btn-primary" style="width: 100%; padding: 12px;">
               Ir a Ver Carpeta de Backups
            </button>
            
            <button onclick="configuracion.cerrarModal()" class="btn btn-secondary" style="width: 100%; padding: 12px;">
              Cerrar
            </button>
          </div>
        </div>
      `;
      
      this.mostrarModal(html);
    } else {
      app.showToast(' No se pudo crear el backup. Verifica que FileSystem est conectado.', 'warning');
    }
  },

  // Abrir carpeta de backups en el explorador de archivos
  async abrirCarpetaBackups() {
    try {
      if (!fsManager.isFileSystemMode || !fsManager.directoryHandle) {
        app.showToast(' FileSystem no est activo', 'warning');
        return;
      }

      // Obtener la ruta de la carpeta base
      const carpetaBase = fsManager.directoryHandle.name || 'INVENTARIO_STORAGE';
      const rutaCompleta = `${carpetaBase}\\backups\\automaticos`;
      
      // Mostrar modal con instrucciones detalladas
      const html = `
        <div class="modal-content" style="max-width: 500px;">
          <h3 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
             <span>Ubicacin de Backups Automticos</span>
          </h3>
          
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <p style="margin: 0 0 10px 0; font-weight: bold; color: #495057;">Ruta completa:</p>
            <code style="display: block; padding: 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; word-break: break-all; font-size: 13px;">
              ${rutaCompleta}
            </code>
          </div>
          
          <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
            <p style="margin: 0 0 10px 0; font-weight: bold; color: #1976D2;"> Cmo llegar?</p>
            <ol style="margin: 0; padding-left: 20px; color: #495057; font-size: 14px;">
              <li>Abre el Explorador de Archivos (Windows + E)</li>
              <li>Navega a la carpeta donde est INVENTARIO_STORAGE</li>
              <li>Entra en: <strong>backups  automaticos</strong></li>
            </ol>
          </div>
          
          <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ffc107;">
            <p style="margin: 0; font-size: 13px; color: #856404;">
               <strong>Nota:</strong> Por seguridad, los navegadores no permiten abrir carpetas automticamente.
              Debes navegar manualmente usando el Explorador de Archivos.
            </p>
          </div>
          
          <div style="margin-top: 20px;">
            <button onclick="configuracion.cerrarModal()" class="btn btn-primary" style="width: 100%; padding: 12px;">
              Entendido
            </button>
          </div>
        </div>
      `;
      
      this.mostrarModal(html);
      
    } catch (error) {
      console.error('Error:', error);
      app.showToast(' Navega manualmente a: INVENTARIO_STORAGE\\backups\\automaticos', 'warning', 5000);
    }
  },

  // Variable temporal para almacenar lista de backups
  _backupsCache: [],

  async restaurarBackupPorIndice(index) {
    const backups = await this.listarBackups();
    if (backups[index]) {
      await this.restaurarBackup(backups[index].handle);
      this.cerrarModal();
    }
  },

  // 
  //  EXPORTACIN A PDF CON JERARQUAS Y FOTOS
  // 
  
  mostrarOpcionesPDF() {
    const html = `
      <div class="modal-content" style="max-width: 600px;">
        <h3 style="margin: 0 0 20px 0; color: #2c3e50;"> Exportar Inventario a PDF</h3>
        
        <div style="display: flex; flex-direction: column; gap: 16px;">
          
          <!-- Exportacin por jerarqua (nica opcin) -->
          <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; border: 2px solid var(--primary);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
              <span style="font-weight: 600; color: var(--text-primary); font-size: 1.1rem;"> Exportar por Nivel Jerrquico</span>
            </div>
            <p style="margin: 0 0 16px 0; font-size: 0.85rem; color: var(--text-secondary);">
              Selecciona la planta/empresa y opcionalmente profundiza en niveles especficos
            </p>
            
            <!-- Selectores de jerarqua (siempre visibles) -->
            <div id="jerarquiaSelectors">
              <div style="display: flex; flex-direction: column; gap: 10px;">
                
                <!-- Nivel 1: Planta/Empresa -->
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
                     Planta/Empresa <span style="color: #e74c3c;">*</span>
                  </label>
                  <select id="nivel_planta" onchange="configuracion.actualizarNivelesJerarquia(1)" class="form-control" style="width: 100%;">
                    <option value="">-- Seleccionar Planta --</option>
                  </select>
                </div>
                
                <!-- Nivel 2: rea General -->
                <div id="container_areaGeneral" style="display: none;">
                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
                    1 rea General
                  </label>
                  <select id="nivel_areaGeneral" onchange="configuracion.actualizarNivelesJerarquia(2)" class="form-control" style="width: 100%;">
                    <option value="">-- Todas (detener aqu) --</option>
                  </select>
                </div>
                
                <!-- Nivel 3: Sub-rea -->
                <div id="container_subArea" style="display: none;">
                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
                    2 Sub-rea
                  </label>
                  <select id="nivel_subArea" onchange="configuracion.actualizarNivelesJerarquia(3)" class="form-control" style="width: 100%;">
                    <option value="">-- Todas (detener aqu) --</option>
                  </select>
                </div>
                
                <!-- Nivel 4: Sistema/Equipo -->
                <div id="container_sistemaEquipo" style="display: none;">
                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
                    3 Sistema/Equipo
                  </label>
                  <select id="nivel_sistemaEquipo" onchange="configuracion.actualizarNivelesJerarquia(4)" class="form-control" style="width: 100%;">
                    <option value="">-- Todos (detener aqu) --</option>
                  </select>
                </div>
                
                <!-- Nivel 5: Sub-Sistema -->
                <div id="container_subSistema" style="display: none;">
                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
                    4 Sub-Sistema
                  </label>
                  <select id="nivel_subSistema" onchange="configuracion.actualizarNivelesJerarquia(5)" class="form-control" style="width: 100%;">
                    <option value="">-- Todos (detener aqu) --</option>
                  </select>
                </div>
                
                <!-- Nivel 6: Seccin -->
                <div id="container_seccion" style="display: none;">
                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
                    5 Seccin
                  </label>
                  <select id="nivel_seccion" class="form-control" style="width: 100%;">
                    <option value="">-- Todas (detener aqu) --</option>
                  </select>
                </div>
                
              </div>
              
              <!-- Opciones adicionales -->
              <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                  <input type="checkbox" id="incluirArbolJerarquico" checked style="width: 16px; height: 16px;">
                  <span style="font-size: 0.9rem;"> Incluir rbol jerrquico en pgina 1</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="agruparPorNiveles" checked style="width: 16px; height: 16px;">
                  <span style="font-size: 0.9rem;"> Agrupar repuestos por niveles</span>
                </label>
              </div>
              
              <!-- Vista previa de conteo -->
              <div id="previewConteo" style="display: none; margin-top: 12px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid var(--primary);">
                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                  <strong style="color: var(--primary);">Vista previa:</strong><br>
                  <span id="conteoRepuestos">0 repuestos</span> sern exportados
                </div>
              </div>
            </div>
          </div>
          
          <!-- Botones de accin -->
          <div style="display: flex; gap: 10px; margin-top: 8px;">
            <button onclick="configuracion.ejecutarExportPDF()" class="btn btn-success" style="flex: 1; padding: 12px; font-weight: 600;">
               Exportar PDF
            </button>
            <button onclick="configuracion.cerrarModal()" class="btn btn-secondary" style="padding: 12px 20px;">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    `;
    
    this.mostrarModal(html);
    
    // Inicializar primer nivel (Planta/Empresa)
    this.cargarOpcionesNivel('planta', null);
  },
  
  // Toggle para mostrar/ocultar opciones de jerarqua (ya no se usa, siempre visible)
  toggleExportOptions(tipo) {
    // Funcin deprecada - los selectores ahora siempre estn visibles
  },
  
  // Cargar opciones para un nivel especfico
  cargarOpcionesNivel(campo, filtros = {}) {
    const select = document.getElementById(`nivel_${campo}`);
    if (!select) return;
    
    // Obtener valores nicos para este campo
    const valores = new Set();
    app.repuestos.forEach(r => {
      // Aplicar filtros de niveles superiores
      let cumpleFiltros = true;
      for (const [key, value] of Object.entries(filtros || {})) {
        if (value && r[key] !== value) {
          cumpleFiltros = false;
          break;
        }
      }
      
      if (cumpleFiltros && r[campo]) {
        valores.add(r[campo]);
      }
    });
    
    // Limpiar y llenar select
    select.innerHTML = campo === 'areaGeneral' 
      ? '<option value="">-- Seleccionar --</option>'
      : '<option value="">-- Todos (detener aqu) --</option>';
    
    Array.from(valores).sort().forEach(valor => {
      const option = document.createElement('option');
      option.value = valor;
      option.textContent = valor;
      select.appendChild(option);
    });
  },
  
  // Actualizar niveles jerrquicos al cambiar seleccin
  actualizarNivelesJerarquia(nivelActual) {
    const mapaNiveles = {
      1: { campo: 'planta', siguiente: 'areaGeneral', container: 'container_areaGeneral' },
      2: { campo: 'areaGeneral', siguiente: 'subArea', container: 'container_subArea' },
      3: { campo: 'subArea', siguiente: 'sistemaEquipo', container: 'container_sistemaEquipo' },
      4: { campo: 'sistemaEquipo', siguiente: 'subSistema', container: 'container_subSistema' },
      5: { campo: 'subSistema', siguiente: 'seccion', container: 'container_seccion' }
    };
    
    const nivel = mapaNiveles[nivelActual];
    if (!nivel) return;
    
    const valorSeleccionado = document.getElementById(`nivel_${nivel.campo}`).value;
    
    // Construir filtros acumulados
    const filtros = {};
    if (nivelActual >= 1) filtros.planta = document.getElementById('nivel_planta').value;
    if (nivelActual >= 2) filtros.areaGeneral = document.getElementById('nivel_areaGeneral').value;
    if (nivelActual >= 3) filtros.subArea = document.getElementById('nivel_subArea').value;
    if (nivelActual >= 4) filtros.sistemaEquipo = document.getElementById('nivel_sistemaEquipo').value;
    if (nivelActual >= 5) filtros.subSistema = document.getElementById('nivel_subSistema').value;
    
    // Mostrar siguiente nivel si hay valor seleccionado
    const siguienteContainer = document.getElementById(nivel.container);
    if (valorSeleccionado) {
      siguienteContainer.style.display = 'block';
      this.cargarOpcionesNivel(nivel.siguiente, filtros);
    } else {
      // Ocultar niveles siguientes
      siguienteContainer.style.display = 'none';
      if (nivelActual < 5) {
        const siguienteNivel = mapaNiveles[nivelActual + 1];
        if (siguienteNivel) {
          document.getElementById(siguienteNivel.container).style.display = 'none';
        }
      }
    }
    
    // Actualizar conteo de repuestos
    this.actualizarConteoPreview();
  },
  
  // Actualizar conteo de repuestos que sern exportados
  actualizarConteoPreview() {
    const previewDiv = document.getElementById('previewConteo');
    const conteoSpan = document.getElementById('conteoRepuestos');
    
    if (!previewDiv || !conteoSpan) return;
    
    // Obtener filtros seleccionados
    const filtros = {};
    const planta = document.getElementById('nivel_planta').value;
    if (planta) {
      filtros.planta = planta;
      
      const areaGeneral = document.getElementById('nivel_areaGeneral').value;
      if (areaGeneral) {
        filtros.areaGeneral = areaGeneral;
        
        const subArea = document.getElementById('nivel_subArea').value;
        if (subArea) {
          filtros.subArea = subArea;
          
          const sistemaEquipo = document.getElementById('nivel_sistemaEquipo').value;
          if (sistemaEquipo) {
            filtros.sistemaEquipo = sistemaEquipo;
            
            const subSistema = document.getElementById('nivel_subSistema').value;
            if (subSistema) {
              filtros.subSistema = subSistema;
              
              const seccion = document.getElementById('nivel_seccion').value;
              if (seccion) {
                filtros.seccion = seccion;
              }
            }
          }
        }
      }
    }
    
    // Contar repuestos que cumplen filtros
    let count = 0;
    app.repuestos.forEach(r => {
      let cumple = true;
      for (const [key, value] of Object.entries(filtros)) {
        if (value && r[key] !== value) {
          cumple = false;
          break;
        }
      }
      if (cumple) count++;
    });
    
    if (Object.keys(filtros).length > 0) {
      previewDiv.style.display = 'block';
      conteoSpan.textContent = `${count} repuesto${count !== 1 ? 's' : ''}`;
    } else {
      previewDiv.style.display = 'none';
    }
  },
  
  // Ejecutar exportacin segn opciones seleccionadas
  async ejecutarExportPDF() {
    // Validar que se haya seleccionado al menos la planta
    const planta = document.getElementById('nivel_planta').value;
    
    if (!planta) {
      app.showToast(' Selecciona al menos una Planta/Empresa', 'warning');
      return;
    }
    
    // Construir filtros de exportacin
    const filtros = {};
    filtros.planta = planta;
    
    const areaGeneral = document.getElementById('nivel_areaGeneral').value;
    if (areaGeneral) {
      filtros.areaGeneral = areaGeneral;
      
      const subArea = document.getElementById('nivel_subArea').value;
      if (subArea) {
        filtros.subArea = subArea;
        
        const sistemaEquipo = document.getElementById('nivel_sistemaEquipo').value;
        if (sistemaEquipo) {
          filtros.sistemaEquipo = sistemaEquipo;
          
          const subSistema = document.getElementById('nivel_subSistema').value;
          if (subSistema) {
            filtros.subSistema = subSistema;
            
            const seccion = document.getElementById('nivel_seccion').value;
            if (seccion) {
              filtros.seccion = seccion;
            }
          }
        }
      }
    }
    
    // Opciones adicionales
    const incluirArbol = document.getElementById('incluirArbolJerarquico').checked;
    const agruparNiveles = document.getElementById('agruparPorNiveles').checked;
    
    this.cerrarModal();
    await this.exportarPDFJerarquico(filtros, incluirArbol, agruparNiveles);
  },
  
  async exportarPDFJerarquico(filtros, incluirArbol, agruparNiveles) {
    // Filtrar repuestos segn jerarqua seleccionada
    const repuestosFiltrados = app.repuestos.filter(r => {
      for (const [key, value] of Object.entries(filtros)) {
        if (value && r[key] !== value) {
          return false;
        }
      }
      return true;
    });
    
    if (repuestosFiltrados.length === 0) {
      app.showToast(' No hay repuestos en esta jerarqua', 'warning');
      return;
    }
    
    // Llamar a exportacin con opciones especiales
    await this.exportarPDFCompleto(filtros, repuestosFiltrados, incluirArbol, agruparNiveles);
  },
  
  async exportarPDFPorArea(areaNombre) {
    // Filtrar repuestos del rea seleccionada
    const repuestosFiltrados = app.repuestos.filter(r => r.area === areaNombre);
    
    if (repuestosFiltrados.length === 0) {
      app.showToast(` No hay repuestos en el rea: ${areaNombre}`, 'error');
      return;
    }
    
    console.log(` Exportando PDF del rea: ${areaNombre} (${repuestosFiltrados.length} repuestos)`);
    
    // Exportar PDF con los repuestos filtrados
    await this.exportarPDFCompleto(areaNombre, repuestosFiltrados);
  },
  
  async exportarPDFCompleto(filtrosJerarquia = null, repuestosFiltrados = null, incluirArbol = false, agruparNiveles = false) {
    if (!window.jspdf || !window.jspdf.jsPDF) {
      app.showToast(' Error: Librera jsPDF no cargada', 'error');
      return;
    }

    try {
      console.log(' Iniciando generacin de PDF...');
      console.log(' Parmetros recibidos:', { filtrosJerarquia, repuestosFiltrados: repuestosFiltrados?.length || 0, incluirArbol, agruparNiveles });
      
      //  VERIFICAR Y CONFIGURAR SISTEMA DE IMGENES
      console.log(' Estado del FileSystem:');
      console.log('   - isFileSystemMode:', fsManager.isFileSystemMode);
      console.log('   - directoryHandle:', !!fsManager.directoryHandle);
      console.log('   - imagesFolder:', !!fsManager.imagesFolder);
      
      //  ADVERTENCIA si NO est en modo FileSystem
      if (!fsManager.isFileSystemMode || !fsManager.directoryHandle) {
        console.error(' ADVERTENCIA: Sistema de archivos NO conectado');
        console.error(' Las imgenes NO se cargarn en el PDF');
        
        const conectar = confirm(
          ' SISTEMA DE ARCHIVOS NO CONECTADO\n\n' +
          'No has conectado la carpeta INVENTARIO_STORAGE.\n' +
          'Las imgenes NO aparecern en el PDF (solo placeholders).\n\n' +
          'Deseas conectar la carpeta ahora antes de exportar el PDF?'
        );
        
        if (conectar) {
          try {
            console.log(' Solicitando acceso a carpeta...');
            await fsManager.requestDirectoryAccess();
            console.log(' FileSystem conectado exitosamente');
            
            // Reintentar la exportacin ahora que est conectado
            console.log(' Reintentando exportacin con FileSystem conectado...');
            return await this.exportarPDFCompleto(repuestosFiltrados, filtrosJerarquia, incluirArbol, agruparNiveles);
          } catch (error) {
            console.error(' Error conectando FileSystem:', error);
            alert('No se pudo conectar la carpeta. El PDF se generar SIN IMGENES.');
          }
        } else {
          console.warn(' Usuario decidi continuar sin conectar FileSystem');
          console.warn(' Se usarn SOLO placeholders en el PDF');
        }
      }
      
      // Si estamos en modo FileSystem pero no tenemos la carpeta de imgenes, intentar obtenerla
      if (fsManager.isFileSystemMode && fsManager.directoryHandle && !fsManager.imagesFolder) {
        try {
          console.log(' Intentando obtener carpeta de imgenes...');
          fsManager.imagesFolder = await fsManager.directoryHandle.getDirectoryHandle('imagenes', { create: false });
          console.log(' Carpeta de imgenes obtenida correctamente');
        } catch (error) {
          console.warn(' No se pudo acceder a carpeta de imgenes:', error.message);
          console.warn(' Se usarn placeholders para todas las imgenes');
        }
      }
      
      // Determinar ttulo segn filtros
      let tituloExport = 'Inventario Completo';
      if (filtrosJerarquia && typeof filtrosJerarquia === 'object') {
        // Es exportacin por jerarqua
        const niveles = [];
        if (filtrosJerarquia.areaGeneral) niveles.push(filtrosJerarquia.areaGeneral);
        if (filtrosJerarquia.subArea) niveles.push(filtrosJerarquia.subArea);
        if (filtrosJerarquia.sistemaEquipo) niveles.push(filtrosJerarquia.sistemaEquipo);
        if (filtrosJerarquia.subSistema) niveles.push(filtrosJerarquia.subSistema);
        if (filtrosJerarquia.seccion) niveles.push(filtrosJerarquia.seccion);
        tituloExport = niveles.join(' > ');
        console.log(' Ttulo generado:', tituloExport);
      } else if (typeof filtrosJerarquia === 'string') {
        // Compatibilidad con versin anterior (areaNombre)
        tituloExport = `rea: ${filtrosJerarquia}`;
        console.log(' Ttulo (compatibilidad):', tituloExport);
      }
      
      // Mostrar progreso inicial
      this.mostrarProgresoPDF(0, `Exportando: ${tituloExport}...`);
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Funcin para limpiar texto con caracteres especiales
      const limpiarTexto = (texto) => {
        if (!texto) return '';
        return String(texto)
          .replace(/\u00E1/g, 'a').replace(/\u00C1/g, 'A')
          .replace(/\u00E9/g, 'e').replace(/\u00C9/g, 'E')
          .replace(/\u00ED/g, 'i').replace(/\u00CD/g, 'I')
          .replace(/\u00F3/g, 'o').replace(/\u00D3/g, 'O')
          .replace(/\u00FA/g, 'u').replace(/\u00DA/g, 'U')
          .replace(/\u00F1/g, 'n').replace(/\u00D1/g, 'N')
          .replace(/\u00FC/g, 'u').replace(/\u00DC/g, 'U')
          .replace(/\u00E7/g, 'c').replace(/\u00C7/g, 'C')
          .replace(/[\u2018\u2019\u201C\u201D]/g, '')
          .replace(/[^\x00-\x7F]/g, ''); // Eliminar cualquier otro caracter no-ASCII
      };
      
      let yPos = 10;
      const pageHeight = doc.internal.pageSize.height;
      const pageWidth = doc.internal.pageSize.width;
      const margin = 10;
      const imgMaxWidth = 50; // Ancho mximo en mm (50mm = 5cm)
      const imgMaxHeight = 35; // Alto mximo en mm (35mm = 3.5cm)
      
      // Funcin para agregar pie de pgina con versin
      const agregarPiePagina = () => {
        const pageCount = doc.internal.getNumberOfPages();
        doc.setFontSize(7);
        doc.setTextColor(150, 150, 150);
        doc.text('v5.3.2', pageWidth - margin - 10, pageHeight - 5, { align: 'right' });
      };
      
      // Funcin para agregar nueva pgina si es necesario
      const checkNewPage = (neededSpace = 15) => {
        if (yPos + neededSpace > pageHeight - margin) {
          agregarPiePagina(); // Agregar versin antes de cambiar de pgina
          doc.addPage();
          yPos = 10;
          return true;
        }
        return false;
      };
      
      // Funcin para calcular dimensiones de imagen SIN DEFORMAR (mantiene proporciones exactas)
      const calcularDimensionesImagen = (imgData) => {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const originalWidth = img.width;
            const originalHeight = img.height;
            const aspectRatio = originalWidth / originalHeight;
            
            let width, height;
            
            // Estrategia: Escalar proporcionalmente hasta que uno de los lados toque el lmite
            // Calcular escala basada en el lado ms restrictivo
            const scaleByWidth = imgMaxWidth / originalWidth;
            const scaleByHeight = imgMaxHeight / originalHeight;
            
            // Usar la escala menor para asegurar que quepa en ambos lmites
            const scale = Math.min(scaleByWidth, scaleByHeight, 0.15); // Mximo 0.15mm por pixel
            
            width = originalWidth * scale;
            height = originalHeight * scale;
            
            // Asegurar dimensiones mnimas visibles
            const minSize = 20; // 20mm mnimo
            if (width < minSize && height < minSize) {
              if (aspectRatio > 1) {
                // Horizontal: ajustar desde el ancho
                width = minSize;
                height = width / aspectRatio;
              } else {
                // Vertical: ajustar desde la altura
                height = minSize;
                width = height * aspectRatio;
              }
            }
            
            // Redondear a 1 decimal
            width = Math.round(width * 10) / 10;
            height = Math.round(height * 10) / 10;
            
            resolve({ 
              width, 
              height, 
              aspectRatio, 
              debeRotar: false, // Nunca rotar, mantener orientacin original
              originalWidth, 
              originalHeight 
            });
          };
          img.onerror = () => resolve({ 
            width: 40, 
            height: 30, 
            aspectRatio: 1.33, 
            debeRotar: false 
          });
          img.src = imgData;
        });
      };
      
      // Imagen placeholder (definida aqu para usarla sin llamar a fsManager)
      const placeholderImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAACWCAYAAACb3McZAAAACXBIWXMAAAsTAAALEwEAmpwYAAADGklEQVR4nO3dy0pDQRRF0ZOI///L4sPIQNAY86h0n7X2gDvJoKu7TqeqngEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgP/q9cV7AK7w+uXlbYwxvr5/f/sewKV+hOPx+Ph8fHwc3wW40I9wjDHG4/Fx8R7Ahb6F4/n5+eE9gAt9C8cY4+49gAt9D8er9wAu9CMcz+N1eA/gQj/CMcZr8x7AhSYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgFv6AyRmU3vlastLAAAAAElFTkSuQmCC';
      
      // Funcin para cargar imagen como base64 (con timeout extendido)
      const getImageBase64 = async (repuesto) => {
        try {
          // Obtener la primera imagen del array multimedia
          if (repuesto.multimedia && Array.isArray(repuesto.multimedia)) {
            const primeraImagen = repuesto.multimedia.find(m => m.type === 'image');
            
            if (primeraImagen && primeraImagen.url) {
              let imagePath = primeraImagen.url;
              
              console.log(` [${repuesto.nombre}] URL original: "${imagePath}"`);
              
              // Normalizar ruta de imagen
              if (imagePath.startsWith('./imagenes/')) {
                imagePath = imagePath.substring(11);
              } else if (imagePath.startsWith('imagenes/')) {
                imagePath = imagePath.substring(9);
              } else if (imagePath.startsWith('INVENTARIO_STORAGE/imagenes/')) {
                imagePath = imagePath.substring(28);
              }
              
              console.log(` [${repuesto.nombre}] Ruta normalizada: "${imagePath}"`);
              console.log(` Estado FileSystem: isFileSystemMode=${fsManager.isFileSystemMode}, imagesFolder=${!!fsManager.imagesFolder}`);
              
              // Intentar cargar desde FileSystem con timeout extendido
              if (fsManager.isFileSystemMode && fsManager.imagesFolder) {
                console.log(` FileSystem disponible, intentando getFileHandle("${imagePath}")...`);
                try {
                  const fileHandle = await fsManager.imagesFolder.getFileHandle(imagePath);
                  const file = await fileHandle.getFile();
                  
                  console.log(` [${repuesto.nombre}] Archivo encontrado: ${file.name}, tamao: ${(file.size/1024).toFixed(1)}KB, tipo: ${file.type}`);
                  
                  // Timeout de 5 segundos por imagen (ms tiempo para cargar)
                  const imageData = await Promise.race([
                    new Promise((resolve) => {
                      const reader = new FileReader();
                      reader.onload = () => {
                        console.log(` [${repuesto.nombre}] Imagen CARGADA exitosamente (${(reader.result.length/1024).toFixed(1)}KB base64)`);
                        resolve(reader.result);
                      };
                      reader.onerror = (err) => {
                        console.error(` [${repuesto.nombre}] Error leyendo archivo:`, err);
                        resolve(null);
                      };
                      reader.readAsDataURL(file);
                    }),
                    new Promise((resolve) => setTimeout(() => {
                      console.warn(` [${repuesto.nombre}] TIMEOUT (5s) cargando imagen`);
                      resolve(null);
                    }, 5000))
                  ]);
                  
                  // Si se carg correctamente, devolverla
                  if (imageData) {
                    return imageData;
                  }
                  
                  // Si timeout o error, usar placeholder
                  console.warn(` [${repuesto.nombre}] Usando PLACEHOLDER (imageData fue null)`);
                  return placeholderImage;
                  
                } catch (error) {
                  // Imagen no encontrada, usar placeholder
                  console.warn(` [${repuesto.nombre}] Archivo NO encontrado en carpeta: ${error.message}`);
                  return placeholderImage;
                }
              } else {
                console.error(` [${repuesto.nombre}] FileSystem NO disponible (isFileSystemMode=${fsManager.isFileSystemMode}, imagesFolder=${!!fsManager.imagesFolder})`);
              }
            } else {
              console.log(` [${repuesto.nombre}] No tiene imagen en multimedia (primeraImagen=${!!primeraImagen})`);
            }
          } else {
            console.log(` [${repuesto.nombre}] No tiene array multimedia`);
          }
        } catch (error) {
          console.error(` [${repuesto.nombre}] Error general cargando imagen:`, error);
        }
        // Retornar placeholder si no hay imagen
        console.log(` [${repuesto.nombre}] Retornando PLACEHOLDER`);
        return placeholderImage;
      };
      
      console.log(' Creando portada...');
      this.mostrarProgresoPDF(5, 'Creando portada del documento...');
      
      // Usar repuestos filtrados o todos
      const repuestosParaPDF = repuestosFiltrados || app.repuestos;
      
      // Determinar el ttulo segn el nivel seleccionado (el ms profundo)
      let tituloDocumento = 'Inventario de Repuestos';
      let subtituloDocumento = 'Todos los repuestos';
      
      if (filtrosJerarquia && typeof filtrosJerarquia === 'object') {
        // Buscar el nivel ms profundo seleccionado
        if (filtrosJerarquia.seccion) {
          tituloDocumento = filtrosJerarquia.seccion;
          subtituloDocumento = `Seccion dentro de ${filtrosJerarquia.subSistema || 'sistema'}`;
        } else if (filtrosJerarquia.subSistema) {
          tituloDocumento = filtrosJerarquia.subSistema;
          subtituloDocumento = `Sub-Sistema dentro de ${filtrosJerarquia.sistemaEquipo || 'equipo'}`;
        } else if (filtrosJerarquia.sistemaEquipo) {
          tituloDocumento = filtrosJerarquia.sistemaEquipo;
          subtituloDocumento = filtrosJerarquia.subArea ? `Sistema/Equipo dentro de ${filtrosJerarquia.subArea}` : `Sistema/Equipo dentro de ${filtrosJerarquia.areaGeneral}`;
        } else if (filtrosJerarquia.subArea) {
          tituloDocumento = filtrosJerarquia.subArea;
          subtituloDocumento = `Sub-Area dentro de ${filtrosJerarquia.areaGeneral || 'area general'}`;
        } else if (filtrosJerarquia.areaGeneral) {
          tituloDocumento = filtrosJerarquia.areaGeneral;
          subtituloDocumento = 'Area General';
        }
      } else if (tituloExport !== 'Inventario Completo') {
        tituloDocumento = tituloExport;
      }
      
      // PORTADA COMPACTA
      doc.setFontSize(18);
      doc.setTextColor(59, 130, 246);
      doc.text(limpiarTexto(tituloDocumento), pageWidth / 2, 20, { align: 'center' });
      
      doc.setFontSize(9);
      doc.setTextColor(100, 100, 100);
      doc.text(limpiarTexto(subtituloDocumento), pageWidth / 2, 26, { align: 'center' });
      doc.text(`${new Date().toLocaleDateString('es-ES')} | Total: ${repuestosParaPDF.length} repuestos`, pageWidth / 2, 31, { align: 'center' });
      
      // Estadsticas compactas
      const sinStock = repuestosParaPDF.filter(r => r.cantidad === 0).length;
      const stockBajo = repuestosParaPDF.filter(r => r.cantidad > 0 && r.cantidad <= (r.minimo || 5)).length;
      const stockOK = repuestosParaPDF.length - sinStock - stockBajo;
      
      yPos = 39;
      doc.setFontSize(8);
      doc.setTextColor(60, 60, 60);
      doc.text(`Stock OK: ${stockOK} | Stock Bajo: ${stockBajo} | Sin Stock: ${sinStock}`, pageWidth / 2, yPos, { align: 'center' });
      
      // ========== RBOL JERRQUICO (si est activado) ==========
      if (incluirArbol && filtrosJerarquia && typeof filtrosJerarquia === 'object') {
        yPos = 48;
        
        // Ttulo del rbol
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);
        doc.setFont(undefined, 'bold');
        doc.text('ESTRUCTURA JERARQUICA', pageWidth / 2, yPos, { align: 'center' });
        doc.setFont(undefined, 'normal');
        
        yPos += 3;
        
        // Lnea separadora
        doc.setDrawColor(150, 150, 150);
        doc.setLineWidth(0.2);
        doc.line(margin + 30, yPos, pageWidth - margin - 30, yPos);
        
        yPos += 8;
        
        // Construir rbol con contadores
        const construirArbol = () => {
          const arbol = {
            empresa: 'Aquachile Antarfood Chonchi',
            areasGenerales: {}
          };
          
          // Analizar todos los repuestos para construir estructura completa
          repuestosParaPDF.forEach(r => {
            const ag = r.areaGeneral || r.area || 'Sin Clasificar';
            if (!arbol.areasGenerales[ag]) {
              arbol.areasGenerales[ag] = { total: 0, subAreas: {} };
            }
            arbol.areasGenerales[ag].total++;
            
            const sa = r.subArea;
            if (sa) {
              if (!arbol.areasGenerales[ag].subAreas[sa]) {
                arbol.areasGenerales[ag].subAreas[sa] = { total: 0, sistemas: {} };
              }
              arbol.areasGenerales[ag].subAreas[sa].total++;
              
              const se = r.sistemaEquipo || r.equipo;
              if (se) {
                if (!arbol.areasGenerales[ag].subAreas[sa].sistemas[se]) {
                  arbol.areasGenerales[ag].subAreas[sa].sistemas[se] = { total: 0, subSistemas: {} };
                }
                arbol.areasGenerales[ag].subAreas[sa].sistemas[se].total++;
                
                const ss = r.subSistema;
                if (ss) {
                  if (!arbol.areasGenerales[ag].subAreas[sa].sistemas[se].subSistemas[ss]) {
                    arbol.areasGenerales[ag].subAreas[sa].sistemas[se].subSistemas[ss] = { total: 0, secciones: {} };
                  }
                  arbol.areasGenerales[ag].subAreas[sa].sistemas[se].subSistemas[ss].total++;
                  
                  const sec = r.seccion;
                  if (sec) {
                    if (!arbol.areasGenerales[ag].subAreas[sa].sistemas[se].subSistemas[ss].secciones[sec]) {
                      arbol.areasGenerales[ag].subAreas[sa].sistemas[se].subSistemas[ss].secciones[sec] = { total: 0, detalles: {} };
                    }
                    arbol.areasGenerales[ag].subAreas[sa].sistemas[se].subSistemas[ss].secciones[sec].total++;
                    
                    const det = r.detalle;
                    if (det) {
                      if (!arbol.areasGenerales[ag].subAreas[sa].sistemas[se].subSistemas[ss].secciones[sec].detalles[det]) {
                        arbol.areasGenerales[ag].subAreas[sa].sistemas[se].subSistemas[ss].secciones[sec].detalles[det] = 0;
                      }
                      arbol.areasGenerales[ag].subAreas[sa].sistemas[se].subSistemas[ss].secciones[sec].detalles[det]++;
                    }
                  }
                }
              }
            }
          });
          
          return arbol;
        };
        
        // Construir rbol completo
        const arbol = construirArbol();
        
        // Funcin recursiva para dibujar todo el rbol
        const xInicio = 10;
        let yActual = yPos;
        const espacioVertical = 3.5;  // Ms compacto (antes 4)
        const espacioHorizontal = 20; // Ms compacto (antes 22)
        
        doc.setFontSize(6.5);  // Letra ms pequea para que quepa ms (antes 7)
        doc.setDrawColor(180, 180, 180);
        doc.setLineWidth(0.15);
        
        // Funcin para verificar si un elemento est seleccionado
        const esSeleccionado = (nivel, valor) => {
          if (nivel === 1) return false; // Nivel 1: Empresa (raz, no seleccionable)
          if (nivel === 2) return filtrosJerarquia.areaGeneral === valor && !filtrosJerarquia.subArea;
          if (nivel === 3) return filtrosJerarquia.subArea === valor && !filtrosJerarquia.sistemaEquipo;
          if (nivel === 4) return filtrosJerarquia.sistemaEquipo === valor && !filtrosJerarquia.subSistema;
          if (nivel === 5) return filtrosJerarquia.subSistema === valor && !filtrosJerarquia.seccion;
          if (nivel === 6) return filtrosJerarquia.seccion === valor && !filtrosJerarquia.detalle;
          if (nivel === 7) return filtrosJerarquia.detalle === valor;
          return false;
        };
        
        // Dibujar raz (Nivel 1: Empresa)
        doc.setFont(undefined, 'normal');
        doc.setTextColor(100, 100, 100);
        doc.text(limpiarTexto(`${arbol.empresa} (${repuestosParaPDF.length})`), xInicio + 2, yActual);
        const yRaiz = yActual;
        yActual += espacioVertical;
        
        // Dibujar todas las reas generales (Nivel 2)
        const areasGenerales = Object.keys(arbol.areasGenerales).sort();
        areasGenerales.forEach((ag, idxAG) => {
          const dataAG = arbol.areasGenerales[ag];
          const xAG = xInicio + espacioHorizontal;
          const yAG = yActual;
          
          // Lnea desde raz
          doc.setDrawColor(180, 180, 180);
          if (idxAG === 0) {
            doc.line(xInicio, yRaiz, xInicio, yAG);
          }
          doc.line(xInicio, yAG, xAG, yAG);
          
          // Texto del rea general (Nivel 2)
          const selAG = esSeleccionado(2, ag);
          if (selAG) {
            doc.setFont(undefined, 'bold');
            doc.setTextColor(220, 38, 38);
          } else {
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
          }
          doc.text(limpiarTexto(`${ag} (${dataAG.total})`), xAG + 2, yAG);
          const yAGInicio = yActual;
          yActual += espacioVertical;
          
          // Dibujar sub-reas de esta rea general (Nivel 3)
          const subAreas = Object.keys(dataAG.subAreas).sort();
          subAreas.forEach((sa, idxSA) => {
            const dataSA = dataAG.subAreas[sa];
            const xSA = xAG + espacioHorizontal;
            const ySA = yActual;
            
            // Lnea desde rea general
            doc.setDrawColor(180, 180, 180);
            if (idxSA === 0) {
              doc.line(xAG, yAG, xAG, ySA);
            }
            doc.line(xAG, ySA, xSA, ySA);
            
            // Texto de sub-rea (Nivel 3)
            const selSA = esSeleccionado(3, sa) && filtrosJerarquia.areaGeneral === ag;
            if (selSA) {
              doc.setFont(undefined, 'bold');
              doc.setTextColor(220, 38, 38);
            } else {
              doc.setFont(undefined, 'normal');
              doc.setTextColor(120, 120, 120);
            }
            doc.text(limpiarTexto(`${sa} (${dataSA.total})`), xSA + 2, ySA);
            const ySAInicio = yActual;
            yActual += espacioVertical;
            
            // Dibujar sistemas de esta sub-rea (Nivel 4)
            const sistemas = Object.keys(dataSA.sistemas).sort();
            sistemas.forEach((se, idxSE) => {
              const dataSE = dataSA.sistemas[se];
              const xSE = xSA + espacioHorizontal;
              const ySE = yActual;
              
              // Lnea desde sub-rea
              doc.setDrawColor(180, 180, 180);
              if (idxSE === 0) {
                doc.line(xSA, ySA, xSA, ySE);
              }
              doc.line(xSA, ySE, xSE, ySE);
              
              // Texto de sistema (Nivel 4)
              const selSE = esSeleccionado(4, se) && filtrosJerarquia.areaGeneral === ag && filtrosJerarquia.subArea === sa;
              if (selSE) {
                doc.setFont(undefined, 'bold');
                doc.setTextColor(220, 38, 38);
              } else {
                doc.setFont(undefined, 'normal');
                doc.setTextColor(140, 140, 140);
              }
              doc.text(limpiarTexto(`${se} (${dataSE.total})`), xSE + 2, ySE);
              const ySEInicio = yActual;
              yActual += espacioVertical;
              
              // Sub-sistemas (Nivel 5 - TODOS, sin lmite)
              const subSistemas = Object.keys(dataSE.subSistemas).sort();
              subSistemas.forEach((ss, idxSS) => {
                const dataSS = dataSE.subSistemas[ss];
                const xSS = xSE + espacioHorizontal;
                const ySS = yActual;
                
                doc.setDrawColor(200, 200, 200);
                if (idxSS === 0) {
                  doc.line(xSE, ySE, xSE, ySS);
                }
                doc.line(xSE, ySS, xSS, ySS);
                
                const selSS = esSeleccionado(5, ss) && filtrosJerarquia.areaGeneral === ag && filtrosJerarquia.subArea === sa && filtrosJerarquia.sistemaEquipo === se;
                if (selSS) {
                  doc.setFont(undefined, 'bold');
                  doc.setTextColor(220, 38, 38);
                } else {
                  doc.setFont(undefined, 'normal');
                  doc.setTextColor(160, 160, 160);
                }
                doc.text(limpiarTexto(`${ss} (${dataSS.total})`), xSS + 2, ySS);
                const ySSInicio = yActual;
                yActual += espacioVertical;
                
                // Secciones (Nivel 6 - TODOS)
                const secciones = Object.keys(dataSS.secciones).sort();
                secciones.forEach((sec, idxSec) => {
                  const dataSec = dataSS.secciones[sec];
                  const xSec = xSS + espacioHorizontal;
                  const ySec = yActual;
                  
                  doc.setDrawColor(220, 220, 220);
                  if (idxSec === 0) {
                    doc.line(xSS, ySS, xSS, ySec);
                  }
                  doc.line(xSS, ySec, xSec, ySec);
                  
                  const selSec = esSeleccionado(6, sec) && filtrosJerarquia.areaGeneral === ag && filtrosJerarquia.subArea === sa && filtrosJerarquia.sistemaEquipo === se && filtrosJerarquia.subSistema === ss;
                  if (selSec) {
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(220, 38, 38);
                  } else {
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(180, 180, 180);
                  }
                  doc.text(limpiarTexto(`${sec} (${dataSec.total})`), xSec + 2, ySec);
                  yActual += espacioVertical;
                  
                  // Detalles (Nivel 7 - TODOS)
                  const detalles = Object.keys(dataSec.detalles).sort();
                  detalles.forEach((det, idxDet) => {
                    const totalDet = dataSec.detalles[det];
                    const xDet = xSec + espacioHorizontal;
                    const yDet = yActual;
                    
                    doc.setDrawColor(230, 230, 230);
                    if (idxDet === 0) {
                      doc.line(xSec, ySec, xSec, yDet);
                    }
                    doc.line(xSec, yDet, xDet, yDet);
                    
                    const selDet = esSeleccionado(7, det) && filtrosJerarquia.areaGeneral === ag && filtrosJerarquia.subArea === sa && filtrosJerarquia.sistemaEquipo === se && filtrosJerarquia.subSistema === ss && filtrosJerarquia.seccion === sec;
                    if (selDet) {
                      doc.setFont(undefined, 'bold');
                      doc.setTextColor(220, 38, 38);
                    } else {
                      doc.setFont(undefined, 'normal');
                      doc.setTextColor(200, 200, 200);
                    }
                    doc.text(limpiarTexto(`${det} (${totalDet})`), xDet + 2, yDet);
                    yActual += espacioVertical;
                    
                    // Verificar si necesitamos una nueva pgina
                    if (yActual > pageHeight - 20) {
                      agregarPiePagina();
                      doc.addPage();
                      yActual = 10;
                      // Re-dibujar ttulo del rbol en nueva pgina
                      doc.setFontSize(8);
                      doc.setTextColor(80, 80, 80);
                      doc.setFont(undefined, 'bold');
                      doc.text('ESTRUCTURA JERARQUICA (continuacion)', pageWidth / 2, yActual, { align: 'center' });
                      doc.setFont(undefined, 'normal');
                      yActual += 5;
                      doc.setFontSize(6.5);
                    }
                  });
                  
                  // Verificar paginacin tambin despus de secciones
                  if (yActual > pageHeight - 20) {
                    agregarPiePagina();
                    doc.addPage();
                    yActual = 10;
                    doc.setFontSize(8);
                    doc.setTextColor(80, 80, 80);
                    doc.setFont(undefined, 'bold');
                    doc.text('ESTRUCTURA JERARQUICA (continuacion)', pageWidth / 2, yActual, { align: 'center' });
                    doc.setFont(undefined, 'normal');
                    yActual += 5;
                    doc.setFontSize(6.5);
                  }
                });
              });
            });
          });
        });
        
        yPos = yActual + 2;
        
        // Lnea separadora final
        doc.setDrawColor(150, 150, 150);
        doc.setLineWidth(0.2);
        doc.line(margin + 30, yPos, pageWidth - margin - 30, yPos);
        
        yPos += 3;
      }
      
      this.mostrarProgresoPDF(10, 'Organizando repuestos por categoras...');
      
      // Organizar repuestos por el nivel hijo del seleccionado
      const repuestosPorCategoria = {};
      
      // Determinar campo de agrupacin segn filtros
      let campoAgrupacion = 'area'; // Por defecto
      let nombreAgrupacion = 'rea';
      
      if (filtrosJerarquia && typeof filtrosJerarquia === 'object') {
        if (filtrosJerarquia.subSistema && !filtrosJerarquia.seccion) {
          // Seleccionado Sub-Sistema  agrupar por Seccin
          campoAgrupacion = 'seccion';
          nombreAgrupacion = 'Seccin';
        } else if (filtrosJerarquia.sistemaEquipo && !filtrosJerarquia.subSistema) {
          // Seleccionado Sistema/Equipo  agrupar por Sub-Sistema
          campoAgrupacion = 'subSistema';
          nombreAgrupacion = 'Sub-Sistema';
        } else if (filtrosJerarquia.subArea && !filtrosJerarquia.sistemaEquipo) {
          // Seleccionado Sub-rea  agrupar por Sistema/Equipo
          campoAgrupacion = 'sistemaEquipo';
          nombreAgrupacion = 'Sistema/Equipo';
        } else if (filtrosJerarquia.areaGeneral && !filtrosJerarquia.subArea) {
          // Seleccionado rea General  agrupar por Sub-rea
          campoAgrupacion = 'subArea';
          nombreAgrupacion = 'Sub-rea';
        }
      }
      
      repuestosParaPDF.forEach(r => {
        let categoria = r[campoAgrupacion] || r.area || 'Sin Clasificar';
        
        // Para sistemaEquipo tambin puede estar en r.equipo
        if (campoAgrupacion === 'sistemaEquipo' && !categoria) {
          categoria = r.equipo || 'Sin Clasificar';
        }
        
        if (!repuestosPorCategoria[categoria]) {
          repuestosPorCategoria[categoria] = [];
        }
        repuestosPorCategoria[categoria].push(r);
      });
      
      console.log(` ${repuestosParaPDF.length} repuestos organizados en ${Object.keys(repuestosPorCategoria).length} categoras (${nombreAgrupacion})`);
      
      // CONTENIDO DETALLADO POR CATEGORA
      // Si no hay rbol, comenzar en yPos=46, si hay rbol ya est posicionado correctamente
      if (!incluirArbol || !filtrosJerarquia || typeof filtrosJerarquia !== 'object') {
        yPos = 46;
      }
      
      let totalProcesados = 0;
      const totalRepuestos = repuestosParaPDF.length;
      
      for (const [categoria, repuestos] of Object.entries(repuestosPorCategoria).sort()) {
        checkNewPage(12);
        
        console.log(` Procesando ${nombreAgrupacion}: ${categoria} (${repuestos.length} repuestos)`);
        
        // Actualizar progreso
        const progresoArea = 10 + (totalProcesados / totalRepuestos) * 80;
        this.mostrarProgresoPDF(progresoArea, `Procesando: ${categoria} (${totalProcesados}/${totalRepuestos})`);
        
        // Ttulo de la categora
        doc.setFontSize(11);
        doc.setTextColor(255, 255, 255);
        doc.setFillColor(59, 130, 246);
        doc.rect(margin, yPos - 4, pageWidth - 2 * margin, 8, 'F');
        doc.text(limpiarTexto(`${categoria} (${repuestos.length})`), margin + 2, yPos + 1);
        yPos += 10;
        
        // Repuestos del rea (diseo compacto en tabla)
        for (const repuesto of repuestos) {
          totalProcesados++;
          
          // Actualizar progreso cada 5 repuestos
          if (totalProcesados % 5 === 0) {
            const progreso = 10 + (totalProcesados / totalRepuestos) * 80;
            this.mostrarProgresoPDF(progreso, `Procesando repuesto ${totalProcesados} de ${totalRepuestos}...`);
            console.log(` Procesando ${totalProcesados}/${totalRepuestos} repuestos...`);
          }
          
          const rowHeight = 34; // Altura aumentada para imgenes ms grandes (de 22 a 34)
          checkNewPage(rowHeight);
          
          // Fondo alternado sutil
          doc.setFillColor(248, 248, 248);
          doc.rect(margin, yPos, pageWidth - 2 * margin, rowHeight, 'F');
          
          let xPos = margin + 2;
          let imgWidth = 0; // Ancho real de la imagen
          
          // Imagen miniatura (siempre mostrar, real o placeholder)
          try {
            console.log(`\n Procesando imagen para: ${repuesto.nombre}`);
            console.log(`   Multimedia array:`, repuesto.multimedia);
            
            const imgData = await getImageBase64(repuesto);
            
            console.log(`   ImgData recibido: ${imgData ? 'S (' + (imgData.length/1024).toFixed(1) + 'KB)' : 'NO'}`);
            
            // getImageBase64 siempre devuelve algo (imagen real o placeholder)
            // Calcular dimensiones manteniendo proporciones originales
            const { width, height, aspectRatio, originalWidth, originalHeight } = await calcularDimensionesImagen(imgData);
            
            console.log(`   Dimensiones originales: ${originalWidth}x${originalHeight}`);
            console.log(`   Dimensiones PDF: ${width}x${height}mm (ratio: ${aspectRatio.toFixed(2)})`);
            
            // Centrar verticalmente la imagen en la fila
            const imgY = yPos + (rowHeight - height) / 2;
            
            // Agregar imagen manteniendo proporciones (sin rotacin, sin deformacin)
            doc.addImage(imgData, 'JPEG', xPos, imgY, width, height);
            imgWidth = width;
            
          } catch (e) {
            console.warn(` Error con imagen de ${repuesto.nombre}:`, e.message);
            // Si falla completamente, usar ancho mximo por defecto
            imgWidth = imgMaxWidth;
          }
          
          // Ajustar xPos segn el ancho real de la imagen (o usar el mximo si no hay imagen)
          xPos += (imgWidth || imgMaxWidth) + 3;
          
          // Informacin del repuesto (ajustada para nueva altura)
          doc.setFontSize(9);
          doc.setTextColor(0, 0, 0);
          doc.setFont(undefined, 'bold');
          const nombreCorto = limpiarTexto((repuesto.nombre || 'Sin nombre').substring(0, 40));
          doc.text(nombreCorto, xPos, yPos + 7);
          
          doc.setFont(undefined, 'normal');
          doc.setFontSize(7);
          doc.setTextColor(80, 80, 80);
          
          let infoY = yPos + 12;
          const infoLines = [];
          if (repuesto.codSAP) infoLines.push(limpiarTexto(`SAP: ${repuesto.codSAP}`));
          if (repuesto.codProv) infoLines.push(limpiarTexto(`Prov: ${repuesto.codProv}`));
          infoLines.push(limpiarTexto(`${repuesto.tipo || 'N/A'} | ${repuesto.equipo || 'N/A'}`));
          
          // Agregar datos tcnicos si existen (NUEVO)
          if (repuesto.datosTecnicos) {
            const datosTecnicosLines = repuesto.datosTecnicos.split('\n').slice(0, 2); // Mximo 2 lneas
            datosTecnicosLines.forEach(linea => {
              if (linea.trim()) {
                infoLines.push(limpiarTexto(`${linea.trim().substring(0, 45)}`));
              }
            });
          }
          
          infoLines.forEach(line => {
            doc.text(line, xPos, infoY);
            infoY += 3.5;
          });
          
          // Stock (con color segn estado) - lado derecho, centrado verticalmente
          const stockX = pageWidth - margin - 35;
          const stockColor = repuesto.cantidad === 0 ? [220, 38, 38] : 
                           repuesto.cantidad <= (repuesto.minimo || 5) ? [245, 158, 11] : 
                           [16, 185, 129];
          doc.setTextColor(...stockColor);
          doc.setFont(undefined, 'bold');
          doc.setFontSize(8);
          doc.text(`Stock: ${repuesto.cantidad}/${repuesto.minimo || 5}`, stockX, yPos + 14);
          
          // Fecha de ltimo conteo (IMPRESCINDIBLE) - TAMAO AUMENTADO CON HORA
          doc.setFont(undefined, 'normal');
          doc.setFontSize(7);
          if (repuesto.ultimoConteo) {
            doc.setTextColor(100, 100, 100);
            const fechaCompleta = new Date(repuesto.ultimoConteo);
            const fecha = fechaCompleta.toLocaleDateString('es-ES');
            const hora = fechaCompleta.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            doc.text(`Conteo: ${fecha} ${hora}`, stockX, yPos + 20);
          } else {
            doc.setTextColor(220, 38, 38);
            doc.text(`Sin conteo`, stockX, yPos + 20);
          }
          
          // Precio (si existe)
          if (repuesto.precio) {
            doc.setTextColor(59, 130, 246);
            doc.setFontSize(7);
            doc.text(`$${repuesto.precio.toFixed(2)}`, stockX, yPos + 26);
          }
          
          yPos += rowHeight + 1;
        }
        
        yPos += 3; // Espacio entre reas
      }
      
      console.log(` Todos los repuestos procesados (${totalProcesados}/${totalRepuestos})`);
      console.log(` Total de pginas generadas: ${doc.internal.getNumberOfPages()}`);
      
      this.mostrarProgresoPDF(95, 'Generando archivo PDF...');
      
      // Agregar pie de pgina a la ltima pgina
      agregarPiePagina();
      
      // Guardar PDF con fecha en el nombre
      const fechaHoy = new Date();
      const dia = String(fechaHoy.getDate()).padStart(2, '0');
      const mes = String(fechaHoy.getMonth() + 1).padStart(2, '0');
      const anio = fechaHoy.getFullYear();
      
      // Nombre del archivo con filtro si es una exportacin especfica
      const nombreFiltro = (tituloExport && tituloExport !== 'Inventario Completo') 
        ? `_${tituloExport.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30)}` 
        : '';
      const filename = `Inventario${nombreFiltro}_${dia}-${mes}-${anio}.pdf`;
      console.log(` Guardando PDF: ${filename}`);
      
      // Pequea pausa para mostrar el 95%
      await new Promise(resolve => setTimeout(resolve, 300));
      
      doc.save(filename);
      
      this.mostrarProgresoPDF(100, 'PDF generado exitosamente!');
      
      // Cerrar el modal despus de 1.5 segundos
      setTimeout(() => {
        this.cerrarModal();
        app.showToast(` PDF descargado: ${filename} (${doc.internal.getNumberOfPages()} pginas)`, 'success', 5000);
      }, 1500);
      
      console.log(' PDF descargado exitosamente');
      
    } catch (error) {
      console.error(' Error generando PDF:', error);
      this.cerrarModal();
      app.showToast(' Error al generar PDF: ' + error.message, 'error');
    }
  },

  // 
  //  SISTEMA DE RESPALDO/CARGA COMPLETA (Migracin entre versiones)
  // 
  
  async exportarRespaldoCompleto() {
    if (!window.JSZip) {
      app.showToast(' Error: Librera JSZip no cargada', 'error');
      return;
    }

    if (!fsManager.isFileSystemMode || !fsManager.directoryHandle) {
      app.showToast(' Primero debes seleccionar una carpeta de trabajo', 'warning');
      return;
    }

    try {
      app.showToast(' Creando respaldo completo... Esto puede tardar', 'info', 5000);
      
      const zip = new JSZip();
      
      // 1. Agregar datos de repuestos (JSON)
      const datosRepuestos = {
        version: '5.3.2',
        fecha: new Date().toISOString(),
        totalRepuestos: app.repuestos.length,
        repuestos: app.repuestos
      };
      zip.file('repuestos.json', JSON.stringify(datosRepuestos, null, 2));
      
      // 2. Agregar mapas si existen
      if (mapStorage && mapStorage.initialized) {
        try {
          const mapas = await mapStorage.getMaps();
          const areas = await mapStorage.getAreas();
          
          const datosMapas = {
            version: '5.3.2',
            fecha: new Date().toISOString(),
            mapas: mapas,
            areas: areas
          };
          zip.file('mapas.json', JSON.stringify(datosMapas, null, 2));
        } catch (error) {
          console.warn(' No se pudieron cargar los mapas:', error);
        }
      }
      
      // 3. Contar imgenes antes del README
      let imagenCount = 0;
      if (fsManager.imagesFolder) {
        for await (const entry of fsManager.imagesFolder.values()) {
          if (entry.kind === 'file') {
            imagenCount++;
          }
        }
      }
      
      // 4. Agregar README con instrucciones
      const readme = `
RESPALDO COMPLETO DEL INVENTARIO (ZIP)
=======================================

 Fecha de creacin: ${new Date().toLocaleString('es-ES')}
 Versin: 5.3.2
 Total de repuestos: ${app.repuestos.length}
  Total de imgenes: ${imagenCount}

CONTENIDO DEL ZIP:
------------------
1. repuestos.json - Datos completos de todos los repuestos
2. mapas.json - Configuracin de mapas y reas marcadas
3. imagenes/ - Carpeta con todas las fotos de repuestos
4. README.txt - Este archivo de instrucciones

UBICACIN DEL RESPALDO:
-----------------------
Este archivo ZIP se guarda automticamente en:
 INVENTARIO_STORAGE/backups/zip/Respaldo_Completo_YYYY-MM-DD.zip

 IMPORTANTE: Los backups se organizan en carpetas separadas:
    backups/automaticos/ - Backups JSON automticos (cada vez que guardas)
    backups/zip/ - Respaldos ZIP completos (con todas las imgenes)
    backups/mapas/ - Backups especficos de mapas
    backups/zonas/ - Backups especficos de zonas

INSTRUCCIONES PARA RESTAURAR:
------------------------------
1. En la aplicacin v5.3.2 o superior, ve a:
   Configuracin > Gestin de Backups > Cargar Respaldo Completo
2. El sistema buscar automticamente en: INVENTARIO_STORAGE/backups/zip/
3. Selecciona el respaldo ZIP que deseas restaurar
4. Listo! Todos tus datos estarn restaurados

MIGRACIN ENTRE VERSIONES:
---------------------------
Este respaldo es compatible con:
- v5.3.0  v5.3.2
- v5.3.2  Versiones futuras

Para migrar a otra versin:
1. Descarga el ZIP al navegador usando el botn "Descargar ZIP"
2. Instala la nueva versin del inventario
3. Selecciona la carpeta INVENTARIO_STORAGE
4. Ve a "Cargar Respaldo Completo" y selecciona este ZIP
5. O copia este archivo a: INVENTARIO_STORAGE/backups/zip/

DIFERENCIAS ENTRE TIPOS DE BACKUP:
-----------------------------------
 Backup Automtico (JSON): ~150-200KB
   - Se crea automticamente al guardar cambios
   - Incluye: repuestos, mapas, reas, estadsticas
   - NO incluye imgenes (solo referencias)
   - Ubicacin: backups/automaticos/
   - Rotacin: Se mantienen los ltimos 5

 Respaldo Completo (ZIP): Variable (depende de imgenes)
   - Se crea manualmente desde "Exportar Respaldo Completo"
   - Incluye: repuestos, mapas, reas, TODAS LAS IMGENES
   - Ideal para migracin o respaldo externo
   - Ubicacin: backups/zip/
   - Rotacin: Se mantienen los ltimos 5

RECOMENDACIONES:
----------------
 Los backups automticos JSON son suficientes para uso diario
 Crea respaldos ZIP completos semanalmente o antes de actualizar
 Descarga los ZIP importantes a tu PC para respaldo externo
 Los archivos ZIP pueden ser muy grandes si tienes muchas imgenes

SOPORTE TCNICO:
----------------
Para ms informacin, consulta la documentacin en:
DOCUMENTACION/GUIA_RAPIDA.md

 Inventario Visual PRO - Sistema de Gestin de Repuestos v5.3.2
      `.trim();
      
      zip.file('README.txt', readme);
      
      // 5. Agregar imgenes si hay FileSystem activo
      if (fsManager.imagesFolder) {
        const imagenesFolder = zip.folder('imagenes');
        
        for await (const entry of fsManager.imagesFolder.values()) {
          if (entry.kind === 'file') {
            try {
              const file = await entry.getFile();
              imagenesFolder.file(file.name, file);
            } catch (error) {
              console.error(`Error agregando imagen ${entry.name}:`, error);
            }
          }
        }
        
        console.log(` ${imagenCount} imgenes agregadas al respaldo`);
      }
      
      // 6. Generar ZIP en memoria
      const blob = await zip.generateAsync({ 
        type: 'blob',
        compression: 'DEFLATE',
        compressionOptions: { level: 6 }
      });
      
      const filename = `Respaldo_Completo_${new Date().toISOString().split('T')[0]}.zip`;
      const sizeMB = (blob.size / (1024 * 1024)).toFixed(2);
      
      // 7. Guardar en INVENTARIO_STORAGE/backups/zip/
      const backupsDir = await fsManager.directoryHandle.getDirectoryHandle('backups', { create: true });
      const zipDir = await backupsDir.getDirectoryHandle('zip', { create: true });
      
      // Eliminar respaldos antiguos si hay ms de 5
      const respaldos = [];
      for await (const entry of zipDir.values()) {
        if (entry.kind === 'file' && entry.name.endsWith('.zip')) {
          const file = await entry.getFile();
          respaldos.push({
            name: entry.name,
            timestamp: file.lastModified
          });
        }
      }
      
      respaldos.sort((a, b) => a.timestamp - b.timestamp);
      while (respaldos.length >= 5) {
        const antiguo = respaldos.shift();
        await zipDir.removeEntry(antiguo.name);
        console.log(` Respaldo antiguo eliminado: ${antiguo.name}`);
      }
      
      // Guardar nuevo respaldo
      const fileHandle = await zipDir.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      
      const rutaCompleta = `INVENTARIO_STORAGE/backups/zip/${filename}`;
      
      // Mostrar modal con informacin
      const html = `
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 3rem; margin-bottom: 16px;"></div>
          <h3 style="color: var(--success); margin-bottom: 16px;">Respaldo Completo Creado</h3>
          
          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin: 20px 0; text-align: left;">
            <div style="margin-bottom: 12px;">
              <strong style="color: var(--text-primary);"> Archivo:</strong>
              <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 6px; font-family: monospace; font-size: 0.9rem; color: var(--primary); word-break: break-all;">
                ${filename}
              </div>
            </div>
            
            <div style="margin-bottom: 12px;">
              <strong style="color: var(--text-primary);"> Ruta:</strong>
              <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 6px; font-family: monospace; font-size: 0.85rem; color: var(--success); word-break: break-all;">
                ${rutaCompleta}
              </div>
            </div>
            
            <div style="margin-bottom: 12px;">
              <strong style="color: var(--text-primary);"> Tamao:</strong>
              <div style="color: var(--text-secondary); margin-top: 4px;">
                ${sizeMB} MB
              </div>
            </div>
            
            <div style="margin-bottom: 12px;">
              <strong style="color: var(--text-primary);"> Contenido:</strong>
              <div style="color: var(--text-secondary); margin-top: 4px;">
                 ${app.repuestos.length} repuestos<br>
                 ${imagenCount} imgenes<br>
                 Mapas y reas
              </div>
            </div>
          </div>
          
          <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 6px; margin: 16px 0; border-left: 4px solid var(--primary);">
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
               <strong>Para migrar a otra versin:</strong><br>
              1. Copia toda la carpeta <code>INVENTARIO_STORAGE/backups/</code><br>
              2. Pgala en la nueva versin<br>
              3. Usa "Cargar Respaldo Completo" para restaurar
            </div>
          </div>
          
          <div style="display: grid; gap: 10px;">
            <button onclick="configuracion.descargarUltimoZip('${filename}')" class="btn btn-success" style="width: 100%; padding: 12px;">
               Descargar ZIP al Navegador (Downloads)
            </button>
            <button onclick="configuracion.cerrarModal()" class="btn btn-secondary" style="width: 100%; padding: 12px;">
              Cerrar
            </button>
          </div>
        </div>
      `;
      
      this.mostrarModal(html);
      
      console.log(` Respaldo completo guardado en: ${rutaCompleta}`);
      
    } catch (error) {
      console.error(' Error creando respaldo completo:', error);
      app.showToast(' Error: ' + error.message, 'error');
    }
  },

  async cargarRespaldoCompleto() {
    if (!fsManager.isFileSystemMode || !fsManager.directoryHandle) {
      app.showToast(' Primero debes seleccionar una carpeta de trabajo', 'warning');
      return;
    }

    try {
      // Obtener la carpeta de respaldos completos
      const backupsDir = await fsManager.directoryHandle.getDirectoryHandle('backups', { create: true });
      const zipDir = await backupsDir.getDirectoryHandle('zip', { create: true });
      
      // Listar archivos ZIP disponibles
      const respaldos = [];
      for await (const entry of zipDir.values()) {
        if (entry.kind === 'file' && entry.name.endsWith('.zip')) {
          const file = await entry.getFile();
          respaldos.push({
            name: entry.name,
            handle: entry,
            file: file,
            timestamp: file.lastModified,
            fecha: new Date(file.lastModified).toLocaleString('es-ES'),
            size: (file.size / (1024 * 1024)).toFixed(2) + ' MB'
          });
        }
      }
      
      if (respaldos.length === 0) {
        app.showToast(' No hay respaldos ZIP disponibles en backups/zip/', 'warning', 4000);
        return;
      }
      
      // Ordenar por fecha (ms reciente primero)
      respaldos.sort((a, b) => b.timestamp - a.timestamp);
      
      // Mostrar modal con lista de respaldos
      let html = `
        <div style="max-height: 500px; overflow-y: auto;">
          <h3 style="margin: 0 0 16px 0; color: var(--primary);">
             Seleccionar Respaldo ZIP (${respaldos.length})
          </h3>
          <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">
            Ubicacin: <code>INVENTARIO_STORAGE/backups/zip/</code>
          </p>
      `;
      
      respaldos.forEach((respaldo, index) => {
        html += `
          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid ${index === 0 ? 'var(--success)' : 'var(--primary)'}; cursor: pointer;" onclick="configuracion.restaurarRespaldoCompletoPorIndice(${index})">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div style="flex: 1;">
                <strong style="color: var(--text-primary);">${respaldo.name}</strong>
                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">
                   ${respaldo.fecha}
                </div>
              </div>
              <span style="background: ${index === 0 ? 'var(--success)' : 'var(--primary)'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; white-space: nowrap;">
                ${index === 0 ? ' Ms Reciente' : `#${index + 1}`}
              </span>
            </div>
            
            <div style="display: flex; gap: 20px; font-size: 0.85rem; color: var(--text-secondary);">
              <div>
                <strong> Tamao:</strong> ${respaldo.size}
              </div>
            </div>
            
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
              <button onclick="event.stopPropagation(); configuracion.restaurarRespaldoCompletoPorIndice(${index})" 
                      class="btn ${index === 0 ? 'btn-success' : 'btn-primary'}" 
                      style="width: 100%; padding: 10px; font-size: 0.9rem;">
                 Cargar Este Respaldo
              </button>
            </div>
          </div>
        `;
      });
      
      html += `
        </div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
          <button onclick="configuracion.cerrarModal()" 
                  class="btn btn-secondary" 
                  style="width: 100%; padding: 12px;">
            Cancelar
          </button>
        </div>
      `;
      
      this.mostrarModal(html);
      
      // Guardar referencia a los respaldos
      this._respaldosCache = respaldos;
      
    } catch (error) {
      console.error(' Error listando respaldos completos:', error);
      app.showToast(' Error al buscar respaldos: ' + error.message, 'error');
    }
  },

  _respaldosCache: [],

  async restaurarRespaldoCompletoPorIndice(index) {
    const respaldo = this._respaldosCache[index];
    if (!respaldo) return;

    if (!window.JSZip) {
      app.showToast(' Error: Librera JSZip no cargada', 'error');
      return;
    }

    try {
      app.showToast(' Cargando respaldo completo...', 'info', 3000);
      
      const zip = await JSZip.loadAsync(respaldo.file);
      
      // 1. Cargar repuestos
      const repuestosFile = zip.file('repuestos.json');
      if (repuestosFile) {
        const data = JSON.parse(await repuestosFile.async('text'));
        
        const confirmacion = confirm(
          ` CARGAR RESPALDO COMPLETO\n\n` +
          ` Archivo: ${respaldo.name}\n` +
          ` Fecha del respaldo: ${new Date(data.fecha).toLocaleString('es-ES')}\n` +
          ` Repuestos: ${data.totalRepuestos}\n` +
          ` Versin: ${data.version}\n\n` +
          ` Esto reemplazar todos los datos actuales.\n\n` +
          `Continuar?`
        );
        
        if (!confirmacion) return;
        
        app.repuestos = data.repuestos || [];
        await app.saveData();
      }
      
      // 2. Cargar mapas si existen
      const mapasFile = zip.file('mapas.json');
      if (mapasFile && mapStorage) {
        const datosMapas = JSON.parse(await mapasFile.async('text'));
        // Aqu se cargaran los mapas (requiere implementacin en mapStorage)
        console.log(' Mapas encontrados:', datosMapas);
      }
      
      // 3. Restaurar imgenes si hay FileSystem activo
      if (fsManager.imagesFolder) {
        const imagenesFolder = zip.folder('imagenes');
        if (imagenesFolder) {
          let restauradas = 0;
          
          for (const [filename, fileData] of Object.entries(imagenesFolder.files)) {
            if (!fileData.dir) {
              try {
                const blob = await fileData.async('blob');
                const fileHandle = await fsManager.imagesFolder.getFileHandle(filename.split('/').pop(), { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                restauradas++;
              } catch (error) {
                console.error(`Error restaurando ${filename}:`, error);
              }
            }
          }
          
          console.log(` ${restauradas} imgenes restauradas`);
        }
      }
      
      await app.render();
      app.renderFilters();
      app.updateAutocompleteData();
      
      this.cerrarModal();
      app.showToast(` Respaldo completo cargado correctamente`, 'success', 4000);
      
    } catch (error) {
      console.error(' Error cargando respaldo:', error);
      app.showToast(' Error: ' + error.message, 'error');
    }
  },

  // 
  //  EXPORTAR APP PORTABLE COMPLETA (Todo en un ZIP)
  // 
  
  async exportarAppCompleta() {
    if (!window.JSZip) {
      app.showToast(' Error: Librera JSZip no cargada', 'error');
      return;
    }

    try {
      const toastId = app.showToast(' Creando paquete portable completo... Esto puede tardar', 'info', 10000);
      
      const zip = new JSZip();
      const version = '5.3.4'; //  FIX: Versin correcta
      const fecha = new Date();
      
      // Formato de fecha y hora ms claro: YYYY-MM-DD_HH-MM-SS
      const anio = fecha.getFullYear();
      const mes = String(fecha.getMonth() + 1).padStart(2, '0');
      const dia = String(fecha.getDate()).padStart(2, '0');
      const hora = String(fecha.getHours()).padStart(2, '0');
      const minutos = String(fecha.getMinutes()).padStart(2, '0');
      const segundos = String(fecha.getSeconds()).padStart(2, '0');
      const timestamp = `${anio}-${mes}-${dia}_${hora}-${minutos}-${segundos}`;
      
      const filename = `InventarioPortable_v${version}_${timestamp}.zip`;
      console.log(` Creando: ${filename}`);
      
      // 1. Agregar el archivo HTML principal (desde el documento actual)
      const htmlContent = document.documentElement.outerHTML;
      zip.file(`inventario_v${version}.html`, '<!DOCTYPE html>\n' + htmlContent);
      
      // 2. Agregar INVENTARIO_STORAGE completo si existe
      if (fsManager.isFileSystemMode && fsManager.directoryHandle) {
        const storageFolder = zip.folder('INVENTARIO_STORAGE');
        
        // Funcin recursiva para agregar carpetas y archivos
        const agregarCarpetaAlZip = async (dirHandle, zipFolder) => {
          for await (const entry of dirHandle.values()) {
            if (entry.kind === 'file') {
              try {
                const file = await entry.getFile();
                zipFolder.file(entry.name, file);
                console.log(` Agregado: ${entry.name}`);
              } catch (error) {
                console.warn(` No se pudo agregar: ${entry.name}`, error);
              }
            } else if (entry.kind === 'directory') {
              const subFolder = zipFolder.folder(entry.name);
              await agregarCarpetaAlZip(entry, subFolder);
            }
          }
        };
        
        // Agregar todo INVENTARIO_STORAGE
        await agregarCarpetaAlZip(fsManager.directoryHandle, storageFolder);
        console.log(' INVENTARIO_STORAGE agregado al ZIP');
      }
      
      // 3. Crear README de instalacin
      const readme = `

                                                                
          INVENTARIO PORTABLE v${version}                         
            Sistema de Gestin de Repuestos                    
                                                                


 Fecha de exportacin: ${fecha.toLocaleString('es-ES')}
 Paquete: Aplicacin completa con todos los datos



 CONTENIDO DEL PAQUETE:


1. inventario_v${version}.html
    Aplicacin principal (archivo nico)
    Abre con cualquier navegador moderno

2. INVENTARIO_STORAGE/
    Todos tus datos y configuraciones
    Backups automticos
    Imgenes de repuestos
    Mapas y configuraciones



 INSTRUCCIONES DE INSTALACIN EN OTRO PC:


PASO 1: Extraer el ZIP
    Descomprime este ZIP en cualquier carpeta de tu PC
    Ejemplo: C:\\MisAplicaciones\\Inventario\\
    MANTN JUNTOS el HTML y la carpeta INVENTARIO_STORAGE

PASO 2: Abrir la aplicacin
    Doble clic en: inventario_v${version}.html
    Se abrir en tu navegador predeterminado

PASO 3: Conectar la carpeta de datos (IMPORTANTE)
    En la pantalla inicial, click en " Seleccionar Carpeta"
    Selecciona la carpeta: INVENTARIO_STORAGE
    TODAS las imgenes, mapas y datos se cargarn automticamente!

 NOTA CRTICA: 
   Sin conectar la carpeta INVENTARIO_STORAGE no vers:
    Imgenes de repuestos
    Imgenes en marcadores del mapa
    Backups guardados
   
   Siempre selecciona la carpeta primero antes de usar la app.



 VENTAJAS DE ESTE PAQUETE:


 No requiere instalacin
 Funciona sin internet
 Porttil entre PCs
 Incluye TODOS tus datos
 Backups incluidos
 Imgenes incluidas
 Compatible Windows/Mac/Linux



 REQUISITOS:


 Navegador moderno (Chrome 86+, Edge 86+, Opera 72+)
 JavaScript habilitado
 File System Access API (automtico en navegadores modernos)



 ESTRUCTURA DE ARCHIVOS:


InventarioPortable_v${version}_${timestamp}.zip
 README.txt (este archivo)
 inventario_v${version}.html (aplicacin)
 INVENTARIO_STORAGE/
     backups/
        automaticos/  (backups JSON)
        zip/          (respaldos completos)
        mapas/        (backups de mapas)
        zonas/        (backups de reas)
     imagenes/         (fotos de repuestos)



 MIGRACIN ENTRE VERSIONES:


Para actualizar a una versin futura:
1. Guarda tu carpeta INVENTARIO_STORAGE
2. Descarga la nueva versin HTML
3. Abre la nueva versin
4. Selecciona tu carpeta INVENTARIO_STORAGE existente
5. Todos tus datos estarn disponibles!



 SOPORTE Y DOCUMENTACIN:


Dentro de la aplicacin:
 Click en  Configuracin
 Seccin "Ayuda y Documentacin"
 Guas rpidas disponibles



 2025 Inventario Visual PRO v${version}
Sistema de Gestin de Repuestos con Mapas Visuales

      `.trim();
      
      zip.file('README.txt', readme);
      
      // 4. Generar ZIP
      const blob = await zip.generateAsync({ 
        type: 'blob',
        compression: 'DEFLATE',
        compressionOptions: { level: 6 }
      }, (metadata) => {
        const porcentaje = metadata.percent.toFixed(0);
        console.log(` Comprimiendo: ${porcentaje}%`);
      });
      
      const sizeMB = (blob.size / (1024 * 1024)).toFixed(2);
      
      // 5. Guardar en la carpeta de backups/app_portable/
      if (fsManager.isFileSystemMode && fsManager.directoryHandle) {
        try {
          // Obtener/crear carpeta backups
          const backupsDir = await fsManager.directoryHandle.getDirectoryHandle('backups', { create: true });
          
          // Obtener/crear carpeta app_portable dentro de backups
          const appPortableDir = await backupsDir.getDirectoryHandle('app_portable', { create: true });
          
          // Crear archivo en la carpeta app_portable
          const fileHandle = await appPortableDir.getFileHandle(filename, { create: true });
          const writable = await fileHandle.createWritable();
          await writable.write(blob);
          await writable.close();
          
          console.log(` App portable guardada en: INVENTARIO_STORAGE/backups/app_portable/${filename}`);
          
          // 6. Mostrar modal de xito
          const html = `
            <div class="modal-content" style="max-width: 500px;">
              <h3 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                 <span>App Portable Exportada</span>
              </h3>
              
              <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #28a745;">
                <p style="margin: 0 0 10px 0; font-weight: bold; color: #155724;"> Paquete Completo Guardado:</p>
                <div style="background: white; padding: 10px; border-radius: 6px; margin-top: 10px;">
                  <div style="font-size: 16px; font-weight: bold; color: #2196F3; margin-bottom: 5px;">
                    ${filename}
                  </div>
                  <div style="font-size: 13px; color: #666;">
                    Tamao: ${sizeMB} MB
                  </div>
                  <div style="font-size: 12px; color: #888; margin-top: 5px;">
                     INVENTARIO_STORAGE/backups/app_portable/
                  </div>
                </div>
              </div>
              
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p style="margin: 0 0 10px 0; font-weight: bold; color: #495057;"> Contenido incluido:</p>
                <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 14px;">
                  <li> Aplicacin HTML completa</li>
                  <li> Todos tus datos y repuestos</li>
                  <li> Todas las imgenes</li>
                  <li> Backups automticos</li>
                  <li> Mapas y configuraciones</li>
                  <li> README con instrucciones</li>
                </ul>
              </div>
              
              <div style="background: #e7f3ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
                <p style="margin: 0; font-size: 13px; color: #0d47a1;">
                   <strong>En otro PC:</strong> Simplemente extrae el ZIP y abre el archivo HTML. 
                  Luego selecciona la carpeta INVENTARIO_STORAGE y tendrs todo funcionando.
                </p>
              </div>
              
              <div style="display: grid; gap: 10px;">
                <button onclick="configuracion.cerrarModal()" class="btn btn-primary" style="width: 100%; padding: 12px;">
                  Entendido
                </button>
              </div>
            </div>
          `;
          
          this.mostrarModal(html);
          app.showToast(` App portable guardada en backups/app_portable/`, 'success', 5000);
          console.log(` App portable exportada: ${filename}`);
          
        } catch (error) {
          console.error(' Error guardando en backups:', error);
          app.showToast(' Error al guardar en backups: ' + error.message, 'error');
        }
      } else {
        // Si no hay FileSystem conectado, descargar al navegador
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        app.showToast(` App portable descargada: ${filename}`, 'success', 5000);
        console.log(` App portable descargada: ${filename}`);
      }
      
    } catch (error) {
      console.error(' Error exportando app completa:', error);
      app.showToast(' Error: ' + error.message, 'error');
    }
  },

  // 
  //  MTODO DE EXPORTAR A EXCEL (Vinculado a app.exportExcel())
  // 
  
  exportarExcel() {
    try {
      // Llamar al mtodo existente de app
      app.exportExcel();
    } catch (error) {
      console.error(' Error exportando a Excel:', error);
      app.showToast(' Error al exportar Excel: ' + error.message, 'error');
    }
  },

  // 
  //  EXPORTAR HTML EMBEBIDO PARA MVIL (standalone sin FileSystem)
  // 
  
  exportarHTMLConDatosEmbebidos() {
    app.showToast(' Funcin no implementada an. Esta funcin permitir exportar un HTML standalone con todos los datos embebidos (sin necesidad de FileSystem) ideal para usar en mviles sin conexin.', 'info', 5000);
    
    // NOTA: Esta funcin exportara un archivo HTML nico que contiene:
    // 1. Todo el cdigo HTML/CSS/JS de la aplicacin
    // 2. Datos JSON embebidos en el <script>
    // 3. Imgenes convertidas a base64 embebidas
    // 4. Sin dependencia de FileSystem API (usa LocalStorage)
    // Ideal para: compartir inventario completo en un solo archivo portable
  }
};


// ========================================================================
//  UTILIDADES PARA MODAL DE CARGA
// ========================================================================
const LoadingModal = {
  modal: null,
  progressBar: null,
  progressText: null,
  messageText: null,
  statusText: null,
  tipText: null,
  rotationTimer: null,
  finishTimer: null,
  defaultTips: [
    'No cierres la pestaña mientras sincronizamos tu carpeta.',
    'Puedes desactivar la auto-reconexión desde Configuración > Almacenamiento.',
    'Tus imágenes y datos quedarán guardados en la carpeta seleccionada.',
    'Si cambias de equipo, conecta la misma carpeta INVENTARIO_STORAGE.'
  ],
  
  init() {
    this.modal = document.getElementById('loadingModal');
    this.progressBar = document.getElementById('loadingProgressBar');
    this.progressText = document.getElementById('loadingProgressText');
    this.messageText = document.getElementById('loadingModalText');
    this.statusText = document.getElementById('loadingModalStatus');
    this.tipText = document.getElementById('loadingModalTip');
  },
  
  show(message = 'Conectando...', status = 'Preparando servicios', tip = null) {
    if (!this.modal) this.init();
    if (!this.modal) return;
    this.messageText.textContent = message;
    this.setStatus(status);
    this.setTip(tip || this.defaultTips[0]);
    this.modal.classList.add('active');
    if (document?.body) {
      document.body.classList.add('loading-modal-active');
    }
    this.setProgress(5);
  },
  
  hide() {
    if (!this.modal) return;
    this.modal.classList.remove('active');
    if (document?.body) {
      document.body.classList.remove('loading-modal-active');
    }
    if (this.finishTimer) {
      clearTimeout(this.finishTimer);
      this.finishTimer = null;
    }
  },
  
  setProgress(percent, message = null) {
    if (!this.progressBar) return;
    const value = Math.min(100, Math.max(0, percent));
    this.progressBar.style.width = `${value}%`;
    this.progressText.textContent = `${Math.round(value)}%`;
    if (message) this.messageText.textContent = message;
  },

  setStatus(message) {
    if (this.statusText && message) {
      this.statusText.textContent = message;
    }
  },

  setTip(message) {
    if (this.tipText && message) {
      this.tipText.textContent = message;
    }
  },

  finish({
    message = 'Inventario listo',
    status = 'Interfaz lista',
    tip = 'Todo sincronizado. Puedes continuar trabajando.',
    delay = 400
  } = {}) {
    if (!this.modal || !this.modal.classList.contains('active')) return;
    this.setProgress(100, message);
    this.setStatus(status);
    this.setTip(tip);
    if (this.finishTimer) clearTimeout(this.finishTimer);
    this.finishTimer = setTimeout(() => this.hide(), delay);
  },

  async runTask(taskFn, {
    startMessage = 'Procesando...',
    statusMessage = 'Inicializando servicios',
    successMessage = 'Completado',
    errorMessage = 'Operación completada',
    autoHideDelay = 0,
    autoHide = true,
    tips = [],
    statusSteps = [
      { value: 15, label: 'Solicitando permisos...' },
      { value: 45, label: 'Sincronizando carpeta...' },
      { value: 75, label: 'Preparando paneles...' }
    ]
  } = {}) {
    if (typeof taskFn !== 'function') {
      console.warn('LoadingModal.runTask requiere una función');
      return false;
    }

    try {
      this.show(startMessage, statusMessage, tips[0]);
    } catch (error) {
      console.warn('No se pudo mostrar el modal de carga:', error);
    }

    let progress = 0;
    const tipPool = tips.length ? tips : this.defaultTips;
    let tipIndex = 0;
    const evaluatedSteps = statusSteps.map(step => ({ ...step, done: false }));
    const interval = setInterval(() => {
      progress = Math.min(95, progress + 10);
      try {
        this.setProgress(progress);
        const nextStep = evaluatedSteps.find(step => !step.done && progress >= step.value);
        if (nextStep) {
          this.setStatus(nextStep.label);
          nextStep.done = true;
        }
      } catch (error) {
        console.warn('No se pudo actualizar el progreso del modal:', error);
      }
    }, 250);

    if (this.rotationTimer) {
      clearInterval(this.rotationTimer);
    }
    this.rotationTimer = setInterval(() => {
      tipIndex = (tipIndex + 1) % tipPool.length;
      this.setTip(tipPool[tipIndex]);
    }, 3200);

    try {
      const result = await taskFn();
      this.setProgress(100, successMessage);
      this.setStatus('Listo para usar');
      this.setTip('Puedes continuar trabajando normalmente.');
      return result;
    } catch (error) {
      this.setProgress(100, errorMessage);
      this.setStatus('Acción requerida');
      throw error;
    } finally {
      clearInterval(interval);
      if (this.rotationTimer) {
        clearInterval(this.rotationTimer);
        this.rotationTimer = null;
      }
      if (autoHide !== false) {
        setTimeout(() => {
          try {
            this.hide();
          } catch (error) {}
        }, autoHideDelay);
      }
    }
  }
};

// ========================================================================
//  INDICADOR NO BLOQUEANTE EN PESTAÑAS (BARRA SUPERIOR)
// ========================================================================
const WarmupProgress = {
  container: null,
  fill: null,
  label: null,
  duration: 15000,
  startTime: null,
  hideTimer: null,
  active: false,

  init() {
    if (this.container) return;
    this.container = document.getElementById('appWarmupProgress');
    this.fill = document.getElementById('appWarmupProgressFill');
    this.label = document.getElementById('appWarmupProgressLabel');
  },

  start(message = 'Preparando aplicación...', duration = null) {
    if (!this.container) this.init();
    if (!this.container) return;
    if (duration) {
      this.duration = duration;
    }
    this.active = true;
    this.startTime = Date.now();
    this.container.classList.add('active');
    this.setMessage(message);
    if (this.hideTimer) {
      clearTimeout(this.hideTimer);
      this.hideTimer = null;
    }
    if (this.fill) {
      this.fill.style.transition = 'none';
      this.fill.style.width = '0%';
      requestAnimationFrame(() => {
        this.fill.style.transition = `width ${this.duration}ms linear`;
        this.fill.style.width = '100%';
      });
    }
  },

  setMessage(message) {
    if (this.label && message) {
      this.label.textContent = message;
    }
  },

  finish(message = 'Aplicación lista') {
    if (!this.active || !this.container) return;
    if (message) {
      this.setMessage(message);
    }
    const elapsed = Date.now() - (this.startTime || Date.now());
    const remaining = Math.max(0, this.duration - elapsed);
    if (this.hideTimer) {
      clearTimeout(this.hideTimer);
    }
    this.hideTimer = setTimeout(() => {
      if (this.fill) {
        this.fill.style.transition = 'width 0.4s ease-out';
        this.fill.style.width = '100%';
      }
      setTimeout(() => {
        this.container.classList.remove('active');
        if (this.fill) {
          this.fill.style.transition = 'none';
          this.fill.style.width = '0%';
        }
        this.active = false;
      }, 600);
    }, remaining);
  }
};

// ========================================================================
//  UTILIDAD PARA DIFERIR TAREAS PESADAS SIN BLOQUEAR LA UI
// ========================================================================
function deferHeavyTask(task, { timeout = 1500, label = 'tarea diferida' } = {}) {
  if (typeof task !== 'function') return Promise.resolve();
  return new Promise(resolve => {
    const runner = () => {
      try {
        const result = task();
        if (result && typeof result.then === 'function') {
          result
            .catch(error => console.warn(`Error en ${label}:`, error))
            .finally(resolve);
          return;
        }
      } catch (error) {
        console.warn(`Error en ${label}:`, error);
      }
      resolve();
    };
    if (typeof window !== 'undefined' && 'requestIdleCallback' in window) {
      window.requestIdleCallback(runner, { timeout });
    } else {
      setTimeout(runner, timeout);
    }
  });
}

// ========================================================================
//  INICIALIZACIÓN DE JERARQUÍA EN TAB MAPAS
// ========================================================================
async function initTabMapas() {
  console.log('🔄 Inicializando jerarquía en Tab Mapas...');
  console.log('window.HierarchySync disponible:', typeof window.HierarchySync);
  console.log('window.appEvents disponible:', typeof window.appEvents);
  console.log('window.appEvents es EventTarget:', window.appEvents instanceof EventTarget);
  
  try {
    // 1. Obtener datos de mapas y zonas desde MapStorage
    let mapasData = [];
    let zonasData = [];
    
    // Intentar cargar desde MapStorage si está disponible
    if (typeof mapStorage !== 'undefined' && mapStorage.state) {
      mapasData = mapStorage.state.mapas || [];
      zonasData = mapStorage.state.zonas || [];
      console.log(`📦 Datos desde MapStorage: ${mapasData.length} mapas, ${zonasData.length} zonas`);
    }
    
    // Fallback: intentar desde app.mapas/app.zonas
    if (mapasData.length === 0 && typeof app !== 'undefined') {
      mapasData = app.mapas || [];
      zonasData = app.zonas || [];
      console.log(`📦 Datos desde app: ${mapasData.length} mapas, ${zonasData.length} zonas`);
    }
    
    console.log(`📦 Datos disponibles: ${mapasData.length} mapas, ${zonasData.length} zonas`);
    
    // 2. Obtener contenedor HTML
    const container = document.getElementById('hierarchy-tree-container');
    if (!container) {
      console.error('❌ Contenedor #hierarchy-tree-container NO ENCONTRADO');
      throw new Error('Contenedor #hierarchy-tree-container no encontrado');
    }
    console.log('✅ Contenedor encontrado:', container);
    
    // 3. Crear instancia de HierarchySync
    if (typeof window.HierarchySync !== 'function') {
      console.error('❌ HierarchySync NO está disponible');
      throw new Error('HierarchySync no está definido');
    }
    
    window.hierarchySync = new HierarchySync(container, mapasData, zonasData);
    console.log('✅ Instancia HierarchySync creada');
    
    // 4. Configurar eventos ANTES de inicializar
    setupHierarchyEvents();
    console.log('✅ Eventos configurados');
    
    // 5. Inicializar (renderiza el árbol)
    window.hierarchySync.init();
    console.log('✅ Árbol renderizado');
    
    // 6. Conectar búsqueda global
    setupGlobalSearch();
    console.log('✅ Búsqueda global conectada');
    
    console.log('✅ Jerarquía de mapas inicializada correctamente');
    
  } catch (error) {
    console.error('❌ Error al inicializar jerarquía de mapas:', error);
    console.error('Stack:', error.stack);
  }
}

// Configurar eventos de la jerarquía
function setupHierarchyEvents() {
  if (!window.hierarchySync) return;
  
  // Evento: Nodo seleccionado
  window.hierarchySync.on('node-selected', (event) => {
    const { name, mapId, level, hasMap } = event.detail.data;
    console.log(`✅ Nodo seleccionado: ${name} (Nivel ${level})`);
    
    // Emitir evento global para sincronización
    if (window.appEvents) {
      window.appEvents.dispatchEvent(new CustomEvent('mapas-node-selected', {
        detail: { name, mapId, hasMap, level }
      }));
    }
  });
  
  // Evento: Actualizar canvas de mapa
  window.hierarchySync.on('map-canvas-update', (event) => {
    const mapa = event.detail.mapa;
    console.log(`🗺️ Canvas actualizado: ${mapa.name}`);
  });
  
  // 📥 SINCRONIZACIÓN: Escuchar eventos desde Tab Inventario
  if (window.appEvents) {
    window.appEvents.addEventListener('inventario-item-selected', (event) => {
      const { nodoJerarquia, equipoId } = event.detail;
      console.log(`📨 Recibido de Inventario: ${nodoJerarquia} (ID: ${equipoId})`);
      
      // Navegar al nodo en la jerarquía
      if (window.hierarchySync && nodoJerarquia) {
        window.hierarchySync.navigateToNode(nodoJerarquia);
      }
    });
    
    // 📥 SINCRONIZACIÓN: Escuchar eventos desde Tab Jerarquía  
    window.appEvents.addEventListener('jerarquia-node-clicked', (event) => {
      const { nodeName } = event.detail;
      console.log(`📨 Recibido de Jerarquía: ${nodeName}`);
      
      // Sincronizar con vista de mapas
      if (window.hierarchySync && nodeName) {
        window.hierarchySync.navigateToNode(nodeName);
      }
    });
  }
}

// Configurar búsqueda global
function setupGlobalSearch() {
  const searchInput = document.getElementById('globalSearch');
  if (!searchInput) {
    console.warn('⚠️ Input de búsqueda no encontrado');
    return;
  }
  
  // Búsqueda en tiempo real
  searchInput.addEventListener('input', (e) => {
    const term = e.target.value;
    if (window.hierarchySync) {
      window.hierarchySync.filter(term);
    }
  });
  
  // Limpiar con ESC
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      searchInput.value = '';
      if (window.hierarchySync) {
        window.hierarchySync.filter('');
      }
    }
  });
}

// ========================================================================
//  INICIALIZACIN CENTRALIZADA DE LA APLICACIN
// ========================================================================
(async () => {
  console.log('\n Iniciando aplicacin...\n');
  
  // Esperar a que el DOM esté listo
  if (document.readyState === 'loading') {
    await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
  }
  
  // Inicializar modal de carga
  try {
    LoadingModal.init();
  } catch (error) {
    console.warn('No se pudo inicializar LoadingModal:', error);
  }
  try {
    WarmupProgress.start('Sincronizando módulos iniciales...', 15000);
  } catch (error) {
    console.warn('No se pudo iniciar WarmupProgress:', error);
  }
  
  //  PASO 1: Auto-reconexin OPCIONAL si existe sesin previa Y el usuario tiene preferencia activada
  const hasFileSystemSession = localStorage.getItem('fsDirectory') === 'enabled';
  const autoReconnectEnabled = localStorage.getItem('fsAutoReconnect') === 'enabled'; // Por defecto: desactivado
  const postConnectTasks = [];
  
  if (hasFileSystemSession && autoReconnectEnabled) {
    console.log(' Detectada sesin FileSystem previa, intentando auto-reconexin...');
    try {
      if (typeof app !== 'undefined' && typeof app.connectWorkspace === 'function') {
        WarmupProgress.setMessage('Restaurando sesión FileSystem...');
        const connected = await app.connectWorkspace(true, false);
        if (connected) {
          WarmupProgress.setMessage('Carpeta reconectada, preparando interfaz...');
        }
      } else {
        console.warn('app.connectWorkspace no está disponible');
      }
    } catch (error) {
      console.warn('Error en auto-reconexión:', error);
    }
  } else {
    if (!hasFileSystemSession) {
      console.log(' No hay sesin previa - Usuario deber conectar carpeta manualmente');
    } else {
      console.log(' Auto-reconexin desactivada por el usuario');
    }
  }
  
  //  PASO 2: Inicializar la app (sin cargar datos, ya los carg connectWorkspace si fue exitoso)
  // Si NO hubo reconexin, init() cargar desde localStorage
  try {
    if (!fsManager.isConnected) {
      await app.init();
    } else {
      // Solo hacer render sin cargar datos (ya estn cargados por connectWorkspace)
      app.showBrowserWarning();
      
      if (typeof configuracion !== 'undefined') {
        setTimeout(() => {
          configuracion.renderStorageUI();
          configuracion.loadICloudPathConfig();
        }, 100);
      }
      
      app.setupEvents();
      app.setupDelegatedEvents();
      app.setupPhotoInputs();
      WarmupProgress.setMessage('Aplicando estilos personalizados...');
      app.applyViewModeStyles();
      app.updateViewModeInfo();
    // NO llamar loadData() porque connectWorkspace ya lo hizo
    // await app.render(); // Ya se hizo en connectWorkspace
    app.renderFilters();
    
    const savedAutocomplete = localStorage.getItem('autocompleteData');
    if (savedAutocomplete) {
      try {
        app.autocompleteData = JSON.parse(savedAutocomplete);
      } catch (e) {
        console.warn('Error cargando autocomplete guardado, regenerando...', e);
        app.updateAutocompleteData();
      }
    } else {
      app.updateAutocompleteData();
    }
    
    app.setupAutocomplete();
    
    if (document.getElementById('sapTreeContainer')) {
      LoadingModal.setStatus('Preparando jerarquía SAP...');
      LoadingModal.setTip('Estamos precargando el árbol para evitar esperas.');
      const sapTreeTask = deferHeavyTask(() => {
        try {
          app.renderSAPTree();
        } catch (error) {
          console.warn('Error precargando árbol SAP:', error);
        }
      }, { timeout: 900, label: 'pre-render jerarquía SAP' }).then(() => {
        LoadingModal.setStatus('Jerarquía lista');
        LoadingModal.setTip('Puedes abrir la pestaña Jerarquía al cerrar este modal.');
      });
      postConnectTasks.push(sapTreeTask);
    }

    const equipoInput = document.getElementById('equipo');
    if (equipoInput) {
      equipoInput.addEventListener('blur', () => {
        const equipo = equipoInput.value.trim();
        if (equipo) {
          app.cargarSistemasPorEquipo(equipo);
        }
      });
    }
  }
  
  //  PASO 3: Inicializar otros mdulos
  if (document.getElementById('okr')) {
    okrModule.init();
  } else {
    console.log(' Se omiti la inicializacin del mdulo OKR (contenedor no presente).');
  }
  console.log('App inicializada:', app);
  console.log('Repuestos cargados:', app.repuestos.length);
  
  //  Inicializar sistema de backups por inactividad
  if (typeof backupManager !== 'undefined') {
    backupManager.init();
    // Agregar referencia en configuracion para acceso fcil
    if (typeof configuracion !== 'undefined') {
      configuracion.backupManager = backupManager;
    }
  }
  
  //  PASO 2.5: Inicializar MapController si el canvas existe
  if (document.getElementById('mapCanvas')) {
    try {
      mapController.init();
      console.log(' MapController inicializado correctamente');
    } catch (error) {
      console.warn(' Error inicializando MapController:', error);
    }
  } else {
    console.log(' Canvas de mapa no encontrado - MapController no inicializado');
  }
  
  //  PASO 2.6: Inicializar jerarquía en Tab Mapas
  try {
    await initTabMapas();
  } catch (error) {
    console.warn(' Error inicializando jerarquía de mapas:', error);
  }
  
  } catch (error) {
    console.error('❌ Error durante la inicialización de la app:', error);
    // Intentar inicializar de forma básica
    try {
      await app.init();
    } catch (e) {
      console.error('❌ Error crítico en inicialización básica:', e);
      alert('Error crítico al inicializar la aplicación. Por favor, recarga la página.');
    }
  }

  // Inicializar vista Visual 2.0 embebida
  // Deshabilitado - módulo visualTreeV2 no está disponible
  /*
  if (!app.visualV2) {
    const visualV2Wrapper = document.getElementById('jerarquiaVisualV2Container');
    if (window.visualTreeV2Module && visualV2Wrapper) {
      try {
        app.visualV2 = window.visualTreeV2Module.create(app);
        app.visualV2.mount(visualV2Wrapper);
        app.visualV2.render();
        console.log(' Visual 2.0 inicializado');
      } catch (error) {
        console.warn(' Error inicializando Visual 2.0:', error);
      }
    }
  }
  */
  
  //  PASO 3: Limpiar localStorage si estamos en modo FileSystem
  if (fsManager.isFileSystemMode) {
    WarmupProgress.setMessage('Verificando carpeta FileSystem...');
    const limpiezaTask = deferHeavyTask(async () => {
      await app.cleanBase64ImagesFromLocalStorage();
      if (typeof configuracion !== 'undefined' && configuracion.actualizarEstadoUI) {
        configuracion.actualizarEstadoUI();
      }
      console.log('\n');
      console.log(' DIAGNSTICO DE RUTAS Y CARGA');
      console.log('');
      const carpetaNombre = localStorage.getItem('fsFolderName') || 'INVENTARIO_PORTABLE';
      console.log(` Carpeta base: ${carpetaNombre}`);
      console.log(` Storage: ${carpetaNombre}/INVENTARIO_STORAGE`);
      console.log(` Imgenes: ${carpetaNombre}/INVENTARIO_STORAGE/imagenes/`);
      console.log(` JSON: ${carpetaNombre}/INVENTARIO_STORAGE/inventario.json`);
      console.log('\n Repuestos:');
      const conImagenes = app.repuestos.filter(r => r.multimedia && r.multimedia.length > 0);
      const sinImagenes = app.repuestos.filter(r => !r.multimedia || r.multimedia.length === 0);
      console.log(`   Con imgenes: ${conImagenes.length}`);
      console.log(`   Sin imgenes: ${sinImagenes.length}`);
      console.log(`   Total: ${app.repuestos.length}`);
      console.log('\n localStorage:');
      const localData = localStorage.getItem('inventarioData');
      if (localData) {
        const localMB = (new Blob([localData]).size / (1024 * 1024)).toFixed(2);
        console.log(`   Tamao: ${localMB} MB`);
        const data = JSON.parse(localData);
        let base64Count = 0;
        data.forEach(item => {
          if (item.multimedia && item.multimedia.length > 0) {
            item.multimedia.forEach(media => {
              if (media.url && media.url.startsWith('data:image')) {
                base64Count++;
              }
            });
          }
        });
        console.log(`  ${base64Count === 0 ? '' : ''} Imgenes base64: ${base64Count}`);
      } else {
        console.log('   Vaco');
      }
      console.log('\n RESUMEN:');
      console.log(`   Todas las referencias desde: ${carpetaNombre}`);
      console.log('   Imgenes: FileSystem (sin lmites)');
      console.log('   Datos: JSON + localStorage (backup)');
      console.log('   Sin referencias externas');
      console.log('\n');
    }, { timeout: 1200, label: 'limpieza FileSystem' });
    postConnectTasks.push(
      limpiezaTask.then(() => {
        LoadingModal.setStatus('Diagnóstico terminado');
        LoadingModal.setTip('Carpeta verificada, interfaz lista.');
      })
    );
  }
  
  //  OCULTAR INDICADOR DE CARGA
  console.log(' Aplicación completamente inicializada');
  if (postConnectTasks.length) {
    WarmupProgress.setMessage('Ultimando detalles...');
  }
  try {
    await Promise.allSettled(postConnectTasks);
    WarmupProgress.finish('Interfaz lista');
  } catch (error) {
    console.warn('No se pudo finalizar WarmupProgress:', error);
  }
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) {
    loadingIndicator.style.opacity = '0';
    loadingIndicator.style.transition = 'opacity 0.3s ease-out';
    setTimeout(() => loadingIndicator.remove(), 300);
  }
})();

// Toggle dropdowns - Funcin global
function toggleDropdown(dropdownId) {
  const dropdown = document.getElementById(dropdownId);
  const isOpen = dropdown.style.display === 'block';
  
  // Cerrar todos los dropdowns
  document.querySelectorAll('[id$="Dropdown"]').forEach(d => {
    d.style.display = 'none';
  });
  
  // Toggle el seleccionado
  if (!isOpen) {
    dropdown.style.display = 'block';
  }
}

// Cerrar dropdowns al hacer click fuera
document.addEventListener('click', (e) => {
  if (!e.target.closest('[onclick*="toggleDropdown"]') && !e.target.closest('.dropdown-item')) {
    document.querySelectorAll('[id$="Dropdown"]').forEach(d => {
      d.style.display = 'none';
    });
  }
});

//  FUNCIONES DEMO PARA NOTIFICACIONES PERSISTENTE
// Agregar estas funciones al objeto app para fcil acceso desde consola

//  FUNCIN DE PRUEBA DIRECTA
app.testCampana = function() {
  console.log(' Probando campana directamente...');
  
  const bell = document.getElementById('notificationBell');
  const panel = document.getElementById('notificationPanel');
  
  console.log('Elementos:', { bell: !!bell, panel: !!panel });
  
  if (bell && panel) {
    console.log(' Elementos encontrados');
    
    // Prueba directa del toggle
    bell.addEventListener('click', function() {
      console.log(' CLICK DIRECTO DETECTADO!');
      const isActive = panel.classList.contains('active');
      console.log('Estado actual:', isActive ? 'abierto' : 'cerrado');
      
      if (isActive) {
        panel.classList.remove('active');
        console.log('Panel cerrado');
      } else {
        panel.classList.add('active');
        console.log('Panel abierto');
      }
    });
    
    console.log(' Event listener agregado - Haz click en la campana');
  } else {
    console.error(' Elementos no encontrados');
  }
};

// FUNCIN DE PRUEBA SIMPLE
app.testNotificationBell = function() {
  console.log(' Probando sistema bsico...');
  
  // Verificar elementos
  const bell = document.getElementById('notificationBell');
  const panel = document.getElementById('notificationPanel');
  
  console.log('Elementos encontrados:', {
    bell: !!bell,
    panel: !!panel
  });
  
  if (bell) {
    console.log(' Campana encontrada, agregando click listener...');
    bell.addEventListener('click', () => {
      console.log(' CLICK DETECTADO EN CAMPANA!');
      if (panel) {
        panel.classList.toggle('active');
        console.log('Panel toggled:', panel.classList.contains('active'));
      }
    });
  }
  
  // Crear una notificacin de prueba directamente
  if (this.addNotification) {
    this.addNotification(' Prueba de notificacin', 'info');
    console.log(' Notificacin de prueba agregada');
  }
};

app.demoNotifications = function() {
  console.log(' Demostrando sistema de notificaciones persistente...');
  
  // Secuencia de notificaciones de prueba
  setTimeout(() => {
    this.showToast(' Sistema de notificaciones activado - Revisa la campana ', 'info');
  }, 500);
  
  setTimeout(() => {
    this.showToast(' Notificaciones ahora se guardan permanentemente', 'success');
  }, 1500);
  
  setTimeout(() => {
    this.showToast(' Indicador rojo aparece con notificaciones sin leer', 'warning');
  }, 2500);
  
  setTimeout(() => {
    this.showToast(' Click en la campana abre el panel completo', 'error');
  }, 3500);
  
  setTimeout(() => {
    this.showToast(' Historial persistente con fecha y hora', 'info');
  }, 4500);
  
  setTimeout(() => {
    console.log(' INSTRUCCIONES DEL SISTEMA:');
    console.log('  Campana arriba a la derecha');
    console.log('  Punto rojo = notificaciones sin leer');
    console.log('  Contador numrico de pendientes');
    console.log('  Panel con historial completo');
    console.log('  Marcar como ledas automticamente');
  }, 6000);
};

app.demoNotificationTypes = function() {
  console.log(' Probando diferentes tipos de notificaciones...');
  
  const messages = [
    { msg: ' Informacin general del sistema', type: 'info' },
    { msg: ' Operacin completada exitosamente', type: 'success' },
    { msg: ' Advertencia importante para el usuario', type: 'warning' },
    { msg: ' Error crtico que necesita atencin', type: 'error' },
    { msg: ' Mantenimiento programado prximamente', type: 'info' },
    { msg: ' Backup automtico completado', type: 'success' }
  ];
  
  messages.forEach((item, index) => {
    setTimeout(() => {
      this.showToast(item.msg, item.type);
    }, index * 800);
  });
  
  setTimeout(() => {
    console.log(' Observa la campana:');
    console.log(` Contador debera mostrar: ${messages.length}`);
    console.log(' Punto rojo pulsando');
    console.log(' Click para ver el historial completo');
  }, messages.length * 800 + 1000);
};

// Obtiene el contenedor activo de la jerarquía
app.getActiveJerarquiaContainer = function() {
  return document.getElementById('jerarquiaTreeContainer');
};

// ============================================================
//  FUNCIONES DE BÚSQUEDA Y PALETAS PARA JERARQUÍA
// ============================================================

// Cambiar paleta de colores de la jerarquía
app.changeJerarquiaPalette = function() {
  const select = document.getElementById('jerarquiaPaletteSelect');
  const container = document.getElementById('jerarquiaTreeContainer');
  
  if (!select || !container) {
    console.error('No se encontraron los elementos necesarios');
    return;
  }
  
  const selectedPalette = select.value;

  if (selectedPalette === 'visual-v2') {
    this.changeJerarquiaPaletteByTab('visual-v2');
    return;
  }
  
  // Remover todas las clases de paleta anteriores
  container.classList.remove('palette-8', 'palette-9', 'palette-visual');
  
  // Agregar la nueva paleta seleccionada (excepto 'original' que no necesita clase)
  if (selectedPalette !== 'original') {
    container.classList.add(selectedPalette);
  }
  
  if (selectedPalette === 'palette-visual') {
    container.style.setProperty('min-height', '600px');
    container.style.setProperty('height', 'auto');
    container.style.setProperty('overflow', 'visible');
    container.style.setProperty('padding', '40px');
    container.style.setProperty('background', '#1e2229');
  } else {
    container.style.removeProperty('min-height');
    container.style.removeProperty('height');
    container.style.removeProperty('overflow');
    container.style.removeProperty('padding');
    container.style.removeProperty('background');
  }
  
  console.log(`✓ Vista cambiada a: ${selectedPalette}`);
  
  // Guardar preferencia en localStorage
  localStorage.setItem('jerarquiaPalettePreference', 'palette-visual');
  
  // Re-renderizar el árbol para aplicar el nuevo formato
  this.renderJerarquiaTree();
};

// Expandir todos los nodos de la jerarquía
app.expandirTodoJerarquia = function() {
  const treeChildren = document.querySelectorAll('.tree-children');
  const toggles = document.querySelectorAll('.node-toggle');
  
  treeChildren.forEach(children => {
    children.style.display = 'block';
  });
  
  toggles.forEach(toggle => {
    toggle.textContent = '›';
    toggle.classList.remove('collapsed');
    toggle.classList.add('expanded');
  });
  
  // Guardar todos los nodos como expandidos
  document.querySelectorAll('.node-content[data-node-id]').forEach(node => {
    const nodeId = node.getAttribute('data-node-id');
    const legacyId = this.getLegacyIdFromNodeContent(node);
    if (nodeId) {
      this.saveNodeExpandState(nodeId, true, legacyId);
    }
  });
  
  console.log('✅ Todos los nodos expandidos y estado guardado');
};

// Contraer todos los nodos de la jerarquía
app.contraerTodoJerarquia = function() {
  const allTreeChildren = document.querySelectorAll('.tree-children');
  const toggles = document.querySelectorAll('.node-toggle');
  
  // Contraer todos excepto el primer nivel (mantener áreas visibles)
  allTreeChildren.forEach((children, index) => {
    if (index > 0) {
      children.style.display = 'none';
    }
  });
  
  // Actualizar iconos de toggle
  toggles.forEach((toggle, index) => {
    if (index > 0) {
      toggle.textContent = '›';
      toggle.classList.remove('expanded');
      toggle.classList.add('collapsed');
    }
  });
  
  // Guardar todos los nodos como contraídos excepto el primero
  document.querySelectorAll('.node-content[data-node-id]').forEach((node, index) => {
    const nodeId = node.getAttribute('data-node-id');
    const legacyId = this.getLegacyIdFromNodeContent(node);
    if (nodeId) {
      this.saveNodeExpandState(nodeId, index === 0, legacyId); // Solo el primero expandido
    }
  });
  
  console.log('✅ Todos los nodos contraídos y estado guardado');
};

// 🔍 Sistema de búsqueda en jerarquía
app.jerarquiaSearchState = {
  index: [],
  matches: [],
  selectedIndex: -1,
  debounceHandle: null,
  lastQuery: '',
  isFilterActive: false,
  activeMatch: null
};

app.initJerarquiaSearch = function() {
  const searchInput = document.getElementById('jerarquiaTreeSearchInput');
  const suggestionsContainer = document.getElementById('jerarquiaSearchSuggestions');

  if (!searchInput || !suggestionsContainer) {
    console.warn('⚠️ Elementos de búsqueda no encontrados');
    return;
  }

  if (this._jerarquiaSearchInitialized) {
    return;
  }
  this._jerarquiaSearchInitialized = true;

  searchInput.addEventListener('input', (event) => {
    const value = event.target.value || '';
    clearTimeout(this.jerarquiaSearchState.debounceHandle);

    if (!value.trim()) {
      this.clearJerarquiaSearch();
      return;
    }

    this.jerarquiaSearchState.debounceHandle = setTimeout(() => {
      this.performJerarquiaSearch(value);
    }, 250);
  });

  searchInput.addEventListener('keydown', (event) => {
    this.handleJerarquiaSearchKeydown(event);
  });

  searchInput.addEventListener('focus', () => {
    const value = searchInput.value || '';
    if (value.trim()) {
      this.performJerarquiaSearch(value);
    }
  });

  this._jerarquiaSearchOutsideHandler = (event) => {
    if (!suggestionsContainer.contains(event.target) && event.target !== searchInput) {
      suggestionsContainer.classList.remove('active');
    }
  };

  document.addEventListener('click', this._jerarquiaSearchOutsideHandler);
  console.log('🔍 Búsqueda de jerarquía inicializada');
};

app.updateJerarquiaSearchStatus = function(message = '', variant = '') {
  const statusElement = document.getElementById('jerarquiaSearchStatus');
  if (statusElement) {
    statusElement.textContent = message;
    statusElement.classList.remove('success', 'warning');

    if (message && variant) {
      statusElement.classList.add(variant);
    }
  }
};

app.collapseJerarquiaTree = function() {
  const container = this.getActiveJerarquiaContainer();
  if (!container) return;

  (container.querySelectorAll('.tree-children') || []).forEach((children) => {
    children.style.display = 'none';
  });

  (container.querySelectorAll('.node-toggle') || []).forEach((toggle) => {
    toggle.classList.remove('expanded');
    toggle.classList.add('collapsed');
    toggle.textContent = '›';
  });
};

app.resetJerarquiaTreeView = function() {
  const container = this.getActiveJerarquiaContainer();
  if (!container) return;

  (container.querySelectorAll('.tree-children') || []).forEach((children) => {
    children.style.display = 'block';
  });

  (container.querySelectorAll('.node-toggle') || []).forEach((toggle) => {
    toggle.classList.remove('collapsed');
    toggle.classList.add('expanded');
    toggle.textContent = '›';
  });
};

app.buildJerarquiaSearchIndex = function() {
  const index = [];
  const data = this.jerarquiaAnidada;

  if (!data) {
    this.jerarquiaSearchState.index = index;
    return;
  }

  const empresaNombre = data.empresa?.nombre || 'Empresa';
  const empresaId = data.empresa?.id || '';

  if (data.empresa) {
    index.push({
      id: empresaId,
      nombre: empresaNombre,
      nivel: 'Empresa',
      path: empresaNombre,
      indices: []
    });
  }

  const pushNode = (node, nivel, path, indices) => {
    index.push({
      id: node?.id || '',
      nombre: node?.nombre || '',
      nivel,
      path,
      indices: [...indices]
    });
  };

  const areas = Array.isArray(data.areas) ? data.areas : [];

  areas.forEach((area, aIdx) => {
    const areaNombre = area?.nombre || 'Área';
    const areaPath = `${empresaNombre} > ${areaNombre}`;
    pushNode(area, 'Área', areaPath, [aIdx]);

    const subAreas = Array.isArray(area?.subAreas) ? area.subAreas : [];
    subAreas.forEach((subArea, saIdx) => {
      const subAreaNombre = subArea?.nombre || 'Sub-Área';
      const subAreaPath = `${areaPath} > ${subAreaNombre}`;
      pushNode(subArea, 'Sub-Área', subAreaPath, [aIdx, saIdx]);

      const sistemas = Array.isArray(subArea?.sistemas) ? subArea.sistemas : [];
      sistemas.forEach((sistema, sIdx) => {
        const sistemaNombre = sistema?.nombre || 'Sistema';
        const sistemaPath = `${subAreaPath} > ${sistemaNombre}`;
        pushNode(sistema, 'Sistema', sistemaPath, [aIdx, saIdx, sIdx]);

        const subSistemas = Array.isArray(sistema?.subSistemas) ? sistema.subSistemas : [];
        subSistemas.forEach((subSistema, ssIdx) => {
          const subSistemaNombre = subSistema?.nombre || 'Sub-Sistema';
          const subSistemaPath = `${sistemaPath} > ${subSistemaNombre}`;
          pushNode(subSistema, 'Sub-Sistema', subSistemaPath, [aIdx, saIdx, sIdx, ssIdx]);

          const secciones = Array.isArray(subSistema?.secciones) ? subSistema.secciones : [];
          secciones.forEach((seccion, secIdx) => {
            const seccionNombre = seccion?.nombre || 'Sección';
            const seccionPath = `${subSistemaPath} > ${seccionNombre}`;
            pushNode(seccion, 'Sección', seccionPath, [aIdx, saIdx, sIdx, ssIdx, secIdx]);

            const subSecciones = Array.isArray(seccion?.subSecciones) ? seccion.subSecciones : [];
            subSecciones.forEach((subSeccion, subSecIdx) => {
              const subSeccionNombre = subSeccion?.nombre || 'Sub-Sección';
              const subSeccionPath = `${seccionPath} > ${subSeccionNombre}`;
              pushNode(subSeccion, 'Sub-Sección', subSeccionPath, [aIdx, saIdx, sIdx, ssIdx, secIdx, subSecIdx]);
            });
          });
        });
      });
    });
  });

  this.jerarquiaSearchState.index = index;
};

app.performJerarquiaSearch = function(rawQuery) {
  const suggestionsContainer = document.getElementById('jerarquiaSearchSuggestions');
  if (!suggestionsContainer) return;

  const query = (rawQuery || '').trim();
  this.jerarquiaSearchState.lastQuery = query;

  if (!query) {
    this.clearJerarquiaSearch();
    return;
  }

  const normalized = query.toLowerCase();
  const matches = this.jerarquiaSearchState.index.filter((item) => {
    const idMatch = item.id && item.id.toLowerCase().includes(normalized);
    const nameMatch = item.nombre && item.nombre.toLowerCase().includes(normalized);
    return idMatch || nameMatch;
  });

  this.jerarquiaSearchState.matches = matches;
  this.jerarquiaSearchState.selectedIndex = matches.length ? 0 : -1;
  this.jerarquiaSearchState.isFilterActive = false;
  this.jerarquiaSearchState.activeMatch = null;

  if (matches.length === 0) {
    this.updateJerarquiaSearchStatus('No se encontraron resultados', 'warning');
  } else {
    this.updateJerarquiaSearchStatus(`${matches.length} resultado(s)`);
  }

  this.renderJerarquiaSuggestions(matches, query);
  this.highlightJerarquiaMatches(query);
};

app.renderJerarquiaSuggestions = function(matches, rawQuery) {
  const suggestionsContainer = document.getElementById('jerarquiaSearchSuggestions');
  if (!suggestionsContainer) return;

  if (!matches || matches.length === 0) {
    suggestionsContainer.innerHTML = '<div class="jerarquia-suggestion-item" style="opacity: 0.6;">No se encontraron resultados</div>';
    suggestionsContainer.classList.add('active');
    return;
  }

  const escapeHtml = (text = '') => text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const escapeRegex = (value = '') => value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const highlightText = (text = '') => {
    if (!rawQuery.trim()) {
      return escapeHtml(text);
    }

    const pattern = new RegExp(`(${escapeRegex(rawQuery.trim())})`, 'gi');
    return text
      .split(pattern)
      .map((segment, idx) => (idx % 2 === 1 ? `<mark class="jerarquia-match">${escapeHtml(segment)}</mark>` : escapeHtml(segment)))
      .join('');
  };

  const limited = matches.slice(0, 12);

  if (this.jerarquiaSearchState.selectedIndex > limited.length - 1) {
    this.jerarquiaSearchState.selectedIndex = limited.length ? limited.length - 1 : -1;
  }

  suggestionsContainer.innerHTML = limited
    .map((match, index) => `
      <div class="jerarquia-suggestion-item ${index === this.jerarquiaSearchState.selectedIndex ? 'selected' : ''}"
           data-suggestion-index="${index}"
           onclick="app.handleJerarquiaSuggestionClick(${index})">
        <div class="jerarquia-suggestion-main">
          <span class="jerarquia-suggestion-id">${highlightText(match.id || '—')}</span>
          <span>${highlightText(match.nombre || 'Sin nombre')}</span>
        </div>
        <div class="jerarquia-suggestion-meta">
          <span>${highlightText(match.nivel || '')}</span>
          <span>•</span>
          <span class="jerarquia-suggestion-path">${highlightText(match.path || '')}</span>
        </div>
      </div>
    `)
    .join('');

  suggestionsContainer.classList.add('active');
  this.updateJerarquiaSuggestionSelection();
};

app.updateJerarquiaSuggestionSelection = function() {
  const suggestionsContainer = document.getElementById('jerarquiaSearchSuggestions');
  if (!suggestionsContainer) return;

  const items = suggestionsContainer.querySelectorAll('.jerarquia-suggestion-item');
  items.forEach((item, index) => {
    item.classList.toggle('selected', index === this.jerarquiaSearchState.selectedIndex);
    if (index === this.jerarquiaSearchState.selectedIndex) {
      item.scrollIntoView({ block: 'nearest' });
    }
  });
};

app.handleJerarquiaSuggestionClick = function(index) {
  const suggestionsContainer = document.getElementById('jerarquiaSearchSuggestions');
  if (suggestionsContainer) {
    suggestionsContainer.classList.remove('active');
  }

  const match = this.jerarquiaSearchState.matches[index];
  if (!match) {
    return;
  }

  this.jerarquiaSearchState.selectedIndex = index;
  this.focusJerarquiaSearchResult(match);
};

app.handleJerarquiaSearchKeydown = function(event) {
  const suggestionsContainer = document.getElementById('jerarquiaSearchSuggestions');
  const matchesCount = this.jerarquiaSearchState.matches.length;

  if (event.key === 'Enter') {
    if (suggestionsContainer && suggestionsContainer.classList.contains('active') && matchesCount > 0) {
      event.preventDefault();
      const index = this.jerarquiaSearchState.selectedIndex >= 0 ? this.jerarquiaSearchState.selectedIndex : 0;
      this.handleJerarquiaSuggestionClick(index);
    }
    return;
  }

  if (!suggestionsContainer || !suggestionsContainer.classList.contains('active') || matchesCount === 0) {
    if (event.key === 'Escape') {
      suggestionsContainer?.classList.remove('active');
    }
    return;
  }

  const visibleItems = Math.min(matchesCount, 12);

  if (event.key === 'ArrowDown') {
    event.preventDefault();
    if (this.jerarquiaSearchState.selectedIndex < 0) {
      this.jerarquiaSearchState.selectedIndex = 0;
    } else {
      this.jerarquiaSearchState.selectedIndex = Math.min(this.jerarquiaSearchState.selectedIndex + 1, visibleItems - 1);
    }
    this.updateJerarquiaSuggestionSelection();
  } else if (event.key === 'ArrowUp') {
    event.preventDefault();
    if (this.jerarquiaSearchState.selectedIndex <= 0) {
      this.jerarquiaSearchState.selectedIndex = 0;
    } else {
      this.jerarquiaSearchState.selectedIndex = Math.max(this.jerarquiaSearchState.selectedIndex - 1, 0);
    }
    this.updateJerarquiaSuggestionSelection();
  } else if (event.key === 'Escape') {
    suggestionsContainer.classList.remove('active');
  }
};

app.highlightJerarquiaMatches = function(rawQuery) {
  const query = (rawQuery || '').trim().toLowerCase();
  this.clearJerarquiaSearchHighlights();

  if (!query) {
    return;
  }

  const container = this.getActiveJerarquiaContainer();
  if (!container) return;

  container.querySelectorAll('.node-content').forEach((node) => {
    const idText = node.querySelector('.node-id')?.textContent || '';
    const nameText = node.querySelector('.node-name')?.textContent || '';
    if (`${idText} ${nameText}`.toLowerCase().includes(query)) {
      node.classList.add('search-match');
    }
  });
};

app.clearJerarquiaSearchHighlights = function() {
  const container = this.getActiveJerarquiaContainer();
  if (!container) return;

  container.querySelectorAll('.node-content').forEach((node) => {
    node.classList.remove('search-match', 'search-highlight');
  });
};

app.focusJerarquiaSearchResult = function(match) {
  if (!match) {
    return;
  }

  const container = this.getActiveJerarquiaContainer();
  if (!container) return;

  const hasIndices = Array.isArray(match.indices) && match.indices.length > 0;

  if (hasIndices) {
    this.collapseJerarquiaTree();
    this.expandJerarquiaPath(match.indices);
    this.jerarquiaSearchState.isFilterActive = true;
  } else {
    this.resetJerarquiaTreeView();
    this.jerarquiaSearchState.isFilterActive = false;
  }

  this.jerarquiaSearchState.activeMatch = match;

  const searchInput = document.getElementById('jerarquiaTreeSearchInput');
  if (searchInput) {
    searchInput.value = match.nombre || match.id || '';
  }

  this.clearJerarquiaSearchHighlights();
  this.highlightJerarquiaMatches(this.jerarquiaSearchState.lastQuery);

  if (hasIndices) {
    this.updateJerarquiaSearchStatus('✓ Filtrado activo', 'success');
  } else {
    this.updateJerarquiaSearchStatus('Empresa seleccionada', 'success');
  }

  let targetElement = null;

  if (Array.isArray(match.indices) && match.indices.length) {
    const selector = `.tree-node[data-node-index="${match.indices.join(',')}"] > .node-content`;
    targetElement = container.querySelector(selector);
  }

  if (!targetElement) {
    targetElement = Array.from(container.querySelectorAll('.node-content')).find((node) => {
      const idText = node.querySelector('.node-id')?.textContent?.trim().toLowerCase();
      const nameText = node.querySelector('.node-name')?.textContent?.trim().toLowerCase();
      return (match.id && idText === match.id.toLowerCase()) || (match.nombre && nameText === match.nombre.toLowerCase());
    }) || null;
  }

  if (targetElement) {
    targetElement.classList.add('search-highlight');
    setTimeout(() => {
      targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
  }
};

app.expandJerarquiaPath = function(indices) {
  const container = this.getActiveJerarquiaContainer();
  if (!container) return;

  if (!Array.isArray(indices) || indices.length === 0) {
    return;
  }

  const rootChildren = container.querySelector('.tree-container > .tree-node > .tree-children');
  if (rootChildren) {
    rootChildren.style.display = 'block';
  }

  const ensureExpanded = (treeNode) => {
    if (!treeNode) return;
    const children = treeNode.querySelector(':scope > .tree-children');
    if (children) {
      children.style.display = 'block';
    }
    const toggle = treeNode.querySelector(':scope > .node-content .node-toggle');
    if (toggle) {
      toggle.classList.remove('collapsed');
      toggle.classList.add('expanded');
      toggle.textContent = '›';
    }
  };

  const path = [];

  indices.forEach((segment) => {
    path.push(segment);
    const selector = `.tree-node[data-node-index="${path.join(',')}"]`;
    const node = container.querySelector(selector);
    if (node) {
      ensureExpanded(node.parentElement?.closest('.tree-node'));
      ensureExpanded(node);
    }
  });
};

app.clearJerarquiaSearch = function(context = {}) {
  const suggestionsContainer = document.getElementById('jerarquiaSearchSuggestions');
  const input = document.getElementById('jerarquiaTreeSearchInput');

  if (input && !context.preserveInput) {
    input.value = '';
  }

  if (suggestionsContainer) {
    suggestionsContainer.innerHTML = '';
    suggestionsContainer.classList.remove('active');
  }

  this.jerarquiaSearchState.matches = [];
  this.jerarquiaSearchState.selectedIndex = -1;
  this.jerarquiaSearchState.lastQuery = '';
  this.jerarquiaSearchState.isFilterActive = false;
  this.jerarquiaSearchState.activeMatch = null;
  this.clearJerarquiaSearchHighlights();
  this.resetJerarquiaTreeView();
  this.updateJerarquiaSearchStatus('');
};

// Hacer la app accesible globalmente para debugging
window.app = app;
window.okrModule = okrModule;
window.mapStorage = mapStorage; //  AHORA DISPONIBLE - MapStorage integrado
window.mapController = mapController; //  Controlador de mapas
console.log('App disponible en: window.app');
console.log('=== SISTEMA LISTO ===');

// 🎨 Inicializar MapasUI cuando todo esté cargado
document.addEventListener('DOMContentLoaded', () => {
  if (window.MapasUI) {
    // Inicializar subsecciones
    window.MapasUI.initializeSubsections();
    
    // Inicializar eventos
    window.MapasUI.initializeEvents();
    
    // Actualizar stats iniciales
    window.MapasUI.updateStats();
    
    // Renderizar secciones con datos
    if (window.mapStorage && window.mapStorage.state) {
      if (window.mapStorage.state.mapas) {
        window.MapasUI.renderMapasList(window.mapStorage.state.mapas);
      }
      window.MapasUI.renderPendientes();
      window.MapasUI.renderEstadisticas();
    }
    
    // Renderizar jerarquía usando HierarchySync
    if (window.HierarchySync && window.mapStorage) {
      setTimeout(() => {
        const container = document.getElementById('hierarchy-tree-container');
        if (container) {
          window.HierarchySync.render(container);
        }
      }, 500);
    }
    
    console.log('✅ MapasUI inicializado');
  }
});

// 🔗 Exponer funciones globales para onclick en HTML
function switchPanelTab(tabName) {
  if (window.MapasUI) {
    window.MapasUI.switchPanelTab(tabName);
  }
}

function scrollToSection(sectionId) {
  if (window.MapasUI) {
    window.MapasUI.scrollToSection(sectionId);
  }
}

function filterHierarchy(searchTerm) {
  if (window.MapasUI) {
    window.MapasUI.filterHierarchy(searchTerm);
  }
}

function toggleSection(headerElement) {
  if (window.MapasUI) {
    window.MapasUI.toggleSection(headerElement);
  }
}

//  FUNCIONES DE ZOOM GLOBAL (zoom CSS puro - estilo navegador)
let currentZoom = 100;
const minZoom = 50;
const maxZoom = 150;
const zoomStep = 10;

function updateZoom(newZoom) {
  currentZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
  
  const zoomRatio = currentZoom / 100;
  
  // Usar solo zoom CSS (el que funcionaba mejor)
  document.body.style.zoom = zoomRatio;
  
  // Actualizar indicador
  const zoomLevel = document.getElementById('zoomLevel');
  if (zoomLevel) {
    zoomLevel.textContent = `${currentZoom}%`;
  }
  
  // Guardar en localStorage
  localStorage.setItem('appZoom', currentZoom);
  
  console.log(` Zoom ajustado: ${currentZoom}% (zoom CSS puro)`);
}

// ========================================
// SISTEMA DE HISTORIAL (UNDO/REDO)
// ========================================
let undoStack = [];
let redoStack = [];
const MAX_HISTORY = 50;

function saveState(action, data) {
  const state = {
    action: action,
    data: JSON.parse(JSON.stringify(data)),
    timestamp: Date.now()
  };
  
  undoStack.push(state);
  if (undoStack.length > MAX_HISTORY) {
    undoStack.shift();
  }
  
  // Limpiar redo stack cuando se hace una nueva acción
  redoStack = [];
  
  console.log(`💾 Estado guardado: ${action}`, undoStack.length);
}

function undoAction() {
  if (undoStack.length === 0) {
    showNotification('No hay acciones para deshacer', 'info');
    return;
  }
  
  const state = undoStack.pop();
  redoStack.push(state);
  
  restoreState(state, 'undo');
  showNotification(`Deshecho: ${state.action}`, 'success');
  console.log(`↶ Deshacer: ${state.action}`, undoStack.length);
}

function redoAction() {
  if (redoStack.length === 0) {
    showNotification('No hay acciones para rehacer', 'info');
    return;
  }
  
  const state = redoStack.pop();
  undoStack.push(state);
  
  restoreState(state, 'redo');
  showNotification(`Rehecho: ${state.action}`, 'success');
  console.log(`↷ Rehacer: ${state.action}`, redoStack.length);
}

function restoreState(state, operation) {
  // Restaurar el estado según el tipo de acción
  switch(state.action) {
    case 'add':
      if (operation === 'undo') {
        // Eliminar el item agregado
        const index = app.repuestos.findIndex(r => r.id === state.data.id);
        if (index !== -1) {
          app.repuestos.splice(index, 1);
        }
      } else {
        // Volver a agregar el item
        app.repuestos.push(state.data);
      }
      break;
      
    case 'edit':
      if (operation === 'undo') {
        // Restaurar datos originales
        const index = app.repuestos.findIndex(r => r.id === state.data.original.id);
        if (index !== -1) {
          app.repuestos[index] = state.data.original;
        }
      } else {
        // Aplicar datos editados
        const index = app.repuestos.findIndex(r => r.id === state.data.edited.id);
        if (index !== -1) {
          app.repuestos[index] = state.data.edited;
        }
      }
      break;
      
    case 'delete':
      if (operation === 'undo') {
        // Restaurar item eliminado
        app.repuestos.push(state.data);
      } else {
        // Eliminar nuevamente
        const index = app.repuestos.findIndex(r => r.id === state.data.id);
        if (index !== -1) {
          app.repuestos.splice(index, 1);
        }
      }
      break;
  }
  
  // Actualizar vista
  app.render();
  app.saveData();
}

// ========================================
// NOTIFICACIONES GENÉRICAS
// ========================================
function showNotification(message, type = 'info') {
  if (window.app && typeof app.showToast === 'function') {
    app.showToast(message, type);
    return;
  }

  const prefix = type ? `[${type.toUpperCase()}]` : '';
  const logFn = type === 'error' ? console.error : type === 'warning' ? console.warn : console.log;
  logFn(`${prefix} ${message}`);
}

// ========================================
// FUNCIÓN PARA LIMPIAR BÚSQUEDA
// ========================================
function clearSearch() {
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.value = '';
    searchInput.focus();
    // Disparar evento para que se apliquen los filtros
    if (app && typeof app.applyFilters === 'function') {
      app.applyFilters();
    }
    showNotification('Búsqueda limpiada', 'info');
  }
}

function clearJerarquiaSearch() {
  const searchInput = document.getElementById('jerarquiaSearchInput');
  if (searchInput) {
    searchInput.value = '';
    searchInput.focus();
    // Disparar evento para limpiar el filtro de jerarquía
    const event = new Event('input', { bubbles: true });
    searchInput.dispatchEvent(event);
    showNotification('Búsqueda de jerarquía limpiada', 'info');
  }
}

// ========================================
// DEBUGGING DE PERSISTENCIA
// ========================================
function debugPersistencia() {
  console.log('\n🐛 ===== DEBUG PERSISTENCIA =====');
  
  try {
    const stateKey = 'jerarquia_expand_state';
    const state = JSON.parse(localStorage.getItem(stateKey) || '{}');
    const stateCount = Object.keys(state).length;
    
    console.log(`📊 Total estados guardados: ${stateCount}`);
    console.log(`📦 Contenido localStorage:`, state);
    
    // Verificar nodos en DOM actual
    const nodesInDom = document.querySelectorAll('.node-content[data-node-id]');
    console.log(`🌲 Nodos en DOM actual: ${nodesInDom.length}`);
    
    const domIds = [];
    nodesInDom.forEach(node => {
      const id = node.getAttribute('data-node-id');
      if (id) domIds.push(id);
    });
    console.log(`🏷️ IDs en DOM:`, domIds);
    
    // Comparar
    const stateIds = Object.keys(state);
    const inStateNotInDom = stateIds.filter(id => !domIds.includes(id));
    const inDomNotInState = domIds.filter(id => !stateIds.includes(id));
    
    if (inStateNotInDom.length > 0) {
      console.warn(`⚠️ IDs en localStorage pero NO en DOM:`, inStateNotInDom);
    }
    if (inDomNotInState.length > 0) {
      console.log(`ℹ️ IDs en DOM pero NO en localStorage:`, inDomNotInState);
    }
    
    // Verificar estados actuales en el DOM
    console.log('\n🔍 Estados actuales en el DOM:');
    nodesInDom.forEach((nodeContent, index) => {
      const nodeId = nodeContent.getAttribute('data-node-id');
      const treeNode = nodeContent.closest('.tree-node');
      const children = treeNode ? treeNode.querySelector(':scope > .tree-children') : null;
      const toggle = nodeContent.querySelector('.node-toggle');
      
      if (children && toggle) {
        const isExpanded = children.style.display !== 'none';
        const savedState = state[nodeId];
        const match = savedState === isExpanded;
        
        console.log(`${match ? '✅' : '❌'} [${index}] ${nodeId}: DOM=${isExpanded ? 'EXPAND' : 'COLLAPSED'}, Storage=${savedState !== undefined ? (savedState ? 'EXPAND' : 'COLLAPSED') : 'N/A'}`);
      }
    });
    
    console.log('\n✅ Debug completado. Revisa la consola arriba.');
    showNotification('Debug info en consola', 'info');
    
  } catch (e) {
    console.error('❌ Error en debug:', e);
  }
}

function resetPersistencia() {
  if (confirm('¿Seguro que quieres borrar todos los estados guardados de la jerarquía?')) {
    try {
      localStorage.removeItem('jerarquia_expand_state');
      console.log('🗑️ Estados de persistencia eliminados');
      showNotification('Estados limpiados. Recarga la página para ver cambios.', 'success');
      
      // Re-renderizar para aplicar estados por defecto
      if (app && typeof app.renderJerarquiaTree === 'function') {
        app.renderJerarquiaTree();
      }
    } catch (e) {
      console.error('❌ Error limpiando estados:', e);
      showNotification('Error al limpiar estados', 'error');
    }
  }
}

// ========================================
// ZOOM FUNCTIONS
// ========================================
function zoomIn() {
  updateZoom(currentZoom + zoomStep);
}

function zoomOut() {
  updateZoom(currentZoom - zoomStep);
}

function zoomReset() {
  updateZoom(100);
}

// Restaurar zoom guardado al cargar
const savedZoom = localStorage.getItem('appZoom');
if (savedZoom) {
  setTimeout(() => {
    updateZoom(parseInt(savedZoom));
    console.log(` Zoom restaurado: ${savedZoom}%`);
  }, 100);
}

// Atajos de teclado para zoom (Ctrl + y Ctrl -)
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    if (e.key === '+' || e.key === '=') {
      e.preventDefault();
      zoomIn();
    } else if (e.key === '-' || e.key === '_') {
      e.preventDefault();
      zoomOut();
    } else if (e.key === '0') {
      e.preventDefault();
      zoomReset();
    } else if (e.key === 'z' || e.key === 'Z') {
      e.preventDefault();
      undoAction();
    } else if (e.key === 'y' || e.key === 'Y') {
      e.preventDefault();
      redoAction();
    }
  }
});

console.log(' Controles de zoom inicializados (zoom CSS puro - navegador)');
console.log('⌨️ Atajos de teclado: Ctrl+Z (Deshacer) | Ctrl+Y (Rehacer)');

//  Mostrar resolucin actual
function updateResolutionDisplay() {
  const resolutionDiv = document.getElementById('screenResolution');
  if (resolutionDiv) {
    const width = window.innerWidth;
    const height = window.innerHeight;
    const ratio = (width / height).toFixed(2);
    resolutionDiv.innerHTML = `${width}${height}<br><small style="font-size: 0.5rem;">${ratio}:1</small>`;
  }
}

// Actualizar al cargar y al redimensionar
updateResolutionDisplay();
window.addEventListener('resize', updateResolutionDisplay);

console.log(` Resolucin actual: ${window.innerWidth}${window.innerHeight}`);

</script>

<!-- MODAL DE DETALLES (para backups, confirmaciones, etc.) -->
<div id="modalDetalles" onclick="if(event.target === this) configuracion.cerrarModal()" class="modal-detalles-overlay">
  <div class="modal-detalles-container">
    <div id="modalDetallesContenido" class="modal-detalles-content">
      <!-- Contenido dinmico -->
    </div>
  </div>
</div>

<style>
  #modalDetalles {
    display: none;
  }
  
  #modalDetalles[style*="display: block"] {
    display: flex !important;
  }
  
  #modalDetalles > div {
    animation: modalSlideIn 0.3s ease-out;
  }
  
  @keyframes modalSlideIn {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
</style>

<!--  SCRIPT DIRECTO PARA CAMPANA - GARANTIZADO -->
<script>
console.log(' Creando funcin global toggleCampana...');

//  SISTEMA DE NOTIFICACIONES CAMPANA CON PERSISTENCIA
window.notifications = [];

//  CARGAR NOTIFICACIONES PERSISTENTES
window.loadNotifications = function() {
  try {
    const saved = localStorage.getItem('app_notifications');
    if (saved) {
      window.notifications = JSON.parse(saved);
      console.log(' Notificaciones cargadas:', window.notifications.length);
    }
  } catch (error) {
    console.error(' Error cargando notificaciones:', error);
    window.notifications = [];
  }
};

//  GUARDAR NOTIFICACIONES
window.saveNotifications = function() {
  try {
    localStorage.setItem('app_notifications', JSON.stringify(window.notifications));
    console.log(' Notificaciones guardadas');
  } catch (error) {
    console.error(' Error guardando notificaciones:', error);
  }
};

window.addNotificationToCampana = function(message, type = 'info') {
  console.log(' Agregando notificacin a campana:', message);
  
  const notification = {
    id: Date.now() + Math.random(),
    message: message,
    type: type,
    timestamp: new Date().toLocaleString('es-ES'),
    read: false
  };
  
  // Agregar al principio del array
  window.notifications.unshift(notification);
  
  // Limitar a 20 notificaciones mximo
  if (window.notifications.length > 20) {
    window.notifications = window.notifications.slice(0, 20);
  }
  
  // Guardar persistentemente
  window.saveNotifications();
  
  // Actualizar contador
  window.updateNotificationCounter();
  
  // Agregar al panel
  window.renderNotifications();
};

//  FUNCIN PARA INTERCEPTAR TOASTS Y REDIRIGIR A CAMPANA
window.interceptToast = function(message, type = 'info') {
  // Lista de mensajes que van SOLO a la campana
  const campanaOnly = [
    'Carpeta conectada',
    'Carpeta reconectada', 
    'Modo Carpeta DESACTIVADO',
    'Repuesto actualizado',
    'Jerarqua actualizada',
    'Modo edicin',
    'Posicin actualizada',
    'Filtro limpiado'
  ];
  
  const shouldGoToCampana = campanaOnly.some(keyword => message.includes(keyword));
  
  if (shouldGoToCampana) {
    // Solo a la campana
    console.log(' Interceptado para campana:', message);
    window.addNotificationToCampana(message, type);
    return true; // Interceptado
  }
  
  return false; // Dejar que el toast normal se ejecute
};

window.updateNotificationCounter = function() {
  const counter = document.getElementById('notificationCounter');
  const unreadCount = window.notifications.filter(n => !n.read).length;
  
  if (counter) {
    counter.textContent = unreadCount;
    counter.style.display = unreadCount > 0 ? 'flex' : 'none';
    
    // Agregar clase para mostrar indicador rojo
    const bell = document.getElementById('notificationBell');
    if (bell) {
      if (unreadCount > 0) {
        bell.classList.add('has-unread');
      } else {
        bell.classList.remove('has-unread');
      }
    }
  }
  
  console.log(' Contador actualizado:', unreadCount);
};

window.renderNotifications = function() {
  const panel = document.getElementById('notificationPanel');
  const listContainer = panel ? panel.querySelector('.notification-list') : null;
  
  if (!listContainer) {
    console.warn(' Lista de notificaciones no encontrada');
    return;
  }
  
  if (window.notifications.length === 0) {
    listContainer.innerHTML = `
      <div class="notification-empty">
        <div class="notification-empty-icon"></div>
        <div class="notification-empty-text">No hay notificaciones</div>
      </div>
    `;
    return;
  }
  
  const html = window.notifications.map(notification => {
    const iconMap = {
      success: '',
      error: '', 
      warning: '',
      info: ''
    };
    
    return `
      <div class="notification-item ${notification.read ? '' : 'unread'}" data-id="${notification.id}">
        <div class="notification-item-icon">${iconMap[notification.type] || ''}</div>
        <div class="notification-item-content">
          <div class="notification-item-message">${notification.message}</div>
          <div class="notification-item-time">
            <span></span>
            <span>${notification.timestamp}</span>
          </div>
        </div>
        <span class="notification-status-badge">${notification.read ? 'Ledo' : 'Nuevo'}</span>
        <button class="notification-item-delete" onclick="window.removeNotification('${notification.id}')" title="Eliminar notificacin">
          
        </button>
      </div>
    `;
  }).join('');
  
  listContainer.innerHTML = html;
};

window.clearAllNotifications = function() {
  window.notifications = [];
  window.saveNotifications(); // Persistir el limpiado
  window.updateNotificationCounter();
  window.renderNotifications();
};

window.removeNotification = function(id) {
  window.notifications = window.notifications.filter(n => n.id != id);
  window.saveNotifications(); // Persistir la eliminacin
  window.updateNotificationCounter();
  window.renderNotifications();
};

window.markAllNotificationsAsRead = function() {
  window.notifications.forEach(n => n.read = true);
  window.saveNotifications(); // Persistir el estado ledo
  window.updateNotificationCounter();
  window.renderNotifications();
};

window.toggleCampana = function() {
  console.log(' FUNCIN GLOBAL TOGGLECAMPANA EJECUTADA!');
  
  const panel = document.getElementById('notificationPanel');
  if (!panel) {
    console.error(' Panel no encontrado');
    return;
  }
  
  if (panel.classList.contains('active')) {
    panel.classList.remove('active');
    console.log(' Panel CERRADO por funcin global');
  } else {
    panel.classList.add('active');
    console.log(' Panel ABIERTO por funcin global');
    
    // Marcar todas como ledas al abrir el panel
    window.markAllNotificationsAsRead();
  }
};

// Verificar que la funcin se cre
console.log(' window.toggleCampana creada:', typeof window.toggleCampana);

//  INICIALIZAR SISTEMA DE NOTIFICACIONES PERSISTENTES
window.loadNotifications();
window.updateNotificationCounter();
window.renderNotifications();

// Tambin crear click fuera
document.addEventListener('click', function(e) {
  const panel = document.getElementById('notificationPanel');
  const bell = document.getElementById('notificationBell');
  
  if (panel && bell && !panel.contains(e.target) && !bell.contains(e.target)) {
    if (panel.classList.contains('active')) {
      panel.classList.remove('active');
      console.log(' Panel cerrado por click fuera');
    }
  }
});

console.log(' Sistema de campana sper simple listo');
console.log(' Notificaciones cargadas:', window.notifications.length);
</script>

</body>
</html>



