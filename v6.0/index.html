<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>APP Inventario v6.0</title>
  
  <!-- Base URL para GitHub Pages -->
  <base href="./">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1a1a2e">
  <meta name="description" content="Sistema de inventario con mapas interactivos, multimedia y sincronización en la nube">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Inventario">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#1a1a2e">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json">
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
  <link rel="apple-touch-icon" href="icons/icon-192x192.svg">

  <!-- 🔧 SISTEMA DE DEBUG UNIVERSAL - Funciona en móvil Y en configuración -->
  <script>
    // 🔧 SISTEMA DE DEBUG UNIVERSAL - Funciona en móvil Y en configuración
    (function() {
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const isDebug = location.search.includes('debug');
      
      // Almacén global de logs
      window.debugLogs = window.debugLogs || [];
      const maxLogs = 150;
      
      // Interceptar console desde el inicio
      const originalLog = console.log;
      const originalWarn = console.warn;
      const originalError = console.error;
      
      function addLogEntry(type, args) {
        const msg = Array.from(args).map(a => 
          typeof a === 'object' ? JSON.stringify(a, null, 2).substring(0, 300) : String(a)
        ).join(' ');
        
        const entry = { 
          type, 
          msg, 
          time: new Date().toLocaleTimeString(),
          timestamp: Date.now()
        };
        
        window.debugLogs.push(entry);
        if (window.debugLogs.length > maxLogs) window.debugLogs.shift();
        
        // Actualizar panel flotante si existe
        if (window.updateFloatingDebug) window.updateFloatingDebug(entry);
        // Actualizar panel de config si existe
        if (window.updateConfigDebug) window.updateConfigDebug(entry);
      }
      
      console.log = function() { originalLog.apply(console, arguments); addLogEntry('info', arguments); };
      console.warn = function() { originalWarn.apply(console, arguments); addLogEntry('warn', arguments); };
      console.error = function() { originalError.apply(console, arguments); addLogEntry('error', arguments); };
      
      // 🛡️ PROTECTOR DE TECLADO PARA INPUTS
      // Evita que otros manejadores globales interfieran con la escritura
      document.addEventListener('keydown', function(e) {
        const isInput = e.target.tagName === 'INPUT' || 
                        e.target.tagName === 'TEXTAREA' || 
                        e.target.isContentEditable;
        
        // Si estamos en un campo de texto, evitar que otros listeners interfieran
        if (isInput) {
          e.stopPropagation();
        }
      }, true); // true = fase de captura (se ejecuta primero)
      
      // 🖥️ FUNCIONES PARA PANEL DE CONFIGURACIÓN
      window.toggleDebugConsole = function() {
        const panel = document.getElementById('debugConsoleConfig');
        if (panel) {
          panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          if (panel.style.display === 'block') {
            window.renderConfigDebugLogs();
          }
        }
      };
      
      window.clearDebugLogs = function() {
        window.debugLogs = [];
        const configLogs = document.getElementById('debugLogsConfig');
        if (configLogs) configLogs.innerHTML = '<div style="color: #888;">Logs limpiados</div>';
      };
      
      window.testDebugLog = function() {
        console.log('🧪 Test LOG - ' + new Date().toLocaleString());
        console.warn('⚠️ Test WARNING - Esto es una advertencia de prueba');
        console.error('❌ Test ERROR - Esto es un error de prueba');
      };
      
      // 🆕 v6.049 - MOSTRAR INFO DE RED EN TIEMPO REAL
      window.showNetworkInfo = function() {
        const display = document.getElementById('networkInfoDisplay');
        if (!display) return;
        
        display.style.display = display.style.display === 'none' ? 'block' : 'none';
        if (display.style.display === 'none') return;
        
        const updateNetInfo = () => {
          const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
          const isOnline = navigator.onLine;
          
          let html = `<div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; color: rgba(255,255,255,0.85);">`;
          html += `<span style="color: #67e8f9;">Estado:</span><span>${isOnline ? '🟢 Online' : '🔴 Offline'}</span>`;
          
          if (conn) {
            html += `<span style="color: #67e8f9;">Tipo efectivo:</span><span>📶 ${(conn.effectiveType || 'desconocido').toUpperCase()}</span>`;
            if (conn.downlink) html += `<span style="color: #67e8f9;">Velocidad:</span><span>⬇️ ${conn.downlink} Mbps</span>`;
            if (conn.rtt) html += `<span style="color: #67e8f9;">Latencia:</span><span>⏱️ ${conn.rtt} ms</span>`;
            if (conn.saveData) html += `<span style="color: #67e8f9;">Ahorro datos:</span><span>⚠️ Activado</span>`;
            if (conn.type) html += `<span style="color: #67e8f9;">Tipo conexión:</span><span>🔌 ${conn.type}</span>`;
          } else {
            html += `<span style="color: #fca5a5;" colspan="2">⚠️ Network Information API no disponible</span>`;
          }
          
          html += `</div>`;
          html += `<div style="margin-top: 8px; font-size: 0.75rem; color: rgba(255,255,255,0.5);">`;
          html += `Actualizado: ${new Date().toLocaleTimeString()}`;
          html += `</div>`;
          
          display.innerHTML = html;
        };
        
        updateNetInfo();
        
        // Escuchar cambios de red
        if (navigator.connection) {
          navigator.connection.addEventListener('change', updateNetInfo);
        }
        window.addEventListener('online', updateNetInfo);
        window.addEventListener('offline', updateNetInfo);
      };
      
      // 📋 COPIAR LOGS AL PORTAPAPELES
      window.copyDebugLogs = function() {
        if (window.debugLogs.length === 0) {
          alert('No hay logs para copiar');
          return;
        }
        
        const header = `═══════════════════════════════════════════════════
🔧 DEBUG LOGS - APP INVENTARIO
📅 ${new Date().toLocaleString()}
📱 ${navigator.userAgent}
🖥️ Pantalla: ${window.innerWidth}x${window.innerHeight}
═══════════════════════════════════════════════════\n\n`;
        
        const logsText = window.debugLogs.map(entry => {
          const icon = entry.type === 'error' ? '❌' : entry.type === 'warn' ? '⚠️' : 'ℹ️';
          return `[${entry.time}] ${icon} ${entry.msg}`;
        }).join('\n');
        
        const fullText = header + logsText;
        
        // Intentar copiar al portapapeles
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(fullText).then(() => {
            alert('✅ Logs copiados al portapapeles!\n\nPuedes pegarlos en WhatsApp, Email, etc.');
          }).catch(err => {
            // Fallback para iOS
            window.fallbackCopyLogs(fullText);
          });
        } else {
          window.fallbackCopyLogs(fullText);
        }
      };
      
      // Fallback para copiar (iOS Safari)
      window.fallbackCopyLogs = function(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.cssText = 'position: fixed; top: 50%; left: 10%; width: 80%; height: 40%; z-index: 999999; font-size: 10px;';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        
        try {
          document.execCommand('copy');
          alert('✅ Logs copiados! (Selecciona todo y copia si no funcionó automáticamente)');
        } catch (err) {
          alert('📋 Selecciona todo el texto y cópialo manualmente');
        }
        
        setTimeout(() => textarea.remove(), 100);
      };
      
      // 📤 DESCARGAR LOGS COMO ARCHIVO TXT
      window.shareDebugLogs = function() {
        if (window.debugLogs.length === 0) {
          alert('No hay logs para descargar');
          return;
        }
        
        const fecha = new Date();
        const fechaStr = fecha.toISOString().split('T')[0]; // 2025-12-05
        const horaStr = fecha.toTimeString().split(' ')[0].replace(/:/g, '-'); // 15-30-45
        
        // Detectar plataforma
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const platform = isMobile ? 'MOBILE' : 'PC';
        const browser = navigator.userAgent.includes('Edg/') ? 'Edge' : 
                       navigator.userAgent.includes('Chrome') ? 'Chrome' :
                       navigator.userAgent.includes('Safari') ? 'Safari' : 'Otro';
        
        const header = `════════════════════════════════════════════════════════════════
🔧 DEBUG LOGS - APP INVENTARIO
════════════════════════════════════════════════════════════════
📅 Fecha: ${fecha.toLocaleString()}
🖥️ Plataforma: ${platform}
🌐 Navegador: ${browser}
📱 User Agent: ${navigator.userAgent}
📐 Pantalla: ${window.innerWidth}x${window.innerHeight}
🔗 URL: ${window.location.href}
☁️ Firebase Storage: ${window.firebaseImageStorage ? 'Activo' : 'No disponible'}
🔄 Sync activada: ${localStorage.getItem('firebaseSyncEnabled') === 'true' ? 'Sí' : 'No'}
📦 Repuestos en memoria: ${window.app?.repuestos?.length || 0}
════════════════════════════════════════════════════════════════

`;
        
        const logsText = window.debugLogs.map(entry => {
          const icon = entry.type === 'error' ? '[ERROR]' : entry.type === 'warn' ? '[WARN]' : '[INFO]';
          return `[${entry.time}] ${icon} ${entry.msg}`;
        }).join('\n');
        
        const fullText = header + logsText;
        const filename = `log_${platform}_${fechaStr}_${horaStr}.txt`;
        
        // Crear blob y descargar
        const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        
        alert(`✅ Archivo descargado:\n${filename}\n\n📂 Búscalo en tu carpeta de Descargas`);
      };
      
      window.renderConfigDebugLogs = function() {
        const logsDiv = document.getElementById('debugLogsConfig');
        if (!logsDiv) return;
        
        if (window.debugLogs.length === 0) {
          logsDiv.innerHTML = '<div style="color: #888;">No hay logs todavía...</div>';
          return;
        }
        
        logsDiv.innerHTML = window.debugLogs.map(entry => {
          const colors = { error: '#f66', warn: '#fa0', info: '#6af' };
          return `<div style="color: ${colors[entry.type] || '#0f0'}; padding: 3px 0; border-bottom: 1px solid #333;">${entry.time} ${entry.msg}</div>`;
        }).join('');
        logsDiv.scrollTop = logsDiv.scrollHeight;
      };
      
      window.updateConfigDebug = function(entry) {
        const logsDiv = document.getElementById('debugLogsConfig');
        const panel = document.getElementById('debugConsoleConfig');
        if (logsDiv && panel && panel.style.display === 'block') {
          const colors = { error: '#f66', warn: '#fa0', info: '#6af' };
          const div = document.createElement('div');
          div.style.cssText = `color: ${colors[entry.type] || '#0f0'}; padding: 3px 0; border-bottom: 1px solid #333;`;
          div.textContent = entry.time + ' ' + entry.msg;
          logsDiv.appendChild(div);
          logsDiv.scrollTop = logsDiv.scrollHeight;
        }
      };
      
      // Actualizar info del sistema cuando DOM esté listo
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
          const infoDiv = document.getElementById('debugSystemInfo');
          if (infoDiv) {
            const ua = navigator.userAgent;
            const isMobileDevice = /Android|iPhone|iPad|iPod/i.test(ua);
            const browser = ua.includes('Chrome') ? 'Chrome' : ua.includes('Safari') ? 'Safari' : ua.includes('Firefox') ? 'Firefox' : 'Otro';
            
            // 🆕 v6.049 - Info de conexión de red
            const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            const netType = conn?.effectiveType?.toUpperCase() || 'Desconocido';
            const netSpeed = conn?.downlink ? `${conn.downlink} Mbps` : '';
            const netRtt = conn?.rtt ? `${conn.rtt}ms` : '';
            const saveData = conn?.saveData ? '⚠️ Ahorro datos' : '';
            const isOnline = navigator.onLine ? '🟢 Online' : '🔴 Offline';
            
            infoDiv.innerHTML = `
              <strong>Dispositivo:</strong> ${isMobileDevice ? '📱 Móvil' : '🖥️ PC'}<br>
              <strong>Navegador:</strong> ${browser}<br>
              <strong>Pantalla:</strong> ${window.innerWidth}x${window.innerHeight}<br>
              <strong>📶 Red:</strong> ${isOnline} | ${netType} ${netSpeed} ${netRtt} ${saveData}<br>
              <strong>Firebase Storage:</strong> ${window.firebaseImageStorage ? '✅ Activo' : '❌ No disponible'}<br>
              <strong>Service Worker:</strong> ${navigator.serviceWorker ? '✅ Soportado' : '❌ No soportado'}<br>
              <strong>Logs capturados:</strong> ${window.debugLogs.length}
            `;
          }
        }, 3000);
      });
      
      // 🔍 BUSCAR REPUESTO EN TODAS LAS FUENTES (diagnóstico)
      window.buscarRepuestoEn = async function(termino) {
        console.log(`\n🔍 BUSCANDO "${termino}" EN TODAS LAS FUENTES...\n`);
        
        const terminoLower = termino.toLowerCase();
        let encontrados = { memoria: [], firebase: [], localStorage: [] };
        
        // 1. Buscar en memoria (window.app.repuestos)
        const enMemoria = (window.app?.repuestos || []).filter(r => 
          r.nombre?.toLowerCase().includes(terminoLower) ||
          r.codSAP?.toLowerCase().includes(terminoLower)
        );
        encontrados.memoria = enMemoria;
        console.log(`📦 EN MEMORIA: ${enMemoria.length} encontrados`);
        enMemoria.forEach(r => console.log(`   - ${r.nombre} (${r.codSAP}) - ID: ${r.id}`));
        
        // 2. Buscar en Firebase directamente
        try {
          if (window.firebaseService && window.firebaseService.isAuthenticated()) {
            const result = await window.firebaseService.readAll('repuestos');
            if (result.success) {
              const enFirebase = result.data.filter(r => 
                r.nombre?.toLowerCase().includes(terminoLower) ||
                r.codSAP?.toLowerCase().includes(terminoLower)
              );
              encontrados.firebase = enFirebase;
              console.log(`☁️ EN FIREBASE: ${enFirebase.length} encontrados (de ${result.data.length} total)`);
              enFirebase.forEach(r => console.log(`   - ${r.nombre} (${r.codSAP}) - ID: ${r.id}`));
            }
          } else {
            console.log('☁️ FIREBASE: No autenticado');
          }
        } catch (e) {
          console.error('❌ Error buscando en Firebase:', e);
        }
        
        // 3. Buscar en localStorage
        try {
          const local = JSON.parse(localStorage.getItem('inventarioData') || '[]');
          const enLocal = local.filter(r => 
            r.nombre?.toLowerCase().includes(terminoLower) ||
            r.codSAP?.toLowerCase().includes(terminoLower)
          );
          encontrados.localStorage = enLocal;
          console.log(`💾 EN LOCALSTORAGE: ${enLocal.length} encontrados (de ${local.length} total)`);
          enLocal.forEach(r => console.log(`   - ${r.nombre} (${r.codSAP}) - ID: ${r.id}`));
        } catch (e) {
          console.error('❌ Error buscando en localStorage:', e);
        }
        
        // Resumen
        console.log(`\n📊 RESUMEN:`);
        console.log(`   Memoria: ${encontrados.memoria.length}`);
        console.log(`   Firebase: ${encontrados.firebase.length}`);
        console.log(`   localStorage: ${encontrados.localStorage.length}`);
        console.log(`   Sync activa: ${window.syncActive ? '✅' : '❌'}`);
        
        // Alertar si hay discrepancia
        if (encontrados.firebase.length > 0 && encontrados.memoria.length === 0) {
          console.warn('⚠️ PROBLEMA: El repuesto EXISTE en Firebase pero NO en memoria');
          console.log('💡 Solución: Recarga la página o ejecuta window.app.loadData()');
        }
        
        return encontrados;
      };
      console.log('💡 Usa: window.buscarRepuestoEn("perno") para diagnosticar');
      
      // 🗑️ LIMPIAR REPUESTOS LOCALES (localStorage)
      window.limpiarRepuestosLocales = function() {
        const repuestosLocales = JSON.parse(localStorage.getItem('inventarioData') || '[]');
        const cantidadLocal = repuestosLocales.length;
        
        if (cantidadLocal === 0) {
          alert('✅ No hay repuestos en localStorage para limpiar');
          return;
        }
        
        const repuestosFirebase = window.app?.repuestos?.length || 0;
        const firebaseActivo = window.firebaseService?.isAuthenticated?.();
        
        const confirmar = confirm(
          `🗑️ LIMPIAR CACHE LOCAL\n\n` +
          `📦 Repuestos en localStorage: ${cantidadLocal}\n` +
          `☁️ Repuestos en Firebase: ${repuestosFirebase}\n` +
          `🔥 Firebase activo: ${firebaseActivo ? 'Sí' : 'No'}\n\n` +
          `${firebaseActivo ? '✅ Es seguro limpiar - Firebase tiene tus datos' : '⚠️ Firebase NO activo - asegúrate de no perder datos'}\n\n` +
          `¿Limpiar localStorage?`
        );
        
        if (confirmar) {
          localStorage.removeItem('inventarioData');
          const sizeBefore = (JSON.stringify(repuestosLocales).length / 1024).toFixed(1);
          console.log(`🗑️ Eliminados ${cantidadLocal} repuestos de localStorage (${sizeBefore}KB liberados)`);
          alert(`✅ localStorage limpiado\n\n• ${cantidadLocal} repuestos eliminados\n• ${sizeBefore}KB liberados\n\n${firebaseActivo ? '🔥 Tus datos siguen en Firebase' : '⚠️ Recarga para verificar'}`);
        }
      };
      
      // 📊 VER ESTADO DE DATOS
      window.verEstadoDatos = async function() {
        const repuestosLocal = JSON.parse(localStorage.getItem('inventarioData') || '[]');
        const repuestosMemoria = window.app?.repuestos || [];
        const jerarquiaLocal = JSON.parse(localStorage.getItem('jerarquiaAnidada') || '[]');
        const syncEnabled = localStorage.getItem('firebaseSyncEnabled') === 'true';
        const fsConnected = window.fsManager?.rootFolder ? true : false;
        
        // Contar imágenes FileSystem vs Firebase
        let imagenesFileSystem = 0;
        let imagenesFirebase = 0;
        let imagenesSinImagen = 0;
        
        repuestosMemoria.forEach(r => {
          if (r.multimedia && r.multimedia.length > 0) {
            r.multimedia.forEach(m => {
              if (m.isFirebaseStorage) imagenesFirebase++;
              else if (m.isFileSystem) imagenesFileSystem++;
            });
          } else {
            imagenesSinImagen++;
          }
        });
        
        // 🔥 Consultar Firebase directamente
        let repuestosFirebase = 0;
        let syncActiva = false;
        try {
          if (window.firebaseService && window.firebaseService.isAuthenticated()) {
            const result = await window.firebaseService.readAll('repuestos');
            repuestosFirebase = result.success ? result.data.length : 0;
            syncActiva = window.syncActive || false;
          }
        } catch (e) {
          console.error('Error consultando Firebase:', e);
        }
        
        const info = `
📊 ESTADO DE DATOS
═══════════════════════════════

📦 REPUESTOS:
   • localStorage: ${repuestosLocal.length}
   • En memoria (app): ${repuestosMemoria.length}
   • En Firebase: ${repuestosFirebase}
   • Sync listener activo: ${syncActiva ? '✅ Sí' : '❌ No'}

🖼️ IMÁGENES:
   • En FileSystem (local): ${imagenesFileSystem}
   • En Firebase Storage: ${imagenesFirebase}
   • Sin imagen: ${imagenesSinImagen}

🗂️ JERARQUÍA:
   • Áreas locales: ${jerarquiaLocal.length}
   • En app: ${window.app?.jerarquiaAnidada?.length || 0}

💾 ALMACENAMIENTO:
   • FileSystem conectado: ${fsConnected ? '✅ Sí' : '❌ No'}
   • Firebase Storage: ${window.firebaseImageStorage ? '✅ Activo' : '❌ No'}

🔄 SINCRONIZACIÓN:
   • Tiempo real habilitada: ${syncEnabled ? '✅ Sí' : '❌ No'}
   • Listener activo: ${syncActiva ? '✅ Sí' : '❌ No'}
`;
        
        console.log(info);
        alert(info);
        
        // Si hay diferencia entre localStorage y Firebase, ofrecer sincronizar
        if (repuestosLocal.length > repuestosMemoria.length) {
          const diferencia = repuestosLocal.length - repuestosMemoria.length;
          const syncMsg = `\n\n⚠️ HAY ${diferencia} REPUESTO(S) EN LOCALSTORAGE QUE NO ESTÁN EN FIREBASE\n\n¿Deseas sincronizar ahora?`;
          
          if (confirm(info + syncMsg)) {
            await window.sincronizarLocalAFirebase();
            return;
          }
        }
        
        alert(info);
      };
      
      // 🔄 SINCRONIZAR LOCALSTORAGE A FIREBASE
      window.sincronizarLocalAFirebase = async function() {
        const repuestosLocal = JSON.parse(localStorage.getItem('inventarioData') || '[]');
        
        if (repuestosLocal.length === 0) {
          alert('❌ No hay repuestos en localStorage');
          return;
        }
        
        if (!window.firebaseStorageAdapter) {
          alert('❌ Firebase no está disponible');
          return;
        }
        
        if (!window.firebaseService?.isAuthenticated?.()) {
          alert('❌ Debes iniciar sesión primero');
          return;
        }
        
        const confirmar = confirm(
          `🔄 SINCRONIZAR A FIREBASE\n\n` +
          `Se subirán ${repuestosLocal.length} repuestos desde localStorage a Firebase.\n\n` +
          `Esto sobrescribirá los datos en Firebase.\n\n` +
          `¿Continuar?`
        );
        
        if (!confirmar) return;
        
        try {
          alert('🔄 Sincronizando... espera un momento');
          
          // Subir todos los repuestos de localStorage a Firebase
          await window.firebaseStorageAdapter.guardarRepuestos(repuestosLocal);
          
          // Recargar desde Firebase para verificar
          const repuestosFirebase = await window.firebaseStorageAdapter.cargarRepuestos();
          
          alert(
            `✅ SINCRONIZACIÓN COMPLETADA\n\n` +
            `• Subidos: ${repuestosLocal.length} repuestos\n` +
            `• En Firebase: ${repuestosFirebase.length} repuestos\n\n` +
            `🔄 Recargando página...`
          );
          
          location.reload();
        } catch (error) {
          console.error('❌ Error sincronizando:', error);
          alert('❌ Error al sincronizar: ' + error.message);
        }
      };
      
      // 🖼️ MIGRAR IMÁGENES DE FILESYSTEM A FIREBASE STORAGE
      window.migrarImagenesAFirebase = async function() {
        // Obtener fsManager desde app (es donde está asignado correctamente)
        const fsManager = window.app?.fsManager;
        
        console.log('🔍 Verificando requisitos para migración...');
        console.log('  - firebaseImageStorage:', !!window.firebaseImageStorage);
        console.log('  - isReady:', window.firebaseImageStorage?.isReady?.());
        console.log('  - isAuthenticated:', window.firebaseImageStorage?.isAuthenticated?.());
        console.log('  - fsManager (from app):', !!fsManager);
        console.log('  - fsManager.rootFolder:', !!fsManager?.rootFolder);
        console.log('  - fsManager.isFileSystemMode:', fsManager?.isFileSystemMode);
        console.log('  - fsManager.imagesFolder:', !!fsManager?.imagesFolder);
        
        // Verificar Firebase Storage disponible
        if (!window.firebaseImageStorage) {
          alert('❌ Firebase Storage no está inicializado.\n\nRecarga la página.');
          return;
        }
        
        if (!window.firebaseImageStorage.isReady || !window.firebaseImageStorage.isReady()) {
          alert('❌ Firebase Storage no está listo.\n\nEspera un momento y vuelve a intentar.');
          return;
        }
        
        if (!window.firebaseImageStorage.isAuthenticated || !window.firebaseImageStorage.isAuthenticated()) {
          alert('❌ No estás autenticado en Firebase.\n\nInicia sesión primero.');
          return;
        }
        
        // 🔥 FIREBASE-ONLY: Ya no se requiere FileSystem conectado
        // Las imágenes ya deberían estar en Firebase Storage
        
        const repuestos = window.app?.repuestos || [];
        let imagenesAMigrar = [];
        
        // Buscar imágenes FileSystem (legacy - para migración)
        repuestos.forEach(r => {
          if (r.multimedia && r.multimedia.length > 0) {
            r.multimedia.forEach((m, idx) => {
              if (m.isFileSystem && !m.isFirebaseStorage) {
                imagenesAMigrar.push({
                  repuestoId: r.id,
                  repuestoNombre: r.descripcion || r.codSAP,
                  mediaIndex: idx,
                  media: m
                });
              }
            });
          }
        });
        
        if (imagenesAMigrar.length === 0) {
          alert('✅ No hay imágenes FileSystem para migrar.\n\nTodas las imágenes ya están en Firebase Storage o no hay imágenes.');
          return;
        }
        
        const confirmar = confirm(
          `🖼️ MIGRAR IMÁGENES A FIREBASE STORAGE\n\n` +
          `Se encontraron ${imagenesAMigrar.length} imágenes en FileSystem local.\n\n` +
          `⚠️ IMPORTANTE:\n` +
          `• Debes estar en tu PC donde están las imágenes\n` +
          `• La carpeta INVENTARIO_STORAGE debe estar conectada\n` +
          `• Este proceso puede tardar varios minutos\n\n` +
          `¿Deseas continuar?`
        );
        
        if (!confirmar) return;
        
        console.log(`🖼️ Iniciando migración de ${imagenesAMigrar.length} imágenes...`);
        
        let exitosas = 0;
        let fallidas = 0;
        const errores = [];
        
        for (let i = 0; i < imagenesAMigrar.length; i++) {
          const item = imagenesAMigrar[i];
          console.log(`🔄 [${i+1}/${imagenesAMigrar.length}] Migrando: ${item.repuestoNombre}`);
          
          try {
            // Extraer nombre de archivo limpio
            let imageName = item.media.name || item.media.url || '';
            // Limpiar la ruta (quitar ./imagenes/ si existe)
            imageName = imageName.replace(/^\.?\/?imagenes\/?/, '');
            
            if (!imageName) {
              throw new Error('Nombre de imagen no válido');
            }
            
            console.log(`   📁 Cargando: ${imageName}`);
            
            // Cargar imagen desde FileSystem usando readFile (método correcto)
            // La imagen está en la carpeta imagesFolder (plana)
            const fileHandle = await fsManager.imagesFolder.getFileHandle(imageName, { create: false });
            const imageFile = await fileHandle.getFile();
            
            if (!imageFile) {
              throw new Error('No se pudo cargar la imagen desde FileSystem');
            }
            
            // El archivo ya es un Blob/File
            const blob = imageFile;
            
            // Subir a Firebase Storage
            const filename = item.media.name || `migrated_${Date.now()}.webp`;
            const result = await window.firebaseImageStorage.uploadRepuestoImage(
              blob,
              item.repuestoId,
              filename,
              (progress) => {
                if (progress % 25 === 0) console.log(`   ↳ Progreso: ${progress.toFixed(0)}%`);
              }
            );
            
            if (result.success) {
              // Actualizar multimedia del repuesto
              const repuesto = window.app.repuestos.find(r => r.id === item.repuestoId);
              if (repuesto && repuesto.multimedia && repuesto.multimedia[item.mediaIndex]) {
                repuesto.multimedia[item.mediaIndex] = {
                  ...repuesto.multimedia[item.mediaIndex],
                  url: result.url,
                  path: result.path,
                  isFirebaseStorage: true,
                  isFileSystem: false,
                  migratedAt: new Date().toISOString()
                };
                
                // Guardar cambios en Firebase (usar guardarRepuestos con array)
                if (window.firebaseStorageAdapter && window.firebaseStorageAdapter.guardarRepuestos) {
                  await window.firebaseStorageAdapter.guardarRepuestos([repuesto]);
                  console.log(`   💾 Repuesto actualizado en Firebase: ${repuesto.nombre}`);
                }
              }
              
              exitosas++;
              console.log(`   ✅ Migrada: ${filename}`);
            } else {
              throw new Error(result.error || 'Error desconocido');
            }
            
          } catch (error) {
            fallidas++;
            errores.push(`${item.repuestoNombre}: ${error.message}`);
            console.error(`   ❌ Error: ${error.message}`);
          }
          
          // Pequeña pausa para no saturar
          await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        // Resultado final
        const resumen = `
🖼️ MIGRACIÓN COMPLETADA
═══════════════════════════════

✅ Exitosas: ${exitosas}
❌ Fallidas: ${fallidas}
📊 Total: ${imagenesAMigrar.length}

${errores.length > 0 ? '⚠️ Errores:\n' + errores.slice(0, 5).join('\n') + (errores.length > 5 ? `\n...y ${errores.length - 5} más` : '') : ''}

${exitosas > 0 ? '🔄 Recarga la página para ver los cambios' : ''}
`;
        
        console.log(resumen);
        alert(resumen);
        
        // Re-renderizar grid si hubo cambios
        if (exitosas > 0 && window.app) {
          window.app.renderInventario();
        }
      };
      
      console.log('🔧 Sistema de Debug Universal inicializado');
    })();
    
    // 🆕 v6.071 - Función global showToast (wrapper para app.showToast)
    window.showToast = function(message, type = 'info', duration = 3200) {
      if (typeof app !== 'undefined' && typeof app.showToast === 'function') {
        app.showToast(message, type, duration);
      } else {
        // Fallback: mostrar en consola si app no está disponible
        const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
        console.log(`${icons[type] || 'ℹ️'} [Toast] ${message}`);
      }
    };
  </script>

  <!-- CSS Modular para Jerarquía de Mapas -->
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/prototype-mapas.css">
  <link rel="stylesheet" href="styles/mapas-hierarchy.css">

  <style>
    /* CACHE-BUST: 2025-11-19-v50-CORRELATIVOS-GLOBALES-EN-MAPAS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /*  PALETA v6.0 - EQUILIBRADA (80% Grises, 20% Acentos) */
      --primary: #5b8bb4;           /* Azul corporativo desaturado */
      --primary-light: #7ba5c8;     /* Azul claro */
      --primary-dark: #4a7090;      /* Azul oscuro */
      --secondary: #6a7581;         /* Gris medio neutro */
      --success: #5b9b7a;           /* Verde esmeralda desaturado */
      --success-dark: #4a7d62;      /* Verde oscuro */
      --warning: #b8925a;           /* mbar desaturado */
      --warning-dark: #9a7848;      /* mbar oscuro */
      --danger: #b86b6b;            /* Rojo coral desaturado */
      --danger-dark: #985555;       /* Rojo oscuro */
      --info: #5b8bb4;              /* Azul info (igual a primary) */
      --info-dark: #4a7090;         /* Azul oscuro */

      /*  Fondos oscuros pero no extremos */
      --gray-50: #1a1d23;           /* Fondo app (ligeramente ms claro) */
      --gray-100: #1e2229;          /* Base principal */
      --gray-200: #252a33;          /* Tarjetas (+10% luminosidad) */
      --gray-300: #2d333d;          /* Hover states */
      --gray-400: #3a4049;          /* Elevado */
      --gray-500: #4a5059;          /* Separadores */
      --gray-600: #6a7078;          /* Texto terciario */
      --gray-700: #8a9098;          /* Texto secundario */
      --gray-800: #b8bec8;          /* Texto normal */
      --gray-900: #e6e9ef;          /* Texto primario */

      /*  Sombras equilibradas (ni planas ni dramticas) */
      --shadow-sm:
        0 2px 4px rgba(0, 0, 0, 0.25),
        0 1px 2px rgba(0, 0, 0, 0.15);
      --shadow-md:
        0 4px 8px rgba(0, 0, 0, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.2);
      --shadow-lg:
        0 8px 16px rgba(0, 0, 0, 0.35),
        0 4px 8px rgba(0, 0, 0, 0.25);
      --shadow-xl:
        0 12px 24px rgba(0, 0, 0, 0.4),
        0 6px 12px rgba(0, 0, 0, 0.3);

      /* Atajos para compatibilidad */
      --card-shadow: var(--shadow-sm);
      --card-shadow-hover: var(--shadow-md);
      --neomorph-shadow: var(--shadow-md);
      --neomorph-shadow-sm: var(--shadow-sm);
      --neomorph-shadow-hover: var(--shadow-lg);
      --neomorph-shadow-inset: inset 0 2px 4px rgba(0, 0, 0, 0.2);

      /*  Geometra consistente - Border Radius estandarizado */
      --radius-sm: 6px;            /* Badges pequeos */
      --radius-md: 8px;            /*  DEFAULT - Botones, inputs, cards */
      --radius-lg: 12px;           /* Modales grandes */
      --radius-xl: 16px;           /* Imgenes */

      /* Bordes y lneas sutiles */
      --border-color: #2d333d;
      --border-color-light: #3a4049;
      --border-accent: #4a5059;

      /*  Fondos con profundidad sutil */
      --bg-primary: #1e2229;        /* Base principal */
      --bg-secondary: #252a33;      /* Tarjetas */
      --bg-tertiary: #2d333d;       /* Hover states */
      --bg-elevated: #3a4049;       /* Elementos elevados */
      --bg-app: #1a1d23;            /* Fondo general app */

      /*  Texto con jerarqua clara (4 niveles) */
      --text-primary: #ffffff;      /* Ttulos (BLANCO PURO) */
      --text-secondary: #ffffff;    /* Texto normal (BLANCO PURO) */
      --text-muted: #e2e8f0;        /* Metadata (gris muy claro) */
      --text-disabled: #94a3b8;     /* Deshabilitados (gris medio) */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-app);
      color: var(--text-primary);
      margin: 0;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    #listView,
    #conteoGrid {
      will-change: scroll-position;
      /* -webkit-overflow-scrolling obsoleto en navegadores modernos */
    }

    /* CSS Containment para mejor rendimiento (Edge Chromium) */
    .repuesto-card {
      contain: layout style paint;
    }

    /* Aspect Ratio nativo (Edge 88+) */
    .card-image {
      aspect-ratio: 16 / 9;
      object-fit: cover;
    }

    /* Logical Properties para mejor RTL/LTR (Edge Chromium) */
    .card-content {
      padding-inline: 12px;
      padding-block: 10px;
      margin-block-end: 6px;
    }

    /* Color Scheme para dark mode nativo (Edge) */
    :root {
      color-scheme: dark light;
    }

    /* Cascade Layers para mejor especificidad (Edge 99+) */
    @layer base, components, utilities;

    @layer base {
      * {
        box-sizing: border-box;
      }
    }

    /* Subgrid para layouts complejos (Edge 117+) */
    @supports (grid-template-rows: subgrid) {
      .list-view {
        display: grid;
        grid-template-rows: auto subgrid;
      }
    }

    /* Has() Selector para interactividad sin JS (Edge 105+) */
    .repuesto-card:has(input:focus) {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    .palette-visual .node-name {
      font-size: 0.85em;
      font-weight: 600;
      flex: 0 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }
    }

    body.force-mobile .repuesto-card {
      max-width: 600px !important;
      margin: 0 auto !important;
    }

    body.force-mobile .card-image {
      height: 250px !important;
    }

    body.force-mobile .card-btn {
      min-height: 48px !important;
      font-size: 1rem !important;
      padding: 12px 16px !important;
    }

    body.force-mobile .btn {
      min-height: 48px !important;
      font-size: 1rem !important;
      padding: 12px 20px !important;
    }

    body.force-mobile .container {
      padding: 16px !important;
    }

    body.force-mobile #pagination {
      flex-direction: column !important;
      gap: 12px !important;
    }

    body.force-mobile #pagination > div:first-child {
      width: 100% !important;
    }

    body.force-mobile #pagination > div:first-child select,
    body.force-mobile #pagination > div:first-child button {
      width: 100% !important;
      margin: 4px 0 !important;
    }

    body.force-mobile #pagination > div:last-child {
      width: 100% !important;
      justify-content: center !important;
    }

    /* Modo Desktop Forzado - Aplica estilo desktop incluso en pantallas pequeas */
    body.force-desktop .cards-grid {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
      gap: 24px !important;
      padding: 24px !important;
    }

    body.force-desktop .repuesto-card {
      max-width: none !important;
    }

    body.force-desktop .card-image {
      height: 200px !important;
    }

    body.force-desktop .card-btn,
    body.force-desktop .btn {
      min-height: 40px !important;
      font-size: 0.95rem !important;
      padding: 10px 16px !important;
    }

    body.force-desktop .container {
      padding: 24px !important;
    }

    body.force-desktop #pagination {
      flex-direction: row !important;
      gap: 16px !important;
    }

    body.force-desktop #pagination > div:first-child,
    body.force-desktop #pagination > div:last-child {
      width: auto !important;
    }

    /* MODOS DE VISUALIZACIN - UTILIDADES */
    .hidden {
      display: none !important;
    }

    .scroll-hidden {
      overflow: hidden !important;
    }

    .hidden-file-input {
      display: none !important;
    }

    .mapa-legacy-title {
      margin-bottom: 20px;
      color: var(--primary);
    }

    /* RESPONSIVE BREAKPOINTS CLAVE */
    @media (max-width: 1024px) {
      .layout-grid {
        display: flex;
        flex-direction: column;
      }

      .layout-sidebar {
        width: 100%;
        margin-bottom: 20px;
      }

      .layout-content {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .jerarquia-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      .jerarquia-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .jerarquia-actions .btn {
        width: 100%;
      }
    }

    @media (max-width: 640px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .header-actions {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .header-actions .btn {
        width: 100%;
      }

      .search-container {
        flex-direction: column;
        gap: 10px;
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
      min-height: 36px;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-danger:hover {
      background: var(--danger-dark);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      box-shadow: var(--shadow-md);
    }

    .toggle-precio {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s;
      font-weight: 600;
      min-height: 48px;
    }

    .toggle-precio.active {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }

    /* NAVEGACIN PROFESIONAL - DESTACADA */
    .nav-tabs {
      background: var(--bg-secondary);
      display: flex;
      border-bottom: 3px solid var(--border-color);
      overflow-x: auto;
      /* -webkit-overflow-scrolling obsoleto en navegadores modernos */
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      /* No necesita position: sticky porque est dentro de sticky-header-container */
      padding: 0 8px;
      gap: 0;
      width: 100%;
    }

    .nav-tab {
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9rem;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      color: var(--text-muted);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      border-bottom: 4px solid transparent;
      border-right: 1px solid var(--border-color);
      touch-action: manipulation;
      position: relative;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      flex: 1 1 0;
      justify-content: center;
      min-width: 140px;
      text-align: center;
    }

    .nav-tab:last-child {
      border-right: none;
    }

    .nav-tab::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 4px;
      background: var(--primary);
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .nav-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      transform: translateY(-2px);
    }

    .nav-tab:hover::before {
      width: 100%;
    }

    .nav-tab.active {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.18) 0%, rgba(59, 130, 246, 0.05) 100%);
      color: var(--primary-light);
      border-bottom-color: var(--primary);
      box-shadow: inset 0 -4px 0 0 var(--primary);
    }

    .nav-tab.active::before {
      width: 100%;
    }

    /* CSS WarmupProgress removido - Firebase carga instantáneamente */

    .container {
      max-width: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }

    .tab-content {
      display: none;
      min-height: calc(100vh - 50px);
      overflow: auto;
      padding: 10px;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    /*  REGLA ESPECFICA PARA TAB MAPA */
    #mapa.tab-content {
      padding: 0; /* Sin padding solo para MAPA */
      overflow: hidden; /* Sin scroll solo para MAPA */
      position: fixed; /*  Posicin fija para ignorar contenedores */
      top: 45px; /*  Justo debajo de las pestaas */
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: calc(100vh - 45px);
      z-index: 1;
    }
    
    #mapa.tab-content.active {
      display: flex; /* Flex solo para MAPA cuando est activo */
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* TOOLBAR - Neumorfismo */
    /* ==========================================
       OPCIÓN 2: GRUPOS DEFINIDOS (RECOMENDADA)
       ========================================== */
    
    /* Toolbar - Contenedor principal */
    .toolbar {
      background: transparent;
      padding: 12px 0;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    /* Grupos visuales dentro del toolbar */
    .toolbar-group {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 0 12px;
      border-left: 2px solid var(--border-color);
    }
    
    .toolbar-group:first-child {
      border-left: none;
      padding-left: 0;
    }
    
    /* Grupo de búsqueda - alineado a la derecha */
    .toolbar-group-search {
      flex: 1;
      justify-content: flex-end;
      border-left: none;
    }
    
    /* Separador sutil entre grupos */
    .toolbar-separator {
      width: 1px;
      height: 24px;
      background: var(--border-color);
      opacity: 0.5;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
      font-size: 1.2rem;
    }

    .search-input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 1rem;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-tertiary);
      box-shadow: var(--shadow-sm);
      color: var(--text-primary);
    }

    .search-input:focus {
      outline: none;
      background: var(--bg-tertiary);
      border-color: var(--primary);
      box-shadow: var(--shadow-sm), 0 0 0 3px rgba(91, 139, 180, 0.2);
    }

    .view-btns {
      display: flex;
      gap: 8px;
    }

    /* Botones de vista - Minimalista */
    .view-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: transparent;
      border-radius: var(--radius-sm);
      border-left: 2px solid transparent;
      border-top: none;
      border-right: none;
      border-bottom: none;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.8rem;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .view-btn:hover {
      color: var(--text-primary);
      background: var(--bg-primary);
      border-left-color: var(--gray-600);
    }

    .view-btn.active {
      background: var(--bg-primary);
      border-left-color: var(--primary);
      color: var(--text-primary);
    }

    /*  BOTN DE CONEXIN - DESHABILITADO (Firebase-only mode) */
    #connectionBtn {
      display: none !important; /* Firebase-only: No se necesita FileSystem */
      position: relative;
      border: none !important;
      cursor: default !important;
      padding: 10px 14px !important;
      border-radius: var(--radius-md) !important;
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    #connectionBtn:hover {
      transform: translateY(-1px);
      box-shadow: 
        0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    #connectionBtn #connectionIcon {
      font-weight: 700;
      font-size: 1.1rem;
      display: inline-block;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* FILTROS */
    .filters-selects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .filter-select {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 48px;
      appearance: none;
      box-shadow: var(--shadow-sm);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238a909a' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    .filter-select:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-color-light);
    }

    .filter-select:focus {
      outline: none;
      background: var(--bg-tertiary);
      border-color: var(--primary);
      box-shadow: var(--shadow-sm), 0 0 0 3px rgba(91, 139, 180, 0.2);
    }

    .filter-chip {
      padding: 8px 16px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      transition: all 0.3s;
      touch-action: manipulation;
      min-height: 40px;
      display: inline-flex;
      align-items: center;
    }

    .filter-chip:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--bg-primary);
    }

    .filter-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* GRID DE TARJETAS */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 18px;
      margin-bottom: 20px;
      min-height: calc(100vh - 300px);
      align-content: start;
    }

    #inventario {
      min-height: calc(100vh - 50px);
    }

    #inventarioContent {
      min-height: calc(100vh - 250px);
    }

    .repuesto-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .repuesto-card:hover {
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      border-color: rgba(91, 139, 180, 0.3);
    }

    .card-image {
      height: 200px;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      border-bottom: 1px solid var(--border-color);
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card-image .no-image {
      font-size: 4rem;
      color: var(--gray-400);
    }

    .card-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.75rem;
      background: rgba(0, 0, 0, 0.7);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      letter-spacing: 0.5px;
    }

    .badge-ok {
      background: rgba(91, 155, 122, 0.95);
      color: #fff;
      border-color: rgba(91, 155, 122, 0.3);
    }

    .badge-bajo {
      background: rgba(184, 146, 90, 0.95);
      color: #fff;
      border-color: rgba(184, 146, 90, 0.3);
    }

    .badge-cero {
      background: rgba(184, 107, 107, 0.95);
      color: #fff;
      border-color: rgba(184, 107, 107, 0.3);
    }

    .card-content {
      padding: 10px 12px;
    }

    .card-content h3 {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-primary);
      background: transparent;
      padding: 0;
      border-left: 3px solid var(--primary);
      padding-left: 8px;
      margin-bottom: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.3;
    }

    .card-content h4 {
      font-size: 0.95rem;
      color: var(--text-primary);
      margin-bottom: 12px;
      font-weight: 500;
    }

    .card-info {
      display: grid;
      gap: 3px;
      margin-bottom: 6px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
      line-height: 1.3;
      margin-bottom: 2px;
      padding: 3px 4px;
      background: transparent;
      border-bottom: 1px solid rgba(91, 139, 180, 0.1);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.65rem;
    }

    .info-value {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .card-footer {
      display: flex;
      gap: 6px;
      padding: 0 12px 10px;
    }

    .card-btn {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      font-size: 0.7rem;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      min-height: 32px;
    }

    .card-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--border-color-light);
      transform: none;
    }

    .btn-edit {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-edit:hover {
      background: var(--primary);
      color: white;
    }

    .btn-delete {
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn-delete:hover {
      background: var(--danger);
      color: white;
    }

    /* Datos Tcnicos - Estilo Corporativo */
    .datos-tecnicos-box {
      background: rgba(91, 139, 180, 0.08);
      border-left: 3px solid var(--primary);
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      margin: 8px 0;
    }

    .datos-tecnicos-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .datos-tecnicos-content {
      font-size: 0.75rem;
      color: var(--text-secondary);
      line-height: 1.5;
      font-family: 'Courier New', monospace;
      white-space: pre-line;
      word-break: break-word;
    }

    /* Contador de Stock - Estilo Corporativo */
    .stock-counter-box {
      background: var(--bg-tertiary);
      padding: 6px 8px;
      border-radius: var(--radius-sm);
      margin-top: 6px;
      border-left: 3px solid currentColor;
    }

    /* Botones de Ubicacin/Mapa - Estilo Corporativo */
    .btn-add-location,
    .btn-view-map {
      flex: 1;
      padding: 6px 10px;
      font-size: 0.75rem;
      font-weight: 500;
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .btn-add-location {
      background: rgba(91, 155, 122, 0.85);
      border: 1px solid rgba(91, 155, 122, 0.3);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .btn-add-location:hover {
      background: rgba(91, 155, 122, 1);
      box-shadow: var(--shadow-sm);
    }

    .btn-view-map {
      background: rgba(91, 139, 180, 0.85);
      border: 1px solid rgba(91, 139, 180, 0.3);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .btn-view-map:hover {
      background: rgba(91, 139, 180, 1);
      box-shadow: var(--shadow-sm);
    }

    /* VISTA LISTA - Compactada con Estilo Corporativo */
    .list-view {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }

    .list-header {
      display: grid;
      grid-template-columns: 50px 0.9fr 1.5fr 160px 220px;
      gap: 6px;
      padding: 6px 10px;
      background: #4A5568;
      font-weight: 700;
      font-size: 0.75rem;
      color: var(--text-primary);
      border-bottom: 2px solid var(--primary);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .list-header-cell {
      display: flex;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      padding: 2px 4px;
      border-radius: 3px;
      transition: all 0.2s;
      position: relative;
    }
    
    .list-header-cell:hover {
      background: rgba(91, 124, 153, 0.3);
      color: #5B7C99;
    }
    
    .list-header-cell.active {
      background: rgba(91, 124, 153, 0.4);
      color: #5B7C99;
    }

    /* Resize handle para columnas */
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      -webkit-user-select: none;
      user-select: none;
      background: transparent;
      z-index: 20;
    }

    .resize-handle:hover {
      background: var(--primary);
      box-shadow: 0 0 4px var(--primary);
    }

    .resize-handle.resizing {
      background: var(--primary);
      box-shadow: 0 0 8px var(--primary);
    }

    .list-header.resizing {
      -webkit-user-select: none;
      user-select: none;
    }

    .list-header.resizing .list-header-cell {
      pointer-events: none;
    }

    .list-header.resizing .resize-handle {
      pointer-events: auto;
    }
    
    .sort-icon {
      font-size: 0.65rem;
      opacity: 0.6;
      transition: all 0.2s;
    }
    
    .list-header-cell.active .sort-icon {
      opacity: 1;
      transform: scale(1.1);
    }

    .list-row {
      display: grid;
      grid-template-columns: 50px 0.9fr 1.5fr 160px 220px;
      gap: 6px;
      padding: 6px 0px 6px 10px;
      border-bottom: 1px solid var(--border-color);
      align-items: center;
      transition: all 0.2s;
      font-size: 0.8rem;
      min-height: 36px;
    }
    
    .list-row > div:last-child,
    .list-row .list-actions {
      justify-self: end !important;
      padding-right: 10px !important;
    }
    
    .list-row > div {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      min-height: 100%;
    }
    
    .list-row .list-actions {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      align-self: stretch !important;
      justify-content: flex-end !important;
      gap: 4px !important;
      padding: 0 !important;
      width: 100% !important;
      margin: 0 !important;
    }
    
    .stock-visual {
      display: flex;
      flex-direction: column;
      gap: 1px;
      width: 100%;
      align-items: stretch !important;
    }
    
    .stock-numbers {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
    }
    
    .stock-bar-container {
      width: 100%;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      border-radius: 2px;
      overflow: hidden;
      position: relative;
    }
    
    .stock-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease, background 0.3s ease;
      box-shadow: 0 0 4px rgba(0,0,0,0.15);
    }

    .list-row:hover {
      background: var(--bg-primary);
    }

    .list-row:last-child {
      border-bottom: none;
    }

    .list-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
      width: 100%;
      align-items: center !important;
    }

    .list-actions button {
      padding: 5px 4px;
      font-size: 0.7rem;
      min-height: 28px;
      width: 100%;
      white-space: nowrap;
    }

    /* PAGINACIN */
    #pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin: 0 auto 16px auto;
      max-width: 100%;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      flex-wrap: wrap;
    }

    #pagination .btn {
      padding: 6px 12px;
      min-width: auto;
      min-height: 32px;
      font-size: 0.8rem;
    }

    #pageNumbers {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    #pageNumbers .btn {
      min-width: 42px;
      padding: 8px 12px;
      transition: all 0.3s ease;
    }

    #itemsPerPageSelect {
      transition: all 0.3s ease;
      font-weight: 500;
    }

    #itemsPerPageSelect:hover {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #itemsPerPageSelect:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }

    #pageNumbers .btn:not(:disabled):hover {
      opacity: 1 !important;
      transform: scale(1.05);
    }

    #pageNumbers .btn:disabled {
      opacity: 1 !important;
      transform: scale(1.1);
      cursor: default;
      font-weight: 700;
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.9);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      z-index: 2000;
  align-items: flex-start;
  justify-content: center;
  overflow-y: auto;
  padding: clamp(10px, 2vh, 28px) clamp(12px, 4vw, 48px);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 0;
      width: fit-content;
      min-width: min(1400px, 100%);
      max-width: 90vw;
      min-height: fit-content;
      max-height: 88vh;
      box-shadow: 0 26px 60px rgba(0, 0, 0, 0.55);
      position: relative;
      border: 1px solid var(--border-color);
      animation: slideUp 0.25s ease;
      display: flex;
      flex-direction: column;
      margin: clamp(10px, 2vh, 24px) auto clamp(20px, 4vh, 48px);
      overflow: hidden;
      transition: transform 0.3s ease, width 0.3s ease, height 0.3s ease;
    }

    /* Cuando el modal es resizable/draggable */
    .modal-content.is-resizable {
      position: fixed;
      margin: 0;
      width: auto;
      min-width: min(1200px, 100%);
      max-width: 95vw;
      height: 85vh;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* Estilos para handles de resize */
    .modal-resize-handle {
      position: absolute;
      z-index: 15;
      background: transparent;
      transition: background 0.2s ease, opacity 0.2s ease;
    }

    .modal-resize-handle:hover {
      background: rgba(91, 139, 180, 0.25);
      opacity: 1;
    }

    /* Indicadores visuales en handles de esquina */
    .modal-resize-handle.modal-resize-ne::after,
    .modal-resize-handle.modal-resize-nw::after,
    .modal-resize-handle.modal-resize-se::after,
    .modal-resize-handle.modal-resize-sw::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(91, 139, 180, 0.4);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-resize-handle.modal-resize-ne::after {
      top: 4px;
      right: 4px;
      border-left: none;
      border-bottom: none;
    }

    .modal-resize-handle.modal-resize-nw::after {
      top: 4px;
      left: 4px;
      border-right: none;
      border-bottom: none;
    }

    .modal-resize-handle.modal-resize-se::after {
      bottom: 4px;
      right: 4px;
      border-left: none;
      border-top: none;
    }

    .modal-resize-handle.modal-resize-sw::after {
      bottom: 4px;
      left: 4px;
      border-right: none;
      border-top: none;
    }

    .modal-resize-handle:hover::after {
      opacity: 1;
    }

    /* Líneas indicadoras en handles de bordes */
    .modal-resize-handle.modal-resize-n::before,
    .modal-resize-handle.modal-resize-s::before {
      content: '';
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 3px;
      background: rgba(91, 139, 180, 0.4);
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-resize-handle.modal-resize-n::before {
      top: 2px;
    }

    .modal-resize-handle.modal-resize-s::before {
      bottom: 2px;
    }

    .modal-resize-handle.modal-resize-e::before,
    .modal-resize-handle.modal-resize-w::before {
      content: '';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 30px;
      background: rgba(91, 139, 180, 0.4);
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-resize-handle.modal-resize-e::before {
      right: 2px;
    }

    .modal-resize-handle.modal-resize-w::before {
      left: 2px;
    }

    .modal-resize-handle:hover::before {
      opacity: 1;
    }

    .modal-drag-handle {
      position: absolute;
      z-index: 5;
      cursor: move;
      user-select: none;
      transition: background 0.2s ease;
    }

    .modal-drag-handle:hover {
      background: rgba(91, 139, 180, 0.08);
    }

    .modal-drag-handle:active {
      cursor: grabbing;
      background: rgba(91, 139, 180, 0.15);
    }

    /* Optimizacin de scroll suave */
    .modal-scroll::-webkit-scrollbar {
      width: 8px;
    }
    
    .modal-scroll::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 10px;
    }
    
    .modal-scroll::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }
    
    .modal-scroll::-webkit-scrollbar-thumb:hover {
      background: #4d92e6;
    }

    .wizard-timeline {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px; /* Reducido de 12px */
      margin-bottom: 19px; /* Reducido de 24px */
      padding: 16px 6px 13px; /* Reducido 20% */
      border-bottom: 2px solid var(--border-color);
      background: rgba(16, 23, 33, 0.4);
      border-radius: 10px; /* Reducido de 12px */
      flex-shrink: 0;
    }

    .wizard-step-indicator {
      display: flex;
      align-items: center;
      gap: 10px; /* Reducido de 12px */
      padding: 11px 13px; /* Reducido de 14px 16px */
      border-radius: 11px; /* Reducido de 14px */
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(16, 23, 33, 0.72);
      color: var(--text-secondary);
      cursor: pointer;
      transition: border 0.2s ease, background 0.2s ease, transform 0.2s ease;
    }

    .wizard-step-indicator:hover {
      border-color: rgba(82, 124, 166, 0.6);
      transform: translateY(-1px);
    }

    .wizard-step-indicator.is-active {
      border-color: var(--accent);
      background: rgba(82, 124, 166, 0.2);
      color: var(--text-primary);
    }

    .wizard-step-indicator.is-completed {
      border-color: rgba(91, 155, 122, 0.5);
      background: rgba(91, 155, 122, 0.18);
      color: var(--text-primary);
    }

    .wizard-step-number {
      display: none; /* Ocultar números */
    }

    .wizard-step-indicator.is-active .wizard-step-number {
      background: var(--accent);
    }

    .wizard-step-indicator.is-completed .wizard-step-number {
      background: var(--success);
    }

    .wizard-step-indicator.is-error {
      border-color: var(--danger);
      color: var(--danger);
      box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.15);
    }

    .wizard-step-indicator.is-error .wizard-step-number {
      background: var(--danger);
      color: #fff;
    }

    .wizard-step-indicator.is-disabled {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
    }

    .wizard-step-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .wizard-step-label {
      font-size: 0.74rem; /* Reducido de 0.92rem (20% menos) */
      font-weight: 600;
      color: inherit;
    }

    .wizard-step-helper {
      font-size: 0.60rem; /* Reducido de 0.75rem (20% menos) */
      color: var(--text-muted);
    }

    .wizard-step-container {
      width: 100%;
      flex: 0 1 auto;
      overflow-y: auto;
      padding: 0 4px;
      min-height: 0;
      max-height: calc(92vh - 360px);
    }

    .wizard-step {
      display: none;
      flex-direction: column;
      gap: 14px;
      width: 100%;
      padding: 8px 6px;
    }

    .wizard-step.wizard-step--active {
      display: flex;
    }

    .wizard-step.wizard-step--invalid {
      border-left: 3px solid var(--danger);
      padding-left: 19px;
      margin-left: -3px;
      transition: border-color 0.3s ease, background 0.3s ease;
      background: rgba(220, 38, 38, 0.04);
      animation: wizard-step-pulse 0.48s ease;
    }

    .wizard-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .wizard-actions .btn.is-hidden {
      display: none !important;
    }

    .wizard-actions .btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .wizard-actions__spacer {
      flex: 1 1 auto;
    }

    .wizard-actions .wizard-save-btn {
      display: none;
    }

    .wizard-actions .wizard-save-btn.is-visible {
      display: inline-flex;
    }

    @media (max-width: 1280px) {
      .wizard-timeline {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @keyframes wizard-step-pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.01);
      }
      100% {
        transform: scale(1);
      }
    }

    @media (max-width: 860px) {
      .wizard-timeline {
        grid-template-columns: 1fr;
      }

      .wizard-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .wizard-actions__spacer {
        display: none;
      }

      .wizard-actions .btn {
        width: 100%;
      }
    }

    /* Layout corporativo del modal principal */
    .sap-modal-header {
      padding: 10px 22px 8px 22px;
      background: rgba(21, 27, 36, 0.8);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sap-header-row {
      display: flex;
      align-items: center;
      gap: 12px;
      min-height: 32px;
    }

    .sap-header-leading {
      display: inline-flex;
      align-items: baseline;
      gap: 10px;
      min-width: 0;
    }

    .sap-header-eyebrow {
      font-size: 0.64rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-secondary);
      font-weight: 600;
      white-space: nowrap;
    }

    .sap-header-title {
      font-size: 1.04rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sap-header-subtitle {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin: 0;
      line-height: 1.3;
      opacity: 0.85;
    }

    .sap-header-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-left: auto;
    }

    .sap-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      flex: 0 0 auto;
      white-space: nowrap;
    }

    .sap-meta-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      font-weight: 700;
    }

    .sap-meta-value {
      font-size: 0.74rem;
      color: var(--text-primary);
      font-weight: 600;
    }

    .sap-meta-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--primary-light);
      background: rgba(91, 139, 180, 0.16);
      border: 1px solid rgba(91, 139, 180, 0.22);
      border-radius: 999px;
      padding: 3px 8px;
      line-height: 1;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    .sap-meta-chip--empty {
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .sap-header-meta .version-indicator {
      margin-left: 6px;
      font-size: 0.65rem;
      padding: 5px 10px;
    }

    .sap-modal-form {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .sap-form-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 0;
      flex: 1 1 auto;
      min-height: 0;
      overflow: hidden;
    }

    .modal-scroll {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 28px 32px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      column-gap: 28px;
      row-gap: 24px;
      background: rgba(16, 21, 29, 0.88);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0;
      box-shadow: none;
      max-height: calc(92vh - 280px);
    }

    .sap-empty {
      margin-left: 24px;
      padding: 6px 8px;
      font-size: 11px;
      color: var(--text-secondary);
      font-style: italic;
    }

    .sap-node-leaf .sap-node-content {
      padding-left: 24px;
    }

    .sap-node-spacer {
      display: inline-block;
      width: 16px;
    }

    /* Wizard dentro del grid */
    .modal-scroll .wizard-timeline {
      grid-column: 1 / -1;
      margin-bottom: 0;
    }

    .modal-scroll .wizard-step-container {
      grid-column: 1 / -1;
      display: contents;
    }

    .sap-form-actions {
      padding: 20px 32px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      background: rgba(12, 16, 24, 0.95);
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .sap-form-actions .btn-primary-cta {
      min-width: 260px;
      justify-content: center;
    }

    .sap-form-actions .btn-secondary {
      min-width: 180px;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: var(--radius-md);
    }

    .form-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 20px 24px;
      background: rgba(12, 16, 24, 0.82);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 14px;
      box-shadow: var(--shadow-xs, 0 6px 16px rgba(0, 0, 0, 0.28));
    }

    .form-section--half {
      grid-column: span 1;
      min-width: 760px;
    }

    .form-section--full {
      grid-column: 1 / -1;
      min-width: 900px; /* Ampliar de 760px a 900px para Step 3 */
    }

    /* Layouts internos de las secciones */
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(360px, 1fr));
      gap: 18px;
    }

    .form-row-triple {
      display: grid;
      grid-template-columns: repeat(3, minmax(240px, 1fr));
      gap: 18px;
    }

    .form-stock-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
    }

    .form-section-header {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .form-section-title {
      font-size: 0.86rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .form-section-description {
      font-size: 0.69rem;
      color: var(--text-secondary);
      margin: 0;
      max-width: 640px;
    }

    .form-section--half {
      width: 100%;
    }

    .form-section--full {
      width: 100%;
    }

    .version-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 11px;
      border-radius: 999px;
      font-size: 0.68rem;
      font-weight: 600;
      border: 1px solid transparent;
      background: rgba(91, 139, 180, 0.18);
      color: var(--primary-light);
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .version-indicator::before {
      content: '';
      font-size: 0.8rem;
    }

    .version-indicator-cascada {
      background: rgba(34, 197, 94, 0.16);
      border-color: rgba(34, 197, 94, 0.4);
      color: #4ade80;
    }

    .version-indicator-original {
      background: rgba(59, 130, 246, 0.16);
      border-color: rgba(59, 130, 246, 0.4);
      color: #60a5fa;
    }

    .ubicaciones-section {
      padding: 0;
      border: none;
      background: transparent;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ubicaciones-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .ubicaciones-title {
      margin: 0;
      color: var(--text-primary);
      font-size: 0.86rem;
      font-weight: 600;
    }

    .ubicaciones-subtitle {
      font-size: 0.68rem;
      color: var(--text-secondary);
      margin-top: 3px;
    }

    .ubicaciones-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-agregar-ubicacion {
      padding: 4px 10px;
      font-size: 0.74rem;
      background: rgba(91, 139, 180, 0.18);
      border: 1px solid rgba(91, 139, 180, 0.45);
      color: var(--primary-light);
      box-shadow: none;
    }

    .btn-agregar-ubicacion:hover {
      background: rgba(91, 139, 180, 0.28);
    }

    .ubicaciones-hint {
      background: rgba(91, 139, 180, 0.12);
      padding: 6px 10px;
      border-radius: 6px;
      border-left: 3px solid var(--primary);
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .sap-ubicaciones-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(900px, 1fr));
      gap: 18px;
    }

    .sap-ubicacion-card {
      border: 1px solid var(--border-color);
      border-radius: 0px;
      padding: 12px;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 11px;
      min-height: 100%;
      min-width: 900px;
      background: #1e2229;
    }

    .sap-ubicacion-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .sap-ubicacion-card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .sap-ubicacion-index {
      display: inline-flex;
      width: 26px;
      height: 26px;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(91, 139, 180, 0.22);
      color: var(--primary);
      font-size: 0.7rem;
      font-weight: 600;
    }

    .sap-btn-remove {
      background: transparent !important;
      color: var(--danger);
      border: 1px solid rgba(184, 107, 107, 0.6);
      box-shadow: none;
    }

    .sap-btn-remove:hover {
      background: rgba(184, 107, 107, 0.18) !important;
      color: #fca5a5;
      border-color: rgba(184, 107, 107, 0.75);
    }

    .sap-ubicacion-body {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .sap-field-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .sap-step-label {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 0.74rem;
      color: var(--text-primary);
      font-weight: 500;
      flex-direction: row;
    }

    .sap-step-number {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(91, 139, 180, 0.22);
      color: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.68rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    /* Controles compactos para ubicaciones en wizard */
    .wizard-step[data-step="3"] .form-control {
      padding: 5px 8px;
      font-size: 0.75rem;
      min-height: 32px;
    }

    .wizard-step[data-step="3"] .sap-ubicacion-card {
      max-width: 100%;
    }

    .wizard-step[data-step="3"] .ubicaciones-section {
      margin: 0;
    }

    .sap-step-hint {
      color: var(--text-muted);
      font-size: 0.62rem;
      display: block;
      margin-top: 4px;
    }

    /* ============================================ */
    /* SELECTOR VISUAL DE JERARQUÍA EN MODAL */
    /* ============================================ */
    .ubicaciones-section-visual {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 100%; /* Ampliar a todo el ancho disponible */
    }

    .ubicaciones-visual-header {
      text-align: center;
      padding: 16px;
      background: rgba(91, 139, 180, 0.08);
      border-radius: 6px;
      border-left: 3px solid var(--primary);
    }

    .ubicaciones-visual-title {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 0 0 8px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .ubicaciones-icon {
      font-size: 1.2rem;
    }

    /* Botón agregar área dentro del árbol */
    .tree-actions-internal {
      padding: 12px;
      background: rgba(76, 175, 80, 0.1);
      border: 1px dashed rgba(76, 175, 80, 0.3);
      border-radius: 6px;
      margin-bottom: 12px;
      text-align: center;
    }

    .tree-actions-internal .btn {
      width: 100%;
    }

    .ubicaciones-visual-description {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .ubicaciones-actions-top {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .ubicaciones-actions-top .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .ubicaciones-tree-selector {
      background: #1a1f26;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Estilos del árbol adaptados del Tab Jerarquía */
    .ubicaciones-tree-selector .jerarquia-tree-node {
      margin-bottom: 4px;
    }

    .ubicaciones-tree-selector .jerarquia-node-content {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ubicaciones-tree-selector .jerarquia-node-content:hover {
      background: rgba(91, 139, 180, 0.15);
      border-color: var(--primary);
    }

    .ubicaciones-tree-selector .jerarquia-node-content.is-selected {
      background: linear-gradient(135deg, rgba(91, 139, 180, 0.4), rgba(91, 139, 180, 0.25));
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(91, 139, 180, 0.3), inset 0 0 8px rgba(91, 139, 180, 0.2);
      font-weight: 600;
    }

    .ubicaciones-tree-selector .jerarquia-node-content.is-selected .jerarquia-node-name {
      color: var(--primary);
    }
    
    /* Nodo asignado (ubicación actual del repuesto) */
    .ubicaciones-tree-selector .jerarquia-node-content.is-assigned {
      background: linear-gradient(90deg, rgba(46, 204, 113, 0.2) 0%, rgba(46, 204, 113, 0.08) 100%);
      border-left: 4px solid #2ecc71;
      font-weight: 600;
    }
    
    .ubicaciones-tree-selector .jerarquia-node-content.is-assigned .jerarquia-node-name {
      color: #27ae60;
    }
    
    .ubicaciones-tree-selector .jerarquia-node-content.is-assigned .jerarquia-node-icon {
      filter: hue-rotate(90deg) saturate(1.5);
    }
    
    /* Nodo recién guardado (animación temporal 2s) */
    .jerarquia-node-content.node-just-saved {
      animation: pulseHighlight 2s ease-in-out;
      background: linear-gradient(90deg, rgba(255, 193, 7, 0.3) 0%, rgba(255, 193, 7, 0.1) 100%) !important;
      border-left: 4px solid #ffc107 !important;
      box-shadow: 0 0 12px rgba(255, 193, 7, 0.4) !important;
    }
    
    @keyframes pulseHighlight {
      0%, 100% { 
        box-shadow: 0 0 12px rgba(255, 193, 7, 0.4);
        transform: scale(1);
      }
      25% { 
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
        transform: scale(1.02);
      }
      50% {
        box-shadow: 0 0 16px rgba(255, 193, 7, 0.5);
        transform: scale(1.01);
      }
      75% {
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
        transform: scale(1.02);
      }
    }

    .ubicaciones-tree-selector .jerarquia-node-toggle {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
    }

    .ubicaciones-tree-selector .jerarquia-node-icon {
      font-size: 1rem;
    }

    .ubicaciones-tree-selector .jerarquia-node-name {
      flex: 1;
      font-size: 0.9rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .ubicaciones-tree-selector .jerarquia-node-count {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: rgba(91, 139, 180, 0.15);
      padding: 2px 8px;
      border-radius: 10px;
    }

    .ubicaciones-tree-selector .jerarquia-node-actions {
      display: none;
      gap: 4px;
      margin-left: 8px;
    }

    .ubicaciones-tree-selector .jerarquia-node-content:hover .jerarquia-node-actions {
      display: flex;
    }

    .ubicaciones-tree-selector .node-btn {
      padding: 2px 6px;
      font-size: 0.75rem;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s ease;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
    }

    .ubicaciones-tree-selector .node-btn-add {
      color: var(--success);
      border-color: var(--success);
      background: rgba(76, 175, 80, 0.1);
    }

    .ubicaciones-tree-selector .node-btn-add:hover {
      background: var(--success);
      color: white;
    }

    .ubicaciones-tree-selector .node-btn-edit {
      color: var(--warning);
      border-color: var(--warning);
      background: rgba(255, 193, 7, 0.1);
    }

    .ubicaciones-tree-selector .node-btn-edit:hover {
      background: var(--warning);
      color: white;
    }

    .ubicaciones-tree-selector .node-btn-delete {
      color: var(--danger);
      border-color: var(--danger);
      background: rgba(244, 67, 54, 0.1);
    }

    .ubicaciones-tree-selector .node-btn-delete:hover {
      background: var(--danger);
      color: white;
    }

    .ubicaciones-tree-selector .jerarquia-node-children {
      margin-left: 24px;
      margin-top: 4px;
      border-left: 1px solid rgba(91, 139, 180, 0.2);
      padding-left: 12px;
    }

    /* Panel de asignación de ubicación */
    .ubicaciones-assignment-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }

    .ubicacion-selected-info {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .selected-area-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(91, 139, 180, 0.15), rgba(91, 139, 180, 0.05));
      border: 1px solid rgba(91, 139, 180, 0.3);
      border-radius: 8px;
    }

    .selected-area-icon {
      font-size: 1.8rem;
      flex-shrink: 0;
    }

    .selected-area-details {
      flex: 1;
    }

    .selected-area-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .selected-area-path {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .path-level {
      background: rgba(91, 139, 180, 0.2);
      padding: 4px 10px;
      border-radius: 4px;
      font-weight: 500;
      white-space: nowrap;
    }

    .path-arrow {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .assignment-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .assignment-actions .btn-lg {
      min-width: 250px;
    }
    
    .assignment-actions .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border: 2px solid #27ae60;
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .assignment-actions .btn-success:hover {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }

    .ubicacion-no-selected {
      padding: 20px;
      text-align: center;
    }

    /* Repuestos en ubicación */
    .repuestos-en-ubicacion {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .repuestos-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .repuestos-icon {
      font-size: 1.2rem;
    }

    .repuestos-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .repuestos-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      background: rgba(255, 193, 7, 0.2);
      color: var(--warning);
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0 8px;
    }

    .repuestos-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .repuesto-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255, 193, 7, 0.08);
      border: 1px solid rgba(255, 193, 7, 0.2);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .repuesto-item:hover {
      background: rgba(255, 193, 7, 0.15);
      border-color: rgba(255, 193, 7, 0.4);
    }

    .repuesto-icon {
      font-size: 1.1rem;
      color: var(--warning);
    }

    .repuesto-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .repuesto-nombre {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .repuesto-codigo {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .btn-repuesto-edit {
      padding: 4px 8px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .btn-repuesto-edit:hover {
      background: var(--warning);
      border-color: var(--warning);
    }

    /* ============================================
       UBICACIONES ASIGNADAS - Panel Compacto
       ============================================ */
    .ubicaciones-asignadas-panel {
      margin-bottom: 20px;
      padding: 16px;
      background: rgba(33, 150, 243, 0.08);
      border: 1px solid rgba(33, 150, 243, 0.2);
      border-radius: 8px;
    }

    .ubicaciones-asignadas-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(33, 150, 243, 0.2);
    }

    .ubicaciones-icon {
      font-size: 1.2rem;
    }

    .ubicaciones-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .ubicaciones-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      background: rgba(33, 150, 243, 0.2);
      color: var(--primary);
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0 8px;
      margin-right: auto; /* Empujar el botón a la derecha */
    }

    .ubicaciones-asignadas-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .ubicacion-asignada-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(33, 150, 243, 0.2);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .ubicacion-asignada-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(33, 150, 243, 0.4);
    }

    .ubicacion-path-compact {
      flex: 1;
      font-size: 0.8rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .ubicacion-cantidad-control {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      border-radius: 4px;
    }

    .ubicacion-cantidad-control input[type="number"] {
      width: 50px !important;
      min-width: 50px;
    }

    .ubicacion-path-compact .path-separator {
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .ubicacion-path-compact .path-level {
      background: rgba(33, 150, 243, 0.15);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    .btn-ubicacion-delete {
      padding: 4px 10px;
      background: rgba(231, 76, 60, 0.1);
      border: 1px solid rgba(231, 76, 60, 0.3);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      color: var(--danger);
    }

    .btn-ubicacion-delete:hover {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    /* Chips legacy - mantener para compatibilidad */
    .ubicaciones-selected-chips {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 16px;
    }

    .selected-chips-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .selected-chips-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .selected-chips-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0 8px;
    }

    .selected-chips-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 40px;
    }

    .selected-chips-list:empty::after {
      content: "Ninguna ubicación seleccionada aún";
      color: var(--text-muted);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* Chips mejorados con rama jerárquica completa */
    .ubicacion-chip-enhanced {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .chip-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .chip-badge {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .chip-path-full {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .chip-level {
      background: rgba(91, 139, 180, 0.15);
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 500;
      white-space: nowrap;
    }

    .chip-separator {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }

    .chip-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }

    .chip-enumeration {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .chip-btn:hover:not(:disabled) {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .chip-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .chip-count {
      min-width: 30px;
      text-align: center;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--primary);
    }

    .chip-remove-btn {
      padding: 6px 12px;
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid rgba(244, 67, 54, 0.3);
      border-radius: 4px;
      color: var(--danger);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .chip-remove-btn:hover {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    /* Chips legacy - mantener para compatibilidad */
    .ubicacion-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(91, 139, 180, 0.2);
      border: 1px solid rgba(91, 139, 180, 0.4);
      border-radius: 16px;
      padding: 6px 12px;
      font-size: 0.8rem;
      color: var(--text-primary);
    }

    .ubicacion-chip-path {
      font-weight: 500;
    }

    .ubicacion-chip-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: rgba(184, 107, 107, 0.3);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #fca5a5;
      font-size: 0.85rem;
    }

    .ubicacion-chip-remove:hover {
      background: rgba(184, 107, 107, 0.6);
      color: white;
    }

    .ubicaciones-actions-bottom {
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    /* Botones de guardar en cada step */
    .step-actions-bottom {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .step-actions-bottom .btn-lg {
      min-width: 200px;
      font-size: 1rem;
      padding: 12px 24px;
    }

    @media (max-width: 1320px) {
      .sap-form-grid {
        padding: 0;
      }

      .modal-scroll {
        grid-template-columns: 1fr;
        padding: 20px 22px;
        gap: 18px;
      }

      .form-section,
      .form-section--half,
      .form-section--full {
        grid-column: 1 / -1;
        padding: 16px 18px;
      }

      .form-section {
        gap: 14px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .form-row-triple {
        grid-template-columns: 1fr;
      }

      .form-stock-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 900px) {
      .sap-header-meta {
        flex-direction: column;
        align-items: flex-start;
      }

      .sap-meta-item {
        width: auto;
      }

      .sap-header-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .sap-header-title {
        white-space: normal;
      }

      .modal-scroll {
        padding: 16px;
        gap: 14px;
      }

      .form-section {
        padding: 14px 16px;
        gap: 12px;
      }

      .sap-header-meta .version-indicator {
        margin-left: 0;
      }

      .sap-form-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .sap-form-actions .btn {
        width: 100%;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(184, 107, 107, 0.9);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .modal-close:hover {
      background: var(--danger);
      box-shadow: var(--shadow-sm);
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 20px;
      padding-right: 50px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 12px;
    }

    .form-group {
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 3px;
      font-size: 0.75rem;
    }

    .form-control {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.78rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      font-family: inherit;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
      background: var(--bg-secondary);
    }

    .form-control::placeholder {
      color: var(--text-secondary);
      opacity: 0.55;
    }

    /* ELIMINADO: Ahora se define arriba con mejor especificidad */
    
    /* Layout optimizado para 4 columnas en campos pequeños */
    .form-row-quad {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
    }
    
    /* Contenedor del formulario compactado */
    .modal-form {
      display: grid;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }
    
    /* Seccin de multimedia con altura flexible */
    .multimedia-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .multimedia-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 8px;
      max-height: 240px;
      overflow-y: auto;
      padding: 8px;
      background: var(--bg-primary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    
    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .preview-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .preview-delete:hover {
      background: #d63031;
    }
    
    .preview-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 0.62rem;
      padding: 3px;
      text-align: center;
    }
    
    .multimedia-preview::-webkit-scrollbar {
      width: 6px;
    }
    
    .multimedia-preview::-webkit-scrollbar-thumb {
      background: var(--gray-400);
      border-radius: 3px;
    }

    .autocomplete-container {
      position: relative;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 2px solid var(--primary);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
    }

    .autocomplete-list.active {
      display: block;
    }

    .autocomplete-item {
      padding: 12px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--gray-200);
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background: var(--bg-secondary);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    /* LIGHTBOX */
    .lightbox {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .lightbox.active {
      display: flex;
    }

    .lightbox-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    .lightbox-content img,
    .lightbox-content video {
      max-width: 100%;
      max-height: 90vh;
      border-radius: 8px;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 30px;
      cursor: pointer;
      z-index: 3001;
      transition: all 0.3s;
    }

    .lightbox-close:hover {
      background: #b91c1c;
      transform: rotate(90deg);
    }

    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 20px;
      font-size: 30px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.3s;
      z-index: 3001;
    }

    .lightbox-nav:hover {
      background: rgba(255,255,255,0.4);
    }

    .lightbox-prev {
      left: 20px;
    }

    .lightbox-next {
      right: 20px;
    }

    /* JERARQUA CASCADA - Estilo rbol visual */
    .hierarchy-tree {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hierarchy-level {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-primary);
      border-radius: 10px;
      border-left: 4px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      animation: slideInRight 0.3s ease-out forwards;
      opacity: 0;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(20px);
      }
    }

    /* ========================================
       ESTILO CORPORATIVO BASE - MINIMALISTA
       ======================================== */
    .corp-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: transparent;
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--border-color);
      border-top: none;
      border-right: none;
      border-bottom: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .corp-btn:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
      transform: translateX(3px);
    }

    .corp-btn:active {
      transform: translateX(1px);
    }

    /* Variantes de color para corp-btn - solo borde */
    .corp-btn-primary {
      border-left-color: var(--primary);
    }

    .corp-btn-primary:hover {
      color: var(--primary-light);
    }

    .corp-btn-success {
      border-left-color: var(--success);
    }

    .corp-btn-warning {
      border-left-color: var(--warning);
    }

    .corp-btn-danger {
      border-left-color: var(--danger);
    }

    .corp-btn-secondary {
      border-left-color: var(--gray-600);
      opacity: 0.7;
    }

    .corp-btn-secondary:hover {
      opacity: 1;
    }

    /* Toggle minimalista */
    .toggle-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: transparent;
      border-left: 3px solid var(--gray-600);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0.7;
    }

    .toggle-wrapper:hover {
      opacity: 1;
      transform: translateX(3px);
    }

    .toggle-wrapper.active {
      border-left-color: var(--primary);
      opacity: 1;
    }

    .toggle-track {
      width: 36px;
      height: 18px;
      background: var(--gray-600);
      border-radius: 9px;
      position: relative;
      transition: background 0.3s ease;
    }

    .toggle-wrapper.active .toggle-track {
      background: var(--primary);
    }

    .toggle-thumb {
      width: 14px;
      height: 14px;
      background: var(--text-primary);
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .toggle-wrapper.active .toggle-thumb {
      transform: translateX(18px);
    }

    .toggle-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* ============================================
       ESTILOS GLASSMORPHISM PARA TOOLBAR
       ============================================ */
    
    .glass-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .glass-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15),
                  inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .glass-btn-primary {
      background: rgba(91, 139, 180, 0.3);
      border-color: rgba(91, 139, 180, 0.5);
      color: var(--primary-light);
    }

    .glass-btn-primary:hover {
      background: rgba(91, 139, 180, 0.4);
    }

    /* Toggle de vista glassmorphism */
    .view-toggle {
      display: inline-flex;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 4px;
      gap: 4px;
    }

    .view-toggle-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.3s ease;
    }

    .view-toggle-btn.active {
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
    }

    .view-toggle-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.06);
    }

    /* Estado de conexión glassmorphism */
    .glass-btn.connection {
      position: relative;
      padding: 10px 14px;
    }

    .glass-btn.connection.connected {
      background: rgba(91, 155, 122, 0.25);
      border-color: rgba(91, 155, 122, 0.5);
      color: #7db99a;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(91, 155, 122, 0.2);
    }

    .glass-btn.connection.disconnected {
      background: rgba(184, 107, 107, 0.25);
      border-color: rgba(184, 107, 107, 0.5);
      color: #c88585;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(184, 107, 107, 0.2);
    }

    .glass-btn.connection:hover {
      transform: scale(1.05) translateY(-2px);
    }

    /* Búsqueda glassmorphism */
    .glass-search {
      flex: 1;
      max-width: 250px;
      position: relative;
    }

    .glass-search input {
      width: 100%;
      padding: 10px 18px 10px 40px;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      color: var(--text-primary);
      font-size: 0.85rem;
      transition: all 0.3s ease;
    }

    .glass-search input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .glass-search .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.5;
    }

    /* Botones de acción (limpiar, deshacer, rehacer) */
    .glass-action-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 1.1rem;
      transition: all 0.3s ease;
      margin-left: 8px;
    }

    .glass-action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      transform: scale(1.05);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .glass-action-btn:active {
      transform: scale(0.95);
    }

    /* Controles de zoom glassmorphism */
    .glass-zoom-controls {
      display: inline-flex;
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 4px;
      gap: 4px;
      align-items: center;
    }

    .glass-zoom-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .glass-zoom-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .glass-zoom-display {
      padding: 0 12px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      min-width: 50px;
      text-align: center;
    }

    .hierarchy-level:nth-child(1) {
      border-left-color: var(--warning);
      animation-delay: 0.1s;
    }

    .hierarchy-level:nth-child(2) {
      border-left-color: var(--primary);
      margin-left: 24px;
      animation-delay: 0.2s;
    }

    .hierarchy-level:nth-child(3) {
      border-left-color: var(--info);
      margin-left: 48px;
      animation-delay: 0.3s;
    }

    .hierarchy-level:nth-child(4) {
      border-left-color: var(--success);
      margin-left: 72px;
      animation-delay: 0.4s;
    }

    .hierarchy-level:hover {
      background: var(--bg-tertiary);
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    .hierarchy-icon {
      font-size: 1.8rem;
      flex-shrink: 0;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .hierarchy-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hierarchy-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .hierarchy-value {
      font-size: 1.05rem;
      color: var(--text-primary);
      font-weight: 600;
    }

    .hierarchy-connector {
      position: absolute;
      left: -12px;
      top: -8px;
      bottom: -8px;
      width: 2px;
      background: linear-gradient(180deg, transparent 0%, var(--border-color) 20%, var(--border-color) 80%, transparent 100%);
    }

    .hierarchy-level:nth-child(1) .hierarchy-connector {
      display: none;
    }

    /* Botn icono de jerarqua en tarjetas */
    .btn-hierarchy {
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }

    .btn-hierarchy:hover {
      background: var(--primary-dark);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn-hierarchy:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    /* Modal Estadsticas - Responsive */
    @media (max-width: 768px) {
      #modalEstadisticas > div {
        width: 95% !important;
        height: 95vh !important;
        margin: 2.5vh auto !important;
      }
      
      #modalEstadisticas h2 {
        font-size: 1.3rem !important;
      }
      
      #estadisticasContent > div:nth-child(2) {
        grid-template-columns: 1fr !important;
      }
      
      #estadisticasContent > div:nth-child(3) > div {
        grid-template-columns: 1fr !important;
      }
    }

    #modalEstadisticas::-webkit-scrollbar,
    #estadisticasContent::-webkit-scrollbar {
      width: 8px;
    }

    #modalEstadisticas::-webkit-scrollbar-track,
    #estadisticasContent::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    #modalEstadisticas::-webkit-scrollbar-thumb,
    #estadisticasContent::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    #modalEstadisticas::-webkit-scrollbar-thumb:hover,
    #estadisticasContent::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }

    /* Modal Cascada - Estilos */
    #modalCascada::-webkit-scrollbar,
    #cascadaContent::-webkit-scrollbar {
      width: 8px;
    }

    #modalCascada::-webkit-scrollbar-track,
    #cascadaContent::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    #modalCascada::-webkit-scrollbar-thumb,
    #cascadaContent::-webkit-scrollbar-thumb {
      background: #6366f1;
      border-radius: 4px;
    }

    #modalCascada::-webkit-scrollbar-thumb:hover,
    #cascadaContent::-webkit-scrollbar-thumb:hover {
      background: #8b5cf6;
    }

    @media (max-width: 768px) {
      #modalCascada > div {
        width: 95% !important;
        height: 95vh !important;
        margin: 2.5vh auto !important;
      }
      
      #modalCascada h3 {
        font-size: 1rem !important;
      }
    }

    .lightbox-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: 700;
      z-index: 3001;
    }

    /* TOAST NOTIFICATIONS - VERSIN CORPORATIVA MEJORADA */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #334155;
      padding: 18px 24px;
      border-radius: 16px;
      box-shadow: 
        0 20px 60px rgba(0,0,0,0.15),
        0 8px 32px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
      animation: slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 4000;
      font-weight: 600;
      max-width: 420px;
      min-width: 280px;
      word-wrap: break-word;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      backdrop-filter: blur(20px) saturate(180%);
      cursor: pointer;
      overflow: hidden;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    /* Indicador de tipo con lnea lateral */
    .toast::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--toast-accent, #64748b);
      border-radius: 0 2px 2px 0;
    }

    /* Icono del tipo de notificacin */
    .toast::after {
      content: var(--toast-icon, '');
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      opacity: 0.7;
    }

    /* Efectos hover - mantener fijo */
    .toast:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 
        0 25px 80px rgba(0,0,0,0.2),
        0 12px 40px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.9);
      background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
      border-color: rgba(148, 163, 184, 0.4);
    }

    /* Estados por tipo - COLORES CORPORATIVOS SUTILES */
    .toast.toast-success {
      --toast-accent: #059669;
      --toast-icon: '';
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: #065f46;
      border-color: rgba(5, 150, 105, 0.2);
    }

    .toast.toast-success:hover {
      background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
    }

    .toast.toast-error {
      --toast-accent: #dc2626;
      --toast-icon: '';
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      color: #7f1d1d;
      border-color: rgba(220, 38, 38, 0.2);
    }

    .toast.toast-error:hover {
      background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
    }

    .toast.toast-warning {
      --toast-accent: #d97706;
      --toast-icon: '';
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      color: #92400e;
      border-color: rgba(217, 119, 6, 0.2);
    }

    .toast.toast-warning:hover {
      background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%);
    }

    .toast.toast-info {
      --toast-accent: #2563eb;
      --toast-icon: '';
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: #1e40af;
      border-color: rgba(37, 99, 235, 0.2);
    }

    .toast.toast-info:hover {
      background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
    }

    /* TOAST HUB - Ventana emergente consolidada */
    .toast-hub {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 20px;
      box-shadow: 
        0 25px 80px rgba(0,0,0,0.25),
        0 15px 50px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      width: 90vw;
      max-width: 500px;
      max-height: 80vh;
      z-index: 5000;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      backdrop-filter: blur(20px) saturate(180%);
      overflow: hidden;
    }

    .toast-hub.active {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .toast-hub-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toast-hub-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1e293b;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast-hub-counter {
      background: #64748b;
      color: white;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .toast-hub-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #64748b;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .toast-hub-close:hover {
      background: rgba(148, 163, 184, 0.1);
      color: #334155;
    }

    .toast-hub-content {
      padding: 12px;
      max-height: calc(80vh - 80px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast-hub-item {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 16px;
      position: relative;
      transition: all 0.2s;
      cursor: pointer;
    }

    .toast-hub-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border-color: rgba(148, 163, 184, 0.3);
    }

    .toast-hub-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--toast-accent, #64748b);
      border-radius: 0 2px 2px 0;
    }

    .toast-hub-item-content {
      padding-left: 16px;
      padding-right: 32px;
    }

    .toast-hub-item-icon {
      position: absolute;
      right: 12px;
      top: 12px;
      font-size: 1.1rem;
      opacity: 0.7;
    }

    .toast-hub-item-time {
      position: absolute;
      right: 12px;
      bottom: 12px;
      font-size: 0.75rem;
      color: #64748b;
      opacity: 0.8;
    }

    .toast-hub-item-delete {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(220, 38, 38, 0.1);
      color: #dc2626;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 0.8rem;
      opacity: 0;
      transition: all 0.2s;
    }

    .toast-hub-item:hover .toast-hub-item-delete {
      opacity: 1;
    }

    .toast-hub-item-delete:hover {
      background: rgba(220, 38, 38, 0.2);
    }

    /* Overlay para el toast hub */
    .toast-hub-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 4999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .toast-hub-overlay.active {
      opacity: 1;
    }

    /* Botn flotante para abrir el hub - DESACTIVADO (ahora usamos campana) */
    .toast-hub-trigger {
      display: none !important; /* Ocultar completamente el botn flotante */
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: 
        0 10px 30px rgba(59, 130, 246, 0.3),
        0 4px 15px rgba(59, 130, 246, 0.2);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 4001;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .toast-hub-trigger.active {
      display: flex;
    }

    .toast-hub-trigger:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 
        0 15px 40px rgba(59, 130, 246, 0.4),
        0 8px 20px rgba(59, 130, 246, 0.3);
    }

    /*  CAMPANA DE NOTIFICACIONES - MINIMALISTA */
    .notification-bell {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 56px;
      height: 56px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      color: var(--text-secondary);
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
      z-index: 4002;
    }

    .notification-bell:hover {
      transform: scale(1.05);
      color: var(--text-primary);
      box-shadow: var(--shadow-lg);
    }

    /* 🔄 BOTÓN DE REFRESH PWA - MÓVIL */
    .pwa-refresh-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      cursor: pointer;
      display: none; /* Oculto por defecto, solo visible en móvil */
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      color: #6b7280; /* Gris por defecto */
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      z-index: 4002;
    }

    /* Estados del botón refresh */
    .pwa-refresh-btn.state-default {
      color: #6b7280; /* Gris - sin actualización pendiente */
      border-color: #4b5563;
    }

    .pwa-refresh-btn.state-updated {
      color: #10b981; /* Verde - actualizado */
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    .pwa-refresh-btn.state-updating {
      color: #3b82f6; /* Azul - actualizando */
      border-color: #3b82f6;
      animation: pwa-spin 1s linear infinite;
    }

    .pwa-refresh-btn:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-lg);
    }

    .pwa-refresh-btn:active {
      transform: scale(0.95);
    }

    @keyframes pwa-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* 🆕 v6.073 - Botón PWA refresh flotante OCULTO - solo usamos el del header */
    @media (max-width: 768px) {
      .pwa-refresh-btn {
        display: none !important; /* Oculto - solo un botón de refresh en header */
      }
      
      /* Ajustar posición de la campana en móvil para no chocar */
      .notification-bell {
        width: 48px;
        height: 48px;
        font-size: 1.3rem;
      }
    }

    /* 🆕 BANNER DE ACTUALIZACIÓN PWA - VISIBLE EN TODA LA PANTALLA */
    .pwa-update-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 12px 20px;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 15px;
      z-index: 10000;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      animation: slideDown 0.5s ease-out;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .pwa-update-banner.visible {
      display: flex;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      }
      50% {
        box-shadow: 0 4px 30px rgba(59, 130, 246, 0.7), 0 0 40px rgba(59, 130, 246, 0.3);
      }
    }

    .pwa-update-banner.visible {
      animation: slideDown 0.5s ease-out, pulse-glow 2s ease-in-out infinite;
    }

    .pwa-update-banner-icon {
      font-size: 1.5rem;
      animation: pwa-spin 2s linear infinite;
    }

    .pwa-update-banner-text {
      flex: 1;
      text-align: center;
    }

    .pwa-update-banner-title {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 2px;
    }

    .pwa-update-banner-subtitle {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .pwa-update-banner-btn {
      background: white;
      color: #1d4ed8;
      border: none;
      padding: 8px 20px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .pwa-update-banner-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
    }

    .pwa-update-banner-btn:active {
      transform: scale(0.98);
    }

    .pwa-update-banner-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin-left: 5px;
    }

    .pwa-update-banner-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    /* Responsive para móvil */
    @media (max-width: 600px) {
      .pwa-update-banner {
        padding: 10px 15px;
        gap: 10px;
        flex-wrap: wrap;
      }

      .pwa-update-banner-text {
        order: 1;
        width: 100%;
        flex: none;
      }

      .pwa-update-banner-icon {
        order: 0;
        font-size: 1.2rem;
      }

      .pwa-update-banner-btn {
        order: 2;
        flex: 1;
        justify-content: center;
        padding: 10px 15px;
      }

      .pwa-update-banner-close {
        order: 3;
      }
    }

    /* 🔧 CONSOLA DE DEBUG PWA (v6.115) */
    .pwa-console {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50vh;
      max-height: 600px;
      background: #1e1e1e;
      color: #d4d4d4;
      z-index: 999998;
      display: none;
      flex-direction: column;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
    }

    .pwa-console.active {
      display: flex;
      transform: translateY(0);
    }

    .pwa-console-header {
      background: #2d2d2d;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #3e3e3e;
    }

    .pwa-console-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .pwa-console-badge {
      background: #0078d4;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .pwa-console-actions {
      display: flex;
      gap: 8px;
    }

    .pwa-console-btn {
      background: transparent;
      border: 1px solid #3e3e3e;
      color: #d4d4d4;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .pwa-console-btn:hover {
      background: #3e3e3e;
      border-color: #0078d4;
    }

    .pwa-console-filters {
      background: #252525;
      padding: 8px 16px;
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #3e3e3e;
      overflow-x: auto;
    }

    .pwa-console-filter {
      background: transparent;
      border: 1px solid #3e3e3e;
      color: #858585;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      white-space: nowrap;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pwa-console-filter.active {
      background: #0078d4;
      color: white;
      border-color: #0078d4;
    }

    .pwa-console-filter:hover:not(.active) {
      background: #3e3e3e;
      color: #d4d4d4;
    }

    .filter-count {
      background: rgba(255,255,255,0.2);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .pwa-console-output {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .pwa-console-output::-webkit-scrollbar {
      width: 8px;
    }

    .pwa-console-output::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    .pwa-console-output::-webkit-scrollbar-thumb {
      background: #3e3e3e;
      border-radius: 4px;
    }

    .pwa-console-output::-webkit-scrollbar-thumb:hover {
      background: #4e4e4e;
    }

    .pwa-console-welcome {
      color: #858585;
      text-align: center;
      padding: 40px 20px;
      font-size: 0.9rem;
      line-height: 1.8;
    }

    .pwa-console-log {
      padding: 6px 0;
      border-bottom: 1px solid #2d2d2d;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .pwa-console-log-time {
      color: #858585;
      font-size: 0.75rem;
      min-width: 70px;
      flex-shrink: 0;
    }

    .pwa-console-log-type {
      font-size: 1rem;
      flex-shrink: 0;
    }

    .pwa-console-log-message {
      flex: 1;
      word-break: break-word;
    }

    .pwa-console-log.log .pwa-console-log-message { color: #d4d4d4; }
    .pwa-console-log.warn .pwa-console-log-message { color: #daa520; }
    .pwa-console-log.error .pwa-console-log-message { color: #f44336; }
    .pwa-console-log.success .pwa-console-log-message { color: #4caf50; }
    .pwa-console-log.highlight {
      background: rgba(255, 193, 7, 0.2);
      border-left: 3px solid #ffc107;
    }

    .pwa-console-search-wrapper {
      background: #2d2d2d;
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      border-top: 1px solid #3e3e3e;
    }

    .pwa-console-search {
      flex: 1;
      background: #1e1e1e;
      border: 1px solid #3e3e3e;
      color: #d4d4d4;
      padding: 10px 12px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.85rem;
      outline: none;
    }

    .pwa-console-search:focus {
      border-color: #0078d4;
      box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
    }

    .pwa-console-search-btn,
    .pwa-console-stats-btn {
      background: #0078d4;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .pwa-console-stats-btn {
      background: #10b981;
    }

    .pwa-console-search-btn:hover {
      background: #006cbd;
      transform: scale(1.05);
    }

    .pwa-console-stats-btn:hover {
      background: #059669;
      transform: scale(1.05);
    }

    .pwa-console-search-btn:active,
    .pwa-console-stats-btn:active {
      transform: scale(0.95);
    }

    .pwa-console-stats {
      background: #252525;
      padding: 16px;
      margin: 8px 0;
      border-radius: 4px;
      border: 1px solid #3e3e3e;
    }

    .pwa-console-stats h3 {
      margin: 0 0 12px 0;
      color: #0078d4;
      font-size: 1rem;
    }

    .pwa-console-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }

    .pwa-console-stat-item {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 4px;
      border-left: 3px solid #0078d4;
    }

    .pwa-console-stat-label {
      font-size: 0.75rem;
      color: #858585;
      margin-bottom: 4px;
    }

    .pwa-console-stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: #d4d4d4;
    }

    .pwa-console-patterns {
      margin-top: 12px;
    }

    .pwa-console-pattern-item {
      background: #1e1e1e;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }

    .pwa-console-pattern-text {
      color: #d4d4d4;
      flex: 1;
    }

    .pwa-console-pattern-count {
      background: #0078d4;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* Botón flotante para abrir consola */
    .pwa-console-toggle {
      position: fixed;
      bottom: 140px; /* ⬆️ Movido más arriba para no chocar con campana */
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 999997;
      transition: all 0.3s;
      display: none; /* 🔒 Oculto por defecto, solo admin lo verá */
      align-items: center;
      justify-content: center;
    }
    
    /* 🔒 Solo admins ven la consola */
    .pwa-console-toggle.admin-only {
      display: flex;
    }

    .pwa-console-toggle:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .pwa-console-toggle:active {
      transform: scale(0.95) rotate(90deg);
    }

    .pwa-console-toggle.has-errors {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      animation: pulse-error 2s infinite;
    }

    @keyframes pulse-error {
      0%, 100% { box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
      50% { box-shadow: 0 4px 20px rgba(244, 67, 54, 0.6); }
    }

    @media (max-width: 768px) {
      .pwa-console {
        height: 70vh;
        max-height: none;
      }

      .pwa-console-toggle {
        bottom: 130px; /* ⬆️ Más arriba en móvil también */
        right: 16px;
        width: 50px;
        height: 50px;
        font-size: 1.3rem;
      }
    }

    /* Contador de notificaciones - minimalista */
    .notification-counter {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--primary);
      color: white;
      border-radius: 10px;
      min-width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      border: 2px solid var(--bg-app);
      box-shadow: var(--shadow-sm);
    }

    /* Panel de notificaciones - limpio y minimalista */
    .notification-panel {
      position: fixed;
      top: 90px;
      right: 20px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      width: 360px;
      max-height: 500px;
      z-index: 4001;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.25s ease;
      display: none;
      overflow: hidden;
    }

    .notification-panel.active {
      opacity: 1;
      transform: translateY(0);
      display: flex;
      flex-direction: column;
    }

    /* Encabezado del panel - minimalista limpio */
    .notification-panel-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
      flex-shrink: 0;
    }

    .notification-panel-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .notification-panel-title span:first-child {
      font-size: 1.1rem;
    }

    .notification-panel-actions {
      display: flex;
      gap: 6px;
    }

    .notification-panel-action {
      background: transparent;
      border: none;
      padding: 4px 10px;
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .notification-panel-action:hover {
      color: var(--text-primary);
    }

    .notification-panel-action:active {
      transform: scale(0.95);
    }

    /* Lista de notificaciones - minimalista */
    .notification-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .notification-list::-webkit-scrollbar {
      width: 4px;
    }

    .notification-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .notification-list::-webkit-scrollbar-thumb {
      background: var(--gray-500);
      border-radius: 2px;
    }

    .notification-list::-webkit-scrollbar-thumb:hover {
      background: var(--gray-600);
    }

    /* Notificación individual - limpio y minimalista */
    .notification-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      margin: 0 10px 6px 10px;
      background: transparent;
      border-left: 3px solid transparent;
      transition: all 0.2s ease;
      position: relative;
      cursor: pointer;
    }

    /* NOTIFICACIÓN NO LEÍDA - simple y limpia */
    .notification-item.unread {
      border-left-color: var(--primary);
    }

    .notification-item.unread:hover {
      background: var(--bg-primary);
      transform: translateX(2px);
    }

    /* NOTIFICACIÓN LEÍDA - muy discreta */
    .notification-item:not(.unread) {
      border-left-color: transparent;
      opacity: 0.5;
    }

    .notification-item:not(.unread):hover {
      opacity: 0.7;
    }

    /* Icono de notificación - más pequeño */
    .notification-item-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
      opacity: 0.7;
    }

    /* Contenido de notificación */
    .notification-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .notification-item-message {
      font-size: 0.85rem;
      color: var(--text-primary);
      font-weight: 400;
      line-height: 1.3;
    }

    .notification-item:not(.unread) .notification-item-message {
      color: var(--text-secondary);
    }

    /* Timestamp minimalista */
    .notification-item-time {
      font-size: 0.65rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 3px;
    }

    /* Badge de estado - pequeño y discreto */
    .notification-status-badge {
      position: absolute;
      top: 10px;
      right: 36px;
      font-size: 0.55rem;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--primary);
      color: white;
      opacity: 0.8;
    }

    .notification-item:not(.unread) .notification-status-badge {
      display: none;
    }

    /* Botón eliminar - minimalista */
    .notification-item-delete {
      opacity: 0;
      background: transparent;
      border: none;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .notification-item:hover .notification-item-delete {
      opacity: 1;
    }

    .notification-item-delete:hover {
      color: var(--danger);
      transform: scale(1.1);
    }

    .notification-item-delete:active {
      transform: scale(0.95);
    }

    /* Estado vacío */
    .notification-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
    }

    .notification-empty-icon {
      font-size: 3rem;
      margin-bottom: 10px;
      opacity: 0.4;
    }

    .toast-hub-trigger-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #dc2626;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
    }

    /* Animaciones mejoradas */
    @keyframes slideInLeft {
      from {
        transform: translateX(-100%) scale(0.8);
        opacity: 0;
      }
      to {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(-50%) scale(0.95);
      }
    }

    .toast.fade-out {
      animation: fadeOut 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* Progreso de tiempo restante */
    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 2px;
      background: var(--toast-accent, #3b82f6);
      border-radius: 0 0 16px 16px;
      transition: width linear;
      opacity: 0.6;
    }

    /* Contador de toasts cuando hay muchos */
    .toast-counter {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--toast-accent, #3b82f6);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      border: 2px solid #1e293b;
      opacity: 0.9;
    }

    /* Responsive - mvil */
    @media (max-width: 768px) {
      .toast {
        left: 12px;
        right: 12px;
        max-width: none;
        min-width: auto;
        border-radius: 12px;
        padding: 16px 20px;
        font-size: 0.9rem;
      }
    }

    /* Animacin de pulso para indicador de hover */
    @keyframes pulse {
      0%, 100% {
        opacity: 0.6;
        transform: scale(1);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    /* Efecto de resplandor sutil en hover prolongado */
    .toast:hover::before {
      box-shadow: 0 0 20px var(--toast-accent);
    }

    /* STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stats-card {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--card-shadow);
      text-align: center;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-left: 4px solid var(--primary);
      position: relative;
      overflow: hidden;
    }

    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        transparent 0%, 
        rgba(59, 130, 246, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.4s;
    }

    .stats-card:hover::before {
      opacity: 1;
    }

    .stats-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: var(--card-shadow-hover), 0 0 25px rgba(59, 130, 246, 0.3);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
      text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
      position: relative;
      z-index: 1;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      z-index: 1;
    }

    /* JERARQUA */
    .tree-container {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }

    .tree-header {
      padding: 16px;
      background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .tree-node {
      margin: 8px 0;
      transition: all 0.3s;
    }

    .tree-item {
      padding: 10px 12px;
      background: #3b4558;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.15s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 400;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      margin-bottom: 4px;
    }

    .tree-item:hover {
      background: #445062;
      transform: none;
    }

    .tree-toggle {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-muted);
      border-radius: 4px;
      font-weight: 700;
      transition: transform 0.3s;
    }

    .tree-toggle.expanded {
      transform: rotate(90deg);
      background: var(--primary);
      color: white;
    }

    .tree-children {
      margin-left: 24px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .tree-children.expanded {
      max-height: 5000px;
    }

    .tree-area .tree-item {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(96, 165, 250, 0.15) 100%);
      color: #60a5fa;
      font-size: 1.05rem;
      border-left: 4px solid var(--primary);
    }

    .tree-equipo .tree-item {
      background: var(--bg-primary);
      color: var(--text-secondary);
      border-left: 3px solid var(--border-color);
    }

    .tree-repuesto .tree-item {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      font-weight: 500;
    }

    /*  RBOL JERRQUICO ESTILO SAP PM - CORPORATIVO */
    
    /* Container principal estilo SAP */
    .sap-tree-container {
      background: linear-gradient(165deg, rgba(32, 36, 44, 0.95) 0%, rgba(25, 28, 35, 0.85) 100%);
      border: 1px solid rgba(128, 142, 162, 0.18);
      border-radius: 6px;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      box-shadow: 0 18px 36px rgba(4, 8, 14, 0.45);
    }

    .sap-tree-node {
      border-bottom: 1px solid rgba(99, 112, 134, 0.16);
      transition: background-color 0.2s ease;
    }

    .sap-tree-node:nth-child(odd) > .sap-tree-item {
      background: linear-gradient(90deg, rgba(41, 47, 57, 0.94) 0%, rgba(35, 41, 51, 0.9) 100%);
    }

    .sap-tree-node:nth-child(even) > .sap-tree-item {
      background: linear-gradient(90deg, rgba(38, 43, 52, 0.92) 0%, rgba(31, 36, 44, 0.9) 100%);
    }

    .sap-tree-item {
      display: flex;
      align-items: center;
      padding: 6px 12px 6px calc(var(--indent, 12px));
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      transition: background-color 0.18s ease, border-color 0.18s ease;
      position: relative;
      background: linear-gradient(90deg, rgba(45, 51, 61, 0.92) 0%, rgba(39, 45, 54, 0.88) 65%, rgba(33, 38, 47, 0.82) 100%);
      border-left: 2px solid transparent;
    }

    .sap-tree-item:hover {
      background: linear-gradient(90deg, rgba(58, 68, 82, 0.95) 0%, rgba(50, 59, 72, 0.9) 100%);
      border-left-color: rgba(99, 177, 217, 0.35);
    }

    .sap-tree-item.selected {
      background: linear-gradient(90deg, rgba(73, 114, 153, 0.28) 0%, rgba(67, 102, 140, 0.24) 100%);
      border-left: 3px solid var(--primary);
      font-weight: 600;
      box-shadow: inset 0 0 0 1px rgba(108, 156, 196, 0.25);
    }

    .sap-tree-item::before {
      content: '';
      position: absolute;
      left: calc(var(--indent, 12px) - 10px);
      top: 0;
      bottom: 50%;
      width: 1px;
      background: rgba(121, 134, 154, 0.28);
    }

    .sap-tree-item::after {
      content: '';
      position: absolute;
      left: calc(var(--indent, 12px) - 10px);
      top: 50%;
      width: 8px;
      height: 1px;
      background: rgba(121, 134, 154, 0.28);
    }

    .sap-tree-node[data-level="0"] .sap-tree-item::before,
    .sap-tree-node[data-level="0"] .sap-tree-item::after {
      display: none;
    }

    .sap-tree-node:last-child > .sap-tree-item::before {
      bottom: 16px;
    }

    .sap-tree-toggle {
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 4px;
      font-size: 11px;
      color: var(--gray-700);
      flex-shrink: 0;
      transition: transform 0.2s ease, color 0.2s ease;
      background: rgba(72, 82, 96, 0.28);
      border-radius: 3px;
    }

    .sap-tree-toggle.expanded {
      transform: rotate(90deg);
      color: var(--primary);
      background: rgba(91, 139, 180, 0.16);
    }

    .sap-tree-toggle.empty {
      opacity: 0;
      pointer-events: none;
    }

    .sap-tree-icon {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 6px;
      font-size: 14px;
      flex-shrink: 0;
      color: rgba(205, 213, 226, 0.78);
    }

    .sap-tree-code {
      font-family: 'Courier New', Courier, monospace;
      font-size: 11px;
      color: rgba(187, 198, 213, 0.9);
      margin-right: 12px;
      min-width: 126px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .sap-tree-label {
      font-size: 12px;
      color: var(--gray-900);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sap-tree-badge {
      background: rgba(86, 109, 130, 0.32);
      border: 1px solid rgba(108, 132, 156, 0.42);
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 11px;
      color: var(--gray-50);
      margin-left: 12px;
      box-shadow: inset 0 1px 0 rgba(136, 162, 188, 0.25);
    }


    /* Hijos colapsados */
    .sap-tree-children {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .sap-tree-children.expanded {
      max-height: 10000px;
    }

    /* Estados de iconos */
    .sap-icon-folder-closed::before { content: ''; }
    .sap-icon-folder-open::before { content: ''; }
    .sap-icon-document::before { content: ''; }
    .sap-icon-equipment::before { content: ''; }
    .sap-icon-component::before { content: ''; }
    
    /*  Clases auxiliares para estilos inline */
    .sap-tree-wrapper {
      margin-top: 20px;
    }
    
    .sap-tree-header-flex {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sap-tree-header-count {
      font-size: 11px;
      color: var(--gray-700); /* Texto secundario */
      font-weight: normal;
    }
    
    .sap-toolbar-separator {
      width: 1px;
      height: 20px;
      background: var(--gray-500); /* Separador corporativo */
      margin: 0 4px;
    }
    
    .sap-tree-scrollable {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .sap-tree-hidden {
      display: none;
    }

    /* Scrollbar corporativo */
    .sap-tree-container::-webkit-scrollbar {
      width: 12px;
    }

    .sap-tree-container::-webkit-scrollbar-track {
      background: var(--gray-200);
    }

    .sap-tree-container::-webkit-scrollbar-thumb {
      background: var(--gray-500);
      border: 2px solid var(--gray-200);
      border-radius: 6px;
    }

    .sap-tree-container::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    /* Header estilo corporativo */
    .sap-tree-header {
      background: linear-gradient(135deg, var(--gray-300) 0%, var(--gray-200) 100%);
      border-bottom: 2px solid var(--primary);
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 700;
      color: var(--gray-900); /* Texto primario */
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Barra de herramientas corporativa */
    .sap-toolbar {
      background: var(--gray-300);
      border-bottom: 1px solid var(--gray-500);
      padding: 6px 8px;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    /* Barra de bsqueda del rbol SAP */
    .sap-search-bar {
      background: var(--bg-secondary);
      padding: 12px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .sap-search-input {
      flex: 1;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .sap-search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
    }

    .sap-search-clear {
      padding: 8px 12px;
      background: var(--secondary);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .sap-search-clear:hover {
      background: var(--danger);
      transform: scale(1.05);
    }

    /* Resaltado de bsqueda */
    .sap-tree-item.search-highlight {
      background: rgba(91, 139, 180, 0.15);
      border-left: 3px solid var(--primary);
    }

    .sap-tree-item.search-highlight .sap-tree-label {
      color: var(--primary-light);
      font-weight: 600;
    }

    .sap-toolbar-btn {
      background: var(--gray-400);
      border: 1px solid var(--gray-500);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      color: var(--gray-800);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .sap-toolbar-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }

    .sap-toolbar-btn:active {
      background: var(--primary-dark);
      transform: scale(0.98);
    }

    .sap-toolbar-btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
      font-weight: 600;
    }

    .sap-toolbar-btn-primary:hover {
      background: var(--primary-light);
    }

    .sap-toolbar-separator {
      width: 1px;
      height: 20px;
      background: var(--gray-500);
      margin: 0 4px;
    }

    /* Indicador de carga */
    .sap-tree-loading {
      padding: 20px;
      text-align: center;
      color: var(--gray-700); /* Texto secundario */
      font-size: 12px;
    }

    /* Indicador vaco */
    .sap-tree-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--gray-600);
      font-size: 12px;
      line-height: 1.6;
    }

    .sap-tree-empty-child {
      padding: 8px 12px;
      margin: 4px 0;
      color: var(--text-muted);
      font-size: 11px;
      font-style: italic;
    }

    /* ============================================================
       NODOS DEL RBOL SAP (JERARQUA CONFIGURABLE)
       ============================================================ */
    .sap-tree {
      padding: 8px;
    }

    .sap-node {
      margin: 4px 0;
      border-left: 2px solid var(--border-color);
      padding-left: 12px;
    }

    .sap-node-level-1 {
      border-left-color: var(--primary);
    }

    .sap-node-level-2 {
      border-left-color: var(--info);
      margin-left: 20px;
    }

    .sap-node-level-3 {
      border-left-color: var(--success);
      margin-left: 40px;
    }

    .sap-node-level-4 {
      border-left-color: var(--warning);
      margin-left: 60px;
    }

    .sap-node-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sap-node-header:hover {
      background: var(--bg-elevated);
      transform: translateX(2px);
    }

    .sap-node-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .sap-node-label {
      flex: 1;
      font-weight: 500;
      color: var(--text-primary);
    }

    .sap-node-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .sap-node-toggle {
      font-size: 0.8rem;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }

    .sap-node-children {
      margin-top: 4px;
      display: block;
    }

    /* ============================================================
       MODAL GESTIN DE JERARQUA
       ============================================================ */
    .jerarquia-manager {
      background: var(--bg-secondary);
      border-radius: 12px;
      overflow: hidden;
      margin: 20px 0;
    }

    .jerarquia-tabs {
      display: flex;
      gap: 4px;
      padding: 8px;
      background: var(--bg-tertiary);
      overflow-x: auto;
      border-bottom: 2px solid var(--border-color);
    }

    .jerarquia-tab {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 100px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .jerarquia-tab:hover {
      background: var(--bg-elevated);
      border-color: var(--primary);
    }

    .jerarquia-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }

    .jerarquia-tab .tab-icon {
      font-size: 1.5rem;
    }

    .jerarquia-tab .tab-label {
      font-size: 0.85rem;
      font-weight: 600;
      line-height: 1.3;
    }

    .jerarquia-tab .tab-label small {
      font-size: 0.7rem;
      opacity: 0.8;
      font-weight: normal;
    }

    .jerarquia-content {
      padding: 20px;
    }

    .jerarquia-level-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-color);
    }

    .jerarquia-level-header h3 {
      font-size: 1.2rem;
      color: var(--primary);
      margin: 0;
    }

    .jerarquia-form {
      background: var(--bg-primary);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid var(--primary);
    }

    .jerarquia-form .form-group {
      margin-bottom: 16px;
    }

    .jerarquia-form .form-group:last-child {
      margin-bottom: 0;
    }

    .jerarquia-form label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .jerarquia-form .form-control {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .jerarquia-form .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .jerarquia-list {
      display: grid;
      gap: 12px;
    }

    .jerarquia-item {
      background: var(--bg-primary);
      padding: 16px;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      transition: all 0.2s ease;
    }

    .jerarquia-item:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
      background: rgba(0, 0, 0, 0.15);
    }

    .jerarquia-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .jerarquia-item-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .jerarquia-item-toggle {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
      line-height: 1;
    }

    .jerarquia-item-toggle:hover {
      background: rgba(52, 152, 219, 0.1);
      transform: scale(1.1);
    }

    .jerarquia-item-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .jerarquia-item-toggle.collapsed:hover {
      transform: rotate(-90deg) scale(1.1);
    }

    .jerarquia-item-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .jerarquia-item-name:hover {
      color: var(--primary);
    }

    .jerarquia-item-content {
      flex: 1;
    }

    .jerarquia-item-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .jerarquia-item-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .jerarquia-item-actions {
      display: flex;
      gap: 8px;
    }

    .jerarquia-item-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .jerarquia-item-btn-edit {
      background: var(--info);
      color: white;
    }

    .jerarquia-item-btn-edit:hover {
      background: var(--info-dark);
      transform: scale(1.05);
    }

    .jerarquia-item-btn-delete {
      background: var(--danger);
      color: white;
    }

    .jerarquia-item-btn-delete:hover {
      background: var(--danger-dark);
      transform: scale(1.05);
    }

    .jerarquia-item-btn-subnivel {
      background: var(--success);
      color: white;
    }

    .jerarquia-item-btn-subnivel:hover {
      background: var(--success-dark);
      transform: scale(1.05);
    }

    .jerarquia-subitems {
      margin-top: 12px;
      margin-left: 32px;
      padding-left: 16px;
      border-left: 3px solid var(--primary);
      display: none;
    }

    .jerarquia-subitems.expanded {
      display: block;
    }

    .jerarquia-subitem {
      background: rgba(52, 152, 219, 0.05);
      padding: 12px;
      border-radius: 6px;
      border: 2px solid rgba(52, 152, 219, 0.2);
      margin-bottom: 8px;
      transition: all 0.2s ease;
    }

    .jerarquia-subitem:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-sm);
      background: rgba(0, 0, 0, 0.1);
    }

    .jerarquia-subitem-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .jerarquia-subitem-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .jerarquia-item.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .jerarquia-item.drag-over {
      border-color: var(--success);
      border-style: dashed;
      background: rgba(46, 204, 113, 0.1);
    }

    /* MAPA */
    .map-container {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: var(--card-shadow);
    }

    .map-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tool-btn {
      padding: 10px 16px;
      border: 2px solid var(--border-color);
      background: var(--bg-primary);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      min-height: 48px;
    }

    .tool-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    #mapCanvas {
      width: 100%;
      height: 100%;
      border: 3px solid var(--border-color);
      border-radius: 16px;
      background: var(--bg-primary);
      cursor: crosshair;
    }

    /* CONTEO */
    .conteo-controls {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .conteo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .conteo-progress {
      width: 100%;
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      margin: 16px 0;
    }

    .conteo-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--success) 0%, #34d399 100%);
      transition: width 0.3s;
      border-radius: 4px;
    }

    .conteo-item {
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 8px;
      margin-bottom: 12px;
      border: 2px solid var(--border-color);
      transition: all 0.3s;
    }

    .conteo-item:hover {
      border-color: var(--primary);
      background: var(--bg-secondary);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
    }

    .conteo-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-300);
      border-radius: 8px;
      font-size: 1.2rem;
      text-align: center;
      font-weight: 700;
      margin-top: 12px;
    }

    /* RESPONSIVE */
    /* Optimizacin para pantallas grandes */
    @media (min-width: 1400px) {
      .container {
        padding: 30px 40px;
      }
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }

      .header-actions {
        justify-content: center;
        flex-wrap: wrap;
      }

      .logo h1 {
        font-size: 1.5rem;
      }

      .logo p {
        font-size: 0.8rem;
      }

      .cards-grid {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 16px;
      }

      .repuesto-card {
        max-width: 100%;
      }

      .card-image {
        height: 220px;
      }

      .stock-badge-new {
        min-width: 120px !important;
        padding: 6px 10px !important;
        font-size: 0.7rem !important;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .list-header,
      .list-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .list-header {
        grid-template-columns: 1fr;
        font-size: 0.8rem;
        padding: 12px;
      }
      
      .list-header-cell {
        padding: 8px;
        justify-content: center;
      }
      
      .list-header-cell:not(:first-child) {
        display: none;
      }

      .list-row {
        grid-template-columns: 1fr;
        padding: 16px 12px;
        gap: 12px;
      }
      
      .list-row > div {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .list-row > div::before {
        content: attr(data-label);
        font-weight: 700;
        color: var(--text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .list-actions {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 8px !important;
        width: 100% !important;
      }
      
      .list-actions::before {
        display: none;
      }
      
      .list-actions button {
        font-size: 0.75rem !important;
        padding: 10px 8px !important;
      }
      
      .stock-visual {
        padding: 8px;
        background: var(--bg-primary);
        border-radius: 6px;
      }

      .toolbar {
        flex-direction: column;
        gap: 12px;
      }

      .search-box {
        width: 100%;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      #pagination {
        flex-wrap: wrap;
        padding: 12px;
        gap: 8px;
        justify-content: center;
      }

      #pagination > div {
        flex-basis: 100%;
        justify-content: center;
        margin-bottom: 8px;
      }

      #itemsPerPageSelect {
        font-size: 0.85rem;
        padding: 6px 10px;
      }

      #pagination .btn {
        min-width: 70px;
        font-size: 0.8rem;
        padding: 8px 12px;
      }

      #pageNumbers .btn {
        min-width: 36px;
        padding: 8px;
        font-size: 0.85rem;
      }

      .nav-tab {
        font-size: 0.85rem;
        padding: 16px 12px;
      }

      .btn {
        min-height: 44px; /* iOS touch target mnimo */
        font-size: 0.9rem;
      }

      .fs-button {
        bottom: 20px;
        right: 20px;
        min-width: 150px;
        padding: 12px 20px;
        font-size: 0.85rem;
      }

      /* Lightbox en mvil */
      .lightbox-close {
        width: 44px;
        height: 44px;
        font-size: 24px;
        top: 10px;
        right: 10px;
      }

      .lightbox-nav {
        width: 50px;
        height: 50px;
        font-size: 28px;
      }

      .lightbox-counter {
        font-size: 0.9rem;
        padding: 8px 16px;
      }

      /* Modal en mvil */
      .modal-content {
        width: 95%;
        max-height: 90vh;
        padding: 20px;
      }
      
      /* Formulario en mvil: 1 columna */
      .form-row,
      .form-row-triple,
      .form-row-quad {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .multimedia-preview {
        max-height: 150px;
      }
    }

    /* ================================================================== */
    /* OPTIMIZACIN PARA PANTALLAS GRANDES - Modal ms compacto */
    /* ================================================================== */
    @media (min-width: 1400px) {
      .modal-content {
        width: clamp(700px, 80vw, 1000px) !important;
        max-width: 1000px !important;
      }
      
      .sap-form-content {
        transform: scale(0.95);
        transform-origin: top center;
      }
      
      .wizard-timeline {
        gap: 8px;
      }
      
      .wizard-step-indicator {
        padding: 8px 12px;
      }
      
      .form-section-header h3 {
        font-size: 1.05rem;
      }
      
      .form-section-description {
        font-size: 0.8rem;
      }
    }

    /* ================================================================== */
    /* OPTIMIZACIN ESPECFICA PARA IPHONE 16 PRO (393x852px) Y SIMILARES */
    /* Pantallas pequeas: max-width 430px (iPhone 16 Pro, 15 Pro, 14 Pro, etc.) */
    /* ================================================================== */
    @media (max-width: 430px) {
      /* Reducir padding global */
      .container {
        padding: 10px 6px !important;
      }

      /* Optimizar header */
      .logo h1 {
        font-size: 1.25rem !important;
        margin-bottom: 2px !important;
      }

      .logo p {
        font-size: 0.7rem !important;
      }

      /* Botones del header ms compactos */
      .header-actions {
        gap: 6px !important;
      }

      .header-actions button,
      .header-actions .btn {
        padding: 8px 10px !important;
        font-size: 0.75rem !important;
        min-width: auto !important;
        min-height: 38px !important;
      }

      /* Cards ultra optimizadas */
      .cards-grid {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
        padding: 6px !important;
      }

      .repuesto-card {
        border-radius: 10px !important;
        box-shadow: var(--shadow-md) !important;
      }

      .card-content {
        padding: 8px !important;
      }

      .card-content h3 {
        font-size: 0.9rem !important;
        line-height: 1.25 !important;
        margin-bottom: 4px !important;
      }

      .card-content h4 {
        font-size: 0.75rem !important;
        margin: 3px 0 !important;
      }

      .card-info {
        font-size: 0.7rem !important;
        gap: 4px !important;
        margin-top: 4px !important;
      }

      .card-image {
        height: 180px !important;
      }

      /* Badges ms compactos */
      .stock-badge-new {
        min-width: 90px !important;
        padding: 4px 6px !important;
        font-size: 0.6rem !important;
      }

      /* Botones de accin ms pequeos */
      .card-actions {
        gap: 4px !important;
        padding: 6px !important;
      }

      .card-actions button {
        padding: 7px 8px !important;
        font-size: 0.7rem !important;
        min-height: 36px !important;
      }

      /* Filtros compactos */
      .filtros-grupo {
        grid-template-columns: 1fr !important;
        gap: 6px !important;
        padding: 8px !important;
      }

      .filtros-grupo select,
      .filtros-grupo input {
        padding: 7px !important;
        font-size: 0.8rem !important;
      }

      /* Modal optimizado para pantalla pequea */
      #modalRepuesto > div {
        width: 98% !important;
        max-width: 98% !important;
        margin: 1% auto !important;
        padding: 12px !important;
        border-radius: 12px !important;
      }

      #modalRepuesto h2 {
        font-size: 1.1rem !important;
        margin-bottom: 12px !important;
      }

      #modalRepuesto .form-group {
        margin-bottom: 10px !important;
      }

      #modalRepuesto .form-group label {
        font-size: 0.8rem !important;
        margin-bottom: 4px !important;
      }

      #modalRepuesto input,
      #modalRepuesto select,
      #modalRepuesto textarea {
        padding: 8px !important;
        font-size: 0.85rem !important;
      }

      #modalRepuesto textarea {
        min-height: 60px !important;
      }

      /* Botones del modal */
      #modalRepuesto button {
        padding: 9px 14px !important;
        font-size: 0.8rem !important;
        min-height: 38px !important;
      }

      /* Lightbox optimizado */
      .lightbox-image {
        max-width: 95vw !important;
        max-height: 65vh !important;
      }

      .lightbox-prev,
      .lightbox-next {
        width: 38px !important;
        height: 38px !important;
        font-size: 1.1rem !important;
      }

      .lightbox-close {
        width: 34px !important;
        height: 34px !important;
        font-size: 1.4rem !important;
        top: 8px !important;
        right: 8px !important;
      }

      .lightbox-counter {
        bottom: 15px !important;
        padding: 6px 12px !important;
        font-size: 0.8rem !important;
      }

      /* Toast ms compacto */
      .toast {
        bottom: 8px !important;
        left: 8px !important;
        right: 8px !important;
        padding: 10px 12px !important;
        font-size: 0.8rem !important;
      }

      /* Preview de imgenes ms pequeo */
      .multimedia-preview {
        max-height: 120px !important;
      }

      .multimedia-preview img {
        max-width: 70px !important;
        max-height: 70px !important;
      }

      /* Botones de foto mvil optimizados */
      #mobile-photo-buttons {
        margin-bottom: 10px !important;
      }

      #mobile-photo-buttons button {
        padding: 9px !important;
        font-size: 0.8rem !important;
        gap: 4px !important;
      }

      /* Toolbar compacto */
      .toolbar {
        padding: 8px !important;
        gap: 8px !important;
      }

      .search-box input {
        padding: 8px !important;
        font-size: 0.85rem !important;
      }

      /* Paginacin ms compacta */
      #pagination {
        padding: 8px !important;
        gap: 6px !important;
      }

      #pagination .btn {
        min-width: 60px !important;
        font-size: 0.75rem !important;
        padding: 6px 10px !important;
        min-height: 36px !important;
      }

      #pageNumbers .btn {
        min-width: 32px !important;
        padding: 6px !important;
        font-size: 0.8rem !important;
      }

      /* Tabs ms compactas */
      .nav-tab {
        font-size: 0.8rem !important;
        padding: 12px 8px !important;
      }

      /* Stats grid en 1 columna */
      .stats-grid {
        grid-template-columns: 1fr !important;
        gap: 8px !important;
      }

      /* Botn flotante ms pequeo */
      .fs-button {
        bottom: 15px !important;
        right: 15px !important;
        min-width: 130px !important;
        padding: 10px 16px !important;
        font-size: 0.8rem !important;
      }
    }

    /* Tabletas y pantallas medianas (769px - 1024px) */
    @media (min-width: 769px) and (max-width: 1024px) {
      .form-row-triple {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .form-row-quad {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Pantallas grandes (> 1400px) - Aprovechar espacio */
    @media (min-width: 1400px) {
      .multimedia-preview {
        max-height: 200px;
      }
    }
    
    /* Pantallas ultra anchas (> 1920px) */
    @media (min-width: 1920px) {
    }

    /* iPhone y pantallas pequeñas (< 480px) - delegado a sección #modal */
    @media (max-width: 480px) {
      .header {
        padding: 12px;
      }

      .logo h1 {
        font-size: 1.3rem;
      }

      .cards-grid {
        padding: 12px;
        gap: 12px;
      }

      .card-footer {
        flex-wrap: wrap;
        gap: 8px;
      }

      .card-btn {
        flex: 1 1 100%;
        min-width: 100%;
      }

      #pagination .btn {
        min-width: 60px;
        padding: 6px 10px;
        font-size: 0.75rem;
      }

      #pageNumbers .btn {
        min-width: 32px;
        padding: 6px;
      }

      .nav-tab {
        font-size: 0.75rem;
        padding: 14px 8px;
        letter-spacing: 0;
      }
      
      .modal-title {
        font-size: 1.3rem;
      }
      
      .form-control {
        padding: 10px 12px;
        font-size: 0.95rem;
      }

      /*  OCULTAR ELEMENTOS INNECESARIOS EN MVIL */
      .pc-only-config,
      #icloud-config-section,
      .view-btns {
        display: none !important;
      }

      /* Optimizar toolbar mvil */
      .toolbar {
        flex-direction: column;
        gap: 10px;
      }

      .search-box {
        width: 100%;
      }

      /* Lista mvil optimizada */
      .list-view {
        padding: 12px;
      }

      /* Ocultar paginacin en mvil (vista completa sin paginar) */
      #pagination {
        display: none !important;
      }
    }

    /* UTILIDADES */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mt-2 {
      margin-top: 20px;
    }

    .mb-2 {
      margin-bottom: 20px;
    }

    .precio-info {
      transition: opacity 0.3s;
    }

    .precio-info.hidden {
      display: none;
    }

    /* CONTENEDOR FIJO SUPERIOR */
    .sticky-header-container {
      position: sticky;
      top: 0;
      z-index: 1000;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
      background: rgba(10, 13, 21, 0.92);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* INDICADOR DE CONEXIN SUTIL - PEQUEO */
    .connection-indicator {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      padding: 4px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .connection-icon {
      font-size: 0.9rem;
    }

    .connection-text {
      font-weight: 500;
    }

    .connection-indicator.connected {
      border-bottom-color: rgba(16, 185, 129, 0.3);
    }

    .connection-indicator.connected .connection-icon {
      filter: hue-rotate(100deg);
    }

    .connection-indicator.connected .connection-text {
      color: #10b981;
    }

    .connection-indicator.disconnected {
      border-bottom-color: rgba(239, 68, 68, 0.3);
    }

    .connection-indicator.disconnected .connection-icon {
      animation: pulse 2s infinite;
    }

    .connection-indicator.disconnected .connection-text {
      color: #ef4444;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    /* ANIMACIONES Y EFECTOS ADICIONALES - MODO OSCURO */
    
    /* Efecto de pulsacin para badges */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.05);
      }
    }

    .badge-cero {
      animation: pulse 2s infinite;
    }

    /* Efecto de gradiente animado para elementos premium */
    @keyframes gradientFlow {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    .header {
      background: linear-gradient(135deg, 
        #1e293b 0%, 
        #0f172a 25%, 
        #1e293b 50%, 
        #0f172a 75%, 
        #1e293b 100%);
      background-size: 200% 200%;
      animation: gradientFlow 15s ease infinite;
    }

    /* Resplandor suave en hover para interactivos */
    .nav-tab:hover,
    .btn:hover,
    .repuesto-card:hover {
      filter: brightness(1.1);
    }

    /* Transicin suave para todos los elementos */
    * {
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Efecto de reveal para cards */
    @keyframes cardReveal {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .repuesto-card {
      animation: cardReveal 0.4s ease forwards;
    }

    .repuesto-card:nth-child(1) { animation-delay: 0.05s; }
    .repuesto-card:nth-child(2) { animation-delay: 0.1s; }
    .repuesto-card:nth-child(3) { animation-delay: 0.15s; }
    .repuesto-card:nth-child(4) { animation-delay: 0.2s; }
    .repuesto-card:nth-child(5) { animation-delay: 0.25s; }
    .repuesto-card:nth-child(6) { animation-delay: 0.3s; }

    /* Efecto de brillo en imgenes al hover */
    .card-image img {
      transition: all 0.4s ease;
    }

    .card-image:hover img {
      transform: scale(1.05);
      filter: brightness(1.1) contrast(1.05);
    }

    /* Scrollbar con gradiente */
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #334155, #475569);
      border-radius: 6px;
      border: 2px solid #0f172a;
      box-shadow: inset 0 0 6px rgba(59, 130, 246, 0.3);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #475569, #64748b);
      box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.5);
    }

    /* Loading spinner mejorado */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(59, 130, 246, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      filter: drop-shadow(0 0 6px var(--primary));
    }

    /* Spinner pequeo para botones */
    .spinner-small {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    /* Efecto nen en ttulos */
    h1, h2 {
      text-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }

    /* Badge mejorado con efecto glow */
    .card-badge {
      box-shadow: 0 0 15px currentColor;
      border: 2px solid currentColor;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    /* Info cards con hover mejorado */
    .info-row:hover {
      background: rgba(59, 130, 246, 0.05);
      border-radius: 8px;
      padding: 8px;
      margin: -8px;
      transition: all 0.3s;
    }

    /* Botones con ripple effect */
    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    .btn.ripple::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      animation: ripple 0.6s;
    }

    /* Mejora visual para select y textarea */
    select.form-control,
    textarea.form-control {
      background-image: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    }

    /* Efecto de enfoque en navegacin activa */
    .nav-tab.active {
      animation: tabActivate 0.3s ease;
    }

    @keyframes tabActivate {
      0% {
        transform: scale(0.95);
      }
      50% {
        transform: scale(1.02);
      }
      100% {
        transform: scale(1);
      }
    }

    /* Efecto de partculas en el fondo (sutil) */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(59, 130, 246, 0.02) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    /* Mejora de contraste para accesibilidad */
    .btn:focus-visible,
    .form-control:focus-visible,
    .nav-tab:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    /* Estilos para el modal de conteo individual */
    .modal-backdrop-custom {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      -webkit-backdrop-filter: blur(5px);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    .modal-dialog-custom {
      animation: slideUpModal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-content-custom {
      background: #1e293b;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      border: 1px solid #334155;
    }

    .modal-header-custom {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header-custom h3 {
      margin: 0;
      font-size: 1.3em;
      font-weight: 600;
    }

    .modal-header-custom .close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      line-height: 1;
    }

    .modal-header-custom .close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .modal-body-custom {
      padding: 25px;
    }

    .modal-footer-custom {
      padding: 20px 25px;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes slideUpModal {
      from {
        transform: translateY(50px) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* Estilos responsive para el modal de conteo */
    @media (max-width: 600px) {
      .modal-dialog-custom {
        margin: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
        height: 100% !important;
      }

      .modal-backdrop-custom {
        padding: 0 !important;
      }

      .modal-content-custom {
        border-radius: 0 !important;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .modal-body-custom {
        padding: 16px;
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .modal-footer-custom {
        padding: 12px 16px;
        position: sticky;
        bottom: 0;
        background: #1e293b;
        border-top: 1px solid #334155;
      }

      .modal-header-custom {
        padding: 16px !important;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .modal-header-custom h3 {
        font-size: 1.1rem !important;
      }
    }

    /* ======================================== */
    /* OKR VISUAL MANAGER */
    /* ======================================== */
    .okr-wrapper {
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding: 6px 0 32px;
    }

    .okr-hero {
      display: flex;
      gap: 24px;
      align-items: stretch;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 18px;
      padding: 28px;
      box-shadow: var(--shadow-md);
      flex-wrap: wrap;
    }

    .okr-hero-text {
      flex: 1 1 320px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .okr-hero-text h2 {
      font-size: 1.9rem;
      line-height: 1.3;
      color: var(--primary-light);
    }

    .okr-hero-text p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .okr-hero-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .okr-upload-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      border-radius: 12px;
      padding: 12px 22px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .okr-upload-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .okr-upload-btn input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .okr-secondary-btn {
      background: rgba(91, 124, 153, 0.12);
      color: var(--primary-light);
      border: 1px solid rgba(91, 124, 153, 0.35);
      border-radius: 10px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .okr-secondary-btn:hover {
      background: rgba(91, 124, 153, 0.2);
      color: var(--text-primary);
    }

    .okr-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .okr-dropzone {
      flex: 0 1 280px;
      border: 2px dashed rgba(122, 154, 184, 0.5);
      border-radius: 16px;
      background: rgba(45, 55, 72, 0.55);
      color: var(--text-secondary);
      display: grid;
      place-items: center;
      padding: 24px;
      text-align: center;
      gap: 8px;
      transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
    }

    .okr-dropzone:hover {
      border-color: var(--primary-light);
      background: rgba(74, 98, 120, 0.6);
      transform: translateY(-2px);
    }

    .okr-dropzone.is-dragover {
      border-color: var(--success);
      background: rgba(107, 142, 127, 0.25);
      color: var(--text-primary);
    }

    .okr-dropzone-icon {
      font-size: 2.4rem;
      line-height: 1;
    }

    .okr-summary {
      display: none;
    }

    .okr-summary.is-visible {
      display: block;
    }

    .okr-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .okr-summary-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .okr-summary-label {
      color: var(--text-muted);
      font-size: 0.85rem;
      letter-spacing: 0.02em;
    }

    .okr-summary-value {
      font-size: 1.9rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.01em;
    }

    .okr-summary-sub {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .okr-filters {
      display: none;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 18px;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      box-shadow: var(--shadow-sm);
    }

    .okr-filters.is-active {
      display: grid;
    }

    .okr-filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .okr-filter-group label {
      font-size: 0.78rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .okr-filter-group select,
    .okr-filter-group input[type="search"] {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .okr-filter-group select:focus,
    .okr-filter-group input[type="search"]:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 2px rgba(91, 124, 153, 0.2);
    }

    .okr-filter-actions {
      align-items: flex-end;
      justify-content: flex-end;
    }

    .okr-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: flex-start;
    }

    .okr-objectives-column {
      flex: 1 1 55%;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .okr-objectives-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .okr-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .okr-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(91, 124, 153, 0.22), transparent 55%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .okr-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }

    .okr-card:hover::after {
      opacity: 1;
    }

    .okr-card-header {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .okr-card-title h3 {
      font-size: 1.15rem;
      color: var(--text-primary);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .okr-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.8rem;
    }

    .okr-progress-ring {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: conic-gradient(var(--progress-color, var(--primary-light)) calc(var(--progress, 0) * 1deg), rgba(255, 255, 255, 0.08) 0deg);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: var(--text-primary);
      position: relative;
    }

    .okr-progress-ring::before {
      content: '';
      position: absolute;
      inset: 8px;
      background: var(--bg-secondary);
      border-radius: 50%;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.07);
    }

    .okr-progress-ring span {
      position: relative;
      font-size: 1rem;
      letter-spacing: 0.03em;
    }

    .okr-card-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .okr-card-notes {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .okr-metadata-line {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .okr-meta-item {
      background: rgba(91, 124, 153, 0.18);
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid rgba(91, 124, 153, 0.25);
    }

    .okr-kr-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .okr-kr-card {
      background: var(--bg-primary);
      border: 1px solid rgba(91, 124, 153, 0.25);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .okr-kr-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .okr-kr-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.92rem;
      line-height: 1.4;
    }

    .okr-kr-progress {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .okr-kr-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .okr-kr-footer {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .okr-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      background: rgba(91, 124, 153, 0.18);
      color: var(--text-secondary);
      border: 1px solid rgba(91, 124, 153, 0.25);
    }

    .okr-chip.muted {
      background: rgba(45, 55, 72, 0.6);
      color: var(--text-secondary);
      border-color: rgba(148, 163, 184, 0.18);
    }

    .okr-chip.tag {
      background: rgba(91, 124, 153, 0.12);
      color: var(--primary-light);
    }

    .okr-chip.mini {
      padding: 3px 8px;
      font-size: 0.7rem;
    }

    .okr-chip.status-on_track,
    .okr-chip.status.status-on_track {
      background: rgba(107, 142, 127, 0.2);
      border-color: rgba(107, 142, 127, 0.4);
      color: var(--success);
    }

    .okr-chip.status-at_risk,
    .okr-chip.status.status-at_risk {
      background: rgba(212, 151, 108, 0.18);
      border-color: rgba(212, 151, 108, 0.35);
      color: var(--warning);
    }

    .okr-chip.status-off_track,
    .okr-chip.status.status-off_track {
      background: rgba(199, 107, 107, 0.18);
      border-color: rgba(199, 107, 107, 0.35);
      color: var(--danger);
    }

    .okr-chip.status-completed,
    .okr-chip.status.status-completed {
      background: rgba(91, 124, 153, 0.2);
      border-color: rgba(91, 124, 153, 0.4);
      color: var(--primary-light);
    }

    .okr-chip.status-not_started,
    .okr-chip.status.status-not_started {
      background: rgba(113, 128, 150, 0.18);
      border-color: rgba(113, 128, 150, 0.3);
      color: var(--text-secondary);
    }

    .okr-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .okr-insights-column {
      flex: 1 1 300px;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .okr-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .okr-panel-header {
      padding: 16px 20px;
      font-weight: 600;
      letter-spacing: 0.03em;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      background: rgba(74, 98, 120, 0.35);
    }

    .okr-panel-body {
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .okr-kr-row,
    .okr-initiative-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px;
      border-radius: 12px;
      background: var(--bg-primary);
      border: 1px solid rgba(91, 124, 153, 0.25);
    }

    .okr-row-top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }

    .okr-row-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.88rem;
      line-height: 1.4;
    }

    .okr-row-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.76rem;
      color: var(--text-secondary);
    }

    .okr-empty,
    .okr-empty-panel {
      text-align: center;
      padding: 40px 24px;
      border-radius: 16px;
      border: 1px dashed rgba(91, 124, 153, 0.3);
      background: rgba(45, 55, 72, 0.6);
      color: var(--text-secondary);
      display: grid;
      gap: 12px;
    }

    .okr-empty h3 {
      font-size: 1.2rem;
      color: var(--primary-light);
    }

    .okr-empty ul {
      list-style: disc;
      margin: 0 auto;
      padding: 0 20px;
      text-align: left;
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: grid;
      gap: 4px;
    }

    .okr-hidden {
      display: none !important;
    }

    @media (max-width: 1024px) {
      .okr-layout {
        flex-direction: column;
      }

      .okr-objectives-column,
      .okr-insights-column {
        flex: 1 1 100%;
      }
    }

    @media (max-width: 720px) {
      .okr-hero {
        padding: 22px;
      }

      .okr-hero-text h2 {
        font-size: 1.6rem;
      }

      .okr-summary-grid {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .okr-objectives-grid {
        grid-template-columns: 1fr;
      }
    }

    /* MAPA - SECCION INTEGRADA */
    .map-shell {
      display: grid;
      grid-template-columns: 680px minmax(0, 1fr); /* 🔧 Panel izquierdo: 680px (alineado con 'JERARQUIA') */
      gap: 12px;
      align-items: stretch;
      width: 100%;
      height: 100%;
      max-height: 100%;
      padding: 2px;
      box-sizing: border-box;
      margin: 0;
    }

    .map-panel {
      background: var(--bg-secondary);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-md);
      min-height: 500px;
      height: 100%; /*  NUEVO: Tomar altura completa del grid */
      overflow: hidden;
      margin: 0; /*  NUEVO: Sin mrgenes para aprovechar espacio */
    }

    .map-panel-header {
      padding: 6px 10px;
      border-bottom: 1px solid var(--border-color-light);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.12));
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 5px;
      flex-shrink: 0;
    }

    .map-panel-header h2 {
      font-size: 0.9rem;
      margin: 0;
      color: var(--text-primary);
      font-weight: 700;
      line-height: 1.2;
    }

    .map-panel-header p {
      font-size: 0.6rem;
      color: var(--text-secondary);
      margin-top: 1px;
      line-height: 1.2;
    }

    .map-connection {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
    }

    .map-storage-banner {
      display: none; /* Oculto - funcionalidad FileSystem no utilizada */
    }

    .map-storage-status {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Modal de Carga con Barra de Progreso */
    .loading-modal {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top, rgba(102, 126, 234, 0.15), rgba(0, 0, 0, 0.85));
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    body.loading-modal-active {
      overflow: hidden;
    }

    body.loading-modal-active > *:not(.loading-modal) {
      filter: blur(1px) saturate(0.9);
      transition: filter 0.3s ease;
      pointer-events: none;
    }

    .loading-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .loading-modal::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at bottom right, rgba(118, 75, 162, 0.25), transparent 45%);
      animation: modalGlow 6s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes modalGlow {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 0.4; }
    }

    .loading-modal-content {
      background: linear-gradient(145deg, rgba(26, 27, 61, 0.95), rgba(33, 44, 85, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 26px;
      padding: 48px 52px;
      text-align: center;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.45);
      max-width: 480px;
      width: min(90%, 500px);
      position: relative;
      overflow: hidden;
    }

    .loading-modal-content::before {
      content: '';
      position: absolute;
      inset: 10px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      pointer-events: none;
    }

    @keyframes modalSlideIn {
      from {
        transform: scale(0.8) translateY(-30px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .loading-modal-icon {
      font-size: 68px;
      margin-bottom: 24px;
      animation: iconPulse 2.4s ease-in-out infinite;
      filter: drop-shadow(0 8px 18px rgba(0, 0, 0, 0.35));
    }

    @keyframes iconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .loading-modal-title {
      font-size: 30px;
      font-weight: 700;
      color: white;
      margin-bottom: 12px;
      text-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
      letter-spacing: 0.4px;
    }

    .loading-modal-text {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 22px;
    }

    .loading-progress-container {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 50px;
      height: 12px;
      overflow: hidden;
      margin-bottom: 16px;
      box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.35);
      position: relative;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 45%, #a6ffcb 100%);
      border-radius: 50px;
      transition: width 0.25s ease;
      box-shadow: 0 0 20px rgba(79, 172, 254, 0.6);
      position: relative;
      overflow: hidden;
    }

    .loading-progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .loading-progress-text {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .loading-modal-status {
      font-size: 13px;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.7);
      letter-spacing: 2px;
      margin-bottom: 12px;
    }

    .loading-modal-tip {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.75);
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 12px 16px;
      margin-top: 20px;
      line-height: 1.4;
    }

    .map-storage-clean-btn {
      font-size: 0.7rem;
      padding: 6px 10px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
    }

    .map-storage-clean-btn:hover {
      border-color: rgba(59, 130, 246, 0.7);
      color: var(--text-primary);
    }

    .map-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--text-secondary);
    }

    .map-status-badge--off {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(239, 68, 68, 0.4);
      color: rgba(239, 68, 68, 0.9);
    }

    .map-status-badge--on {
      background: rgba(16, 185, 129, 0.12);
      border-color: rgba(16, 185, 129, 0.4);
      color: rgba(16, 185, 129, 0.9);
    }

    .map-panel-scroll {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 6px 8px;
      display: grid;
      gap: 6px;
      min-height: 0;
    }

    /* ============================================
       🎯 GUÍA DE FLUJO DE TRABAJO - MAPAS
       ============================================ */
    .map-workflow-guide {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 10px;
      padding: 12px !important;
      margin-bottom: 12px;
    }

    .workflow-guide-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .workflow-guide-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #60a5fa;
    }

    .workflow-icon {
      font-size: 1.1rem;
    }

    .workflow-dismiss-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-muted);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .workflow-dismiss-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: var(--text-primary);
    }

    .workflow-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .workflow-step {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(26, 29, 35, 0.7);
      border: 1px solid rgba(91, 139, 180, 0.25);
      border-radius: 8px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 120px;
    }

    .workflow-step:hover {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.5);
      transform: translateY(-2px);
    }

    .step-number {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .step-content {
      flex: 1;
      min-width: 0;
    }

    .step-title {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .step-desc {
      font-size: 0.6rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .step-action {
      font-size: 1rem;
      opacity: 0.7;
    }

    .workflow-step-arrow {
      color: var(--text-muted);
      font-size: 1rem;
      opacity: 0.5;
    }

    .workflow-quick-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .workflow-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.72rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .workflow-action-btn.primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }

    .workflow-action-btn.primary:hover {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .workflow-action-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .workflow-action-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      color: var(--text-primary);
    }

    /* Ocultar guía cuando el usuario la cierra */
    .map-workflow-guide.hidden {
      display: none;
    }

    /* Placeholder cuando no hay mapas */
    .no-maps-placeholder,
    .no-pending-placeholder {
      text-align: center;
      padding: 24px 16px;
      background: rgba(26, 29, 35, 0.5);
      border: 2px dashed rgba(91, 139, 180, 0.25);
      border-radius: 10px;
    }

    .no-maps-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      opacity: 0.6;
    }

    .no-maps-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .no-maps-desc {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .no-maps-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .no-maps-btn:hover {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .no-pending-placeholder {
      padding: 16px;
    }

    /* Responsive para pantallas pequeñas */
    @media (max-width: 500px) {
      .workflow-steps {
        flex-direction: column;
        gap: 6px;
      }
      
      .workflow-step-arrow {
        transform: rotate(90deg);
      }
      
      .workflow-step {
        width: 100%;
      }
    }

    .map-section {
      background: var(--bg-primary);
      border-radius: 6px;
      padding: 5px 6px;
      box-shadow: var(--shadow-sm);
    }

    .map-section-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      padding: 0;
      min-height: 28px;
    }

    .map-section-header:hover h3 {
      color: var(--primary-color);
    }

    .map-section-header h3 {
      margin: 0;
      font-size: 0.7rem;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: color 0.2s ease;
      line-height: 1.2;
    }

    .map-section-collapse-icon {
      font-size: 0.7rem;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }

    .map-section--collapsed .map-section-collapse-icon {
      transform: rotate(-90deg);
    }

    .map-section--collapsed .map-card-list {
      display: none;
    }

    .map-card-list {
      display: grid;
      gap: 5px;
      padding: 0;
    }

    .map-card-list.map-hierarchy-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-hierarchy-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-hierarchy-group {
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.6);
      padding: 4px;
    }

    .map-hierarchy-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      cursor: pointer;
      position: relative;
      border-radius: 6px;
      transition: background 0.2s ease;
    }

    .map-hierarchy-header--clickable {
      cursor: pointer;
    }

    .map-hierarchy-header--static {
      cursor: default;
    }

    .map-hierarchy-header--static .map-hierarchy-chevron {
      opacity: 0;
      pointer-events: none;
    }

    .map-hierarchy-header--map {
      cursor: pointer;
    }

    .map-hierarchy-header:hover .map-hierarchy-label {
      color: var(--primary-light);
    }

    .map-hierarchy-header--active {
      background: rgba(59, 130, 246, 0.15);
    }

    .map-hierarchy-header-main {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .map-hierarchy-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .map-hierarchy-path {
      font-size: 0.6rem;
      color: var(--text-secondary);
    }

    .map-hierarchy-count {
      font-size: 0.6rem;
      color: var(--text-secondary);
      font-weight: 600;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .map-hierarchy-actions {
      display: inline-flex;
      gap: 4px;
      margin-right: 4px;
    }

    .map-hierarchy-actions .map-card-btn {
      padding: 2px 6px;
    }

    .map-hierarchy-tooltip {
      position: absolute;
      top: calc(100% + 6px);
      left: 6px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(59, 130, 246, 0.45);
      border-radius: 8px;
      padding: 8px 10px;
      box-shadow: 0 12px 32px rgba(2, 6, 23, 0.55);
      font-size: 0.65rem;
      color: var(--text-primary);
      min-width: 240px;
      max-width: 320px;
      z-index: 20;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-4px);
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    .map-hierarchy-header:hover .map-hierarchy-tooltip,
    .map-hierarchy-leaf:hover .map-hierarchy-tooltip {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .map-hierarchy-tooltip-line {
      display: block;
      margin-bottom: 4px;
      color: var(--text-secondary);
    }

    .map-hierarchy-tooltip-line strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .map-hierarchy-tooltip-line:last-child {
      margin-bottom: 0;
    }

    .map-hierarchy-chevron {
      display: inline-flex;
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      color: var(--text-secondary);
      transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .map-hierarchy-chevron::before {
      content: '\25BC';
    }

    .map-hierarchy-group--collapsed .map-hierarchy-chevron {
      transform: rotate(-90deg);
    }

    .map-hierarchy-body {
      padding: 4px 4px 8px 22px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-hierarchy-leaf-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .map-hierarchy-leaf {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.45);
      cursor: pointer;
      position: relative;
      transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    .map-hierarchy-leaf:hover {
      border-color: rgba(59, 130, 246, 0.6);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(2, 6, 23, 0.45);
    }

    .map-hierarchy-leaf--active {
      border-color: rgba(59, 130, 246, 0.8);
      box-shadow: 0 12px 28px rgba(59, 130, 246, 0.2);
    }

    .map-hierarchy-leaf-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
      flex: 1;
    }

    .map-hierarchy-leaf-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .map-hierarchy-leaf-meta {
      font-size: 0.6rem;
      color: var(--text-secondary);
    }

    .map-hierarchy-leaf-right {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .map-hierarchy-children {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-hierarchy-group--collapsed .map-hierarchy-body {
      display: none;
    }

    .map-hierarchy-cards {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-card {
      border-radius: 5px;
      padding: 5px 6px;
      background: rgba(15, 23, 42, 0.7);
      cursor: pointer;
      display: grid;
      gap: 2px;
      transition: transform 0.2s ease, border 0.2s ease, box-shadow 0.2s ease;
    }

    .map-card:hover {
      transform: translateY(-2px);
      border-color: rgba(59, 130, 246, 0.6);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.45);
    }

    .map-card--active {
      border-color: rgba(59, 130, 246, 0.8);
      box-shadow: 0 10px 24px rgba(59, 130, 246, 0.25);
    }

    .map-card-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.75rem; /*  Reducido de 0.8rem a 0.75rem */
      line-height: 1.2;
    }

    /* 🔥 NUEVO: Header con título e indicadores */
    .map-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    /* 🔥 NUEVO: Contenedor de indicadores */
    .map-card-indicators {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    /* 🔥 NUEVO: Indicadores visuales */
    .map-indicator {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.65rem;
      font-weight: 600;
      line-height: 1;
      white-space: nowrap;
    }

    .map-indicator--success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #4ade80;
    }

    .map-indicator--info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #60a5fa;
    }

    .map-indicator--warning {
      background: rgba(251, 146, 60, 0.1);
      border: 1px solid rgba(251, 146, 60, 0.3);
      color: #fb923c;
    }

    .map-card-path {
      font-size: 0.6rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .map-card-path--empty {
      color: rgba(248, 113, 113, 0.9);
    }

    /*  NUEVO: Contenedor y botones de acciones en tarjetas */
    .map-card-content {
      display: grid;
      gap: 2px; /*  Reducido de 3px a 2px */
      cursor: pointer;
    }

    .map-card-actions {
      display: flex;
      gap: 3px; /*  Reducido de 4px a 3px */
      margin-top: 3px; /*  Reducido de 4px a 3px */
      padding-top: 3px; /*  Reducido de 4px a 3px */
      border-top: 1px solid rgba(148, 163, 184, 0.15);
      justify-content: flex-end;
    }

    .map-card-btn {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 3px; /*  Reducido de 4px a 3px */
      padding: 2px 5px; /*  Reducido de 3px 7px a 2px 5px */
      font-size: 0.7rem; /*  Reducido de 0.75rem a 0.7rem */
      cursor: pointer;
      transition: all 0.2s ease;
      color: #94a3b8;
      line-height: 1.2;
    }

    .map-card-btn:hover {
      background: rgba(59, 130, 246, 0.3);
      border-color: rgba(59, 130, 246, 0.6);
      transform: translateY(-1px);
    }

    .map-card-btn--edit:hover {
      background: rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.5);
    }

    .map-card-btn--delete:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .map-card-btn--link {
      background: transparent;
      border-color: rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    .map-card-btn--link:hover {
      background: rgba(59, 130, 246, 0.15);
      color: var(--text-primary);
    }

    .map-jerarquia-badge {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.8);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 0.75rem;
      line-height: 1.4;
    }

    .map-jerarquia-badge--empty {
      border-style: dashed;
      opacity: 0.85;
    }

    .map-jerarquia-badge strong {
      display: block;
      font-size: 0.8rem;
      color: var(--text-primary);
    }

    .map-jerarquia-badge__path {
      color: var(--text-secondary);
      display: block;
      margin-top: 2px;
      font-weight: 500;
    }

    .map-jerarquia-badge button {
      flex-shrink: 0;
      padding: 6px 10px;
      font-size: 0.7rem;
    }

    .map-jerarquia-badge[data-state='free'] {
      border-color: rgba(94, 234, 212, 0.5);
      background: rgba(15, 118, 110, 0.18);
    }

    .map-jerarquia-badge[data-state='locked'] {
      border-color: rgba(14, 165, 233, 0.5);
      background: rgba(15, 23, 42, 0.8);
    }

    .map-jerarquia-badge[data-state='issue'] {
      border-color: rgba(248, 113, 113, 0.6);
      background: rgba(120, 53, 15, 0.3);
    }

    .map-jerarquia-badge[data-state='conflict'] {
      border-color: rgba(249, 115, 22, 0.8);
      background: rgba(120, 53, 15, 0.4);
    }

    .map-contract-signals {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .map-contract-signals.hidden {
      display: none;
    }

    .map-contract-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.65);
      color: var(--text-secondary);
    }

    .map-contract-chip--free {
      border-color: rgba(45, 212, 191, 0.6);
      color: rgba(94, 234, 212, 0.95);
    }

    .map-contract-chip--locked {
      border-color: rgba(59, 130, 246, 0.6);
      color: rgba(191, 219, 254, 0.95);
    }

    .map-contract-chip--issue {
      border-color: rgba(248, 113, 113, 0.7);
      color: rgba(254, 226, 226, 0.95);
    }

    .map-contract-chip--conflict {
      border-color: rgba(249, 115, 22, 0.8);
      color: rgba(255, 237, 213, 0.95);
    }

    .map-jerarquia-inline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px;
      background: rgba(148, 163, 184, 0.08);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .map-jerarquia-inline-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      flex: 1;
      min-height: 1.5em;
    }

    .map-jerarquia-branch {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-contract-panel {
      margin-top: 10px;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.75);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .map-contract-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    .map-contract-stat {
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-sm);
      padding: 8px;
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .map-contract-stat span {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .map-contract-stat strong {
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .map-contract-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .map-contract-actions small {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .map-contract-issues {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-contract-issue {
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 10px;
      background: rgba(15, 23, 42, 0.65);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-contract-issue h4 {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .map-contract-issue p {
      margin: 0;
      font-size: 0.78rem;
      color: var(--text-secondary);
    }

    .map-contract-issue__meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .map-contract-issue__tag {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-secondary);
      font-weight: 600;
    }

    .map-contract-issue--success {
      border-color: rgba(34, 197, 94, 0.4);
      background: rgba(22, 101, 52, 0.25);
    }

    .map-contract-issue--warning {
      border-color: rgba(251, 191, 36, 0.5);
      background: rgba(120, 53, 15, 0.35);
    }

    .map-contract-issue--error {
      border-color: rgba(248, 113, 113, 0.7);
      background: rgba(127, 29, 29, 0.4);
    }

    .map-contract-issue--info {
      border-color: rgba(14, 165, 233, 0.5);
      background: rgba(8, 47, 73, 0.45);
    }

    .map-contract-issue--empty {
      border-style: dashed;
      opacity: 0.8;
    }

    .map-contract-issue__actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .map-contract-issue__actions .map-btn {
      font-size: 0.7rem;
      padding: 4px 10px;
    }

    .map-jerarquia-branch-node {
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: var(--radius-sm);
      padding: 8px;
      background: rgba(15, 23, 42, 0.6);
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .map-jerarquia-branch-node.is-active {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.12);
    }

    .map-jerarquia-branch-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
    }

    .map-jerarquia-branch-level {
      font-weight: 600;
      color: var(--primary-light);
      font-size: 0.7rem;
      letter-spacing: 0.02em;
    }

    .map-jerarquia-branch-name {
      flex: 1;
      font-weight: 600;
      color: var(--text-primary);
      text-align: right;
    }

    .map-jerarquia-branch-stats {
      display: flex;
      gap: 12px;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .map-jerarquia-branch-stats strong {
      color: var(--text-primary);
      margin-right: 4px;
    }

    .map-jerarquia-branch-empty {
      padding: 10px;
      border: 1px dashed rgba(148, 163, 184, 0.3);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      color: var(--text-secondary);
      background: rgba(15, 23, 42, 0.4);
    }

    .map-jerarquia-modal {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .map-jerarquia-summary {
      padding: 14px 18px;
      border-radius: var(--radius-md);
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(59, 130, 246, 0.25);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .map-jerarquia-summary-text {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .map-jerarquia-selected {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      min-height: 36px;
    }

    .map-jerarquia-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.65);
      font-size: 0.78rem;
      line-height: 1;
      color: var(--text-primary);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.4);
    }

    .map-jerarquia-chip-level {
      font-size: 0.65rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--primary-light);
      opacity: 0.85;
    }

    .map-jerarquia-chip-name {
      font-weight: 600;
      white-space: nowrap;
    }

    .map-jerarquia-chip-arrow {
      display: inline-flex;
      align-items: center;
      color: var(--text-muted);
      font-size: 0.85rem;
      padding: 0 4px;
    }

    .map-jerarquia-chip--empty {
      border-style: dashed;
      color: var(--text-secondary);
    }

    .map-jerarquia-selector {
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.65);
      padding: 16px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .jerarquia-selector-tree-root,
    .jerarquia-selector-children {
      list-style: none;
      margin: 0;
      padding-left: 0;
    }

    .jerarquia-selector-tree-root > .jerarquia-selector-item {
      padding-left: 0;
      margin-left: 0;
      border-left: none;
    }

    .jerarquia-selector-children {
      margin-left: 18px;
      padding-left: 18px;
      border-left: 1px dashed rgba(148, 163, 184, 0.25);
    }

    .jerarquia-selector-item {
      margin: 4px 0;
      position: relative;
    }

    .jerarquia-selector-node {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.5);
      color: var(--text-primary);
      text-align: left;
      transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
      cursor: pointer;
    }

    .jerarquia-selector-node:hover {
      border-color: var(--primary-light);
      background: rgba(59, 130, 246, 0.15);
      transform: translateX(4px);
    }

    .jerarquia-selector-node.is-selected {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.18);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
    }

    .jerarquia-selector-level {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .jerarquia-selector-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .map-area-filter-alert {
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      background: rgba(59, 130, 246, 0.12);
      border: 1px solid rgba(59, 130, 246, 0.3);
      font-size: 0.75rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .map-area-filter-alert button {
      border: none;
      background: transparent;
      color: var(--primary-light);
      cursor: pointer;
      font-size: 0.72rem;
      font-weight: 600;
    }

    .map-area-list {
      display: grid;
      gap: 6px;
      max-height: calc(100vh - 280px);
      overflow-y: auto;
      padding: 0;
    }

    .map-area-item {
      border-radius: 4px;
      padding: 10px 12px;
      background: #3b4558;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      transition: background 0.15s ease;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .map-area-item:hover {
      background: #445062;
    }

    .map-area-item--active {
      background: #4a5568;
    }

    .map-area-content {
      display: flex;
      flex-direction: column;
      gap: 0;
      flex: 1;
      min-width: 0;
    }

    .map-area-title {
      font-weight: 400;
      color: #e2e8f0;
      font-size: 0.8125rem;
      line-height: 1.5;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .map-area-subtitle {
      font-size: 0.75rem;
      color: #94a3b8;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .map-area-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }
    
    .map-area-action-btn {
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #4a5568;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.15s ease;
      font-size: 0.75rem;
      padding: 0;
    }
    
    .map-area-action-btn:hover {
      background: #556277;
    }
    
    .map-area-action-btn--edit {
      color: #fbbf24;
    }
    
    .map-area-action-btn--config {
      color: #cbd5e1;
    }
    
    .map-area-action-btn--delete {
      color: #cbd5e1;
    }

    .map-log-list {
      font-family: "JetBrains Mono", "Courier New", monospace;
      font-size: 0.7rem;
      display: grid;
      gap: 6px;
      max-height: 160px;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 12px;
    }

    .map-log-entry {
      color: rgba(148, 163, 184, 0.9);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .map-log-entry time {
      color: rgba(59, 130, 246, 0.8);
    }

    .map-btn {
      border: none;
      border-radius: 5px; /*  Reducido de 6px a 5px */
      padding: 5px 8px; /*  Reducido de 6px 10px a 5px 8px */
      font-size: 0.65rem; /*  Reducido de 0.7rem a 0.65rem */
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 3px; /*  Reducido de 4px a 3px */
      color: #e2e8f0;
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
      white-space: nowrap;
      min-height: 24px; /*  Reducido de 28px a 24px */
      line-height: 1.2;
    }

    .map-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      background: rgba(37, 50, 73, 0.9);
      border-color: rgba(148, 163, 184, 0.5);
    }

    .map-btn:active {
      transform: translateY(0);
    }

    .map-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .map-btn--primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: 1px solid rgba(59, 130, 246, 0.5);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
    }

    .map-btn--primary:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
    }

    .map-btn--accent {
      background: linear-gradient(135deg, #14b8a6, #0d9488);
      color: white;
      border: 1px solid rgba(20, 184, 166, 0.5);
      box-shadow: 0 2px 8px rgba(20, 184, 166, 0.25);
    }

    .map-btn--accent:hover {
      background: linear-gradient(135deg, #0d9488, #0f766e);
      box-shadow: 0 4px 16px rgba(20, 184, 166, 0.4);
    }

    .map-btn--ghost {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #cbd5e1;
    }

    .map-btn--ghost:hover {
      background: rgba(51, 65, 85, 0.8);
      color: #e2e8f0;
    }

    .map-icon-btn {
      background: rgba(30, 41, 59, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 6px;
      color: #e2e8f0;
      padding: 6px 10px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 36px;
      min-height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .map-icon-btn:hover {
      background: rgba(59, 130, 246, 0.25);
      border-color: rgba(59, 130, 246, 0.5);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .map-icon-btn:active {
      transform: translateY(0);
    }

    /*  Tooltips informativos para botones */
    .map-btn-info {
      position: relative;
    }

    .info-icon {
      font-size: 0.65rem;
      opacity: 0; /*  OCULTO por defecto */
      transition: opacity 0.2s ease;
      margin-left: -4px; /*  Reducir espacio */
    }

    .map-btn-info:hover .info-icon {
      opacity: 0.7; /*  Aparecer al hover */
    }

    .map-btn-info::after {
      content: attr(data-tooltip);
      position: absolute;
      top: calc(100% + 8px); /*  CAMBIO: Tooltip ABAJO del botn */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.98);
      color: #e2e8f0;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 500;
      line-height: 1.5;
      white-space: normal;
      max-width: 280px;
      width: max-content;
      text-align: left;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      z-index: 100000;
    }

    .map-btn-info:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(4px); /*  Hacia abajo */
    }

    .map-btn-info::before {
      content: '';
      position: absolute;
      top: calc(100% + 2px); /*  Flecha ARRIBA del tooltip */
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-bottom-color: rgba(15, 23, 42, 0.98); /*  Flecha apuntando hacia arriba */
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 100001;
    }

    .map-btn-info:hover::before {
      opacity: 1;
      transform: translateX(-50%) translateY(4px); /*  Hacia abajo */
    }

    /* Aplicar tooltips tambin a botones de icono */
    .map-icon-btn.map-btn-info {
      position: relative;
    }

    .map-icon-btn.map-btn-info::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.98);
      color: #e2e8f0;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 500;
      line-height: 1.5;
      white-space: normal;
      max-width: 280px;
      width: max-content;
      text-align: left;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      z-index: 100000;
    }

    .map-icon-btn.map-btn-info:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .map-icon-btn.map-btn-info::before {
      content: '';
      position: absolute;
      bottom: calc(100% + 2px);
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(15, 23, 42, 0.98);
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 100001;
    }

    .map-icon-btn.map-btn-info:hover::before {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .map-workspace {
      background: rgba(15, 23, 42, 0.8);
      border-radius: 12px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: var(--shadow-lg);
      overflow: visible;
      width: 100%;
      height: 100%;
      min-height: 0;
      margin: 0;
      box-sizing: border-box;
    }

    .map-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 8px 10px;
      overflow: visible;
      position: relative;
      flex-shrink: 0;
      z-index: 10;
    }

    .map-toolbar-left,
    .map-toolbar-right {
      display: flex;
      align-items: center;
      gap: 6px;
      overflow: visible;
    }

    .map-toolbar-center {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .map-zoom-badge,
    .map-meta-badge {
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.85);
      color: rgba(226, 232, 240, 0.9);
    }

    .map-canvas-stage {
      position: relative;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.7);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.4);
      flex: 1;
      width: 100%;
      min-height: 0;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      z-index: 1;
    }

    .map-canvas {
      width: 100%;
      height: 100%;
      display: block;
      cursor: crosshair;
    }

    .map-hint {
      position: fixed;
      bottom: 16px;
      left: 16px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 0.75rem;
      color: rgba(226, 232, 240, 0.85);
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .map-hint.hidden {
      opacity: 0;
    }

    /*  NUEVO: Tooltip para reas en hover */
    .map-tooltip {
      position: absolute;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(59, 130, 246, 0.5);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.95);
      pointer-events: none;
      transition: opacity 0.15s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      max-width: 280px;
    }

    /*  NUEVO: Permitir clicks cuando el tooltip est fijado */
    .map-tooltip.pinned {
      pointer-events: auto;
      border-color: rgba(251, 191, 36, 0.6); /* Borde amarillo para indicar fijacin */
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    .map-tooltip.hidden {
      opacity: 0;
      display: none;
    }

    .map-tooltip-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 6px;
      color: #60a5fa;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .map-tooltip-category {
      font-size: 0.75rem;
      color: rgba(226, 232, 240, 0.7);
      margin-bottom: 8px;
      padding: 3px 8px;
      background: rgba(59, 130, 246, 0.15);
      border-radius: 4px;
      display: inline-block;
    }

    .map-tooltip-equipos {
      font-size: 0.75rem;
      color: rgba(226, 232, 240, 0.8);
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    .map-tooltip-equipos strong {
      display: block;
      margin-bottom: 4px;
      color: rgba(226, 232, 240, 0.9);
    }

    /*  NUEVO: Minimap para navegacin rpida */
    .map-minimap-container {
      position: absolute;
      bottom: 16px;
      right: 16px;
      width: 200px;
      height: 140px;
      background: rgba(15, 23, 42, 0.95);
      border: 2px solid rgba(59, 130, 246, 0.4);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
      transition: opacity 0.2s ease;
      z-index: 100;
    }

    .map-minimap-container.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .map-minimap-canvas {
      width: 100%;
      height: 100%;
      display: block;
      cursor: pointer;
    }

    .map-minimap-viewport {
      position: absolute;
      border: 2px solid rgba(251, 191, 36, 0.8);
      background: rgba(251, 191, 36, 0.15);
      pointer-events: none;
      box-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
    }

    .map-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px; /*  Reducido de 16px a 12px */
      padding: 12px 16px; /*  Agregado padding para que sea ms compacto */
      background: rgba(15, 23, 42, 0.5); /*  Fondo sutil */
      border-radius: 10px; /*  Bordes redondeados */
    }

    .map-status-text {
      font-size: 0.75rem; /*  Reducido de 0.8rem a 0.75rem */
      color: var(--text-secondary);
    }

    .map-footer-actions {
      display: flex;
      gap: 10px;
    }

    .map-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.82);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 9999;
    }

    .map-modal.hidden {
      display: none;
    }

    .map-modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      width: min(520px, 96vw);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-xl);
    }

    .map-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .map-modal-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .map-modal-body {
      padding: 20px 24px;
      overflow-y: auto;
      display: grid;
      gap: 16px;
    }

    /* Overlay de carga para mapas pesados */
    .map-loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(5, 8, 20, 0.88);
      -webkit-backdrop-filter: blur(3px);
      backdrop-filter: blur(3px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 9998;
    }

    .map-loading-modal {
      width: min(420px, 92vw);
      background: var(--bg-primary);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 30px 70px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .map-loading-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .map-loading-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
    }

    .map-loading-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .map-loading-status {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .map-loading-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      position: relative;
      overflow: hidden;
    }

    .map-loading-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.2s ease;
    }

    .map-loading-percent {
      font-family: 'JetBrains Mono', 'Consolas', monospace;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
      text-align: right;
    }

    .map-loading-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
    }

    @media (max-width: 1180px) {
      .map-shell {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .map-panel {
        order: 2;
      }

      .map-workspace {
        order: 1;
      }
    }

    /*  Media Query para pantallas medianas - Toolbar con wrap */
    @media (max-width: 900px) {
      .map-toolbar {
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px 12px;
      }

      .map-toolbar-left,
      .map-toolbar-right {
        gap: 4px;
      }

      .btn-toolbar {
        padding: 8px 12px;
        font-size: 13px;
      }
    }

    @media (max-width: 720px) {
      .map-toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .map-toolbar-left,
      .map-toolbar-right {
        justify-content: center;
      }

      .map-panel-header {
        flex-direction: column;
        align-items: stretch;
      }

      .map-connection {
        align-items: flex-start;
      }
    }
    
    /* FIN ESTILOS DEL SISTEMA DE MAPAS */
    
    /* 
        ESTILOS APLICADOS A CONFIGURACIN - MISMO DISEO LIMPIO
        */
    
    .config-card {
      background: #3b4558 !important;
      padding: 16px !important;
      border-radius: 4px !important;
      border: none !important;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
    }
    
    .config-card h3 {
      font-weight: 400 !important;
      font-size: 0.95rem !important;
      color: #e2e8f0 !important;
      margin-bottom: 12px !important;
    }
    
    /*  Estilos para rbol Jerrquico */
    .tree-actions {
      display: none; /* No ocupar espacio cuando est oculto */
    }
    
    .tree-node-header:hover .tree-actions {
      display: flex !important;
      gap: 4px;
    }
    
    .tree-node-expandable:hover > .tree-node-header .tree-actions {
      display: flex !important;
      gap: 4px;
    }
    
    /* Hover para mostrar botones en nodos del rbol (INDIVIDUAL) */
    .tree-node-hover:hover > .tree-actions {
      display: flex !important;
      gap: 4px;
    }
    
    /* Evitar activacin en cadena - solo el hover directo */
    .tree-node-hover .tree-actions {
      display: none;
    }
    
    .tree-toggle {
      font-size: 0.9rem;
      font-weight: 700;
    }
    
    .jerarquia-tree button {
      transition: all 0.2s ease;
    }
    
    .jerarquia-tree button:hover {
      transform: scale(1.05);
      filter: brightness(1.1);
    }
    
    /*  Estilos para Modales Personalizados Centrados */
    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .custom-modal {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 24px;
      min-width: 400px;
      max-width: 500px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .custom-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }
    
    .custom-modal-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 0.95rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin-bottom: 20px;
      font-family: inherit;
    }
    
    .custom-modal-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .custom-modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .custom-modal-btn {
      padding: 8px 20px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    /* ============================================================
       ZOOM CONTROLS HORIZONTAL
       ============================================================ */
    .zoom-controls-horizontal {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 12px;
    }

    /* Botones de zoom - Minimalista */
    .zoom-btn-h {
      padding: 6px 10px;
      background: transparent;
      color: var(--text-muted);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      min-width: 32px;
    }

    .zoom-btn-h:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    #zoomLevel {
      font-weight: 600;
      color: var(--text-secondary);
      min-width: 50px;
      text-align: center;
      font-size: 12px;
    }

    #screenResolution {
      font-size: 10px;
      color: var(--text-muted);
      padding: 0 8px;
      border-left: 1px solid var(--border-color);
    }

    /* ============================================================
       MODAL JERARQUA - OVERRIDES
       ============================================================ */
    #modalJerarquia {
      display: none;
    }

    #modalJerarquia .modal-content {
      width: min(1380px, 96vw);
      max-height: 92vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #jerarquiaForm {
      display: none;
    }

    .modal-actions {
      margin-top: 20px;
    }
    
    .custom-modal-btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .custom-modal-btn-primary:hover {
      background: #5558dd;
      transform: translateY(-1px);
    }
    
    .custom-modal-btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .custom-modal-btn-secondary:hover {
      background: var(--border-color);
    }
    
    .custom-modal-message {
      color: var(--text-primary);
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .jerarquia-toolbar {
      display: grid;
      gap: 18px;
      padding: 16px 20px 0 20px;
    }

    .jerarquia-toolbar-top {
      display: grid;
      grid-template-columns: minmax(240px, 1fr) auto;
      gap: 20px;
      align-items: center;
    }

    .jerarquia-toolbar-text {
      color: var(--text-secondary);
      font-size: 0.92rem;
      line-height: 1.5;
    }

    .jerarquia-toolbar-hint {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .jerarquia-toolbar-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }

    .jerarquia-toolbar-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .jerarquia-stat-pill {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      padding: 10px 14px;
      border-radius: 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      font-size: 0.82rem;
      color: var(--text-secondary);
      min-width: 150px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
    }

    .jerarquia-stat-pill .pill-label {
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .jerarquia-stat-pill strong {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1rem;
    }

    .jerarquia-toolbar-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .jerarquia-toolbar-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }

    .jerarquia-search {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      min-width: 250px;
      transition: border-color 0.2s ease;
    }

    .jerarquia-search:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.15);
    }

    .jerarquia-search-icon {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .jerarquia-search-input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 0.9rem;
      outline: none;
    }

    .jerarquia-search-clear {
      border: none;
      background: none;
      color: var(--text-muted);
      font-size: 1rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s ease;
    }

    .jerarquia-search-clear:hover {
      color: var(--primary);
    }

    .jerarquia-search:not(.has-value) .jerarquia-search-clear {
      opacity: 0;
      pointer-events: none;
    }

    .jerarquia-results {
      padding: 0 20px 10px 20px;
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .jerarquia-results-tag {
      text-transform: uppercase;
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .jerarquia-results-highlight {
      font-weight: 600;
      color: var(--primary);
    }

    .jerarquia-tabs-wrapper {
      padding: 0 20px;
    }

    .jerarquia-tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin: 0;
    }

    .jerarquia-tab {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 14px;
      background: var(--bg-tertiary);
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .jerarquia-tab.active {
      border-color: var(--primary);
      box-shadow: 0 8px 24px rgba(56, 189, 248, 0.15);
    }

    .jerarquia-tab .tab-chevron {
      font-size: 1rem;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }

    .jerarquia-tab.active .tab-chevron {
      transform: rotate(90deg);
      color: var(--primary);
    }

    .jerarquia-content {
      margin-top: 10px;
      border-top: 1px solid var(--border-color);
      padding: 20px;
      background: var(--bg-primary);
      border-radius: 16px 16px 0 0;
    }

/* ================================================================
    MEJORAS VISUALES v6.0 - CSS REFACTORIZADO
   ================================================================ */

/* =================================================================
   REFACTORIZACIN DE ESTILOS INLINE
   Este archivo contiene todas las clases CSS creadas para reemplazar
   los estilos inline del HTML principal
   ================================================================= */

/* ============================================================
   BARRA DE PROGRESO DE BACKUP
   ============================================================ */
#backupProgressBar {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 10000;
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  padding: 8px 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  border-bottom: 2px solid var(--primary);
}

.backup-progress-container {
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: 1400px;
  margin: 0 auto;
}

.backup-progress-loading {
  width: 16px;
  height: 16px;
  border-width: 2px;
}

.backup-progress-content {
  flex: 1;
}

.backup-progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.backup-progress-text {
  color: #fff;
  font-size: 0.85rem;
  font-weight: 600;
}

.backup-progress-percent {
  color: var(--primary);
  font-weight: 700;
  font-size: 0.85rem;
}

.backup-progress-bar-bg {
  background: rgba(0,0,0,0.3);
  height: 6px;
  border-radius: 3px;
  overflow: hidden;
}

.backup-progress-bar-fill {
  background: linear-gradient(90deg, var(--primary), #10b981);
  height: 100%;
  width: 0%;
  transition: width 0.3s ease;
  box-shadow: 0 0 10px var(--primary);
}

/* ============================================================
   TOOLBAR - BOTONES Y CONTROLES
   ============================================================ */
/* CTA principal compartido para flujos de inventario (desktop-first) */
.btn-primary-cta {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 14px 26px;
  min-height: 56px;
  border-radius: var(--radius-lg);
  border: 1px solid rgba(255, 255, 255, 0.14);
  background: linear-gradient(135deg, rgba(91, 139, 180, 0.95) 0%, rgba(43, 93, 140, 0.95) 100%);
  color: #f8fafc;
  font-weight: 700;
  font-size: 0.95rem;
  letter-spacing: 0.2px;
  box-shadow: 0 18px 34px rgba(34, 114, 188, 0.35);
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
  text-transform: none;
  text-decoration: none;
  white-space: nowrap;
}

.btn-primary-cta:hover {
  transform: translateY(-1px);
  box-shadow: 0 22px 42px rgba(34, 114, 188, 0.4);
  filter: brightness(1.05);
}

.btn-primary-cta:active {
  transform: translateY(0);
  box-shadow: 0 12px 28px rgba(21, 74, 121, 0.45);
  filter: brightness(0.98);
}

.btn-primary-cta:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
  filter: none;
}

.btn-primary-cta:focus-visible {
  outline: 2px solid rgba(148, 214, 255, 0.85);
  outline-offset: 2px;
}

.btn-primary-cta .btn-icon {
  font-size: 1.2rem;
  line-height: 1;
}

.btn-primary-cta .btn-text {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn-primary-cta .btn-loading {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.btn-primary-cta .spinner-small {
  width: 18px;
  height: 18px;
}

.btn-add-main {
  margin-right: 12px;
}

.toggle-label-custom {
  margin-right: 16px;
}

.btn-quitar-filtros {
  display: none;
  margin-right: 16px;
  padding: 8px 16px;
  font-size: 0.85rem;
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  border: none;
  color: white;
}

.connection-btn-custom {
  margin-left: 4px;
  padding: 8px 12px;
  cursor: default;
}

.search-box-custom {
  max-width: 350px;
  margin-left: auto;
}

/* ============================================================
   PAGINACIN
   ============================================================ */
.pagination-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.pagination-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

.pagination-select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.9rem;
  min-width: 180px;
}

.pagination-info {
  font-size: 0.85rem;
  color: var(--text-secondary);
  opacity: 0.8;
  font-style: italic;
}

.page-numbers-container {
  display: flex;
  gap: 8px;
  align-items: center;
}

/* ============================================================
   VISTAS - LISTA Y TARJETAS
   ============================================================ */
.list-view-hidden {
  display: none;
}

/* ============================================================
   JERARQUA - TREE HEADER
   ============================================================ */
.tree-header-custom {
  font-size: 0.85rem;
  line-height: 1.6;
}

.tree-header-title {
  color: var(--primary);
}

/* ============================================================
   JERARQUA - BUSCADOR
   ============================================================ */
.jerarquia-search-container {
  padding: 16px;
  background: var(--bg-secondary);
  border-bottom: 2px solid var(--primary-color);
}

.jerarquia-search-wrapper {
  position: relative;
}

.jerarquia-search-input {
  width: 100%;
  padding: 12px 40px 12px 56px;
  font-size: 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  background: var(--bg-primary);
  color: var(--text-primary);
}

.jerarquia-search-clear {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  font-size: 1.2rem;
  color: var(--gray-500);
  cursor: pointer;
  padding: 4px 8px;
}

.jerarquia-search-results {
  margin-top: 8px;
  max-height: 300px;
  overflow-y: auto;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: none;
}

/* ============================================================
   JERARQUA - CONTROLES Y FILTROS
   ============================================================ */
.jerarquia-controls {
  padding: 12px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.toggle-tree-btn {
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.filtros-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  flex-wrap: wrap;
}

.filtros-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

.filtro-select {
  max-width: 200px;
}

.filtro-select-hidden {
  max-width: 180px;
  display: none;
}

.btn-limpiar-filtros {
  padding: 6px 12px;
  font-size: 0.85rem;
  display: none;
}

.jerarquia-counter {
  font-size: 0.85rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

/* ============================================================
   JERARQUA - BREADCRUMB
   ============================================================ */
.filtros-breadcrumb {
  padding: 8px 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-bottom: 1px solid var(--border-color);
  display: none;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  font-size: 0.85rem;
  color: white;
}

.breadcrumb-label {
  font-weight: 600;
}

.breadcrumb-path {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

/* ============================================================
   MAPAS - HEADERS
   ============================================================ */
.map-section-header-custom h3 {
  line-height: 28px;
}

.map-new-btn {
  white-space: nowrap;
}

.map-controls-wrapper {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}

/* ============================================================
   MAPAS - BUSCADOR Y FILTROS
   ============================================================ */
.map-search-container {
  padding: 8px 10px;
  background: var(--bg-secondary);
  border-radius: 6px;
  margin-bottom: 6px;
}

.map-search-input {
  width: 100%;
  padding: 6px 10px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.75rem;
  outline: none;
}

.map-category-filters {
  padding: 6px 10px;
  background: var(--bg-secondary);
  border-radius: 6px;
  margin-bottom: 8px;
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  align-items: center;
}

.map-category-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  font-weight: 600;
}

.map-category-filter-btn {
  padding: 3px 8px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.2s;
}

.map-category-filter-btn[data-category="all"] {
  background: var(--primary);
  color: white;
}

.map-category-filter-btn.active {
  background: var(--primary);
  color: white;
}

/* ============================================================
   UTILIDADES GENERALES
   ============================================================ */
.flex-center {
  display: flex;
  align-items: center;
}

.flex-between {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.gap-sm {
  gap: 6px;
}

.gap-md {
  gap: 12px;
}

.text-small {
  font-size: 0.85rem;
}

.text-tiny {
  font-size: 0.75rem;
}

.mb-sm {
  margin-bottom: 4px;
}

.mr-sm {
  margin-right: 8px;
}

.mr-md {
  margin-right: 16px;
}

/* ============================================================
   SECCIN DE MAPAS - ICONOS Y ELEMENTOS ADICIONALES
   ============================================================ */
.info-icon-small {
  font-size: 0.65rem;
}

.map-selection-badge {
  display: none;
  background: #10b981;
  color: white;
}

.map-btn-batch-hidden {
  display: none;
}

/* ============================================================
   ESTADSTICAS - TAB STATS
   ============================================================ */
.stats-title {
  margin-bottom: 24px;
  color: var(--primary);
}

.stats-details {
  margin-top: 30px;
}

/* ============================================================
   VALORES - TAB VALORES
   ============================================================ */
.valores-title {
  margin-bottom: 24px;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.valores-resumen {
  background: var(--bg-secondary);
  color: var(--text-primary);
  padding: 24px;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
}

.valores-tabs-container {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 8px;
  flex-wrap: wrap;
}

.tab-valores {
  flex: 1;
  min-width: 150px;
  padding: 12px 16px;
  border: none;
  border-radius: 8px 8px 0 0;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.9rem;
  text-align: center;
}

.tab-valores:not(.active) {
  background: var(--bg-primary);
  color: var(--text-secondary);
}

.tab-valores.active {
  background: var(--primary);
  color: white;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
}

/* ============================================================
   CONFIGURACIN - TAB CONFIG
   ============================================================ */
.config-title {
  margin-bottom: 20px;
  color: var(--primary);
}

.config-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 6px;
}

.config-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  padding: 16px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  border-radius: 10px;
  transition: all 0.2s;
  color: white;
  font-weight: 600;
  font-size: 1rem;
}

.config-content-hidden {
  display: none;
  padding-top: 16px;
}

.config-buttons-grid {
  display: grid;
  gap: 10px;
}

.config-btn-full {
  width: 100%;
  padding: 12px;
}

.config-btn-secondary {
  background: var(--secondary);
  color: white;
}

.config-btn-danger {
  background: var(--danger);
  color: white;
}

/* ============================================================
   BACKUP - PANEL DE ESTADO Y ESTRUCTURA
   ============================================================ */
.backup-structure-info {
  margin-bottom: 16px;
  padding: 12px;
  background: rgba(0,0,0,0.15);
  border-radius: 6px;
  font-family: monospace;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.backup-structure-title {
  color: var(--primary);
}

.backup-structure-content {
  margin-left: 8px;
  margin-top: 6px;
  line-height: 1.6;
}

.backup-file-name {
  color: var(--success);
}

.backup-file-hint {
  color: var(--warning);
}

.backup-file-hint-special {
  color: var(--info);
}

.backup-manual-update {
  margin-top: 10px;
  padding: 10px;
  background: rgba(245, 158, 11, 0.1);
  border-left: 3px solid var(--warning);
  border-radius: 4px;
}

.backup-manual-title {
  color: var(--warning);
}

.backup-manual-text {
  line-height: 1.6;
}

.backup-status-panel {
  margin-bottom: 16px;
  padding: 14px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.backup-status-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.backup-status-icon {
  font-size: 1.3rem;
}

.backup-status-content {
  flex: 1;
}

.backup-status-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.9rem;
}

.backup-status-text {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin-top: 2px;
}

.backup-metrics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}

.backup-metric-card {
  background: rgba(0,0,0,0.15);
  padding: 8px;
  border-radius: 6px;
}

.backup-metric-label {
  color: var(--text-secondary);
  font-size: 0.7rem;
  margin-bottom: 3px;
}

.backup-metric-value {
  color: var(--text-primary);
  font-weight: 600;
  font-size: 0.85rem;
}

/* ============================================================
   CONFIGURACIN - SECCIONES DETALLADAS
   ============================================================ */
.config-section-content {
  display: none;
  padding-top: 16px;
}

.config-buttons-container {
  display: grid;
  gap: 10px;
}

.config-btn-mobile {
  width: 100%;
  background: var(--secondary);
  color: white;
  padding: 12px;
}

.config-btn-pdf {
  width: 100%;
  padding: 12px;
  background: var(--danger);
  color: white;
}

.backup-structure {
  margin-bottom: 16px;
  padding: 12px;
  background: rgba(0,0,0,0.15);
  border-radius: 6px;
  font-family: monospace;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.backup-structure-path {
  margin-left: 8px;
  margin-top: 6px;
  line-height: 1.6;
}

.backup-manual-guide {
  margin-top: 10px;
  padding: 10px;
  background: rgba(245, 158, 11, 0.1);
  border-left: 3px solid var(--warning);
  border-radius: 4px;
}

.backup-guide-text {
  line-height: 1.6;
}

.backup-status-panel-container {
  margin-bottom: 16px;
  padding: 14px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.backup-pending-changes {
  display: none;
  margin-top: 10px;
  padding: 8px;
  background: rgba(245, 158, 11, 0.15);
  border-radius: 6px;
  border-left: 3px solid var(--warning);
}

.config-divider {
  border-top: 1px solid var(--border-color);
  padding-top: 10px;
  margin-top: 6px;
}

.config-divider-margin {
  margin-top: 10px;
}

.config-small-text {
  color: var(--text-secondary);
  font-size: 0.75rem;
  display: block;
  margin-bottom: 10px;
}

.config-small-text-line-height {
  line-height: 1.5;
}

.config-btn-warning {
  width: 100%;
  padding: 12px;
  background: var(--warning);
  color: white;
}

.config-btn-info {
  width: 100%;
  padding: 12px;
  background: var(--info);
  color: white;
  margin-top: 8px;
}

.config-btn-gradient {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.config-success-note {
  margin-top: 12px;
  padding: 12px;
  background: rgba(16, 185, 129, 0.1);
  border-radius: 6px;
  border-left: 4px solid var(--success);
}

.config-inline-code {
  background: rgba(0,0,0,0.2);
  padding: 2px 4px;
  border-radius: 3px;
}

/* ============================================================
   JERARQUA CONFIG - SECCIN ESPECIAL
   ============================================================ */
.jerarquia-config-container {
  margin-top: 4px;
  padding: 12px;
  background: var(--bg-secondary);
  border-radius: 8px;
  border: 1px solid var(--border-color);
  max-width: 600px;
}

/* Variante para pestaa Jerarqua (ancho completo) */
.jerarquia-config-container.full-width {
  max-width: 100%;
}

.jerarquia-config-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0;
  cursor: pointer;
  padding: 6px;
  background: rgba(0,0,0,0.1);
  border-radius: 4px;
  -webkit-user-select: none;
  user-select: none;
}

/* Variante sin hover para pestaa Jerarqua */
.jerarquia-config-header.no-hover {
  cursor: default;
  background: var(--bg-secondary);
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 8px;
}

.jerarquia-config-header-content {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Variante con descripcin */
.jerarquia-config-header-content.with-description {
  flex-direction: column;
  align-items: flex-start;
}

.jerarquia-config-title {
  color: var(--primary);
  margin: 0;
  font-size: 1.3rem;
  font-weight: 600;
}

.jerarquia-config-title.large {
  font-size: 1.5rem;
}

.jerarquia-description {
  margin: 8px 0 0 0;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.jerarquia-save-btn {
  padding: 10px 24px;
  font-weight: 600;
  display: none;
}

.jerarquia-save-container {
  text-align: right;
  margin-top: 8px;
}

.jerarquia-tree-container {
  background: var(--bg-primary);
  padding: 12px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  min-height: 400px;
  margin-top: 6px;
}

.visual-v2-wrapper {
  margin-top: 6px;
  border-radius: 10px;
  border: 1px solid rgba(90, 120, 160, 0.3);
  background: linear-gradient(135deg, rgba(21, 25, 33, 0.96), rgba(27, 32, 41, 0.96));
  position: relative;
  min-height: 480px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  overflow: hidden;
}

.visual-v2-wrapper.is-hidden {
  display: none;
}

.visual-v2-shell {
  display: flex;
  flex-direction: column;
  height: 100%;
  color: #eaf2ff;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.visual-v2-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 24px;
  background: rgba(24, 28, 36, 0.9);
  border-bottom: 1px solid rgba(74, 128, 176, 0.3);
  -webkit-backdrop-filter: blur(12px);
  backdrop-filter: blur(12px);
}

.visual-v2-toolbar-left {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
  gap: 16px;
  flex: 1;
}

.visual-v2-heading {
  display: flex;
  align-items: center;
  gap: 14px;
}

.visual-v2-heading-icon {
  font-size: 1.8rem;
  line-height: 1;
  filter: drop-shadow(0 0 8px rgba(91, 139, 180, 0.45));
}

.visual-v2-title {
  margin: 0;
  font-size: 1.3rem;
  letter-spacing: 0.4px;
  color: #8eb6ff;
  text-transform: uppercase;
}

.visual-v2-subtitle {
  margin: 4px 0 0;
  font-size: 0.85rem;
  color: rgba(208, 224, 255, 0.75);
}

.visual-v2-toolbar-actions {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.visual-v2-btn {
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  background: rgba(57, 90, 140, 0.35);
  color: #eaf2ff;
  font-weight: 600;
  font-size: 0.85rem;
  cursor: pointer;
  transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
  min-width: 48px;
}

.visual-v2-btn:hover {
  transform: translateY(-2px);
  background: rgba(82, 122, 186, 0.55);
  box-shadow: 0 8px 18px rgba(82, 122, 186, 0.35);
}

.visual-v2-btn:active {
  transform: translateY(0);
}

.visual-v2-zoom-indicator {
  min-width: 64px;
  text-align: center;
  font-family: 'Fira Code', 'Courier New', monospace;
  font-size: 0.9rem;
  padding: 6px 10px;
  border-radius: 8px;
  background: rgba(33, 39, 55, 0.9);
  border: 1px solid rgba(91, 139, 180, 0.45);
}

.visual-v2-toolbar-divider {
  width: 1px;
  height: 28px;
  background: linear-gradient(180deg, rgba(91, 139, 180, 0) 0%, rgba(91, 139, 180, 0.45) 50%, rgba(91, 139, 180, 0) 100%);
}

.visual-v2-statusbar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  background: rgba(24, 28, 36, 0.65);
  border-bottom: 1px solid rgba(74, 128, 176, 0.25);
  font-size: 0.85rem;
  justify-content: space-between;
  flex-wrap: wrap;
}

.visual-v2-status-label {
  color: rgba(208, 224, 255, 0.65);
}

.visual-v2-status-value {
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(91, 139, 180, 0.18);
  color: #a9c7ff;
  font-weight: 600;
}

.visual-v2-status-group {
  display: flex;
  align-items: center;
  gap: 6px;
}

.visual-v2-search-status {
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(91, 139, 180, 0.12);
  color: #c6dcff;
  font-weight: 600;
  font-size: 0.8rem;
}

.visual-v2-tree-scroll {
  flex: 1;
  overflow: auto;
  padding: 24px 32px 32px;
  position: relative;
}

.visual-v2-tree-container {
  transform-origin: top center;
  transition: transform 0.25s ease;
  min-width: 780px;
  color: #f0f4ff;
  display: flex;
  flex-direction: column;
  gap: 30px;
}

/* 🔧 SECCIÓN DE ELEMENTOS GENÉRICOS */
.visual-v2-tree-container .tree-section {
  width: 100%;
}

.visual-v2-tree-container .tree-section-generic {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(5, 150, 105, 0.05) 100%);
  border: 2px solid rgba(16, 185, 129, 0.25);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 16px rgba(16, 185, 129, 0.15);
}

.visual-v2-tree-container .tree-section-organizational {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(37, 99, 235, 0.05) 100%);
  border: 2px solid rgba(59, 130, 246, 0.25);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
}

.visual-v2-tree-container .tree-section-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  margin-bottom: 16px;
  border-left: 4px solid rgba(16, 185, 129, 0.5);
}

.visual-v2-tree-container .tree-section-icon {
  font-size: 1.5rem;
  line-height: 1;
}

.visual-v2-tree-container .tree-section-title {
  font-size: 1rem;
  font-weight: 700;
  color: #10b981;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.visual-v2-tree-container .tree-section-badge {
  margin-left: auto;
  padding: 4px 12px;
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid rgba(16, 185, 129, 0.4);
  border-radius: 12px;
  color: #10b981;
  font-size: 0.85rem;
  font-weight: 700;
}

.visual-v2-tree-container .tree-container {
  padding: 20px;
  width: fit-content;
  min-width: 720px;
  overflow-x: visible;
}

.visual-v2-search-wrapper {
  position: relative;
  flex: 1 1 260px;
  max-width: 540px;
}

.visual-v2-wrapper .jerarquia-search-suggestions {
  z-index: 1500;
}

.visual-v2-tree-container .tree-node {
  position: relative;
  margin: 6px 0;
}

/* 🔧 Nodos genéricos con estilo especial */
.visual-v2-tree-container .tree-node.node-generic .node-content {
  border-left-color: rgba(16, 185, 129, 0.5);
  background: rgba(16, 185, 129, 0.08);
}

.visual-v2-tree-container .tree-node.node-generic .node-content:hover {
  background: rgba(16, 185, 129, 0.15);
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
}

.visual-v2-tree-container .node-content {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 8px 14px;
  padding-right: 8px;
  min-width: 320px;
  max-width: 100%;
  width: fit-content;
  background: rgba(30, 41, 59, 0.5);
  color: #e2e8f0;
  border-radius: 5px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  cursor: pointer;
  transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
  position: relative;
  z-index: 2;
  height: 32px;
  font-size: 0.8rem;
  border-left: 2px solid rgba(59, 130, 246, 0.3);
}

/* Mantener hover activo cuando el mouse está sobre los botones o el contenido */
.visual-v2-tree-container .node-content:hover {
  transform: translateX(4px);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
  background: rgba(51, 65, 85, 0.6);
  padding-right: 8px;
}

.visual-v2-tree-container .node-content.search-highlight {
  animation: visual-v2-pulse 1.5s ease-in-out infinite;
  box-shadow: 0 0 20px rgba(251, 191, 36, 0.6) !important;
  border: 2px solid #fbbf24 !important;
}

.visual-v2-tree-container .node-content.search-match {
  border: 2px solid #10b981 !important;
}

@keyframes visual-v2-pulse {
  0%,
  100% {
    box-shadow: 0 0 20px rgba(251, 191, 36, 0.6) !important;
  }
  50% {
    box-shadow: 0 0 30px rgba(251, 191, 36, 0.9) !important;
  }
}

.visual-v2-tree-container .node-actions {
  display: flex;
  gap: 4px;
  margin-left: auto;
  padding-left: 8px;
  flex-shrink: 0;
  pointer-events: none;
  opacity: 0;
  z-index: 100;
  position: relative;
  transition: opacity 0.2s ease;
}

/* Mostrar botones al hacer hover sobre el contenido O sobre los botones mismos */
.visual-v2-tree-container .node-content:hover .node-actions,
.visual-v2-tree-container .node-actions:hover {
  opacity: 1;
  pointer-events: auto;
}

/* 🔥 NUEVO: Indicadores de estado de nodos */
.visual-v2-tree-container .node-status-indicators {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-left: 8px;
  flex-shrink: 0;
}

.visual-v2-tree-container .node-status-badge {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.65rem;
  font-weight: 600;
  line-height: 1;
  white-space: nowrap;
}

.visual-v2-tree-container .node-status-badge--map {
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgba(34, 197, 94, 0.3);
  color: #4ade80;
}

.visual-v2-tree-container .node-status-badge--area {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  color: #60a5fa;
}

.visual-v2-tree-container .node-status-badge--marker {
  background: rgba(251, 146, 60, 0.1);
  border: 1px solid rgba(251, 146, 60, 0.3);
  color: #fb923c;
}

/* 🔧 Badge para áreas genéricas */
.visual-v2-tree-container .node-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.65rem;
  font-weight: 700;
  line-height: 1;
  white-space: nowrap;
  margin-left: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.visual-v2-tree-container .node-badge-generic {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.15) 100%);
  border: 1px solid rgba(16, 185, 129, 0.5);
  color: #10b981;
  box-shadow: 0 1px 3px rgba(16, 185, 129, 0.2);
  animation: pulseGeneric 2s ease-in-out infinite;
}

@keyframes pulseGeneric {
  0%, 100% {
    box-shadow: 0 1px 3px rgba(16, 185, 129, 0.2);
  }
  50% {
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
  }
}

.visual-v2-tree-container .node-actions .node-btn {
  padding: 4px 8px;
  background: rgba(59, 130, 246, 0.15);
  border: 1px solid rgba(59, 130, 246, 0.4);
  border-radius: 4px;
  color: #60a5fa;
  font-size: 0.7em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  line-height: 1.2;
  pointer-events: auto;
  z-index: 100;
  position: relative;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.visual-v2-tree-container .node-actions .node-btn:hover {
  background: rgba(59, 130, 246, 0.3);
  border-color: rgba(59, 130, 246, 0.6);
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
}

.visual-v2-tree-container .node-btn-add {
  background: rgba(16, 185, 129, 0.2);
  border-color: rgba(16, 185, 129, 0.5);
  color: #10b981;
}

.visual-v2-tree-container .node-btn-add:hover {
  background: rgba(16, 185, 129, 0.35);
  border-color: rgba(16, 185, 129, 0.7);
  box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
}

.visual-v2-tree-container .node-btn-edit {
  background: rgba(251, 146, 60, 0.2);
  border-color: rgba(251, 146, 60, 0.5);
  color: #fb923c;
}

.visual-v2-tree-container .node-btn-edit:hover {
  background: rgba(251, 146, 60, 0.35);
  border-color: rgba(251, 146, 60, 0.7);
  box-shadow: 0 2px 6px rgba(251, 146, 60, 0.4);
}

.visual-v2-tree-container .node-btn-edit:hover {
  background: rgba(184, 146, 107, 0.65);
  border-color: rgba(184, 146, 107, 0.7);
}

.visual-v2-tree-container .node-btn-delete {
  background: rgba(184, 107, 107, 0.4);
  border-color: rgba(184, 107, 107, 0.5);
}

.visual-v2-tree-container .node-btn-delete:hover {
  background: rgba(184, 107, 107, 0.65);
  border-color: rgba(184, 107, 107, 0.7);
}

.visual-v2-tree-container .node-btn-move {
  background: rgba(91, 139, 180, 0.3);
  padding: 2px 5px;
  font-size: 0.8em;
}

.visual-v2-tree-container .node-btn-move:hover {
  background: rgba(91, 139, 180, 0.5);
}

/* === REPUESTOS EN NODOS DEL ÁRBOL === */
.node-repuestos-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 8px 0;
  margin-left: 20px;
  border-left: 2px solid rgba(91, 139, 180, 0.3);
}

.node-repuesto-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: rgba(96, 165, 250, 0.08);
  border-left: 3px solid rgba(96, 165, 250, 0.6);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
  max-width: 500px;
}

.node-repuesto-item:hover {
  background: rgba(96, 165, 250, 0.15);
  border-left-color: rgba(96, 165, 250, 0.8);
  transform: translateX(4px);
  box-shadow: 0 2px 8px rgba(96, 165, 250, 0.3);
}

.node-repuesto-item .repuesto-icon {
  font-size: 1rem;
  flex-shrink: 0;
}

.node-repuesto-item .repuesto-nombre {
  flex: 1;
  color: #60a5fa;
  font-weight: 400;
  font-style: italic;
  display: flex;
  align-items: center;
  gap: 6px;
  text-shadow: 0 0 8px rgba(96, 165, 250, 0.3);
}

.node-repuesto-item .repuesto-badges {
  display: flex;
  align-items: center;
  gap: 8px;
}

.node-repuesto-item .repuesto-cantidad {
  font-size: 0.85rem;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: 600;
  white-space: nowrap;
}

.node-repuesto-item .repuesto-cantidad.status-ok {
  background: rgba(46, 204, 113, 0.2);
  color: #2ecc71;
}

.node-repuesto-item .repuesto-cantidad.status-low {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

.instancia-badge-small {
  font-size: 0.75rem;
  padding: 2px 6px;
  background: rgba(91, 139, 180, 0.3);
  color: #5b8bb4;
  border-radius: 8px;
  font-weight: 600;
}

.instancia-badge-small-gray {
  font-size: 0.75rem;
  padding: 2px 6px;
  background: rgba(128, 128, 128, 0.2);
  color: #888;
  border-radius: 8px;
  font-weight: 500;
}

.instancia-badge-correlativo {
  font-size: 0.75rem;
  padding: 2px 7px;
  background: rgba(34, 34, 34, 0.9);
  color: #ffffff;
  border-radius: 10px;
  font-weight: 700;
  font-family: monospace;
  margin-left: 4px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.marcador-badge {
  font-size: 0.9rem;
  opacity: 1;
  transition: transform 0.2s ease;
}

.marcador-badge-empty {
  font-size: 0.9rem;
  opacity: 0.3;
}

.node-repuesto-item:hover .marcador-badge {
  transform: scale(1.2);
}

/* Estilos para lista de repuestos en modal */
.repuesto-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: rgba(30, 34, 41, 0.4);
  border-radius: 6px;
  margin-bottom: 6px;
  transition: all 0.2s ease;
}

.repuesto-item:hover {
  background: rgba(91, 139, 180, 0.2);
}

.repuesto-item .repuesto-actions {
  display: flex;
  gap: 6px;
  margin-left: auto;
}

.repuesto-item .btn-repuesto-edit,
.repuesto-item .btn-repuesto-delete {
  padding: 4px 8px;
  background: rgba(91, 139, 180, 0.3);
  border: 1px solid rgba(91, 139, 180, 0.5);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.repuesto-item .btn-repuesto-delete {
  background: rgba(231, 76, 60, 0.3);
  border-color: rgba(231, 76, 60, 0.5);
}

.repuesto-item .btn-repuesto-edit:hover {
  background: rgba(91, 139, 180, 0.5);
  transform: scale(1.1);
}

.repuesto-item .btn-repuesto-delete:hover {
  background: rgba(231, 76, 60, 0.5);
  transform: scale(1.1);
}

.instancia-badge {
  font-size: 0.8rem;
  padding: 2px 8px;
  background: rgba(52, 152, 219, 0.3);
  color: #3498db;
  border-radius: 10px;
  font-weight: 600;
  margin-left: 4px;
}

.visual-v2-tree-container .tree-children {
  margin-left: 60px;
  position: relative;
  padding-top: 0;
}

.visual-v2-tree-container .drag-handle {
  font-size: 1em;
  color: rgba(255, 255, 255, 0.95);
  cursor: pointer;
  margin-right: 4px;
  transition: all 0.2s ease;
  -webkit-user-select: none;
  user-select: none;
}

.visual-v2-tree-container .drag-handle:hover {
  transform: scale(1.1);
}

.visual-v2-tree-container .drag-handle:active {
  cursor: grabbing;
  transform: scale(1.15);
}

.visual-v2-tree-container .dragging .node-content {
  opacity: 0.7;
  transform: scale(0.98);
}

.visual-v2-tree-container .drop-target {
  outline: 2px dashed rgba(91, 139, 180, 0.6);
  outline-offset: 6px;
}

.visual-v2-tree-container .node-id,
.visual-v2-tree-container .node-level {
  font-size: 0.75em;
  opacity: 0.9;
  flex-shrink: 0;
  padding: 2px 6px;
  background: rgba(0, 0, 0, 0.15);
  border-radius: 3px;
  white-space: nowrap;
}

.visual-v2-tree-container .node-level {
  font-size: 0.7em;
  opacity: 0.8;
}

.visual-v2-tree-container .node-name {
  font-size: 0.85em;
  font-weight: 600;
  flex: 0 1 auto;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

.visual-v2-tree-container .node-toggle {
  font-size: 1em;
  color: rgba(255, 255, 255, 0.9);
  cursor: pointer;
  margin-right: 4px;
  width: 16px;
  text-align: center;
  transition: all 0.2s ease;
  -webkit-user-select: none;
  user-select: none;
  flex-shrink: 0;
}

.visual-v2-tree-container .node-toggle:hover {
  color: #ffffff;
  transform: scale(1.2);
}

.visual-v2-tree-container .node-toggle.collapsed {
  transform: rotate(0deg);
}

.visual-v2-tree-container .node-toggle.expanded {
  transform: rotate(90deg);
}

/* 📦 Toggle de repuestos a la derecha del nombre */
.visual-v2-tree-container .node-repuestos-toggle {
  font-size: 0.9em;
  color: rgba(91, 139, 180, 0.8);
  cursor: pointer;
  margin-left: 8px;
  margin-right: 8px;
  padding: 2px 6px;
  border-radius: 4px;
  background: rgba(91, 139, 180, 0.1);
  transition: all 0.2s ease;
  -webkit-user-select: none;
  user-select: none;
  flex-shrink: 0;
}

.visual-v2-tree-container .node-repuestos-toggle:hover {
  color: #5b8bb4;
  background: rgba(91, 139, 180, 0.25);
  transform: scale(1.1);
}

.visual-v2-tree-container .node-repuestos-toggle.collapsed {
  opacity: 0.6;
}

.visual-v2-tree-container .node-repuestos-toggle.expanded {
  opacity: 1;
}

.visual-v2-tree-container > .tree-node > .tree-children::before,
.visual-v2-tree-container .tree-children::before,
.visual-v2-tree-container .tree-children > .tree-node::before,
.visual-v2-tree-container .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  opacity: 1;
  z-index: 1;
}

.visual-v2-tree-container > .tree-node > .tree-children::before {
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container > .tree-node > .tree-children > .tree-node::before {
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container > .tree-node > .tree-children > .tree-node::after {
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children::before {
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node::before {
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node::after {
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

/* PASO 5: Conectar SUB-SISTEMA con SECCIONES */
.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* PASO 6: Conectar SECCIÓN con SUB-SECCIONES */
.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.visual-v2-tree-container .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

.visual-v2-export {
  background: #1a1d23;
  padding: 30px;
}

.visual-v2-empty {
  padding: 40px;
  text-align: center;
  color: rgba(208, 224, 255, 0.6);
}

.jerarquia-tree-sap {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 13px;
  line-height: 1.4;
}

.sap-node {
  margin-bottom: 2px;
}

.sap-node-empresa {
  background: var(--bg-secondary);
  border-left: 3px solid #0070f3;
  padding: 8px 12px;
  border-radius: 4px;
  margin-bottom: 12px;
}

.sap-node-content {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 8px;
  border-radius: 3px;
  transition: background 0.15s;
  cursor: pointer;
}

.sap-node-content:hover {
  background: rgba(0,0,0,0.2);
}

.sap-node-drag-handle {
  cursor: grab;
  color: var(--text-muted);
  font-size: 16px;
  line-height: 1;
  padding: 0 4px;
  -webkit-user-select: none;
  user-select: none;
}

.sap-node-drag-handle:hover {
  color: var(--primary);
}

.sap-node-drag-handle:active {
  cursor: grabbing;
}

.sap-node.dragging {
  opacity: 0.5;
  cursor: move;
}

.sap-node.drag-over > .sap-node-content {
  background: rgba(46, 204, 113, 0.15);
  border: 2px dashed var(--success);
  border-radius: 4px;
}

/* Línea de inserción visual */
.sap-drop-indicator {
  position: absolute;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), var(--success));
  box-shadow: 0 0 8px rgba(52, 152, 219, 0.6);
  z-index: 1000;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s ease;
}

.sap-drop-indicator.active {
  opacity: 1;
}

.sap-drop-indicator::before {
  content: '';
  position: absolute;
  left: 0;
  top: -3px;
  width: 9px;
  height: 9px;
  background: var(--primary);
  border-radius: 50%;
  box-shadow: 0 0 6px rgba(52, 152, 219, 0.8);
}

/* Cursores personalizados según validez */
.sap-node.drag-valid {
  cursor: copy !important;
}

.sap-node.drag-invalid {
  cursor: no-drop !important;
}

.sap-node.dragging * {
  cursor: grabbing !important;
}

/* Highlight verde para contenedores válidos durante drag */
.sap-node.valid-drop-target {
  background: rgba(46, 204, 113, 0.12) !important;
  border: 2px solid rgba(46, 204, 113, 0.5) !important;
  border-radius: 6px;
  box-shadow: 0 0 12px rgba(46, 204, 113, 0.3);
  transition: all 0.2s ease;
}

.sap-node.valid-drop-target > .sap-node-content {
  background: rgba(46, 204, 113, 0.08);
}

/* Indicador visual de "drop zone" */
.sap-node.valid-drop-target::after {
  content: '✓ Soltar aquí';
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--success);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  opacity: 0.9;
  pointer-events: none;
  z-index: 10;
}

.sap-node-expand {
  cursor: pointer;
  width: 16px;
  text-align: center;
  font-size: 12px;
  font-weight: bold;
  color: #4a90a4;
  -webkit-user-select: none;
  user-select: none;
}

.sap-node-icon {
  font-size: 14px;
  width: 18px;
  text-align: center;
}

.sap-node-id {
  font-family: 'Courier New', monospace;
  font-size: 11px;
  font-weight: 600;
  color: #1a2d35;
  background: #a8c7d0;
  padding: 3px 8px;
  border-radius: 2px;
  min-width: 60px;
  text-align: center;
  border: 1px solid #7ea8b5;
}

.sap-node-name {
  flex: 1;
  color: var(--text-primary);
  font-weight: 500;
  cursor: pointer;
  -webkit-user-select: none;
  user-select: none;
  transition: color 0.2s;
}

.sap-node-name:hover {
  color: var(--primary);
}

.sap-node-part-number {
  font-family: 'Courier New', monospace;
  font-size: 11px;
  font-weight: 600;
  color: #4a5c2d;
  background: #dfe6b8;
  padding: 3px 8px;
  border-radius: 2px;
  margin-left: 8px;
  border: 1px solid #c5d19e;
}

.sap-node-actions {
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.2s;
}

.sap-node-content:hover .sap-node-actions {
  opacity: 1;
}

.sap-btn {
  background: none;
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  padding: 3px 8px;
  border-radius: 3px;
  cursor: pointer;
  font-family: 'Courier New', monospace;
  font-size: 10px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  transition: all 0.15s;
}

.sap-btn:hover {
  background: var(--bg-secondary);
  border-color: var(--text-secondary);
}

.sap-btn-edit {
  border-color: var(--info);
  color: var(--info);
}

.sap-btn-edit:hover {
  background: var(--info);
  color: white;
}

.sap-btn-delete {
  border-color: var(--danger);
  color: var(--danger);
}

.sap-btn-delete:hover {
  background: var(--danger);
  color: white;
}

.sap-btn-add {
  border-color: var(--success);
  color: var(--success);
  font-size: 12px;
}

.sap-btn-add:hover {
  background: var(--success);
  color: white;
}

/* BOTONES UNDO/REDO - Flotantes en cada pestaña */
.undo-redo-controls {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  gap: 8px;
  z-index: 999;
  opacity: 0.95;
}

.undo-redo-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
  position: relative;
}

.undo-redo-btn:hover:not(:disabled) {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.undo-redo-btn:active:not(:disabled) {
  transform: translateY(-1px) scale(0.98);
}

.undo-redo-btn:disabled {
  background: linear-gradient(135deg, #ccc 0%, #999 100%);
  cursor: not-allowed;
  opacity: 0.5;
}

.undo-redo-btn::before {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  margin-bottom: 8px;
}

.undo-redo-btn:hover::before {
  opacity: 1;
}

.undo-btn {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.redo-btn {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.sap-btn-subnivel {
  border-color: var(--warning);
  color: var(--warning);
  font-size: 10px;
}

.sap-btn-subnivel:hover {
  background: var(--warning);
  color: white;
}

.sap-children {
  margin-left: 24px;
  border-left: 1px dashed var(--border-color);
  padding-left: 8px;
  margin-top: 2px;
}

#jerarquiaTreeContainer:not(.palette-visual) .sap-node-empresa {
  margin-bottom: 16px;
  position: relative;
  z-index: 2;
}

#jerarquiaTreeContainer:not(.palette-visual) .sap-node-empresa + .sap-node {
  margin-top: 12px;
}

.sap-add-root {
  margin-top: 12px;
  padding-left: 24px;
}

/* ============================================================
   LISTAS CONFIG - SECCIN DE LISTAS DESPLEGABLES
   ============================================================ */
.listas-config-container {
  margin-top: 24px;
  padding: 24px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border: 2px solid var(--border-color);
}

.listas-config-description {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin-bottom: 12px;
}

.listas-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 12px;
}

.lista-card {
  background: var(--bg-secondary);
  padding: 12px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
}

.lista-card-info {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.jerarquia-note-title {
  display: flex;
  align-items: center;
  gap: 8px;
}

.jerarquia-note-text {
  margin: 0;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.jerarquia-note-list {
  margin: 0;
  padding-left: 18px;
  color: var(--text-secondary);
  font-size: 0.85rem;
  line-height: 1.4;
}

.jerarquia-note-tip {
  border: 1px dashed var(--border-color);
  border-radius: 6px;
  padding: 12px;
  background: var(--bg-secondary);
  color: var(--text-muted);
  font-size: 0.85rem;
}

.lista-title {
  color: var(--primary);
  margin-bottom: 8px;
  font-size: 0.85rem;
  font-weight: 600;
}

.lista-badge {
  display: inline-block;
  background: rgba(91, 124, 153, 0.2);
  color: #5B7C99;
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 0.65rem;
  margin-right: 6px;
}

.lista-badge-n1 {
  background: rgba(74, 144, 226, 0.2);
  color: #4A90E2;
}

.lista-badge-n2 {
  background: rgba(91, 124, 153, 0.2);
  color: #5B7C99;
}

.lista-badge-n3 {
  background: rgba(113, 128, 150, 0.2);
  color: #718096;
}

.lista-badge-n4 {
  background: rgba(122, 154, 184, 0.2);
  color: #7A9AB8;
}

.lista-badge-n5 {
  background: rgba(139, 154, 170, 0.2);
  color: #8B9AAA;
}

.lista-badge-n6 {
  background: rgba(154, 171, 184, 0.2);
  color: #9AABB8;
}

.lista-badge-n7 {
  background: rgba(107, 142, 127, 0.2);
  color: #6B8E7F;
}

.lista-content {
  max-height: 150px;
  overflow-y: auto;
  margin-bottom: 8px;
  background: var(--bg-primary);
  padding: 6px;
  border-radius: 4px;
  font-size: 0.8rem;
}

.lista-input-group {
  display: flex;
  gap: 6px;
}

.lista-input {
  flex: 1;
  padding: 6px 8px;
  font-size: 0.8rem;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
}

.lista-add-btn {
  padding: 6px 10px;
  font-size: 0.75rem;
}

/* ============================================================
   JERARQUIA - CONTROLES DE BÚSQUEDA Y PALETAS
   ============================================================ */

.jerarquia-controls-bar {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: flex-start;
  padding: 15px 20px;
  background: rgba(37, 42, 51, 0.6);
  border-radius: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  position: relative;
}

.jerarquia-controls-bar.is-visual-v2-active {
  display: none;
}

.jerarquia-search-wrapper {
  position: relative;
  flex: 1;
  min-width: 280px;
  max-width: 500px;
}

.jerarquia-search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  pointer-events: none;
  opacity: 0.6;
}

.jerarquia-search-input {
  width: 100%;
  padding: 8px 12px 8px 40px;
  background: #252a33;
  border: 1px solid #4a5059;
  border-radius: 6px;
  color: #e6e9ef;
  font-size: 0.9em;
  transition: all 0.3s ease;
}

.jerarquia-search-input:focus {
  outline: none;
  border-color: #5b8bb4;
  box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
}

.jerarquia-search-input::placeholder {
  color: #8a909a;
}

.jerarquia-search-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #252a33;
  border: 1px solid #5b8bb4;
  border-top: none;
  border-radius: 0 0 6px 6px;
  margin-top: 0;
  max-height: 300px;
  overflow-y: auto;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: none;
}

.jerarquia-search-suggestions.active {
  display: block;
}

.jerarquia-suggestion-item {
  padding: 10px 15px;
  cursor: pointer;
  border-bottom: 1px solid rgba(74, 80, 89, 0.3);
  transition: background 0.2s ease;
  display: flex;
  gap: 10px;
  align-items: center;
}

.jerarquia-suggestion-item:last-child {
  border-bottom: none;
}

.jerarquia-suggestion-item:hover {
  background: #2d333d;
}

.jerarquia-suggestion-item.selected {
  background: #3d4454;
  border-left: 3px solid #5b8bb4;
}

.jerarquia-suggestion-main {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
}

.jerarquia-suggestion-id {
  color: #5b8bb4;
  font-weight: 700;
  font-size: 0.85em;
  min-width: 80px;
}

.jerarquia-suggestion-meta {
  display: flex;
  gap: 6px;
  align-items: center;
  font-size: 0.75em;
  color: #8a909a;
}

.jerarquia-suggestion-path {
  font-size: 0.75em;
  color: #8a909a;
}

.jerarquia-match {
  background: rgba(91, 139, 180, 0.3);
  color: #e6e9ef;
  border-radius: 3px;
  padding: 0 2px;
}

.jerarquia-search-status {
  font-size: 0.85em;
  color: #8a909a;
  font-style: italic;
  white-space: nowrap;
  display: none; /* Oculto por defecto */
}

.jerarquia-search-status.success {
  color: #10b981;
}

.jerarquia-search-status.warning {
  color: #fbbf24;
}

/* Separador en jerarquía */
.jerarquia-controls-bar .toolbar-separator {
  width: 1px;
  height: 28px;
  background: rgba(255, 255, 255, 0.1);
  margin: 0 4px;
}

/* Toggle Triple de Vistas - Compacto sin iconos */
.jerarquia-view-toggle {
  position: relative;
  display: flex;
  background: #1a1d23;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 3px;
  gap: 3px;
  min-width: 240px;
}

/* Botones Expandir/Contraer */
.jerarquia-expand-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px 16px;
  background: rgba(255, 255, 255, 0.05);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  color: var(--text-secondary);
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.jerarquia-expand-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--text-primary);
  transform: scale(1.05);
  border-color: rgba(255, 255, 255, 0.2);
}

.jerarquia-expand-btn:active {
  transform: scale(0.95);
}

.jerarquia-expand-btn .expand-label {
  position: relative;
  z-index: 1;
}

/* Botón Debug */
.jerarquia-expand-btn.debug-btn {
  background: rgba(91, 139, 180, 0.15);
}

/* Botón Reset */
.jerarquia-expand-btn.reset-btn {
  background: rgba(180, 91, 91, 0.15);
}

.jerarquia-toggle-option {
  flex: 1;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 6px 12px;
  background: #2d333d;
  border: none;
  border-radius: 4px;
  color: #7a8189;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  white-space: nowrap;
  letter-spacing: 0.5px;
}

.jerarquia-toggle-option .toggle-label {
  position: relative;
  z-index: 1;
}

.jerarquia-toggle-option:hover:not(.active) {
  background: #3a4049;
  color: #8a9098;
  transform: translateY(-1px);
}

.jerarquia-toggle-option.active {
  background: #4a5562;
  color: #e6e9ef;
  box-shadow: 
    0 2px 8px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.08);
}

/* Botón de reset especial */
.jerarquia-toggle-option.jerarquia-reset-btn {
  flex: 0 0 auto;
  min-width: 40px;
  padding: 6px;
  background: #dc3545;
  color: white;
}

.jerarquia-toggle-option.jerarquia-reset-btn:hover {
  background: #c82333;
  transform: translateY(-1px) rotate(180deg);
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Pestañas de Vista - Ocultas ahora */
.jerarquia-view-tabs {
  display: none;
}

.jerarquia-view-selector {
  display: flex;
  align-items: center;
  gap: 10px;
}

.jerarquia-view-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  white-space: nowrap;
}

.jerarquia-palette-select {
  padding: 8px 12px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 220px;
}

.jerarquia-palette-select:hover {
  border-color: var(--primary);
}

.jerarquia-palette-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(91, 139, 180, 0.1);
}

/* Highlight para búsqueda */
.search-highlight {
  background: rgba(255, 235, 59, 0.3);
  border-radius: 2px;
  padding: 1px 0;
  font-weight: 600;
}

.search-match {
  background: rgba(255, 235, 59, 0.5);
  box-shadow: 0 0 8px rgba(255, 235, 59, 0.3);
}

/* ============================================================
   PALETAS DE COLORES PARA JERARQUÍA
   ============================================================ */

/* PALETA VISUAL: ÁRBOL CON CONEXIONES - Vista 3 (jerarquia_visual_dependencias) */
#jerarquiaTreeContainer {
  position: relative;
  transition: opacity 0.35s ease, transform 0.35s ease;
  opacity: 0;
  visibility: hidden;
  transform: translateY(8px);
}

#jerarquiaTreeContainer.jerarquia-tree-restoring {
  opacity: 0;
  pointer-events: none;
  visibility: hidden;
  transform: translateY(8px);
  transition: none !important;
}

#jerarquiaTreeContainer.jerarquia-tree-restoring::after {
  content: '';
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(15, 18, 25, 0.8);
  z-index: 2;
  pointer-events: none;
}

#jerarquiaTreeContainer.jerarquia-tree-restoring::before {
  content: '';
  position: absolute;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 3px solid rgba(255, 255, 255, 0.2);
  border-top-color: var(--primary, #4db6ff);
  animation: jerarquia-spinner 0.9s linear infinite;
  z-index: 3;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

#jerarquiaTreeContainer.jerarquia-tree-ready {
  opacity: 1;
  pointer-events: auto;
  visibility: visible;
  transform: translateY(0);
}

@keyframes jerarquia-spinner {
  from {
    transform: translate(-50%, -50%) rotate(0deg);
  }
  to {
    transform: translate(-50%, -50%) rotate(360deg);
  }
}

#jerarquiaTreeContainer.palette-visual {
  background: #1a1d23;
  padding: 40px;
  overflow: visible;
  min-height: 600px;
  height: auto;
}

.palette-visual .tree-container {
  overflow-x: auto;
  padding: 20px;
  height: auto;
  transform-origin: top center;
  transition: transform 0.3s ease;
}

.palette-visual .tree-node {
  position: relative;
  margin: 6px 0;
}

.palette-visual .node-content {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  min-width: 320px;
  max-width: fit-content;
  background: linear-gradient(135deg, #3d4a5c 0%, #2d3847 100%);
  color: #c5cdd9;
  border-radius: 6px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  z-index: 2;
  height: 32px;
}

/* === DISEÑO GRADIENTE PURO: Minimalista azul-gris por nivel === */
/* Nivel 1 (Empresa): #1e3a8a (azul oscuro) → gris */
.palette-visual .node-content[data-level="1"] {
  background: linear-gradient(90deg, rgba(30, 58, 138, 0.15), rgba(51, 65, 85, 0.1));
  color: #e2e8f0;
  padding-left: 14px;
  border-left: 2px solid rgba(59, 130, 246, 0.3);
}

.palette-visual .tree-container > .tree-node > .node-content[data-level="1"] {
  margin-bottom: 24px;
}

.palette-visual .node-content[data-level="2"] {
  background: linear-gradient(90deg, rgba(30, 64, 175, 0.15), rgba(51, 65, 85, 0.1));
  color: #e2e8f0;
  padding-left: 14px;
  border-left: 2px solid rgba(59, 130, 246, 0.3);
}

.palette-visual .node-content[data-level="3"] {
  background: linear-gradient(90deg, rgba(37, 99, 235, 0.15), rgba(51, 65, 85, 0.1));
  color: #e2e8f0;
  padding-left: 14px;
  border-left: 2px solid rgba(59, 130, 246, 0.3);
}

.palette-visual .node-content[data-level="4"] {
  background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), rgba(51, 65, 85, 0.1));
  color: #e2e8f0;
  padding-left: 14px;
  border-left: 2px solid rgba(59, 130, 246, 0.3);
}

.palette-visual .node-content[data-level="5"] {
  background: linear-gradient(90deg, rgba(96, 165, 250, 0.15), rgba(51, 65, 85, 0.1));
  color: #e2e8f0;
  padding-left: 14px;
  border-left: 2px solid rgba(59, 130, 246, 0.3);
}

.palette-visual .node-content[data-level="6"] {
  background: linear-gradient(90deg, rgba(147, 197, 253, 0.15), rgba(51, 65, 85, 0.1));
  color: #e2e8f0;
  padding-left: 14px;
  border-left: 2px solid rgba(59, 130, 246, 0.3);
}

.palette-visual .node-content[data-level="7"] {
  background: linear-gradient(90deg, rgba(147, 197, 253, 0.15), rgba(51, 65, 85, 0.1));
  color: #e2e8f0;
  padding-left: 14px;
  border-left: 2px solid rgba(59, 130, 246, 0.3);
}

.palette-visual .node-content:hover {
  transform: translateX(4px);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
  background: rgba(51, 65, 85, 0.2) !important;
}

.palette-visual .node-toggle {
  font-size: 1em;
  color: rgba(255, 255, 255, 0.9);
  cursor: pointer;
  margin-right: 4px;
  width: 16px;
  text-align: center;
  transition: all 0.2s ease;
  -webkit-user-select: none;
  user-select: none;
  flex-shrink: 0;
}

.palette-visual .node-toggle:hover {
  color: white;
  transform: scale(1.2);
}

.palette-visual .node-toggle.collapsed {
  transform: rotate(0deg);
}

.palette-visual .node-toggle.expanded {
  transform: rotate(90deg);
}

.palette-visual .node-id {
  font-size: 0.75em;
  opacity: 0.9;
  flex-shrink: 0;
  padding: 2px 6px;
  background: rgba(0, 0, 0, 0.15);
  border-radius: 3px;
  white-space: nowrap;
}

.palette-visual .node-content[data-level="1"] .node-id,
.palette-visual .node-content[data-level="2"] .node-id,
.palette-visual .node-content[data-level="3"] .node-id,
.palette-visual .node-content[data-level="4"] .node-id,
.palette-visual .node-content[data-level="5"] .node-id,
.palette-visual .node-content[data-level="6"] .node-id,
.palette-visual .node-content[data-level="7"] .node-id {
  background: rgba(0, 0, 0, 0.15);
  color: white;
  border: none;
}

.palette-visual .node-name {
  font-size: 0.85em;
  font-weight: 600;
  flex: 0 1 auto;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}
.palette-visual .node-level {
  font-size: 0.7em;
  opacity: 0.8;
  flex-shrink: 0;
  padding: 2px 6px;
  background: rgba(0, 0, 0, 0.15);
  border-radius: 3px;
  white-space: nowrap;
}

.palette-visual .tree-children {
  margin-left: 60px;
  position: relative;
  padding-top: 0;
  max-height: none;
  overflow: visible;
}

/* CONEXIONES NIVEL 1: EMPRESA → ÁREAS */
.palette-visual .tree-container > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* CONEXIONES NIVEL 2: ÁREA → SUB-ÁREAS */
.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* CONEXIONES NIVEL 3: SUB-ÁREA → SISTEMAS */
.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 16px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* CONEXIONES NIVEL 4: SISTEMA → SUB-SISTEMAS */
.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* CONEXIONES NIVEL 5: SUB-SISTEMA → SECCIONES */
.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* CONEXIONES NIVEL 6: SECCIÓN → SUB-SECCIONES */
.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  opacity: 1;
  z-index: 1;
}

.palette-visual .tree-container > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node > .tree-children > .tree-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  box-shadow: none;
  opacity: 1;
  z-index: 2;
}

/* PALETA 8: CORPORATIVO OSCURO */
.palette-8 .sap-node-empresa {
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

/* ========================================
   CONEXIONES NIVEL 5: SUB-SISTEMA → SECCIONES
   ======================================== */
   
.palette-visual .sap-node[data-node-type="subSistema"] > .sap-node-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  z-index: 1;
}

.palette-visual .sap-node[data-node-type="subSistema"] > .sap-node-children > .sap-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  z-index: 1;
}

.palette-visual .sap-node[data-node-type="subSistema"] > .sap-node-children > .sap-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

/* ========================================
   CONEXIONES NIVEL 6: SECCIÓN → SUB-SECCIONES
   ======================================== */
   
.palette-visual .sap-node[data-node-type="seccion"] > .sap-node-children::before {
  content: '';
  position: absolute;
  top: -16px;
  bottom: 24px;
  left: -30px;
  width: 2px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 1px;
  z-index: 1;
}

.palette-visual .sap-node[data-node-type="seccion"] > .sap-node-children > .sap-node::before {
  content: '';
  position: absolute;
  top: 16px;
  left: -30px;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 1px;
  z-index: 1;
}

.palette-visual .sap-node[data-node-type="seccion"] > .sap-node-children > .sap-node::after {
  content: '';
  position: absolute;
  top: 13px;
  left: -33px;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  z-index: 2;
}

/* Estilos de nodos para todos los niveles (excepto empresa) */
.palette-visual .sap-node-content {
  background: linear-gradient(135deg, #5b8bb4 0%, #4a7090 100%);
  color: white;
  border: none;
  border-radius: 6px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  padding: 4px 8px;
  min-height: 32px;
  transition: all 0.3s ease;
}

.palette-visual .sap-node-content:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 6px 20px rgba(91, 139, 180, 0.4);
}

.palette-visual .sap-node-id {
  background: rgba(0, 0, 0, 0.15);
  color: #ffffff;
  font-size: 0.75em;
  opacity: 0.9;
  border-radius: 3px;
  padding: 2px 6px;
}

.palette-visual .sap-node-name {
  color: #ffffff;
  font-size: 0.85em;
  font-weight: 600;
}

/* Reducir espaciado entre nodos en vista visual */
.palette-visual .sap-node {
  margin-bottom: 2px;
}

/* PALETA 8: CORPORATIVO OSCURO */
.palette-8 .sap-node-empresa {
  background: linear-gradient(135deg, #171d28 0%, #232a38 100%);
  border-left: 4px solid #2d4a6b;
}

.palette-8 .sap-node-empresa .sap-node-id {
  background: #232a38;
  color: #8895ab;
  border-color: #2d4a6b;
}

/* Nivel 2: Áreas */
.palette-8 .sap-node[data-node-type="area"] > .sap-node-content {
  background: linear-gradient(135deg, #1e2936 0%, #2a3543 100%);
  border-left: 4px solid #354c69;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="area"] .sap-node-id {
  background: #2a3543;
  color: #97a8be;
  border-color: #354c69;
}

/* Nivel 3: Sub-Áreas */
.palette-8 .sap-node[data-node-type="subArea"] > .sap-node-content {
  background: linear-gradient(135deg, #283544 0%, #344254 100%);
  border-left: 4px solid #3f5573;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="subArea"] .sap-node-id {
  background: #344254;
  color: #a8b9d0;
  border-color: #3f5573;
}

/* Nivel 4: Sistemas */
.palette-8 .sap-node[data-node-type="sistema"] > .sap-node-content {
  background: linear-gradient(135deg, #324454 0%, #3e5164 100%);
  border-left: 4px solid #4a617c;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="sistema"] .sap-node-id {
  background: #3e5164;
  color: #bacbdf;
  border-color: #4a617c;
}

/* Nivel 5: Sub-Sistemas */
.palette-8 .sap-node[data-node-type="subSistema"] > .sap-node-content {
  background: linear-gradient(135deg, #3d5265 0%, #496176 100%);
  border-left: 4px solid #566e84;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="subSistema"] .sap-node-id {
  background: #496176;
  color: #cddceb;
  border-color: #566e84;
}

/* Nivel 6: Secciones */
.palette-8 .sap-node[data-node-type="seccion"] > .sap-node-content {
  background: linear-gradient(135deg, #4a6276 0%, #567185 100%);
  border-left: 4px solid #61798a;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="seccion"] .sap-node-id {
  background: #567185;
  color: #d9e2ef;
  border-color: #61798a;
}

/* Nivel 7: Sub-Secciones */
.palette-8 .sap-node[data-node-type="subSeccion"] > .sap-node-content {
  background: linear-gradient(135deg, #576d7d 0%, #61798a 100%);
  border-left: 4px solid #7692aa;
  padding-left: 8px;
}

.palette-8 .sap-node[data-node-type="subSeccion"] .sap-node-id {
  background: #61798a;
  color: #e8f0f7;
  border-color: #7692aa;
}

#jerarquiaTreeContainer.palette-8 .sap-node {
  margin-bottom: 12px;
  position: relative;
}

#jerarquiaTreeContainer.palette-8 .sap-node:last-child {
  margin-bottom: 0;
}

#jerarquiaTreeContainer.palette-8 .sap-node-empresa {
  padding: 0;
  border-left: none;
  margin: 12px 0 0;
  margin-left: 0;
  width: 100%;
}

#jerarquiaTreeContainer.palette-8 .sap-node-empresa .sap-node-content {
  padding: 8px 14px;
  border-radius: 6px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
  position: relative;
  z-index: 5;
  width: 100%;
  max-width: none;
  margin-left: 0;
  margin-right: 0;
  background: linear-gradient(135deg, #171d28 0%, #232a38 100%);
  border-left: 4px solid #2d4a6b;
  border: none;
}

#jerarquiaTreeContainer.palette-8 .sap-node-empresa .sap-node-content::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 6px;
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
  pointer-events: none;
}

#jerarquiaTreeContainer.palette-8 .sap-node-empresa + .sap-node {
  margin-top: 50px;
}

#jerarquiaTreeContainer.palette-8 .sap-children {
  margin-top: 10px;
  padding-left: 18px;
  border-left: 1px solid rgba(118, 146, 170, 0.4);
}

#jerarquiaTreeContainer.palette-8 .sap-node-content {
  padding: 8px 14px;
  border-radius: 6px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
  position: relative;
  overflow: hidden;
  -webkit-backdrop-filter: blur(2px);
  backdrop-filter: blur(2px);
}

#jerarquiaTreeContainer.palette-8 .sap-node-content::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 6px;
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
  pointer-events: none;
}

#jerarquiaTreeContainer.palette-8 .sap-node-content > * {
  position: relative;
  z-index: 1;
}

#jerarquiaTreeContainer.palette-8 .sap-node-expand,
#jerarquiaTreeContainer.palette-8 .sap-node-drag-handle {
  color: rgba(255, 255, 255, 0.7);
}

#jerarquiaTreeContainer.palette-8 .sap-node-expand:hover,
#jerarquiaTreeContainer.palette-8 .sap-node-drag-handle:hover {
  color: #ffffff;
}

#jerarquiaTreeContainer.palette-8 .sap-node-id {
  background: rgba(12, 22, 32, 0.6);
  color: #d7e3f5;
  border-color: rgba(118, 146, 170, 0.45);
}

#jerarquiaTreeContainer.palette-8 .sap-node-name {
  color: #f0f4ff;
  font-weight: 600;
}

#jerarquiaTreeContainer.palette-8 .sap-node-actions {
  background: rgba(0, 0, 0, 0.15);
  padding: 4px 6px;
  border-radius: 999px;
}

#jerarquiaTreeContainer.palette-8 .sap-btn {
  border-color: rgba(173, 192, 211, 0.4);
  color: #e4ebf7;
}

#jerarquiaTreeContainer.palette-8 .sap-btn:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(173, 192, 211, 0.7);
}

/* ============================================================
   HIDDEN ELEMENTS - Para elementos con display: none inicial
   ============================================================ */
.hidden {
  display: none;
}

/* ============================================================
   CONFIG - Categoras de reas del Mapa
   ============================================================ */
.config-section {
  margin-top: 32px;
  padding: 24px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border: 2px solid var(--border-color);
}

.config-section-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0;
}

.config-section-clickable {
  cursor: pointer;
  flex: 1;
  padding: 12px;
  background: rgba(0,0,0,0.1);
  border-radius: 6px;
  -webkit-user-select: none;
  user-select: none;
}

.config-section-title-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.config-section-title {
  color: var(--primary);
  margin: 0;
  font-size: 1.2rem;
  font-weight: 600;
}

.config-btn-add-category {
  background: var(--success);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.config-btn-add-category:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.config-btn-icon {
  font-size: 1.1rem;
}

.config-description {
  color: var(--text-secondary);
  font-size: 0.85rem;
  margin-bottom: 16px;
}

.config-section-content-hidden {
  display: none;
  padding-top: 16px;
}

.categorias-container {
  background: var(--bg-secondary);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid var(--border-color);
}

.categorias-grid {
  display: grid;
  gap: 12px;
}

.mensaje-no-categorias {
  display: none;
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.mensaje-no-categorias-icon {
  font-size: 3rem;
  margin-bottom: 12px;
  opacity: 0.5;
}

.mensaje-no-categorias-text {
  font-size: 0.95rem;
  margin: 0;
}

.mensaje-no-categorias-small {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.config-info-box {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
  padding: 16px;
  border-radius: 8px;
  margin-top: 16px;
  border-left: 4px solid var(--primary);
}

.config-info-content {
  display: flex;
  align-items: start;
  gap: 12px;
}

.config-info-icon {
  font-size: 1.5rem;
}

.config-info-title {
  color: var(--text-primary);
  font-size: 0.9rem;
  margin: 0 0 6px 0;
  font-weight: 600;
}

.config-info-description {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin: 0;
  line-height: 1.5;
}

/* ============================================================
   MODAL REPUESTOS - Formulario
   ============================================================ */
.form-categoria-select {
  font-size: 1.05rem;
  font-weight: 700;
  color: #4A6278;
}

.form-ejemplos-small {
  color: #7A9AB8;
  font-size: 0.68rem;
  display: block;
  margin-top: 4px;
  font-style: italic;
  min-height: 16px;
}

.form-stock-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
}

.form-hint-small {
  color: var(--text-secondary);
  font-size: 0.65rem;
  display: block;
  margin-top: -6px;
  margin-bottom: 8px;
}

.form-label-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-label-optional {
  color: var(--text-secondary);
  font-weight: 400;
  font-size: 0.65rem;
}

.form-textarea-tech {
  resize: vertical;
  min-height: 60px;
  font-family: 'Courier New', monospace;
  font-size: 0.78rem;
}

.form-textarea-hint {
  color: var(--text-secondary);
  font-size: 0.62rem;
  display: block;
  margin-top: 3px;
}

.form-multimedia-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(360px, 1fr));
  gap: 18px;
  margin-bottom: 12px;
}

.form-label-space-between {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-weight: 500;
  font-size: 0.85rem;
  color: var(--text-primary);
}

.form-upload-mode {
  color: var(--info);
  font-weight: 600;
  font-size: 0.7rem;
}

.mobile-photo-buttons {
  display: none;
  gap: 6px;
  margin-bottom: 8px;
}

.mobile-photo-btn {
  flex: 1;
  padding: 8px;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.form-input-hidden {
  display: none;
}

.form-input-file {
  padding: 8px 12px;
  font-size: 0.85rem;
}

.multimedia-preview-margin {
  margin-top: 6px;
}

.form-label-margin {
  margin-bottom: 6px;
}

.documents-list {
  margin-top: 6px;
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* Zona de carga de imgenes mejorada */
.image-upload-zone {
  border: 2px dashed var(--primary);
  border-radius: 6px;
  padding: 24px 16px;
  text-align: center;
  background: rgba(91, 139, 180, 0.04);
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 12px;
}

.image-upload-zone:hover {
  background: rgba(91, 139, 180, 0.08);
  border-color: rgba(91, 139, 180, 0.8);
}

.upload-icon {
  font-size: 2.5rem;
  margin-bottom: 8px;
  opacity: 0.6;
}

.upload-text {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.upload-hint {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

/* Modal Optimizador de Imgenes */
.optimizer-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.65);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
  overflow-y: auto;
}

.optimizer-modal.active {
  display: flex;
}

.optimizer-content {
  background: var(--bg-secondary);
  border-radius: 16px;
  max-width: 920px;
  width: 100%;
  max-height: 92vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
  margin: auto;
  animation: modalFadeIn 0.2s ease-out;
}

@keyframes modalFadeIn {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.optimizer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 2px solid var(--border-color);
  background: var(--bg-tertiary);
  border-radius: 16px 16px 0 0;
  flex-shrink: 0;
}

.optimizer-header h3 {
  margin: 0;
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.optimizer-header h3::before {
  content: '🖼️';
  font-size: 1.4rem;
}

.optimizer-close {
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  font-size: 1.5rem;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 0;
  width: 36px;
  height: 36px;
  line-height: 1;
  border-radius: 8px;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.optimizer-close:hover {
  color: white;
  background: var(--danger);
  border-color: var(--danger);
  transform: rotate(90deg);
}

.optimizer-body {
  padding: 24px;
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}

.optimizer-preview {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 16px;
  margin-bottom: 24px;
  align-items: center;
}

@media (max-width: 768px) {
  .optimizer-preview {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  .preview-arrow {
    transform: rotate(90deg);
  }
}

.preview-original,
.preview-optimized {
  text-align: center;
}

.preview-original h4,
.preview-optimized h4 {
  margin: 0 0 10px 0;
  font-size: 0.9rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.preview-original img,
.preview-optimized img {
  max-width: 100%;
  max-height: 220px;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  background: var(--bg-primary);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: transform 0.2s ease;
}

.preview-original img:hover,
.preview-optimized img:hover {
  transform: scale(1.02);
  border-color: var(--primary);
}

.preview-info {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.preview-arrow {
  font-size: 2rem;
  color: var(--primary);
}

.savings-badge {
  margin-top: 10px;
  padding: 8px 12px;
  background: var(--success);
  color: white;
  border-radius: 6px;
  font-size: 0.85rem;
  display: inline-block;
}

.savings-badge strong {
  font-size: 1.1rem;
}

.optimizer-controls {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.control-group label {
  display: block;
  margin-bottom: 10px;
  font-weight: 500;
  color: var(--text-primary);
}

.size-options {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}

.size-btn {
  padding: 12px;
  border: 2px solid var(--border-color);
  background: var(--bg-tertiary);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
}

.size-btn span {
  display: block;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.size-btn small {
  display: block;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.size-btn:hover {
  border-color: var(--primary);
  background: rgba(91, 139, 180, 0.1);
}

.size-btn.active {
  border-color: var(--primary);
  background: var(--primary);
  color: white;
}

.size-btn.active span,
.size-btn.active small {
  color: white;
}

#qualitySlider {
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: var(--border-color);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

#qualitySlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
}

#qualitySlider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
  border: none;
}

.control-group small {
  display: block;
  margin-top: 5px;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.optimizer-footer {
  display: flex;
  gap: 12px;
  padding: 20px 24px;
  border-top: 2px solid var(--border-color);
  justify-content: space-between;
  background: var(--bg-tertiary);
  border-radius: 0 0 16px 16px;
  flex-shrink: 0;
}

.optimizer-footer .btn {
  min-width: 160px;
  padding: 12px 24px;
  font-size: 0.95rem;
  font-weight: 600;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.optimizer-footer .btn-success {
  background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
  box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

.optimizer-footer .btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
}

.optimizer-footer .btn-secondary {
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  color: var(--text-primary);
}

.optimizer-footer .btn-secondary:hover {
  background: var(--bg-secondary);
  border-color: var(--primary);
  transform: translateY(-1px);
}

@media (max-width: 640px) {
  .optimizer-footer {
    flex-direction: column-reverse;
  }
  .optimizer-footer .btn {
    width: 100%;
  }
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 2px solid var(--border-color);
}

.btn-save-main {
  flex: 0 0 auto;
  min-width: 260px;
  justify-content: center;
}

.btn-loading-hidden {
  display: none;
}

.btn-cancel-modal {
  flex: 0 0 auto;
  min-width: 180px;
}

/* ============================================================
   MODALES - Estilos comunes para modales
   ============================================================ */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  z-index: 10001;
  overflow: hidden;
  -webkit-backdrop-filter: blur(4px);
  backdrop-filter: blur(4px);
}

.modal-overlay-highest {
  z-index: 99999;
}

.modal-container {
  position: relative;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  margin: 10vh auto;
  background: var(--bg-secondary);
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal-header {
  padding: 20px 24px;
  background: linear-gradient(135deg, var(--primary), var(--info));
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  margin: 0;
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-icon {
  font-size: 1.8rem;
}

.modal-close-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 1.8rem;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.modal-close-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.modal-content {
  padding: 24px;
  max-height: calc(80vh - 80px);
  overflow-y: auto;
}

/* Variantes de modal */
.modal-container-large {
  max-width: 900px;
  height: 90vh;
  margin: 5vh auto;
  background: var(--bg-primary);
}

.modal-container-xlarge {
  max-width: 1200px;
  height: 90vh;
  margin: 5vh auto;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-header-stats {
  padding: 24px;
  border-bottom: 2px solid var(--border-color);
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border-radius: 16px 16px 0 0;
  flex-shrink: 0;
}

.modal-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title-large {
  margin: 0;
  font-size: 1.8rem;
  display: flex;
  align-items: center;
  gap: 12px;
}

.modal-icon-large {
  font-size: 2rem;
}

.modal-close-btn-large {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 28px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.modal-close-btn-large:hover {
  background: rgba(239, 68, 68, 0.9);
  transform: rotate(90deg);
}

.modal-content-flex {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.modal-footer {
  padding: 20px 24px;
  border-top: 2px solid var(--border-color);
  background: var(--bg-secondary);
  border-radius: 0 0 16px 16px;
  flex-shrink: 0;
}

.modal-footer-btn {
  width: 100%;
  padding: 14px;
  font-size: 1.1rem;
}

/* Modal Cascada - estilos especficos */
.modal-header-cascada {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
  background: var(--bg-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}

.modal-title-cascada {
  margin: 0;
  font-size: 1.1rem;
  color: var(--text-primary);
  font-weight: 600;
}

.modal-close-btn-simple {
  background: none;
  border: none;
  color: var(--text-secondary);
  width: 32px;
  height: 32px;
  border-radius: 4px;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.modal-close-btn-simple:hover {
  background: var(--bg-tertiary);
  color: var(--danger);
}

.cascada-toolbar {
  padding: 12px 20px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  flex-shrink: 0;
}

.cascada-stats {
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  margin-bottom: 10px;
  font-size: 0.85rem;
  color: var(--text-secondary);
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.cascada-search-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 0.9rem;
  outline: none;
  margin-bottom: 10px;
}

.cascada-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.cascada-btn {
  padding: 6px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.2s;
}

.cascada-btn:hover {
  background: var(--bg-primary);
}

.modal-content-cascada {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
}

.modal-footer-simple {
  padding: 12px 20px;
  border-top: 1px solid var(--border-color);
  background: var(--bg-secondary);
  flex-shrink: 0;
}

.modal-footer-btn-simple {
  width: 100%;
  padding: 10px;
  background: var(--primary);
  border: none;
  border-radius: 4px;
  color: white;
  font-size: 0.95rem;
  cursor: pointer;
  transition: opacity 0.2s;
}

.modal-footer-btn-simple:hover {
  opacity: 0.9;
}

/* Modal Detalles - modal simple para confirmaciones */
.modal-detalles-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 10000;
  justify-content: center;
  align-items: center;
}

.modal-detalles-container {
  background: var(--bg-secondary);
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.modal-detalles-content {
  padding: 20px;
}

.file-input-hidden {
  display: none;
}



/* =================================================================
    REFACTORIZACIN DE ESTILOS INLINE v6.0
   Este archivo contiene todas las clases CSS creadas para reemplazar
   los estilos inline del HTML principal - Mejoras visuales aplicadas
   ================================================================= */

/* ============================================================
   BARRA DE PROGRESO DE BACKUP
   ============================================================ */
#backupProgressBar {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 10000;
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  padding: 8px 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  border-bottom: 2px solid var(--primary);
}

.backup-progress-container {
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: 1400px;
  margin: 0 auto;
}

.backup-progress-loading {
  width: 16px;
  height: 16px;
  border-width: 2px;
}

.backup-progress-content {
  flex: 1;
}

.backup-progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.backup-progress-text {
  color: #fff;
  font-size: 0.85rem;
  font-weight: 600;
}

.backup-progress-percent {
  color: var(--primary);
  font-weight: 700;
  font-size: 0.85rem;
}

.backup-progress-bar-bg {
  background: rgba(0,0,0,0.3);
  height: 6px;
  border-radius: 3px;
  overflow: hidden;
}

.backup-progress-bar-fill {
  background: linear-gradient(90deg, var(--primary), #10b981);
  height: 100%;
  width: 0%;
  transition: width 0.3s ease;
  box-shadow: 0 0 10px var(--primary);
}

/* ============================================================
   TOOLBAR - BOTONES Y CONTROLES
   ============================================================ */
.btn-add-main {
  margin-right: 12px;
}

.toggle-label-custom {
  margin-right: 16px;
}

.btn-quitar-filtros {
  display: none;
  margin-right: 16px;
  padding: 8px 16px;
  font-size: 0.85rem;
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  border: none;
  color: white;
}

.connection-btn-custom {
  margin-left: 4px;
  padding: 8px 12px;
  cursor: default;
}

.search-box-custom {
  max-width: 350px;
  margin-left: auto;
}

/* ============================================================
   PAGINACIN
   ============================================================ */
.pagination-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  flex-wrap: wrap;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 12px;
  box-shadow: var(--shadow-md);
  margin: 20px 0;
}

.pagination-items-selector {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.pagination-nav {
  display: flex;
  align-items: center;
  gap: 8px;
}

.pagination-jump {
  display: flex;
  align-items: center;
  gap: 8px;
}

.pagination-input {
  width: 70px;
  padding: 8px 12px;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  background: var(--bg-primary);
  color: var(--text-primary);
  text-align: center;
  font-size: 0.9rem;
  font-weight: 600;
}

.pagination-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn-pagination {
  min-width: 40px !important;
  padding: 8px 12px !important;
  font-size: 1.1rem;
}

.btn-pagination-text {
  min-width: auto !important;
  padding: 10px 16px !important;
  font-size: 0.875rem !important;
  font-weight: 600;
  letter-spacing: 0.3px;
  text-transform: uppercase;
  transition: all 0.2s ease;
}

.btn-pagination-text span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.btn-pagination-text:hover:not(:disabled) {
  background: var(--primary);
  color: white;
  transform: translateY(-1px);
  box-shadow: var(--shadow-lg);
}

.btn-pagination:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.pagination-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  white-space: nowrap;
  font-weight: 500;
}

.pagination-select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  background: var(--bg-primary);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.9rem;
  min-width: 180px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.pagination-select:hover {
  border-color: var(--primary);
}

.pagination-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.pagination-info {
  font-size: 0.85rem;
  color: var(--text-secondary);
  opacity: 0.8;
  font-style: italic;
  margin-left: 4px;
}

.page-numbers-container {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
}

.page-number-btn {
  min-width: 44px !important;
  padding: 10px 14px !important;
  font-size: 0.9rem !important;
  font-weight: 600 !important;
  transition: all 0.2s ease;
  border-radius: 8px;
}

.page-number-btn:hover:not(:disabled) {
  background: var(--primary-light);
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.page-number-btn.page-active {
  background: var(--primary) !important;
  color: white !important;
  box-shadow: var(--shadow-lg);
  cursor: default;
  font-weight: 700 !important;
}

.pagination-status {
  color: var(--text-secondary);
  font-size: 0.875rem;
  margin-left: 16px;
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border-radius: 6px;
  white-space: nowrap;
  font-weight: 600;
  letter-spacing: 0.3px;
}

/* ============================================================
   VISTAS - LISTA Y TARJETAS
   ============================================================ */
.list-view-hidden {
  display: none;
}

/* ============================================================
   JERARQUA - TREE HEADER
   ============================================================ */
.tree-header-custom {
  font-size: 0.85rem;
  line-height: 1.6;
}

.tree-header-title {
  color: var(--primary);
}

/* ============================================================
   JERARQUA - BUSCADOR
   ============================================================ */
.jerarquia-search-container {
  padding: 16px;
  background: var(--bg-secondary);
  border-bottom: 2px solid var(--primary-color);
}

.jerarquia-search-wrapper {
  position: relative;
}

.jerarquia-search-clear {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  font-size: 1.2rem;
  color: var(--gray-500);
  cursor: pointer;
  padding: 4px 8px;
}

.jerarquia-search-results {
  margin-top: 8px;
  max-height: 300px;
  overflow-y: auto;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: none;
}

/* ============================================================
   JERARQUA - CONTROLES Y FILTROS
   ============================================================ */
.jerarquia-controls {
  padding: 12px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.toggle-tree-btn {
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.filtros-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  flex-wrap: wrap;
}

.filtros-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

.filtro-select {
  max-width: 200px;
}

.filtro-select-hidden {
  max-width: 180px;
  display: none;
}

.btn-limpiar-filtros {
  padding: 6px 12px;
  font-size: 0.85rem;
  display: none;
}

.jerarquia-counter {
  font-size: 0.85rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

/* ============================================================
   JERARQUA - BREADCRUMB
   ============================================================ */
.filtros-breadcrumb {
  padding: 8px 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-bottom: 1px solid var(--border-color);
  display: none;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  font-size: 0.85rem;
  color: white;
}

.breadcrumb-label {
  font-weight: 600;
}

.breadcrumb-path {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

/* ============================================================
   MAPAS - HEADERS
   ============================================================ */
.map-section-header-custom h3 {
  line-height: 28px;
}

.map-new-btn {
  white-space: nowrap;
}

.map-controls-wrapper {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}

/* ============================================================
   MAPAS - BUSCADOR Y FILTROS
   ============================================================ */
.map-search-container {
  padding: 8px 10px;
  background: var(--bg-secondary);
  border-radius: 6px;
  margin-bottom: 6px;
}

.map-search-input {
  width: 100%;
  padding: 6px 10px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.75rem;
  outline: none;
}

.map-category-filters {
  padding: 6px 10px;
  background: var(--bg-secondary);
  border-radius: 6px;
  margin-bottom: 8px;
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  align-items: center;
}

.map-category-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  font-weight: 600;
}

.map-category-filter-btn {
  padding: 3px 8px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.2s;
}

.map-category-filter-btn[data-category="all"] {
  background: var(--primary);
  color: white;
}

.map-category-filter-btn.active {
  background: var(--primary);
  color: white;
}

/* ============================================================
   UTILIDADES GENERALES
   ============================================================ */
.flex-center {
  display: flex;
  align-items: center;
}

.flex-between {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.gap-sm {
  gap: 6px;
}

.gap-md {
  gap: 12px;
}

.text-small {
  font-size: 0.85rem;
}

.text-tiny {
  font-size: 0.75rem;
}

.mb-sm {
  margin-bottom: 4px;
}

.mr-sm {
  margin-right: 8px;
}

.mr-md {
  margin-right: 16px;
}

/* ============================================================
   SECCIN DE MAPAS - ICONOS Y ELEMENTOS ADICIONALES
   ============================================================ */
.info-icon-small {
  font-size: 0.65rem;
}

.map-selection-badge {
  display: none;
  background: #10b981;
  color: white;
}

.map-btn-batch-hidden {
  display: none;
}

/* ============================================================
   ESTADSTICAS - TAB STATS
   ============================================================ */
.stats-title {
  margin-bottom: 24px;
  color: var(--primary);
}

.stats-details {
  margin-top: 30px;
}

/* ============================================================
   VALORES - TAB VALORES
   ============================================================ */
.valores-title {
  margin-bottom: 24px;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.valores-resumen {
  background: var(--bg-secondary);
  color: var(--text-primary);
  padding: 24px;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
}

.valores-tabs-container {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 8px;
  flex-wrap: wrap;
}

.tab-valores {
  flex: 1;
  min-width: 150px;
  padding: 12px 16px;
  border: none;
  border-radius: 8px 8px 0 0;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.9rem;
  text-align: center;
}

.tab-valores:not(.active) {
  background: var(--bg-primary);
  color: var(--text-secondary);
}

.tab-valores.active {
  background: var(--primary);
  color: white;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
}

/* ============================================================
   CONFIGURACIN - TAB CONFIG
   ============================================================ */
.config-title {
  margin-bottom: 20px;
  color: var(--primary);
}

.config-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 6px;
}

.config-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  padding: 16px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  border-radius: 10px;
  transition: all 0.2s;
  color: white;
  font-weight: 600;
  font-size: 1rem;
}

.config-content-hidden {
  display: none;
  padding-top: 16px;
}

.config-buttons-grid {
  display: grid;
  gap: 10px;
}

.config-btn-full {
  width: 100%;
  padding: 12px;
}

.config-btn-secondary {
  background: var(--secondary);
  color: white;
}

.config-btn-danger {
  background: var(--danger);
  color: white;
}

/* ===== INDICADOR DE CARGA INICIAL - REMOVIDO (Firebase es instantáneo) ===== */

/* ================================================================== */
/* 📱 MEJORAS RESPONSIVE PARA MÓVILES - COMPLETO                      */
/* ================================================================== */

/* === MÓVILES GENERALES (max-width: 768px) === */
@media (max-width: 768px) {
  /* 🎯 OCULTAR BOTONES EN TARJETAS - Las acciones están en el footer contextual */
  .card-btn {
    display: none !important;
  }
  
  /* Modal de edición optimizado para móvil - delegado a sección específica #modal */
  /* Los estilos principales están en la sección "MODAL MÓVIL - RESET TOTAL" */

  .wizard-step-meta {
    display: none !important;
  }

  .wizard-step-number {
    width: 28px !important;
    height: 28px !important;
    font-size: 0.85rem !important;
  }

  .wizard-step-label {
    font-size: 0.7rem !important;
    display: block !important;
    margin-top: 4px !important;
  }

  /* Formulario en móvil: más compacto */
  .sap-form-grid {
    padding: 0 !important;
  }

  .form-section {
    padding: 12px !important;
    margin-bottom: 12px !important;
  }

  .form-section-header {
    margin-bottom: 12px !important;
  }

  .form-section-title {
    font-size: 1rem !important;
  }

  .form-section-description {
    font-size: 0.75rem !important;
  }

  .form-group label {
    font-size: 0.85rem !important;
    margin-bottom: 4px !important;
  }

  .form-control {
    padding: 10px 12px !important;
    font-size: 16px !important; /* Evita zoom en iOS */
  }

  /* Preview de imágenes en grid de 3 columnas */
  .multimedia-preview {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 8px !important;
    max-height: 200px !important;
    padding: 8px !important;
  }

  .preview-item {
    aspect-ratio: 1 !important;
    min-height: 80px !important;
  }

  .preview-item img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
  }

  .preview-delete {
    width: 26px !important;
    height: 26px !important;
    font-size: 16px !important;
    top: 4px !important;
    right: 4px !important;
  }

  .preview-info {
    font-size: 0.55rem !important;
    padding: 2px !important;
  }

  /* Upload zone más grande y touch-friendly */
  .image-upload-zone {
    padding: 20px 16px !important;
    min-height: 100px !important;
  }

  .upload-icon {
    font-size: 32px !important;
  }

  .upload-text {
    font-size: 0.9rem !important;
  }

  .upload-hint {
    font-size: 0.75rem !important;
  }

  /* Botones de acción más grandes para touch */
  .step-actions-bottom {
    padding: 12px !important;
    gap: 10px !important;
    flex-direction: column !important;
  }

  .step-actions-bottom .btn {
    width: 100% !important;
    padding: 14px 20px !important;
    font-size: 1rem !important;
    min-height: 50px !important;
  }

  /* Optimizador de imágenes en móvil */
  .optimizer-modal {
    padding: 0 !important;
    align-items: flex-start !important;
  }
  
  .optimizer-content {
    max-width: 100% !important;
    width: 100% !important;
    height: 100vh !important;
    max-height: 100vh !important;
    border-radius: 0 !important;
    margin: 0 !important;
    display: flex !important;
    flex-direction: column !important;
  }

  .optimizer-header {
    padding: 10px 16px !important;
    flex-shrink: 0 !important;
  }

  .optimizer-header h3 {
    font-size: 1rem !important;
  }

  .optimizer-body {
    padding: 10px 12px !important;
    overflow-y: auto !important;
    flex: 1 !important;
    min-height: 0 !important;
    max-height: calc(100vh - 180px) !important; /* Reservar espacio para header y footer */
  }

  .optimizer-preview {
    grid-template-columns: 1fr 1fr !important;
    gap: 8px !important;
  }

  .preview-original,
  .preview-optimized {
    padding: 8px !important;
  }
  
  .preview-original h4,
  .preview-optimized h4 {
    font-size: 0.8rem !important;
    margin-bottom: 6px !important;
  }

  .preview-original img,
  .preview-optimized img {
    max-height: 80px !important;
    width: auto !important;
    max-width: 100% !important;
  }

  .preview-info {
    font-size: 0.65rem !important;
    gap: 4px !important;
    margin-top: 4px !important;
  }
  
  .savings-badge {
    font-size: 0.65rem !important;
    padding: 3px 6px !important;
    margin-top: 4px !important;
  }

  .preview-arrow {
    display: none !important;
  }
  
  .optimizer-controls {
    margin-top: 8px !important;
    gap: 8px !important;
  }
  
  .control-group {
    margin-bottom: 6px !important;
  }
  
  .control-group label {
    font-size: 0.75rem !important;
    margin-bottom: 4px !important;
  }

  /* Botones de tamaño en 2x2 grid más compacto */
  .size-options {
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 4px !important;
  }

  .size-btn {
    padding: 6px 4px !important;
  }

  .size-btn span {
    font-size: 0.7rem !important;
  }

  .size-btn small {
    font-size: 0.6rem !important;
    display: none !important; /* Ocultar subtítulos para ahorrar espacio */
  }
  
  /* Slider de calidad más compacto */
  #qualitySlider {
    height: 6px !important;
  }
  
  .control-group small {
    font-size: 0.6rem !important;
    display: none !important; /* Ocultar ayuda para ahorrar espacio */
  }

  .optimizer-footer {
    padding: 10px 12px !important;
    flex-direction: row !important;
    gap: 8px !important;
    flex-shrink: 0 !important;
    border-top: 1px solid var(--border-color) !important;
    background: var(--bg-tertiary) !important;
    position: sticky !important;
    bottom: 0 !important;
    margin-bottom: env(safe-area-inset-bottom, 0) !important;
    padding-bottom: calc(10px + env(safe-area-inset-bottom, 0)) !important;
  }

  .optimizer-footer .btn {
    flex: 1 !important;
    padding: 10px 8px !important;
    min-height: 44px !important;
    font-size: 0.8rem !important;
  }

  /* Lightbox en móvil */
  .lightbox-image {
    max-width: 95vw !important;
    max-height: 80vh !important;
  }

  .lightbox-nav {
    width: 44px !important;
    height: 44px !important;
    font-size: 1.2rem !important;
  }

  .lightbox-close {
    width: 40px !important;
    height: 40px !important;
    font-size: 1.5rem !important;
    top: 10px !important;
    right: 10px !important;
  }

  /* Cards de repuestos en lista */
  .repuesto-card {
    border-radius: 12px !important;
  }

  .card-image {
    height: 160px !important;
  }

  .card-content {
    padding: 12px !important;
  }

  .card-content h3 {
    font-size: 0.95rem !important;
    line-height: 1.3 !important;
  }

  .card-footer {
    padding: 10px 12px !important;
    gap: 8px !important;
  }

  .card-btn {
    padding: 8px 12px !important;
    font-size: 0.8rem !important;
    min-height: 40px !important;
  }
}

/* === MÓVILES PEQUEÑOS (max-width: 480px) === */
@media (max-width: 480px) {
  /* Preview de imágenes en 2 columnas */
  .multimedia-preview {
    grid-template-columns: repeat(2, 1fr) !important;
    max-height: 180px !important;
  }

  .preview-item {
    min-height: 90px !important;
  }

  /* Wizard ultra compacto */
  .wizard-step-indicator {
    min-width: 70px !important;
    padding: 6px 10px !important;
  }

  .wizard-step-number {
    width: 24px !important;
    height: 24px !important;
    font-size: 0.75rem !important;
  }

  .wizard-step-label {
    font-size: 0.6rem !important;
  }

  /* Formularios más compactos */
  .form-row,
  .form-row-triple,
  .form-row-quad,
  .form-stock-grid,
  .form-multimedia-grid {
    grid-template-columns: 1fr !important;
    gap: 10px !important;
  }

  .form-control {
    padding: 10px !important;
  }

  /* Cards en una sola columna */
  .cards-grid {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
    padding: 10px !important;
  }

  .card-image {
    height: 200px !important;
  }

  /* Tabs de navegación más compactas */
  .nav-tab {
    padding: 10px 8px !important;
    font-size: 0.7rem !important;
    gap: 4px !important;
  }

  .nav-tab i {
    font-size: 1rem !important;
  }

  /* Header compacto */
  .header {
    padding: 10px !important;
  }

  .logo h1 {
    font-size: 1.1rem !important;
  }

  .logo p {
    font-size: 0.65rem !important;
  }

  .header-actions {
    gap: 4px !important;
  }

  .header-actions button,
  .header-actions .btn {
    padding: 8px 10px !important;
    font-size: 0.7rem !important;
  }

  /* Optimizador más compacto para pantallas muy pequeñas */
  .optimizer-header h3::before {
    display: none !important;
  }

  .preview-original img,
  .preview-optimized img {
    max-height: 70px !important;
  }

  .size-options {
    grid-template-columns: repeat(4, 1fr) !important;
  }

  /* Slider de calidad */
  #qualitySlider {
    height: 6px !important;
  }
}

/* === LANDSCAPE EN MÓVILES === */
@media (max-height: 500px) and (orientation: landscape) {
  .modal-content,
  .modal-content.is-resizable {
    height: 100vh !important;
    max-height: 100vh !important;
  }

  .wizard-timeline {
    padding: 8px !important;
  }

  .wizard-step-indicator {
    min-width: 80px !important;
    padding: 6px 10px !important;
  }

  .optimizer-preview {
    grid-template-columns: 1fr 1fr !important;
    gap: 12px !important;
  }

  .preview-arrow {
    display: none !important;
  }

  .preview-original img,
  .preview-optimized img {
    max-height: 100px !important;
  }

  .optimizer-body {
    padding: 10px !important;
  }

  .optimizer-controls {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    gap: 12px !important;
  }

  .control-group {
    flex: 1 1 45% !important;
  }
}

/* === MEJORAS DE ACCESIBILIDAD TÁCTIL === */
@media (pointer: coarse) {
  /* Targets táctiles más grandes */
  .preview-delete,
  .modal-close,
  .optimizer-close,
  .lightbox-close,
  .lightbox-nav {
    min-width: 44px !important;
    min-height: 44px !important;
  }

  /* Espaciado extra en items clickeables */
  .autocomplete-item {
    padding: 14px 12px !important;
    min-height: 48px !important;
  }

  /* Checkboxes y radios más grandes */
  input[type="checkbox"],
  input[type="radio"] {
    width: 20px !important;
    height: 20px !important;
  }

  /* Selects más fáciles de tocar */
  select.form-control {
    min-height: 48px !important;
    padding: 12px !important;
  }
}

/* === MODO OSCURO EN MÓVIL (si aplica) === */
@media (max-width: 768px) and (prefers-color-scheme: dark) {
  .image-upload-zone {
    background: var(--bg-primary) !important;
    border-color: var(--border-color) !important;
  }
}

/* === 📱 JERARQUÍA OPTIMIZADA PARA MÓVIL === */
@media (max-width: 768px) {
  /* Barra de controles en jerarquía */
  .jerarquia-controls-bar {
    flex-direction: column !important;
    gap: 10px !important;
    padding: 12px !important;
  }

  .jerarquia-search-wrapper {
    width: 100% !important;
    max-width: 100% !important;
    min-width: unset !important;
  }

  .jerarquia-search-input {
    font-size: 16px !important; /* Evita zoom en iOS */
  }

  /* Ocultar botones secundarios en móvil */
  .jerarquia-controls-bar .toolbar-separator,
  .jerarquia-controls-bar .debug-btn,
  .jerarquia-controls-bar .reset-btn {
    display: none !important;
  }

  /* Botones en fila */
  .jerarquia-controls-bar .glass-action-btn,
  .jerarquia-controls-bar .jerarquia-expand-btn {
    min-height: 44px !important;
    min-width: 44px !important;
    flex: 1 !important;
  }

  .jerarquia-expand-btn .expand-label {
    font-size: 0.8rem !important;
  }

  /* Árbol jerárquico */
  #jerarquiaTreeContainer {
    padding: 10px !important;
    font-size: 0.9rem !important;
  }

  /* Nodos más grandes para touch */
  .tree-node,
  .palette-visual .node {
    padding: 12px !important;
    margin: 6px 0 !important;
    min-height: 48px !important;
  }

  /* Botón guardar fijo en la parte inferior */
  .jerarquia-save-container {
    position: fixed !important;
    bottom: 70px !important;
    left: 0 !important;
    right: 0 !important;
    padding: 12px !important;
    background: var(--bg-primary) !important;
    border-top: 1px solid var(--border-color) !important;
    z-index: 100 !important;
  }

  .jerarquia-save-btn {
    width: 100% !important;
    min-height: 50px !important;
    font-size: 1rem !important;
  }

  /* Panel de asignación de repuesto */
  .panel-asignacion-repuesto {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 200 !important;
    border-radius: 0 0 12px 12px !important;
    max-height: 40vh !important;
    overflow-y: auto !important;
  }
}

/* === 📱 MAPAS OPTIMIZADOS PARA MÓVIL === */
@media (max-width: 768px) {
  /* Contenedor de mapa a pantalla completa */
  #mapa .map-container,
  .map-viewer-container {
    padding: 0 !important;
    height: calc(100vh - 140px) !important;
  }

  /* Controles de mapa */
  .map-controls {
    flex-wrap: wrap !important;
    gap: 8px !important;
    padding: 10px !important;
  }

  .map-controls .tool-btn {
    min-height: 44px !important;
    min-width: 44px !important;
    flex: 1 !important;
  }

  /* Selector de mapas */
  .map-selector {
    width: 100% !important;
    min-height: 44px !important;
    font-size: 16px !important;
  }

  /* Zoom controls */
  .zoom-controls {
    position: fixed !important;
    bottom: 80px !important;
    right: 10px !important;
    z-index: 100 !important;
    flex-direction: column !important;
    gap: 8px !important;
  }

  .zoom-controls button {
    width: 44px !important;
    height: 44px !important;
    font-size: 1.2rem !important;
    border-radius: 50% !important;
    background: var(--bg-secondary) !important;
    border: 1px solid var(--border-color) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
  }

  /* Canvas del mapa */
  .map-canvas-container {
    touch-action: pan-x pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  /* Panel lateral de información de nodo */
  .node-info-panel,
  .mapa-node-panel {
    position: fixed !important;
    bottom: 70px !important;
    left: 0 !important;
    right: 0 !important;
    max-height: 40vh !important;
    border-radius: 16px 16px 0 0 !important;
    z-index: 150 !important;
  }

  /* Lista de repuestos en mapa */
  .map-repuestos-list {
    max-height: 200px !important;
    overflow-y: auto !important;
  }
}

/* ================================================================== */
/* 🖼️ VISOR DE IMÁGENES FULLSCREEN (LIGHTBOX TÁCTIL)                  */
/* ================================================================== */
.image-fullscreen-viewer {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.95);
  z-index: 100000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  animation: fadeInViewer 0.3s ease;
  touch-action: none;
}

@keyframes fadeInViewer {
  from { opacity: 0; }
  to { opacity: 1; }
}

.image-fullscreen-viewer .viewer-header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
  z-index: 10;
}

.image-fullscreen-viewer .viewer-title {
  color: white;
  font-size: 0.9rem;
  font-weight: 500;
  max-width: 70%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.image-fullscreen-viewer .viewer-counter {
  color: rgba(255,255,255,0.8);
  font-size: 0.85rem;
  background: rgba(255,255,255,0.1);
  padding: 4px 12px;
  border-radius: 20px;
}

.image-fullscreen-viewer .viewer-close {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 44px;
  height: 44px;
  background: rgba(255,255,255,0.15);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  z-index: 20;
}

.image-fullscreen-viewer .viewer-close:hover,
.image-fullscreen-viewer .viewer-close:active {
  background: rgba(255,255,255,0.3);
  transform: scale(1.1);
}

.image-fullscreen-viewer .viewer-image-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  overflow: hidden;
  position: relative;
  touch-action: none; /* Permite control total de gestos táctiles */
}

.image-fullscreen-viewer .viewer-image {
  max-width: 95%;
  max-height: 80vh;
  object-fit: contain;
  transition: transform 0.15s ease-out; /* Más rápido para zoom fluido */
  cursor: zoom-in;
  user-select: none;
  -webkit-user-drag: none;
  will-change: transform; /* Optimización GPU */
  transform-origin: center center;
}

.image-fullscreen-viewer .viewer-image.zoomed {
  cursor: zoom-out;
}

.image-fullscreen-viewer .viewer-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 50px;
  height: 80px;
  background: rgba(255,255,255,0.1);
  border: none;
  color: white;
  font-size: 28px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  z-index: 5;
}

.image-fullscreen-viewer .viewer-nav:hover,
.image-fullscreen-viewer .viewer-nav:active {
  background: rgba(255,255,255,0.25);
}

.image-fullscreen-viewer .viewer-nav.prev {
  left: 0;
  border-radius: 0 8px 8px 0;
}

.image-fullscreen-viewer .viewer-nav.next {
  right: 0;
  border-radius: 8px 0 0 8px;
}

.image-fullscreen-viewer .viewer-nav:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.image-fullscreen-viewer .viewer-dots {
  display: flex;
  gap: 8px;
  padding: 16px;
  justify-content: center;
}

.image-fullscreen-viewer .viewer-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  border: none;
  cursor: pointer;
  transition: all 0.2s;
}

.image-fullscreen-viewer .viewer-dot.active {
  background: white;
  transform: scale(1.3);
}

/* Mobile optimizations for viewer */
@media (max-width: 768px) {
  .image-fullscreen-viewer .viewer-nav {
    width: 40px;
    height: 60px;
    font-size: 22px;
    opacity: 0.6;
  }
  
  .image-fullscreen-viewer .viewer-image {
    max-width: 100%;
    max-height: 75vh;
  }
  
  .image-fullscreen-viewer .viewer-header {
    padding: 12px 60px 12px 16px;
  }
  
  .image-fullscreen-viewer .viewer-title {
    font-size: 0.85rem;
  }
}

/* ================================================================== */
/* 📱 MODAL MÓVIL v6.031 - SCROLL ÚNICO (SIN TABS)                    */
/* ================================================================== */

/* Ocultar en desktop */
.mobile-modal-overlay {
  display: none !important;
}

@media (max-width: 768px) {
  /* OVERLAY - Solo visible cuando está activo */
  .mobile-modal-overlay {
    display: none !important;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    background: #0f172a;
    z-index: 10000;
    overflow: hidden;
  }
  
  .mobile-modal-overlay.active {
    display: flex !important;
  }
  
  /* MODAL CONTAINER */
  .mobile-modal {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  /* HEADER FIJO */
  .mobile-modal-header {
    flex-shrink: 0;
    height: 56px;
    padding: 0 12px;
    padding-top: env(safe-area-inset-top);
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  
  .mobile-modal-title {
    flex: 1;
    font-size: 1rem;
    font-weight: 600;
    color: white;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .mobile-modal-close,
  .mobile-modal-save {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.15);
    color: white;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .mobile-modal-close:active,
  .mobile-modal-save:active {
    background: rgba(255,255,255,0.3);
  }
  
  /* BODY SCROLLEABLE */
  .mobile-modal-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 16px;
    padding-bottom: 100px;
    -webkit-overflow-scrolling: touch;
  }
  
  /* SECCIONES */
  .mobile-section {
    background: #1e293b;
    border-radius: 16px;
    margin-bottom: 16px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.08);
  }
  
  .mobile-section-header {
    padding: 14px 16px;
    background: rgba(255,255,255,0.03);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
    color: white;
    font-size: 0.95rem;
  }
  
  .mobile-section-badge {
    background: #3b82f6;
    color: white;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 700;
  }
  
  .mobile-section-content {
    padding: 16px;
  }
  
  /* FORM GROUPS */
  .mobile-form-group {
    margin-bottom: 16px;
  }
  
  .mobile-form-group:last-child {
    margin-bottom: 0;
  }
  
  .mobile-form-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: rgba(255,255,255,0.5);
    margin-bottom: 8px;
  }
  
  .mobile-form-input,
  .mobile-form-select,
  .mobile-form-textarea {
    width: 100%;
    padding: 14px 16px;
    font-size: 16px; /* Previene zoom en iOS */
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    color: white;
    outline: none;
    transition: all 0.2s;
    -webkit-appearance: none;
    appearance: none;
  }
  
  .mobile-form-input:focus,
  .mobile-form-select:focus,
  .mobile-form-textarea:focus {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }
  
  .mobile-form-input::placeholder,
  .mobile-form-textarea::placeholder {
    color: rgba(255,255,255,0.3);
  }
  
  .mobile-form-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 44px;
  }
  
  .mobile-form-textarea {
    min-height: 80px;
    resize: vertical;
  }
  
  /* ROWS - 2 columnas */
  .mobile-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  
  .mobile-form-row .mobile-form-group {
    margin-bottom: 0;
  }
  
  /* ROWS - 3 columnas */
  .mobile-form-row-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }
  
  .mobile-form-row-3 .mobile-form-group {
    margin-bottom: 0;
  }
  
  /* INPUTS NUMÉRICOS */
  .mobile-input-number {
    text-align: center;
    font-weight: 600;
    font-size: 1.1rem;
  }
  
  /* LISTA DE UBICACIONES */
  .mobile-ubicacion-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .mobile-ubicacion-item {
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    font-size: 0.9rem;
    color: rgba(255,255,255,0.8);
    border-left: 3px solid #3b82f6;
  }
  
  /* GRID DE FOTOS */
  .mobile-fotos-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  
  .mobile-foto-item {
    aspect-ratio: 1;
    border-radius: 10px;
    overflow: hidden;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .mobile-foto-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  /* EMPTY STATE */
  .mobile-empty-state {
    text-align: center;
    padding: 24px 16px;
    color: rgba(255,255,255,0.4);
    font-size: 0.9rem;
  }
  
  /* FOOTER FIJO */
  .mobile-modal-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 16px;
    padding-bottom: calc(16px + env(safe-area-inset-bottom));
    background: linear-gradient(to top, #0f172a 0%, #0f172a 70%, transparent 100%);
  }
  
  .mobile-btn-save {
    width: 100%;
    padding: 16px;
    font-size: 1rem;
    font-weight: 700;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    border: none;
    border-radius: 14px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .mobile-btn-save:active {
    transform: scale(0.98);
    box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
  }
  
  /* BOTÓN AGREGAR UBICACIÓN */
  .mobile-btn-add-ubicacion,
  .mobile-btn-add-foto {
    width: 100%;
    padding: 14px;
    font-size: 0.95rem;
    font-weight: 600;
    background: rgba(59, 130, 246, 0.15);
    border: 2px dashed rgba(59, 130, 246, 0.4);
    border-radius: 12px;
    color: #60a5fa;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
  }
  
  .mobile-btn-add-ubicacion:active,
  .mobile-btn-add-foto:active {
    background: rgba(59, 130, 246, 0.25);
    border-color: #3b82f6;
  }
  
  /* UBICACIÓN ITEM CON ELIMINAR */
  .mobile-ubicacion-item {
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    font-size: 0.9rem;
    color: rgba(255,255,255,0.8);
    border-left: 3px solid #3b82f6;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  
  .mobile-ubicacion-item .ubicacion-text {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .mobile-ubicacion-item .btn-remove {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    font-size: 14px;
    cursor: pointer;
    flex-shrink: 0;
  }
  
  /* ÁRBOL DE JERARQUÍA MÓVIL */
  .mobile-tree-selector {
    font-size: 14px;
    user-select: none;
    -webkit-user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  
  .mobile-tree-node {
    margin-left: 0;
  }
  
  .mobile-tree-node-content {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 40px; /* Touch target optimizado */
    position: relative;
  }
  
  .mobile-tree-node-content:active {
    background: rgba(255,255,255,0.1);
  }
  
  .mobile-tree-node-content.is-selected {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.15) 100%);
    border-left: 3px solid #3b82f6;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
  }
  
  /* Botón usar ubicación */
  .mobile-tree-use-btn {
    position: absolute;
    right: 8px;
    padding: 4px 10px;
    background: rgba(34, 197, 94, 0.9);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .mobile-tree-use-btn:active {
    transform: scale(0.95);
  }
  
  .mobile-tree-node-toggle {
    font-size: 10px;
    color: rgba(255,255,255,0.5);
    width: 16px;
    flex-shrink: 0;
    text-align: center;
  }
  
  .mobile-tree-node-icon {
    font-size: 14px;
    flex-shrink: 0;
  }
  
  .mobile-tree-node-name {
    flex: 1;
    color: rgba(255,255,255,0.9);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .mobile-tree-node-children {
    margin-left: 12px;
    border-left: 1px dashed rgba(255,255,255,0.08);
    padding-left: 6px;
  }
  
  .mobile-tree-node-children[style*="display: none"] {
    display: none !important;
  }
  
  /* Breadcrumb de ubicación seleccionada */
  .mobile-ubicacion-breadcrumb {
    padding: 10px 12px;
    background: rgba(59, 130, 246, 0.15);
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 13px;
    color: #60a5fa;
    display: flex;
    align-items: center;
    gap: 6px;
    overflow-x: auto;
    white-space: nowrap;
  }
  
  .mobile-ubicacion-breadcrumb span {
    opacity: 0.7;
  }
  
  /* FOTO ITEM CON ELIMINAR */
  .mobile-foto-item {
    aspect-ratio: 1;
    border-radius: 10px;
    overflow: hidden;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    position: relative;
  }
  
  .mobile-foto-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .mobile-foto-item .btn-remove-foto {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: none;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* INFO BOX */
  .mobile-info-box {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 12px;
    color: rgba(255,255,255,0.8);
    font-size: 0.9rem;
  }
}

/* ================================================================== */
/* 📱 v6.033 - BÚSQUEDA RÁPIDA MEJORADA CON CONTEO                    */
/* ================================================================== */

/* Resultados de búsqueda mejorados */
.quick-search-results-v2 {
  background: var(--bg-secondary);
  border-radius: 12px;
  margin-top: 8px;
  max-height: 70vh;
  overflow-y: auto;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  border: 1px solid var(--border-color);
}

.quick-result-item-v2 {
  display: flex;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid var(--border-color);
  gap: 10px;
}

.quick-result-item-v2:last-child {
  border-bottom: none;
}

.quick-result-info-v2 {
  flex: 1;
  min-width: 0;
}

.quick-result-name-v2 {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}

.quick-result-code-v2 {
  font-size: 0.95rem;
  font-family: 'Consolas', 'Monaco', monospace;
  color: #cbd5e1;
  letter-spacing: 1px;
}

/* Resaltado de dígitos buscados en ROJO */
.quick-result-code-v2 .highlight-match {
  color: #ff4757;
  font-weight: 700;
  background: rgba(255, 71, 87, 0.15);
  padding: 1px 2px;
  border-radius: 2px;
}

.quick-result-area-v2 {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 2px;
}

/* Stock badge */
.quick-result-stock-v2 {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.85rem;
  min-width: 36px;
  text-align: center;
}

.quick-result-stock-v2.low {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

.quick-result-stock-v2.critical {
  background: rgba(255, 71, 87, 0.2);
  color: #ff4757;
}

/* Botones de acción rápida */
.quick-action-buttons {
  display: flex;
  gap: 6px;
  margin-left: 8px;
}

.quick-action-btn {
  padding: 6px 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
}

.quick-action-btn.count {
  background: linear-gradient(135deg, #6B8E7F, #557566);
  color: white;
}

.quick-action-btn.count:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(107, 142, 127, 0.4);
}

.quick-action-btn.edit {
  background: linear-gradient(135deg, #5B7C99, #4A6278);
  color: white;
}

.quick-action-btn.edit:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(91, 124, 153, 0.4);
}

/* Header de resultados */
.quick-search-header {
  padding: 10px 12px;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 12px 12px 0 0;
}

.quick-search-header span {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.quick-search-header strong {
  color: var(--primary);
}

/* ================================================================== */
/* 📱 MODAL CONTEO RÁPIDO - OPTIMIZADO PARA MÓVIL v6.033              */
/* ================================================================== */
.modal-conteo-rapido {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 99999;
  display: flex;
  flex-direction: column;
}

.conteo-rapido-container {
  background: var(--bg-secondary);
  display: flex;
  flex-direction: column;
  height: 100%;
  max-height: 100vh;
}

.conteo-rapido-header {
  background: linear-gradient(135deg, #4A5568, #5A6778);
  color: white;
  padding: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.conteo-rapido-header h3 {
  margin: 0;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.conteo-rapido-close {
  background: rgba(255,255,255,0.15);
  border: none;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  font-size: 1.3rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 🎯 BOTONES ARRIBA - Para acceso rápido */
.conteo-rapido-actions {
  padding: 12px 16px;
  background: var(--bg-tertiary);
  display: flex;
  gap: 10px;
  flex-shrink: 0;
  border-bottom: 1px solid var(--border-color);
}

.conteo-rapido-actions .btn-guardar {
  flex: 1;
  padding: 14px;
  background: linear-gradient(135deg, #6B8E7F, #557566);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.conteo-rapido-actions .btn-cancelar {
  padding: 14px 20px;
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  font-size: 1rem;
  cursor: pointer;
}

/* Info del producto compacta */
.conteo-rapido-info {
  padding: 12px 16px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  flex-shrink: 0;
}

.conteo-rapido-nombre {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.conteo-rapido-meta {
  font-size: 0.8rem;
  color: var(--text-muted);
  display: flex;
  gap: 12px;
}

/* Área del contador principal */
.conteo-rapido-body {
  flex: 1;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  overflow-y: auto;
}

.conteo-rapido-display {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 16px;
  background: var(--bg-primary);
  border-radius: 12px;
}

.conteo-btn-minus,
.conteo-btn-plus {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  border: none;
  font-size: 2rem;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.1s;
}

.conteo-btn-minus {
  background: linear-gradient(135deg, #C76B6B, #A85555);
  color: white;
}

.conteo-btn-plus {
  background: linear-gradient(135deg, #6B8E7F, #557566);
  color: white;
}

.conteo-btn-minus:active,
.conteo-btn-plus:active {
  transform: scale(0.95);
}

.conteo-input-grande {
  width: 120px;
  height: 70px;
  font-size: 2.5rem;
  font-weight: 700;
  text-align: center;
  background: var(--bg-tertiary);
  border: 2px solid var(--primary);
  border-radius: 12px;
  color: var(--text-primary);
}

/* Comparación actual vs nuevo */
.conteo-rapido-comparacion {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 10px;
  align-items: center;
}

.conteo-stat-box {
  background: var(--bg-primary);
  padding: 12px;
  border-radius: 10px;
  text-align: center;
  border-left: 3px solid var(--border-color);
}

.conteo-stat-box.actual {
  border-left-color: #5B7C99;
}

.conteo-stat-box.minimo {
  border-left-color: #D4976C;
}

.conteo-stat-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.conteo-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
}

.conteo-flecha {
  font-size: 1.2rem;
  color: var(--text-muted);
}

/* Botones rápidos de cantidad */
.conteo-rapido-presets {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

.preset-btn {
  padding: 10px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
}

.preset-btn:hover {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

/* ================================================================== */
/* 📱 CONTEO MODAL - SIN SCROLL LATERAL                               */
/* ================================================================== */
@media (max-width: 768px) {
  #modalConteoIndividual {
    padding: 0 !important;
  }
  
  #modalConteoIndividual .modal-dialog-custom {
    width: 100% !important;
    max-width: 100% !important;
    height: 100% !important;
    max-height: 100% !important;
    margin: 0 !important;
    border-radius: 0 !important;
  }
  
  #modalConteoIndividual .modal-content-custom {
    height: 100vh !important;
    border-radius: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
  }
  
  #modalConteoIndividual .modal-body-custom {
    flex: 1 !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch !important;
  }
  
  #modalConteoIndividual .modal-footer-custom {
    position: sticky !important;
    bottom: 0 !important;
    padding: 12px !important;
    background: var(--bg-secondary) !important;
    border-top: 1px solid var(--border-color) !important;
  }
  
  /* Botón actualizar conteo siempre visible */
  #modalConteoIndividual .modal-footer-custom .btn {
    width: 100% !important;
    min-height: 50px !important;
    font-size: 1rem !important;
  }
}

/* ================================================================== */
/* 📱 OCULTAR ELEMENTOS REDUNDANTES EN MÓVIL                          */
/* ================================================================== */
@media (max-width: 768px) {
  /* Ocultar botón agregar del header (ya existe en footer) */
  .header-actions .glass-btn-primary[onclick*="openModal('add')"],
  .header-actions [onclick*="openModal('new')"] {
    display: none !important;
  }
  
  /* Ocultar indicador conectado/desconectado (no se usa con Firebase) */
  #estadoSincronizacion,
  .sync-status-indicator,
  [data-sync-indicator] {
    display: none !important;
  }
  
  /* Campana de notificaciones - mover para no tapar modal */
  .notification-bell {
    top: auto !important;
    bottom: 80px !important;
    right: 16px !important;
    z-index: 9000 !important;
  }
  
  .notification-panel {
    top: auto !important;
    bottom: 140px !important;
    right: 16px !important;
    max-height: 50vh !important;
  }
  
  /* Botón PWA refresh - junto a campana */
  .pwa-refresh-btn {
    top: auto !important;
    bottom: 130px !important;
    right: 16px !important;
  }
}

/* ================================================================== */
/* 📱 MINIATURA DE IMAGEN CON FONDO DE RESPALDO                       */
/* ================================================================== */
.mobile-thumbnail {
  position: relative;
  width: 70px;
  height: 70px;
  min-width: 70px;
  border-radius: 10px;
  overflow: hidden;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  cursor: pointer;
}

.mobile-thumbnail.has-image {
  border-color: var(--primary);
}

.mobile-thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.mobile-thumbnail .thumb-badge {
  position: absolute;
  bottom: 2px;
  right: 2px;
  background: var(--primary);
  color: white;
  font-size: 10px;
  padding: 2px 5px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 2px;
}

.mobile-thumbnail .thumb-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: var(--text-secondary);
  background: var(--bg-secondary);
}

/* ===== RESTO DEL CSS OMITIDO POR BREVEDAD - SE APLICAR COMPLETO ===== */
    
  </style>
  
  <!-- SheetJS para exportacin Excel profesional -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script> -->
  
  <!-- jsPDF para exportacin PDF con imgenes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- JSZip para compresin de backups completos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- Sistema de modales redimensionables y arrastrables -->
  <script src="scripts/modal-resizable.js"></script>
</head>
<body>

<!-- 📱 SCRIPT CRÍTICO: Ocultar inventario en móvil ANTES de que se renderice -->
<script>
(function() {
  if (window.innerWidth <= 768) {
    // Inyectar CSS crítico para móvil
    var style = document.createElement('style');
    style.id = 'mobile-init-critical';
    style.textContent = '#inventario.tab-content.active { display: none !important; } #mobileHome { display: block !important; }';
    document.head.appendChild(style);
    console.log('📱 CSS crítico móvil inyectado');
  }
})();
</script>

<!-- INDICADOR DE CARGA REMOVIDO - Firebase carga instantáneamente -->

<!--  MODAL DE CARGA CON BARRA DE PROGRESO -->
<div id="loadingModal" class="loading-modal">
  <div class="loading-modal-content">
    <div class="loading-modal-icon">🔄</div>
    <div class="loading-modal-title">Conectando...</div>
    <div class="loading-modal-status" id="loadingModalStatus">Inicializando módulos</div>
    <div class="loading-modal-text" id="loadingModalText">Preparando sesión FileSystem</div>
    <div class="loading-progress-container">
      <div class="loading-progress-bar" id="loadingProgressBar" style="width: 0%"></div>
    </div>
    <div class="loading-progress-text" id="loadingProgressText">0%</div>
    <div class="loading-modal-tip" id="loadingModalTip">Consejo: No cierres la ventana mientras sincronizamos tu carpeta.</div>
  </div>
</div>

<!-- 🔄 BOTÓN DE ACTUALIZACIÓN PWA -->
<button id="pwaRefreshBtn" class="pwa-refresh-btn state-default" title="Actualizar aplicación" onclick="triggerPWARefresh()">
  🔄
</button>

<!-- 🆕 BANNER DE ACTUALIZACIÓN PWA -->
<div id="pwaUpdateBanner" class="pwa-update-banner">
  <span class="pwa-update-banner-icon">🔄</span>
  <div class="pwa-update-banner-text">
    <div class="pwa-update-banner-title">¡Nueva versión disponible!</div>
    <div class="pwa-update-banner-subtitle">Actualiza para obtener las últimas mejoras</div>
  </div>
  <button class="pwa-update-banner-btn" onclick="applyPWAUpdate()">
    <span>⚡</span> Actualizar ahora
  </button>
  <button class="pwa-update-banner-close" onclick="dismissPWABanner()" title="Cerrar">
    ✕
  </button>
</div>

<!-- 🔧 CONSOLA DE DEBUG PWA (v6.115) -->
<div id="pwaConsole" class="pwa-console">
  <div class="pwa-console-header">
    <div class="pwa-console-title">
      <span style="font-size: 1.2rem;">🔧</span>
      <span>Consola de Debug</span>
      <span class="pwa-console-badge" id="consoleLogCount">0</span>
    </div>
    <div class="pwa-console-actions">
      <button class="pwa-console-btn" onclick="window.pwaConsole.clearLogs()" title="Limpiar logs">
        🗑️
      </button>
      <button class="pwa-console-btn" onclick="window.exportMobileLogs()" title="Exportar logs">
        💾
      </button>
      <button class="pwa-console-btn" onclick="window.pwaConsole.close()" title="Cerrar">
        ✕
      </button>
    </div>
  </div>
  
  <div class="pwa-console-filters">
    <button class="pwa-console-filter active" data-type="all" onclick="window.pwaConsole.setFilter('all')">
      Todos <span class="filter-count" id="filterCountAll">0</span>
    </button>
    <button class="pwa-console-filter" data-type="log" onclick="window.pwaConsole.setFilter('log')">
      📝 Log <span class="filter-count" id="filterCountLog">0</span>
    </button>
    <button class="pwa-console-filter" data-type="warn" onclick="window.pwaConsole.setFilter('warn')">
      ⚠️ Warn <span class="filter-count" id="filterCountWarn">0</span>
    </button>
    <button class="pwa-console-filter" data-type="error" onclick="window.pwaConsole.setFilter('error')">
      ❌ Error <span class="filter-count" id="filterCountError">0</span>
    </button>
    <button 
      id="btnToggleAutoCheck" 
      class="pwa-console-filter" 
      onclick="window.toggleAutoCheck()"
      style="margin-left: auto; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"
      title="Pausar/reanudar verificaciones automáticas"
    >
      ⏸️ Pausar Auto-Check
    </button>
  </div>
  
  <div class="pwa-console-output" id="pwaConsoleOutput">
    <div class="pwa-console-welcome">
      🎯 Consola de Debug activada<br>
      📱 Todos los logs se capturan automáticamente<br>
      � Usa la búsqueda para encontrar logs específicos
    </div>
  </div>
  
  <div class="pwa-console-search-wrapper">
    <input 
      type="text" 
      class="pwa-console-search" 
      id="pwaConsoleSearch" 
      placeholder="Buscar en logs (ej: 'EDITAR', 'Error', 'Firebase')..."
      autocomplete="off"
    />
    <button class="pwa-console-search-btn" onclick="window.pwaConsole.search()">
      🔍
    </button>
    <button class="pwa-console-stats-btn" onclick="window.pwaConsole.showStats()">
      📊 Stats
    </button>
  </div>
</div>

<!-- 🔘 BOTÓN FLOTANTE PARA ABRIR CONSOLA -->
<button id="pwaConsoleToggle" class="pwa-console-toggle" onclick="window.pwaConsole.toggle()" title="Abrir consola de debug">
  🔧
</button>

<!--  CAMPANA DE NOTIFICACIONES PERSISTENTE -->
<div id="notificationBell" class="notification-bell" title="Notificaciones" onclick="
  console.log(' CLICK DIRECTO EN ONCLICK!');
  const panel = document.getElementById('notificationPanel');
  if (panel.classList.contains('active')) {
    panel.classList.remove('active');
    console.log(' Panel CERRADO');
  } else {
    panel.classList.add('active');
    console.log(' Panel ABIERTO');
  }
">
  🔔
  <span id="notificationCounter" class="notification-counter">0</span>
</div>

<!--  PANEL DE NOTIFICACIONES -->
<div id="notificationPanel" class="notification-panel">
  <!-- Encabezado -->
  <div class="notification-panel-header">
    <div class="notification-panel-title">
      <span>🔔</span>
      <span>Notificaciones</span>
    </div>
    <div class="notification-panel-actions">
      <button class="notification-panel-action" onclick="window.markAllNotificationsAsRead()">
        Marcar leídas
      </button>
      <button class="notification-panel-action" onclick="window.clearAllNotifications()">
        Limpiar todo
      </button>
    </div>
  </div>
  
  <!-- Lista de notificaciones -->
  <div id="notificationList" class="notification-list">
    <!-- Se llena dinámicamente -->
  </div>
</div>

<!--  BARRA DE PROGRESO DE BACKUP AUTOMTICO -->
<div id="backupProgressBar">
  <div class="backup-progress-container">
    <div class="loading backup-progress-loading"></div>
    <div class="backup-progress-content">
      <div class="backup-progress-header">
        <span class="backup-progress-text">Creando backup automtico...</span>
        <span id="backupProgressPercent" class="backup-progress-percent">0%</span>
      </div>
      <div class="backup-progress-bar-bg">
        <div id="backupProgressFill" class="backup-progress-bar-fill"></div>
      </div>
    </div>
  </div>
</div>

<!-- CONTENEDOR FIJO SUPERIOR -->
<div class="sticky-header-container">

  <!-- NAVEGACIN - DENTRO DEL CONTENEDOR STICKY -->
  <div class="nav-tabs">
    <button class="nav-tab active" data-tab="inventario">
      Inventario
    </button>
    <button class="nav-tab" data-tab="jerarquia">
      Jerarqua
    </button>
    <button class="nav-tab" data-tab="mapa">
      Mapa
    </button>
    <button class="nav-tab" data-tab="stats">
      Stats
    </button>
    <button class="nav-tab" data-tab="valores">
      Valores
    </button>
    <button class="nav-tab" data-tab="configuracion" id="navTabConfiguracion">
      Configuracin
    </button>
  </div>

  <!-- WarmupProgress removido - Firebase carga instantáneamente -->
</div>

<!-- CONTENEDOR PRINCIPAL -->
<div class="container">
  <!-- 🏠 TAB MOBILE HOME (Solo visible en móvil) -->
  <div id="mobileHome" class="tab-content">
    
    <!-- Header Home -->
    <header class="mobile-home-header">
      <div class="home-brand">
        <span class="brand-icon">📦</span>
        <div class="brand-text">
          <h1>Inventario <span class="version-badge" id="versionBadgeMobile"></span></h1>
          <span class="brand-subtitle">Sistema de Gestión</span>
        </div>
      </div>
      <div class="home-header-actions">
        <!-- 🆕 v6.042 - Botón Usuario/Logout para móvil -->
        <button id="mobileUserBtn" class="home-user-btn" onclick="window.toggleMobileUserMenu()" title="Usuario" style="display: none;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </button>
        <!-- Menú desplegable usuario móvil -->
        <div id="mobileUserMenu" class="mobile-user-dropdown" style="display: none;">
          <div class="mobile-user-info">
            <span id="mobileUserEmail">No conectado</span>
            <span id="mobileUserRole" class="mobile-user-role"></span>
          </div>
          <button onclick="window.mobileLogout()" class="mobile-logout-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Cerrar sesión
          </button>
        </div>
        <button class="home-refresh-btn" onclick="location.reload(true)" title="Refrescar página">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6"></path>
            <path d="M1 20v-6h6"></path>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
        </button>
        <button class="home-config-btn" onclick="switchMobileTab('config')" title="Configuración">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- 🔍 BÚSQUEDA RÁPIDA EN TIEMPO REAL -->
    <section class="home-quick-search">
      <div class="quick-search-container">
        <span class="quick-search-icon">🔍</span>
        <input type="text" 
               id="mobileQuickSearch" 
               class="quick-search-input" 
               placeholder="Buscar repuesto..." 
               autocomplete="off"
               inputmode="text"
               oninput="window.mobileHomeActions?.quickSearch(this.value)"
               onkeydown="event.stopPropagation();"
               onkeyup="event.stopPropagation();"
               onkeypress="event.stopPropagation();">
        <button class="quick-search-clear" onclick="window.mobileHomeActions?.clearQuickSearch()" style="display:none;">✕</button>
        <!-- 🆕 v6.033 - Botón agregar cuando código SAP no existe -->
        <button id="quickSearchAddBtn" class="quick-search-add-btn" onclick="window.mobileHomeActions?.addNewFromSearch()" style="display:none;">
          ➕
        </button>
      </div>
      <!-- Resultados de búsqueda -->
      <div id="quickSearchResults" class="quick-search-results" style="display:none;"></div>
    </section>

    <!-- 📂 CATEGORÍAS DE ÁREAS -->
    <section class="home-area-categories">
      <div class="area-chips-container" id="homeAreaChips">
        <button class="area-chip active" data-area="" onclick="window.mobileHomeActions?.filterByArea('')">
          <span class="chip-icon">📦</span>
          <span class="chip-label">Todos</span>
        </button>
        <!-- Los chips de áreas se generan dinámicamente -->
      </div>
    </section>

    <!-- Stats Cards -->
    <section class="home-stats">
      <div class="stat-card" onclick="switchMobileTab('inventario')">
        <div class="stat-number" id="homeStatTotal">0</div>
        <div class="stat-label">Repuestos</div>
        <div class="stat-indicator"></div>
      </div>
      <div class="stat-card stat-warning" onclick="window.mobileHomeActions?.showStockBajo()">
        <div class="stat-number" id="homeStatStockBajo">0</div>
        <div class="stat-label">Stock Bajo</div>
        <div class="stat-indicator"></div>
      </div>
      <div class="stat-card" onclick="switchMobileTab('mapas')">
        <div class="stat-number" id="homeStatMapas">0</div>
        <div class="stat-label">Mapas</div>
        <div class="stat-indicator"></div>
      </div>
    </section>

    <!-- Acción Principal - Escanear -->
    <section class="home-main-action">
      <button class="scan-main-btn" onclick="window.sapScanner?.openCaptureModal()">
        <div class="scan-btn-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
            <circle cx="12" cy="13" r="4"></circle>
          </svg>
        </div>
        <div class="scan-btn-text">
          <span class="scan-title">Escanear Repuesto</span>
          <span class="scan-subtitle">Captura etiqueta SAP</span>
        </div>
        <div class="scan-btn-arrow">→</div>
      </button>
    </section>

    <!-- Acciones Secundarias -->
    <section class="home-actions">
      <button class="action-card" onclick="window.app.openModal('add')">
        <div class="action-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </div>
        <span class="action-label">Agregar</span>
      </button>
      <button class="action-card" onclick="switchMobileTab('inventario'); setTimeout(() => document.getElementById('searchInput')?.focus(), 300)">
        <div class="action-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </div>
        <span class="action-label">Buscar</span>
      </button>
      <button class="action-card" onclick="switchMobileTab('jerarquia')">
        <div class="action-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </div>
        <span class="action-label">Ubicaciones</span>
      </button>
      <button class="action-card" onclick="switchMobileTab('mapas')">
        <div class="action-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
            <line x1="8" y1="2" x2="8" y2="18"></line>
            <line x1="16" y1="6" x2="16" y2="22"></line>
          </svg>
        </div>
        <span class="action-label">Mapas</span>
      </button>
    </section>

    <!-- Zonas Rápidas -->
    <section class="home-zones">
      <div class="section-header">
        <h2>Zonas</h2>
        <button class="see-all-btn" onclick="switchMobileTab('jerarquia')">Ver todas</button>
      </div>
      <div class="zones-list" id="homeZonesList">
        <div class="zone-item zone-loading">
          <span class="zone-name">Cargando ubicaciones...</span>
        </div>
      </div>
    </section>

    <!-- Alertas -->
    <section class="home-alerts-section" id="homeAlertsSection">
      <div class="section-header">
        <h2>Alertas</h2>
      </div>
      <div class="alerts-list" id="homeAlertsList">
        <!-- Se llena dinámicamente -->
      </div>
    </section>

  </div>

  <!-- TAB INVENTARIO -->
  <div id="inventario" class="tab-content active">
    <!-- 🔍 BUSCADOR MÓVIL - Solo visible en móvil -->
    <div class="mobile-search-bar" style="display: none;">
      <div class="mobile-search-container">
        <span class="mobile-search-icon">🔍</span>
        <input 
          type="text" 
          id="mobileSearchInput" 
          class="mobile-search-input" 
          placeholder="Buscar repuesto..." 
          autocomplete="off"
          oninput="window.app.handleMobileSearch(this.value)"
        />
        <button class="mobile-search-clear" onclick="window.app.clearMobileSearch()" style="display:none;">✕</button>
      </div>
    </div>

    <div class="toolbar">
      <!-- GRUPO 1: ACCIONES PRINCIPALES -->
      <div class="toolbar-group">
        <button class="glass-btn glass-btn-primary" onclick="window.app.openModal('add')">
          <span>Agregar Repuesto</span>
        </button>
        
        <button class="glass-btn" id="quitarFiltrosJerarquicosBtn" onclick="window.app.quitarFiltrosJerarquicos()" title="Quitar filtros aplicados desde jerarquía">
          Quitar Filtros
        </button>
      </div>
      
      <!-- GRUPO 2: VISUALIZACIÓN -->
      <div class="toolbar-group">
        <div class="toggle-wrapper" id="togglePrecioBtn" onclick="window.app.togglePrecio()" title="Mostrar u ocultar columna de precio">
          <div class="toggle-track">
            <div class="toggle-thumb"></div>
          </div>
          <span class="toggle-label">Precio</span>
        </div>
        
        <div class="view-toggle">
          <button class="view-toggle-btn active" data-view="cards" onclick="window.app.toggleView(this, 'cards')">Tarjetas</button>
          <button class="view-toggle-btn" data-view="list" onclick="window.app.toggleView(this, 'list')">Lista</button>
        </div>
        
        <!-- DESHABILITADO: Firebase-only mode - No se necesita FileSystem -->
        <button class="glass-btn connection disconnected" id="connectionBtn" title="Estado de conexión con la carpeta" style="display:none !important;">
          Desconectado
        </button>
      </div>
      
      <!-- GRUPO 3: CONTROLES DE ZOOM -->
      <div class="toolbar-group">
        <div class="glass-zoom-controls">
          <button onclick="zoomOut()" class="glass-zoom-btn" title="Alejar">−</button>
          <div class="glass-zoom-display" id="zoomLevel">100%</div>
          <button onclick="zoomIn()" class="glass-zoom-btn" title="Acercar">+</button>
          <button onclick="zoomReset()" class="glass-zoom-btn" title="Restablecer">⟲</button>
        </div>
      </div>
      
      <!-- GRUPO 3.5: USUARIO (después de login) -->
      <div class="toolbar-group" id="userMenu" style="display: none;">
        <div class="toolbar-separator"></div>
        <div style="display: inline-flex; align-items: stretch; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden;">
          <span id="userEmail" style="display: flex; align-items: center; padding: 6px 12px; background: rgba(255,255,255,0.05); font-size: 0.75rem; color: rgba(255,255,255,0.7); font-weight: 500; white-space: nowrap;"></span>
          <button id="btnLogout" style="display: flex; align-items: center; padding: 6px 12px; background: rgba(255,255,255,0.08); border: none; border-left: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem; color: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.2s;" title="Cerrar sesión" onmouseover="this.style.background='rgba(248, 113, 113, 0.15)'; this.style.color='rgba(248, 113, 113, 0.9)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'; this.style.color='rgba(255,255,255,0.5)'">
            Salir
          </button>
        </div>
        <span class="version-badge" id="versionBadgeDesktop" style="margin-left: 8px;"></span>
      </div>
      
      <!-- GRUPO 4: BÚSQUEDA -->
      <div class="toolbar-group toolbar-group-search">
        <div class="glass-search">
          <span class="search-icon">🔍</span>
          <input type="text" id="searchInput" placeholder="Buscar...">
        </div>
        <button onclick="clearSearch()" class="glass-action-btn" title="Limpiar búsqueda">✕</button>
        <div class="toolbar-separator"></div>
        <button onclick="undoAction()" class="glass-action-btn" title="Deshacer (Ctrl+Z)">↶</button>
        <button onclick="redoAction()" class="glass-action-btn" title="Rehacer (Ctrl+Y)">↷</button>
      </div>
    </div>

    <div class="filters-selects">
      <select class="filter-select" id="filterArea" onchange="app.applyFilters()" aria-label="Filtrar por rea">
        <option value="">Todas las reas</option>
      </select>
      
      <select class="filter-select" id="filterEquipo" onchange="app.applyFilters()" aria-label="Filtrar por equipo">
        <option value="">Todos los Equipos</option>
      </select>
      
      <select class="filter-select" id="filterTipo" onchange="app.applyFilters()" aria-label="Filtrar por tipo">
        <option value="">Todos los Tipos</option>
      </select>
      
      <select class="filter-select" id="filterStock" onchange="app.applyFilters()" aria-label="Filtrar por stock">
        <option value="">Ver Todos</option>
        <option value="agotado">Agotados (0 unid.)</option>
        <option value="critico">Crticos (bajo mnimo)</option>
        <option value="adecuado">Adecuados (entre mn-pt)</option>
        <option value="optimo">ptimos (sobre ptimo)</option>
      </select>
    </div>

    <!-- PAGINACIN -->
    <div id="pagination" class="pagination-controls">
      <div class="pagination-items-selector">
        <label class="pagination-label">Items por pgina:</label>
        <select id="itemsPerPageSelect" onchange="app.changeItemsPerPage(this.value)" class="pagination-select" aria-label="Seleccionar items por pgina">
          <option value="auto">Auto (Responsive)</option>
          <option value="12">12 items</option>
          <option value="18">18 items</option>
          <option value="21">21 items</option>
          <option value="24">24 items</option>
          <option value="30">30 items</option>
          <option value="40">40 items</option>
          <option value="50">50 items</option>
          <option value="100">100 items</option>
        </select>
        <span id="itemsPerPageInfo" class="pagination-info"></span>
      </div>
      
      <div class="pagination-nav">
        <button onclick="window.app.goToPage(1)" class="btn btn-secondary btn-pagination btn-pagination-text" id="btnFirstPage" title="Ir a la primera pgina">
          <span> Primera</span>
        </button>
        <button onclick="window.app.previousPage()" class="btn btn-secondary btn-pagination btn-pagination-text" id="btnPrevPage" title="Pgina anterior">
          <span> Anterior</span>
        </button>
        
        <div id="pageNumbers" class="page-numbers-container"></div>
        
        <button onclick="window.app.nextPage()" class="btn btn-secondary btn-pagination btn-pagination-text" id="btnNextPage" title="Pgina siguiente">
          <span>Siguiente </span>
        </button>
        <button onclick="window.app.goToPage('last')" class="btn btn-secondary btn-pagination btn-pagination-text" id="btnLastPage" title="Ir a la ltima pgina">
          <span>ltima </span>
        </button>
      </div>
      
      <div class="pagination-jump">
        <label class="pagination-label">Ir a pgina:</label>
        <input type="number" id="jumpToPage" min="1" class="pagination-input" placeholder="#" onkeypress="if(event.key==='Enter') app.jumpToPage()" aria-label="Nmero de pgina">
        <button onclick="window.app.jumpToPage()" class="btn btn-primary btn-sm" title="Ir a pgina">
          Ir
        </button>
      </div>
    </div>

    <div id="inventarioContent">
      <div class="cards-grid" id="cardsGrid"></div>
      <div class="list-view list-view-hidden" id="listView"></div>
    </div>
  </div>

  <!-- TAB JERARQUA -->
  <div id="jerarquia" class="tab-content">
    <!--  RBOL JERRQUICO ORGANIZACIONAL -->
    <div class="jerarquia-config-container full-width">
      
      <!-- 🎯 PANEL DE ASIGNACIÓN DE REPUESTO (Flujo Guiado) -->
      <div id="panelAsignacionRepuesto" class="panel-asignacion-repuesto" style="display: none;">
        <div class="panel-asignacion-header">
          <h3>📦 Asignando Repuesto a Jerarquía</h3>
          <button onclick="window.app.cerrarPanelAsignacion()" class="btn-cerrar-panel" title="Cerrar">✕</button>
        </div>
        <div class="panel-asignacion-body">
          <div class="repuesto-preview">
            <div class="repuesto-preview-label">Repuesto:</div>
            <div id="repuestoNombreAsignacion" class="repuesto-preview-nombre">-</div>
            <div id="repuestoCodigoAsignacion" class="repuesto-preview-codigo">-</div>
          </div>
          <div class="instrucciones-asignacion">
            <p>👉 <strong>Navega por el árbol</strong> y selecciona el nodo donde deseas ubicar este repuesto.</p>
            <p>💡 Puedes asignarlo a cualquier nivel: Área, Sistema, Equipo, etc.</p>
          </div>
          <div id="nodoSeleccionadoInfo" class="nodo-seleccionado-info" style="display: none;">
            <div class="nodo-seleccionado-label">✓ Nodo seleccionado:</div>
            <div id="nodoSeleccionadoPath" class="nodo-seleccionado-path">-</div>
          </div>
        </div>
        <div class="panel-asignacion-footer">
          <button id="btnAsignarRepuestoANodo" onclick="window.app.asignarRepuestoANodo()" class="btn btn-success btn-lg" disabled>
            ✓ Asignar Repuesto a Este Nodo
          </button>
        </div>
      </div>
      
      <!-- 🔍 BARRA DE CONTROLES -->
      <div class="jerarquia-controls-bar">
        <div class="jerarquia-search-wrapper">
          <span class="jerarquia-search-icon">🔍</span>
          <input 
            type="text" 
            id="jerarquiaTreeSearchInput" 
            class="jerarquia-search-input"
            placeholder="Buscar en la jerarquía..."
            autocomplete="off"
          />
          <div id="jerarquiaSearchSuggestions" class="jerarquia-search-suggestions"></div>
        </div>
        <button onclick="clearJerarquiaSearch()" class="glass-action-btn" title="Limpiar búsqueda">✕</button>
        <div class="toolbar-separator"></div>
        <button onclick="undoAction()" class="glass-action-btn" title="Deshacer (Ctrl+Z)">↶</button>
        <button onclick="redoAction()" class="glass-action-btn" title="Rehacer (Ctrl+Y)">↷</button>
        <div class="toolbar-separator"></div>
        
        <!-- Botones Expandir/Contraer -->
        <button class="jerarquia-expand-btn" onclick="window.app.expandirTodoJerarquia()" title="Expandir todo">
          <span class="expand-label">Expandir</span>
        </button>
        <button class="jerarquia-expand-btn" onclick="window.app.contraerTodoJerarquia()" title="Contraer todo">
          <span class="expand-label">Contraer</span>
        </button>
        <div class="toolbar-separator"></div>
        <button class="jerarquia-expand-btn debug-btn" onclick="debugPersistencia()" title="Ver estados en consola">
          <span class="expand-label">🐛 Debug</span>
        </button>
        <button class="jerarquia-expand-btn reset-btn" onclick="resetPersistencia()" title="Limpiar estados guardados">
          <span class="expand-label">🗑️ Reset</span>
        </button>
      </div>
      </div>
      
      <div id="jerarquiaTreeContainer" class="palette-visual">
        <!-- Se llenará dinámicamente con el árbol visual -->
      </div>
      
      <!-- Botón guardar en la parte inferior -->
      <div class="jerarquia-save-container">
        <button id="btnGuardarJerarquia" onclick="window.app.guardarCambiosJerarquia()" 
                class="btn btn-success jerarquia-save-btn">
           Guardar Cambios
        </button>
      </div>
      
      <!-- FAB Escanear (solo móvil) -->
      <button class="jerarquia-fab-scan" onclick="window.scanFromJerarquia()" title="Escanear SAP">
        📸
      </button>
    </div>
  </div>

  <!-- 
  
   MAPA ANTIGUO COMENTADO COMO BACKUP (FASE 1)
  
  Si el nuevo mapa falla, puedes descomentar esto y comentar el nuevo.
  
  <div id="mapa" class="tab-content">
    <div class="map-container">
      <h2 class="mapa-legacy-title">Mapa de Ubicaciones</h2>
      
      <div class="map-controls">
        <button class="tool-btn" onclick="document.getElementById('mapImageInput').click()">
          Cargar Imagen
        </button>
        <input type="file" id="mapImageInput" accept="image/*" class="hidden-file-input" onchange="app.loadMapImage(event)">
        
        <button class="tool-btn active" data-tool="select" onclick="window.app.selectTool('select')">
          Seleccionar
        </button>
        <button class="tool-btn" data-tool="rect" onclick="window.app.selectTool('rect')">
          Rectngulo
        </button>
        <button class="tool-btn" data-tool="circle" onclick="window.app.selectTool('circle')">
          Crculo
        </button>
        <button class="tool-btn" data-tool="machine" onclick="window.app.selectTool('machine')">
          Mquina
        </button>
        <button class="tool-btn" data-tool="delete" onclick="window.app.selectTool('delete')">
          Eliminar
        </button>
        <button class="btn btn-success" onclick="window.app.saveMap()">
          Guardar Mapa
        </button>
      </div>
      
      <canvas id="mapCanvas"></canvas>
    </div>
  </div>
  
  -->
  
  <!--  🏥 TRASPLANTE VISUAL DEL PROTOTIPO - Tab Mapas v6.0 -->
  <!-- TAB MAPA -->
  <div id='mapa' class='tab-content mapas-tab'>
    <div class='map-shell'>
      <!-- PANEL LATERAL CON TABS -->
      <aside class='map-panel'>
        
        <!-- TABS DE NAVEGACIÓN -->
        <div class='panel-tabs' style='display: none;'>
          <button class='panel-tab active' onclick='switchPanelTab("mapas")'>
            <span class='panel-tab-text'>Mapas</span>
            <span class='panel-tab-badge'>-</span>
          </button>
        </div>

        <!-- CONTENIDO: MAPAS -->
        <div id='tabMapas' class='panel-tab-content active'>
          <!-- Sidebar de subsecciones -->
          <nav class='subsections-sidebar' id='subsectionsSidebar'>
            <button class='subsection-item active' onclick='scrollToSection("jerarquia-completa")'>
              <span class='subsection-icon'>J</span>
              <span class='subsection-label'>Jerarquía Completa</span>
            </button>
            <button class='subsection-item' onclick='scrollToSection("mapas-creados")'>
              <span class='subsection-icon'>M</span>
              <span class='subsection-label'>Mapas Creados</span>
            </button>
            <button class='subsection-item' onclick='scrollToSection("pendientes")'>
              <span class='subsection-icon'>P</span>
              <span class='subsection-label'>Pendientes</span>
            </button>
            <button class='subsection-item' onclick='scrollToSection("estadisticas")'>
              <span class='subsection-icon'>E</span>
              <span class='subsection-label'>Estadísticas</span>
            </button>
          </nav>

          <!-- Contenedor del contenido -->
          <div class='tab-content-wrapper'>
            <!-- Área fija mejorada -->
            <div class='tab-fixed-header'>
              <!-- 1. BREADCRUMB Y MAPA ACTIVO -->
              <div class='map-active-header' style='display: none;'>
                <div class='map-thumbnail-container'>
                  <img id='activeMapThumbnail' src='' alt='Mapa activo' class='map-thumbnail' onerror='this.style.display="none"'>
                  <div class='map-thumbnail-placeholder'>📍</div>
                </div>
                <div class='map-breadcrumb-info'>
                  <div class='breadcrumb-path' id='mapBreadcrumb'>
                    <span class='breadcrumb-item'>Sin mapa</span>
                  </div>
                  <div class='map-active-name' id='activeMapName'>Ningún mapa cargado</div>
                </div>
                <div class='map-status-indicator'>
                  <span class='status-badge status-inactive' id='mapStatusBadge'>●</span>
                </div>
              </div>

              <!-- 2. BOTÓN CREAR MAPA -->
              <button class='create-map-btn' onclick='mapController.openNewMapModal()' style='width: 100%; padding: 8px 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.15)); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 6px; color: #60a5fa; font-size: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; margin-bottom: 8px;'>
                <span style='font-size: 1rem;'>+</span>
                <span>Crear Nuevo Mapa</span>
              </button>

              <!-- 3. BÚSQUEDA AVANZADA CON FILTROS -->
              <div class='search-advanced-container'>
                <div class='search-input-wrapper'>
                  <input type='text' id='globalSearch' class='search-input-enhanced' 
                         placeholder='🔎 Buscar en jerarquía, mapas, áreas...' 
                         oninput='handleAdvancedSearch(this.value)'
                         onkeydown='handleSearchKeyboard(event)'
                         autocomplete='off'>
                  <div class='search-suggestions' id='searchSuggestions' style='display: none;'></div>
                  <div class='search-history' id='searchHistory' style='display: none;'></div>
                </div>
                <div class='search-filters'>
                  <button class='filter-btn active' data-filter='all' onclick='setSearchFilter("all")'>Todo</button>
                  <button class='filter-btn' data-filter='mapas' onclick='setSearchFilter("mapas")'>🗺️</button>
                  <button class='filter-btn' data-filter='areas' onclick='setSearchFilter("areas")'>📦</button>
                  <button class='filter-btn' data-filter='marcadores' onclick='setSearchFilter("marcadores")'>📍</button>
                </div>
              </div>

              <!-- 4. STATS SIMPLIFICADOS Y LIMPIOS -->
              <div style='display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 8px;'>
                <div style='background: rgba(26, 29, 35, 0.6); border: 1px solid rgba(91, 139, 180, 0.25); border-radius: 6px; padding: 8px 6px; text-align: center;'>
                  <div style='font-size: 1.1rem; font-weight: 700; color: #60a5fa; line-height: 1; margin-bottom: 4px;' id='statsMapasCount'>0</div>
                  <div style='font-size: 0.6rem; color: rgba(226, 232, 240, 0.6); text-transform: uppercase; letter-spacing: 0.5px;'>Mapas</div>
                </div>
                <div style='background: rgba(26, 29, 35, 0.6); border: 1px solid rgba(91, 139, 180, 0.25); border-radius: 6px; padding: 8px 6px; text-align: center;'>
                  <div style='font-size: 1.1rem; font-weight: 700; color: #60a5fa; line-height: 1; margin-bottom: 4px;' id='statsAreasCount'>0</div>
                  <div style='font-size: 0.6rem; color: rgba(226, 232, 240, 0.6); text-transform: uppercase; letter-spacing: 0.5px;'>Áreas</div>
                </div>
                <div style='background: rgba(26, 29, 35, 0.6); border: 1px solid rgba(91, 139, 180, 0.25); border-radius: 6px; padding: 8px 6px; text-align: center;'>
                  <div style='font-size: 1.1rem; font-weight: 700; color: #60a5fa; line-height: 1; margin-bottom: 4px;' id='statsMarcadoresCount'>0</div>
                  <div style='font-size: 0.6rem; color: rgba(226, 232, 240, 0.6); text-transform: uppercase; letter-spacing: 0.5px;'>Marcadores</div>
                </div>
              </div>
            </div>

            <!-- Área con scroll -->
            <div class='tab-scroll-content'>

          <!-- 🎯 GUÍA DE FLUJO DE TRABAJO - PANEL DESTACADO -->
          <section class='map-section map-workflow-guide' id='section-workflow-guide'>
            <div class='workflow-guide-header'>
              <div class='workflow-guide-title'>
                <span class='workflow-icon'>🎯</span>
                <span>¿Cómo gestionar mapas?</span>
              </div>
              <button class='workflow-dismiss-btn' onclick='dismissWorkflowGuide()' title='Ocultar guía'>✕</button>
            </div>
            <div class='workflow-steps'>
              <div class='workflow-step' onclick='mapController.openNewMapModal()'>
                <div class='step-number'>1</div>
                <div class='step-content'>
                  <div class='step-title'>Crear Mapa</div>
                  <div class='step-desc'>Sube una imagen del plano</div>
                </div>
                <div class='step-action'>+</div>
              </div>
              <div class='workflow-step-arrow'>→</div>
              <div class='workflow-step' onclick='scrollToSection("mapas-creados"); setTimeout(() => showZonesHelper(), 300);'>
                <div class='step-number'>2</div>
                <div class='step-content'>
                  <div class='step-title'>Dibujar Zonas</div>
                  <div class='step-desc'>Define áreas en el mapa</div>
                </div>
                <div class='step-action'>📐</div>
              </div>
              <div class='workflow-step-arrow'>→</div>
              <div class='workflow-step' onclick='showMarkerHelper()'>
                <div class='step-number'>3</div>
                <div class='step-content'>
                  <div class='step-title'>Agregar Marcadores</div>
                  <div class='step-desc'>Ubica repuestos en el mapa</div>
                </div>
                <div class='step-action'>📍</div>
              </div>
            </div>
            <div class='workflow-quick-actions'>
              <button class='workflow-action-btn primary' onclick='mapController.openNewMapModal()'>
                <span>+</span> Crear Mi Primer Mapa
              </button>
              <button class='workflow-action-btn secondary' onclick='showMapTutorial()'>
                <span>📖</span> Ver Tutorial
              </button>
            </div>
          </section>

          <!-- 1. JERARQUÍA COMPLETA - SECCIÓN PRINCIPAL -->
          <section class='map-section' id='section-jerarquia-completa'>
            <div class='map-section-header' onclick='toggleSection(this)'>
              <h3><span class='collapse-icon'>▼</span> 🏢 Jerarquía Completa</h3>
            </div>
            <div class='section-content'>
              <div style='font-size: 0.6rem; color: var(--text-muted); margin-bottom: 8px; padding: 6px 8px; background: rgba(59, 130, 246, 0.05); border-radius: 4px; border-left: 2px solid var(--primary);'>
                💡 <strong>Indicadores:</strong> 🗺️ Mapa asignado • 📦 Área creada • 📍 Marcadores (numerados)
              </div>
              <div id='hierarchy-tree-container' class='area-tree'>
                <!-- La jerarquía completa se cargará dinámicamente aquí -->
              </div>
            </div>
          </section>

          <!-- PANEL FLOTANTE DE ASIGNACIÓN DE MAPA (similar al de jerarquía) -->
          <div id="panel-asignacion-mapa" class="panel-asignacion-repuesto" style="display: none;">
            <div class="panel-header">
              <h3>📍 Asignar Ubicación en Mapa</h3>
              <button class="panel-close-btn" onclick="window.app.cerrarPanelAsignacionMapa()">&times;</button>
            </div>
            <div class="panel-body">
              <div class="repuesto-preview">
                <div class="repuesto-preview-icon">📦</div>
                <div class="repuesto-preview-info">
                  <div class="repuesto-preview-name" id="panelMapaRepuestoNombre">-</div>
                  <div class="repuesto-preview-code" id="panelMapaRepuestoCodigo">-</div>
                </div>
              </div>
              
              <div class="panel-instructions">
                <h4>📋 Paso 1: Selecciona un mapa</h4>
                <p>Primero elige el mapa donde se ubica el repuesto</p>
                <div id="mapasSelectorContainer" class="mapas-selector">
                  <!-- Se llenará dinámicamente con la lista de mapas -->
                </div>
              </div>

              <div class="panel-instructions" id="zonaInstructions" style="display: none;">
                <h4>📋 Paso 2: Selecciona una zona (opcional)</h4>
                <p>Si el mapa tiene zonas definidas, selecciona una. Si no, continúa al marcador.</p>
                <button class="btn-secondary" onclick="window.app.saltarAMarcador()">Saltar a colocar marcador</button>
              </div>

              <div class="panel-instructions" id="marcadorInstructions" style="display: none;">
                <h4>📋 Paso 3: Coloca el marcador</h4>
                <p>Haz clic en el mapa para colocar el marcador en la ubicación exacta del repuesto</p>
                <div id="coordenadasMarcador" style="margin-top: 8px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 4px; font-size: 0.85rem;">
                  <strong>Coordenadas:</strong> <span id="coordsDisplay">-</span>
                </div>
              </div>

              <div class="panel-info-box">
                <strong>💡 Progreso:</strong>
                <div id="progresoMapa" style="margin-top: 6px; padding: 6px; background: rgba(26, 29, 35, 0.6); border-radius: 4px; font-size: 0.8rem;">
                  <div id="estadoMapaSeleccionado">📋 Paso 1: Selecciona un mapa</div>
                  <div id="estadoZonaSeleccionada" style="margin-top: 4px; opacity: 0.5;">📋 Paso 2: Zona (opcional)</div>
                  <div id="estadoMarcadorColocado" style="margin-top: 4px; opacity: 0.5;">📋 Paso 3: Coloca marcador</div>
                </div>
              </div>
            </div>
            <div class="panel-footer">
              <button class="btn-secondary" onclick="window.app.cerrarPanelAsignacionMapa()">Cancelar</button>
              <button id="btnAsignarMapa" class="btn-primary" onclick="window.app.confirmarAsignacionMapa()" disabled>
                Asignar Mapa
              </button>
            </div>
          </div>

          <!-- 2. MAPAS CREADOS - LISTA COMPACTA -->
          <section class='map-section' id='section-mapas-creados'>
            <div class='map-section-header' onclick='toggleSection(this)'>
              <h3><span class='collapse-icon'>▼</span> 🗺️ Mapas Creados (<span id='mapasCount'>0</span>)</h3>
            </div>
            <div class='section-content' id='mapList'>
              <!-- Placeholder mejorado cuando no hay mapas -->
              <div id='noMapsPlaceholder' class='no-maps-placeholder'>
                <div class='no-maps-icon'>🗺️</div>
                <div class='no-maps-title'>No hay mapas creados</div>
                <div class='no-maps-desc'>Crea tu primer mapa para comenzar a ubicar repuestos visualmente</div>
                <button class='no-maps-btn' onclick='mapController.openNewMapModal()'>
                  <span>+</span> Crear Primer Mapa
                </button>
              </div>
            </div>
          </section>

          <!-- 3. PENDIENTES - ELEMENTOS SIN ASIGNAR -->
          <section class='map-section' id='section-pendientes'>
            <div class='map-section-header' onclick='toggleSection(this)'>
              <h3><span class='collapse-icon'>▼</span> ⚠️ Pendientes (<span id='pendientesCount'>0</span>)</h3>
            </div>
            <div class='section-content' id='pendientesList'>
              <div id='noPendingPlaceholder' class='no-pending-placeholder'>
                <div style='font-size: 1.5rem; margin-bottom: 8px;'>✅</div>
                <div style='font-size: 0.75rem; color: var(--text-secondary);'>¡Todo al día!</div>
                <div style='font-size: 0.65rem; color: var(--text-muted);'>No hay repuestos sin ubicar en el mapa</div>
              </div>
            </div>
          </section>

          <!-- 4. ESTADÍSTICAS - RESUMEN VISUAL -->
          <section class='map-section' id='section-estadisticas'>
            <div class='map-section-header' onclick='toggleSection(this)'>
              <h3><span class='collapse-icon'>▼</span> 📊 Estadísticas</h3>
            </div>
            <div class='section-content'>
              <div id='stats-details-container'>
                <!-- Estadísticas detalladas se cargarán aquí -->
              </div>
            </div>
          </section>

          </div> <!-- Fin tab-scroll-content -->
          </div> <!-- Fin tab-content-wrapper -->
        </div> <!-- Fin tabMapas -->


      </aside>

      <!-- WORKSPACE CANVAS MEJORADO -->
      <div class='map-workspace' id='mapWorkspace' style='display: none;'>
        <!-- Toolbar con controles mejorados -->
        <div class='map-toolbar'>
          <div class='toolbar-section'>
            <div class='zoom-controls'>
              <button class='zoom-btn' onclick='mapController.zoomOut()' title='Alejar (Ctrl + -)'>−</button>
              <span class='zoom-level' id='zoomLevel'>100%</span>
              <button class='zoom-btn' onclick='mapController.zoomIn()' title='Acercar (Ctrl + +)'>+</button>
            </div>
            <button class='toolbar-btn' onclick='mapController.resetView()' title='Restablecer vista (R)'>
              🔄 Reset
            </button>
          </div>
          
          <div class='toolbar-section'>
            <span id='mapToolbarInfo' style='font-size: 0.75rem; color: var(--text-secondary); font-weight: 500;'>
              Sin mapa cargado
            </span>
          </div>
          
          <div class='toolbar-section'>
            <button class='toolbar-btn' onclick='mapController.toggleNombres()' title='Mostrar/ocultar nombres'>
              📝 Nombres
            </button>
            <button class='toolbar-btn' onclick='mapController.togglePuntos()' title='Mostrar/ocultar puntos'>
              📍 Puntos
            </button>
            <button class='toolbar-btn' onclick='mapController.toggleGrid()' title='Mostrar/ocultar rejilla'>
              ⊞ Rejilla
            </button>
          </div>
        </div>

        <!-- Canvas principal con minimapa -->
        <div class='map-canvas-stage'>
          <canvas id='mapCanvas' class='map-canvas'></canvas>
          
          <!-- Hints y tooltips -->
          <div id='mapHint' class='map-hint hidden'></div>
          <div id='mapTooltip' class='map-tooltip hidden'></div>
          
          <!-- Indicador de atajos de teclado -->
          <div id='keyboardShortcuts' class='keyboard-shortcuts-indicator'>
            Presiona <span class='shortcut-key'>?</span> para ver atajos
          </div>
        </div>
      </div>
    </div>

    <!-- MODALES (mantener compatibilidad) -->
    <div id='mapModalOverlay' class='map-modal hidden'>
      <div class='map-modal-content'>
        <div class='map-modal-header'>
          <h3 id='mapModalTitle'>Modal</h3>
          <button id='mapModalClose' class='map-icon-btn'>X</button>
        </div>
        <div id='mapModalBody' class='map-modal-body'></div>
      </div>
    </div>

    <div id='mapLoadingOverlay' class='map-loading-overlay hidden'>
      <div class='map-loading-modal'>
        <div class='map-loading-header'>
          <div class='map-loading-icon'>🗺️</div>
          <div>
            <div id='mapLoadingTitle' class='map-loading-title'>Preparando mapa</div>
            <div id='mapLoadingStatus' class='map-loading-status'>Inicializando...</div>
          </div>
        </div>
        <div class='map-loading-bar'>
          <div id='mapLoadingBar' class='map-loading-bar-fill'></div>
        </div>
        <div id='mapLoadingPercent' class='map-loading-percent'>0%</div>
        <div class='map-loading-hint'>Cargando recursos del mapa...</div>
      </div>
    </div>
  </div>

  <!-- TAB STATS -->
  <div id="stats" class="tab-content">
    <h2 class="stats-title">Estadsticas y Mtricas de Decisin</h2>
    <div class="stats-grid" id="statsGrid"></div>
    <div id="statsDetails" class="stats-details"></div>
  </div>

  <!-- TAB VALORES -->
  <div id="valores" class="tab-content">
    <h2 class="valores-title">
      Desglose Detallado de Valores del Inventario
    </h2>
    
    <!-- Resumen General -->
    <div id="valoresResumen" class="valores-resumen"></div>
    
    <!-- Tabs de Valores -->
    <div class="valores-tabs-container">
      <button onclick="window.app.switchValoresTab('area')" id="tabArea" class="tab-valores active">
        Por rea
      </button>
      <button onclick="window.app.switchValoresTab('equipo')" id="tabEquipo" class="tab-valores">
        Por Equipo
      </button>
      <button onclick="window.app.switchValoresTab('tipo')" id="tabTipo" class="tab-valores">
        Por Tipo
      </button>
      <button onclick="window.app.switchValoresTab('top')" id="tabTop" class="tab-valores">
        Top 10
      </button>
    </div>
    
    <!-- Contenido de Tabs -->
    <div id="valoresTabContent"></div>
  </div>

  <!-- TAB CONFIGURACIN -->
  <div id="configuracion" class="tab-content">
    <h2 class="config-title">Configuracin</h2>
    
    <!-- 🆕 v6.034 GESTIÓN DE USUARIOS (Solo Admin) -->
    <div id="users-management-section" class="config-section" style="display: none;">
      <div class="config-card" style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%); border: 1px solid rgba(147, 51, 234, 0.4);">
        <div class="config-section-header-row">
          <div onclick="toggleConfigSection('users-config')" class="config-section-clickable">
            <div class="config-section-title-row">
              <span id="users-config-icon">👥</span>
              <h3 class="config-section-title" style="color: #c4b5fd;">
                👥 Gestión de Usuarios y Permisos
              </h3>
            </div>
          </div>
        </div>
        
        <div id="users-config-content" class="config-section-content" style="display: block;">
          <!-- 🆕 v6.053 - Panel de Control Admin -->
          <div id="adminControlPanel" style="display: none; margin-bottom: 16px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(147, 51, 234, 0.15) 100%); border-radius: 12px; padding: 16px; border: 1px solid rgba(239, 68, 68, 0.3);">
            <h4 style="margin: 0 0 12px 0; color: #f87171; font-size: 1rem;">⚡ Control de Administrador</h4>
            <div style="display: grid; gap: 12px;">
              <!-- Forzar actualización a todos los usuarios -->
              <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                  <div>
                    <div style="font-weight: 500; color: rgba(255,255,255,0.9); font-size: 0.9rem;">🔄 Forzar Actualización Global</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 2px;">
                      Recarga automática para todos los usuarios conectados (sin preguntar)
                    </div>
                  </div>
                  <button onclick="forceGlobalUpdate()" style="padding: 10px 16px; border-radius: 8px; border: none; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem; white-space: nowrap;">
                    ⚡ Forzar Update
                  </button>
                </div>
              </div>
              
              <!-- Auto-update toggle -->
              <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                  <div>
                    <div style="font-weight: 500; color: rgba(255,255,255,0.9); font-size: 0.9rem;">🤖 Actualizaciones Automáticas</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 2px;">
                      Los usuarios recibirán actualizaciones sin preguntar
                    </div>
                  </div>
                  <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="autoUpdateToggle" onchange="toggleAutoUpdate(this.checked)" 
                           style="width: 20px; height: 20px; accent-color: #22c55e; cursor: pointer;">
                    <span id="autoUpdateStatus" style="margin-left: 8px; font-size: 0.8rem; color: #fbbf24;">OFF</span>
                  </label>
                </div>
              </div>
              
              <!-- Intervalo de actualización de tracking -->
              <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                  <div>
                    <div style="font-weight: 500; color: rgba(255,255,255,0.9); font-size: 0.9rem;">📡 Tracking en Tiempo Real</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 2px;">
                      Ver actividad de usuarios cada X segundos
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <select id="trackingInterval" onchange="setTrackingInterval(this.value)" 
                            style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(147, 51, 234, 0.5); background: rgba(0,0,0,0.3); color: white; font-size: 0.8rem;">
                      <option value="0">Desactivado</option>
                      <option value="5">5 seg</option>
                      <option value="10" selected>10 seg</option>
                      <option value="30">30 seg</option>
                      <option value="60">1 min</option>
                    </select>
                    <span id="trackingStatus" style="font-size: 1.2rem;">📡</span>
                  </div>
                </div>
              </div>
              
              <!-- 🆕 v6.100 - Limpiar caché y forzar actualización -->
              <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                  <div>
                    <div style="font-weight: 500; color: rgba(255,255,255,0.9); font-size: 0.9rem;">🧹 Limpiar Caché PWA</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 2px;">
                      Borra caché y Service Worker para forzar actualización
                    </div>
                  </div>
                  <button onclick="clearCacheAndReload()" style="padding: 10px 16px; border-radius: 8px; border: none; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem; white-space: nowrap;">
                    🧹 Limpiar
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Estado de Usuarios Conectados -->
          <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h4 style="margin: 0; color: #c4b5fd; font-size: 1rem;">🟢 Usuarios Conectados</h4>
              <button onclick="refreshOnlineUsers()" class="btn" style="padding: 6px 12px; font-size: 0.8rem; background: rgba(147, 51, 234, 0.3);">
                🔄 Actualizar
              </button>
            </div>
            <div id="onlineUsersContainer" style="display: grid; gap: 8px;">
              <p style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin: 0;">Cargando usuarios...</p>
            </div>
          </div>
          
          <!-- Lista de Todos los Usuarios -->
          <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px;">
            <h4 style="margin: 0 0 12px 0; color: #93c5fd; font-size: 1rem;">📋 Todos los Usuarios</h4>
            <div id="allUsersContainer" style="display: grid; gap: 8px;">
              <p style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin: 0;">Cargando...</p>
            </div>
          </div>
          
          <!-- 🆕 v6.051 - Solicitudes Pendientes de Aprobación -->
          <div id="pendingRequestsSection" style="margin-top: 16px; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%); border-radius: 12px; padding: 16px; border: 1px solid rgba(251, 191, 36, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h4 style="margin: 0; color: #fbbf24; font-size: 1rem;">
                📝 Solicitudes Pendientes 
                <span id="pendingRequestsCount" style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 8px;">0</span>
              </h4>
              <button onclick="loadPendingRequests()" class="btn" style="padding: 6px 12px; font-size: 0.8rem; background: rgba(251, 191, 36, 0.3);">
                🔄 Actualizar
              </button>
            </div>
            <div id="pendingRequestsContainer" style="display: grid; gap: 8px; max-height: 400px; overflow-y: auto;">
              <p style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin: 0;">Cargando solicitudes...</p>
            </div>
          </div>
          
          <!-- Leyenda de Roles (🆕 v6.051 actualizada) -->
          <div style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.15); border-radius: 8px;">
            <p style="margin: 0 0 8px 0; font-size: 0.85rem; color: rgba(255,255,255,0.7);">
              <strong>Roles disponibles:</strong>
            </p>
            <div style="display: grid; gap: 8px; font-size: 0.8rem;">
              <span style="color: #f87171;">🔴 <b>Admin:</b> Control total sin restricciones</span>
              <span style="color: #fbbf24;">🟡 <b>Usuario:</b> Puede crear/editar/eliminar pero requiere aprobación del Admin</span>
              <span style="color: #60a5fa;">🔵 <b>Lectura:</b> Solo puede ver información, sin botones de edición</span>
            </div>
          </div>
          
          <!-- 🆕 v6.038 - Formulario Crear Usuario -->
          <div style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3);">
            <h4 style="margin: 0 0 12px 0; color: #86efac; font-size: 1rem;">➕ Crear Nuevo Usuario</h4>
            <div style="display: grid; gap: 10px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="newUserNick" placeholder="Nick (ej: juan)" 
                       style="padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 0.9rem;">
                <div style="position: relative;">
                  <input type="password" id="newUserPassword" placeholder="Contraseña" 
                         style="padding: 10px 12px; padding-right: 40px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 0.9rem; width: 100%; box-sizing: border-box;">
                  <button type="button" onclick="togglePasswordVisibility('newUserPassword', this)" 
                          style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: rgba(255,255,255,0.6); cursor: pointer; font-size: 1.1rem; padding: 4px;" title="Ver/ocultar contraseña">👁️</button>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
                <select id="newUserRole" style="padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 0.9rem;">
                  <option value="lectura">🔵 Lectura (Solo ver)</option>
                  <option value="usuario" selected>🟡 Usuario (Crear/Editar)</option>
                  <option value="admin">🔴 Admin (Control total)</option>
                </select>
                <button onclick="createNewUser()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
                  ➕ Crear
                </button>
              </div>
            </div>
            <p style="margin: 10px 0 0 0; font-size: 0.75rem; color: rgba(255,255,255,0.5);">
              💡 El usuario iniciará sesión con su nick y contraseña (mínimo 6 caracteres)
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="config-grid">
      <!-- ALMACENAMIENTO -->
      <div id="storage-config-container" class="config-card">
        <div id="storage-config-content"></div>
      </div>

      <!-- EXPORTACIN Y REPORTES -->
      <div class="config-card">
        <h3 onclick="toggleConfigSection('export-config')" class="config-section-header">
          <span id="export-config-icon"></span>
          <span> Exportacin y Reportes</span>
        </h3>
        
        <div id="export-config-content" class="config-section-content">
          <div class="config-buttons-container">
            <button onclick="configuracion.exportarHTMLConDatosEmbebidos()" class="btn config-btn-mobile">
               Exportar HTML para Mvil
            </button>

            <button onclick="configuracion.exportarExcel()" class="btn btn-primary config-btn-full">
               Exportar a Excel
            </button>
            
            <button onclick="configuracion.mostrarOpcionesPDF()" class="btn config-btn-pdf">
               Exportar a PDF
            </button>
          </div>
        </div>
      </div>

      <!-- SISTEMA DE BACKUPS Y RESPALDOS - OCULTO EN MODO FIREBASE-ONLY -->
      <div class="config-card" style="display: none !important;">
        <!-- Sección de backups FileSystem deshabilitada - Todo se guarda en Firebase -->
        <h3 onclick="toggleConfigSection('backup-config')" class="config-section-header">
          <span id="backup-config-icon"></span>
          <span> Sistema de Backups y Respaldos</span>
        </h3>
        
        <div id="backup-config-content" class="config-section-content">
          <!-- Estructura de carpetas -->
          <div class="backup-structure">
            <strong class="backup-structure-title"> Estructura de Backups:</strong><br>
            <div class="backup-structure-path">
              INVENTARIO_STORAGE/<br>
               <strong class="backup-file-name">repuestos.json</strong> <span class="backup-file-hint"> Pegar aqu JSON de repuestos</span><br>
               <strong class="backup-file-name">mapas.json</strong> <span class="backup-file-hint"> Pegar aqu JSON de mapas</span><br>
               <strong class="backup-file-name">zonas.json</strong> <span class="backup-file-hint"> Pegar aqu JSON de reas</span><br>
               imagenes/ <span class="backup-file-hint backup-file-hint-special"> Copiar aqu carpeta de imgenes completa</span><br>
               backups/<br>
              &nbsp;&nbsp;&nbsp;&nbsp; automaticos/ <span class="backup-file-name"> Backups automticos (5 ltimos)</span>
            </div>
            <div class="backup-manual-guide">
              <strong class="backup-manual-title"> Para actualizar manualmente:</strong><br>
              <small class="backup-guide-text">
                1. Pega el JSON en el archivo correspondiente (repuestos.json, mapas.json, zonas.json)<br>
                2. Copia las imgenes a la carpeta imagenes/<br>
                3. Recarga la app (F5) para ver los cambios<br>
                4. La app crear un backup automtico al guardar
              </small>
          </div>
        </div>
        
        <!--  ESTADO DEL SISTEMA DE BACKUP AUTOMTICO -->
        <div id="backupStatusPanel" class="backup-status-panel-container">
          <div class="backup-status-header">
            <div id="backupStatusIcon" class="backup-status-icon"></div>
            <div class="backup-status-content">
              <div class="backup-status-title">Sistema de Backup Automtico</div>
              <div id="backupStatusText" class="backup-status-text">Inicializando...</div>
            </div>
          </div>
          
          <div class="backup-metrics-grid">
            <div class="backup-metric-card">
              <div class="backup-metric-label">ltimo backup</div>
              <div id="backupLastTime" class="backup-metric-value">---</div>
            </div>
            <div class="backup-metric-card">
              <div class="backup-metric-label">Inactividad</div>
              <div id="backupCountdown" class="backup-metric-value">---</div>
            </div>
            <div class="backup-metric-card">
              <div class="backup-metric-label">Prximo backup</div>
              <div id="backupNextTime" class="backup-metric-value">Al detectar inactividad</div>
            </div>
          </div>
          
          <div id="backupPendingChanges" class="backup-pending-changes">
            <small class="config-small-text">
               <strong>Hay cambios pendientes</strong> - Se crear backup cuando el sistema detecte 1 minuto de inactividad
            </small>
          </div>
        </div>
        
        <div class="config-buttons-container">
          <button onclick="configuracion.mostrarGestionBackups()" class="btn btn-primary config-btn-full">
             Ver Historial de Backups Automticos
          </button>
          
          <button onclick="configuracion.crearBackupManual()" class="btn btn-success config-btn-full">
             Crear Backup Manual Ahora
          </button>
          
          <div class="config-divider">
            <small class="config-small-text">
              <strong> Respaldo Completo ZIP:</strong> Incluye datos + mapas + imgenes. Ideal para migrar entre versiones o copiar toda la carpeta backups/ a otra instalacin.
            </small>
            
            <button onclick="configuracion.exportarRespaldoCompleto()" class="btn config-btn-warning">
               Crear Respaldo Completo ZIP
            </button>
            
            <button onclick="configuracion.cargarRespaldoCompleto()" class="btn config-btn-info">
               Cargar Respaldo Completo ZIP
            </button>
          </div>
          
          <div class="config-divider config-divider-margin">
            <small class="config-small-text">
              <strong> Exportar App Portable Completa:</strong> Genera un ZIP con toda la aplicacin y tus datos para llevarlo a otro PC.
            </small>
            
            <button onclick="configuracion.exportarAppCompleta()" class="btn config-btn-gradient">
               Exportar App Portable Completa
            </button>
          </div>
        </div>
        
        <div class="config-success-note">
          <small class="config-small-text config-small-text-line-height">
            <strong> Sistema de Backups Automticos COMPLETOS:</strong><br>
             Se crean automticamente al guardar cambios<br>
             <strong>Incluyen JSON + TODAS las imgenes</strong><br>
             Se mantienen los ltimos 5 backups completos<br>
             El ms antiguo se elimina automticamente (JSON + imgenes)<br>
             <strong>Restauracin automtica:</strong> Datos + Imgenes en un solo click<br>
             <strong>Para migrar:</strong> Copia toda la carpeta <code class="config-inline-code">INVENTARIO_STORAGE/backups/automaticos/</code> a la nueva versin
          </small>
        </div>
        </div> <!-- Fin backup-config-content -->
      </div>
    </div>

    <!-- GESTIN DE LISTAS DESPLEGABLES - OCULTO (no se usa actualmente) -->
    <div class="listas-config-container" style="display: none !important;">
      <!-- Sección de listas de autocompletado deshabilitada - La jerarquía se gestiona desde la pestaña Jerarquía -->
      <h3 onclick="toggleConfigSection('listas-config')" class="config-section-header">
        <span id="listas-config-icon"></span>
        <span> Gestin de Listas de Autocompletado</span>
      </h3>
      
      <div id="listas-config-content" class="config-section-content">
        <p class="listas-config-description">
          Administra los valores de autocompletado.
        </p>

        <div class="listas-grid">
        
        <!-- TIPOS -->
        <div class="lista-card">
          <h4 class="lista-title">
            Tipos de Repuesto
          </h4>
          <div id="listaTipo" class="lista-content">
            <!-- Se llenar dinmicamente -->
          </div>
          <div class="lista-input-group">
            <input type="text" id="nuevoTipo" placeholder="Nuevo tipo..." class="lista-input">
            <button onclick="window.app.agregarItemLista('tipo')" class="btn btn-success lista-add-btn">
              +
            </button>
          </div>
        </div>

        <!-- JERARQUIA REDIRIGIDA -->
        <div class="lista-card lista-card-info">
          <h4 class="lista-title jerarquia-note-title">
            <span class="lista-badge lista-badge-n2">N2-N7</span>
            Jerarquia corporativa
          </h4>
          <p class="jerarquia-note-text">
            Los niveles Empresa, area, Sub-area, Sistema y Seccion se sincronizan ahora desde la pestana Jerarquia. Edita el arbol y los catalogos se actualizaran automaticamente en los formularios.
          </p>
          <ul class="jerarquia-note-list">
            <li>Usa <strong>Jerarquia &gt; Arbol corporativo</strong> para agregar niveles.</li>
            <li>Las areas y repuestos toman sugerencias directo del arbol.</li>
            <li>Esta tarjeta es solo informativa; no hay mas listas manuales.</li>
          </ul>
          <div class="jerarquia-note-tip">
            Consejo: mantn la jerarquia limpia y anidada para que la busqueda y los badges N1..N6 se sincronicen con tus mapas.
          </div>
        </div>

      </div>
      </div> <!-- Fin listas-config-content -->
    </div>

    <!-- FIREBASE Y SINCRONIZACIÓN - OCULTO (ya se muestra arriba en storage-config-content) -->
    <div class="config-section" id="firebase-section" style="display: none !important;">
      <div class="config-section-header-row">
        <div onclick="toggleConfigSection('firebase-config')" class="config-section-clickable">
          <div class="config-section-title-row">
            <span id="firebase-config-icon">☁️</span>
            <h3 class="config-section-title">
              ☁️ Almacenamiento en la Nube
            </h3>
          </div>
        </div>
      </div>
      
      <div id="firebase-config-content" class="config-section-content">
        <!-- Estado de Firebase -->
        <div class="config-card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border: 1px solid rgba(34, 197, 94, 0.3);">
          <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
            <div style="font-size: 2.5rem;">☁️</div>
            <div>
              <h4 style="margin-bottom: 4px; color: rgba(134, 239, 172, 0.9);">Modo Firebase Activo</h4>
              <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin: 0;">
                Todos tus datos se guardan automáticamente en la nube
              </p>
            </div>
          </div>
          
          <div id="firebase-status-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-bottom: 4px;">CONEXIÓN</div>
              <div id="firebase-conn-status" style="font-size: 0.9rem; font-weight: 600; color: #22c55e;">✅ Conectado</div>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-bottom: 4px;">SINCRONIZACIÓN</div>
              <div id="firebase-sync-status" style="font-size: 0.9rem; font-weight: 600; color: #22c55e;">🔄 Activa</div>
            </div>
          </div>
          
          <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #3b82f6;">
            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin: 0; line-height: 1.5;">
              <strong style="color: #93c5fd;">💡 Información:</strong><br>
              • Los cambios se sincronizan automáticamente<br>
              • Accede desde cualquier dispositivo con tu cuenta<br>
              • Las imágenes se guardan en Firebase Storage
            </p>
          </div>
        </div>

        <!-- Estadísticas de Firebase -->
        <div class="config-card" style="margin-top: 15px;">
          <h4 style="margin-bottom: 12px; color: rgba(255,255,255,0.9);">📊 Datos en la Nube</h4>
          <div id="firebase-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;" id="stat-repuestos">--</div>
              <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">Repuestos</div>
            </div>
            <div style="background: rgba(147, 51, 234, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #9333ea;" id="stat-mapas">--</div>
              <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">Mapas</div>
            </div>
            <div style="background: rgba(234, 179, 8, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #eab308;" id="stat-zonas">--</div>
              <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">Zonas</div>
            </div>
            <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;" id="stat-imagenes">--</div>
              <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">Imágenes</div>
            </div>
          </div>
        </div>
        
        <!-- Acciones de mantenimiento -->
        <div class="config-card" style="margin-top: 15px;">
          <h4 style="margin-bottom: 12px; color: rgba(255,255,255,0.9);">🔧 Mantenimiento</h4>
          <div style="display: grid; gap: 10px;">
            <button onclick="window.activarSincronizacionTiempoReal()" class="btn btn-success" style="padding: 12px; font-size: 0.9rem;">
              🔄 Reconectar Sincronización
            </button>
            <button onclick="actualizarEstadoFirebase()" class="btn btn-primary" style="padding: 12px; font-size: 0.9rem;">
              📊 Actualizar Estadísticas
            </button>
          </div>
        </div>
      </div>
    </div>

    <!--  CATEGORAS DE REAS DEL MAPA -->
    <div class="config-section">
      <div class="config-section-header-row">
        <div onclick="toggleConfigSection('herramientas-config')" class="config-section-clickable">
          <div class="config-section-title-row">
            <span id="herramientas-config-icon"></span>
            <h3 class="config-section-title">
               Categoras de reas del Mapa
            </h3>
          </div>
        </div>
        <button onclick="event.stopPropagation(); app.agregarNuevaCategoria()" 
                class="config-btn-add-category">
          <span class="config-btn-icon"></span> Nueva Categora
        </button>
      </div>
      
      <div id="herramientas-config-content" class="config-section-content-hidden">
        <p class="config-description">
          Gestiona las categoras que se pueden asignar a las reas del mapa
        </p>

        <div class="categorias-container">
        <div id="listaCategoriasAreas" class="categorias-grid">
          <!-- Se llenar dinmicamente -->
        </div>
        
        <div id="mensajeNoCategoriasAreas" class="mensaje-no-categorias">
          <div class="mensaje-no-categorias-icon"></div>
          <p class="mensaje-no-categorias-text">No hay categoras configuradas</p>
          <small class="mensaje-no-categorias-small">Haz clic en "Nueva Categora" para agregar una</small>
        </div>
      </div>

      <!-- Informacin sobre sincronizacin -->
      <div class="config-info-box">
        <div class="config-info-content">
          <span class="config-info-icon"></span>
          <div>
            <p class="config-info-title">
              Sincronizacin Automtica
            </p>
            <p class="config-info-description">
              Las categoras se sincronizan automticamente con los mapas. Al editar una categora, todos los mapas se actualizarn instantneamente.
              Las categoras eliminadas se removern de las reas que las usen.
            </p>
          </div>
        </div>
      </div>
      </div> <!-- Fin herramientas-config-content -->
    </div>

    <!-- 📋 HISTORIAL DE ACTIVIDAD - Solo visible para Admin -->
    <div class="config-section" id="activity-log-section-admin" style="display: none;">
      <div class="config-section-header-row">
        <div onclick="toggleConfigSection('activity-log-config')" class="config-section-clickable">
          <div class="config-section-title-row">
            <span id="activity-log-config-icon">📋</span>
            <h3 class="config-section-title">
              📋 Historial de Actividad (Solo Admin)
            </h3>
          </div>
        </div>
      </div>
      
      <div id="activity-log-config-content" class="config-section-content-hidden">
        <p class="config-description">
          Registro de todas las acciones realizadas por los usuarios en el sistema.
        </p>

        <div class="config-card" style="margin-bottom: 15px;">
          <!-- Filtros -->
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <select id="activityFilterAction" onchange="window.loadActivityLog()" style="padding: 8px 12px; border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">
              <option value="">Todas las acciones</option>
              <option value="create">➕ Creados</option>
              <option value="update">✏️ Editados</option>
              <option value="delete">🗑️ Eliminados</option>
            </select>
            <button onclick="window.loadActivityLog()" class="btn btn-primary" style="padding: 8px 16px;">
              🔄 Actualizar
            </button>
            <button onclick="window.exportActivityLog()" class="btn btn-success" style="padding: 8px 16px;">
              📥 Exportar CSV
            </button>
          </div>
          
          <!-- Lista de actividad -->
          <div id="activityLogContainer" style="max-height: 500px; overflow-y: auto;">
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
              <div style="font-size: 2rem; margin-bottom: 10px;">📋</div>
              <p>Cargando historial...</p>
            </div>
          </div>
        </div>

        <div class="config-info-box">
          <div class="config-info-content">
            <span class="config-info-icon">💡</span>
            <div>
              <p class="config-info-title">Información del Historial</p>
              <p class="config-info-description">
                Se registran las últimas 100 acciones. El historial se actualiza en tiempo real cuando los usuarios crean, editan o eliminan repuestos, mapas y zonas.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 🔧 CONSOLA DE DEBUG (MÓVIL) - Solo visible para Admin -->
    <div class="config-section" id="debug-section-admin" style="display: none;">
      <div class="config-section-header-row">
        <div onclick="toggleConfigSection('debug-config')" class="config-section-clickable">
          <div class="config-section-title-row">
            <span id="debug-config-icon">🔧</span>
            <h3 class="config-section-title">
              🔧 Consola de Debug (Solo Admin)
            </h3>
          </div>
        </div>
      </div>
      
      <div id="debug-config-content" class="config-section-content-hidden">
        <p class="config-description">
          Panel de diagnóstico para ver logs de la aplicación en dispositivos móviles donde no hay acceso a las herramientas de desarrollador.
        </p>

        <div class="config-card" style="margin-bottom: 15px;">
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <button onclick="window.toggleDebugConsole()" class="btn btn-primary" style="padding: 10px 20px;">
              📺 Mostrar/Ocultar Consola
            </button>
            <button onclick="window.clearDebugLogs()" class="btn btn-warning" style="padding: 10px 20px;">
              🗑️ Limpiar Logs
            </button>
            <button onclick="window.testDebugLog()" class="btn btn-info" style="padding: 10px 20px;">
              🧪 Test Log
            </button>
          </div>
          
          <!-- 🆕 v6.049 - Info de Red -->
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button onclick="window.showNetworkInfo()" class="btn btn-info" style="padding: 10px 20px; background: linear-gradient(135deg, #06b6d4, #0891b2);">
              📶 Ver Info de Red
            </button>
            <div id="networkInfoDisplay" style="flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.85rem; display: none;">
              <!-- Se llenará dinámicamente -->
            </div>
          </div>
          
          <!-- Botones de Compartir/Copiar -->
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button onclick="window.copyDebugLogs()" class="btn btn-success" style="padding: 10px 20px;">
              📋 Copiar Logs
            </button>
            <button onclick="window.shareDebugLogs()" class="btn btn-secondary" style="padding: 10px 20px; background: #6366f1;">
              📥 Descargar .txt
            </button>
          </div>
          
          <!-- Herramientas de Datos -->
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button onclick="window.limpiarRepuestosLocales()" class="btn btn-danger" style="padding: 10px 20px;">
              🗑️ Limpiar Repuestos Locales
            </button>
            <button onclick="window.verEstadoDatos()" class="btn btn-info" style="padding: 10px 20px;">
              📊 Ver Estado Datos
            </button>
            <button onclick="window.sincronizarLocalAFirebase()" class="btn btn-primary" style="padding: 10px 20px; background: linear-gradient(135deg, #f59e0b, #d97706);">
              🔄 Forzar Sync a Firebase
            </button>
          </div>
          
          <!-- 🔄 Herramientas de Migración a Firebase - OBSOLETAS (ya migrado todo) -->
          <!-- Botones de migración eliminados - todo ya está en Firebase -->
          
          <div id="debugConsoleConfig" style="display: none; background: rgba(0,0,0,0.9); border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
            <div id="debugLogsConfig" style="color: #0f0;"></div>
          </div>
        </div>

        <div class="config-info-box">
          <div class="config-info-content">
            <span class="config-info-icon">💡</span>
            <div>
              <p class="config-info-title">Información de Debug</p>
              <p class="config-info-description" id="debugSystemInfo">
                Cargando información del sistema...
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================== -->
<!-- 📱 MODAL MÓVIL DEDICADO - Solo visible en pantallas < 768px    -->
<!-- v6.031: Diseño completamente separado del modal PC             -->
<!-- ============================================================== -->
<div id="mobileModalOverlay" class="mobile-modal-overlay">
  <div class="mobile-modal">
    <!-- HEADER FIJO -->
    <div class="mobile-modal-header">
      <button class="mobile-modal-close" onclick="window.app.closeMobileModal()">✕</button>
      <span class="mobile-modal-title" id="mobileModalTitle">📦 Editar Repuesto</span>
      <button class="mobile-modal-save" onclick="window.app.saveMobileModal()">💾</button>
    </div>
    
    <!-- CONTENIDO SCROLLEABLE - TODO EN UNA SOLA VISTA -->
    <div class="mobile-modal-body" id="mobileModalBody">
      
      <!-- SECCIÓN 1: IDENTIFICACIÓN -->
      <div class="mobile-section">
        <div class="mobile-section-header">
          <span>🏷️ Identificación</span>
        </div>
        <div class="mobile-section-content">
          <div class="mobile-form-group">
            <label class="mobile-form-label">Nombre *</label>
            <input type="text" id="mobile-nombre" class="mobile-form-input" placeholder="Nombre del repuesto" autocomplete="off">
          </div>
          <div class="mobile-form-group">
            <label class="mobile-form-label">Descripción</label>
            <textarea id="mobile-descripcion" class="mobile-form-textarea" rows="2" placeholder="Descripción detallada"></textarea>
          </div>
          <div class="mobile-form-row">
            <div class="mobile-form-group">
              <label class="mobile-form-label">Marca</label>
              <input type="text" id="mobile-marca" class="mobile-form-input" placeholder="Marca" autocomplete="off">
            </div>
            <div class="mobile-form-group">
              <label class="mobile-form-label">Modelo</label>
              <input type="text" id="mobile-modelo" class="mobile-form-input" placeholder="Modelo" autocomplete="off">
            </div>
          </div>
        </div>
      </div>
      
      <!-- SECCIÓN 2: STOCK -->
      <div class="mobile-section">
        <div class="mobile-section-header">
          <span>📊 Stock</span>
        </div>
        <div class="mobile-section-content">
          <div class="mobile-form-row mobile-form-row-3">
            <div class="mobile-form-group">
              <label class="mobile-form-label">Actual</label>
              <input type="number" id="mobile-stock-actual" class="mobile-form-input mobile-input-number" value="0" min="0" inputmode="numeric">
            </div>
            <div class="mobile-form-group">
              <label class="mobile-form-label">Mínimo</label>
              <input type="number" id="mobile-stock-minimo" class="mobile-form-input mobile-input-number" value="0" min="0" inputmode="numeric">
            </div>
            <div class="mobile-form-group">
              <label class="mobile-form-label">Máximo</label>
              <input type="number" id="mobile-stock-maximo" class="mobile-form-input mobile-input-number" value="0" min="0" inputmode="numeric">
            </div>
          </div>
          <div class="mobile-form-group">
            <label class="mobile-form-label">Unidad de medida</label>
            <select id="mobile-unidad" class="mobile-form-select">
              <option value="unidad">Unidad</option>
              <option value="pieza">Pieza</option>
              <option value="metro">Metro</option>
              <option value="litro">Litro</option>
              <option value="kg">Kilogramo</option>
              <option value="caja">Caja</option>
              <option value="rollo">Rollo</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- SECCIÓN 3: UBICACIÓN -->
      <div class="mobile-section">
        <div class="mobile-section-header">
          <span>📍 Ubicación</span>
          <span class="mobile-section-badge" id="mobile-ubicacion-count">0</span>
        </div>
        <div class="mobile-section-content">
          <!-- Lista de ubicaciones asignadas -->
          <div id="mobile-ubicacion-list" class="mobile-ubicacion-list" style="margin-bottom: 12px;">
            <div class="mobile-empty-state">Sin ubicaciones asignadas</div>
          </div>
          
          <!-- Selector Visual de Jerarquía MÓVIL - Optimizado PWA -->
          <div id="mobileUbicacionesTreeContainer" class="mobile-tree-selector" style="max-height: 280px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; padding: 4px; background: rgba(0,0,0,0.25);">
            <!-- Botón crear jerarquía -->
            <div id="mobile-tree-actions" style="padding: 6px; border-bottom: 1px dashed rgba(255,255,255,0.08); margin-bottom: 6px;">
              <button type="button" onclick="window.app.agregarNodoJerarquiaMobile()" class="mobile-btn-add-area" style="width: 100%; padding: 10px; font-size: 13px; font-weight: 600; background: rgba(34, 197, 94, 0.12); border: 1.5px dashed rgba(34, 197, 94, 0.35); border-radius: 6px; color: #22c55e; cursor: pointer;">
                ➕ Nueva Ubicación
              </button>
            </div>
            <!-- Árbol de jerarquía se renderizará aquí -->
            <div class="mobile-empty-state">Cargando jerarquía...</div>
          </div>
        </div>
      </div>
      
      <!-- SECCIÓN 4: MULTIMEDIA -->
      <div class="mobile-section">
        <div class="mobile-section-header">
          <span>📷 Fotos</span>
          <span class="mobile-section-badge" id="mobile-fotos-count">0</span>
        </div>
        <div class="mobile-section-content">
          <div id="mobile-fotos-grid" class="mobile-fotos-grid">
            <div class="mobile-empty-state">Sin fotos</div>
          </div>
          <!-- Botón para agregar fotos -->
          <div class="mobile-foto-actions" style="margin-top: 12px;">
            <input type="file" id="mobile-foto-input" accept="image/*" multiple style="display: none;" onchange="app.onMobileFotoSelected(event)">
            <button type="button" class="mobile-btn-add-foto" onclick="document.getElementById('mobile-foto-input').click()">
              📷 Tomar / Seleccionar Foto
            </button>
          </div>
        </div>
      </div>
      
    </div>
    
    <!-- FOOTER FIJO CON BOTÓN GUARDAR -->
    <div class="mobile-modal-footer">
      <button type="button" class="mobile-btn-save" onclick="window.app.saveMobileModal()">
        💾 Guardar Cambios
      </button>
    </div>
  </div>
</div>

<!-- MODAL FORMULARIO (PC) -->
<div class="modal" id="modal">
  <div class="modal-content">
  <button class="modal-close" onclick="window.app.closeModal()" title="Cerrar" aria-label="Cerrar"></button>
    <form id="repuestoForm" onsubmit="app.saveRepuesto(event)" class="sap-modal-form">
      <input type="hidden" id="repuestoId">

      <div class="sap-form-grid">
        <div class="modal-scroll">
          <div class="wizard-timeline" id="wizardTimeline">
                <button type="button" class="wizard-step-indicator is-active" data-step="1">
                  <span class="wizard-step-number">1</span>
                  <div class="wizard-step-meta">
                    <span class="wizard-step-label">Identificacin</span>
                    <span class="wizard-step-helper">Cdigos y descripcin</span>
                  </div>
                </button>
                <button type="button" class="wizard-step-indicator" data-step="2">
                  <span class="wizard-step-number">2</span>
                  <div class="wizard-step-meta">
                    <span class="wizard-step-label">Stock & polticas</span>
                    <span class="wizard-step-helper">Cantidades y parmetros</span>
                  </div>
                </button>
                <button type="button" class="wizard-step-indicator" data-step="3">
                  <span class="wizard-step-number">3</span>
                  <div class="wizard-step-meta">
                    <span class="wizard-step-label">Ubicaciones</span>
                    <span class="wizard-step-helper">Jerarqua corporativa</span>
                  </div>
                </button>
                <button type="button" class="wizard-step-indicator" data-step="4">
                  <span class="wizard-step-number">4</span>
                  <div class="wizard-step-meta">
                    <span class="wizard-step-label">Multimedia</span>
                    <span class="wizard-step-helper">Imgenes y documentos</span>
                  </div>
                </button>
              </div>

              <div class="wizard-step-container">
                <div class="wizard-step wizard-step--active" data-step="1">
                  <section class="form-section form-section--half">
                    <div class="form-section-header">
                      <h3 class="form-section-title">Identificación general</h3>
                      <p class="form-section-description">Registra los códigos oficiales y la descripción que se verá en SAP, reportes y etiquetas.</p>
                    </div>
                    <div class="form-row-triple">
                      <div class="form-group">
                        <label>Cdigo SAP: *</label>
                        <input type="text" class="form-control" id="codSAP" list="codSAPDatalist" required placeholder="Ej: SAP12345">
                        <datalist id="codSAPDatalist">
                          <option value="Pendiente">Pendiente</option>
                        </datalist>
                      </div>

                      <div class="form-group autocomplete-container">
                        <label>Cd. Proveedor:</label>
                        <input type="text" class="form-control" id="codProv" autocomplete="off" placeholder="Ej: PROV-001">
                        <div class="autocomplete-list" id="autocomplete-codProv"></div>
                      </div>

                      <div class="form-group autocomplete-container">
                        <label>Tipo:</label>
                        <input type="text" class="form-control" id="tipo" autocomplete="off" placeholder="Ej: Filtro">
                        <div class="autocomplete-list" id="autocomplete-tipo"></div>
                      </div>
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label>Categora: *</label>
                        <select class="form-control form-categoria-select" id="categoria" required onchange="app.mostrarEjemplosCategoria(this.value)" aria-label="Seleccionar categora del repuesto">
                          <option value="">Seleccionar categora...</option>
                          <option value="Repuesto">REPUESTO</option>
                          <option value="Insumo">INSUMO</option>
                          <option value="Herramienta">HERRAMIENTA</option>
                          <option value="EPP">EPP</option>
                          <option value="Qumico">QUMICO</option>
                        </select>
                        <small id="ejemplosCategoria" class="form-ejemplos-small">Selecciona una categora para ver ejemplos</small>
                      </div>

                      <div class="form-group">
                        <label>Nombre/Descripcin: *</label>
                        <input type="text" class="form-control" id="nombre" required placeholder="Descripcin detallada del repuesto">
                      </div>
                    </div>
                  </section>

                  <section class="form-section form-section--half">
                    <div class="form-section-header">
                      <h3 class="form-section-title">Datos tcnicos</h3>
                      <p class="form-section-description">Agrega especificaciones relevantes para mantenimiento, compras o montaje.</p>
                    </div>
                    
                    <!-- 🔧 Número de Equipo - NUEVO -->
                    <div class="form-group">
                      <label class="form-label-row">
                        <span>Número de Equipo:</span>
                        <small class="form-label-optional">(Opcional - Identificador de máquina/equipo)</small>
                      </label>
                      <input type="text" class="form-control" id="numEquipo" placeholder="Ej: EQ-001, BOMBA-2340, MOTOR-A15">
                      <small class="form-textarea-hint">Identificador único del equipo donde se usa este repuesto</small>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label-row">
                        <span>Datos Tcnicos Especficos:</span>
                        <small class="form-label-optional">(Opcional - Para motores, cintas, etc.)</small>
                      </label>
                      <textarea class="form-control form-textarea-tech" id="datosTecnicos" rows="3" placeholder="Ej: Motor 0.75 kW, 380V, 1400 RPM, IP55&#10;Marca: WEG, Modelo: W22&#10;Rodamientos: 6204 y 6205"></textarea>
                      <small class="form-textarea-hint">Puedes incluir: potencia, voltaje, RPM, marca, modelo, dimensiones, especificaciones tcnicas, etc.</small>
                    </div>

                    <!-- Botón Guardar en Step 1 -->
                    <div class="step-actions-bottom">
                      <button type="button" id="saveRepuestoStep1" class="btn btn-primary btn-lg">
                        💾 Guardar Repuesto
                      </button>
                    </div>
                  </section>
                </div>

                <div class="wizard-step" data-step="2">
                  <section class="form-section form-section--full">
                    <div class="form-section-header">
                      <h3 class="form-section-title">Stock y polticas</h3>
                      <p class="form-section-description">Controla inventario fsico, cantidades instaladas y parmetros mnimos para alertas.</p>
                    </div>
                    <div class="form-stock-grid">
                      <div class="form-group">
                        <label>Stock Actual: *</label>
                        <input type="number" class="form-control" id="cantidad" min="0" required placeholder="0">
                      </div>

                      <div class="form-group">
                        <label>Instalados:</label>
                        <input type="number" class="form-control" id="cantidadInstalada" min="0" value="0" placeholder="0" title="Cantidad de repuestos actualmente instalados/en uso">
                      </div>

                      <div class="form-group">
                        <label>Mnimo: *</label>
                        <input type="number" class="form-control" id="minimo" min="0" value="5" required placeholder="5">
                      </div>

                      <div class="form-group">
                        <label>ptimo:</label>
                        <input type="number" class="form-control" id="optimo" min="0" value="10" placeholder="10">
                      </div>

                      <div class="form-group precio-info">
                        <label>Precio ($):</label>
                        <input type="number" class="form-control" id="precio" min="0" step="0.01" value="0" placeholder="0.00">
                      </div>
                    </div>
                    <small class="form-hint-small"> <strong>Instalados:</strong> Cantidad en uso. <strong>ptimo:</strong> Nivel recomendado para asegurar continuidad operativa.</small>

                    <!-- Botón Guardar en Step 2 -->
                    <div class="step-actions-bottom">
                      <button type="button" id="saveRepuestoStep2" class="btn btn-primary btn-lg">
                        💾 Guardar Repuesto
                      </button>
                    </div>
                  </section>
                </div>

                <div class="wizard-step" data-step="3">
                  <section class="form-section form-section--full">
                    
                    <!-- 💡 PANEL DE AYUDA: ÁREAS GENÉRICAS -->
                    <div style="padding: 14px 18px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(16,185,129,0.3); box-shadow: 0 4px 12px rgba(16,185,129,0.15);">
                      <div style="color: white; font-size: 0.9rem;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                          <span style="font-size: 1.4rem;">💡</span>
                          <strong style="font-size: 1rem;">¿Elementos de uso general sin equipo específico?</strong>
                        </div>
                        <div style="font-size: 0.87rem; opacity: 0.95; line-height: 1.6; margin-bottom: 12px;">
                          Si este repuesto es de uso general (pernos, tornillos, consumibles, etc.) y no pertenece a un equipo específico, puedes crear <strong>áreas genéricas</strong> para organizarlos mejor.
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 0.82rem;">
                          <div style="background: rgba(255,255,255,0.18); padding: 8px 12px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2);">
                            <strong>🔧 Elementos Comunes</strong>
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 2px;">Para uso transversal</div>
                          </div>
                          <div style="background: rgba(255,255,255,0.18); padding: 8px 12px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2);">
                            <strong>🔩 Pernería General</strong>
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 2px;">Pernos, tuercas, arandelas</div>
                          </div>
                          <div style="background: rgba(255,255,255,0.18); padding: 8px 12px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2);">
                            <strong>📦 Consumibles</strong>
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 2px;">Limpieza, lubricantes</div>
                          </div>
                        </div>
                        <div style="margin-top: 12px; padding: 8px 12px; background: rgba(0,0,0,0.15); border-radius: 5px; font-size: 0.78rem; opacity: 0.95; line-height: 1.5;">
                          <strong>ℹ️ Flexibilidad:</strong> Un mismo elemento puede estar en área genérica Y como repuesto específico de un equipo. Ejemplo: "Perno M8" en <em>"Pernería General"</em> y también en <em>"Baader 142 → Motor Principal"</em>.
                        </div>
                      </div>
                    </div>
                    
                    <div class="ubicaciones-section-visual">
                      <!-- Panel de ubicaciones asignadas -->
                      <div id="ubicacionesAsignadas" class="ubicaciones-asignadas-panel" style="display: none;">
                        <div class="ubicaciones-asignadas-header">
                          <span class="ubicaciones-icon">📍</span>
                          <span class="ubicaciones-label">Ubicaciones asignadas:</span>
                          <span id="ubicacionesCount" class="ubicaciones-count">0</span>
                          <button type="button" id="btnAgregarOtraUbicacion" onclick="window.app.agregarOtraUbicacion()" class="btn btn-primary btn-sm" style="margin-left: auto;">
                            ➕ Agregar otra ubicación
                          </button>
                        </div>
                        <div id="ubicacionesAsignadasList" class="ubicaciones-asignadas-list">
                          <!-- Lista de ubicaciones asignadas se renderizará aquí -->
                        </div>
                      </div>

                      <!-- Selector Visual de Jerarquía -->
                      <div id="ubicacionesTreeContainer" class="ubicaciones-tree-selector">
                        <!-- Botón agregar área dentro del árbol -->
                        <div class="tree-actions-internal">
                          <button type="button" onclick="window.app.agregarNodoJerarquiaModal('area')" class="btn btn-success btn-sm">
                            ➕ Agregar Área
                          </button>
                        </div>
                        <!-- El árbol se renderizará aquí -->
                      </div>

                      <!-- Botón Guardar en Step 3 -->
                      <div class="step-actions-bottom">
                        <button type="button" id="saveRepuestoStep3" class="btn btn-primary btn-lg">
                          💾 Guardar Repuesto
                        </button>
                      </div>
                    </div>
                  </section>
                </div>

                <div class="wizard-step" data-step="4">
                  <section class="form-section form-section--full">
                    <div class="form-section-header">
                      <h3 class="form-section-title">Multimedia y soportes</h3>
                      <p class="form-section-description">Adjunta material visual o documental que facilite inspecciones, compras y capacitacin.</p>
                    </div>
                    <div class="form-multimedia-grid">
                      <div class="form-group">
                        <label class="form-label-space-between">
                          <span>Imgenes</span>
                          <small id="image-upload-mode" class="form-upload-mode" title="Optimizacin automtica WebP">WebP Auto</small>
                        </label>

                        <div class="image-upload-zone" onclick="document.getElementById('imagenFile').click()">
                          <div class="upload-icon"></div>
                          <div class="upload-text">Click para seleccionar imgenes</div>
                          <div class="upload-hint">Formatos: JPG, PNG, WebP (mx. 10MB)</div>
                        </div>

                        <input type="file"
                               class="form-input-hidden"
                               id="imagenFile"
                               accept="image/*"
                               multiple
                               onchange="app.handleImageWithOptimizer(event)"
                               aria-label="Seleccionar imgenes">

                        <div id="imagePreview" class="multimedia-preview multimedia-preview-margin"></div>
                      </div>

                      <div class="form-group">
                        <label class="form-label-margin">Documentos</label>
                        <input type="file" class="form-control form-input-file" id="documentos" accept=".pdf,.doc,.docx,.xls,.xlsx,video/*" multiple onchange="app.handleMultimedia(event, 'document')" aria-label="Seleccionar documentos">
                        <div id="documentsList" class="documents-list"></div>
                      </div>
                    </div>

                    <div id="optimizerModal" class="optimizer-modal">
                      <div class="optimizer-content">
                        <div class="optimizer-header">
                          <h3>Optimizador de Imgenes</h3>
                          <button type="button" class="optimizer-close" onclick="window.app.closeOptimizer()" title="Cerrar optimizador" aria-label="Cerrar optimizador"></button>
                        </div>

                        <div class="optimizer-body">
                          <div class="optimizer-preview">
                            <div class="preview-original">
                              <h4>Original</h4>
                              <img id="optimizerOriginal" src="" alt="Original">
                              <div class="preview-info">
                                <span id="originalSize">-</span>
                                <span id="originalDimensions">-</span>
                              </div>
                            </div>

                            <div class="preview-arrow"></div>

                            <div class="preview-optimized">
                              <h4>Optimizada</h4>
                              <img id="optimizerOptimized" src="" alt="Optimizada">
                              <div class="preview-info">
                                <span id="optimizedSize">-</span>
                                <span id="optimizedDimensions">-</span>
                              </div>
                              <div class="savings-badge" id="savingsBadge">Ahorro: <strong>0%</strong></div>
                            </div>
                          </div>

                          <div class="optimizer-controls">
                            <div class="control-group">
                              <label>Tamao de optimizacin:</label>
                              <div class="size-options">
                                <button type="button" class="size-btn" data-size="800" onclick="window.app.setOptimizeSize(800)">
                                  <span>Pequeo</span>
                                  <small>800px</small>
                                </button>
                                <button type="button" class="size-btn active" data-size="1200" onclick="window.app.setOptimizeSize(1200)">
                                  <span>Mediano</span>
                                  <small>1200px</small>
                                </button>
                                <button type="button" class="size-btn" data-size="1600" onclick="window.app.setOptimizeSize(1600)">
                                  <span>Grande</span>
                                  <small>1600px</small>
                                </button>
                                <button type="button" class="size-btn" data-size="original" onclick="window.app.setOptimizeSize('original')">
                                  <span>Original</span>
                                  <small>Sin redimensionar</small>
                                </button>
                              </div>
                            </div>

                            <div class="control-group">
                              <label for="qualitySlider">Calidad WebP: <span id="qualityValue">85%</span></label>
                              <input type="range" id="qualitySlider" min="60" max="95" value="85" oninput="app.updateQuality(this.value)">
                              <small>60% (mxima compresin) - 95% (mxima calidad)</small>
                            </div>
                          </div>
                        </div>

                        <div class="optimizer-footer">
                          <button type="button" class="btn btn-secondary" onclick="window.app.skipOptimization()">Usar Original</button>
                          <button type="button" class="btn btn-success" onclick="window.app.applyOptimization()">Aplicar Optimizacin</button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Botón Guardar en Step 4 -->
                    <div class="step-actions-bottom">
                      <!-- 🎯 Botón de flujo guiado: Guardar y continuar a Jerarquía -->
                      <button type="button" id="saveAndContinueJerarquia" class="btn btn-success btn-lg" style="display: none;">
                        <span class="btn-text">💾 Guardar y Asignar Jerarquía →</span>
                        <span class="btn-loading" style="display: none;">
                          <span class="spinner-border spinner-border-sm"></span> Guardando...
                        </span>
                      </button>
                      
                      <!-- Botón normal de guardar -->
                      <button type="button" id="saveRepuestoStep4" class="btn btn-primary btn-lg">
                        <span class="btn-text">💾 Guardar Repuesto</span>
                        <span class="btn-loading" style="display: none;">
                          <span class="spinner-border spinner-border-sm"></span> Guardando...
                        </span>
                      </button>
                    </div>
                  </section>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox">
  <button class="lsimpx-close" onclick="window.app.closeLightbox()" title="Cerrar visor" aria-label="Cerrar visor"></button>
  <button class="lightbox-nav lightbox-prev" onclick="window.app.lightboxPrev()" title="Imagen anterior" aria-label="Imagen anterior"></button>
  <button class="lightbox-nav lightbox-next" onclick="window.app.lightboxNext()" title="Imagen siguiente" aria-label="Imagen siguiente"></button>
  <div class="lightbox-content" id="lightboxContent"></div>
  <div class="lightbox-counter" id="lightboxCounter"></div>
</div>

<!-- MODAL JERARQUA VISUAL CASCADA -->
<div id="modalJerarquiaVisual" class="modal-overlay" onclick="if(event.target.id === 'modalJerarquiaVisual') this.style.display='none'">
  <div class="modal-container" onclick="event.stopPropagation()">
    
    <!-- Header con gradiente -->
    <div class="modal-header">
      <h3 class="modal-title">
        <span class="modal-icon"></span>
        <span>Ubicacin del Repuesto</span>
      </h3>
      <button onclick="document.getElementById('modalJerarquiaVisual').style.display='none'" 
        class="modal-close-btn" title="Cerrar dialogo" aria-label="Cerrar dialogo">
        
      </button>
    </div>
    
    <!-- Contenido de la jerarqua cascada -->
    <div id="jerarquiaContent" class="modal-content">
      <!-- Se llenar dinmicamente con la estructura de rbol -->
    </div>
  </div>
</div>

<!-- MODAL ESTADSTICAS -->
<div id="modalEstadisticas" class="modal-overlay" onclick="if(event.target.id === 'modalEstadisticas') this.style.display='none'">
  <div class="modal-container modal-container-large" onclick="event.stopPropagation()">
    
    <!-- Header -->
    <div class="modal-header-stats">
      <div class="modal-header-row">
        <h2 class="modal-title-large">
          <span class="modal-icon-large"></span>
          <span>Estadsticas de Almacenamiento</span>
        </h2>
  <button onclick="document.getElementById('modalEstadisticas').style.display='none'" 
    class="modal-close-btn-large" title="Cerrar dialogo" aria-label="Cerrar dialogo">
          
        </button>
      </div>
    </div>
    
    <!-- Content con scroll -->
    <div id="estadisticasContent" class="modal-content-flex">
      <!-- Contenido dinmico -->
    </div>
    
    <!-- Footer -->
    <div class="modal-footer">
      <button onclick="document.getElementById('modalEstadisticas').style.display='none'" class="btn btn-primary modal-footer-btn">
         Cerrar
      </button>
    </div>
  </div>
</div>

<!-- MODAL CASCADA JERRQUICA -->
<div id="modalCascada" class="modal-overlay modal-overlay-highest" onclick="if(event.target.id === 'modalCascada') this.style.display='none'">
  <div class="modal-container modal-container-xlarge" onclick="event.stopPropagation()">
    
    <!-- Header simplificado -->
    <div class="modal-header-cascada">
      <h3 class="modal-title-cascada">
         Cascada de reas
      </h3>
      <button onclick="document.getElementById('modalCascada').style.display='none'" 
        class="modal-close-btn-simple" title="Cerrar dialogo" aria-label="Cerrar dialogo">
        
      </button>
    </div>
    
    <!-- Barra de bsqueda y botones -->
    <div class="cascada-toolbar">
      <!-- Info de elementos -->
      <div id="cascadaStats" class="cascada-stats">
        <span> <strong id="statsAreas">0</strong> reas</span>
        <span> <strong id="statsMarcadores">0</strong> marcadores</span>
        <span> <strong id="statsSinJerarquia">0</strong> sin nivel asignado</span>
      </div>
      
      <input 
        id="cascadaSearchInput" 
        type="text" 
        placeholder=" Buscar rea o marcador..."
        class="cascada-search-input"
        onkeyup="mapController.filterCascada(this.value)"
      />
      
      <div class="cascada-buttons">
        <button onclick="mapController.expandAllCascada()" class="cascada-btn">
           Expandir todo
        </button>
        <button onclick="mapController.collapseAllCascada()" class="cascada-btn">
           Colapsar todo
        </button>
        <button onclick="mapController.toggleMostrarSoloConJerarquia()" id="btnToggleVacias" class="cascada-btn">
           Ocultar vacas
        </button>
        <button onclick="mapController.exportCascada()" class="cascada-btn">
           Exportar
        </button>
      </div>
    </div>
    
    <!-- Content con scroll -->
    <div id="cascadaContent" class="modal-content-cascada">
      <!-- Contenido dinmico generado por renderHierarchyTree -->
    </div>
    
    <!-- Footer simplificado -->
    <div class="modal-footer-simple">
      <button onclick="document.getElementById('modalCascada').style.display='none'" class="modal-footer-btn-simple">
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- MODAL PARA GESTIONAR JERARQUA -->
<div class="modal" id="modalJerarquia">
  <div class="modal-content">
  <button class="modal-close" onclick="window.app.closeJerarquiaModal()" title="Cerrar dialogo" aria-label="Cerrar dialogo"></button>
    
    <header class="sap-modal-header">
      <div class="sap-header-row">
        <div class="sap-header-leading">
          <span class="sap-header-eyebrow">Configuracin</span>
          <h2 class="sap-header-title">Gestionar Niveles Jerrquicos</h2>
        </div>
      </div>
      <p class="sap-header-subtitle">Mantn alineados los catlogos por nivel: cada cambio se replica en formularios, sugerencias y rutas en cascada.</p>
    </header>

    <div class="jerarquia-manager">
      <div class="jerarquia-toolbar">
        <div class="jerarquia-toolbar-top">
          <div class="jerarquia-toolbar-text">
            Ajusta los nombres oficiales por nivel y usa el buscador para saltar directo al registro que necesitas.
            <div class="jerarquia-toolbar-hint">Tip: reordena arrastrando, crea subniveles para ramificaciones frecuentes y todo quedará disponible en formularios y mapas.</div>
          </div>
          <div class="jerarquia-toolbar-actions">
            <div class="jerarquia-search" id="jerarquiaSearchWrapper">
              <span class="jerarquia-search-icon" aria-hidden="true">🔎</span>
              <input type="search" id="jerarquiaModalSearchInput" class="jerarquia-search-input" placeholder="Buscar nivel o subnivel..." oninput="app.handleJerarquiaModalSearch(this.value)" autocomplete="off" aria-label="Buscar en jerarquía" />
              <button type="button" class="jerarquia-search-clear" onclick="window.app.clearJerarquiaModalSearch()" title="Limpiar bsqueda">×</button>
            </div>
            <button type="button" class="jerarquia-toolbar-btn" onclick="window.app.expandAllJerarquiaItems()">Expandir todo</button>
            <button type="button" class="jerarquia-toolbar-btn" onclick="window.app.collapseAllJerarquiaItems()">Colapsar todo</button>
          </div>
        </div>
        <div class="jerarquia-toolbar-stats" id="jerarquiaStatsPills">
          <!-- pills dinámicos -->
        </div>
      </div>
      <div class="jerarquia-results" id="jerarquiaResultsSummary"></div>

      <!-- Tabs para cada nivel -->
      <div class="jerarquia-tabs jerarquia-tabs-wrapper">
        <button class="jerarquia-tab active" data-level="1" onclick="window.app.switchJerarquiaLevel(1)">
          <span class="tab-icon">🏢</span>
          <span class="tab-label">N1<br><small>Empresa</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="2" onclick="window.app.switchJerarquiaLevel(2)">
          <span class="tab-icon">🏭</span>
          <span class="tab-label">N2<br><small>Área</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="3" onclick="window.app.switchJerarquiaLevel(3)">
          <span class="tab-icon">📍</span>
          <span class="tab-label">N3<br><small>Sub-área</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="4" onclick="window.app.switchJerarquiaLevel(4)">
          <span class="tab-icon">⚙️</span>
          <span class="tab-label">N4<br><small>Sistema</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="5" onclick="window.app.switchJerarquiaLevel(5)">
          <span class="tab-icon">🔧</span>
          <span class="tab-label">N5<br><small>Sub-sistema</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="6" onclick="window.app.switchJerarquiaLevel(6)">
          <span class="tab-icon">📦</span>
          <span class="tab-label">N6<br><small>Sección</small></span>
          <span class="tab-chevron">›</span>
        </button>
        <button class="jerarquia-tab" data-level="7" onclick="window.app.switchJerarquiaLevel(7)">
          <span class="tab-icon">🔩</span>
          <span class="tab-label">N7<br><small>Sub-sección</small></span>
          <span class="tab-chevron">›</span>
        </button>
      </div>

      <!-- Contenido del nivel actual -->
      <div class="jerarquia-content">
        <div class="jerarquia-level-header">
          <h3 id="jerarquiaLevelTitle">N1 - Empresa</h3>
          <button class="btn btn-primary" onclick="window.app.addJerarquiaItem()">
             Agregar Nuevo
          </button>
        </div>

        <!-- Formulario para agregar -->
        <div id="jerarquiaForm" class="jerarquia-form">
          <div class="form-group">
            <label for="jerarquiaItemName">Nombre:</label>
            <input type="text" id="jerarquiaItemName" class="form-control" placeholder="Ingrese el nombre...">
          </div>
          <div class="form-group">
            <label for="jerarquiaItemDesc">Descripcin (opcional):</label>
            <textarea id="jerarquiaItemDesc" class="form-control" rows="2" placeholder="Descripcin adicional..."></textarea>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-primary" onclick="window.app.saveJerarquiaItem()">Guardar</button>
            <button type="button" class="btn btn-secondary" onclick="window.app.cancelJerarquiaItem()">Cancelar</button>
          </div>
        </div>

        <!-- Lista de items del nivel -->
        <div id="jerarquiaList" class="jerarquia-list">
          <!-- Se llena dinmicamente -->
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="window.app.closeJerarquiaModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Script visualTreeV2.js removido - funcionalidad integrada en el código principal -->

<!-- Inicializar sistema de eventos ANTES de cargar módulos -->
<script>
// ========================================================================
//  VERSIÓN DE LA APLICACIÓN - CAMBIAR SOLO AQUÍ
// ========================================================================
window.APP_VERSION = 'v6.122';
window.CACHE_VERSION = 'inventario-v6.122';
window.APP_BUILD = 122; // Número de build para comparación numérica
console.log(`🚀 Iniciando aplicación ${window.APP_VERSION}`);

// ========================================================================
//  SISTEMA DE EVENTOS GLOBAL
// ========================================================================
if (!window.appEvents) {
  window.appEvents = new EventTarget();
  console.log('✅ Sistema de eventos global creado');
}
</script>

<!-- Cargar módulo de sincronización de jerarquía (sin ES6 modules para compatibilidad file://) -->
<script src="./modules/hierarchy-sync.js"></script>

<!-- Cargar módulo de UI para Tab Mapas -->
<script src="./modules/mapas-ui.js"></script>

<!-- 🚀 Cargar módulo de mejoras avanzadas -->
<script src="./modules/map-enhancements.js"></script>

<script>
// @ts-nocheck

const EMBEDDED_DATA = {
  version: '1.0-mobile',
  lastUpdate: new Date().toISOString(),
  platform: 'mobile-embedded',
  note: 'Datos sin multimedia - Solo texto y nmeros para mxima compatibilidad',
  repuestos: []
};

class IndexedDBImageManager {
  constructor() {
    this.dbName = 'InventarioImagenes';
    this.dbVersion = 1;
    this.storeName = 'images';
    this.db = null;
  }

  async init() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.dbVersion);
      
      request.onerror = () => {
        console.error(' Error al abrir IndexedDB:', request.error);
        reject(request.error);
      };
      
      request.onsuccess = () => {
        this.db = request.result;
        console.log(' IndexedDB inicializada correctamente');
        resolve(this.db);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(this.storeName)) {
          const objectStore = db.createObjectStore(this.storeName, { keyPath: 'id' });
          objectStore.createIndex('repuestoId', 'repuestoId', { unique: false });
          objectStore.createIndex('timestamp', 'timestamp', { unique: false });
          console.log(' Object store "images" creado');
        }
      };
    });
  }

  async saveImage(imageId, repuestoId, file) {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      
      reader.onload = () => {
        const transaction = this.db.transaction([this.storeName], 'readwrite');
        const store = transaction.objectStore(this.storeName);
        
        const imageData = {
          id: imageId,
          repuestoId: repuestoId,
          data: reader.result, // base64 string
          type: file.type,
          size: file.size,
          name: file.name,
          timestamp: Date.now()
        };
        
        const request = store.put(imageData);
        
        request.onsuccess = () => {
          console.log(` Imagen guardada en IndexedDB: ${imageId}`);
          resolve(true);
        };
        
        request.onerror = () => {
          console.error(` Error al guardar imagen ${imageId}:`, request.error);
          reject(request.error);
        };
      };
      
      reader.onerror = () => reject(reader.error);
      reader.readAsDataURL(file); // Convierte a base64
    });
  }

  async getImage(imageId) {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([this.storeName], 'readonly');
      const store = transaction.objectStore(this.storeName);
      const request = store.get(imageId);
      
      request.onsuccess = () => {
        if (request.result) {
          const blob = this.base64ToBlob(request.result.data, request.result.type);
          const blobUrl = URL.createObjectURL(blob);
          resolve({
            url: blobUrl,
            blob: blob,
            metadata: {
              type: request.result.type,
              size: request.result.size,
              name: request.result.name,
              timestamp: request.result.timestamp
            }
          });
        } else {
          resolve(null);
        }
      };
      
      request.onerror = () => reject(request.error);
    });
  }

  async getImagesByRepuesto(repuestoId) {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([this.storeName], 'readonly');
      const store = transaction.objectStore(this.storeName);
      const index = store.index('repuestoId');
      const request = index.getAll(repuestoId);
      
      request.onsuccess = () => {
        const images = request.result.map(img => ({
          id: img.id,
          url: this.base64ToBlob(img.data, img.type),
          metadata: {
            type: img.type,
            size: img.size,
            name: img.name,
            timestamp: img.timestamp
          }
        }));
        resolve(images);
      };
      
      request.onerror = () => reject(request.error);
    });
  }

  async deleteImage(imageId) {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([this.storeName], 'readwrite');
      const store = transaction.objectStore(this.storeName);
      const request = store.delete(imageId);
      
      request.onsuccess = () => {
        console.log(` Imagen eliminada de IndexedDB: ${imageId}`);
        resolve(true);
      };
      
      request.onerror = () => reject(request.error);
    });
  }

  async getStorageStats() {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([this.storeName], 'readonly');
      const store = transaction.objectStore(this.storeName);
      const request = store.getAll();
      
      request.onsuccess = () => {
        const images = request.result;
        const totalSize = images.reduce((acc, img) => acc + img.size, 0);
        const totalCount = images.length;
        
        resolve({
          count: totalCount,
          size: totalSize,
          sizeFormatted: this.formatBytes(totalSize),
          images: images.map(img => ({
            id: img.id,
            repuestoId: img.repuestoId,
            size: img.size,
            timestamp: img.timestamp
          }))
        });
      };
      
      request.onerror = () => reject(request.error);
    });
  }

  async clearAll() {
    if (!this.db) await this.init();
    
    return new Promise((resolve, reject) => {
      const transaction = this.db.transaction([this.storeName], 'readwrite');
      const store = transaction.objectStore(this.storeName);
      const request = store.clear();
      
      request.onsuccess = () => {
        console.log(' Todas las imgenes eliminadas de IndexedDB');
        resolve(true);
      };
      
      request.onerror = () => reject(request.error);
    });
  }

  base64ToBlob(base64, mimeType) {
    const byteString = atob(base64.split(',')[1]);
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
      ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], { type: mimeType });
  }

  formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
}

class FileSystemManager {
  constructor() {
    this.directoryHandle = null;
    this.imagesFolder = null;
    this.isFileSystemMode = false;
    this.folderPath = '';
    this.dbName = 'InventarioFS';
    this.dbVersion = 1;
  }

  //  AGREGADO PARA COMPATIBILIDAD CON MAPSTORAGE
  get storageHandle() {
    return this.directoryHandle;
  }

  get isConnected() {
    return this.isFileSystemMode && !!this.directoryHandle;
  }
  // FIN AGREGADO PARA MAPSTORAGE

  async saveDirectoryHandle(handle) {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.dbVersion);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        const db = request.result;
        const transaction = db.transaction(['directories'], 'readwrite');
        const store = transaction.objectStore('directories');
        store.put({ id: 'main', handle: handle, timestamp: Date.now() });
        transaction.oncomplete = () => resolve(true);
        transaction.onerror = () => reject(transaction.error);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('directories')) {
          db.createObjectStore('directories', { keyPath: 'id' });
        }
      };
    });
  }

  async loadDirectoryHandle() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.dbVersion);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        const db = request.result;
        const transaction = db.transaction(['directories'], 'readonly');
        const store = transaction.objectStore('directories');
        const getRequest = store.get('main');
        
        getRequest.onsuccess = () => {
          resolve(getRequest.result?.handle || null);
        };
        getRequest.onerror = () => reject(getRequest.error);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('directories')) {
          db.createObjectStore('directories', { keyPath: 'id' });
        }
      };
    });
  }

  async restoreFromPreviousSession() {
    try {
      const savedHandle = await this.loadDirectoryHandle();
      if (!savedHandle) {
        console.log('No hay carpeta guardada previamente');
        return false;
      }

      const permission = await savedHandle.queryPermission({ mode: 'readwrite' });
      
      if (permission === 'granted') {
        this.directoryHandle = savedHandle;
        await this.ensureImageFolder();
        this.folderPath = this.directoryHandle.name;
        this.isFileSystemMode = true;
        this.updateStatusIndicator(true, this.folderPath);
        console.log(' Sesin FileSystem restaurada automticamente:', this.folderPath);
        return true;
      } else if (permission === 'prompt') {
        const hasUserActivation = Boolean(navigator.userActivation?.isActive);
        if (!hasUserActivation) {
          console.warn(' Se requiere interaccin del usuario para volver a solicitar permisos.');
          if (typeof app !== 'undefined' && typeof app.showToast === 'function') {
            app.showToast('Debes usar "Conectar Carpeta" para reactivar los permisos.', 'warning');
          }
          this.updateStatusIndicator(false);
          return false;
        }

        const newPermission = await savedHandle.requestPermission({ mode: 'readwrite' });
        if (newPermission === 'granted') {
          this.directoryHandle = savedHandle;
          await this.ensureImageFolder();
          this.folderPath = this.directoryHandle.name;
          this.isFileSystemMode = true;
          this.updateStatusIndicator(true, this.folderPath);
          console.log(' Permisos re-otorgados, sesin restaurada:', this.folderPath);
          return true;
        }
      }
      
  console.log('[WARN] Permisos denegados, necesita reactivar manualmente');
      return false;
    } catch (error) {
      console.error('Error restaurando sesin:', error);
      return false;
    }
  }

  updateStatusIndicator(connected, path = '') {
    const btn = document.getElementById('connectionBtn');
    const icon = document.getElementById('connectionIcon');

    if (btn && icon) {
      if (connected) {
        //  Verde con gradiente Neomorphism
        btn.style.background = 'linear-gradient(145deg, #10b981, #059669)';
        btn.style.color = 'white';
        btn.title = path ? ` Conectado: ${path}` : ' Conectado';
        icon.textContent = '';
      } else {
        //  Rojo con gradiente Neomorphism
        btn.style.background = 'linear-gradient(145deg, #ef4444, #dc2626)';
        btn.style.color = 'white';
        btn.title = ' No conectado';
        icon.textContent = '';
      }
    }
  }

  async selectFolder() {
    try {
      const selectedFolder = await window.showDirectoryPicker({ mode: 'readwrite' });
      console.log(' Carpeta seleccionada por usuario:', selectedFolder.name);
      
      let workingFolder = selectedFolder;
      let detectedPath = selectedFolder.name;
      
      if (selectedFolder.name === 'INVENTARIO_PORTABLE') {
        console.log(' Detectado INVENTARIO_PORTABLE, buscando INVENTARIO_STORAGE dentro...');
        try {
          const storageFolder = await selectedFolder.getDirectoryHandle('INVENTARIO_STORAGE', { create: false });
          workingFolder = storageFolder;
          detectedPath = `${selectedFolder.name}/${storageFolder.name}`;
          console.log(' INVENTARIO_STORAGE encontrado automticamente!');
        } catch (e) {
          console.warn(' INVENTARIO_STORAGE no encontrada, crendola...');
          const storageFolder = await selectedFolder.getDirectoryHandle('INVENTARIO_STORAGE', { create: true });
          workingFolder = storageFolder;
          detectedPath = `${selectedFolder.name}/${storageFolder.name}`;
          console.log(' INVENTARIO_STORAGE creada automticamente!');
        }
      } else if (selectedFolder.name === 'INVENTARIO_STORAGE') {
        console.log(' INVENTARIO_STORAGE seleccionada directamente');
      } else {
        console.log(' Buscando INVENTARIO_STORAGE dentro de', selectedFolder.name);
        try {
          const storageFolder = await selectedFolder.getDirectoryHandle('INVENTARIO_STORAGE', { create: false });
          workingFolder = storageFolder;
          detectedPath = `${selectedFolder.name}/${storageFolder.name}`;
          console.log(' INVENTARIO_STORAGE encontrado dentro de', selectedFolder.name);
        } catch (e) {
          console.log(' INVENTARIO_STORAGE no encontrada, usando carpeta seleccionada como est');
        }
      }
      
      this.directoryHandle = workingFolder;
      await this.ensureImageFolder();
      
      await this.saveDirectoryHandle(this.directoryHandle);
      localStorage.setItem('fsDirectory', 'enabled');
      
      this.folderPath = detectedPath;
      localStorage.setItem('fsFolderName', this.folderPath);
      
      this.isFileSystemMode = true;
      console.log(' Sistema configurado con carpeta:', detectedPath);
      
      this.updateStatusIndicator(true, detectedPath);
      
      return true;
    } catch (error) {
      console.error('Error seleccionando carpeta:', error);
      this.updateStatusIndicator(false);
      return false;
    }
  }

  async ensureImageFolder() {
    try {
      this.imagesFolder = await this.directoryHandle.getDirectoryHandle('imagenes', { create: true });
      console.log(' Carpeta "imagenes" accesible:', this.imagesFolder);
      
      let count = 0;
      for await (const entry of this.imagesFolder.values()) {
        count++;
        if (count <= 3) {
          console.log(`    Encontrado: ${entry.name}`);
        }
      }
      console.log(`    Total de archivos en carpeta imagenes: ${count}`);
    } catch (error) {
      console.error(' Error accediendo a carpeta imagenes:', error);
      this.imagesFolder = null;
    }
  }

  async saveJSON(data) {
    if (!this.isFileSystemMode) {
      return false; // No est en modo FileSystem
    }
    try {
      const fileHandle = await this.directoryHandle.getFileHandle('inventario.json', { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(JSON.stringify(data, null, 2));
      await writable.close();
      console.log(' JSON guardado en archivo: inventario.json');
      return true;
    } catch (error) {
      console.error(' Error guardando JSON en FileSystem:', error);
      return false;
    }
  }

  async saveImage(blob, filename) {
    if (!this.isFileSystemMode) return null;
    try {
      const fileHandle = await this.imagesFolder.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      console.log(' Imagen guardada:', filename);
      return './imagenes/' + filename;
    } catch (error) {
      console.error('Error guardando imagen:', error);
      return null;
    }
  }

  /**
   * Guarda imagen en carpeta jerrquica segn ubicacin
   */
  async saveImageJerarquica(blob, filename, carpetaDestino) {
    if (!this.isFileSystemMode) return null;
    try {
      const fileHandle = await carpetaDestino.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      console.log(' Imagen guardada en carpeta jerrquica:', filename);
      return filename;
    } catch (error) {
      console.error('Error guardando imagen en carpeta jerrquica:', error);
      return null;
    }
  }

  /**
   * Lee un archivo desde el File System Access API
   * @param {string|Array} imagePath - Ruta del archivo (string con / o array de segmentos)
   * @returns {Promise<Blob|null>} - Blob del archivo o null si falla
   */
  async readFile(imagePath) {
    if (!this.isFileSystemMode) {
      console.warn(' FileSystem no est activo');
      return null;
    }

    try {
      // Convertir path string a array de segmentos
      const segments = Array.isArray(imagePath) 
        ? imagePath 
        : String(imagePath || '').split('/').filter(Boolean);

      if (!segments.length) {
        console.warn(' Ruta de imagen vaca');
        return null;
      }

      // Navegar por la jerarqua de carpetas
      let currentDir = this.directoryHandle;
      
      for (let i = 0; i < segments.length - 1; i++) {
        const folderName = segments[i];
        currentDir = await currentDir.getDirectoryHandle(folderName, { create: false });
      }

      // Obtener el archivo final
      const fileName = segments[segments.length - 1];
      const fileHandle = await currentDir.getFileHandle(fileName, { create: false });
      const file = await fileHandle.getFile();
      
      return file;
    } catch (error) {
      console.error(' Error leyendo archivo:', imagePath, error);
      return null;
    }
  }

  async deleteImage(imagePath) {
    if (!this.isFileSystemMode) return false;
    try {
      const filename = imagePath.replace('./imagenes/', '').replace('imagenes/', '');
      
      if (!filename) {
        console.warn(' Nombre de archivo invlido:', imagePath);
        return false;
      }
      
      console.log(` Intentando eliminar archivo: ${filename}`);
      
      await this.imagesFolder.removeEntry(filename);
      console.log(` Archivo eliminado del FileSystem: ${filename}`);
      return true;
    } catch (error) {
      if (error.name === 'NotFoundError') {
        console.warn(` Archivo no encontrado (ya estaba eliminado): ${imagePath}`);
        return true; // Considerar como xito si ya no existe
      }
      console.error(' Error eliminando imagen del FileSystem:', error);
      return false;
    }
  }

  async deleteMultipleImages(imagePaths) {
    if (!this.isFileSystemMode) return { deleted: 0, failed: 0 };
    
    let deleted = 0;
    let failed = 0;
    
    console.log(` Eliminando ${imagePaths.length} imgenes del FileSystem...`);
    
    for (const imagePath of imagePaths) {
      const success = await this.deleteImage(imagePath);
      if (success) {
        deleted++;
      } else {
        failed++;
      }
    }
    
    console.log(` Eliminadas: ${deleted} |  Fallidas: ${failed}`);
    return { deleted, failed };
  }

  async getAllImagesInFolder() {
    if (!this.isFileSystemMode) return [];
    
    try {
      const images = [];
      for await (const entry of this.imagesFolder.values()) {
        if (entry.kind === 'file') {
          images.push(entry.name);
        }
      }
      return images;
    } catch (error) {
      console.error('Error listando imgenes:', error);
      return [];
    }
  }

  async cleanOrphanImages(repuestos) {
    if (!this.isFileSystemMode) return { orphans: 0, deleted: 0, failed: 0, size: 0 };
    
    console.log(' Buscando imgenes hurfanas...');
    
    const allImages = await this.getAllImagesInFolder();
    console.log(` Total de imgenes en carpeta: ${allImages.length}`);
    
    const referencedImages = new Set();
    repuestos.forEach(r => {
      if (r.multimedia) {
        r.multimedia
          .filter(m => m.type === 'image' && m.isFileSystem && m.url)
          .forEach(m => {
            const filename = m.url.replace('./imagenes/', '').replace('imagenes/', '');
            referencedImages.add(filename);
          });
      }
    });
    console.log(` Imgenes referenciadas: ${referencedImages.size}`);
    
    const orphanImages = allImages.filter(img => !referencedImages.has(img));
    console.log(` Imgenes hurfanas encontradas: ${orphanImages.length}`);
    
    if (orphanImages.length === 0) {
      return { orphans: 0, deleted: 0, failed: 0, size: 0 };
    }
    
    let totalSize = 0;
    for (const filename of orphanImages) {
      try {
        const fileHandle = await this.imagesFolder.getFileHandle(filename);
        const file = await fileHandle.getFile();
        totalSize += file.size;
      } catch (error) {
        console.warn(` No se pudo leer tamao de: ${filename}`);
      }
    }
    
    let deleted = 0;
    let failed = 0;
    
    for (const filename of orphanImages) {
      try {
        await this.imagesFolder.removeEntry(filename);
        deleted++;
        console.log(` Eliminada hurfana: ${filename}`);
      } catch (error) {
        failed++;
        console.error(` Error eliminando: ${filename}`, error);
      }
    }
    
    console.log(` Limpieza completada: ${deleted} eliminadas, ${failed} fallidas`);
    console.log(` Espacio liberado: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
    
    return { 
      orphans: orphanImages.length, 
      deleted, 
      failed, 
      size: totalSize 
    };
  }
}

const fsManager = new FileSystemManager();
const indexedDBManager = new IndexedDBImageManager();

if (!('showDirectoryPicker' in window)) {
  indexedDBManager.init().then(() => {
    console.log(' IndexedDB Manager inicializado para modo mvil');
  }).catch(err => {
    console.error(' Error al inicializar IndexedDB:', err);
  });
}

const globalBlobCache = new Map();

// ============================================================
//  BUS DE EVENTOS GLOBAL - SINCRONIZAR PESTAÑAS
// ============================================================
const appEvents = (() => {
  const listeners = new Map();

  return {
    on(eventName, handler) {
      if (!eventName || typeof handler !== 'function') {
        return () => {};
      }

      if (!listeners.has(eventName)) {
        listeners.set(eventName, new Set());
      }

      const eventListeners = listeners.get(eventName);
      eventListeners.add(handler);

      return () => {
        eventListeners.delete(handler);
        if (eventListeners.size === 0) {
          listeners.delete(eventName);
        }
      };
    },

    emit(eventName, payload = {}) {
      const eventListeners = listeners.get(eventName);
      if (!eventListeners || eventListeners.size === 0) {
        return;
      }

      eventListeners.forEach((handler) => {
        try {
          handler(payload);
        } catch (error) {
          console.error('appEvents handler error:', eventName, error);
        }
      });
    }
  };
})();

// NO sobreescribir window.appEvents si ya es un EventTarget
// El EventTarget se crea antes en el HTML y es compatible con addEventListener
if (!(window.appEvents instanceof EventTarget)) {
  window.appEvents = appEvents;
}

// Funcin para obtener o crear Blob URL con cach global
async function getCachedBlobUrl(filename, loadFunction) {
  // NO usar caché para evitar problemas con "Tracking Prevention" de Edge
  // que bloquea blob URLs antiguos. Siempre generar blob fresco.
  const url = await loadFunction();
  
  if (url) {
    // Guardar referencia pero siempre generar nuevo blob
    globalBlobCache.set(filename, {
      url: url,
      timestamp: Date.now(),
      filename: filename
    });
    console.log(` [CACH GLOBAL] Blob fresco creado: ${filename} (Total: ${globalBlobCache.size})`);
  }
  return url;
}

function activarModoFileSystem() {
  if (!('showDirectoryPicker' in window)) {
    alert('Tu navegador no soporta FileSystem Access API.\n\nPor favor usa:\n Google Chrome 86+\n Microsoft Edge 86+');
    return;
  }
  fsManager.selectFolder().then(ok => {
    if (ok) {
      document.getElementById('fsBadge').style.display = 'inline';
      alert('Almacenamiento Ilimitado activado!\n\nAhora puedes agregar INFINITAS imgenes.\nCarpeta: ' + fsManager.folderPath);
    }
  });
}

// FUNCIN TOGGLE PARA ACTIVAR/DESACTIVAR ALMACENAMIENTO ILIMITADO
function toggleModoFileSystem() {
  if (fsManager.isFileSystemMode) {
    // Si est activo, mostrar confirmacin para desactivar
    const confirmar = confirm(
      'Almacenamiento Ilimitado ACTIVO\n\n' +
      'Deseas DESACTIVAR el almacenamiento ilimitado?\n\n' +
      'Se volver al modo localStorage (lmite 10MB)\n' +
      'Los datos guardados en la carpeta NO se perdern'
    );
    if (confirmar) {
      desactivarModoFileSystem();
    }
  } else {
    // Si est inactivo, activar
    activarModoFileSystem();
  }
}

//  FUNCIN PARA DESACTIVAR MODO FILESYSTEM
function desactivarModoFileSystem() {
  console.log(' Desactivando modo FileSystem...');
  
  // Limpiar estado del FileSystemManager
  fsManager.isFileSystemMode = false;
  fsManager.directoryHandle = null;
  fsManager.imagesFolder = null;
  fsManager.folderPath = null;
  
  // Limpiar localStorage
  localStorage.removeItem('fsDirectory');
  localStorage.removeItem('fsFolderName');
  
  // Eliminar base de datos IndexedDB
  const deleteRequest = indexedDB.deleteDatabase(fsManager.dbName);
  deleteRequest.onsuccess = () => {
    console.log(' Base de datos IndexedDB eliminada');
  };
  deleteRequest.onerror = () => {
    console.warn(' No se pudo eliminar la base de datos IndexedDB');
  };
  
  // Actualizar indicador visual
  fsManager.updateStatusIndicator(false);
  document.getElementById('fsBadge').style.display = 'none';
  
  // Mostrar notificacin
  if (typeof app !== 'undefined' && app.showToast) {
    app.showToast(' Modo Carpeta DESACTIVADO - Volviendo a localStorage (lmite 10MB)', 'error', 4000);
  } else {
    alert(' Modo Carpeta DESACTIVADO\n\nAhora usars localStorage con lmite de 10MB');
  }
  
  console.log(' Modo FileSystem desactivado completamente');
}

/* 
    MAP STORAGE SERVICE - INTEGRADO DESDE APP_BASE (FASE 4A)
   
   Gestiona el almacenamiento de mapas y reas en FileSystem con backups y logs.
    */

class MapStorageService {
  constructor(fsManager) {
    this.fsManager = fsManager;
    this.maps = [];
    this.areas = []; // Antes 'zones' - Mantener compatibilidad con zonas.json
    this.maxBackups = 5;
    this.mapsFileName = 'mapas.json';
    this.areasFileName = 'zonas.json'; // IMPORTANTE: Mantener 'zonas.json' para compatibilidad con datos existentes
    this.logsDirName = 'logs';
    this.logFileName = 'mapas-history.log';
    this.mapImagesPath = ['imagenes', 'mapas'];
    this.backupMapPath = ['backups', 'mapas'];
    this.backupAreaPath = ['backups', 'zonas']; // IMPORTANTE: Mantener 'zonas' para compatibilidad
    this.initialized = false;
    this.logsDirHandle = null;
    this.backupMapsDir = null;
    this.backupAreasDir = null; // Antes 'backupZonesDir'
    this.mapImagesDir = null;
  }

  get rootHandle() {
    return this.fsManager ? this.fsManager.storageHandle : null;
  }

  // 🔥 CRÍTICO: Exponer datos como "state" para compatibilidad con jerarquía
  get state() {
    return {
      mapas: this.maps || [],
      zonas: this.areas || []
    };
  }

  setMaxBackups(value) {
    if (typeof value === 'number' && value >= 1) {
      this.maxBackups = Math.floor(value);
    }
  }

  async init(options = {}) {
    const { autoReconnect = false } = options; // Cambiado a false por defecto - se controla desde inicialización centralizada
    if (!this.fsManager) {
      return false;
    }

    if (!this.fsManager.isConnected && autoReconnect && typeof this.fsManager.restoreFromPreviousSession === 'function') {
      try {
        await this.fsManager.restoreFromPreviousSession();
      } catch (error) {
        console.warn('No se pudo restaurar la carpeta de FileSystem:', error);
      }
    }

    if (!this.fsManager.isConnected) {
      return false;
    }

    await this.ensureStructure();
    await Promise.all([this.loadMaps(), this.loadAreas()]);
    this.initialized = true;
    
    return true;
  }

  async ensureStructure() {
    const root = this.rootHandle;
    if (!root) {
      return;
    }

    this.mapImagesDir = await this.ensureDirectory(this.mapImagesPath);
    this.backupMapsDir = await this.ensureDirectory(this.backupMapPath);
    this.backupAreasDir = await this.ensureDirectory(this.backupAreaPath);
    this.logsDirHandle = await this.ensureDirectory([this.logsDirName]);

    await this.ensureJSONFile(this.mapsFileName, '[]');
    await this.ensureJSONFile(this.areasFileName, '[]'); // Archivo zonas.json para compatibilidad
    await this.ensureLogFile();
  }

  async ensureDirectory(pathSegments) {
    let current = this.rootHandle;
    if (!current) {
      return null;
    }

    for (const segment of pathSegments) {
      if (!segment) {
        continue;
      }
      current = await current.getDirectoryHandle(segment, { create: true });
    }

    return current;
  }

  async ensureJSONFile(fileName, defaultContent) {
    const root = this.rootHandle;
    if (!root) {
      return;
    }

    try {
      await root.getFileHandle(fileName);
    } catch (error) {
      if (error.name === 'NotFoundError') {
        const handle = await root.getFileHandle(fileName, { create: true });
        const writable = await handle.createWritable();
        await writable.write(defaultContent);
        await writable.close();
      } else {
        console.warn(`No se pudo asegurar ${fileName}:`, error);
      }
    }
  }

  async ensureLogFile() {
    if (!this.logsDirHandle) {
      return;
    }

    try {
      await this.logsDirHandle.getFileHandle(this.logFileName);
    } catch (error) {
      if (error.name === 'NotFoundError') {
        const handle = await this.logsDirHandle.getFileHandle(this.logFileName, { create: true });
        const writable = await handle.createWritable();
        await writable.write('');
        await writable.close();
      } else {
        console.warn('No se pudo asegurar el archivo de log:', error);
      }
    }
  }

  normalizeJerarquiaPath(path) {
    if (!Array.isArray(path)) {
      return [];
    }

    return path
      .map((node) => {
        if (!node) {
          return null;
        }

        if (typeof node === 'string') {
          return { id: node, nivel: null };
        }

        if (typeof node === 'object') {
          const id = node.id ?? node.value ?? null;
          if (!id) {
            return null;
          }
          return {
            id,
            nivel: node.nivel ?? node.level ?? null
          };
        }

        return null;
      })
      .filter(Boolean);
  }

  deriveMapLevel(jerarquiaPath = []) {
    if (!Array.isArray(jerarquiaPath) || !jerarquiaPath.length) {
      return null;
    }
    const leaf = jerarquiaPath[jerarquiaPath.length - 1];
    return leaf?.nivel ?? null;
  }

  normalizeMap(map) {
    if (!map || typeof map !== 'object') {
      return {
        id: Date.now(),
        name: 'Mapa sin nombre',
        jerarquiaPath: [],
        allowFreeLevel: false,
        mapLevel: null
      };
    }

    const normalizedPath = this.normalizeJerarquiaPath(map.jerarquiaPath);
    const allowFreeLevel = Boolean(map.allowFreeLevel);
    const mapLevel = allowFreeLevel ? null : (map.mapLevel ?? this.deriveMapLevel(normalizedPath));

    return {
      ...map,
      allowFreeLevel,
      jerarquiaPath: normalizedPath,
      mapLevel: mapLevel || null
    };
  }

  validateMapEntry(map) {
    const issues = [];

    if (!map.allowFreeLevel) {
      if (!Array.isArray(map.jerarquiaPath) || !map.jerarquiaPath.length) {
        issues.push('Mapa sin jerarquiaPath asignado');
      } else {
        const leaf = map.jerarquiaPath[map.jerarquiaPath.length - 1];
        if (!leaf || !leaf.id) {
          issues.push('Nodo hoja sin ID');
        }
        if (!leaf || !leaf.nivel) {
          issues.push('Nodo hoja sin nivel');
        }
        if (!map.mapLevel) {
          issues.push('mapLevel no definido');
        }
      }
    }

    return {
      ok: issues.length === 0,
      issues
    };
  }

  validateMapCollection(maps) {
    const errors = [];
    const warnings = [];
    const leafAssignments = new Map();

    maps.forEach((map) => {
      const result = this.validateMapEntry(map);
      if (!result.ok) {
        errors.push({ mapId: map.id, name: map.name || 'Sin nombre', issues: result.issues.join('; ') });
      }

      if (map.allowFreeLevel) {
        return;
      }

      if (Array.isArray(map.jerarquiaPath) && map.jerarquiaPath.length) {
        const leaf = map.jerarquiaPath[map.jerarquiaPath.length - 1];
        const key = `${leaf.nivel || 'sin-nivel'}:${leaf.id}`;
        if (!leafAssignments.has(key)) {
          leafAssignments.set(key, []);
        }
        leafAssignments.get(key).push({ mapId: map.id, name: map.name || 'Sin nombre' });
      }
    });

    for (const [key, list] of leafAssignments.entries()) {
      if (list.length > 1) {
        warnings.push({
          leaf: key,
          maps: list.map((item) => `${item.name} (#${item.mapId})`).join(', ')
        });
      }
    }

    return {
      ok: errors.length === 0,
      errors,
      warnings
    };
  }

  logMapValidation(result) {
    if (!result) {
      return;
    }

    if (result.errors.length) {
      console.group('❌ Errores de validación de mapas');
      console.table(result.errors);
      console.groupEnd();
    }

    if (result.warnings.length) {
      console.group('⚠️ Advertencias de jerarquía duplicada');
      console.table(result.warnings);
      console.groupEnd();
    }
  }

  async loadMaps() {
    if (!this.fsManager || !this.fsManager.isConnected) {
      this.maps = [];
      return this.maps;
    }

    try {
      const fileHandle = await this.rootHandle.getFileHandle(this.mapsFileName, { create: true });
      const file = await fileHandle.getFile();
      const raw = (await file.text()).trim();
      let parsed = [];
      if (raw) {
        parsed = JSON.parse(raw);
      }
      this.maps = Array.isArray(parsed)
        ? parsed.map((map) => this.normalizeMap(map))
        : [];
    } catch (error) {
      console.warn('No se pudieron cargar los mapas:', error);
      this.maps = [];
    }

    return this.maps;
  }

  async loadAreas() { // Antes loadZones
    if (!this.fsManager || !this.fsManager.isConnected) {
      this.areas = [];
      return this.areas;
    }

    try {
      const fileHandle = await this.rootHandle.getFileHandle(this.areasFileName, { create: true });
      const file = await fileHandle.getFile();
      const raw = (await file.text()).trim();
      let parsed = [];
      if (raw) {
        parsed = JSON.parse(raw);
      }
      this.areas = Array.isArray(parsed) ? parsed : [];
    } catch (error) {
      console.warn('No se pudieron cargar las reas:', error);
      this.areas = [];
    }

    return this.areas;
  }

  async writeJSON(fileName, data) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return false;
    }

    try {
      const handle = await this.rootHandle.getFileHandle(fileName, { create: true });
      const writable = await handle.createWritable();
      await writable.write(JSON.stringify(data, null, 2));
      await writable.close();
      return true;
    } catch (error) {
      console.warn(`No se pudo escribir ${fileName}:`, error);
      return false;
    }
  }

  async saveMaps(maps, meta = {}) {
    const normalized = Array.isArray(maps) ? maps.map((map) => this.normalizeMap(map)) : [];
    const validation = this.validateMapCollection(normalized);
    this.logMapValidation(validation);

    if (!validation.ok) {
      console.warn('Guardado abortado: la colección de mapas no supera la validación de jerarquía.');
      return false;
    }

    if (!this.fsManager || !this.fsManager.isConnected) {
      this.maps = [...normalized];
      return false;
    }

    await this.createBackup(this.mapsFileName, 'maps');
    await this.writeJSON(this.mapsFileName, normalized);
    this.maps = [...normalized];

    await this.appendLog({ scope: 'maps', action: meta.action || 'save', mapId: meta.mapId || null, detail: meta.detail || null });
    return true;
  }

  async saveAreas(areas, meta = {}) { // Antes saveZones
    const normalized = Array.isArray(areas) ? areas : [];

    if (!this.fsManager || !this.fsManager.isConnected) {
      this.areas = [...normalized];
      return false;
    }

    await this.createBackup(this.areasFileName, 'areas'); // Backup sigue siendo 'areas'
    await this.writeJSON(this.areasFileName, normalized); // Archivo sigue siendo zonas.json
    this.areas = [...normalized];

    await this.appendLog({ scope: 'areas', action: meta.action || 'save', mapId: meta.mapId || null, areaId: meta.areaId || null, detail: meta.detail || null });
    return true;
  }

  async createBackup(fileName, namespace) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return;
    }

    const dirHandle = namespace === 'areas' ? this.backupAreasDir : this.backupMapsDir;
    if (!dirHandle) {
      return;
    }

    try {
      const fileHandle = await this.rootHandle.getFileHandle(fileName);
      const file = await fileHandle.getFile();
      const content = await file.text();
      if (!content || !content.trim()) {
        return;
      }

      const timestamp = this.formatTimestamp(new Date());
      const baseName = fileName.replace('.json', '');
      const backupHandle = await dirHandle.getFileHandle(`${baseName}-${timestamp}.json`, { create: true });
      const writable = await backupHandle.createWritable();
      await writable.write(content);
      await writable.close();

      await this.rotateBackups(dirHandle);
    } catch (error) {
      if (error.name !== 'NotFoundError') {
        console.warn(`No se pudo crear backup para ${fileName}:`, error);
      }
    }
  }

  async rotateBackups(dirHandle) {
    if (!dirHandle) {
      return;
    }

    const files = [];
    try {
      for await (const entry of dirHandle.values()) {
        if (entry.kind === 'file') {
          files.push(entry.name);
        }
      }
    } catch (error) {
      console.warn('No se pudo enumerar los backups:', error);
      return;
    }

    files.sort();

    while (files.length > this.maxBackups) {
      const oldest = files.shift();
      try {
        await dirHandle.removeEntry(oldest);
      } catch (error) {
        console.warn('No se pudo eliminar backup antiguo:', oldest, error);
        break;
      }
    }
  }

  async appendLog(event) {
    if (!event || typeof event !== 'object') {
      return;
    }

    if (!this.logsDirHandle) {
      return;
    }

    try {
      const payload = {
        scope: event.scope || 'maps',
        action: event.action || 'update',
        mapId: event.mapId || null,
        areaId: event.areaId || null, // Antes 'zoneId'
        detail: event.detail || null,
        timestamp: new Date().toISOString()
      };
      const handle = await this.logsDirHandle.getFileHandle(this.logFileName, { create: true });
      const file = await handle.getFile();
      const writable = await handle.createWritable({ keepExistingData: true });
      await writable.seek(file.size);
      await writable.write(JSON.stringify(payload) + '\n');
      await writable.close();
    } catch (error) {
      console.warn('No se pudo registrar el evento de mapa:', error);
    }
  }

  async readLog(limit = null) {
    if (!this.logsDirHandle) {
      return [];
    }

    try {
      const handle = await this.logsDirHandle.getFileHandle(this.logFileName, { create: true });
      const file = await handle.getFile();
      const text = await file.text();
      if (!text) {
        return [];
      }

      const lines = text.split('\n').filter(line => line.trim().length > 0);
      const events = [];
      for (const line of lines) {
        try {
          events.push(JSON.parse(line));
        } catch (error) {
          console.warn('Entrada de log invalida:', line);
        }
      }

      if (typeof limit === 'number' && limit > 0) {
        return events.slice(-limit);
      }

      return events;
    } catch (error) {
      console.warn('No se pudo leer el log de mapas:', error);
      return [];
    }
  }

  async getFileHandleFromPath(path) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return null;
    }

    const segments = Array.isArray(path) ? path : String(path || '').split('/').filter(Boolean);
    if (!segments.length) {
      return null;
    }

    let currentDir = this.rootHandle;
    try {
      for (let i = 0; i < segments.length; i++) {
        const segment = segments[i];
        const isLast = i === segments.length - 1;
        if (isLast) {
          return await currentDir.getFileHandle(segment, { create: false });
        }
        currentDir = await currentDir.getDirectoryHandle(segment, { create: false });
      }
    } catch (error) {
      console.warn('No se pudo resolver ruta de archivo:', path, error);
      return null;
    }

    return null;
  }

  async getMapImage(map) {
    if (!map || (!map.imagePath && !map.imageUrl)) {
      return null;
    }

    try {
      // 🔥 FIREBASE-ONLY: Si hay imageUrl de Firebase, descargar desde ahí
      if (this.firebaseMode && map.imageUrl) {
        console.log('🔥 Descargando imagen de mapa desde Firebase:', map.imageUrl);
        const response = await fetch(map.imageUrl);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const blob = await response.blob();
        // Crear un objeto File desde el blob para compatibilidad
        const fileName = map.imagePath ? map.imagePath.split('/').pop() : `map_${map.id}.webp`;
        return new File([blob], fileName, { type: blob.type });
      }
      
      // Modo FileSystem local
      const handle = await this.getFileHandleFromPath(map.imagePath);
      if (!handle) {
        return null;
      }
      return await handle.getFile();
    } catch (error) {
      console.warn('No se pudo obtener imagen del mapa:', error);
      return null;
    }
  }
  
  async listMapImageFiles() {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return [];
    }

    await this.ensureStructure();
    if (!this.mapImagesDir) {
      return [];
    }

    const files = [];
    try {
      for await (const entry of this.mapImagesDir.values()) {
        if (entry.kind === 'file') {
          files.push(entry.name);
        }
      }
    } catch (error) {
      console.warn('No se pudieron enumerar las imgenes de mapas:', error);
    }

    return files;
  }

  async deleteMapImage(target) {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return { success: false, reason: 'fs-offline' };
    }

    const imagePath = typeof target === 'string'
      ? target
      : (target && target.imagePath) ? target.imagePath : null;

    if (!imagePath) {
      return { success: false, reason: 'no-path' };
    }

    const segments = String(imagePath).split('/').filter(Boolean);
    if (!segments.length || !this.rootHandle) {
      return { success: false, reason: 'invalid-path' };
    }

    try {
      let currentDir = this.rootHandle;
      for (let i = 0; i < segments.length - 1; i++) {
        currentDir = await currentDir.getDirectoryHandle(segments[i], { create: false });
      }
      const fileName = segments[segments.length - 1];
      await currentDir.removeEntry(fileName);
      return { success: true, reason: 'deleted' };
    } catch (error) {
      if (error.name === 'NotFoundError') {
        return { success: true, reason: 'missing' };
      }
      console.warn('No se pudo eliminar imagen del mapa:', imagePath, error);
      return { success: false, reason: 'fs-error', error };
    }
  }

  async cleanupOrphanMapImages() {
    if (!this.fsManager || !this.fsManager.isConnected) {
      return { scanned: 0, referenced: 0, orphans: 0, removed: 0, failed: [] };
    }

    await this.ensureStructure();
    const files = await this.listMapImageFiles();
    if (!files.length) {
      return { scanned: 0, referenced: 0, orphans: 0, removed: 0, failed: [] };
    }

    const referenced = new Set(
      (this.maps || [])
        .map(map => {
          if (!map || !map.imagePath) {
            return null;
          }
          const parts = map.imagePath.split('/').filter(Boolean);
          return parts.length ? parts[parts.length - 1] : null;
        })
        .filter(Boolean)
    );

    const orphans = files.filter(name => !referenced.has(name));
    const failed = [];
    let removed = 0;

    for (const fileName of orphans) {
      try {
        await this.mapImagesDir.removeEntry(fileName);
        removed++;
      } catch (error) {
        failed.push({ fileName, error: error?.message || 'unknown' });
        console.warn('No se pudo eliminar mapa hurfano:', fileName, error);
      }
    }

    return {
      scanned: files.length,
      referenced: referenced.size,
      orphans: orphans.length,
      removed,
      failed
    };
  }
  
  getMapById(mapId) {
    return this.maps.find(map => map.id === mapId) || null;
  }

  getAreasByMap(mapId) { // Antes getZonesByMap
    return this.areas.filter(area => area.mapId === mapId);
  }

  formatTimestamp(date = new Date()) {
    const pad = (value) => String(value).padStart(2, '0');
    const year = date.getFullYear();
    const month = pad(date.getMonth() + 1);
    const day = pad(date.getDate());
    const hours = pad(date.getHours());
    const minutes = pad(date.getMinutes());
    const seconds = pad(date.getSeconds());
    return `${year}${month}${day}-${hours}${minutes}${seconds}`;
  }

  // Mtodos para exportacin de respaldo completo
  async getMaps() {
    await this.loadMaps();
    return this.maps;
  }

  async getAreas() {
    await this.loadAreas();
    return this.areas;
  }

  async auditMapHierarchy({ log = true } = {}) {
    await Promise.all([this.loadMaps(), this.loadAreas()]);

    const summary = {
      timestamp: new Date().toISOString(),
      totalMaps: this.maps.length,
      totalAreas: this.areas.length,
      stats: {
        mapsWithJerarquia: 0,
        mapsWithoutJerarquia: 0,
        uniqueLeafNodes: 0,
        duplicateLeafNodes: 0,
        areasOrphan: 0,
        mapsWithoutAreas: 0
      },
      issues: {
        missingJerarquiaPath: [],
        missingLeafNode: [],
        duplicateLeafAssignments: [],
        orphanAreas: [],
        mapsWithoutAreas: []
      }
    };

    const leafAssignments = new Map();
    const mapsById = new Map();
    const mapAreaCounts = new Map();

    for (const map of this.maps) {
      if (!map || typeof map !== 'object') {
        continue;
      }
      mapsById.set(map.id, map);
      const path = Array.isArray(map.jerarquiaPath) ? map.jerarquiaPath.filter(Boolean) : [];
      if (!path.length) {
        summary.issues.missingJerarquiaPath.push({ mapId: map.id, name: map.name || 'Sin nombre' });
        continue;
      }

      summary.stats.mapsWithJerarquia++;
      const leaf = path[path.length - 1];
      if (!leaf || !leaf.id) {
        summary.issues.missingLeafNode.push({ mapId: map.id, name: map.name || 'Sin nombre' });
        continue;
      }

      const key = `${leaf.nivel || 'sin-nivel'}:${leaf.id}`;
      if (!leafAssignments.has(key)) {
        leafAssignments.set(key, []);
      }
      leafAssignments.get(key).push({
        mapId: map.id,
        name: map.name || 'Sin nombre',
        nivel: leaf.nivel || null,
        nodeId: leaf.id
      });
    }

    summary.stats.mapsWithoutJerarquia = summary.issues.missingJerarquiaPath.length;
    summary.stats.uniqueLeafNodes = leafAssignments.size;

    for (const [, maps] of leafAssignments.entries()) {
      if (Array.isArray(maps) && maps.length > 1) {
        summary.issues.duplicateLeafAssignments.push(maps);
      }
    }

    summary.stats.duplicateLeafNodes = summary.issues.duplicateLeafAssignments.length;

    for (const area of this.areas) {
      if (!area || typeof area !== 'object') {
        continue;
      }
      const mapId = area.mapId;
      if (!mapsById.has(mapId)) {
        summary.issues.orphanAreas.push({ areaId: area.id, mapId, name: area.name || null });
        continue;
      }
      mapAreaCounts.set(mapId, (mapAreaCounts.get(mapId) || 0) + 1);
    }

    summary.stats.areasOrphan = summary.issues.orphanAreas.length;

    for (const map of this.maps) {
      if (!mapAreaCounts.has(map.id)) {
        summary.issues.mapsWithoutAreas.push({ mapId: map.id, name: map.name || 'Sin nombre' });
      }
    }

    summary.stats.mapsWithoutAreas = summary.issues.mapsWithoutAreas.length;

    if (log) {
      this.printMapAuditSummary(summary);
    }

    return summary;
  }

  printMapAuditSummary(summary) {
    if (!summary) {
      console.warn('Resumen de auditoria no disponible');
      return;
    }

    console.groupCollapsed('📊 Auditoria de mapas y jerarquia');
    console.log('Timestamp:', summary.timestamp);
    console.table(summary.stats);

    const logIssues = (label, items) => {
      if (Array.isArray(items) && items.length) {
        console.group(label);
        console.table(items);
        console.groupEnd();
      }
    };

    logIssues('Mapas sin jerarquiaPath', summary.issues.missingJerarquiaPath);
    logIssues('Mapas sin nodo hoja', summary.issues.missingLeafNode);
    if (Array.isArray(summary.issues.duplicateLeafAssignments) && summary.issues.duplicateLeafAssignments.length) {
      console.group('Mapas duplicados por nodo hoja');
      summary.issues.duplicateLeafAssignments.forEach((group, index) => {
        console.group(`Nodo duplicado ${index + 1}`);
        console.table(group);
        console.groupEnd();
      });
      console.groupEnd();
    }
    logIssues('Areas huerfanas', summary.issues.orphanAreas);
    logIssues('Mapas sin areas asociadas', summary.issues.mapsWithoutAreas);
    console.groupEnd();
  }
}

//  Crear instancia de MapStorage (usa el fsManager ya existente)
const mapStorage = new MapStorageService(fsManager);
console.log(' MapStorage inicializado');

/* FIN MAP STORAGE SERVICE */

/* 
    MAP CONTROLLER - INTEGRADO DESDE APP_BASE (FASE 4B)
   
   Controlador principal del editor de mapas con canvas, zoom, pan y dibujo de reas.
    */

const mapController = {
  elements: {},
  cachedJerarquiaOptions: null,
  cachedJerarquiaStructure: null,
  cachedJerarquiaVersion: 0,
  
  // 
  //  SISTEMA DE CATEGORAS PARA REAS (Etapa 1.2)
  // 
  categories: {
    area: { 
      icon: '', 
      color: '#3b82f6',
      name: 'rea',
      description: 'Zona general de planta'
    },
    maquina: { 
      icon: '', 
      color: '#10b981',
      name: 'Mquina',
      description: 'Equipo industrial principal'
    },
    estructura: { 
      icon: '', 
      color: '#64748b',
      name: 'Estructura',
      description: 'Componente estructural'
    },
    cinta: { 
      icon: '', 
      color: '#f59e0b',
      name: 'Cinta',
      description: 'Transportador o cinta'
    },
    componente: { 
      icon: '', 
      color: '#8b5cf6',
      name: 'Componente',
      description: 'Pieza o elemento menor'
    }
  },

  jerarquiaLevelConfig: {
    empresa: { label: 'Empresa', childKey: 'areas', childNivel: 'area' },
    area: { label: 'rea', childKey: 'subAreas', childNivel: 'subArea' },
    subArea: { label: 'Sub-rea', childKey: 'sistemas', childNivel: 'sistema' },
    sistema: { label: 'Sistema', childKey: 'subSistemas', childNivel: 'subSistema' },
    subSistema: { label: 'Sub-Sistema', childKey: 'secciones', childNivel: 'seccion' },
    seccion: { label: 'Seccin', childKey: 'subSecciones', childNivel: 'subSeccion' },
    subSeccion: { label: 'Sub-Seccin', childKey: null, childNivel: null }
  },
  // JERARQUÍA UNIFICADA DE 7 NIVELES (sincronizada con app.js)
  areaJerarquiaFieldOrder: ['nivel1', 'nivel2', 'nivel3', 'nivel4', 'nivel5', 'nivel6', 'nivel7'],
  areaJerarquiaFieldOrderLegacy: ['planta', 'areaGeneral', 'subArea', 'sistemaEquipo', 'subSistema', 'seccion', 'detalle'],
  
  state: {
    currentMapId: null,
    currentMap: null,
    currentImage: null,
    currentImageUrl: null,
    imageLODs: [],
    imageDimensions: { width: 0, height: 0 },
    usingBitmapRenderer: false,
    scale: 1,
    minScale: 0.05,
    maxScale: 20,
    offsetX: 0,
    offsetY: 0,
    isPanning: false,
    panStartX: 0,
    panStartY: 0,
    drawing: false,
    tempPoints: [],
    previewPoint: null,
    highlightAreaId: null, // Antes highlightZoneId
    showGrid: false,
    showRulers: false, //  NUEVO: Mostrar reglas laterales
    gridSize: 50, //  NUEVO: Tamao de celda del grid (pxeles)
    showMinimap: true, //  NUEVO: Mostrar minimap por defecto
    mostrarNombresAreas: true, //  NUEVO: Mostrar nombres de reas
    mostrarPuntosRepuestos: true, //  NUEVO: Mostrar puntos de repuestos
    repuestoFiltrado: null, //  NUEVO: ID del repuesto filtrado
    tooltipPinned: false, //  Tooltip fijado al hacer click
    pinnedAreaId: null, //  ID del rea cuyo tooltip est fijado
    cascadaEditMode: false, //  NUEVO: Modo edicin drag & drop en cascada
    mostrarSoloConJerarquia: false, //  NUEVO: Filtro para ocultar elementos sin jerarqua
    draggedRepuesto: null, //  NUEVO: Repuesto siendo arrastrado
    dropTargetArea: null, //  NUEVO: rea objetivo del drop
    areas: [], // Antes zones
    categoryFilter: null, // NUEVO: filtro activo por categora
    
    jerarquiaBranchFilter: null,
    //  ETAPA 3.1: Seleccin mltiple
    selectedAreaIds: [], // IDs de reas seleccionadas
    isMultiSelectMode: false, // Modo seleccin mltiple activo
    
    //  ETAPA 3.2: Edicin de puntos de reas (reshape)
    isReshapeMode: false, // Modo reshape activo
    reshapeAreaId: null, // ID del rea siendo editada
    reshapePoints: [], // Puntos del rea en edicin
    selectedPointIndex: null, // ndice del punto seleccionado
    isDraggingPoint: false, // Arrastrando un punto
    hoveredPointIndex: null, // Punto bajo el cursor
    hoveredEdgeIndex: null, // Borde bajo el cursor (para agregar punto)
    
    // Modo de edicin de puntos
    editingAreaId: null, // Antes editingZoneId
    editingPoints: [],
    selectedPointIndex: null,
    isDraggingPoint: false,
    // Performance optimization
    animationFrameId: null,
    needsRedraw: false,

    // Sincronizacin con jerarqua/inventario
    pendingJerarquiaRefresh: false,
    pendingCatalogRefresh: false,
    lastJerarquiaSync: null,
    contractAudit: null,
    lastCatalogSync: null,

    // Asignacin temporal de jerarqua para mapas
    tempJerarquiaAssignment: null,
    mapFormContext: null,

    // Overlay de carga de mapas
    mapLoadingActive: false,
    mapLoadingProgress: 0,
    mapLoadingHideTimeout: null
  },

  viewportState: null,
  mapViewportStorageKey: 'mapViewportState_v1',
  viewportPersistDelay: 600,
  viewportSaveTimer: null,
  viewportChangedDuringPan: false,

  restoreViewportState() {
    try {
      const raw = localStorage.getItem(this.mapViewportStorageKey);
      if (raw) {
        this.viewportState = JSON.parse(raw);
      }
    } catch (error) {
      console.warn('No se pudo restaurar el estado visual del mapa:', error);
    }

    if (!this.viewportState || typeof this.viewportState !== 'object') {
      this.viewportState = { lastMapId: null, views: {} };
    } else {
      this.viewportState.lastMapId = this.viewportState.lastMapId || null;
      this.viewportState.views = this.viewportState.views || {};
    }
  },

  captureCurrentViewportSnapshot() {
    if (!this.state.currentMapId) return null;
    const scale = Number(this.state.scale);
    const offsetX = Number(this.state.offsetX);
    const offsetY = Number(this.state.offsetY);
    if (!Number.isFinite(scale) || !Number.isFinite(offsetX) || !Number.isFinite(offsetY)) {
      return null;
    }

    const clampedScale = Math.min(this.state.maxScale, Math.max(this.state.minScale, scale));
    return {
      mapId: this.state.currentMapId,
      scale: clampedScale,
      offsetX,
      offsetY
    };
  },

  getLastViewedMapId() {
    return this.viewportState?.lastMapId || null;
  },

  getPersistedViewportForMap(mapId) {
    if (!mapId || !this.viewportState || !this.viewportState.views) {
      return null;
    }
    return this.viewportState.views[mapId] || null;
  },

  sanitizeViewportSnapshot(snapshot) {
    if (!snapshot || typeof snapshot !== 'object') {
      return null;
    }
    const scale = Number(snapshot.scale);
    const offsetX = Number(snapshot.offsetX);
    const offsetY = Number(snapshot.offsetY);
    if (!Number.isFinite(scale) || !Number.isFinite(offsetX) || !Number.isFinite(offsetY)) {
      return null;
    }
    return {
      scale: Math.min(this.state.maxScale, Math.max(this.state.minScale, scale)),
      offsetX,
      offsetY
    };
  },

  applyViewportSnapshot(snapshot) {
    const sanitized = this.sanitizeViewportSnapshot(snapshot);
    if (!sanitized) return false;
    this.state.scale = sanitized.scale;
    this.state.offsetX = sanitized.offsetX;
    this.state.offsetY = sanitized.offsetY;
    return true;
  },

  queueViewportPersist(reason = 'auto') {
    if (!this.state.currentMapId) return;
    if (this.viewportSaveTimer) {
      clearTimeout(this.viewportSaveTimer);
    }
    this.viewportSaveTimer = setTimeout(() => {
      this.persistViewportState(reason);
    }, this.viewportPersistDelay);
  },

  persistViewportState(reason = 'auto') {
    if (!this.state.currentMapId) {
      return;
    }

    const snapshot = this.captureCurrentViewportSnapshot();
    if (!snapshot) {
      return;
    }

    if (!this.viewportState || typeof this.viewportState !== 'object') {
      this.viewportState = { lastMapId: null, views: {} };
    }

    this.viewportState.lastMapId = snapshot.mapId;
    const entry = {
      scale: snapshot.scale,
      offsetX: snapshot.offsetX,
      offsetY: snapshot.offsetY,
      updatedAt: Date.now()
    };
    this.viewportState.views[snapshot.mapId] = entry;

    const viewEntries = Object.entries(this.viewportState.views);
    const maxEntries = 25;
    if (viewEntries.length > maxEntries) {
      viewEntries
        .sort((a, b) => (a[1]?.updatedAt || 0) - (b[1]?.updatedAt || 0))
        .slice(0, viewEntries.length - maxEntries)
        .forEach(([key]) => delete this.viewportState.views[key]);
    }

    try {
      localStorage.setItem(this.mapViewportStorageKey, JSON.stringify(this.viewportState));
    } catch (error) {
      console.warn('No se pudo guardar el estado visual del mapa:', error, reason);
    }

    if (this.viewportSaveTimer) {
      clearTimeout(this.viewportSaveTimer);
      this.viewportSaveTimer = null;
    }
  },


  init() {
    //  Cargar categoras personalizadas desde localStorage
    const savedCategories = localStorage.getItem('mapCategories');
    if (savedCategories) {
      try {
        this.categories = JSON.parse(savedCategories);
        console.log(' Categoras personalizadas cargadas:', Object.keys(this.categories));
      } catch (e) {
        console.warn(' Error al cargar categoras personalizadas:', e);
      }
    }

    this.restoreViewportState();

    if (typeof window !== 'undefined' && window.addEventListener) {
      window.addEventListener('beforeunload', () => {
        this.persistViewportState('beforeunload');
      });
    }

    this.elements = {
      shell: document.querySelector('.map-shell'),
      connectBtn: document.getElementById('mapConnectBtn'),
      cleanImagesBtn: document.getElementById('mapCleanImagesBtn'),
      newBtn: document.getElementById('mapNewBtn'),
      drawBtn: document.getElementById('mapDrawAreaBtn'), // Antes mapDrawZoneBtn
      saveBtn: document.getElementById('mapSaveAreasBtn'), // Antes mapSaveZonesBtn
      mapList: document.getElementById('mapList'),
      areaList: document.getElementById('areaList'), // Antes zoneList
      jerarquiaBadge: document.getElementById('mapJerarquiaBadge'),
      jerarquiaBranch: document.getElementById('mapJerarquiaBranch'),
      contractPanel: document.getElementById('mapContractAuditPanel'),
      contractIssueList: document.getElementById('mapContractIssueList'),
      contractRefreshBtn: document.getElementById('mapContractAuditRefresh'),
      contractTimestamp: document.getElementById('mapContractAuditTimestamp'),
      contractStats: {
        total: document.getElementById('mapAuditTotal'),
        compliant: document.getElementById('mapAuditCompliant'),
        pending: document.getElementById('mapAuditPending'),
        conflicts: document.getElementById('mapAuditConflicts')
      },
      logList: document.getElementById('mapLogList'),
      logRefreshBtn: document.getElementById('mapLogRefreshBtn'),
      connectionBadge: document.getElementById('mapConnectionBadge'),
      status: document.getElementById('mapStatus'),
      zoomBadge: document.getElementById('mapZoomBadge'),
      metaBadge: document.getElementById('mapMetaBadge'),
      toolbar: document.getElementById('mapToolbar'),
      canvasStage: document.querySelector('.map-canvas-stage'),
      canvas: document.getElementById('mapCanvas'),
      hint: document.getElementById('mapHint'),
      tooltip: document.getElementById('mapTooltip'), //  NUEVO: Tooltip para reas
      minimapContainer: document.getElementById('mapMinimapContainer'), //  NUEVO: Contenedor minimap
      minimap: document.getElementById('mapMinimap'), //  NUEVO: Canvas minimap
      minimapViewport: document.getElementById('mapMinimapViewport'), //  NUEVO: Indicador viewport
      modal: document.getElementById('mapModalOverlay'),
      modalBody: document.getElementById('mapModalBody'),
      modalTitle: document.getElementById('mapModalTitle'),
      modalClose: document.getElementById('mapModalClose'),
      mapLoadingOverlay: document.getElementById('mapLoadingOverlay'),
      mapLoadingTitle: document.getElementById('mapLoadingTitle'),
      mapLoadingStatus: document.getElementById('mapLoadingStatus'),
      mapLoadingBar: document.getElementById('mapLoadingBar'),
      mapLoadingPercent: document.getElementById('mapLoadingPercent')
    };
    this.state.contractAudit = this.buildContractAuditReport();
    this.renderContractAudit();

    if (!this.elements.canvas) {
      console.warn('mapController: canvas no disponible');
      return;
    }

    this.ctx = this.elements.canvas.getContext('2d', { alpha: false, desynchronized: true });
    
    //  NUEVO: Inicializar contexto del minimap
    if (this.elements.minimap) {
      this.minimapCtx = this.elements.minimap.getContext('2d', { alpha: true });
    }
    
    this.bindEvents();
    this.updateConnectionBadge();
    this.resizeCanvas();

    if (mapStorage.initialized) {
      this.loadData();
    } else if (fsManager.isConnected) {
      mapStorage.init({ autoReconnect: false }).then(() => this.loadData()).catch((error) => {
        console.warn('mapController: no se pudo inicializar mapStorage de inmediato', error);
      });
    } else {
      this.drawMessage('Conecta la carpeta INVENTARIO_STORAGE para comenzar.');
      this.renderMapList([]);
      this.renderAreaList([]);
      this.updateMapJerarquiaBadge();
    }

    if (this.state.pendingJerarquiaRefresh) {
      this.handleJerarquiaStructureUpdate({ silent: true, reason: 'pending-refresh' });
    }

    if (this.state.pendingCatalogRefresh) {
      this.handleJerarquiaCatalogUpdate({ silent: true, reason: 'pending-refresh' });
    }
  },

  bindEvents() {
    const { connectBtn, cleanImagesBtn, newBtn, drawBtn, toolbar, logRefreshBtn, modalClose, modal } = this.elements;

    if (connectBtn) connectBtn.addEventListener('click', () => this.handleConnect());
    if (cleanImagesBtn) cleanImagesBtn.addEventListener('click', () => this.cleanOrphanMapImages());
    if (newBtn) newBtn.addEventListener('click', () => this.openNewMapModal());
    if (drawBtn) drawBtn.addEventListener('click', () => this.toggleDrawingMode());
    
    //  BOTN AGREGAR MARCADOR
    const addMarkerBtn = document.getElementById('mapAddMarkerBtn');
    if (addMarkerBtn) {
      addMarkerBtn.addEventListener('click', () => this.toggleModoAgregarMarcador());
    }
    
    if (toolbar) {
      toolbar.addEventListener('click', (event) => {
        const target = event.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        event.preventDefault();
        this.handleToolbarAction(action);
      });
    }
    if (logRefreshBtn) logRefreshBtn.addEventListener('click', () => this.refreshLog());
    if (modalClose) modalClose.addEventListener('click', () => this.closeModal());
    if (modal) modal.addEventListener('click', (event) => {
      if (event.target === modal) this.closeModal();
    });

    // Event listeners para filtros de historial
    const filterAction = document.getElementById('mapLogFilterAction');
    const filterScope = document.getElementById('mapLogFilterScope');
    const helpBtn = document.getElementById('mapLogHelpBtn');
    
    if (filterAction) filterAction.addEventListener('change', () => this.refreshLog());
    if (filterScope) filterScope.addEventListener('change', () => this.refreshLog());
    if (helpBtn) helpBtn.addEventListener('click', () => this.showHistorialHelp());

    //  NUEVO: Event listeners para filtros de categora
    const categoryFilterBtns = document.querySelectorAll('.map-category-filter-btn');
    categoryFilterBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const category = e.target.dataset.category;
        this.applyCategoryFilter(category);
        
        // Actualizar estilos de botones activo/inactivo
        categoryFilterBtns.forEach(b => {
          if (b.dataset.category === category) {
            b.style.background = 'var(--primary)';
            b.style.color = 'white';
          } else {
            b.style.background = 'var(--bg-tertiary)';
            b.style.color = 'var(--text-primary)';
          }
        });
      });
    });

    //  NUEVO: Event listener para buscador de reas
    const areaSearchInput = document.getElementById('mapAreaSearch');
    if (areaSearchInput) {
      areaSearchInput.addEventListener('input', () => {
        // Re-renderizar la lista con el filtro de bsqueda aplicado
        if (this.state.currentMapId) {
          const currentAreas = this.state.areas.filter(a => a.mapId === this.state.currentMapId);
          this.renderAreaList(currentAreas);
        }
      });
    }

    if (this.elements.contractRefreshBtn) {
      this.elements.contractRefreshBtn.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        this.runContractAudit();
      });
    }

    if (this.elements.contractIssueList) {
      this.elements.contractIssueList.addEventListener('click', (event) => {
        const actionBtn = event.target.closest('[data-action]');
        if (!actionBtn) {
          return;
        }
        event.preventDefault();
        event.stopPropagation();
        this.handleContractIssueAction(actionBtn.dataset.action, actionBtn.dataset);
      });
    }

    if (this.elements.jerarquiaBadge) {
      this.elements.jerarquiaBadge.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;
        const actionBtn = target.closest('[data-action="badge-assign-jerarquia"]');
        if (!actionBtn) return;
        event.preventDefault();
        event.stopPropagation();
        if (this.state.currentMapId) {
          this.openAssignJerarquiaModal(this.state.currentMapId);
        } else {
          this.showToast('Selecciona un mapa primero.', 'info');
        }
      });
    }

    if (this.elements.jerarquiaBranch) {
      this.elements.jerarquiaBranch.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;

        const clearBtn = target.closest('[data-action="branch-clear-filter"]');
        if (clearBtn) {
          event.preventDefault();
          event.stopPropagation();
          this.clearJerarquiaBranchFilter();
          return;
        }

        const nodeBtn = target.closest('[data-branch-index]');
        if (!nodeBtn) return;

        const index = parseInt(nodeBtn.getAttribute('data-branch-index'), 10);
        if (Number.isNaN(index)) {
          return;
        }
        event.preventDefault();
        this.toggleJerarquiaBranchFilter(index);
      });
    }

    //  NUEVO: Event listener para clic en minimap
    if (this.elements.minimap) {
      this.elements.minimap.addEventListener('click', (event) => {
        this.handleMinimapClick(event);
      });
    }

    this.registerCanvasEvents();
    window.addEventListener('resize', () => this.handleResize());
  },

  async handleConnect() {
    if (typeof fsManager?.checkFileSystemAPI === 'function' && !fsManager.checkFileSystemAPI()) {
      this.showToast('Tu navegador no soporta File System Access API. Usa Microsoft Edge o Chrome.', 'warning');
      return;
    }

    //  USAR MTODO CENTRALIZADO
    try {
      console.log(' Iniciando conexin...');
      const connected = await LoadingModal.runTask(
        () => app.connectWorkspace(false, true),
        {
          startMessage: 'Conectando carpeta...',
          statusMessage: 'Solicitando permisos...',
          successMessage: 'Carpeta lista',
          errorMessage: 'Operacin cancelada',
          autoHide: false,
          tips: [
            'Autoriza la carpeta INVENTARIO_STORAGE cuando el navegador lo solicite.',
            'Puedes cambiar la carpeta en cualquier momento desde Configuración.',
            'No cierres la ventana hasta que la sincronización finalice.'
          ]
        }
      );
      console.log(' Resultado conexin:', connected);
      LoadingModal.finish({
        message: 'Carpeta conectada',
        status: 'Sincronización completa',
        tip: 'Recargando para usar tu carpeta principal...',
        delay: 800
      });
      
      //  SIEMPRE recargar pgina despus de intentar conectar
      console.log(' Recargando pgina en 1 segundo...');
      setTimeout(() => {
        location.reload();
      }, 1000);
      
    } catch (error) {
      console.error('Error conectando carpeta:', error);
      this.showToast('No se pudo conectar la carpeta: ' + (error?.message || error), 'error');
      LoadingModal.finish({
        message: 'Conexión interrumpida',
        status: 'Revisa los permisos',
        tip: 'Vuelve a intentar seleccionando la carpeta nuevamente.',
        delay: 800
      });
    }
  },

  updateConnectionBadge() {
    const { connectionBadge, status } = this.elements;
    if (!connectionBadge) return;

    if (mapStorage.initialized && fsManager.isConnected) {
      connectionBadge.textContent = fsManager.folderPath || 'INVENTARIO_STORAGE';
      connectionBadge.classList.remove('map-status-badge--off');
      connectionBadge.classList.add('map-status-badge--on');
      if (status) {
        status.textContent = 'Selecciona un mapa o crea uno nuevo para comenzar a trabajar.';
      }
    } else {
      connectionBadge.textContent = 'Sin carpeta';
      connectionBadge.classList.remove('map-status-badge--on');
      connectionBadge.classList.add('map-status-badge--off');
      if (status) {
        status.textContent = 'Conecta la carpeta INVENTARIO_STORAGE para habilitar el editor de mapas.';
      }
    }
  },

  async loadData(options = {}) {
    if (!mapStorage.initialized) {
      this.renderMapList([]);
      this.renderAreaList([]);
      this.drawMessage('Conecta la carpeta INVENTARIO_STORAGE para comenzar.');
      this.updateMapJerarquiaBadge();
      return;
    }

    try {
      if (options.force) {
        await mapStorage.ensureStructure();
        await Promise.all([mapStorage.loadMaps(), mapStorage.loadAreas()]);
      }

      const maps = mapStorage.maps || [];
      this.renderMapList(maps);

      if (!maps.length) {
        this.state.currentMapId = null;
        this.state.currentMap = null;
        this.state.jerarquiaBranchFilter = null;
        this.state.areas = [];
        this.cleanupImage();
        this.renderAreaList([]);
        this.drawMessage('Crea un mapa para comenzar a dibujar zonas.');
        this.updateMapJerarquiaBadge();
        return;
      }

      const hasMap = (mapId) => maps.some((m) => Number(m.id) === Number(mapId));
      let targetMapId = this.state.currentMapId && hasMap(this.state.currentMapId)
        ? this.state.currentMapId
        : null;

      if (!targetMapId) {
        const persistedId = this.getLastViewedMapId();
        if (persistedId && hasMap(persistedId)) {
          targetMapId = persistedId;
        }
      }

      if (!targetMapId) {
        targetMapId = maps[0].id;
      }

      const keepViewport = Boolean(this.state.currentMapId && this.state.currentMapId === targetMapId);
      await this.selectMap(targetMapId, { keepViewport });

      await this.refreshLog();
      this.runContractAudit({ silent: true });
    } catch (error) {
      console.error('mapController.loadData error:', error);
      this.showToast('No se pudieron cargar los mapas. Revisa la consola.', 'error');
      this.renderContractAudit();
    }
  },

  renderMapList(maps) {
    const { mapList } = this.elements;
    if (!mapList) return;

    if (!Array.isArray(maps) || !maps.length) {
      mapList.classList.remove('map-hierarchy-list');
      mapList.innerHTML = `<div style="padding: 16px; border: 1px dashed var(--border-color); border-radius: 10px; color: var(--text-secondary); font-size: 0.85rem;">An no hay mapas registrados.</div>`;
      return;
    }

    const tree = this.buildMapHierarchyTree(maps);
    const hierarchyHtml = this.renderMapHierarchyGroups(tree.children, 0);
    mapList.classList.add('map-hierarchy-list');
    mapList.innerHTML = hierarchyHtml;

    this.attachMapHierarchyEvents();
    this.attachMapCardEvents();
  },

  getMapHierarchyPath(map) {
    if (map && Array.isArray(map.jerarquiaPath) && map.jerarquiaPath.length) {
      return map.jerarquiaPath.map(node => ({
        id: node.id || null,
        nivel: node.nivel || null,
        nombre: node.nombre || null
      }));
    }

    return [{ id: 'sin-jerarquia', nivel: 'sin-nivel', nombre: 'Sin jerarqua asignada' }];
  },

  getJerarquiaNodeName(node) {
    if (!node) {
      return 'Sin nombre';
    }

    const found = this.findJerarquiaNodeInTree(node.id, node.nivel);
    return found?.nombre || node.nombre || node.id || 'Nivel sin nombre';
  },

  buildMapHierarchyTree(maps) {
    const root = { key: 'root', label: 'root', fullPath: '', children: new Map(), maps: [] };

    maps.forEach(map => {
      const path = this.getMapHierarchyPath(map);
      let current = root;

      path.forEach((node, index) => {
        const key = `${node.id || 'nivel'}-${node.nivel || index}`;
        if (!current.children.has(key)) {
          const partialPath = path.slice(0, index + 1);
          current.children.set(key, {
            key,
            label: this.getJerarquiaNodeName(node),
            fullPath: this.getJerarquiaPathLabel(partialPath),
            nivel: node.nivel || null,
            children: new Map(),
            maps: []
          });
        }

        current = current.children.get(key);
      });

      current.maps.push(map);
    });

    return root;
  },

  sortHierarchyChildren(childrenMap) {
    return Array.from(childrenMap.values()).sort((a, b) => a.label.localeCompare(b.label || '', 'es', { sensitivity: 'base' }));
  },

  countMapsInGroup(group) {
    let total = Array.isArray(group.maps) ? group.maps.length : 0;
    if (group.children && group.children.size) {
      total += Array.from(group.children.values()).reduce((acc, child) => acc + this.countMapsInGroup(child), 0);
    }
    return total;
  },

  renderMapHierarchyGroups(childrenMap, depth = 0) {
    if (!childrenMap || !childrenMap.size) {
      return '';
    }

    return this.sortHierarchyChildren(childrenMap).map(group => {
      const totalMaps = this.countMapsInGroup(group);
      const hasChildren = !!(group.children && group.children.size);
      const mapCount = Array.isArray(group.maps) ? group.maps.length : 0;
      const mapRef = mapCount === 1 ? group.maps[0] : null;
      const headerClasses = `map-hierarchy-header ${hasChildren ? 'map-hierarchy-header--clickable' : 'map-hierarchy-header--static'} ${mapRef ? 'map-hierarchy-header--map' : ''} ${mapRef && String(this.state.currentMapId) === String(mapRef.id) ? 'map-hierarchy-header--active' : ''}`;
      const headerAttributes = mapRef ? `data-map-id="${mapRef.id}"` : '';
      const tooltip = mapRef ? this.renderGroupTooltip(mapRef) : '';
      const actionsHtml = mapRef ? this.renderGroupActions(mapRef) : '';
      const nestedHtml = group.children?.size ? `<div class="map-hierarchy-children">${this.renderMapHierarchyGroups(group.children, depth + 1)}</div>` : '';
      const mapList = mapRef ? [] : (group.maps || []);
      const mapsHtml = mapList.length ? `<div class="map-hierarchy-leaf-list">${mapList.map((map) => this.renderMapHierarchyLeaf(map)).join('')}</div>` : '';

      return `
        <div class="map-hierarchy-group" data-depth="${depth}">
          <div class="${headerClasses}" ${headerAttributes}>
            <div class="map-hierarchy-header-main">
              <span class="map-hierarchy-chevron" data-action="toggle-group"></span>
              <div>
                <div class="map-hierarchy-label">${this.escapeHtml(group.label)}</div>
                ${group.fullPath ? `<div class="map-hierarchy-path">${this.escapeHtml(group.fullPath)}</div>` : ''}
              </div>
            </div>
            <span class="map-hierarchy-count">
              ${actionsHtml}
              ${totalMaps} mapa${totalMaps === 1 ? '' : 's'}
            </span>
            ${tooltip}
          </div>
          <div class="map-hierarchy-body">
            ${mapsHtml}
            ${nestedHtml}
          </div>
        </div>
      `;
    }).join('');
  },

  renderMapCard(map) {
    const isActive = this.state.currentMapId === map.id;
    const hasJerarquia = Array.isArray(map.jerarquiaPath) && map.jerarquiaPath.length > 0;
    const pathLabel = hasJerarquia ? this.getJerarquiaPathLabel(map.jerarquiaPath) : 'Sin jerarquía asignada';
    
    // 🔥 NUEVO: Indicadores visuales
    const areasCount = this.getAreasCountForMap(map.id);
    const markersCount = this.getMarkersCountForMap(map.id);
    
    let statusIndicators = '<div class="map-card-indicators">';
    if (hasJerarquia) {
      statusIndicators += '<span class="map-indicator map-indicator--success" title="Jerarquía asignada">🗺️</span>';
    }
    if (areasCount > 0) {
      statusIndicators += `<span class="map-indicator map-indicator--info" title="${areasCount} área(s)">📦 ${areasCount}</span>`;
    }
    if (markersCount > 0) {
      statusIndicators += `<span class="map-indicator map-indicator--warning" title="${markersCount} marcador(es)">📍 ${markersCount}</span>`;
    }
    statusIndicators += '</div>';

    return `
      <article class="map-card ${isActive ? 'map-card--active' : ''}" data-map-id="${map.id}">
        <div class="map-card-content" data-action="select-map">
          <div class="map-card-header">
            <div class="map-card-title">${this.escapeHtml(map.name || 'Mapa sin nombre')}</div>
            ${statusIndicators}
          </div>
          <div class="map-card-path ${hasJerarquia ? '' : 'map-card-path--empty'}">${this.escapeHtml(pathLabel)}</div>
        </div>
      </article>
    `;
  },

  /**
   * 🔥 NUEVO: Obtener cantidad de marcadores en un mapa
   */
  getMarkersCountForMap(mapId) {
    if (!mapStorage || !Array.isArray(mapStorage.areas)) {
      return 0;
    }
    let count = 0;
    mapStorage.areas.forEach(area => {
      if (area.mapId === mapId && area.equipos && Array.isArray(area.equipos)) {
        count += area.equipos.length;
      }
    });
    return count;
  },

  getAreasCountForMap(mapId) {
    if (!mapStorage || !Array.isArray(mapStorage.areas)) {
      return 0;
    }
    return mapStorage.areas.filter(z => z.mapId === mapId).length;
  },

  renderGroupTooltip(map) {
    if (!map) {
      return '';
    }

    const createdAt = map.createdAt ? new Date(map.createdAt).toLocaleDateString('es-CL') : '';
    const dimensions = map.width && map.height ? `${map.width}  ${map.height}px` : 'Dimensiones pendientes';
    const areasCount = this.getAreasCountForMap(map.id);
    const pathLabel = Array.isArray(map.jerarquiaPath) && map.jerarquiaPath.length
      ? this.getJerarquiaPathLabel(map.jerarquiaPath)
      : '';

    const rows = [
      `<span class="map-hierarchy-tooltip-line"><strong>${this.escapeHtml(map.name || 'Mapa sin nombre')}</strong></span>`,
      pathLabel ? `<span class="map-hierarchy-tooltip-line">Ruta: ${this.escapeHtml(pathLabel)}</span>` : null,
      `<span class="map-hierarchy-tooltip-line">${areasCount} rea(s) registradas</span>`,
      dimensions ? `<span class="map-hierarchy-tooltip-line">Resolucin: ${this.escapeHtml(dimensions)}</span>` : null,
      createdAt ? `<span class="map-hierarchy-tooltip-line">Creado: ${this.escapeHtml(createdAt)}</span>` : null
    ].filter(Boolean).join('');

    return `<div class="map-hierarchy-tooltip">${rows}</div>`;
  },

  renderGroupActions(map) {
    return `
      <span class="map-hierarchy-actions">
        <button class="map-card-btn map-card-btn--link" data-action="assign-jerarquia" data-map-id="${map.id}" title="Asignar jerarqua">Jerarqua</button>
        <button class="map-card-btn map-card-btn--edit" data-action="edit-map" data-map-id="${map.id}" title="Editar mapa"></button>
        <button class="map-card-btn map-card-btn--delete" data-action="delete-map" data-map-id="${map.id}" title="Eliminar mapa"></button>
      </span>
    `;
  },

  renderMapHierarchyLeaf(map) {
    if (!map) return '';

    const isActive = String(this.state.currentMapId) === String(map.id);
    const areasCount = this.getAreasCountForMap(map.id);

    return `
      <div class="map-hierarchy-leaf ${isActive ? 'map-hierarchy-leaf--active' : ''}" data-map-id="${map.id}">
        <div class="map-hierarchy-leaf-main">
          <span class="map-hierarchy-leaf-label">${this.escapeHtml(map.name || 'Mapa sin nombre')}</span>
          <span class="map-hierarchy-leaf-meta">${areasCount} rea${areasCount === 1 ? '' : 's'}</span>
        </div>
        <div class="map-hierarchy-leaf-right">
          ${this.renderGroupActions(map)}
        </div>
        ${this.renderGroupTooltip(map)}
      </div>
    `;
  },

  attachMapHierarchyEvents() {
    const { mapList } = this.elements;
    if (!mapList) return;

    Array.from(mapList.querySelectorAll('.map-hierarchy-chevron[data-action="toggle-group"]')).forEach(toggle => {
      toggle.addEventListener('click', (event) => {
        event.stopPropagation();
        const groupEl = toggle.closest('.map-hierarchy-group');
        if (!groupEl) return;
        groupEl.classList.toggle('map-hierarchy-group--collapsed');
      });
    });

    Array.from(mapList.querySelectorAll('.map-hierarchy-header--clickable:not([data-map-id])')).forEach(header => {
      header.addEventListener('click', () => {
        const groupEl = header.closest('.map-hierarchy-group');
        if (!groupEl) return;
        groupEl.classList.toggle('map-hierarchy-group--collapsed');
      });
    });

    Array.from(mapList.querySelectorAll('.map-hierarchy-header[data-map-id]')).forEach(header => {
      header.addEventListener('click', async () => {
        const mapId = header.getAttribute('data-map-id');
        if (!mapId) return;
        await this.selectMap(mapId);
      });
    });

    Array.from(mapList.querySelectorAll('.map-hierarchy-leaf[data-map-id]')).forEach(leaf => {
      leaf.addEventListener('click', async () => {
        const mapId = leaf.getAttribute('data-map-id');
        if (!mapId) return;
        await this.selectMap(mapId);
      });
    });
  },

  attachMapCardEvents() {
    const { mapList } = this.elements;
    if (!mapList) return;

    Array.from(mapList.querySelectorAll('[data-action="select-map"]')).forEach(content => {
      content.addEventListener('click', async (e) => {
        const card = e.target.closest('.map-card');
        const mapId = card?.getAttribute('data-map-id');
        if (!mapId) return;
        await this.selectMap(mapId);
      });
    });

    Array.from(mapList.querySelectorAll('[data-action="edit-map"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const mapId = btn.getAttribute('data-map-id');
        await this.openEditMapModal(mapId);
      });
    });

    Array.from(mapList.querySelectorAll('[data-action="assign-jerarquia"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const mapId = btn.getAttribute('data-map-id');
        await this.openAssignJerarquiaModal(mapId);
      });
    });

    Array.from(mapList.querySelectorAll('[data-action="delete-map"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const mapId = btn.getAttribute('data-map-id');
        await this.deleteMap(mapId);
      });
    });
  },

  //  FUNCIÓN CENTRALIZADA: Calcular correlativos GLOBALES para todo el sistema
  calcularCorrelativosGlobales(mapId) {
    if (!app || !app.repuestos || !Array.isArray(app.repuestos)) return {};
    
    const correlativosGlobales = {}; // { repuestoId: { ubicacionIndex: { numero, total } } }
    
    // Calcular correlativos globales por repuesto (igual que en árbol de jerarquía)
    app.repuestos.forEach(repuesto => {
      if (!repuesto.ubicaciones || !Array.isArray(repuesto.ubicaciones)) return;
      
      // Generar array con todas las instancias globales
      let ubicacionesConCantidad = [];
      repuesto.ubicaciones.forEach((ub, ubIndex) => {
        const cantidadEnUbicacion = ub.cantidadEnUbicacion || 1;
        for (let i = 1; i <= cantidadEnUbicacion; i++) {
          ubicacionesConCantidad.push({
            ubicacionIndex: ubIndex,
            instanciaLocal: i,
            ubicacion: ub
          });
        }
      });
      
      // Total global de instancias
      const totalGlobal = ubicacionesConCantidad.length;
      
      // Asignar correlativo global a cada instancia
      correlativosGlobales[repuesto.id] = {};
      ubicacionesConCantidad.forEach((item, globalIndex) => {
        const ubIndex = item.ubicacionIndex;
        
        if (!correlativosGlobales[repuesto.id][ubIndex]) {
          correlativosGlobales[repuesto.id][ubIndex] = [];
        }
        
        correlativosGlobales[repuesto.id][ubIndex].push({
          numero: globalIndex + 1,
          total: totalGlobal,
          instanciaLocal: item.instanciaLocal
        });
      });
    });
    
    return correlativosGlobales;
  },

  //  Obtener marcadores agrupados por área y categoría con numeración correlativa GLOBAL
  getMarcadoresPorArea(areaId) {
    if (!app || !app.repuestos || !Array.isArray(app.repuestos)) return {};
    
    const mapId = this.state.currentMapId;
    const marcadoresPorCategoria = {};
    
    // Obtener correlativos globales una sola vez
    const correlativosGlobales = this.calcularCorrelativosGlobales(mapId);
    
    app.repuestos.forEach(repuesto => {
      if (!repuesto.ubicaciones || !Array.isArray(repuesto.ubicaciones)) return;
      
      repuesto.ubicaciones.forEach((ubicacion, index) => {
        // Filtrar por mapa y área actual
        if (String(ubicacion.mapId) !== String(mapId)) return;
        if (String(ubicacion.areaId) !== String(areaId)) return;
        
        const categoria = ubicacion.categoria || 'Sin categoría';
        
        if (!marcadoresPorCategoria[categoria]) {
          marcadoresPorCategoria[categoria] = [];
        }
        
        // Obtener correlativos globales para esta ubicación (puede tener múltiples instancias)
        const corrInfoArray = correlativosGlobales[repuesto.id]?.[index] || [{ numero: 1, total: 1, instanciaLocal: 1 }];
        
        // Agregar una entrada por cada instancia
        corrInfoArray.forEach(corrInfo => {
          marcadoresPorCategoria[categoria].push({
            repuesto: repuesto,
            ubicacion: ubicacion,
            ubicacionIndex: index,
            numeroCorrelativo: corrInfo.numero,
            totalInstancias: corrInfo.total,
            instanciaLocal: corrInfo.instanciaLocal
          });
        });
      });
    });
    
    return marcadoresPorCategoria;
  },

  // Toggle para expandir/colapsar rea
  toggleArea(toggleBtn) {
    const areaDiv = toggleBtn.closest('[data-area-id]');
    if (!areaDiv) return;
    
    const children = areaDiv.nextElementSibling;
    if (!children || !children.classList.contains('area-children')) return;
    
    const isCollapsed = children.style.display === 'none';
    children.style.display = isCollapsed ? 'block' : 'none';
    toggleBtn.textContent = isCollapsed ? 'v' : '>';
  },

  //  Toggle para expandir/colapsar categora
  toggleCategoria(catHeader) {
    const catGroup = catHeader.closest('.categoria-group');
    if (!catGroup) return;
    
    const marcadores = catGroup.querySelector('.categoria-marcadores');
    const toggle = catHeader.querySelector('.categoria-toggle');
    if (!marcadores || !toggle) return;
    
    const isCollapsed = marcadores.style.display === 'none';
    marcadores.style.display = isCollapsed ? 'block' : 'none';
    toggle.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(-90deg)';
  },

  //  Hacer zoom a un marcador especfico
  focusOnMarker(repuestoId, ubicacionIndex) {
    //  Limpiar seleccin anterior antes de seleccionar nuevo
    const prevSelection = this.state.highlightMarker;
    const sameMarker = prevSelection && 
                       prevSelection.repuestoId === repuestoId && 
                       prevSelection.ubicacionIndex === ubicacionIndex;
    
    // Si es el mismo marcador, no hacer nada (ya est seleccionado)
    if (sameMarker) {
      console.log(' Marcador ya seleccionado');
      return;
    }
    
    //  Si haba una animacin anterior, detenerla
    if (prevSelection) {
      this.stopMarkerAnimation();
    }
    
    const repuesto = app.repuestos.find(r => r.id === repuestoId);
    if (!repuesto || !repuesto.ubicaciones || !repuesto.ubicaciones[ubicacionIndex]) {
      console.warn('focusOnMarker: repuesto o ubicacin no encontrada', { repuestoId, ubicacionIndex });
      return;
    }
    
    const ubicacion = repuesto.ubicaciones[ubicacionIndex];
    
    if (!ubicacion.markerX || !ubicacion.markerY) {
      console.warn('focusOnMarker: ubicacin sin coordenadas', ubicacion);
      return;
    }
    
    const canvas = this.elements.canvas;
    if (!canvas) {
      console.warn('focusOnMarker: canvas no disponible');
      return;
    }
    
    //  SOLUCIN: Centrar el marcador manteniendo el zoom actual
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    
    //  Calcular nuevo offset para centrar el marcador
    // Frmula canvas: screenPos = translate(offset) + scale(worldPos)
    // Para centrar: centerX = offsetX + (markerX * scale)
    // Por lo tanto: offsetX = centerX - (markerX * scale)
    this.state.offsetX = centerX - (ubicacion.markerX * this.state.scale);
    this.state.offsetY = centerY - (ubicacion.markerY * this.state.scale);
    
    console.log(` Marcador centrado: ${repuesto.nombre} #${ubicacionIndex + 1}`, {
      worldPos: [ubicacion.markerX.toFixed(1), ubicacion.markerY.toFixed(1)],
      zoom: `${Math.round(this.state.scale * 100)}%`,
      nuevoOffset: [this.state.offsetX.toFixed(1), this.state.offsetY.toFixed(1)]
    });
    
    //  Resaltar marcador de forma persistente
    this.state.highlightMarker = { repuestoId, ubicacionIndex };
    
    //  ANIMACIN: Iniciar loop para el efecto de halo pulsante
    this.startMarkerAnimation();
    
    // Redibujar para mostrar el resaltado
    this.draw();
    this.queueViewportPersist('focus-marker');
  },
  
  //  NUEVO: Iniciar animacin continua para marcador resaltado
  startMarkerAnimation() {
    // Si ya hay una animacin activa, no crear otra
    if (this.state.markerAnimationId) {
      return;
    }
    
    const animate = () => {
      // Solo continuar si hay un marcador resaltado
      if (this.state.highlightMarker) {
        this.draw();
        this.state.markerAnimationId = requestAnimationFrame(animate);
      } else {
        this.state.markerAnimationId = null;
      }
    };
    
    this.state.markerAnimationId = requestAnimationFrame(animate);
  },
  
  //  NUEVO: Detener animacin de marcador
  stopMarkerAnimation() {
    if (this.state.markerAnimationId) {
      cancelAnimationFrame(this.state.markerAnimationId);
      this.state.markerAnimationId = null;
    }
  },
  
  //  Limpiar seleccin de marcador (llamar al hacer click fuera o seleccionar otro)
  clearMarkerSelection() {
    if (this.state.highlightMarker) {
      this.state.highlightMarker = null;
      this.stopMarkerAnimation(); //  Detener animacin del halo
      this.scheduleRender();
    }
  },

  //  Abrir modal para editar datos de un marcador (jerarqua, categora)
  openEditMarkerModal(repuestoId, ubicacionIndex) {
    const repuesto = app.repuestos.find(r => r.id === repuestoId);
    if (!repuesto || !repuesto.ubicaciones || !repuesto.ubicaciones[ubicacionIndex]) {
      this.showToast(' Marcador no encontrado', 'error');
      return;
    }
    
    const ubicacion = repuesto.ubicaciones[ubicacionIndex];
    const area = this.state.areas.find(a => a.id === ubicacion.areaId);
    
    //  CALCULAR NIVEL SUGERIDO basado en la jerarqua del rea
    let nivelSugerido = 'N8'; // Por defecto N8 (Detalle)
    let razonSugerencia = '';
    
    const areaJerarquia = area ? this.normalizeAreaJerarquia(area.jerarquia) : null;
    if (areaJerarquia) {
      // Mapeo de niveles: planta  N2, areaGeneral  N3, subArea  N4, etc.
      const mapaJerarquia = {
        'planta': 'N2',
        'areaGeneral': 'N3', 
        'subArea': 'N4',
        'sistemaEquipo': 'N5',
        'subSistema': 'N6',
        'seccion': 'N7',
        'detalle': 'N8'
      };
      
      // Encontrar el nivel ms profundo definido en el rea
      const nivelesDefinidos = ['detalle', 'seccion', 'subSistema', 'sistemaEquipo', 'subArea', 'areaGeneral', 'planta'];
      for (const nivel of nivelesDefinidos) {
        if (areaJerarquia[nivel]) {
          nivelSugerido = mapaJerarquia[nivel];
          razonSugerencia = `Basado en ${areaJerarquia[nivel]}`;
          break;
        }
      }
      
      // Si el rea tiene nivel, el repuesto debera estar un nivel ms abajo
      const nivelNumerico = parseInt(nivelSugerido.substring(1));
      if (nivelNumerico < 8) {
        nivelSugerido = 'N' + (nivelNumerico + 1);
        razonSugerencia = `Repuesto dentro de ${razonSugerencia}`;
      }
    }
    
    // Obtener nivel jerrquico actual del repuesto
    const nivelActual = repuesto.nivelJerarquico || nivelSugerido;
    
    // Crear modal
    const modalHTML = `
      <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100000;">
        <div style="background: var(--bg-secondary); border-radius: 6px; padding: 20px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
          <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 1rem; font-weight: 600;">
             Editar Datos del Repuesto
          </h3>
          
          <div style="margin-bottom: 12px; padding: 10px; background: var(--bg-tertiary); border-radius: 4px;">
            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Repuesto:</div>
            <div style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">
              ${this.escapeHtml(repuesto.nombre)}
            </div>
            ${repuesto.codSAP ? `<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">SAP: ${repuesto.codSAP}</div>` : ''}
          </div>
          
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">
               Ubicacin Actual:
            </label>
            <div style="padding: 8px; background: var(--bg-tertiary); border-radius: 4px; color: var(--text-primary); font-size: 0.85rem;">
              ${this.escapeHtml(area ? area.name : 'Desconocida')}
            </div>
          </div>
          
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">
               Nivel Jerrquico:
            </label>
            ${nivelActual !== nivelSugerido && razonSugerencia ? `
              <div style="margin-bottom: 8px; padding: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 4px;">
                <div style="font-size: 0.75rem; color: #22c55e; font-weight: 600; margin-bottom: 2px;">
                   Nivel sugerido: ${nivelSugerido}
                </div>
                <div style="font-size: 0.7rem; color: var(--text-secondary);">
                  ${razonSugerencia}
                </div>
                <button onclick="document.getElementById('editMarkerNivel').value='${nivelSugerido}'; this.parentElement.style.display='none';" style="margin-top: 6px; padding: 4px 12px; background: #22c55e; color: white; border: none; border-radius: 3px; font-size: 0.7rem; cursor: pointer; font-weight: 600;">
                   Aplicar Sugerencia
                </button>
              </div>
            ` : ''}
            <select id="editMarkerNivel" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.9rem;">
              <option value="N1" ${nivelActual === 'N1' ? 'selected' : ''}>N1 - Empresa</option>
              <option value="N2" ${nivelActual === 'N2' ? 'selected' : ''}>N2 - Planta (Planta Principal, Acopio, etc.)</option>
              <option value="N3" ${nivelActual === 'N3' ? 'selected' : ''}>N3 - rea General</option>
              <option value="N4" ${nivelActual === 'N4' ? 'selected' : ''}>N4 - Sub-rea</option>
              <option value="N5" ${nivelActual === 'N5' ? 'selected' : ''}>N5 - Sistema/Equipo</option>
              <option value="N6" ${nivelActual === 'N6' ? 'selected' : ''}>N6 - Sub-Sistema</option>
              <option value="N7" ${nivelActual === 'N7' ? 'selected' : ''}>N7 - Seccin</option>
              <option value="N8" ${nivelActual === 'N8' ? 'selected' : ''}>N8 - Detalle (predeterminado)</option>
            </select>
          </div>
          
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">
               Categora:
            </label>
            <select id="editMarkerCategoria" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.9rem;">
              <option value="Sin categora" ${ubicacion.categoria === 'Sin categora' ? 'selected' : ''}>Sin categora</option>
              <option value="Componentes" ${ubicacion.categoria === 'Componentes' ? 'selected' : ''}>Componentes</option>
              <option value="Elctrico" ${ubicacion.categoria === 'Elctrico' ? 'selected' : ''}>Elctrico</option>
              <option value="Mecnico" ${ubicacion.categoria === 'Mecnico' ? 'selected' : ''}>Mecnico</option>
              <option value="Hidrulico" ${ubicacion.categoria === 'Hidrulico' ? 'selected' : ''}>Hidrulico</option>
              <option value="Neumtico" ${ubicacion.categoria === 'Neumtico' ? 'selected' : ''}>Neumtico</option>
              <option value="Estructura" ${ubicacion.categoria === 'Estructura' ? 'selected' : ''}>Estructura</option>
              <option value="Seguridad" ${ubicacion.categoria === 'Seguridad' ? 'selected' : ''}>Seguridad</option>
              <option value="Instrumentacin" ${ubicacion.categoria === 'Instrumentacin' ? 'selected' : ''}>Instrumentacin</option>
              <option value="Otro" ${ubicacion.categoria === 'Otro' ? 'selected' : ''}>Otro</option>
            </select>
          </div>
          
          <div style="margin-bottom: 16px; padding: 10px; background: rgba(99,102,241,0.08); border-left: 3px solid #6366f1; border-radius: 4px;">
            <p style="margin: 0 0 6px 0; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">
               Sobre el nivel jerrquico:
            </p>
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.75rem; line-height: 1.4;">
              El nivel determina el orden en cascada e inventario. N1 (Empresa) es el ms alto, N8 (Detalle) el ms especfico. Usa los mismos niveles configurados en Configuracin.
            </p>
          </div>
          
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button id="editMarkerCancelBtn" style="padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.9rem;">
              Cancelar
            </button>
            <button id="editMarkerSaveBtn" style="padding: 8px 16px; background: var(--primary); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
              Guardar
            </button>
          </div>
        </div>
      </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Event listeners
    const cancelBtn = modalContainer.querySelector('#editMarkerCancelBtn');
    const saveBtn = modalContainer.querySelector('#editMarkerSaveBtn');
    
    cancelBtn.onclick = () => {
      document.body.removeChild(modalContainer);
    };
    
    saveBtn.onclick = () => {
      const nuevaCategoria = modalContainer.querySelector('#editMarkerCategoria').value;
      const nuevoNivel = modalContainer.querySelector('#editMarkerNivel').value;
      
      // Actualizar la categora en la ubicacin especfica
      repuesto.ubicaciones[ubicacionIndex].categoria = nuevaCategoria;
      
      // Actualizar el nivel jerrquico del repuesto (aplica a todas sus ubicaciones)
      repuesto.nivelJerarquico = nuevoNivel;
      
      // Guardar cambios
      app.guardarDatos();
      
      // Cerrar modal
      document.body.removeChild(modalContainer);
      
      // Re-renderizar lista
      this.renderAreaList(this.state.areas);
      
      this.showToast(` Repuesto actualizado: Nivel ${nuevoNivel}`, 'success');
    };
  },

  renderAreaList(areas) {
    const { areaList } = this.elements;
    if (!areaList) return;

    this.renderMapJerarquiaBranch();

    //  Aplicar filtro de categora si est activo
    let filteredAreas = Array.isArray(areas) ? areas : [];

    if (this.state.jerarquiaBranchFilter) {
      filteredAreas = this.applyActiveBranchFilter(filteredAreas);
    }

    if (this.state.categoryFilter) {
      filteredAreas = filteredAreas.filter(area => (area.category || 'area') === this.state.categoryFilter);
    }

    //  NUEVO: Aplicar filtro de bsqueda si existe texto
    const searchInput = document.getElementById('mapAreaSearch');
    if (searchInput && searchInput.value.trim()) {
      const searchTerm = searchInput.value.trim().toLowerCase();
      filteredAreas = filteredAreas.filter(area => {
        const areaName = (area.name || '').toLowerCase();
        const normalized = this.normalizeAreaJerarquia(area.jerarquia);
        const jerarquia = Object.values(normalized).filter(Boolean).join(' ').toLowerCase();
        return areaName.includes(searchTerm) || jerarquia.includes(searchTerm);
      });
    }

    const filterLabel = this.getActiveBranchFilterLabel();
    const filterNoticeHtml = filterLabel
      ? `<div class="map-area-filter-alert">Filtrando por jerarqua: <strong>${this.escapeHtml(filterLabel)}</strong> <button type="button" data-action="branch-clear-filter">Limpiar</button></div>`
      : '';

    if (!Array.isArray(filteredAreas) || !filteredAreas.length) {
      let mensaje = this.state.categoryFilter 
        ? `No hay reas de la categora seleccionada.`
        : (searchInput && searchInput.value.trim() ? `No se encontraron reas con "${searchInput.value.trim()}".` : `No hay reas registradas para este mapa.`);
      if (filterLabel) {
        mensaje = `No se encontraron reas para el nivel "${filterLabel}".`;
      }
      areaList.innerHTML = `${filterNoticeHtml}<div style="padding: 12px; border: 1px dashed var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 0.8rem;">${mensaje}</div>`;
      if (filterLabel) {
        const clearBtn = areaList.querySelector('[data-action="branch-clear-filter"]');
        if (clearBtn) {
          clearBtn.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            this.clearJerarquiaBranchFilter();
          });
        }
      }
      return;
    }

    //  Construir rbol jerrquico completo (6 niveles)
    const tree = this.buildHierarchyTree(filteredAreas);
    areaList.innerHTML = `${filterNoticeHtml}${this.renderHierarchyTree(tree)}`;

    if (filterLabel) {
      const clearBtn = areaList.querySelector('[data-action="branch-clear-filter"]');
      if (clearBtn) {
        clearBtn.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          this.clearJerarquiaBranchFilter();
        });
      }
    }

    // Event listeners para enfocar zona
    Array.from(areaList.querySelectorAll('[data-action="focus-area"]')).forEach(content => {
      content.addEventListener('click', (e) => {
        const areaId = e.target.closest('[data-area-id]')?.getAttribute('data-area-id');
        if (areaId) this.focusArea(areaId);
      });
    });

    // Event listeners para editar forma (puntos) de zona
    Array.from(areaList.querySelectorAll('[data-action="edit-area-points"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        await this.startEditAreaPoints(areaId);
      });
    });

    // Event listeners para editar metadatos de zona
    Array.from(areaList.querySelectorAll('[data-action="edit-area-metadata"]')).forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        this.openEditAreaMetadataModal(areaId);
      });
    });

    // Event listeners para editar la jerarqua desde la lista principal
    Array.from(areaList.querySelectorAll('[data-action="edit-area-hierarchy"]')).forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        this.openEditAreaHierarchyModal(areaId);
      });
    });

    // Event listeners para eliminar zona
    Array.from(areaList.querySelectorAll('[data-action="delete-area"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        await this.deleteArea(areaId);
      });
    });
  },

  handleJerarquiaStructureUpdate(eventDetail = {}) {
    this.state.lastJerarquiaSync = Date.now();
    this.cachedJerarquiaStructure = app?.jerarquiaAnidada || null;
    this.cachedJerarquiaOptions = this.mergeWithFallbackJerarquiaOptions(
      this.buildJerarquiaOptionSetsFromStructure(this.cachedJerarquiaStructure)
    );

    if (!this.elements || !this.elements.areaList) {
      this.state.pendingJerarquiaRefresh = true;
      return;
    }

    this.state.pendingJerarquiaRefresh = false;

    if (Array.isArray(this.state.areas) && this.state.areas.length) {
      this.renderAreaList(this.state.areas);
    }

    if (!eventDetail?.silent) {
      console.log(' mapController: Jerarquia actualizada', eventDetail);
    }
  },

  handleJerarquiaCatalogUpdate(eventDetail = {}) {
    this.state.lastCatalogSync = Date.now();
    this.cachedJerarquiaOptions = this.mergeWithFallbackJerarquiaOptions(
      this.buildJerarquiaOptionSetsFromStructure(app?.jerarquiaAnidada)
    );

    if (!this.elements || !this.elements.areaList) {
      this.state.pendingCatalogRefresh = true;
      return;
    }

    this.state.pendingCatalogRefresh = false;

    if (Array.isArray(this.state.areas) && this.state.areas.length) {
      this.renderAreaList(this.state.areas);
    }

    this.refreshAreaMetadataFormOptions();

    if (!eventDetail?.silent) {
      console.log(' mapController: Catalogos de jerarquia actualizados', eventDetail);
    }
  },

  refreshAreaMetadataFormOptions() {
    const form = document.getElementById('editAreaForm');
    if (!form) return;

    const jerarquiaOptions = this.getJerarquiaOptionCatalog();
    const datalistConfig = [
      { id: 'plantaList', key: 'planta' },
      { id: 'areaGeneralList', key: 'areaGeneral' },
      { id: 'subAreaList', key: 'subArea' },
      { id: 'sistemaEquipoList', key: 'sistemaEquipo' },
      { id: 'subSistemaList', key: 'subSistema' },
      { id: 'seccionList', key: 'seccion' }
    ];

    datalistConfig.forEach(({ id, key }) => {
      const listElement = document.getElementById(id);
      if (!listElement) return;

      const values = Array.isArray(jerarquiaOptions[key]) ? jerarquiaOptions[key] : [];
      listElement.innerHTML = values.map((value) => `<option value="${this.escapeHtml(value)}"></option>`).join('');
    });
  },

  //  MODAL CASCADA JERRQUICA GRANDE
  openCascadaModal() {
    console.log(' openCascadaModal llamado');
    
    const modal = document.getElementById('modalCascada');
    const contentDiv = document.getElementById('cascadaContent');
    
    console.log('Modal:', modal);
    console.log('ContentDiv:', contentDiv);
    
    if (!modal || !contentDiv) {
      console.error(' Modal de cascada no encontrado en el DOM');
      alert('Error: Modal no encontrado. Por favor recarga la pgina.');
      return;
    }

    // Obtener reas del mapa actual desde el state
    const currentMap = this.state.currentMap;
    const areas = this.state.areas || [];
    
    console.log('Current Map:', currentMap);
    console.log('Areas:', areas);
    
    if (!currentMap || !areas || areas.length === 0) {
  console.log('[WARN] No hay reas en el mapa actual');
      contentDiv.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
          <div style="font-size: 4rem; margin-bottom: 16px;"></div>
          <h3 style="margin: 0 0 8px 0;">No hay reas en este mapa</h3>
          <p style="margin: 0; opacity: 0.7;">Dibuja algunas reas primero para ver la cascada jerrquica</p>
        </div>
      `;
      modal.style.display = 'block';
      console.log(' Modal mostrado (sin reas)');
      return;
    }

    // Construir y renderizar el rbol jerrquico
    const tree = this.buildHierarchyTree(areas);
    contentDiv.innerHTML = this.renderHierarchyTree(tree);

    // Agregar event listeners para interaccin
    this.attachCascadaEventListeners(contentDiv);
    
    // Calcular y mostrar estadsticas
    this.updateCascadaStats(areas);

    // Mostrar modal
    console.log(' Mostrando modal...');
    modal.style.display = 'block';
    modal.style.zIndex = '99999'; // Forzar z-index muy alto
    console.log(' Modal display:', modal.style.display);
    console.log(' Modal z-index:', modal.style.zIndex);

    // ESC key para cerrar
    const escHandler = (e) => {
      if (e.key === 'Escape') {
        console.log(' ESC presionado, cerrando modal');
        modal.style.display = 'none';
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);

    // Limpiar input de bsqueda
    const searchInput = document.getElementById('cascadaSearchInput');
    if (searchInput) searchInput.value = '';
    
    console.log(' Modal completamente configurado y visible');
  },

  // Agregar event listeners a la cascada en el modal
  attachCascadaEventListeners(container) {
    // Event listeners para enfocar zona
    Array.from(container.querySelectorAll('[data-action="focus-area"]')).forEach(content => {
      content.addEventListener('click', (e) => {
        const areaId = e.target.closest('[data-area-id]')?.getAttribute('data-area-id');
        if (areaId) {
          this.focusArea(areaId);
          // Cerrar modal despus de enfocar
          document.getElementById('modalCascada').style.display = 'none';
        }
      });
    });

    // Event listeners para editar forma (puntos) de zona
    Array.from(container.querySelectorAll('[data-action="edit-area-points"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        await this.startEditAreaPoints(areaId);
        document.getElementById('modalCascada').style.display = 'none';
      });
    });

    // Event listeners para editar metadatos de zona
    Array.from(container.querySelectorAll('[data-action="edit-area-metadata"]')).forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        this.openEditAreaMetadataModal(areaId);
        document.getElementById('modalCascada').style.display = 'none';
      });
    });

    // Event listeners para editar jerarqua de rea
    Array.from(container.querySelectorAll('[data-action="edit-area-hierarchy"]')).forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        this.openEditAreaHierarchyModal(areaId);
      });
    });

    // Event listeners para eliminar zona
    Array.from(container.querySelectorAll('[data-action="delete-area"]')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const areaId = btn.getAttribute('data-area-id');
        await this.deleteArea(areaId);
        // Refrescar contenido del modal
        this.openCascadaModal();
      });
    });
  },

  // Filtrar cascada por bsqueda
  filterCascada(searchTerm) {
    const contentDiv = document.getElementById('cascadaContent');
    if (!contentDiv) return;

    const areas = this.state.areas || [];
    
    if (!areas || areas.length === 0) return;

    // Filtrar reas por trmino de bsqueda
    const filtered = searchTerm.trim() 
      ? areas.filter(area => {
          const normalized = this.normalizeAreaJerarquia(area.jerarquia);
          const searchLower = searchTerm.toLowerCase();
          return (
            (area.name || '').toLowerCase().includes(searchLower) ||
            Object.values(normalized).some(val => 
              (val || '').toLowerCase().includes(searchLower)
            )
          );
        })
      : areas;

    const tree = this.buildHierarchyTree(filtered);
    contentDiv.innerHTML = filtered.length > 0 
      ? this.renderHierarchyTree(tree)
      : `<div style="text-align: center; padding: 40px; color: var(--text-secondary);">
           <div style="font-size: 3rem;"></div>
           <p>No se encontraron reas con "${searchTerm}"</p>
         </div>`;

    this.attachCascadaEventListeners(contentDiv);
  },

  // Expandir todos los nodos
  expandAllCascada() {
    const contentDiv = document.getElementById('cascadaContent');
    if (!contentDiv) return;
    
    // Buscar todos los divs que tienen el toggle
    const allParents = contentDiv.querySelectorAll('[onclick*="nextElementSibling.style.display"]');
    allParents.forEach(parent => {
      const content = parent.nextElementSibling;
      const toggleIcon = parent.querySelector('.toggle');
      if (content && toggleIcon) {
        content.style.display = 'block';
        toggleIcon.textContent = 'v';
      }
    });
    
    console.log(' Todos los nodos expandidos');
  },

  // Colapsar todos los nodos
  collapseAllCascada() {
    const contentDiv = document.getElementById('cascadaContent');
    if (!contentDiv) return;
    
    // Buscar todos los divs que tienen el toggle
    const allParents = contentDiv.querySelectorAll('[onclick*="nextElementSibling.style.display"]');
    allParents.forEach(parent => {
      const content = parent.nextElementSibling;
      const toggleIcon = parent.querySelector('.toggle');
      if (content && toggleIcon) {
        content.style.display = 'none';
        toggleIcon.textContent = '>';
      }
    });
    
    console.log(' Todos los nodos colapsados');
  },

  // Modal para editar solo la jerarqua de un rea
  openEditAreaHierarchyModal(areaId) {
    const numericId = typeof areaId === 'string' ? parseInt(areaId, 10) : areaId;
    const area = this.state.areas.find(a => a.id === numericId);
    
    if (!area) {
      this.showToast('rea no encontrada', 'error');
      return;
    }

    const jerarquia = this.normalizeAreaJerarquia(area.jerarquia);
    const jerarquiaOptions = this.getJerarquiaOptionCatalog();
    
    const buildDatalist = (id, values) => {
      if (!Array.isArray(values) || !values.length) return '';
      return `<datalist id="${id}">${values.map(v => `<option value="${this.escapeHtml(v)}"></option>`).join('')}</datalist>`;
    };

    // Crear modal simple
    const modalHTML = `
      <div id="modalEditHierarchy" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target.id==='modalEditHierarchy') this.remove()">
        <div style="background: var(--bg-primary); border-radius: 8px; padding: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; color: var(--text-primary);">Editar Jerarqua de rea</h3>
            <button onclick="document.getElementById('modalEditHierarchy').remove()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer;"></button>
          </div>
          
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 16px;">
            <div style="color: var(--text-secondary); font-size: 0.9rem;">
              <strong style="color: var(--text-primary);">rea:</strong> ${this.escapeHtml(area.name || 'Sin nombre')}
            </div>
          </div>
          
          <!-- 💡 PANEL DE AYUDA: ÁREAS GENÉRICAS -->
          <div style="padding: 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 6px; margin-bottom: 16px; border: 1px solid rgba(59,130,246,0.3);">
            <div style="color: white; font-size: 0.9rem;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 1.2rem;">💡</span>
                <strong>Áreas Genéricas para Elementos Comunes</strong>
              </div>
              <div style="font-size: 0.85rem; opacity: 0.95; line-height: 1.5;">
                Para pernos, tornillos, consumibles y otros elementos de uso general, puedes crear áreas específicas como:
              </div>
              <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 0.8rem;">
                <div style="background: rgba(255,255,255,0.15); padding: 6px 10px; border-radius: 4px;">🔧 <strong>Elementos Comunes</strong></div>
                <div style="background: rgba(255,255,255,0.15); padding: 6px 10px; border-radius: 4px;">📦 <strong>Consumibles Generales</strong></div>
                <div style="background: rgba(255,255,255,0.15); padding: 6px 10px; border-radius: 4px;">🔩 <strong>Pernería General</strong></div>
                <div style="background: rgba(255,255,255,0.15); padding: 6px 10px; border-radius: 4px;">⚙️ <strong>Repuestos Transversales</strong></div>
                <div style="background: rgba(255,255,255,0.15); padding: 6px 10px; border-radius: 4px;">🛠️ <strong>Herramientas Compartidas</strong></div>
                <div style="background: rgba(255,255,255,0.15); padding: 6px 10px; border-radius: 4px;">🔌 <strong>Componentes Eléctricos</strong></div>
              </div>
              <div style="margin-top: 10px; font-size: 0.75rem; opacity: 0.85; font-style: italic;">
                ℹ️ Estos elementos pueden coexistir con repuestos específicos de equipos. Un perno puede estar en "Pernería General" Y en "Baader 142 → Motor".
              </div>
            </div>
          </div>
          
          <form id="formEditHierarchy" style="display: flex; flex-direction: column; gap: 12px;">
            
            <!-- 🔧 CHECKBOX: MARCAR COMO ÁREA GENÉRICA -->
            <div style="padding: 14px; background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(5,150,105,0.05) 100%); border: 2px solid rgba(16,185,129,0.3); border-radius: 8px; margin-bottom: 8px;">
              <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none;">
                <input type="checkbox" id="checkboxAreaGenerica" name="esAreaGenerica" ${area.esAreaGenerica ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer; accent-color: #10b981;" />
                <div style="flex: 1;">
                  <div style="color: var(--text-primary); font-weight: 700; font-size: 0.95rem; margin-bottom: 4px;">
                    🔧 Marcar como Área de Uso General
                  </div>
                  <div style="color: var(--text-secondary); font-size: 0.8rem; line-height: 1.4;">
                    Si activas esta opción, el área aparecerá en una sección separada visualmente, fuera de la jerarquía organizacional normal. Ideal para elementos comunes, consumibles, pernería, etc.
                  </div>
                </div>
              </label>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N1 - Empresa 🏢
                <span title="Nivel corporativo más alto (ej: Aquachile Antarfood)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel1" list="nivel1List" placeholder="Ej: Aquachile Antarfood" value="${this.escapeHtml(jerarquia.nivel1 || 'Aquachile Antarfood')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel1List', ['Aquachile Antarfood'])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N2 - Área 🏭
                <span title="Área de la planta (ej: Planta Principal, Procesamiento) o Área Genérica (ej: 🔧 Elementos Comunes)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel2" list="nivel2List" placeholder="Ej: Planta Principal o 🔧 Elementos Comunes" value="${this.escapeHtml(jerarquia.nivel2 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel2List', jerarquiaOptions.nivel2 || [])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N3 - Sub-área 📍
                <span title="Zona específica (ej: Eviscerado, Filete) o Categoría Genérica (ej: Pernería General, Consumibles)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel3" list="nivel3List" placeholder="Ej: Eviscerado o Pernería General" value="${this.escapeHtml(jerarquia.nivel3 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel3List', jerarquiaOptions.nivel3 || [])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N4 - Sistema ⚙️
                <span title="Sistema o equipo principal (ej: Grader, Marel)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel4" list="nivel4List" placeholder="Ej: Grader" value="${this.escapeHtml(jerarquia.nivel4 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel4List', jerarquiaOptions.nivel4 || [])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N5 - Sub-sistema 🔧
                <span title="Componente del sistema (ej: Pocket 1-4, Cinta Z)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel5" list="nivel5List" placeholder="Ej: Pocket 1-4" value="${this.escapeHtml(jerarquia.nivel5 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel5List', jerarquiaOptions.nivel5 || [])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N6 - Sección 📦
                <span title="Sección específica (ej: Sistema Neumático, Hidráulico)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel6" list="nivel6List" placeholder="Ej: Sistema Neumático" value="${this.escapeHtml(jerarquia.nivel6 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel6List', jerarquiaOptions.nivel6 || [])}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                N7 - Sub-sección 🔩
                <span title="Detalle más específico (ej: Válvula Principal, Sensor)" style="cursor: help; color: var(--text-tertiary); font-size: 0.75rem;">ℹ️</span>
              </label>
              <input type="text" name="nivel7" list="nivel7List" placeholder="Ej: Válvula Principal" value="${this.escapeHtml(jerarquia.nivel7 || '')}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />
              ${buildDatalist('nivel7List', jerarquiaOptions.nivel7 || [])}
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button type="button" onclick="document.getElementById('modalEditHierarchy').remove()" style="flex: 1; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); cursor: pointer;">
                Cancelar
              </button>
              <button type="submit" style="flex: 1; padding: 10px; background: var(--primary); border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: 600;">
                Guardar Jerarqua
              </button>
            </div>
          </form>
        </div>
      </div>
    `;
    
    // Agregar al DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Event listener para el formulario
    const form = document.getElementById('formEditHierarchy');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      // NUEVA ESTRUCTURA: Guardar en jerarquía unificada de 7 niveles
      const newJerarquia = {
        nivel1: formData.get('nivel1') || 'Aquachile Antarfood',
        nivel2: formData.get('nivel2') || null,
        nivel3: formData.get('nivel3') || null,
        nivel4: formData.get('nivel4') || null,
        nivel5: formData.get('nivel5') || null,
        nivel6: formData.get('nivel6') || null,
        nivel7: formData.get('nivel7') || null
      };
      
      // 🔧 CAPTURAR CHECKBOX DE ÁREA GENÉRICA
      const esAreaGenerica = formData.get('esAreaGenerica') === 'on';
      
      console.log('🔧 Guardando área:', {
        areaId: area.id,
        nombre: area.name,
        esAreaGenerica,
        jerarquia: newJerarquia
      });
      
      // Preservar jerarquía legacy si existía (para rollback)
      if (area.jerarquia && !area._jerarquiaLegacy) {
        area._jerarquiaLegacy = { ...area.jerarquia };
      }
      
      // Actualizar área con nueva jerarquía Y marca de genérica
      area.jerarquia = newJerarquia;
      area.esAreaGenerica = esAreaGenerica;
      
      console.log('📦 Área antes de guardar:', JSON.stringify(area, null, 2));
      
      // Guardar
      await mapStorage.updateArea(area);
      
      console.log('✅ Área guardada en mapStorage');
      
      // 🔄 INVALIDAR CACHÉ DE JERARQUÍA PARA FORZAR RECONSTRUCCIÓN
      this.cachedJerarquiaOptions = null;
      this.jerarquiaAnidada = null;
      
      console.log('🔄 Reconstruyendo jerarquía anidada...');
      
      // Reconstruir jerarquía anidada
      await this.construirJerarquiaAnidada();
      
      console.log('🌳 Jerarquía anidada reconstruida');
      
      // Renderizar árbol actualizado
      this.renderizarArbolJerarquia();
      
      console.log('✅ Árbol renderizado');
      
      // Cerrar modal
      document.getElementById('modalEditHierarchy').remove();
      
      // Refrescar cascada si está abierta
      const modalCascada = document.getElementById('modalCascada');
      if (modalCascada && modalCascada.style.display !== 'none') {
        this.openCascadaModal();
      }
      
      this.showToast(esAreaGenerica ? '🔧 Área marcada como genérica' : '✅ Jerarquía actualizada', 'success');
      console.log('🎉 Proceso completado');
    });
  },

  // Exportar cascada a JSON
  exportCascada() {
    const currentMap = this.state.currentMap;
    const areas = this.state.areas || [];
    
    if (!currentMap || !areas || areas.length === 0) {
      alert('No hay datos para exportar');
      return;
    }

    const tree = this.buildHierarchyTree(areas);
    const dataStr = JSON.stringify(tree, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `cascada_jerarquica_${currentMap.name || 'mapa'}_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  },

  // Toggle modo edicin de cascada
  toggleCascadaEditMode() {
    this.state.cascadaEditMode = !this.state.cascadaEditMode;
    const btn = document.getElementById('cascadaEditModeBtn');
    
    if (this.state.cascadaEditMode) {
      if (btn) {
        btn.classList.add('active');
        btn.style.background = 'var(--success)';
        btn.style.color = 'white';
      }
      this.showToast(' Modo edicin activado', 'success');
      console.log(' Modo edicin de cascada ACTIVADO');
    } else {
      if (btn) {
        btn.classList.remove('active');
        btn.style.background = '';
        btn.style.color = '';
      }
      this.showToast(' Modo edicin desactivado', 'info');
      console.log(' Modo edicin de cascada DESACTIVADO');
    }
  },

  // Calcular estadsticas de la cascada
  updateCascadaStats(areas) {
    const statsAreas = document.getElementById('statsAreas');
    const statsMarcadores = document.getElementById('statsMarcadores');
    const statsSinJerarquia = document.getElementById('statsSinJerarquia');
    
    if (!statsAreas || !statsMarcadores || !statsSinJerarquia) return;
    
    // Contar reas
    const totalAreas = areas.length;
    
    // Contar reas sin jerarqua definida (todas vacas o "Sin...")
    const areasSinJerarquia = areas.filter(area => {
      const j = area.jerarquia || {};
      return (!j.planta || j.planta === 'Sin planta') && 
             (!j.areaGeneral || j.areaGeneral === 'Sin rea') &&
             !j.subArea && !j.sistemaEquipo && !j.subSistema && !j.seccion;
    }).length;
    
    // Contar marcadores
    let totalMarcadores = 0;
    let marcadoresSinNivel = 0;
    
    const repuestos = app?.repuestos || [];
    repuestos.forEach(rep => {
      if (rep.ubicaciones && Array.isArray(rep.ubicaciones)) {
        rep.ubicaciones.forEach(ub => {
          if (ub.mapaId === this.state.currentMapId) {
            totalMarcadores++;
            if (!rep.nivelJerarquico || rep.nivelJerarquico === '') {
              marcadoresSinNivel++;
            }
          }
        });
      }
    });
    
    // Actualizar UI
    statsAreas.textContent = totalAreas;
    statsMarcadores.textContent = totalMarcadores;
    statsSinJerarquia.textContent = areasSinJerarquia + marcadoresSinNivel;
    
    // Cambiar color si hay elementos sin jerarqua
    const statsSinJerarquiaParent = statsSinJerarquia.parentElement;
    if (areasSinJerarquia + marcadoresSinNivel > 0) {
      statsSinJerarquiaParent.style.color = '#f59e0b';
    } else {
      statsSinJerarquiaParent.style.color = 'var(--text-secondary)';
    }
  },

  // Toggle mostrar solo elementos con jerarqua
  toggleMostrarSoloConJerarquia() {
    this.state.mostrarSoloConJerarquia = !this.state.mostrarSoloConJerarquia;
    const btn = document.getElementById('btnToggleVacias');
    
    if (this.state.mostrarSoloConJerarquia) {
      btn.textContent = ' Mostrar vacas';
      btn.style.background = 'var(--primary)';
      btn.style.color = 'white';
    } else {
      btn.textContent = ' Ocultar vacas';
      btn.style.background = '';
      btn.style.color = '';
    }
    
    // Refrescar vista
    this.openCascadaModal();
  },

  //  Construir rbol jerrquico de 6 niveles (MEJORADO: sin duplicados)
  buildHierarchyTree(areas) {
    const tree = {};
    
    // Filtrar reas vacas si est activado
    let areasToProcess = areas;
    if (this.state.mostrarSoloConJerarquia) {
      areasToProcess = areas.filter(area => {
        const j = area.jerarquia || {};
        return (j.planta && j.planta !== 'Sin planta') || 
               (j.areaGeneral && j.areaGeneral !== 'Sin rea') ||
               j.subArea || j.sistemaEquipo || j.subSistema || j.seccion;
      });
    }
    
    areasToProcess.forEach(area => {
      const normalizedJerarquia = this.normalizeAreaJerarquia(area.jerarquia);
      const planta = normalizedJerarquia.planta || 'Sin empresa';
      const areaGeneral = normalizedJerarquia.areaGeneral || 'Sin rea';
      const subArea = normalizedJerarquia.subArea || null;
      const sistema = normalizedJerarquia.sistemaEquipo || null;
      const subSistema = normalizedJerarquia.subSistema || null;
      const seccion = normalizedJerarquia.seccion || null;
      
      //  DETECTAR NIVEL MS PROFUNDO - El rea solo se agrega UNA VEZ en su nivel ms especfico
      let nivelMasProfundo = null;
      let targetNode = null;
      
      // Nivel 1: Planta
      if (!tree[planta]) tree[planta] = {};
      
      // Nivel 2: rea General
      if (!tree[planta][areaGeneral]) tree[planta][areaGeneral] = {};
      
      // Si no hay ms niveles definidos, el rea va aqu
      if (!subArea && !sistema && !subSistema && !seccion) {
        nivelMasProfundo = 'areaGeneral';
        targetNode = tree[planta][areaGeneral];
      }
      
      // Nivel 3: Sub-rea
      if (subArea) {
        if (!tree[planta][areaGeneral][subArea]) tree[planta][areaGeneral][subArea] = {};
        
        // Si no hay ms niveles, el rea va aqu
        if (!sistema && !subSistema && !seccion) {
          nivelMasProfundo = 'subArea';
          targetNode = tree[planta][areaGeneral][subArea];
        }
        
        // Nivel 4: Sistema/Equipo
        if (sistema) {
          if (!tree[planta][areaGeneral][subArea][sistema]) tree[planta][areaGeneral][subArea][sistema] = {};
          
          // Si no hay ms niveles, el rea va aqu
          if (!subSistema && !seccion) {
            nivelMasProfundo = 'sistema';
            targetNode = tree[planta][areaGeneral][subArea][sistema];
          }
          
          // Nivel 5: Sub-sistema
          if (subSistema) {
            if (!tree[planta][areaGeneral][subArea][sistema][subSistema]) tree[planta][areaGeneral][subArea][sistema][subSistema] = {};
            
            // Si no hay ms niveles, el rea va aqu
            if (!seccion) {
              nivelMasProfundo = 'subSistema';
              targetNode = tree[planta][areaGeneral][subArea][sistema][subSistema];
            }
            
            // Nivel 6: Seccin (nivel ms profundo posible)
            if (seccion) {
              if (!tree[planta][areaGeneral][subArea][sistema][subSistema][seccion]) {
                tree[planta][areaGeneral][subArea][sistema][subSistema][seccion] = { _areas: [] };
              }
              nivelMasProfundo = 'seccion';
              targetNode = tree[planta][areaGeneral][subArea][sistema][subSistema][seccion];
            }
          }
        }
      }
      
      //  AGREGAR EL REA SOLO UNA VEZ EN SU NIVEL MS PROFUNDO
      if (targetNode) {
        if (!targetNode._areas) {
          targetNode._areas = [];
        }
        // Evitar duplicados por ID
        if (!targetNode._areas.find(a => a.id === area.id)) {
          targetNode._areas.push(area);
        }
      }
    });
    
    return tree;
  },

  //  Renderizar rbol jerrquico completo (MEJORADO: ordenado alfabticamente)
  renderHierarchyTree(tree, level = 0) {
    let html = '';
    const indent = level * 12; // 12px por nivel
    
    //  ORDENAR CLAVES alfabticamente (espaol), _areas siempre al final
    const keys = Object.keys(tree).sort((a, b) => {
      if (a === '_areas') return 1; // _areas al final
      if (b === '_areas') return -1;
      return a.localeCompare(b, 'es', { sensitivity: 'base', numeric: true });
    });
    
    for (const key of keys) {
      if (key === '_areas') {
        //  ORDENAR REAS alfabticamente por nombre
        const areasOrdenadas = [...tree[key]].sort((a, b) => {
          return (a.name || '').localeCompare(b.name || '', 'es', { sensitivity: 'base' });
        });
        
        // Renderizar reas en este nivel
        areasOrdenadas.forEach(area => {
          html += this.renderAreaItem(area, indent, level);
        });
      } else {
        // Renderizar nodo de jerarqua
        const childrenHTML = this.renderHierarchyTree(tree[key], level + 1);
        const hasChildren = childrenHTML.trim().length > 0;
        
        //  Badge de nivel jerrquico - MOVIDO A LA IZQUIERDA
        const nivelBadge = `<span style="
          background: rgba(59, 130, 246, 0.2);
          color: #60a5fa;
          padding: 1px 4px;
          border-radius: 2px;
          font-size: 0.65rem;
          font-weight: 600;
          font-family: monospace;
          min-width: 22px;
          text-align: center;
        ">N${Math.max(1, level + 1)}</span>`;
        
        html += `
          <div style="margin-bottom: 1px;">
            <div style="
              padding: 4px 6px;
              padding-left: ${indent + 6}px;
              background: rgba(255,255,255,0.02);
              border-left: 2px solid rgba(100,100,100,0.3);
              font-size: 0.75rem;
              font-weight: 600;
              color: #d4d4d4;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 6px;
            " onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle').textContent = this.nextElementSibling.style.display === 'none' ? '>' : 'v'">
              <span class="toggle" style="font-size: 0.7rem; width: 8px; font-family: monospace;">${hasChildren ? 'v' : '>'}</span>
              ${nivelBadge}
              <span style="flex: 1;">${this.escapeHtml(key)}</span>
            </div>
            <div style="display: ${hasChildren ? 'block' : 'none'};">
              ${childrenHTML}
            </div>
          </div>
        `;
      }
    }
    
    return html;
  },

  //  Renderizar item de rea individual
  renderAreaItem(area, indent, level = 0) {
    const color = area.color || '#3b82f6';
    const category = area.category || 'area';
    
    //  Obtener marcadores agrupados por categora para esta rea
    const marcadoresPorCategoria = this.getMarcadoresPorArea(area.id);
    const totalMarcadores = Object.values(marcadoresPorCategoria).reduce((sum, markers) => sum + markers.length, 0);

    //  Badge de nivel jerrquico para rea (nivel+1 porque el rea es un nivel ms profundo que su nodo padre)
    const nivelBadge = `<span style="
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
      padding: 1px 4px;
      border-radius: 2px;
      font-size: 0.65rem;
      font-weight: 600;
      font-family: monospace;
      margin-left: 4px;
    ">N${Math.max(1, level + 1)}</span>`;

    // Generar HTML para las categoras y marcadores
    let categoriasHTML = '';
    const categorias = Object.keys(marcadoresPorCategoria).sort();
    
    if (categorias.length > 0) {
      categoriasHTML = categorias.map(catNombre => {
        const marcadores = marcadoresPorCategoria[catNombre];
        
        const marcadoresHTML = marcadores.map(m => {
          // Mostrar nmero correlativo solo si hay ms de 1 instancia
          const showCorrelativo = m.totalInstancias > 1;
          
          return `
          <div class="marker-item" style="
            padding: 3px 8px;
            padding-left: ${indent + 24}px;
            font-size: 0.72rem;
            color: #bbb;
            cursor: pointer;
            transition: all 0.1s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
          " 
          onmouseover="this.style.background='rgba(255,255,255,0.05)'; this.style.color='#fff'; this.querySelector('.marker-edit-btn').style.opacity='1'"
          onmouseout="this.style.background='transparent'; this.style.color='#bbb'; this.querySelector('.marker-edit-btn').style.opacity='0'">
            <span onclick="mapController.focusOnMarker('${m.repuesto.id}', ${m.ubicacionIndex})" style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 4px;">
              <span style="overflow: hidden; text-overflow: ellipsis;">${this.escapeHtml(m.repuesto.nombre || 'Sin nombre')}</span>
              ${showCorrelativo ? `<span style="
                background: #222;
                color: #fff;
                padding: 1px 4px;
                border-radius: 2px;
                font-size: 0.65rem;
                font-weight: 600;
                font-family: monospace;
                flex-shrink: 0;
              ">#${m.numeroCorrelativo}</span>` : ''}
            </span>
            <button 
              class="marker-edit-btn"
              onclick="event.stopPropagation(); mapController.openEditMarkerModal('${m.repuesto.id}', ${m.ubicacionIndex})" 
              style="
                opacity: 0;
                transition: opacity 0.15s;
                background: none;
                border: none;
                color: #888;
                cursor: pointer;
                padding: 0;
                font-size: 0.7rem;
              " 
              title="Editar marcador">E</button>
          </div>
        `;
        }).join('');
        
        return `
          <div class="categoria-group" style="
            display: block;
            border-left: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 1px;
          ">
            <div class="categoria-header" style="
              padding: 3px 8px;
              padding-left: ${indent + 16}px;
              font-size: 0.72rem;
              font-weight: 500;
              color: #aaa;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 6px;
              transition: background 0.1s;
            "
            onclick="mapController.toggleCategoria(this)"
            onmouseover="this.style.background='rgba(255,255,255,0.03)'"
            onmouseout="this.style.background='transparent'">
              <span class="categoria-toggle" style="
                font-size: 0.7rem; 
                font-family: monospace;
                width: 8px;
              ">v</span>
              <span>${catNombre}</span>
              <span style="
                font-size: 0.65rem;
                color: #666;
                background: rgba(255,255,255,0.05);
                padding: 1px 5px;
                border-radius: 3px;
                margin-left: auto;
              ">${marcadores.length}</span>
            </div>
            <div class="categoria-marcadores" style="display: block;">
              ${marcadoresHTML}
            </div>
          </div>
        `;
      }).join('');
    }
    
    return `
      <div style="
        padding: 4px 6px;
        padding-left: ${indent + 6}px;
        background: rgba(255,255,255,0.02);
        border-left: 2px solid ${color};
        font-size: 0.75rem;
        font-weight: 500;
        color: #d4d4d4;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        position: relative;
        margin-bottom: 1px;
      "
      data-area-id="${area.id}"
      onmouseover="this.querySelector('.map-area-actions').style.opacity='1'"
      onmouseout="this.querySelector('.map-area-actions').style.opacity='0'">
        <div class="area-toggle" 
             onclick="mapController.toggleArea(this)" 
             style="
               cursor: pointer; 
               font-size: 0.7rem;
               font-family: monospace;
               user-select: none;
               width: 8px;
             ">${totalMarcadores > 0 ? 'v' : '>'}</div>
        <span style="
          background: rgba(59, 130, 246, 0.3);
          color: #60a5fa;
          padding: 1px 5px;
          border-radius: 2px;
          font-size: 0.65rem;
          font-weight: 700;
          font-family: monospace;
        ">REA</span>
        ${nivelBadge}
        <div class="map-area-content" 
             data-action="focus-area" 
             style="flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
          ${this.escapeHtml(area.name || 'Area sin nombre')}${totalMarcadores > 0 ? ` (${totalMarcadores})` : ''}
        </div>
        <div class="map-area-actions" style="
          display: flex; 
          gap: 6px;
          opacity: 0;
          transition: opacity 0.15s;
          font-size: 0.7rem;
          color: #888;
        ">
          <span data-action="edit-area-hierarchy" data-area-id="${area.id}" title="Editar jerarqua" style="cursor: pointer; color: #8b5cf6;">J</span>
          <span data-action="edit-area-points" data-area-id="${area.id}" title="Editar forma" style="cursor: pointer;">E</span>
          <span data-action="edit-area-metadata" data-area-id="${area.id}" title="Editar datos" style="cursor: pointer;">C</span>
          <span data-action="delete-area" data-area-id="${area.id}" title="Eliminar" style="cursor: pointer; color: #c55;">X</span>
        </div>
      </div>
      ${totalMarcadores > 0 ? `
        <div class="area-children" style="display: block;">
          ${categoriasHTML}
        </div>
      ` : ''}
    `;
  },

  //  NUEVO: Aplicar filtro de categora
  applyCategoryFilter(category) {
    console.log(` Filtro de categora aplicado: ${category}`);
    
    if (category === 'all') {
      this.state.categoryFilter = null;
    } else {
      this.state.categoryFilter = category;
    }
    
    // Re-renderizar la lista con el filtro aplicado
    this.renderAreaList(this.state.areas);
    
    // Mostrar toast informativo
    const categoryName = category === 'all' 
      ? 'Todas las categoras' 
      : this.categories[category]?.name || category;
    this.showToast(`Filtrando: ${categoryName}`, 'info');
  },

  async selectMap(mapId, options = {}) {
    if (!mapId) return;
    if (!mapStorage.initialized) {
      this.showToast('Conecta la carpeta primero.', 'warning');
      return;
    }

    const numericId = typeof mapId === 'string' ? parseInt(mapId, 10) : mapId;
    const map = mapStorage.getMapById(numericId);

    if (!map) {
      this.showToast('Mapa no encontrado.', 'warning');
      return;
    }

    if (this.state.currentMapId !== map.id) {
      this.state.jerarquiaBranchFilter = null;
    }

    this.state.currentMapId = map.id;
    this.state.currentMap = map;
    this.state.areas = mapStorage.getAreasByMap(map.id);
    this.state.highlightAreaId = null;

    const viewportOverride = !options.keepViewport
      ? this.getPersistedViewportForMap(map.id)
      : null;

    if (!options.keepViewport && !viewportOverride) {
      this.state.scale = 1;
      this.state.offsetX = 0;
      this.state.offsetY = 0;
    } else if (viewportOverride) {
      this.applyViewportSnapshot(viewportOverride);
    }

    this.showMapLoadingOverlay(map);
    
    // 🔥 Mostrar workspace cuando se selecciona un mapa
    const workspace = document.getElementById('mapWorkspace');
    if (workspace) {
      workspace.style.display = 'flex';
    }
    
    await this.loadMapImage(map, { ...options, viewportOverride });
    this.renderMapList(mapStorage.maps);
    this.renderAreaList(this.state.areas);
    this.updateMetaBadge();
    this.updateMapJerarquiaBadge();
    this.syncButtonStates(); //  Sincronizar estado visual de botones
    this.queueViewportPersist('select-map');
  },

  async loadMapImage(map, options = {}) {
    this.cleanupImage();

    if (!map.imagePath) {
      this.drawMessage('El mapa seleccionado no tiene imagen asociada.');
      this.hideMapLoadingOverlay(true, 'Sin imagen asociada.');
      return;
    }

    if (!this.state.mapLoadingActive) {
      this.showMapLoadingOverlay(map);
    }

    this.updateMapLoadingProgress(10, 'Buscando imagen en la carpeta...');
    try {
      const file = await mapStorage.getMapImage(map);
      if (!file) {
        this.drawMessage('No se encontr la imagen del mapa.');
        this.hideMapLoadingOverlay(true, 'No se encontr la imagen del mapa.');
        return;
      }

      this.updateMapLoadingProgress(25, 'Procesando imagen...');
      if (typeof window !== 'undefined' && typeof window.createImageBitmap === 'function') {
        await this.loadMapImageFromBitmaps(file, map, options);
      } else {
        await this.loadMapImageLegacy(file, options);
      }
    } catch (error) {
      console.error('Error cargando imagen del mapa:', error);
      this.drawMessage('No se pudo cargar la imagen del mapa.');
      this.hideMapLoadingOverlay(true, 'No se pudo cargar la imagen.');
    }
  },

  async loadMapImageFromBitmaps(file, map, options = {}) {
    const dimensions = {
      width: Number(map?.width) || 0,
      height: Number(map?.height) || 0
    };

    if (!dimensions.width || !dimensions.height) {
      const fallback = await this.getImageDimensions(file);
      dimensions.width = fallback.width;
      dimensions.height = fallback.height;
    }

    if (!dimensions.width || !dimensions.height) {
      this.drawMessage('No se pudo determinar el tamao del mapa.');
      this.hideMapLoadingOverlay(true, 'No se pudo determinar el tamao del mapa.');
      return;
    }

    this.state.imageDimensions = { ...dimensions };

    this.updateMapLoadingProgress(40, 'Optimizando resoluciones...');
    const lods = await this.buildImageLODs(file, dimensions, (value, label) => {
      this.updateMapLoadingProgress(value, label);
    });
    if (!lods.length) {
      this.drawMessage('No se pudo preparar la imagen del mapa.');
      this.hideMapLoadingOverlay(true, 'No se pudo preparar la imagen del mapa.');
      return;
    }

    this.state.imageLODs = lods;
    this.state.currentImage = lods[lods.length - 1].bitmap;
    this.state.currentImageUrl = null;
    this.state.usingBitmapRenderer = true;

    this.updateMapLoadingProgress(90, 'Aplicando mapa al lienzo...');
    this.configureCanvasForImage({ width: dimensions.width, height: dimensions.height }, options);
    this.draw();
    this.completeMapLoadingProgress();
      this.completeMapLoadingProgress();
  },

  async loadMapImageLegacy(file, options = {}) {
    const url = URL.createObjectURL(file);
    const img = new Image();
      this.hideMapLoadingOverlay(true, 'Error cargando la imagen del mapa.');
    img.onload = () => {
      this.updateMapLoadingProgress(85, 'Aplicando mapa al lienzo...');
      this.state.currentImage = img;
      this.state.currentImageUrl = url;
      this.state.imageDimensions = { width: img.width, height: img.height };
      this.state.usingBitmapRenderer = false;
      this.state.imageLODs = [];
      this.configureCanvasForImage(img, options);
      this.draw();
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      this.drawMessage('Error cargando la imagen del mapa.');
    };
    img.src = url;
  },

  async buildImageLODs(file, dimensions, progressCallback = null) {
    const originalWidth = dimensions.width;
    const originalHeight = dimensions.height;
    const targetWidths = this.getLODTargetWidths(originalWidth);
    const lods = [];

    let baseBitmap = null;
    const totalTargets = targetWidths.length || 1;
    const reportProgress = (index, width) => {
      if (typeof progressCallback !== 'function') {
        return;
      }
      const base = 45;
      const span = 40;
      const ratio = (index + 1) / totalTargets;
      const percent = Math.min(90, Math.round(base + span * ratio));
      progressCallback(percent, `Escala ${width}px optimizada`);
    };

    for (const targetWidth of targetWidths) {
      const ratio = targetWidth / originalWidth;
      const targetHeight = Math.max(1, Math.round(originalHeight * ratio));

      try {
        if (!baseBitmap) {
          baseBitmap = await createImageBitmap(file);
        }

        const bitmap = targetWidth === originalWidth && targetHeight === originalHeight
          ? baseBitmap
          : await createImageBitmap(baseBitmap, {
              resizeWidth: targetWidth,
              resizeHeight: targetHeight,
              resizeQuality: 'high'
            });

        lods.push({
          width: targetWidth,
          height: targetHeight,
          scale: ratio,
          bitmap
        });
        reportProgress(lods.length - 1, targetWidth);
      } catch (error) {
        console.warn(`No se pudo generar LOD ${targetWidth}px:`, error);
      }
    }

    lods.sort((a, b) => a.scale - b.scale);
    return lods;
  },

  getLODTargetWidths(originalWidth) {
    const presets = [1024, 2048, 4096, 6144, 8192];
    const targets = presets
      .filter((size) => originalWidth > size * 1.05)
      .concat(originalWidth);

    const uniqueTargets = [...new Set(targets.map((value) => Math.round(value)))];
    uniqueTargets.sort((a, b) => a - b);
    return uniqueTargets;
  },

  configureCanvasForImage(img, options = {}) {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    const container = this.elements.canvasStage || canvas.parentElement;
    if (container) {
      const containerWidth = container.clientWidth;
      const containerHeight = container.clientHeight;
      
      //  Buffer del canvas = tamao del contenedor
      canvas.width = containerWidth;
      canvas.height = containerHeight;
      
      //  Canvas CSS ocupa TODO el contenedor amarillo
      canvas.style.width = '100%';
      canvas.style.height = '100%';
    } else {
      // Fallback
      canvas.width = img.width;
      canvas.height = img.height;
    }

    if (options.viewportOverride) {
      this.applyViewportSnapshot(options.viewportOverride);
    } else if (!options.keepViewport) {
      this.state.scale = 1;
      this.state.offsetX = 0;
      this.state.offsetY = 0;
    }

    this.updateZoomBadge();
  },

  cleanupImage() {
    if (this.state.currentImageUrl) {
      try {
        URL.revokeObjectURL(this.state.currentImageUrl);
      } catch (error) {
        console.debug('cleanupImage revoke fall:', error);
      }
    }
    this.state.currentImageUrl = null;

    if (Array.isArray(this.state.imageLODs) && this.state.imageLODs.length) {
      this.state.imageLODs.forEach((lod) => {
        try {
          lod?.bitmap?.close?.();
        } catch (error) {
          console.debug('No se pudo liberar LOD:', error);
        }
      });
    }

    this.state.imageLODs = [];
    this.state.imageDimensions = { width: 0, height: 0 };
    this.state.usingBitmapRenderer = false;
    this.state.currentImage = null;
  },

  handleResize() {
    if (!this.elements.canvas) return;
    if (!this.state.currentImage) {
      this.resizeCanvas();
      return;
    }

    //  Canvas siempre ocupa TODO el contenedor amarillo (100%)
    this.elements.canvas.style.width = '100%';
    this.elements.canvas.style.height = '100%';

    this.draw();
  },

  resizeCanvas() {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    if (!this.state.currentImage) {
      const container = this.elements.canvasStage || canvas.parentElement;
      const rectWidth = container ? container.clientWidth : 640;
      const rectHeight = container ? container.clientHeight : 480;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.max(1, Math.round(rectWidth * dpr));
      canvas.height = Math.max(1, Math.round(rectHeight * dpr));
      this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      this.drawMessage('Conecta la carpeta INVENTARIO_STORAGE para comenzar.');
    } else {
      this.handleResize();
    }
  },

  drawMessage(message) {
    const canvas = this.elements.canvas;
    if (!canvas || !this.ctx) return;
    const ctx = this.ctx;
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'rgba(148, 163, 184, 0.9)';
    ctx.font = '16px "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(message, canvas.width / 2, canvas.height / 2);
    ctx.restore();
  },

  getVisibleMapBounds() {
    const canvas = this.elements.canvas;
    const dimensions = this.state.imageDimensions || {};
    if (!canvas || !dimensions.width || !dimensions.height) {
      return null;
    }

    const scale = this.state.scale;
    const offsetX = this.state.offsetX;
    const offsetY = this.state.offsetY;
    const viewWidth = canvas.width / scale;
    const viewHeight = canvas.height / scale;
    const viewX = (-offsetX) / scale;
    const viewY = (-offsetY) / scale;

    return {
      x: viewX,
      y: viewY,
      width: viewWidth,
      height: viewHeight,
      maxWidth: dimensions.width,
      maxHeight: dimensions.height
    };
  },

  getMapDimensionsSafe() {
    if (this.state.imageDimensions?.width && this.state.imageDimensions?.height) {
      return { ...this.state.imageDimensions };
    }

    if (this.state.currentImage) {
      return { width: this.state.currentImage.width, height: this.state.currentImage.height };
    }

    return { width: 0, height: 0 };
  },

  getMinimapBitmap() {
    if (this.state.imageLODs?.length) {
      return this.state.imageLODs[0]?.bitmap || null;
    }
    return this.state.currentImage;
  },

  pickLODForScale(scale) {
    const lods = this.state.imageLODs;
    if (!Array.isArray(lods) || lods.length === 0) {
      return null;
    }

    let chosen = lods[0];
    for (const lod of lods) {
      if (scale >= lod.scale || lod.scale === 1) {
        chosen = lod;
      } else {
        break;
      }
    }
    return chosen;
  },

  drawBaseImage(ctx) {
    if (this.state.usingBitmapRenderer && this.state.imageLODs.length) {
      const lod = this.pickLODForScale(this.state.scale);
      const bounds = this.getVisibleMapBounds();
      if (!lod || !bounds) {
        return;
      }

      const startX = Math.max(0, bounds.x);
      const startY = Math.max(0, bounds.y);
      const endX = Math.min(bounds.maxWidth, bounds.x + bounds.width);
      const endY = Math.min(bounds.maxHeight, bounds.y + bounds.height);

      const visibleWidth = Math.max(0, endX - startX);
      const visibleHeight = Math.max(0, endY - startY);

      if (visibleWidth <= 0 || visibleHeight <= 0) {
        return;
      }

      const ratio = lod.scale;
      const sourceX = startX * ratio;
      const sourceY = startY * ratio;
      const sourceWidth = visibleWidth * ratio;
      const sourceHeight = visibleHeight * ratio;

      ctx.drawImage(
        lod.bitmap,
        sourceX,
        sourceY,
        sourceWidth,
        sourceHeight,
        startX,
        startY,
        visibleWidth,
        visibleHeight
      );
      return;
    }

    if (this.state.currentImage) {
      ctx.drawImage(this.state.currentImage, 0, 0);
    }
  },

  draw() {
    const canvas = this.elements.canvas;
    if (!canvas || !this.ctx) return;

    const ctx = this.ctx;
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    //  Aplicar transformaciones de pan y zoom
    ctx.translate(this.state.offsetX, this.state.offsetY);
    ctx.scale(this.state.scale, this.state.scale);
    
    this.drawBaseImage(ctx);

    if (this.state.showGrid) {
      this.drawGrid(ctx);
    }

    this.drawAreas(ctx);
    this.drawTempShape(ctx);
    this.drawEditPoints(ctx);

    //  ETAPA 3.2: Dibujar handles de reshape
    if (this.state.isReshapeMode && this.state.reshapeAreaId) {
      this.drawReshapeHandles(ctx);
    }

    //  NUEVO: Dibujar marcadores de repuestos
    this.drawMarkers(ctx);
    
    //  NUEVO: Dibujar ubicaciones resaltadas (con animacin)
    this.dibujarUbicacionesResaltadas(ctx);

    ctx.restore();
    this.updateZoomBadge();
    
    //  NUEVO: Dibujar reglas si estn activadas
    if (this.state.showRulers) {
      this.drawRulers();
    }
    
    //  NUEVO: Dibujar minimap si est activado
    if (this.state.showMinimap && this.getMinimapBitmap()) {
      this.drawMinimap();
    }
  },

  // Rendering optimizado con requestAnimationFrame
  scheduleRender() {
    if (this.state.animationFrameId) {
      return; // Ya hay un render pendiente
    }
    this.state.animationFrameId = requestAnimationFrame(() => {
      this.draw();
      this.state.animationFrameId = null;
    });
  },

  drawCanvas() {
    // Alias para draw()
    this.draw();
  },

  drawGrid(ctx) {
    const dimensions = this.getMapDimensionsSafe();
    if (!dimensions.width || !dimensions.height) return;

    const step = this.state.gridSize || 50; //  Usar gridSize configurable
    const width = dimensions.width;
    const height = dimensions.height;
    ctx.save();
    ctx.strokeStyle = 'rgba(148, 163, 184, 0.25)';
    ctx.lineWidth = 1 / this.state.scale;

    for (let x = step; x < width; x += step) {
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, height);
      ctx.stroke();
    }
    for (let y = step; y < height; y += step) {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(width, y);
      ctx.stroke();
    }

    ctx.restore();
  },

  //  NUEVO: Dibujar reglas laterales con medidas
  drawRulers() {
    if (!this.state.showRulers) return;

    const dimensions = this.getMapDimensionsSafe();
    if (!dimensions.width || !dimensions.height) return;

    const canvas = this.elements.canvas;
    const ctx = this.ctx;
    const rulerSize = 30; // Ancho/alto de las reglas en pxeles
    const gridSize = this.state.gridSize || 50;

    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0); // Resetear transformacin

    // Fondo de las reglas
    ctx.fillStyle = 'rgba(15, 23, 42, 0.9)';
    
    // Regla horizontal (arriba)
    ctx.fillRect(rulerSize, 0, canvas.width - rulerSize, rulerSize);
    
    // Regla vertical (izquierda)
    ctx.fillRect(0, rulerSize, rulerSize, canvas.height - rulerSize);
    
    // Esquina (interseccin)
    ctx.fillStyle = 'rgba(15, 23, 42, 0.95)';
    ctx.fillRect(0, 0, rulerSize, rulerSize);

    // Configuracin de texto
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // Calcular rango visible en coordenadas del mundo
    const viewLeft = -this.state.offsetX / this.state.scale;
    const viewRight = (canvas.width - this.state.offsetX) / this.state.scale;
    const viewTop = -this.state.offsetY / this.state.scale;
    const viewBottom = (canvas.height - this.state.offsetY) / this.state.scale;

    // Dibujar marcas horizontales (regla superior)
    ctx.strokeStyle = 'rgba(148, 163, 184, 0.5)';
    ctx.fillStyle = 'rgba(226, 232, 240, 0.9)';
    ctx.lineWidth = 1;

    const startX = Math.floor(viewLeft / gridSize) * gridSize;
    for (let x = startX; x <= viewRight; x += gridSize) {
      const screenX = x * this.state.scale + this.state.offsetX;
      if (screenX < rulerSize || screenX > canvas.width) continue;

      // Lnea de marca
      ctx.beginPath();
      ctx.moveTo(screenX, rulerSize - 8);
      ctx.lineTo(screenX, rulerSize);
      ctx.stroke();

      // Nmero
      if (x % (gridSize * 2) === 0) { // Mostrar cada 2 marcas
        ctx.fillText(Math.round(x).toString(), screenX, rulerSize / 2);
      }
    }

    // Dibujar marcas verticales (regla izquierda)
    ctx.textAlign = 'left';
    const startY = Math.floor(viewTop / gridSize) * gridSize;
    for (let y = startY; y <= viewBottom; y += gridSize) {
      const screenY = y * this.state.scale + this.state.offsetY;
      if (screenY < rulerSize || screenY > canvas.height) continue;

      // Lnea de marca
      ctx.beginPath();
      ctx.moveTo(rulerSize - 8, screenY);
      ctx.lineTo(rulerSize, screenY);
      ctx.stroke();

      // Nmero (rotado)
      if (y % (gridSize * 2) === 0) {
        ctx.save();
        ctx.translate(rulerSize / 2, screenY);
        ctx.rotate(-Math.PI / 2);
        ctx.textAlign = 'center';
        ctx.fillText(Math.round(y).toString(), 0, 0);
        ctx.restore();
      }
    }

    // Borde de las reglas
    ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
    ctx.lineWidth = 1;
    ctx.strokeRect(rulerSize, 0, canvas.width - rulerSize, rulerSize);
    ctx.strokeRect(0, rulerSize, rulerSize, canvas.height - rulerSize);

    ctx.restore();
  },

  drawAreas(ctx) {
    if (!Array.isArray(this.state.areas) || !this.state.areas.length) return;

    ctx.save();
    this.state.areas.forEach(area => {
      if (!Array.isArray(area.points) || area.points.length < 3) return;
      const color = area.color || '#3b82f6';
      const opacity = typeof area.opacity === 'number' ? area.opacity : 0.35;
      
      //  ETAPA 3.1: Verificar si el rea est seleccionada
      const isSelected = this.state.selectedAreaIds.includes(area.id);
      
      ctx.beginPath();
      area.points.forEach((point, index) => {
        if (index === 0) ctx.moveTo(point.x, point.y);
        else ctx.lineTo(point.x, point.y);
      });
      ctx.closePath();
      
      //  Si es el rea resaltada, usar relleno amarillo brillante
      if (area.id === this.state.highlightAreaId) {
        ctx.fillStyle = 'rgba(251, 191, 36, 0.4)'; // Amarillo brillante semi-transparente
      } else {
        ctx.fillStyle = this.hexToRgba(color, opacity);
      }
      
      //  Cambiar estilo de borde segn estado
      if (isSelected) {
        ctx.strokeStyle = '#10b981'; // Verde para seleccionadas
        ctx.lineWidth = 4 / this.state.scale;
      } else if (area.id === this.state.highlightAreaId) {
        //  REA RESALTADA - EFECTO SUPER VISIBLE
        // Sombra exterior brillante (resplandor)
        ctx.shadowColor = '#fbbf24'; // Amarillo brillante
        ctx.shadowBlur = 20 / this.state.scale;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        
        // Borde amarillo grueso
        ctx.strokeStyle = '#fbbf24'; // Amarillo muy visible
        ctx.lineWidth = 6 / this.state.scale;
      } else {
        ctx.strokeStyle = color;
        ctx.lineWidth = 2 / this.state.scale;
      }
      
      ctx.fill();
      ctx.stroke();
      
      // Limpiar sombra para el resto del dibujo
      ctx.shadowBlur = 0;

      //  Solo dibujar nombres si estn habilitados
      if (this.state.mostrarNombresAreas) {
        const centroid = this.calculateCentroid(area.points);
        if (centroid) {
          //  ETAPA 2: Etiqueta mejorada con fondo semi-transparente y texto multi-lnea
          ctx.save();
          
          // Obtener offset personalizado (por defecto 0, 0)
          const labelOffsetX = area.labelOffsetX || 0;
          const labelOffsetY = area.labelOffsetY || 0;
          const labelX = centroid.x + labelOffsetX;
          const labelY = centroid.y + labelOffsetY;
          
          //  TAMAO DE FUENTE ADAPTATIVO AL ZOOM
          // Formula mejorada: Tamao base decrece con el zoom para no ocupar tanto espacio
          // Zoom 1.0 (normal): 28px
          // Zoom 0.5 (alejado 2x): 20px
          // Zoom 0.25 (alejado 4x): 14px (mnimo)
          const baseFontSize = 28;
          const minFontSize = 14;
          const zoomFactor = this.state.zoom || 1.0;
          
          // Aplicar raz cuadrada para suavizar el cambio
        const fontSize = Math.max(minFontSize, baseFontSize / Math.sqrt(zoomFactor));
        
        ctx.font = `bold ${fontSize}px "Segoe UI", sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        //  MEJORA: Dividir texto largo en mltiples lneas (mximo 20 caracteres por lnea)
        const text = area.name || 'rea';
        const maxCharsPerLine = 20;
        const lines = [];
        
        if (text.length <= maxCharsPerLine) {
          lines.push(text);
        } else {
          // Dividir por palabras para no cortar a la mitad
          const words = text.split(' ');
          let currentLine = '';
          
          words.forEach((word, idx) => {
            const testLine = currentLine ? `${currentLine} ${word}` : word;
            if (testLine.length <= maxCharsPerLine) {
              currentLine = testLine;
            } else {
              if (currentLine) lines.push(currentLine);
              currentLine = word;
            }
            if (idx === words.length - 1 && currentLine) {
              lines.push(currentLine);
            }
          });
        }
        
        // Medir el ancho mximo de todas las lneas
        let maxWidth = 0;
        lines.forEach(line => {
          const metrics = ctx.measureText(line);
          if (metrics.width > maxWidth) maxWidth = metrics.width;
        });
        
        const textWidth = maxWidth;
        const lineHeight = fontSize * 1.2;
        const textHeight = lineHeight * lines.length;
        
        //  Padding interno adaptativo al zoom (ms pequeo cuando hay zoom)
        const paddingX = Math.max(6, 12 / Math.sqrt(zoomFactor));
        const paddingY = Math.max(4, 8 / Math.sqrt(zoomFactor));
        
        // Dimensiones del rectngulo
        const rectWidth = textWidth + paddingX * 2;
        const rectHeight = textHeight + paddingY * 2;
        const rectX = labelX - rectWidth / 2;
        const rectY = labelY - rectHeight / 2;
        
        //  MEJORA: Fondo semi-transparente con efecto glassmorphism
        const isSelected = this.state.selectedAreaIds.includes(area.id);
        const isHighlighted = area.id === this.state.highlightAreaId;
        
        //  Sombra adaptativa al zoom
        ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
        ctx.shadowBlur = Math.max(4, 8 / Math.sqrt(zoomFactor));
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = Math.max(1, 2 / Math.sqrt(zoomFactor));
        
        // Fondo con gradiente sutil
        const gradient = ctx.createLinearGradient(rectX, rectY, rectX, rectY + rectHeight);
        if (isSelected) {
          gradient.addColorStop(0, 'rgba(209, 250, 229, 0.95)');  // Verde claro
          gradient.addColorStop(1, 'rgba(167, 243, 208, 0.95)');
        } else if (isHighlighted) {
          gradient.addColorStop(0, 'rgba(254, 249, 195, 0.95)');  // Amarillo claro
          gradient.addColorStop(1, 'rgba(253, 230, 138, 0.95)');
        } else {
          gradient.addColorStop(0, 'rgba(255, 255, 255, 0.92)');  // Blanco semi-transparente
          gradient.addColorStop(1, 'rgba(249, 250, 251, 0.92)');
        }
        ctx.fillStyle = gradient;
        
        //  Rectngulo con bordes redondeados adaptativos
        const radius = Math.max(3, 6 / Math.sqrt(zoomFactor));
        ctx.beginPath();
        ctx.moveTo(rectX + radius, rectY);
        ctx.lineTo(rectX + rectWidth - radius, rectY);
        ctx.quadraticCurveTo(rectX + rectWidth, rectY, rectX + rectWidth, rectY + radius);
        ctx.lineTo(rectX + rectWidth, rectY + rectHeight - radius);
        ctx.quadraticCurveTo(rectX + rectWidth, rectY + rectHeight, rectX + rectWidth - radius, rectY + rectHeight);
        ctx.lineTo(rectX + radius, rectY + rectHeight);
        ctx.quadraticCurveTo(rectX, rectY + rectHeight, rectX, rectY + rectHeight - radius);
        ctx.lineTo(rectX, rectY + radius);
        ctx.quadraticCurveTo(rectX, rectY, rectX + radius, rectY);
        ctx.closePath();
        ctx.fill();
        
        // Remover sombra para el borde
        ctx.shadowBlur = 0;
        
        // Dibujar borde (verde si seleccionado, amarillo si resaltado, gris si normal)
        if (isSelected) {
          ctx.strokeStyle = '#10b981';
          ctx.lineWidth = 3 / this.state.scale;
        } else if (isHighlighted) {
          ctx.strokeStyle = '#facc15';
          ctx.lineWidth = 3 / this.state.scale;
        } else {
          ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
          ctx.lineWidth = 2 / this.state.scale;
        }
        ctx.stroke();
        
        //  MEJORA: Dibujar texto multi-lnea con mejor contraste
        ctx.fillStyle = isSelected ? '#064e3b' : (isHighlighted ? '#713f12' : '#1f2937');
        ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
        ctx.shadowBlur = 3 / this.state.scale;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        
        // Calcular posicin Y inicial (centrada verticalmente)
        const startY = labelY - (textHeight / 2) + (lineHeight / 2);
        
        lines.forEach((line, idx) => {
          const lineY = startY + (idx * lineHeight);
          ctx.fillText(line, labelX, lineY);
        });
        
        ctx.shadowBlur = 0;
        
        //  Agregar check mark si est seleccionado
        if (isSelected) {
          ctx.font = `bold ${fontSize * 0.9}px "Segoe UI", sans-serif`;
          ctx.fillStyle = '#10b981';
          ctx.shadowBlur = 0;
          ctx.fillText('', rectX + rectWidth + (paddingX * 1.5), labelY);
        }
        
        //  ICONOS DE CATEGORA REMOVIDOS (ocupaban mucho espacio)
        // Los nombres ahora se muestran sin iconos para mejor legibilidad
        
        ctx.restore();
        } // Fin del if mostrarNombresAreas
      } // Fin del if centroid
    });
    ctx.restore();
  },

  //  NUEVO: Dibujar marcadores de repuestos en el mapa
  drawMarkers(ctx) {
    //  MODIFICADO: Si el botón está OFF, solo mostrar el marcador seleccionado
    // Si está ON, mostrar todos los marcadores
    
    if (!app || !app.repuestos) return;
    
    ctx.save();
    
    //  Usar función centralizada para correlativos GLOBALES
    const correlativosGlobales = this.calcularCorrelativosGlobales(this.state.currentMapId);
    
    //  PASO 2: Buscar repuestos con ubicaciones en el mapa actual y asignar número correlativo GLOBAL
    const marcadores = [];
    
    app.repuestos.forEach(repuesto => {
      // Formato NUEVO: array de ubicaciones
      if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones)) {
        repuesto.ubicaciones.forEach((ub, index) => {
          if (String(ub.mapId) === String(this.state.currentMapId) && ub.markerX && ub.markerY) {
            // Obtener todas las instancias de esta ubicación
            const corrInfoArray = correlativosGlobales[repuesto.id]?.[index] || [{ numero: 1, total: 1, instanciaLocal: 1 }];
            
            // Agregar un marcador por cada instancia (con el mismo markerX, markerY pero correlativo diferente)
            corrInfoArray.forEach(corrInfo => {
              marcadores.push({
                repuesto: repuesto,
                x: ub.markerX,
                y: ub.markerY,
                areaId: ub.areaId,
                ubicacionIndex: index,
                numeroCorrelativo: corrInfo.numero,
                totalInstancias: corrInfo.total,
                instanciaLocal: corrInfo.instanciaLocal
              });
            });
          }
        });
      }
      
      // Formato ANTIGUO: propiedades directas (compatibilidad)
      if (repuesto.mapId && String(repuesto.mapId) === String(this.state.currentMapId) && repuesto.markerX && repuesto.markerY) {
        const corrInfoArray = correlativosGlobales[repuesto.id]?.[0] || [{ numero: 1, total: 1, instanciaLocal: 1 }];
        corrInfoArray.forEach(corrInfo => {
          marcadores.push({
            repuesto: repuesto,
            x: repuesto.markerX,
            y: repuesto.markerY,
            areaId: repuesto.areaId,
            ubicacionIndex: 0,
            numeroCorrelativo: corrInfo.numero,
            totalInstancias: corrInfo.total,
            instanciaLocal: corrInfo.instanciaLocal
          });
        });
      }
    });
    
    //  FILTRAR: Si hay un repuesto filtrado, mostrar solo sus marcadores
    let marcadoresFiltrados = marcadores;
    if (this.state.repuestoFiltrado) {
      marcadoresFiltrados = marcadores.filter(m => 
        String(m.repuesto.id) === String(this.state.repuestoFiltrado)
      );
      console.log(` Filtro activo: Mostrando ${marcadoresFiltrados.length} de ${marcadores.length} marcadores`);
    }
    
    //  NUEVO FILTRO: Si el botón de puntos está OFF, solo mostrar el marcador seleccionado
    if (!this.state.mostrarPuntosRepuestos) {
      if (this.state.highlightMarker) {
        // Solo mostrar el marcador resaltado
        marcadoresFiltrados = marcadores.filter(m => 
          String(m.repuesto.id) === String(this.state.highlightMarker.repuestoId) &&
          m.ubicacionIndex === this.state.highlightMarker.ubicacionIndex
        );
        console.log(` Botn OFF: Mostrando solo marcador seleccionado`);
      } else {
        // No hay seleccin, no mostrar nada
        ctx.restore();
        return;
      }
    }
    
    //  Si hay un marcador siendo arrastrado, dibujarlo en posicin temporal
    if (this.state.marcadorArrastre && this.state.marcadorArrastre.iniciado) {
      const { info, mapX, mapY } = this.state.marcadorArrastre;
      
  // Dibujar marcador en posicin temporal con efecto fantasma
  this.dibujarMarcadorIndividual(ctx, info.repuesto, mapX, mapY, info.ubicacion.areaId, true, 1.0, info.ubicacionIndex, info.numeroCorrelativo, info.totalInstancias);
      
      // Tambin mostrar la posicin original con opacidad reducida
      marcadoresFiltrados.forEach((m, i) => {
        const esElMismomarcador = m.repuesto.id === info.repuesto.id && 
                                  Math.abs(m.x - info.x) < 1 && 
                                  Math.abs(m.y - info.y) < 1;
        
  this.dibujarMarcadorIndividual(ctx, m.repuesto, m.x, m.y, m.areaId, false, esElMismomarcador ? 0.3 : 1.0, m.ubicacionIndex, m.numeroCorrelativo, m.totalInstancias);
      });
    } else {
      // Dibujar todos los marcadores (filtrados o todos)
    if (marcadoresFiltrados.length === 0) {
      ctx.restore();
      return;
    }
    
    // console.log(` Dibujando ${marcadoresFiltrados.length} marcadores en el mapa`);
    
    marcadoresFiltrados.forEach(({ repuesto, x, y, areaId, ubicacionIndex, numeroCorrelativo, totalInstancias }) => {
      this.dibujarMarcadorIndividual(ctx, repuesto, x, y, areaId, false, 1.0, ubicacionIndex, numeroCorrelativo, totalInstancias);
    });
  }    ctx.restore();
  },
  
  //  NUEVA FUNCIN: Dibujar un marcador individual
  dibujarMarcadorIndividual(ctx, repuesto, x, y, areaId, esPreview = false, opacidad = 1.0, ubicacionIndex = null, numeroCorrelativo = null, totalInstancias = 1) {
    ctx.save();
    
    // Verificar si este es el pin en modo edicin
    const esEdicionPin = this.state.pinAMover && 
                         this.state.pinAMover.editando && 
                         String(repuesto.id) === String(this.state.pinAMover.repuestoId);
    
    //  Verificar si este marcador est resaltado (highlight)
    // IMPORTANTE: Verificar tambin el ubicacionIndex para resaltar solo el correcto
  const esResaltado = this.state.highlightMarker &&
            String(repuesto.id) === String(this.state.highlightMarker.repuestoId) &&
            (ubicacionIndex !== null && ubicacionIndex === this.state.highlightMarker.ubicacionIndex);
    
    // Si es preview, aplicar efecto pulsante
    if (esPreview) {
      ctx.globalAlpha = 0.8;
      const pulso = Math.sin(Date.now() / 100) * 0.1 + 0.9;
      // No aplicar scale, solo dibujar en la posicin temporal
    } else if (esResaltado) {
      //  Efecto pulsante para marcador resaltado
      ctx.globalAlpha = 1.0;
    } else {
      ctx.globalAlpha = opacidad;
    }
    
    //  Dibujar marcador tipo "pin"
    //  CORRECCIN: Aplicar efecto pulsante al tamao en lugar de ctx.scale()
    // para evitar que el marcador se "mueva" por el escalado desde origen (0,0)
    const pulsoMultiplicador = esResaltado ? (Math.sin(Date.now() / 200) * 0.15 + 1.15) : 1.0;
    const pinHeight = Math.max(30, 40 / this.state.scale) * pulsoMultiplicador;
    const pinWidth = Math.max(20, 26 / this.state.scale) * pulsoMultiplicador;
    
    //  EFECTO HALO: Dibujar aura pulsante para marcador resaltado
    if (esResaltado) {
      const haloPulso = Math.sin(Date.now() / 300) * 0.3 + 0.7; // Pulso suave entre 0.4 y 1.0
      const haloRadius = (pinWidth * 1.8) * haloPulso;
      
      // Dibujar mltiples anillos semi-transparentes para efecto de "ondas"
      for (let i = 3; i >= 1; i--) {
        ctx.beginPath();
        ctx.arc(x, y - pinHeight / 2, haloRadius * (1 + i * 0.15), 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(251, 191, 36, ${0.2 / i})`; // Amarillo dorado semi-transparente
        ctx.lineWidth = Math.max(2, 4 / this.state.scale);
        ctx.stroke();
      }
      
      // Crculo de relleno suave en el centro del halo
      const gradientHalo = ctx.createRadialGradient(x, y - pinHeight / 2, 0, x, y - pinHeight / 2, haloRadius);
      gradientHalo.addColorStop(0, 'rgba(251, 191, 36, 0.15)');
      gradientHalo.addColorStop(0.7, 'rgba(251, 191, 36, 0.05)');
      gradientHalo.addColorStop(1, 'rgba(251, 191, 36, 0)');
      
      ctx.fillStyle = gradientHalo;
      ctx.beginPath();
      ctx.arc(x, y - pinHeight / 2, haloRadius * 1.3, 0, Math.PI * 2);
      ctx.fill();
    }
    
    // Sombra del pin (ms pronunciada para marcador resaltado)
    if (esResaltado) {
      ctx.shadowColor = 'rgba(251, 191, 36, 0.8)'; // Sombra amarilla para resaltado
      ctx.shadowBlur = 25 / this.state.scale;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 8 / this.state.scale;
    } else {
      ctx.shadowColor = esPreview ? 'rgba(59, 130, 246, 0.6)' : 
                        esEdicionPin ? 'rgba(249, 115, 22, 0.6)' : 
                        'rgba(0, 0, 0, 0.4)';
      ctx.shadowBlur = 15 / this.state.scale;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 5 / this.state.scale;
    }
    
    // Color segn stock o modo edicin
    const cantidad = repuesto.cantidad || 0;
    const minimo = repuesto.minimo || 5;
    let markerColor, markerBorder;
    
    if (esEdicionPin) {
      //  NARANJA para modo edicin (como cuando editas reas)
      markerColor = '#f97316'; // Naranja brillante
      markerBorder = '#ea580c';
    } else if (esResaltado) {
      //  AMARILLO BRILLANTE para marcador resaltado
      markerColor = '#fbbf24'; // Amarillo dorado
      markerBorder = '#f59e0b';
    } else if (esPreview) {
      markerColor = '#3b82f6'; // Azul para preview
      markerBorder = '#2563eb';
    } else if (cantidad === 0) {
      markerColor = '#ef4444'; // Rojo - sin stock
      markerBorder = '#dc2626';
    } else if (cantidad < minimo) {
      markerColor = '#f59e0b'; // Naranja - bajo stock
      markerBorder = '#d97706';
    } else {
      markerColor = '#10b981'; // Verde - stock OK
      markerBorder = '#059669';
    }
    
    // Dibujar forma de pin (gota invertida)
    ctx.beginPath();
    
    // Crculo superior del pin
    const circleRadius = pinWidth / 2;
    ctx.arc(x, y - pinHeight + circleRadius, circleRadius, 0, Math.PI * 2);
    
    // Punta del pin (tringulo hacia abajo)
    ctx.moveTo(x - circleRadius * 0.5, y - circleRadius);
    ctx.lineTo(x, y);
    ctx.lineTo(x + circleRadius * 0.5, y - circleRadius);
    
    ctx.fillStyle = markerColor;
    ctx.fill();
    
    // Borde del pin
    ctx.strokeStyle = markerBorder;
    ctx.lineWidth = Math.max(1.5, 2 / this.state.scale);
    ctx.stroke();
    
    ctx.shadowBlur = 0;
    
    // Punto central blanco dentro del crculo
    ctx.beginPath();
    ctx.arc(x, y - pinHeight + circleRadius, circleRadius * 0.4, 0, Math.PI * 2);
    ctx.fillStyle = '#ffffff';
    ctx.fill();
    
    //  Etiqueta del repuesto (ESCALADA SEGN ZOOM)
    // Frmula similar a nombres de reas: baseFontSize / zoomFactor
    const baseFontSize = 18;
    const minFontSize = 10;
    const zoomFactor = this.state.zoom || 1.0;
    const fontSize = Math.max(minFontSize, baseFontSize / Math.sqrt(zoomFactor));
    
    ctx.font = `bold ${fontSize}px "Segoe UI", sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    
    // Limitar longitud del texto
    let text = repuesto.nombre;
    if (text.length > 20) {
      text = text.substring(0, 17) + '...';
    }
    
    const metrics = ctx.measureText(text);
    const textWidth = metrics.width;
    
    // Padding adaptativo segn zoom
    const paddingX = Math.max(4, 8 / Math.sqrt(zoomFactor));
    const paddingY = Math.max(2.5, 5 / Math.sqrt(zoomFactor));
    
    // Fondo de la etiqueta con bordes redondeados
    const rectX = x - textWidth / 2 - paddingX;
    const rectY = y - pinHeight - fontSize - paddingY * 2.5;
    const rectWidth = textWidth + paddingX * 2;
    const rectHeight = fontSize + paddingY * 2;
    const cornerRadius = Math.max(2, 4 / Math.sqrt(zoomFactor));
    
    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
    ctx.shadowBlur = Math.max(5, 10 / Math.sqrt(zoomFactor));
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = Math.max(1, 2 / Math.sqrt(zoomFactor));
    
    // Rectngulo con esquinas redondeadas
    ctx.beginPath();
    ctx.moveTo(rectX + cornerRadius, rectY);
    ctx.lineTo(rectX + rectWidth - cornerRadius, rectY);
    ctx.arcTo(rectX + rectWidth, rectY, rectX + rectWidth, rectY + cornerRadius, cornerRadius);
    ctx.lineTo(rectX + rectWidth, rectY + rectHeight - cornerRadius);
    ctx.arcTo(rectX + rectWidth, rectY + rectHeight, rectX + rectWidth - cornerRadius, rectY + rectHeight, cornerRadius);
    ctx.lineTo(rectX + cornerRadius, rectY + rectHeight);
    ctx.arcTo(rectX, rectY + rectHeight, rectX, rectY + rectHeight - cornerRadius, cornerRadius);
    ctx.lineTo(rectX, rectY + cornerRadius);
    ctx.arcTo(rectX, rectY, rectX + cornerRadius, rectY, cornerRadius);
    ctx.closePath();
    
    ctx.fillStyle = esPreview ? 'rgba(59, 130, 246, 0.95)' : 'rgba(0, 0, 0, 0.85)';
    ctx.fill();
    
    // Borde de la etiqueta
    ctx.strokeStyle = markerColor;
    ctx.lineWidth = Math.max(1, 1.5 / this.state.scale);
    ctx.stroke();
    
    ctx.shadowBlur = 0;
    
    // Texto del nombre
    ctx.fillStyle = '#ffffff';
    ctx.fillText(text, x, y - pinHeight - paddingY * 1.5);
    
    //  Badge de cantidad (pequeo crculo con nmero)
    if (cantidad >= 0 && !esPreview) {
      const badgeRadius = Math.max(10, 14 / this.state.scale);
      const badgeX = x + circleRadius * 0.7;
      const badgeY = y - pinHeight + circleRadius - circleRadius * 0.7;
      
      // Crculo del badge
      ctx.beginPath();
      ctx.arc(badgeX, badgeY, badgeRadius, 0, Math.PI * 2);
      ctx.fillStyle = cantidad === 0 ? '#dc2626' : (cantidad < minimo ? '#d97706' : '#059669');
      ctx.fill();
      
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = Math.max(1, 2 / this.state.scale);
      ctx.stroke();
      
      // Nmero de cantidad
      const badgeFontSize = Math.max(9, 12 / this.state.scale);
      ctx.font = `bold ${badgeFontSize}px "Segoe UI", sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#ffffff';
      ctx.fillText(cantidad.toString(), badgeX, badgeY);
    }
    
    //  Badge de nmero correlativo (solo si hay mltiples instancias)
    if (totalInstancias > 1 && numeroCorrelativo && !esPreview) {
      const correlativoBadgeRadius = Math.max(9, 12 / this.state.scale);
      const correlativoBadgeX = x - circleRadius * 0.7;
      const correlativoBadgeY = y - pinHeight + circleRadius - circleRadius * 0.7;
      
      // Crculo del badge negro
      ctx.beginPath();
      ctx.arc(correlativoBadgeX, correlativoBadgeY, correlativoBadgeRadius, 0, Math.PI * 2);
      ctx.fillStyle = '#222222';
      ctx.fill();
      
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = Math.max(1, 1.5 / this.state.scale);
      ctx.stroke();
      
      // Nmero correlativo
      const correlativoFontSize = Math.max(8, 10 / this.state.scale);
      ctx.font = `bold ${correlativoFontSize}px monospace`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#ffffff';
      ctx.fillText(`#${numeroCorrelativo}`, correlativoBadgeX, correlativoBadgeY);
    }
    
    // Texto "ARRASTRANDO" si es preview
    if (esPreview) {
      const previewFontSize = Math.max(10, 14 / this.state.scale);
      ctx.font = `bold ${previewFontSize}px "Segoe UI", sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillStyle = '#3b82f6';
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 3 / this.state.scale;
      ctx.strokeText(' ARRASTRANDO', x, y + 10 / this.state.scale);
      ctx.fillText(' ARRASTRANDO', x, y + 10 / this.state.scale);
    }
    
  ctx.restore();
},

//  Continuar con ubicaciones resaltadas (solo si no hay arrastre activo)
dibujarUbicacionesResaltadas(ctx) {
  if (!this.state.ubicacionesResaltadas || this.state.ubicacionesResaltadas.length === 0) return;
  if (this.state.marcadorArrastre && this.state.marcadorArrastre.iniciado) return;
  
  //  OPTIMIZADO: Animacin ms sutil y menos costosa
  // Solo animar cada 100ms en lugar de cada frame
  const ahora = Date.now();
  if (!this.state.ultimaAnimacion || ahora - this.state.ultimaAnimacion > 100) {
    this.state.ultimaAnimacion = ahora;
    this.state.pulsoAnimacion = (this.state.pulsoAnimacion || 0) + 0.15;
  }
  
  this.state.ubicacionesResaltadas.forEach(({ x, y, repuesto, descripcion }, index) => {
    // Animacin simple: solo un anillo pulsante
    const pulso = Math.sin(this.state.pulsoAnimacion + index * 0.5) * 0.3 + 0.7; // 0.4 a 1.0
    
    // Tamao base adaptable al zoom
    const baseSize = Math.max(25, 40 / this.state.scale);
    const ringRadius = baseSize * pulso;
    
    // UN SOLO anillo (en lugar de 2)
    ctx.beginPath();
    ctx.arc(x, y, ringRadius, 0, Math.PI * 2);
    ctx.strokeStyle = `rgba(59, 130, 246, ${0.5 * pulso})`;
    ctx.lineWidth = Math.max(2, 4 / this.state.scale);
    ctx.stroke();
    
    // Punto central SIN sombra (las sombras son costosas)
    const centerRadius = Math.max(10, 15 / this.state.scale);
    
    ctx.beginPath();
    ctx.arc(x, y, centerRadius, 0, Math.PI * 2);
    ctx.fillStyle = '#3b82f6';
    ctx.fill();
    
    // Borde blanco del punto
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = Math.max(2, 3 / this.state.scale);
    ctx.stroke();
    
    // Punto interno
    ctx.beginPath();
    ctx.arc(x, y, centerRadius * 0.3, 0, Math.PI * 2);
    ctx.fillStyle = '#ffffff';
    ctx.fill();
  });
  
  //  Continuar animacin solo si hay ubicaciones resaltadas
  if (this.state.ubicacionesResaltadas && this.state.ubicacionesResaltadas.length > 0) {
    if (!this.state.animacionResaltadaActiva) {
      this.state.animacionResaltadaActiva = true;
      const animarResaltado = () => {
        if (this.state.ubicacionesResaltadas && this.state.ubicacionesResaltadas.length > 0) {
          this.draw();
          requestAnimationFrame(animarResaltado);
        } else {
          this.state.animacionResaltadaActiva = false;
        }
      };
      requestAnimationFrame(animarResaltado);
    }
  }
},

  //  NUEVA FUNCIN: Guardar nueva posicin del marcador despus de arrastrar
  async guardarNuevaPosicionMarcador(marcadorInfo, nuevoX, nuevoY) {
    const { repuesto, ubicacionIndex, ubicacion } = marcadorInfo;
    
    console.log(` Guardando nueva posicin del marcador:`, {
      repuesto: repuesto.nombre,
      indice: ubicacionIndex,
      antiguaPos: { x: ubicacion.markerX, y: ubicacion.markerY },
      nuevaPos: { x: nuevoX, y: nuevoY }
    });
    
    // Verificar que la nueva posicin est en un rea vlida
    const areasCercanas = this.buscarAreasCercanas(nuevoX, nuevoY, 300);
    
    if (areasCercanas.length === 0) {
      this.showToast(' No hay reas cercanas. Coloca el marcador dentro de un rea.', 'warning');
      this.draw(); // Redibujar sin cambios
      return;
    }
    
    // Si hay un rea vlida, usar la primera (ms cercana)
    const areaNueva = areasCercanas[0].area;
    
    // Actualizar ubicacin en el repuesto
    if (repuesto.ubicaciones && Array.isArray(repuesto.ubicaciones)) {
      const ub = repuesto.ubicaciones[ubicacionIndex];
      if (ub) {
        ub.markerX = nuevoX;
        ub.markerY = nuevoY;
        ub.areaId = areaNueva.id; // Actualizar rea si cambi
      }
    }
    
    // Guardar cambios
    try {
      await app.saveData();
      this.showToast(` Posicin actualizada en "${areaNueva.name}"`, 'success');
      this.draw(); // Redibujar con nueva posicin
    } catch (error) {
      console.error('Error guardando posicin:', error);
      this.showToast(' Error al guardar la nueva posicin', 'error');
      // Revertir cambio
      if (repuesto.ubicaciones && repuesto.ubicaciones[ubicacionIndex]) {
        repuesto.ubicaciones[ubicacionIndex].markerX = ubicacion.markerX;
        repuesto.ubicaciones[ubicacionIndex].markerY = ubicacion.markerY;
        repuesto.ubicaciones[ubicacionIndex].areaId = ubicacion.areaId;
      }
      this.draw();
    }
  },

  drawTempShape(ctx) {
    if (!this.state.drawing || this.state.tempPoints.length === 0) return;

    ctx.save();
    
    //  MEJORA: Lneas ms gruesas y visibles
    ctx.strokeStyle = 'rgba(59, 130, 246, 1)'; // Opacidad 100%
    ctx.fillStyle = 'rgba(59, 130, 246, 0.25)'; // Ms opaco
    ctx.lineWidth = Math.max(3, 3 / this.state.scale); // Mnimo 3px
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    //  SOMBRA para el polgono
    ctx.shadowColor = 'rgba(59, 130, 246, 0.5)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;

    ctx.beginPath();
    this.state.tempPoints.forEach((point, index) => {
      if (index === 0) ctx.moveTo(point.x, point.y);
      else ctx.lineTo(point.x, point.y);
    });

    if (this.state.previewPoint) {
      ctx.lineTo(this.state.previewPoint.x, this.state.previewPoint.y);
    }

    if (this.state.tempPoints.length >= 2) {
      ctx.fill();
    }
    ctx.stroke();

    //  PUNTOS ms grandes y visibles con borde
    ctx.shadowBlur = 0; // Quitar sombra para puntos
    
    this.state.tempPoints.forEach((point, index) => {
      const radius = Math.max(6, 8 / this.state.scale); // Mnimo 6px
      
      // Borde blanco
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius + 2 / this.state.scale, 0, Math.PI * 2);
      ctx.fillStyle = '#ffffff';
      ctx.fill();
      
      // Punto principal azul
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius, 0, Math.PI * 2);
      ctx.fillStyle = index === 0 ? '#facc15' : '#3b82f6'; // Primer punto amarillo
      ctx.fill();
      
      // Nmero del punto
      if (this.state.tempPoints.length > 2) {
        ctx.fillStyle = '#ffffff';
        ctx.font = `bold ${Math.max(10, 12 / this.state.scale)}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText((index + 1).toString(), point.x, point.y);
      }
    });
    
    //  Punto de preview (cursor)
    if (this.state.previewPoint && this.state.tempPoints.length > 0) {
      const radius = Math.max(4, 6 / this.state.scale);
      ctx.beginPath();
      ctx.arc(this.state.previewPoint.x, this.state.previewPoint.y, radius, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(59, 130, 246, 0.5)';
      ctx.fill();
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 2 / this.state.scale;
      ctx.stroke();
    }
    
    ctx.restore();
  },

  drawEditPoints(ctx) {
    if (!this.state.editingAreaId || !this.state.editingPoints.length) return;

    ctx.save();
    
    const lineWidth = Math.max(3, 3 / this.state.scale);
    const pointRadius = Math.max(16, 16 / this.state.scale); // MS GRANDE: 16px (era 14px)
    const selectedRadius = Math.max(22, 22 / this.state.scale); // MS GRANDE: 22px (era 20px)
    
    // Dibujar las lneas de la forma
    ctx.beginPath();
    this.state.editingPoints.forEach((point, index) => {
      if (index === 0) {
        ctx.moveTo(point.x, point.y);
      } else {
        ctx.lineTo(point.x, point.y);
      }
    });
    ctx.closePath();
    
    // Lnea con estilo destacado
    ctx.strokeStyle = '#f59e0b'; // Amber para indicar modo edicin
    ctx.lineWidth = lineWidth;
    ctx.setLineDash([10 / this.state.scale, 5 / this.state.scale]);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Dibujar TODOS los puntos editables (todos visibles y arrastrables)
    this.state.editingPoints.forEach((point, index) => {
      const isSelected = index === this.state.selectedPointIndex;
      const isDragging = isSelected && this.state.isDraggingPoint;
      const radius = isSelected ? selectedRadius : pointRadius;
      
      // Sombra ms pronunciada para puntos seleccionados
      if (isDragging) {
        ctx.shadowColor = 'rgba(245, 158, 11, 0.6)';
        ctx.shadowBlur = 20 / this.state.scale;
      } else {
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 15 / this.state.scale;
      }
      ctx.shadowOffsetX = 3 / this.state.scale;
      ctx.shadowOffsetY = 3 / this.state.scale;
      
      // Crculo exterior (color principal) - MS TRANSPARENTE
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius, 0, Math.PI * 2);
      
      // Color segn estado - con transparencia para ver el fondo
      if (isDragging) {
        ctx.fillStyle = 'rgba(245, 158, 11, 0.7)'; // Amber semi-transparente
      } else if (isSelected) {
        ctx.fillStyle = 'rgba(251, 146, 60, 0.7)'; // Amber claro semi-transparente
      } else {
        ctx.fillStyle = 'rgba(59, 130, 246, 0.6)'; // Azul semi-transparente
      }
      ctx.fill();
      
      // Quitar sombra para el borde
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      
      // Borde blanco grueso
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 3 / this.state.scale;
      ctx.stroke();
      
      // Punto interior blanco semi-transparente para ver a travs
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius * 0.4, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.fill();
      
      // Anillo interior para puntos seleccionados
      if (isSelected) {
        ctx.beginPath();
        ctx.arc(point.x, point.y, radius * 0.65, 0, Math.PI * 2);
        ctx.strokeStyle = isDragging ? '#fbbf24' : '#fb923c';
        ctx.lineWidth = 2 / this.state.scale;
        ctx.stroke();
      }
      
      // Nmero del punto con fondo semi-transparente
      const fontSize = Math.max(16, 16 / this.state.scale);
      ctx.font = `bold ${fontSize}px sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      const labelY = point.y - radius - 14 / this.state.scale;
      const text = String(index + 1);
      
      // Medir texto para el fondo
      const metrics = ctx.measureText(text);
      const padding = 5 / this.state.scale;
      const bgWidth = metrics.width + padding * 2;
      const bgHeight = fontSize + padding * 2;
      
      // Fondo semi-transparente con bordes redondeados
      ctx.fillStyle = isSelected ? 'rgba(245, 158, 11, 0.85)' : 'rgba(0, 0, 0, 0.75)';
      const bgX = point.x - bgWidth / 2;
      const bgY = labelY - bgHeight / 2;
      const borderRadius = 5 / this.state.scale;
      
      ctx.beginPath();
      ctx.roundRect(bgX, bgY, bgWidth, bgHeight, borderRadius);
      ctx.fill();
      
      // Borde blanco del fondo
      ctx.strokeStyle = isSelected ? '#fbbf24' : 'white';
      ctx.lineWidth = 2 / this.state.scale;
      ctx.stroke();
      
      // Texto blanco
      ctx.fillStyle = 'white';
      ctx.fillText(text, point.x, labelY);
    });
    
    ctx.restore();
  },

  //  ETAPA 3.2: Dibujar handles de reshape (puntos editables)
  drawReshapeHandles(ctx) {
    if (!this.state.reshapeAreaId || !this.state.reshapePoints.length) return;
    
    ctx.save();
    
    const lineWidth = Math.max(3, 3 / this.state.scale);
    const pointRadius = Math.max(8, 8 / this.state.scale);
    const selectedRadius = Math.max(12, 12 / this.state.scale);
    const hoveredRadius = Math.max(10, 10 / this.state.scale);
    
    // Dibujar el polgono en edicin con estilo destacado
    ctx.beginPath();
    this.state.reshapePoints.forEach((point, index) => {
      if (index === 0) {
        ctx.moveTo(point.x, point.y);
      } else {
        ctx.lineTo(point.x, point.y);
      }
    });
    ctx.closePath();
    
    // Lnea punteada azul
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = lineWidth;
    ctx.setLineDash([8 / this.state.scale, 4 / this.state.scale]);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Dibujar bordes con indicador de hover (para agregar puntos)
    if (this.state.hoveredEdgeIndex !== null && this.state.hoveredEdgeIndex !== -1) {
      const p1 = this.state.reshapePoints[this.state.hoveredEdgeIndex];
      const p2 = this.state.reshapePoints[(this.state.hoveredEdgeIndex + 1) % this.state.reshapePoints.length];
      
      ctx.beginPath();
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.strokeStyle = '#10b981'; // Verde para indicar que puede agregar
      ctx.lineWidth = lineWidth * 1.5;
      ctx.stroke();
      
      // Dibujar punto fantasma donde se agregara
      const midX = (p1.x + p2.x) / 2;
      const midY = (p1.y + p2.y) / 2;
      
      ctx.beginPath();
      ctx.arc(midX, midY, pointRadius * 0.8, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(16, 185, 129, 0.3)';
      ctx.fill();
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 2 / this.state.scale;
      ctx.stroke();
    }
    
    // Dibujar puntos editables
    this.state.reshapePoints.forEach((point, index) => {
      const isSelected = index === this.state.selectedPointIndex;
      const isHovered = index === this.state.hoveredPointIndex;
      const isDragging = isSelected && this.state.isDraggingPoint;
      
      let radius = pointRadius;
      if (isSelected) radius = selectedRadius;
      else if (isHovered) radius = hoveredRadius;
      
      // Sombra
      ctx.shadowColor = isDragging ? 'rgba(59, 130, 246, 0.6)' : 'rgba(0, 0, 0, 0.3)';
      ctx.shadowBlur = isDragging ? 12 / this.state.scale : 6 / this.state.scale;
      ctx.shadowOffsetX = 2 / this.state.scale;
      ctx.shadowOffsetY = 2 / this.state.scale;
      
      // Crculo principal
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius, 0, Math.PI * 2);
      
      if (isDragging) {
        ctx.fillStyle = '#3b82f6'; // Azul slido
      } else if (isSelected) {
        ctx.fillStyle = '#60a5fa'; // Azul claro
      } else if (isHovered) {
        ctx.fillStyle = '#93c5fd'; // Azul muy claro
      } else {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)'; // Blanco semi-transparente
      }
      ctx.fill();
      
      // Quitar sombra para el borde
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      
      // Borde
      ctx.strokeStyle = isSelected || isDragging ? '#3b82f6' : '#64748b';
      ctx.lineWidth = 2 / this.state.scale;
      ctx.stroke();
      
      // Punto interior
      if (isSelected || isHovered) {
        ctx.beginPath();
        ctx.arc(point.x, point.y, radius * 0.4, 0, Math.PI * 2);
        ctx.fillStyle = '#3b82f6';
        ctx.fill();
      }
      
      // Nmero del punto
      const fontSize = Math.max(10, 10 / this.state.scale);
      ctx.font = `bold ${fontSize}px sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      const labelY = point.y - radius - 10 / this.state.scale;
      const text = String(index + 1);
      
      // Fondo del nmero
      const metrics = ctx.measureText(text);
      const padding = 3 / this.state.scale;
      const bgWidth = metrics.width + padding * 2;
      const bgHeight = fontSize + padding;
      
      ctx.fillStyle = isSelected ? '#3b82f6' : 'rgba(0, 0, 0, 0.7)';
      const bgX = point.x - bgWidth / 2;
      const bgY = labelY - bgHeight / 2;
      
      ctx.beginPath();
      ctx.roundRect(bgX, bgY, bgWidth, bgHeight, 3 / this.state.scale);
      ctx.fill();
      
      // Texto
      ctx.fillStyle = 'white';
      ctx.fillText(text, point.x, labelY);
    });
    
    // Mostrar controles en pantalla
    if (this.state.reshapeAreaId) {
      ctx.restore(); // Restaurar para dibujar en coordenadas de pantalla
      
      ctx.save();
      ctx.setTransform(1, 0, 0, 1, 0, 0); // Resetear transformacin
      
      // Panel de ayuda
      const canvas = this.elements.canvas;
      const panelX = 10;
      const panelY = canvas.height - 100;
      const panelWidth = 280;
      const panelHeight = 90;
      
      // Fondo del panel
      ctx.fillStyle = 'rgba(15, 23, 42, 0.95)';
      ctx.beginPath();
      ctx.roundRect(panelX, panelY, panelWidth, panelHeight, 8);
      ctx.fill();
      
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // Texto de ayuda
      ctx.fillStyle = '#e2e8f0';
      ctx.font = 'bold 12px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText(' Modo Edicin de Puntos', panelX + 12, panelY + 20);
      
      ctx.font = '11px sans-serif';
      ctx.fillStyle = '#cbd5e1';
      ctx.fillText(' Arrastra puntos para moverlos', panelX + 12, panelY + 40);
      ctx.fillText(' Click en borde para agregar punto', panelX + 12, panelY + 55);
      ctx.fillText(' Selecciona + Delete para eliminar', panelX + 12, panelY + 70);
      
      // Botones
      const btnY = panelY + panelHeight + 10;
      const btnHeight = 32;
      const btnPadding = 8;
      
      // Botn Guardar
      const saveBtn = { x: panelX, y: btnY, width: 100, height: btnHeight };
      ctx.fillStyle = '#10b981';
      ctx.beginPath();
      ctx.roundRect(saveBtn.x, saveBtn.y, saveBtn.width, saveBtn.height, 6);
      ctx.fill();
      
      ctx.fillStyle = 'white';
      ctx.font = 'bold 12px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(' Guardar (Enter)', saveBtn.x + saveBtn.width / 2, saveBtn.y + saveBtn.height / 2);
      
      // Botn Cancelar
      const cancelBtn = { x: panelX + 110, y: btnY, width: 100, height: btnHeight };
      ctx.fillStyle = '#ef4444';
      ctx.beginPath();
      ctx.roundRect(cancelBtn.x, cancelBtn.y, cancelBtn.width, cancelBtn.height, 6);
      ctx.fill();
      
      ctx.fillStyle = 'white';
      ctx.fillText(' Cancelar (Esc)', cancelBtn.x + cancelBtn.width / 2, cancelBtn.y + cancelBtn.height / 2);
      
      ctx.restore();
      return; // Ya hicimos restore
    }
    
    ctx.restore();
  },

  //  NUEVO: Renderizar minimap con vista general
  drawMinimap() {
    if (!this.minimapCtx || !this.elements.minimap) return;

    const image = this.getMinimapBitmap();
    if (!image) return;

    const minimap = this.elements.minimap;
    const ctx = this.minimapCtx;
    const container = this.elements.minimapContainer;
    
    // Ajustar tamao del canvas minimap al contenedor
    const containerWidth = container.offsetWidth;
    const containerHeight = container.offsetHeight;
    
    if (minimap.width !== containerWidth || minimap.height !== containerHeight) {
      minimap.width = containerWidth;
      minimap.height = containerHeight;
    }

    // Limpiar minimap
    ctx.clearRect(0, 0, minimap.width, minimap.height);
    ctx.fillStyle = 'rgba(15, 23, 42, 0.5)';
    ctx.fillRect(0, 0, minimap.width, minimap.height);

    // Calcular escala para que la imagen completa quepa en el minimap
    const dimensions = this.getMapDimensionsSafe();
    if (!dimensions.width || !dimensions.height) return;

    const imgWidth = dimensions.width;
    const imgHeight = dimensions.height;
    const scaleX = minimap.width / imgWidth;
    const scaleY = minimap.height / imgHeight;
    const minimapScale = Math.min(scaleX, scaleY) * 0.95; // 95% para dejar margen

    // Centrar imagen en minimap
    const drawWidth = imgWidth * minimapScale;
    const drawHeight = imgHeight * minimapScale;
    const offsetX = (minimap.width - drawWidth) / 2;
    const offsetY = (minimap.height - drawHeight) / 2;

    // Dibujar imagen en minimap
    ctx.save();
    ctx.translate(offsetX, offsetY);
    ctx.scale(minimapScale, minimapScale);
    ctx.globalAlpha = 0.6;
    ctx.drawImage(image, 0, 0, image.width, image.height, 0, 0, imgWidth, imgHeight);
    ctx.globalAlpha = 1;

    // Dibujar reas en minimap
    this.state.areas.forEach(area => {
      if (!Array.isArray(area.points) || area.points.length < 3) return;

      ctx.beginPath();
      area.points.forEach((point, index) => {
        if (index === 0) {
          ctx.moveTo(point.x, point.y);
        } else {
          ctx.lineTo(point.x, point.y);
        }
      });
      ctx.closePath();

      // Color del rea
      ctx.fillStyle = area.color ? `${area.color}40` : 'rgba(59, 130, 246, 0.25)';
      ctx.fill();
      ctx.strokeStyle = area.color || '#3b82f6';
      ctx.lineWidth = 1.5 / minimapScale;
      ctx.stroke();
    });

    ctx.restore();

    // Dibujar rectngulo del viewport actual
    const viewport = this.elements.minimapViewport;
    if (viewport) {
      const mainCanvas = this.elements.canvas;
      
      // Calcular viewport en coordenadas del mundo
      const viewLeft = -this.state.offsetX / this.state.scale;
      const viewTop = -this.state.offsetY / this.state.scale;
      const viewWidth = mainCanvas.width / this.state.scale;
      const viewHeight = mainCanvas.height / this.state.scale;

      // Convertir a coordenadas del minimap
      const vpLeft = offsetX + viewLeft * minimapScale;
      const vpTop = offsetY + viewTop * minimapScale;
      const vpWidth = viewWidth * minimapScale;
      const vpHeight = viewHeight * minimapScale;

      viewport.style.left = `${Math.max(0, Math.min(vpLeft, minimap.width))}px`;
      viewport.style.top = `${Math.max(0, Math.min(vpTop, minimap.height))}px`;
      viewport.style.width = `${Math.max(0, Math.min(vpWidth, minimap.width - vpLeft))}px`;
      viewport.style.height = `${Math.max(0, Math.min(vpHeight, minimap.height - vpTop))}px`;
    }
  },

  registerCanvasEvents() {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    canvas.addEventListener('mousedown', (event) => {
      if (event.button === 0) {
        const rect = canvas.getBoundingClientRect();
        const screenX = event.clientX - rect.left;
        const screenY = event.clientY - rect.top;
        
        // Calcular coordenadas transformadas (coordenadas de la imagen)
        const mapX = (screenX - this.state.offsetX) / this.state.scale;
        const mapY = (screenY - this.state.offsetY) / this.state.scale;
        
        //  VERIFICAR SI SE HIZO CLICK EN EL NOMBRE DE UN REA (para fijar tooltip)
        if (this.state.mostrarNombresAreas && !this.state.drawing && !this.state.editingAreaId && !this.state.modoAgregarMarcadorActivo) {
          let clickedOnLabel = false;
          let clickedArea = null;
          
          for (const area of this.state.areas) {
            if (!Array.isArray(area.points) || area.points.length < 3) continue;
            
            const centroid = this.calculateCentroid(area.points);
            if (!centroid) continue;
            
            const labelOffsetX = area.labelOffsetX || 0;
            const labelOffsetY = area.labelOffsetY || 0;
            const labelX = centroid.x + labelOffsetX;
            const labelY = centroid.y + labelOffsetY;
            
            // Calcular dimensiones del rectngulo del texto
            const text = area.name || 'rea';
            const maxCharsPerLine = 20;
            const lines = [];
            
            if (text.length <= maxCharsPerLine) {
              lines.push(text);
            } else {
              const words = text.split(' ');
              let currentLine = '';
              words.forEach((word, idx) => {
                const testLine = currentLine ? `${currentLine} ${word}` : word;
                if (testLine.length <= maxCharsPerLine) {
                  currentLine = testLine;
                } else {
                  if (currentLine) lines.push(currentLine);
                  currentLine = word;
                }
                if (idx === words.length - 1 && currentLine) {
                  lines.push(currentLine);
                }
              });
            }
            
            const baseFontSize = 28;
            const minFontSize = 14;
            const zoomFactor = this.state.zoom || 1.0;
            const fontSize = Math.max(minFontSize, baseFontSize / Math.sqrt(zoomFactor));
            
            const maxLineLength = Math.max(...lines.map(l => l.length));
            const textWidth = maxLineLength * fontSize * 0.6;
            const lineHeight = fontSize * 1.2;
            const textHeight = lineHeight * lines.length;
            
            const paddingX = Math.max(6, 12 / Math.sqrt(zoomFactor));
            const paddingY = Math.max(4, 8 / Math.sqrt(zoomFactor));
            
            const rectWidth = textWidth + paddingX * 2;
            const rectHeight = textHeight + paddingY * 2;
            const rectX = labelX - rectWidth / 2;
            const rectY = labelY - rectHeight / 2;
            
            // Verificar si el click est dentro del rectngulo del nombre
            if (mapX >= rectX && mapX <= rectX + rectWidth &&
                mapY >= rectY && mapY <= rectY + rectHeight) {
              clickedOnLabel = true;
              clickedArea = area;
              break;
            }
          }
          
          if (clickedOnLabel && clickedArea) {
            // Si el tooltip ya est fijado en esta rea, desfijarlo
            if (this.state.tooltipPinned && this.state.pinnedAreaId === clickedArea.id) {
              this.state.tooltipPinned = false;
              this.state.pinnedAreaId = null;
              this.state.highlightAreaId = null; //  Quitar resaltado amarillo
              this.elements.tooltip.classList.add('hidden');
              this.scheduleRender(); //  Redibujar para quitar el amarillo
              console.log(' Tooltip desfijado');
            } else {
              // Fijar el tooltip en esta rea
              this.state.tooltipPinned = true;
              this.state.pinnedAreaId = clickedArea.id;
              this.state.highlightAreaId = clickedArea.id; //  Resaltar rea en amarillo
              // Forzar actualizacin del tooltip
              this.updateTooltip(event);
              this.scheduleRender(); //  Redibujar con resaltado
              console.log(' Tooltip fijado en:', clickedArea.name);
            }
            
            // Prevenir otros comportamientos
            event.preventDefault();
            event.stopPropagation();
            return;
          } else if (!clickedOnLabel && this.state.tooltipPinned) {
            // Si se hace click fuera del label y el tooltip est fijado, desfijarlo
            this.state.tooltipPinned = false;
            this.state.pinnedAreaId = null;
            this.state.highlightAreaId = null; //  Quitar resaltado amarillo
            this.elements.tooltip.classList.add('hidden');
            this.scheduleRender(); //  Redibujar para quitar el amarillo
            console.log(' Tooltip desfijado por click fuera');
          }
          
          //  NUEVO: Si se hace click fuera, quitar seleccin de marcador tambin
          if (!clickedOnLabel) {
            this.clearMarkerSelection();
          }
        }
        
        //  MODO AGREGAR MARCADOR: Detectar click en rea y abrir modal
        if (this.state.modoAgregarMarcadorActivo) {
          console.log(' Click en modo agregar marcador:', { 
            screen: { screenX, screenY },
            map: { mapX, mapY },
            transform: { offsetX: this.state.offsetX, offsetY: this.state.offsetY, scale: this.state.scale }
          });
          
          // Buscar el rea donde se hizo click (usando coordenadas de la imagen)
          const areas = this.state.areas || [];
          console.log(' reas en el mapa:', areas.length);
          
          if (areas.length === 0) {
            console.warn(' No hay reas cargadas!');
            this.showToast(' Este mapa no tiene reas definidas', 'warning');
            event.preventDefault();
            event.stopPropagation();
            return;
          }
          
          // Probar cada rea
          let areaClickeada = null;
          for (const area of areas) {
            console.log(` Probando rea "${area.name}":`, {
              points: area.points.length,
              primer_punto: area.points[0],
              click: { mapX, mapY }
            });
            
            const dentro = this.puntoEnArea(mapX, mapY, area);
            console.log(`   Resultado: ${dentro ? ' DENTRO' : ' fuera'}`);
            
            if (dentro) {
              areaClickeada = area;
              break;
            }
          }
          
          if (areaClickeada) {
            console.log(' Click dentro del rea:', areaClickeada.name);
            // Usar coordenadas de la imagen para el marcador
            this.abrirModalBusquedaRepuesto(mapX, mapY, areaClickeada);
          } else {
            console.log(' No se encontr rea en las coordenadas:', { mapX, mapY });
            this.showToast(' Debes hacer click dentro de un rea', 'warning');
          }
          
          event.preventDefault();
          event.stopPropagation();
          return;
        }
        
        //  MODO MOVER PIN: Si estamos en modo edicin de pin
        if (this.state.pinAMover && this.state.pinAMover.editando) {
          console.log(' Click en modo edicin de pin');
          
          const marcadorClickeado = this.detectarClickEnMarcador(mapX, mapY);
          
          if (marcadorClickeado && 
              String(marcadorClickeado.repuesto.id) === String(this.state.pinAMover.repuestoId) &&
              marcadorClickeado.ubicacionIndex === this.state.pinAMover.ubicacionIndex) {
            
            console.log(' Click en el pin correcto! Activando arrastre...');
            
            // Activar arrastre del pin
            this.state.marcadorArrastre = {
              info: marcadorClickeado,
              iniciado: true,
              inicioX: screenX,
              inicioY: screenY,
              tiempoInicio: Date.now(),
              mapX: mapX,
              mapY: mapY,
              esEdicionPin: true  // Bandera especial para saber que es edicin de pin
            };
            
            canvas.style.cursor = 'grabbing';
            event.preventDefault();
            event.stopPropagation();
            return;
          }
        }
        
        //  CLICK EN MARCADORES FUERA DE MODO EDICIN: Fijar tarjeta hover
        if (!this.state.isReshapeMode && !this.state.pinAMover) {
          const marcadorClickeado = this.detectarClickEnMarcador(mapX, mapY);
          if (marcadorClickeado) {
            console.log(' Click en marcador  Fijar tarjeta hover');
            
            //  SOLUCIN: Delay para evitar que se cierre inmediatamente
            // Primero cerrar tarjeta anterior
            const tarjetaAnterior = document.getElementById('tarjetaHoverRepuesto');
            if (tarjetaAnterior) {
              tarjetaAnterior.remove();
            }
            
            // Marcar que estamos abriendo una nueva tarjeta
            this.state.abriendo_tarjeta_fija = true;
            
            // Abrir nueva tarjeta con delay
            setTimeout(() => {
              this.fijarTarjetaHoverRepuesto(marcadorClickeado, screenX, screenY);
              // Resetear bandera despus de que se haya montado
              setTimeout(() => {
                this.state.abriendo_tarjeta_fija = false;
              }, 150);
            }, 10);
            
            event.preventDefault();
            event.stopPropagation();
            return;
          } else {
            // Click fuera de marcadores  Cerrar tarjeta fija si existe
            // Solo cerrar si NO estamos abriendo una nueva
            if (!this.state.abriendo_tarjeta_fija) {
              this.cerrarTarjetaFija();
            }
          }
        }
        
        //  PRIORIDAD MXIMA: Modo marcador de repuesto
        if (this.state.modoMarcador && this.state.marcadorPendiente) {
          console.log(' Click detectado en modo marcador:', { mapX, mapY });
          this.colocarMarcador(mapX, mapY);
          return;
        }
        
        //  ETAPA 3.2: Detectar click en botones del panel de reshape
        if (this.state.isReshapeMode && this.state.reshapeAreaId) {
          const rect = canvas.getBoundingClientRect();
          const clickX = event.clientX - rect.left;
          const clickY = event.clientY - rect.top;
          
          const panelY = canvas.height - 100;
          const btnY = panelY + 90 + 10;
          const btnHeight = 32;
          
          // Botn Guardar
          if (clickX >= 10 && clickX <= 110 && clickY >= btnY && clickY <= btnY + btnHeight) {
            this.saveReshapeChanges();
            return;
          }
          
          // Botn Cancelar
          if (clickX >= 120 && clickX <= 220 && clickY >= btnY && clickY <= btnY + btnHeight) {
            this.cancelReshape();
            return;
          }
        }
        
        //  ETAPA 3.2: Modo reshape (edicin de puntos Y repuestos)
        if (this.state.isReshapeMode) {
          //  PRIORIDAD 1: Verificar si se clicke un marcador de repuesto
          const marcadorClickeado = this.detectarClickEnMarcador(mapX, mapY);
          if (marcadorClickeado) {
            console.log(' Modo edicin: Click en marcador de repuesto - PERMITIR ARRASTRE');
            //  Activar arrastre del marcador (SOLO en modo edicin)
            this.state.marcadorArrastre = {
              info: marcadorClickeado,
              iniciado: false, // Se activar al mover el mouse
              inicioX: screenX,
              inicioY: screenY,
              tiempoInicio: Date.now(),
              modoEdicion: true // Bandera para saber que est en modo edicin
            };
            event.preventDefault();
            event.stopPropagation();
            return;
          }
          
          //  PRIORIDAD 2: Si no hay marcador, verificar puntos de rea
          const pointIndex = this.state.reshapeAreaId ? this.findPointAtCursor(
            (event.clientX - this.elements.canvas.getBoundingClientRect().left - this.state.offsetX) / this.state.scale,
            (event.clientY - this.elements.canvas.getBoundingClientRect().top - this.state.offsetY) / this.state.scale
          ) : -1;
          
          if (pointIndex !== -1) {
            // Iniciar arrastre de punto de rea
            this.state.selectedPointIndex = pointIndex;
            this.state.isDraggingPoint = true;
          } else {
            // Click normal en reshape (seleccionar rea)
            this.handleReshapeClick(event);
          }
        }
        //  ETAPA 3.1: Modo seleccin mltiple
        else if (this.state.isMultiSelectMode && !this.state.drawing && !this.state.editingAreaId) {
          this.handleMultiSelectClick(event);
        } else if (this.state.editingAreaId) {
          // Modo edicin de puntos
          this.handleEditPointMouseDown(event);
        } else if (this.state.drawing) {
          this.addPoint(event);
        } else {
          this.beginPan(event);
        }
      }
    });

    canvas.addEventListener('mousemove', (event) => {
      //  ARRASTRE DE MARCADOR: Detectar movimiento para activar arrastre
      if (this.state.marcadorArrastre && !this.state.marcadorArrastre.iniciado) {
        const rect = canvas.getBoundingClientRect();
        const screenX = event.clientX - rect.left;
        const screenY = event.clientY - rect.top;
        
        const distancia = Math.sqrt(
          Math.pow(screenX - this.state.marcadorArrastre.inicioX, 2) +
          Math.pow(screenY - this.state.marcadorArrastre.inicioY, 2)
        );
        
        // Si se movi ms de 5px, activar modo arrastre
        if (distancia > 5) {
          this.state.marcadorArrastre.iniciado = true;
          canvas.style.cursor = 'grabbing';
        }
      }
      
      //  ARRASTRE DE MARCADOR: Mover marcador
      if (this.state.marcadorArrastre && this.state.marcadorArrastre.iniciado) {
        const rect = canvas.getBoundingClientRect();
        const screenX = event.clientX - rect.left;
        const screenY = event.clientY - rect.top;
        const mapX = (screenX - this.state.offsetX) / this.state.scale;
        const mapY = (screenY - this.state.offsetY) / this.state.scale;
        
        // Actualizar posicin temporal para dibujo
        this.state.marcadorArrastre.mapX = mapX;
        this.state.marcadorArrastre.mapY = mapY;
        
        // Si es edicin de pin, actualizar tambin ubicacionesResaltadas
        if (this.state.marcadorArrastre.esEdicionPin) {
          this.state.ubicacionesResaltadas = [{
            x: mapX,
            y: mapY,
            repuesto: 'Nueva posicin',
            descripcion: 'Suelta aqu para guardar'
          }];
        }
        
        requestAnimationFrame(() => this.draw());
        return;
      }
      
      //  ETAPA 3.2: Modo reshape
      if (this.state.isReshapeMode && this.state.reshapeAreaId) {
        this.handleReshapeMouseMove(event);
      }
      else if (this.state.isDraggingPoint) {
        // Arrastrando un punto en modo edicin
        this.handleEditPointDrag(event);
      } else if (this.state.editingAreaId) {
        // Hover sobre puntos en modo edicin
        this.updateEditPointHover(event);
      } else if (this.state.drawing) {
        this.updatePreviewPoint(event);
      } else if (this.state.isPanning) {
        this.pan(event);
      } else {
        //  Cambiar cursor y mostrar tarjeta hover si est sobre un marcador
        const rect = canvas.getBoundingClientRect();
        const screenX = event.clientX - rect.left;
        const screenY = event.clientY - rect.top;
        const mapX = (screenX - this.state.offsetX) / this.state.scale;
        const mapY = (screenY - this.state.offsetY) / this.state.scale;
        
        const marcadorHover = this.detectarClickEnMarcador(mapX, mapY);
        if (marcadorHover) {
          canvas.style.cursor = this.state.isReshapeMode ? 'grab' : 'pointer';
          
          //  Mostrar tarjeta hover simplificada
          this.mostrarTarjetaHoverRepuesto(marcadorHover, screenX, screenY);
        } else {
          canvas.style.cursor = 'default';
          
          // Ocultar tarjeta hover
          this.ocultarTarjetaHoverRepuesto();
        }
        
        //  NUEVO: Mostrar tooltip al pasar sobre reas
        this.updateTooltip(event);
      }
    });

    ['mouseup', 'mouseleave'].forEach(type => {
      canvas.addEventListener(type, (event) => {
        //  ARRASTRE DE MARCADOR: Finalizar arrastre o mostrar men
        if (this.state.marcadorArrastre) {
          if (this.state.marcadorArrastre.iniciado) {
            // Se arrastr el marcador
            const rect = canvas.getBoundingClientRect();
            const screenX = event.clientX - rect.left;
            const screenY = event.clientY - rect.top;
            const mapX = (screenX - this.state.offsetX) / this.state.scale;
            const mapY = (screenY - this.state.offsetY) / this.state.scale;
            
            // Si es edicin de pin, NO guardar automticamente
            if (this.state.marcadorArrastre.esEdicionPin) {
              console.log(' Pin soltado en modo edicin');
              // Solo actualizar la posicin visual, el usuario debe hacer click en "Guardar"
              canvas.style.cursor = 'grab';
            } else {
              // Arrastre normal, guardar automticamente
              this.guardarNuevaPosicionMarcador(
                this.state.marcadorArrastre.info,
                mapX,
                mapY
              );
              canvas.style.cursor = 'default';
            }
          } else {
            // Click corto - distinguir entre modo edicin y modo normal
            if (this.state.marcadorArrastre.modoEdicion) {
              // En modo edicin, NO mostrar men (solo arrastre o nada)
              console.log(' Click corto en modo edicin - no hacer nada');
            } else if (!this.state.marcadorArrastre.esEdicionPin) {
              // Modo normal: mostrar men contextual
              const tiempoClick = Date.now() - this.state.marcadorArrastre.tiempoInicio;
              
              if (tiempoClick < 300) {
                // Click rpido = men contextual
                this.mostrarMenuMarcador(
                  this.state.marcadorArrastre.info,
                  this.state.marcadorArrastre.inicioX,
                  this.state.marcadorArrastre.inicioY
                );
              }
            }
          }
          
          this.state.marcadorArrastre = null;
          return;
        }
        
        //  ETAPA 3.2: Soltar punto en reshape
        if (this.state.isReshapeMode && this.state.isDraggingPoint) {
          this.state.isDraggingPoint = false;
          this.draw();
        }
        else if (this.state.isDraggingPoint) {
          this.handleEditPointMouseUp();
        }
        this.endPan();
      });
    });

    // Event listener pasivo para wheel - mejora rendimiento
    canvas.addEventListener('wheel', (event) => this.handleWheel(event), { passive: false });

    canvas.addEventListener('dblclick', (event) => {
      if (this.state.editingAreaId) {
        event.preventDefault();
        // No hacer nada, los botones de guardar/cancelar estn en pantalla
        return;
      } else if (this.state.drawing) {
        event.preventDefault();
        this.finishDrawing();
      } else {
        //  Doble click afuera: Limpiar filtro de repuesto
        if (this.state.repuestoFiltrado || this.state.ubicacionesResaltadas.length > 0) {
          this.state.repuestoFiltrado = null;
          this.state.ubicacionesResaltadas = [];
          this.showToast(' Filtro limpiado - Mostrando todos los repuestos', 'success', 2000);
          this.draw();
        }
      }
    });

    canvas.addEventListener('contextmenu', (event) => {
      if (this.state.editingAreaId) {
        event.preventDefault();
        // No cancelar con click derecho, solo los botones en pantalla
        return;
      } else if (this.state.drawing) {
        event.preventDefault();
        this.finishDrawing();
      }
    });

    //  ETAPA 3.1: Atajos de teclado para seleccin mltiple
    document.addEventListener('keydown', (event) => {
      // Solo si el mapa est visible y activo
      if (!this.state.currentMap) return;
      
      //  ETAPA 3.2: Atajos de reshape
      if (this.state.isReshapeMode && this.state.reshapeAreaId) {
        // Delete: Eliminar punto seleccionado
        if (event.key === 'Delete' && this.state.selectedPointIndex !== null) {
          event.preventDefault();
          this.deleteSelectedPoint();
          return;
        }
        
        // Enter: Guardar cambios
        if (event.key === 'Enter') {
          event.preventDefault();
          this.saveReshapeChanges();
          return;
        }
        
        // Escape: Cancelar edicin
        if (event.key === 'Escape') {
          event.preventDefault();
          this.cancelReshape();
          return;
        }
      }
      
      // Ctrl+A: Seleccionar todas las reas
      if (event.ctrlKey && event.key === 'a' && this.state.isMultiSelectMode) {
        event.preventDefault();
        this.selectAllAreas();
      }
      
      // Escape: Deseleccionar todas
      if (event.key === 'Escape' && this.state.selectedAreaIds.length > 0) {
        event.preventDefault();
        this.deselectAllAreas();
      }
      
      // Delete: Eliminar reas seleccionadas
      if (event.key === 'Delete' && this.state.selectedAreaIds.length > 0 && this.state.isMultiSelectMode) {
        event.preventDefault();
        this.batchDeleteAreas();
      }
      
      // Ctrl+B: Abrir operaciones en lote
      if (event.ctrlKey && event.key === 'b' && this.state.selectedAreaIds.length > 0) {
        event.preventDefault();
        this.openBatchOperationsModal();
      }
    });
  },

  beginPan(event) {
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    this.state.isPanning = true;
    this.state.panStartX = canvasX - this.state.offsetX;
    this.state.panStartY = canvasY - this.state.offsetY;
    this.elements.canvas.style.cursor = 'grabbing';
  },

  pan(event) {
    if (!this.state.isPanning) return;
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    this.state.offsetX = canvasX - this.state.panStartX;
    this.state.offsetY = canvasY - this.state.panStartY;
    this.scheduleRender();
    this.viewportChangedDuringPan = true;
  },

  endPan() {
    if (this.state.isPanning) {
      this.state.isPanning = false;
      this.elements.canvas.style.cursor = this.state.drawing ? 'crosshair' : 'grab';
      if (this.viewportChangedDuringPan) {
        this.viewportChangedDuringPan = false;
        this.queueViewportPersist('pan');
      }
    }
  },

  handleWheel(event) {
    if (!this.state.currentImage) return;
    event.preventDefault();
    const delta = event.deltaY > 0 ? 0.85 : 1.15;
    const coords = this.getCanvasCoordinates(event);
    this.zoomAt(coords.canvasX, coords.canvasY, delta);
  },

  handleEditPointMouseDown(event) {
    if (!this.state.editingAreaId || !this.state.editingPoints.length) return;
    
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const threshold = 50; // Threshold ENORME: 50px (era 35px)
    
    // Buscar el punto ms cercano
    let closestIndex = -1;
    let closestDist = Infinity;
    
    this.state.editingPoints.forEach((point, index) => {
      // Convertir punto de imagen a pantalla
      const screenX = point.x * this.state.scale + this.state.offsetX;
      const screenY = point.y * this.state.scale + this.state.offsetY;
      
      const dx = screenX - canvasX;
      const dy = screenY - canvasY;
      const dist = Math.sqrt(dx * dx + dy * dy);
      
      if (dist < threshold && dist < closestDist) {
        closestDist = dist;
        closestIndex = index;
      }
    });
    
    if (closestIndex !== -1) {
      this.state.selectedPointIndex = closestIndex;
      this.state.isDraggingPoint = true;
      this.elements.canvas.style.cursor = 'grabbing';
      this.draw(); // Redibujar para mostrar punto seleccionado
      console.log(' Punto', closestIndex + 1, 'seleccionado, distancia:', closestDist.toFixed(1), 'px');
    }
  },

  handleEditPointDrag(event) {
    if (!this.state.isDraggingPoint || this.state.selectedPointIndex === null) return;
    
    const { mapX, mapY } = this.getMapPoint(event);
    if (!Number.isFinite(mapX) || !Number.isFinite(mapY)) return;
    
    // Actualizar posicin del punto seleccionado
    this.state.editingPoints[this.state.selectedPointIndex] = { x: mapX, y: mapY };
    this.scheduleRender();
  },

  handleEditPointMouseUp() {
    if (this.state.isDraggingPoint) {
      this.state.isDraggingPoint = false;
      // NO limpiar selectedPointIndex para mantener el punto resaltado
      console.log(' Punto', (this.state.selectedPointIndex + 1), 'soltado, listo para mover otro');
      this.elements.canvas.style.cursor = 'grab';
      this.scheduleRender(); // Redibujar
    }
  },

  updateEditPointHover(event) {
    if (!this.state.editingAreaId || !this.state.editingPoints.length || this.state.isDraggingPoint) return;
    
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const threshold = 50; // 50px en pantalla
    
    // Ver si el cursor est cerca de algn punto (en coordenadas de pantalla)
    let nearPoint = false;
    for (const point of this.state.editingPoints) {
      const screenX = point.x * this.state.scale + this.state.offsetX;
      const screenY = point.y * this.state.scale + this.state.offsetY;
      
      const dx = screenX - canvasX;
      const dy = screenY - canvasY;
      const dist = Math.sqrt(dx * dx + dy * dy);
      
      if (dist < threshold) {
        nearPoint = true;
        break;
      }
    }
    
    this.elements.canvas.style.cursor = nearPoint ? 'grab' : 'default';
  },

  //  NUEVO: Mostrar tooltip al pasar sobre el NOMBRE del rea (no el rea completa)
  updateTooltip(event) {
    const tooltip = this.elements.tooltip;
    if (!tooltip || !this.state.currentImage || this.state.drawing || this.state.editingAreaId) {
      if (tooltip && !this.state.tooltipPinned) {
        tooltip.classList.add('hidden');
      }
      return;
    }

    // Si el tooltip est "fijado" (pinned), mantenerlo con el rea fijada
    if (this.state.tooltipPinned && this.state.pinnedAreaId) {
      const pinnedArea = this.state.areas.find(a => a.id === this.state.pinnedAreaId);
      if (pinnedArea) {
        this.renderTooltipContent(pinnedArea, event);
        return;
      } else {
        // Si el rea ya no existe, desfijar
        this.state.tooltipPinned = false;
        this.state.pinnedAreaId = null;
        this.state.highlightAreaId = null; //  Quitar resaltado
        this.scheduleRender(); //  Redibujar
      }
    }

    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    
    // Convertir coordenadas de canvas a coordenadas del mundo (imagen)
    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;

    // Buscar rea cuyo NOMBRE est bajo el cursor
    let hoveredArea = null;
    
    if (this.state.mostrarNombresAreas) {
      for (const area of this.state.areas) {
        if (!Array.isArray(area.points) || area.points.length < 3) continue;
        
        // Calcular centroide y posicin del label
        const centroid = this.calculateCentroid(area.points);
        if (!centroid) continue;
        
        const labelOffsetX = area.labelOffsetX || 0;
        const labelOffsetY = area.labelOffsetY || 0;
        const labelX = centroid.x + labelOffsetX;
        const labelY = centroid.y + labelOffsetY;
        
        // Calcular dimensiones del rectngulo del texto
        const text = area.name || 'rea';
        const maxCharsPerLine = 20;
        const lines = [];
        
        if (text.length <= maxCharsPerLine) {
          lines.push(text);
        } else {
          const words = text.split(' ');
          let currentLine = '';
          words.forEach((word, idx) => {
            const testLine = currentLine ? `${currentLine} ${word}` : word;
            if (testLine.length <= maxCharsPerLine) {
              currentLine = testLine;
            } else {
              if (currentLine) lines.push(currentLine);
              currentLine = word;
            }
            if (idx === words.length - 1 && currentLine) {
              lines.push(currentLine);
            }
          });
        }
        
        // Estimar dimensiones (aproximado, sin usar ctx.measureText)
        const baseFontSize = 28;
        const minFontSize = 14;
        const zoomFactor = this.state.zoom || 1.0;
        const fontSize = Math.max(minFontSize, baseFontSize / Math.sqrt(zoomFactor));
        
        // Aproximar ancho: cada carcter ~0.6 del fontSize
        const maxLineLength = Math.max(...lines.map(l => l.length));
        const textWidth = maxLineLength * fontSize * 0.6;
        const lineHeight = fontSize * 1.2;
        const textHeight = lineHeight * lines.length;
        
        const paddingX = Math.max(6, 12 / Math.sqrt(zoomFactor));
        const paddingY = Math.max(4, 8 / Math.sqrt(zoomFactor));
        
        const rectWidth = textWidth + paddingX * 2;
        const rectHeight = textHeight + paddingY * 2;
        const rectX = labelX - rectWidth / 2;
        const rectY = labelY - rectHeight / 2;
        
        // Verificar si el cursor est dentro del rectngulo del nombre
        if (worldX >= rectX && worldX <= rectX + rectWidth &&
            worldY >= rectY && worldY <= rectY + rectHeight) {
          hoveredArea = area;
          break;
        }
      }
    }

    if (hoveredArea) {
      this.renderTooltipContent(hoveredArea, event);
    } else {
      tooltip.classList.add('hidden');
    }
  },

  //  Renderizar contenido del tooltip para un rea
  renderTooltipContent(area, event) {
    const tooltip = this.elements.tooltip;
    if (!tooltip) return;
    
    // Obtener categora
    const category = this.categories[area.category] || this.categories.area;
    
    // Construir contenido del tooltip
    let tooltipHTML = `
      <div class="map-tooltip-title">
        <span>${category.icon}</span>
        <span>${area.name || 'Sin nombre'}</span>
      </div>
      <div class="map-tooltip-category">${category.name}</div>
    `;
    
    // Agregar equipos si existen
    if (Array.isArray(area.equipos) && area.equipos.length > 0) {
      const equiposPreview = area.equipos.slice(0, 3).join(', ');
      const moreText = area.equipos.length > 3 ? ` (+${area.equipos.length - 3} mas)` : '';
      tooltipHTML += `
        <div class="map-tooltip-equipos">
          <strong>Equipos:</strong>
          ${equiposPreview}${moreText}
        </div>
      `;
    }
    
    // Indicar si est fijado
    const pinnedIndicator = this.state.tooltipPinned && this.state.pinnedAreaId === area.id
      ? '<div style="font-size: 0.7rem; color: #fbbf24; margin-top: 4px;"> Fijado (click para desfijar)</div>'
      : '<div style="font-size: 0.7rem; color: #888; margin-top: 4px;">Click en el nombre para fijar</div>';
    
    // Agregar botones de accion
    tooltipHTML += `
      ${pinnedIndicator}
      <div style="display: flex; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
        <button onclick="mapController.startEditAreaPoints('${area.id}');" style="flex: 1; padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); cursor: pointer; font-size: 0.75rem;">
          E Forma
        </button>
        <button onclick="mapController.openEditAreaMetadataModal('${area.id}');" style="flex: 1; padding: 4px 8px; background: var(--primary); border: none; border-radius: 3px; color: white; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
          C Datos
        </button>
        <button onclick="mapController.deleteArea('${area.id}');" style="padding: 4px 8px; background: #dc2626; border: none; border-radius: 3px; color: white; cursor: pointer; font-size: 0.75rem;">
          X
        </button>
      </div>
    `;
    
    tooltip.innerHTML = tooltipHTML;
    
    //  Agregar/quitar clase 'pinned' segn estado
    if (this.state.tooltipPinned && this.state.pinnedAreaId === area.id) {
      tooltip.classList.add('pinned');
    } else {
      tooltip.classList.remove('pinned');
    }
    
    // Posicionar tooltip cerca del cursor (solo si no est fijado)
    if (!this.state.tooltipPinned) {
      const rect = this.elements.canvasStage.getBoundingClientRect();
      let tooltipX = event.clientX - rect.left + 15;
      let tooltipY = event.clientY - rect.top + 15;
      
      // Ajustar si se sale del canvas
      const tooltipRect = tooltip.getBoundingClientRect();
      if (tooltipX + tooltipRect.width > rect.width) {
        tooltipX = event.clientX - rect.left - tooltipRect.width - 15;
      }
      if (tooltipY + tooltipRect.height > rect.height) {
        tooltipY = event.clientY - rect.top - tooltipRect.height - 15;
      }
      
      tooltip.style.left = `${tooltipX}px`;
      tooltip.style.top = `${tooltipY}px`;
    }
    
    tooltip.classList.remove('hidden');
  },

  // Funcin helper para detectar si un punto est dentro de un polgono
  isPointInPolygon(point, polygon) {
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const xi = polygon[i].x, yi = polygon[i].y;
      const xj = polygon[j].x, yj = polygon[j].y;
      
      const intersect = ((yi > point.y) !== (yj > point.y))
        && (point.x < (xj - xi) * (point.y - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  },

  zoomAt(canvasX, canvasY, factor) {
    const newScale = Math.max(this.state.minScale, Math.min(this.state.maxScale, this.state.scale * factor));
    if (newScale === this.state.scale) return;

    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;

    this.state.scale = newScale;
    this.state.offsetX = canvasX - worldX * newScale;
    this.state.offsetY = canvasY - worldY * newScale;
    this.updateZoomBadge(); //  Actualizar badge de zoom
    this.draw();
    this.queueViewportPersist('zoom');
  },

  handleToolbarAction(action) {
    switch (action) {
      case 'zoom-in':
        this.zoomCentered(1.2);
        break;
      case 'zoom-out':
        this.zoomCentered(1 / 1.2);
        break;
      case 'reset-view':
        this.resetView();
        break;
      case 'toggle-nombres-areas':
        this.toggleNombresAreas();
        break;
      case 'toggle-puntos-repuestos':
        this.togglePuntosRepuestos();
        break;
      case 'toggle-grid':
        this.toggleGrid();
        break;
      case 'toggle-minimap':
        this.toggleMinimap();
        break;
      case 'toggle-rulers':
        this.toggleRulers();
        break;
      case 'toggle-multiselect':
        this.toggleMultiSelect();
        break;
      case 'toggle-reshape':
        this.toggleReshape();
        break;
      case 'recenter':
        this.recenter();
        break;
      default:
        console.debug('Accin de toolbar no implementada:', action);
    }
  },

  zoomCentered(factor) {
    if (!this.state.currentImage) return;
    const canvas = this.elements.canvas;
    const canvasX = canvas.width / 2;
    const canvasY = canvas.height / 2;
    this.zoomAt(canvasX, canvasY, factor);
  },

  resetView() {
    this.state.scale = 1;
    this.state.offsetX = 0;
    this.state.offsetY = 0;
    this.updateZoomBadge(); //  Actualizar badge de zoom
    this.draw();
    this.queueViewportPersist('reset-view');
  },

  recenter() {
    if (!this.state.currentImage) return;
    const canvas = this.elements.canvas;
    const centerX = (this.state.currentImage.width / 2) * this.state.scale;
    const centerY = (this.state.currentImage.height / 2) * this.state.scale;
    this.state.offsetX = canvas.width / 2 - centerX;
    this.state.offsetY = canvas.height / 2 - centerY;
    this.draw();
    this.queueViewportPersist('recenter');
  },

  toggleGrid() {
    this.state.showGrid = !this.state.showGrid;
    this.draw();
    this.showToast(this.state.showGrid ? 'Rejilla activada.' : 'Rejilla desactivada.', 'info');
  },

  toggleNombresAreas() {
    this.state.mostrarNombresAreas = !this.state.mostrarNombresAreas;
    this.draw();
    const btn = document.querySelector('[data-action="toggle-nombres-areas"]');
    if (btn) {
      btn.style.background = this.state.mostrarNombresAreas ? '#3b82f6' : '';
      btn.style.color = this.state.mostrarNombresAreas ? 'white' : '';
    }
    this.showToast(this.state.mostrarNombresAreas ? ' Nombres de reas visibles' : ' Nombres de reas ocultos', 'info');
  },

  togglePuntosRepuestos() {
    this.state.mostrarPuntosRepuestos = !this.state.mostrarPuntosRepuestos;
    this.draw();
    const btn = document.querySelector('[data-action="toggle-puntos-repuestos"]');
    if (btn) {
      //  MEJORA VISUAL: Estilos ms claros para ON/OFF
      if (this.state.mostrarPuntosRepuestos) {
        // Estado ON: Fondo azul brillante
        btn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
        btn.style.color = 'white';
        btn.style.fontWeight = 'bold';
        btn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
        btn.style.transform = 'scale(1.0)';
      } else {
        // Estado OFF: Gris oscuro con borde
        btn.style.background = 'linear-gradient(135deg, #4b5563 0%, #374151 100%)';
        btn.style.color = '#d1d5db';
        btn.style.fontWeight = 'normal';
        btn.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3), inset 0 0 0 2px rgba(239, 68, 68, 0.5)';
        btn.style.transform = 'scale(0.95)';
      }
      btn.style.transition = 'all 0.3s ease';
    }
    this.showToast(
      this.state.mostrarPuntosRepuestos 
        ? ' Todos los puntos visibles' 
        : ' Solo marcador seleccionado', 
      'info'
    );
  },

  //  NUEVA FUNCIN: Sincronizar estado visual de botones con el estado interno
  syncButtonStates() {
    // Botn de puntos
    const btnPuntos = document.querySelector('[data-action="toggle-puntos-repuestos"]');
    if (btnPuntos) {
      if (this.state.mostrarPuntosRepuestos) {
        // Estado ON: Fondo azul brillante
        btnPuntos.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
        btnPuntos.style.color = 'white';
        btnPuntos.style.fontWeight = 'bold';
        btnPuntos.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
        btnPuntos.style.transform = 'scale(1.0)';
      } else {
        // Estado OFF: Gris oscuro con borde rojo
        btnPuntos.style.background = 'linear-gradient(135deg, #4b5563 0%, #374151 100%)';
        btnPuntos.style.color = '#d1d5db';
        btnPuntos.style.fontWeight = 'normal';
        btnPuntos.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3), inset 0 0 0 2px rgba(239, 68, 68, 0.5)';
        btnPuntos.style.transform = 'scale(0.95)';
      }
      btnPuntos.style.transition = 'all 0.3s ease';
    }
    
    // Botn de nombres de reas
    const btnNombres = document.querySelector('[data-action="toggle-nombres-areas"]');
    if (btnNombres) {
      btnNombres.style.background = this.state.mostrarNombresAreas ? '#3b82f6' : '';
      btnNombres.style.color = this.state.mostrarNombresAreas ? 'white' : '';
    }
  },

  toggleMinimap() {
    this.state.showMinimap = !this.state.showMinimap;
    if (this.elements.minimapContainer) {
      if (this.state.showMinimap) {
        this.elements.minimapContainer.classList.remove('hidden');
        this.drawMinimap();
      } else {
        this.elements.minimapContainer.classList.add('hidden');
      }
    }
    this.showToast(this.state.showMinimap ? 'Minimap activado.' : 'Minimap desactivado.', 'info');
  },

  handleMinimapClick(event) {
    if (!this.state.currentImage || !this.elements.minimap) return;

    const minimap = this.elements.minimap;
    const rect = minimap.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const clickY = event.clientY - rect.top;

    // Calcular escala del minimap (igual que en drawMinimap)
    const imgWidth = this.state.currentImage.width;
    const imgHeight = this.state.currentImage.height;
    const scaleX = minimap.width / imgWidth;
    const scaleY = minimap.height / imgHeight;
    const minimapScale = Math.min(scaleX, scaleY) * 0.95;

    const drawWidth = imgWidth * minimapScale;
    const drawHeight = imgHeight * minimapScale;
    const offsetX = (minimap.width - drawWidth) / 2;
    const offsetY = (minimap.height - drawHeight) / 2;

    // Convertir coordenadas de clic a coordenadas del mundo
    const worldX = (clickX - offsetX) / minimapScale;
    const worldY = (clickY - offsetY) / minimapScale;

    // Centrar el viewport en el punto clicado
    const mainCanvas = this.elements.canvas;
    this.state.offsetX = -worldX * this.state.scale + mainCanvas.width / 2;
    this.state.offsetY = -worldY * this.state.scale + mainCanvas.height / 2;

    this.draw();
    this.queueViewportPersist('minimap');
  },

  toggleRulers() {
    this.state.showRulers = !this.state.showRulers;
    this.draw();
    this.showToast(this.state.showRulers ? 'Reglas activadas.' : 'Reglas desactivadas.', 'info');
  },

  //  ETAPA 3.1: Toggle modo seleccin mltiple
  toggleMultiSelect() {
    this.state.isMultiSelectMode = !this.state.isMultiSelectMode;
    
    const btn = document.getElementById('mapMultiSelectBtn');
    if (this.state.isMultiSelectMode) {
      btn.classList.add('map-btn--primary');
      btn.textContent = ' Modo Activo';
      this.showHint('Modo seleccin mltiple: Click en reas para seleccionar/deseleccionar. Ctrl+A para seleccionar todas.');
    } else {
      btn.classList.remove('map-btn--primary');
      btn.textContent = ' Seleccin Mltiple';
      this.state.selectedAreaIds = []; // Limpiar seleccin
      this.updateSelectionBadge();
      this.hideHint();
    }
    
    this.draw();
    this.showToast(this.state.isMultiSelectMode ? ' Modo seleccin mltiple activado' : ' Modo seleccin mltiple desactivado', 'info');
  },

  //  ETAPA 3.1: Actualizar badge de seleccin
  updateSelectionBadge() {
    const badge = document.getElementById('mapSelectionBadge');
    if (!badge) return;
    
    if (this.state.selectedAreaIds.length > 0) {
      badge.textContent = `${this.state.selectedAreaIds.length} seleccionada${this.state.selectedAreaIds.length !== 1 ? 's' : ''}`;
      badge.style.display = 'block';
    } else {
      badge.style.display = 'none';
    }
  },

  //  ETAPA 3.1: Seleccionar/deseleccionar rea
  toggleAreaSelection(areaId) {
    const index = this.state.selectedAreaIds.indexOf(areaId);
    if (index > -1) {
      this.state.selectedAreaIds.splice(index, 1); // Deseleccionar
    } else {
      this.state.selectedAreaIds.push(areaId); // Seleccionar
    }
    this.updateSelectionBadge();
    this.draw();
    console.log(` reas seleccionadas: ${this.state.selectedAreaIds.length}`);
  },

  //  ETAPA 3.1: Seleccionar todas las reas
  selectAllAreas() {
    this.state.selectedAreaIds = this.state.areas.map(area => area.id);
    this.updateSelectionBadge();
    this.draw();
    this.showToast(` ${this.state.selectedAreaIds.length} reas seleccionadas`, 'success');
  },

  //  ETAPA 3.1: Deseleccionar todas las reas
  deselectAllAreas() {
    this.state.selectedAreaIds = [];
    this.updateSelectionBadge();
    this.draw();
    this.showToast(' Seleccin limpiada', 'info');
  },

  //  ETAPA 3.1: Abrir modal de operaciones en lote
  openBatchOperationsModal() {
    if (this.state.selectedAreaIds.length === 0) {
      this.showToast(' No hay reas seleccionadas', 'warning');
      return;
    }

    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) return;

    this.elements.modalTitle.textContent = `Operaciones en lote (${this.state.selectedAreaIds.length} reas)`;

    // Generar opciones de categoras
    const categoryOptions = Object.entries(this.categories).map(([key, cat]) => 
      `<option value="${key}">${cat.icon} ${cat.name}</option>`
    ).join('');

    body.innerHTML = `
      <form id="batchOperationsForm" class="map-area-form">
        <p style="color: var(--text-secondary); margin-bottom: 16px;">
          Aplicar cambios a <strong>${this.state.selectedAreaIds.length}</strong> rea(s) seleccionada(s):
        </p>

        <div class="form-group">
          <label>Cambiar categora</label>
          <select name="batchCategory" id="batchCategory">
            <option value="">No cambiar</option>
            ${categoryOptions}
          </select>
        </div>

        <div class="form-group">
          <label>Cambiar color</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="checkbox" id="batchColorEnable" style="width: auto;">
            <input type="color" name="batchColor" id="batchColor" value="#3b82f6" disabled />
            <span id="batchColorHex" style="font-family: monospace; color: var(--text-secondary);">#3b82f6</span>
          </div>
        </div>

        <div class="form-group">
          <label>Cambiar opacidad</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="checkbox" id="batchOpacityEnable" style="width: auto;">
            <input type="range" name="batchOpacity" id="batchOpacity" min="10" max="90" value="35" disabled />
            <span id="batchOpacityValue" style="min-width: 40px; color: var(--text-secondary);">35%</span>
          </div>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">

        <div class="form-actions">
          <button type="button" class="map-btn map-btn--danger" onclick="mapController.batchDeleteAreas()">
             Eliminar todas
          </button>
          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>
          <button type="submit" class="map-btn map-btn--primary">Aplicar cambios</button>
        </div>
      </form>
    `;

    modal.classList.remove('hidden');

    // Event listeners para habilitar/deshabilitar inputs
    const colorCheckbox = document.getElementById('batchColorEnable');
    const colorInput = document.getElementById('batchColor');
    const colorHex = document.getElementById('batchColorHex');
    
    colorCheckbox.addEventListener('change', () => {
      colorInput.disabled = !colorCheckbox.checked;
    });
    
    colorInput.addEventListener('input', () => {
      colorHex.textContent = colorInput.value;
    });

    const opacityCheckbox = document.getElementById('batchOpacityEnable');
    const opacityInput = document.getElementById('batchOpacity');
    const opacityValue = document.getElementById('batchOpacityValue');
    
    opacityCheckbox.addEventListener('change', () => {
      opacityInput.disabled = !opacityCheckbox.checked;
    });
    
    opacityInput.addEventListener('input', () => {
      opacityValue.textContent = `${opacityInput.value}%`;
    });

    const cancelBtn = body.querySelector('[data-action="cancel"]');
    if (cancelBtn) cancelBtn.addEventListener('click', () => this.closeModal());

    const form = body.querySelector('#batchOperationsForm');
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        this.applyBatchOperations(new FormData(form));
      });
    }
  },

  //  ETAPA 3.1: Aplicar operaciones en lote
  applyBatchOperations(formData) {
    const category = formData.get('batchCategory');
    const colorEnable = document.getElementById('batchColorEnable').checked;
    const color = formData.get('batchColor');
    const opacityEnable = document.getElementById('batchOpacityEnable').checked;
    const opacity = parseInt(formData.get('batchOpacity')) / 100;

    let changesCount = 0;

    this.state.areas.forEach(area => {
      if (this.state.selectedAreaIds.includes(area.id)) {
        if (category) {
          area.category = category;
          changesCount++;
        }
        if (colorEnable) {
          area.color = color;
          changesCount++;
        }
        if (opacityEnable) {
          area.opacity = opacity;
          changesCount++;
        }
      }
    });

    this.saveAreas();
    this.draw();
    this.renderAreasList();
    this.closeModal();
    this.showToast(` Cambios aplicados a ${this.state.selectedAreaIds.length} rea(s)`, 'success');
  },

  //  ETAPA 3.1: Eliminar reas seleccionadas en lote
  batchDeleteAreas() {
    if (!confirm(`Eliminar ${this.state.selectedAreaIds.length} rea(s) seleccionada(s)?\n\nEsta accin no se puede deshacer.`)) {
      return;
    }

    this.state.areas = this.state.areas.filter(area => !this.state.selectedAreaIds.includes(area.id));
    this.state.selectedAreaIds = [];
    
    this.updateSelectionBadge();
    this.saveAreas();
    this.draw();
    this.renderAreasList();
    this.closeModal();
    this.showToast(' reas eliminadas correctamente', 'success');
  },

  //  ETAPA 3.1: Manejar click en modo seleccin mltiple
  handleMultiSelectClick(event) {
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;

    // Buscar rea en el punto clicado
    const clickedArea = this.findAreaAtPoint(worldX, worldY);
    
    if (clickedArea) {
      this.toggleAreaSelection(clickedArea.id);
    }
    
    // Prevenir panning
    event.stopPropagation();
  },

  //  ETAPA 3.1: Encontrar rea en un punto
  findAreaAtPoint(worldX, worldY) {
    // Buscar en orden inverso (las ms recientes primero)
    for (let i = this.state.areas.length - 1; i >= 0; i--) {
      const area = this.state.areas[i];
      if (this.isPointInPolygon({ x: worldX, y: worldY }, area.points)) {
        return area;
      }
    }
    return null;
  },

  //  ETAPA 3.2: Toggle modo reshape (edicin de puntos)
  toggleReshape() {
    this.state.isReshapeMode = !this.state.isReshapeMode;
    
    const btn = document.getElementById('mapReshapeBtn');
    if (this.state.isReshapeMode) {
      // Desactivar otros modos
      if (this.state.isMultiSelectMode) {
        this.toggleMultiSelect();
      }
      if (this.state.drawing) {
        this.cancelDrawing();
      }
      
      btn.classList.add('map-btn--primary');
      btn.innerHTML = ' Modo Activo <span class="info-icon"></span>';
      this.showHint('Modo Edicin: Click en un rea para editar puntos. Arrastra repuestos para reubicarlos. Click en bordes para agregar puntos, selecciona punto + Delete para eliminar.');
    } else {
      btn.classList.remove('map-btn--primary');
      btn.innerHTML = ' Editar Ubicaciones <span class="info-icon"></span>';
      this.exitReshapeMode();
      this.hideHint();
    }
    
    this.draw();
    this.showToast(this.state.isReshapeMode ? ' Modo edicin activado - Puedes mover reas y repuestos' : ' Modo edicin desactivado', 'info');
  },

  //  ETAPA 3.2: Salir del modo reshape
  exitReshapeMode() {
    this.state.reshapeAreaId = null;
    this.state.reshapePoints = [];
    this.state.selectedPointIndex = null;
    this.state.isDraggingPoint = false;
    this.state.hoveredPointIndex = null;
    this.state.hoveredEdgeIndex = null;
  },

  //  ETAPA 3.2: Iniciar edicin de un rea
  startReshapingArea(areaId) {
    const area = this.state.areas.find(a => a.id === areaId);
    if (!area) return;
    
    this.state.reshapeAreaId = areaId;
    this.state.reshapePoints = JSON.parse(JSON.stringify(area.points)); // Copia profunda
    this.draw();
    this.showToast(` Editando rea: ${area.name}`, 'info');
  },

  //  ETAPA 3.2: Guardar cambios del reshape
  saveReshapeChanges() {
    if (!this.state.reshapeAreaId || this.state.reshapePoints.length < 3) {
      this.showToast(' El rea debe tener mnimo 3 puntos', 'warning');
      return;
    }
    
    const area = this.state.areas.find(a => a.id === this.state.reshapeAreaId);
    if (area) {
      area.points = JSON.parse(JSON.stringify(this.state.reshapePoints));
      this.saveAreas();
      this.showToast(' Cambios guardados correctamente', 'success');
    }
    
    this.exitReshapeMode();
    this.draw();
  },

  //  ETAPA 3.2: Cancelar edicin reshape
  cancelReshape() {
    this.exitReshapeMode();
    this.draw();
    this.showToast(' Edicin cancelada', 'info');
  },

  //  ETAPA 3.2: Encontrar punto bajo el cursor
  findPointAtCursor(worldX, worldY, threshold = 10) {
    if (!this.state.reshapeAreaId) return -1;
    
    const screenThreshold = threshold / this.state.scale;
    
    for (let i = 0; i < this.state.reshapePoints.length; i++) {
      const point = this.state.reshapePoints[i];
      const dx = point.x - worldX;
      const dy = point.y - worldY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance < screenThreshold) {
        return i;
      }
    }
    
    return -1;
  },

  //  ETAPA 3.2: Encontrar borde bajo el cursor (para agregar punto)
  findEdgeAtCursor(worldX, worldY, threshold = 15) {
    if (!this.state.reshapeAreaId) return -1;
    
    const screenThreshold = threshold / this.state.scale;
    const points = this.state.reshapePoints;
    
    for (let i = 0; i < points.length; i++) {
      const p1 = points[i];
      const p2 = points[(i + 1) % points.length];
      
      const distance = this.pointToLineDistance(worldX, worldY, p1.x, p1.y, p2.x, p2.y);
      
      if (distance < screenThreshold) {
        return i; // Retorna el ndice del primer punto del borde
      }
    }
    
    return -1;
  },

  //  ETAPA 3.2: Calcular distancia de punto a lnea
  pointToLineDistance(px, py, x1, y1, x2, y2) {
    const A = px - x1;
    const B = py - y1;
    const C = x2 - x1;
    const D = y2 - y1;
    
    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    let param = -1;
    
    if (lenSq !== 0) {
      param = dot / lenSq;
    }
    
    let xx, yy;
    
    if (param < 0) {
      xx = x1;
      yy = y1;
    } else if (param > 1) {
      xx = x2;
      yy = y2;
    } else {
      xx = x1 + param * C;
      yy = y1 + param * D;
    }
    
    const dx = px - xx;
    const dy = py - yy;
    return Math.sqrt(dx * dx + dy * dy);
  },

  //  ETAPA 3.2: Agregar punto en borde
  addPointToEdge(edgeIndex, worldX, worldY) {
    // Insertar el nuevo punto despus del punto en edgeIndex
    this.state.reshapePoints.splice(edgeIndex + 1, 0, { x: worldX, y: worldY });
    this.draw();
    this.showToast(' Punto agregado', 'success');
  },

  //  ETAPA 3.2: Eliminar punto seleccionado
  deleteSelectedPoint() {
    if (this.state.selectedPointIndex === null) return;
    
    if (this.state.reshapePoints.length <= 3) {
      this.showToast(' El rea debe tener mnimo 3 puntos', 'warning');
      return;
    }
    
    this.state.reshapePoints.splice(this.state.selectedPointIndex, 1);
    this.state.selectedPointIndex = null;
    this.draw();
    this.showToast(' Punto eliminado', 'success');
  },

  //  ETAPA 3.2: Manejar click en modo reshape
  handleReshapeClick(event) {
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;
    
    // Si no hay rea seleccionada, seleccionar una
    if (!this.state.reshapeAreaId) {
      const clickedArea = this.findAreaAtPoint(worldX, worldY);
      if (clickedArea) {
        this.startReshapingArea(clickedArea.id);
      }
      return;
    }
    
    // Verificar si se hizo click en un punto
    const pointIndex = this.findPointAtCursor(worldX, worldY);
    if (pointIndex !== -1) {
      this.state.selectedPointIndex = pointIndex;
      this.draw();
      return;
    }
    
    // Verificar si se hizo click en un borde (para agregar punto)
    const edgeIndex = this.findEdgeAtCursor(worldX, worldY);
    if (edgeIndex !== -1) {
      this.addPointToEdge(edgeIndex, worldX, worldY);
      return;
    }
    
    // Click fuera: deseleccionar punto
    this.state.selectedPointIndex = null;
    this.draw();
  },

  //  ETAPA 3.2: Manejar movimiento del mouse en reshape
  handleReshapeMouseMove(event) {
    if (!this.state.reshapeAreaId) return;
    
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const worldX = (canvasX - this.state.offsetX) / this.state.scale;
    const worldY = (canvasY - this.state.offsetY) / this.state.scale;
    
    // Si est arrastrando un punto
    if (this.state.isDraggingPoint && this.state.selectedPointIndex !== null) {
      this.state.reshapePoints[this.state.selectedPointIndex] = { x: worldX, y: worldY };
      this.draw();
      return;
    }
    
    // Actualizar punto/borde bajo el cursor
    const pointIndex = this.findPointAtCursor(worldX, worldY);
    const edgeIndex = pointIndex === -1 ? this.findEdgeAtCursor(worldX, worldY) : -1;
    
    if (this.state.hoveredPointIndex !== pointIndex || this.state.hoveredEdgeIndex !== edgeIndex) {
      this.state.hoveredPointIndex = pointIndex;
      this.state.hoveredEdgeIndex = edgeIndex;
      
      // Cambiar cursor
      const canvas = this.elements.canvas;
      if (pointIndex !== -1) {
        canvas.style.cursor = 'move';
      } else if (edgeIndex !== -1) {
        canvas.style.cursor = 'copy';
      } else {
        canvas.style.cursor = 'default';
      }
      
      this.draw();
    }
  },

  getCanvasCoordinates(event) {
    const canvas = this.elements.canvas;
    const rect = canvas.getBoundingClientRect();
    const cssScaleX = canvas.width / rect.width;
    const cssScaleY = canvas.height / rect.height;
    const canvasX = (event.clientX - rect.left) * cssScaleX;
    const canvasY = (event.clientY - rect.top) * cssScaleY;
    return { canvasX, canvasY };
  },

  getMapPoint(event) {
    const { canvasX, canvasY } = this.getCanvasCoordinates(event);
    const mapX = (canvasX - this.state.offsetX) / this.state.scale;
    const mapY = (canvasY - this.state.offsetY) / this.state.scale;
    return { mapX, mapY, canvasX, canvasY };
  },

  addPoint(event) {
    const { mapX, mapY } = this.getMapPoint(event);
    if (!Number.isFinite(mapX) || !Number.isFinite(mapY)) return;

    if (this.state.tempPoints.length >= 3) {
      const firstPoint = this.state.tempPoints[0];
      const distance = Math.hypot(firstPoint.x - mapX, firstPoint.y - mapY);
      if (distance <= 15) {
        this.finishDrawing();
        return;
      }
    }

    this.state.tempPoints.push({ x: mapX, y: mapY });
    this.draw();
  },

  updatePreviewPoint(event) {
    const { mapX, mapY } = this.getMapPoint(event);
    this.state.previewPoint = { x: mapX, y: mapY };
    this.scheduleRender();
  },

  finishDrawing() {
    if (this.state.tempPoints.length < 3) {
      this.showToast('Necesitas al menos 3 puntos para crear un rea.', 'warning');
      return;
    }

    if (!this.guardMapContract('crear una nueva rea')) {
      return;
    }

    this.openAreaModal();
  },

  toggleDrawingMode() {
    if (this.state.drawing) {
      this.cancelDrawing();
      return;
    }

    if (!this.guardMapContract('dibujar nuevas zonas')) {
      return;
    }

    this.state.drawing = true;
    this.state.tempPoints = [];
    this.state.previewPoint = null;
    this.state.highlightAreaId = null;
    if (this.elements.drawBtn) {
      this.elements.drawBtn.textContent = 'Finalizar rea';
      this.elements.drawBtn.classList.add('map-btn--primary');
    }
    this.showHint('Modo dibujo activo: haz clic para agregar puntos. Doble clic o clic derecho para cerrar.');
    this.elements.canvas.style.cursor = 'crosshair';
  },

  cancelDrawing() {
    this.state.drawing = false;
    this.state.tempPoints = [];
    this.state.previewPoint = null;
    if (this.elements.drawBtn) {
      this.elements.drawBtn.textContent = 'Dibujar zona';
      this.elements.drawBtn.classList.remove('map-btn--primary');
    }
    this.hideHint();
    this.elements.canvas.style.cursor = 'grab';
    this.draw();
  },

  //  MODO AGREGAR MARCADOR CON BSQUEDA
  toggleModoAgregarMarcador() {
    const btn = document.getElementById('mapAddMarkerBtn');
    
    if (this.state.modoAgregarMarcadorActivo) {
      // Desactivar modo
      this.state.modoAgregarMarcadorActivo = false;
      if (btn) {
        btn.textContent = ' Agregar Marcador';
        btn.classList.remove('map-btn--danger');
        btn.classList.add('map-btn--success');
      }
      if (this.elements.canvas) {
        this.elements.canvas.style.cursor = 'grab';
      }
      this.hideHint();
      this.showToast('Modo agregar marcador desactivado', 'info');
      return;
    }

    if (!this.guardMapContract('agregar marcadores')) {
      return;
    }

    // Activar modo
    this.state.modoAgregarMarcadorActivo = true;
    if (btn) {
      btn.textContent = ' Cancelar';
      btn.classList.remove('map-btn--success');
      btn.classList.add('map-btn--danger');
    }
    if (this.elements.canvas) {
      this.elements.canvas.style.cursor = 'crosshair';
    }
    this.showHint('Modo Agregar Marcador: Haz clic dentro de un rea para colocar un marcador');
    this.showToast(' Haz clic en un rea para agregar marcador', 'success');
  },

  //  MODAL DE BSQUEDA DE REPUESTOS
  abrirModalBusquedaRepuesto(x, y, area) {
    const modalHTML = `
      <div id="modalBusquedaRepuesto" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 10000;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      ">
        <!-- Header -->
        <div style="
          padding: 16px 20px;
          border-bottom: 1px solid var(--border-color);
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: var(--bg-secondary);
        ">
          <div>
            <h3 style="margin: 0; color: var(--text-primary); font-size: 1.1rem;">
               Seleccionar Repuesto
            </h3>
            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
              rea: <strong>${area.name}</strong>
            </p>
          </div>
          <button onclick="mapController.cerrarModalBusquedaRepuesto()" style="
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px 8px;
            line-height: 1;
          "></button>
        </div>

        <!-- Buscador -->
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color);">
          <input 
            type="text" 
            id="inputBusquedaRepuesto" 
            placeholder=" Escribe para buscar repuesto..."
            style="
              width: 100%;
              padding: 12px 16px;
              border: 2px solid var(--border-color);
              border-radius: 8px;
              font-size: 1rem;
              background: var(--bg-tertiary);
              color: var(--text-primary);
              transition: border-color 0.2s;
            "
            autocomplete="off"
          />
          
          <!--  Selector de Categora -->
          <div style="margin-top: 12px;">
            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">
               Categora (opcional):
            </label>
            <select 
              id="selectCategoriaMarker" 
              style="
                width: 100%;
                padding: 10px 14px;
                border: 2px solid var(--border-color);
                border-radius: 6px;
                font-size: 0.95rem;
                background: var(--bg-tertiary);
                color: var(--text-primary);
                cursor: pointer;
              "
            >
              <option value="Sin categora">Sin categora</option>
              <option value="Componentes"> Componentes</option>
              <option value="Elctrico"> Elctrico</option>
              <option value="Mecnico"> Mecnico</option>
              <option value="Hidrulico"> Hidrulico</option>
              <option value="Neumtico"> Neumtico</option>
              <option value="Estructura"> Estructura</option>
              <option value="Seguridad"> Seguridad</option>
              <option value="Instrumentacin"> Instrumentacin</option>
              <option value="Otro"> Otro</option>
            </select>
          </div>
          
          <div id="contadorResultados" style="
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
          "></div>
        </div>

        <!-- Lista de resultados -->
        <div id="listaResultadosRepuestos" style="
          flex: 1;
          overflow-y: auto;
          padding: 8px;
        "></div>

        <!-- Footer -->
        <div style="
          padding: 12px 20px;
          border-top: 1px solid var(--border-color);
          background: var(--bg-secondary);
          display: flex;
          justify-content: flex-end;
          gap: 8px;
        ">
          <button onclick="mapController.cerrarModalBusquedaRepuesto()" style="
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.95rem;
          ">
            Cancelar
          </button>
        </div>
      </div>

      <!-- Overlay -->
      <div id="overlayBusquedaRepuesto" onclick="mapController.cerrarModalBusquedaRepuesto()" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
      "></div>
    `;

    // Eliminar modal previo si existe
    this.cerrarModalBusquedaRepuesto();

    // Agregar al DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Guardar contexto
    this.state.modalBusqueda = { x, y, area };

    // Focus en el input y configurar bsqueda
    const input = document.getElementById('inputBusquedaRepuesto');
    if (input) {
      input.focus();
      input.addEventListener('input', (e) => {
        this.filtrarRepuestos(e.target.value);
      });
    }

    // Mostrar todos los repuestos inicialmente
    this.filtrarRepuestos('');
  },

  filtrarRepuestos(termino) {
    const lista = document.getElementById('listaResultadosRepuestos');
    const contador = document.getElementById('contadorResultados');
    if (!lista || !app || !app.repuestos) return;

    const terminoNorm = termino.toLowerCase().trim();
    
    let repuestosFiltrados = app.repuestos;
    if (terminoNorm) {
      repuestosFiltrados = app.repuestos.filter(r => {
        const nombre = (r.nombre || '').toLowerCase();
        const codigo = (r.codigo || '').toLowerCase();
        const area = (r.areaGeneral || r.area || '').toLowerCase();
        const sistema = (r.sistemaEquipo || r.equipo || '').toLowerCase();
        
        return nombre.includes(terminoNorm) || 
               codigo.includes(terminoNorm) ||
               area.includes(terminoNorm) ||
               sistema.includes(terminoNorm);
      });
    }

    // Actualizar contador
    if (contador) {
      contador.textContent = `${repuestosFiltrados.length} repuesto(s) encontrado(s)`;
    }

    // Renderizar lista
    if (repuestosFiltrados.length === 0) {
      lista.innerHTML = `
        <div style="
          padding: 40px 20px;
          text-align: center;
          color: var(--text-muted);
        ">
          <div style="font-size: 3rem; margin-bottom: 12px;"></div>
          <p>No se encontraron repuestos</p>
        </div>
      `;
      return;
    }

    lista.innerHTML = repuestosFiltrados.map(r => `
      <div 
        onclick="mapController.seleccionarRepuestoParaMarcador('${r.id}')"
        style="
          padding: 12px 16px;
          margin-bottom: 8px;
          border: 1px solid var(--border-color);
          border-radius: 8px;
          background: var(--bg-tertiary);
          cursor: pointer;
          transition: all 0.2s;
        "
        onmouseover="this.style.background='var(--bg-hover)'; this.style.borderColor='var(--primary)';"
        onmouseout="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border-color)';"
      >
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
              ${r.nombre || 'Sin nombre'}
            </div>
            <div style="font-size: 0.85rem; color: var(--text-muted);">
              ${r.codigo ? `Cdigo: ${r.codigo}` : ''}
              ${r.areaGeneral ? `  ${r.areaGeneral}` : ''}
              ${r.sistemaEquipo ? `  ${r.sistemaEquipo}` : ''}
            </div>
          </div>
          <div style="
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
          ">
            Seleccionar
          </div>
        </div>
      </div>
    `).join('');
  },

  async seleccionarRepuestoParaMarcador(repuestoId, numeroCorrelativoSeleccionado = null) {
    const repuesto = app.repuestos.find(r => r.id === repuestoId);
    if (!repuesto || !this.state.modalBusqueda) return;

    const { x, y, area } = this.state.modalBusqueda;
    const mapId = this.state.currentMapId;
    
    // 🔢 DETECTAR MÚLTIPLES INSTANCIAS: Si el repuesto tiene cantidadEnUbicacion > 1 en esta área
    const ubicacionEnArea = repuesto.ubicaciones?.find(ub => {
      // Buscar ubicación que coincida con la jerarquía del área del mapa
      return ub.mapId === mapId && ub.areaId === area.id;
    });
    
    const cantidadEnEstaArea = ubicacionEnArea?.cantidadEnUbicacion || 1;
    
    // Si hay múltiples instancias Y NO se ha seleccionado el correlativo aún, mostrar selector
    if (cantidadEnEstaArea > 1 && numeroCorrelativoSeleccionado === null) {
      this.mostrarSelectorCorrelativo(repuestoId, cantidadEnEstaArea);
      return;
    }
    
    //  Obtener categora seleccionada
    const selectCategoria = document.getElementById('selectCategoriaMarker');
    const categoria = selectCategoria ? selectCategoria.value : 'Sin categora';

    console.log('📌 Agregando marcador:', {
      repuesto: repuesto.nombre,
      repuestoId: repuesto.id,
      coordenadas: { x, y },
      area: area.name,
      areaId: area.id,
      mapId: mapId,
      categoria: categoria //  Log de categora
    });

    try {
      // Inicializar array de ubicaciones si no existe
      if (!repuesto.ubicaciones || !Array.isArray(repuesto.ubicaciones)) {
        repuesto.ubicaciones = [];
        console.log('   Inicializando array de ubicaciones');
      }

      console.log(`   Ubicaciones actuales: ${repuesto.ubicaciones.length}`);
      repuesto.ubicaciones.forEach((ub, idx) => {
        console.log(`    [${idx}] mapId: ${ub.mapId}, areaId: ${ub.areaId}, pos: (${ub.markerX}, ${ub.markerY})`);
      });

      //  MEJORADO: Solo verificar duplicados si es en la MISMA POSICIN (no solo misma rea)
      // Permitir mltiples marcadores del mismo repuesto en la misma rea pero en posiciones diferentes
      const TOLERANCE = 5; // Tolerancia de 5 pxeles para considerar "misma posicin"
      const yaExisteEnMismaPosicion = repuesto.ubicaciones.some(ub => {
        const mismoMapa = String(ub.mapId) === String(mapId);
        const mismaArea = String(ub.areaId) === String(area.id);
        const mismaPosicion = Math.abs(ub.markerX - x) < TOLERANCE && Math.abs(ub.markerY - y) < TOLERANCE;
        return mismoMapa && mismaArea && mismaPosicion;
      });

      if (yaExisteEnMismaPosicion) {
        console.log('   Ya existe un marcador en esta posicin exacta');
        this.showToast(' Ya hay un marcador en esta posicin', 'warning');
        this.cerrarModalBusquedaRepuesto();
        return;
      }

      // Agregar nueva ubicacin (ahora permite mltiples marcadores del mismo repuesto en la misma rea)
      console.log('   Agregando nueva ubicacin con correlativo:', numeroCorrelativoSeleccionado);
      repuesto.ubicaciones.push({
        mapId: mapId,
        areaId: area.id,
        areaName: area.name, //  Guardar nombre del rea padre
        markerX: x,
        markerY: y,
        categoria: categoria, //  Categora jerrquica
        numeroCorrelativo: numeroCorrelativoSeleccionado || 1 // 🔢 Correlativo seleccionado
      });
      console.log(`   Total ubicaciones ahora: ${repuesto.ubicaciones.length}`);
      
      // Contar cuntos marcadores de este repuesto hay en esta rea
      const marcadoresEnArea = repuesto.ubicaciones.filter(ub => 
        String(ub.mapId) === String(mapId) && String(ub.areaId) === String(area.id)
      ).length;
      
      if (marcadoresEnArea > 1) {
        this.showToast(` "${repuesto.nombre}" agregado (${marcadoresEnArea} en "${area.name}")`, 'success');
      } else {
        this.showToast(` "${repuesto.nombre}" agregado a "${area.name}"`, 'success');
      }

      // Guardar cambios
      console.log('   Guardando cambios...');
      await app.saveData();
      console.log('    Guardado completado');

      // Cerrar modal y redibujar
      this.cerrarModalBusquedaRepuesto();
      this.draw();

      console.log(` Marcador agregado: ${repuesto.nombre} en (${x}, ${y})`);

    } catch (error) {
      console.error(' Error agregando marcador:', error);
      this.showToast(' Error al agregar marcador', 'error');
    }
  },

  mostrarSelectorCorrelativo(repuestoId, cantidadTotal) {
    const repuesto = app.repuestos.find(r => r.id === repuestoId);
    if (!repuesto) return;

    const modalHTML = `
      <div id="modalSelectorCorrelativo" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-primary);
        border: 2px solid var(--primary);
        border-radius: 12px;
        box-shadow: 0 12px 48px rgba(0,0,0,0.4);
        z-index: 10001;
        width: 90%;
        max-width: 450px;
        padding: 24px;
      ">
        <h3 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 1.2rem;">
          🔢 Seleccionar Instancia
        </h3>
        <p style="margin: 0 0 20px 0; color: var(--text-muted); font-size: 0.95rem;">
          Este repuesto tiene <strong>${cantidadTotal} instancias</strong> en esta ubicación.<br>
          ¿Cuál instancia estás marcando en el mapa?
        </p>
        
        <div style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
          gap: 12px;
          margin-bottom: 20px;
        ">
          ${Array.from({ length: cantidadTotal }, (_, i) => i + 1).map(num => `
            <button 
              onclick="mapController.seleccionarCorrelativo('${repuestoId}', ${num})"
              style="
                padding: 16px 12px;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                background: var(--bg-secondary);
                color: var(--text-primary);
                cursor: pointer;
                font-size: 1.1rem;
                font-weight: 700;
                font-family: monospace;
                transition: all 0.2s;
              "
              onmouseover="this.style.background='var(--primary)'; this.style.color='white'; this.style.borderColor='var(--primary)';"
              onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)'; this.style.borderColor='var(--border-color)';"
            >
              #${num}
            </button>
          `).join('')}
        </div>

        <div style="display: flex; gap: 8px; justify-content: flex-end;">
          <button 
            onclick="mapController.cerrarSelectorCorrelativo()"
            style="
              padding: 10px 20px;
              border: 1px solid var(--border-color);
              border-radius: 6px;
              background: var(--bg-tertiary);
              color: var(--text-primary);
              cursor: pointer;
              font-size: 0.95rem;
            "
          >
            Cancelar
          </button>
        </div>
      </div>

      <div id="overlaySelectorCorrelativo" onclick="mapController.cerrarSelectorCorrelativo()" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 10000;
      "></div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
  },

  seleccionarCorrelativo(repuestoId, numeroCorrelativo) {
    this.cerrarSelectorCorrelativo();
    this.seleccionarRepuestoParaMarcador(repuestoId, numeroCorrelativo);
  },

  cerrarSelectorCorrelativo() {
    const modal = document.getElementById('modalSelectorCorrelativo');
    const overlay = document.getElementById('overlaySelectorCorrelativo');
    if (modal) modal.remove();
    if (overlay) overlay.remove();
  },

  cerrarModalBusquedaRepuesto() {
    const modal = document.getElementById('modalBusquedaRepuesto');
    const overlay = document.getElementById('overlayBusquedaRepuesto');
    
    if (modal) modal.remove();
    if (overlay) overlay.remove();
    
    this.state.modalBusqueda = null;
  },

  openAreaModal() {
    const modal = this.elements.modal;
    const body = this.elements.modalBody;
    if (!modal || !body) return;

    this.elements.modalTitle.textContent = 'Definir nueva rea';

    const jerarquia = this.getJerarquiaOptionCatalog();
    const mapJerarquiaDefaults = this.getCurrentMapJerarquiaDefaults();
    const buildDatalist = (id, values) => {
      if (!Array.isArray(values) || !values.length) return '';
      return `<datalist id="${id}">${values.map(v => `<option value="${this.escapeHtml(v)}"></option>`).join('')}</datalist>`;
    };

    // Construir opciones de categoras con iconos
    const categoryOptions = Object.entries(this.categories).map(([key, cat]) => 
      `<option value="${key}">${cat.icon} ${cat.name}</option>`
    ).join('');

    body.innerHTML = `
      <form id="mapAreaForm" class="map-area-form">
        <div class="form-group">
          <label> Categora</label>
          <select name="category" id="areaCategorySelect" style="font-size: 1rem; padding: 8px;">
            ${categoryOptions}
          </select>
        </div>
        <div class="form-group">
          <label>Nombre del rea</label>
          <input type="text" name="areaName" required placeholder="Ej: Planta Principal" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Color</label>
            <input type="color" name="areaColor" id="areaColorInput" value="#3b82f6" />
          </div>
          <div class="form-group">
            <label>Opacidad</label>
            <input type="range" name="areaOpacity" min="10" max="90" value="35" />
          </div>
        </div>
        
        <!--  NUEVO: Controles para posicionar el nombre en el canvas -->
        <div class="form-group" style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 1.1rem;"></span>
            <span>Posicin del nombre en el mapa</span>
          </label>
          <div class="form-row" style="gap: 12px;">
            <div class="form-group" style="flex: 1;">
              <label style="font-size: 0.85rem; color: var(--text-secondary);">Desplazar horizontalmente (X)</label>
              <input type="number" name="labelOffsetX" value="0" step="10" placeholder="0" 
                     style="text-align: center;" title="Valores positivos mueven a la derecha, negativos a la izquierda" />
              <small style="color: var(--text-muted); font-size: 0.75rem;"> Izq (-)  |  Der (+) </small>
            </div>
            <div class="form-group" style="flex: 1;">
              <label style="font-size: 0.85rem; color: var(--text-secondary);">Desplazar verticalmente (Y)</label>
              <input type="number" name="labelOffsetY" value="0" step="10" placeholder="0" 
                     style="text-align: center;" title="Valores positivos mueven hacia abajo, negativos hacia arriba" />
              <small style="color: var(--text-muted); font-size: 0.75rem;"> Arriba (-)  |  Abajo (+) </small>
            </div>
          </div>
          <small style="display: block; margin-top: 8px; color: var(--text-muted); font-size: 0.8rem;">
             Ajusta estos valores si el nombre se monta sobre otra rea (puedes editarlo despus)
          </small>
        </div>
        
        <div class="form-group">
          <label>Nivel 1  Empresa / Planta</label>
          <input type="text" name="planta" list="plantaList" placeholder="Ej: Aquachile Antarfood" value="${this.escapeHtml(mapJerarquiaDefaults.planta || '')}" />
          ${buildDatalist('plantaList', jerarquia.planta)}
        </div>
        <div class="form-group">
          <label>Nivel 2  rea general</label>
          <input type="text" name="areaGeneral" list="areaGeneralList" placeholder="Ej: Planta Principal" value="${this.escapeHtml(mapJerarquiaDefaults.areaGeneral || '')}" />
          ${buildDatalist('areaGeneralList', jerarquia.areaGeneral)}
        </div>
        <div class="form-group">
          <label>Nivel 3  Sub-rea</label>
          <input type="text" name="subArea" list="subAreaList" placeholder="Ej: Estanques" value="${this.escapeHtml(mapJerarquiaDefaults.subArea || '')}" />
          ${buildDatalist('subAreaList', jerarquia.subArea)}
        </div>
        <div class="form-group">
          <label>Nivel 4  Sistema / Equipo</label>
          <input type="text" name="sistemaEquipo" list="sistemaEquipoList" placeholder="Ej: Grader Baader" value="${this.escapeHtml(mapJerarquiaDefaults.sistemaEquipo || '')}" />
          ${buildDatalist('sistemaEquipoList', jerarquia.sistemaEquipo)}
        </div>
        <div class="form-group">
          <label>Nivel 5  Sub-sistema</label>
          <input type="text" name="subSistema" list="subSistemaList" placeholder="Ej: Cinta Zeta" value="${this.escapeHtml(mapJerarquiaDefaults.subSistema || '')}" />
          ${buildDatalist('subSistemaList', jerarquia.subSistema)}
        </div>
        <div class="form-group">
          <label>Nivel 6  Seccin</label>
          <input type="text" name="seccion" list="seccionList" placeholder="Ej: Mdulo 1" value="${this.escapeHtml(mapJerarquiaDefaults.seccion || '')}" />
          ${buildDatalist('seccionList', jerarquia.seccion)}
        </div>
        <div class="form-group">
          <label>Equipos / mquinas (uno por lnea)</label>
          <textarea name="equipos" rows="4" placeholder="Ej:\nMotor principal\nBanda transportadora"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>
          <button type="submit" class="map-btn map-btn--primary">Guardar rea</button>
        </div>
      </form>
    `;

    modal.classList.remove('hidden');

    const form = body.querySelector('#mapAreaForm');
    const cancelBtn = body.querySelector('[data-action="cancel"]');
    if (cancelBtn) cancelBtn.addEventListener('click', () => {
      this.closeModal();
      this.cancelDrawing();
    });

    // Event listener para cambiar color sugerido al seleccionar categora
    const categorySelect = body.querySelector('#areaCategorySelect');
    const colorInput = body.querySelector('#areaColorInput');
    if (categorySelect && colorInput) {
      categorySelect.addEventListener('change', (e) => {
        const selectedCategory = e.target.value;
        if (this.categories[selectedCategory]) {
          colorInput.value = this.categories[selectedCategory].color;
          console.log(` Color sugerido para categora "${selectedCategory}": ${this.categories[selectedCategory].color}`);
        }
      });
    }

    if (form) {
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        this.saveAreaFromModal(new FormData(form));
      });
    }
  },

  closeModal() {
    const modal = this.elements.modal;
    if (modal) {
      modal.classList.add('hidden');
    }
    this.elements.modalBody.innerHTML = '';
    this.elements.modalTitle.textContent = '';
    this.state.tempJerarquiaAssignment = null;
    this.state.mapFormContext = null;
  },

  async saveAreaFromModal(formData) {
    const name = (formData.get('areaName') || '').toString().trim();
    if (!name) {
      this.showToast('Asigna un nombre a el rea.', 'warning');
      return;
    }

    const color = (formData.get('areaColor') || '#3b82f6').toString();
    const opacityValue = parseInt(formData.get('areaOpacity'), 10);
    const opacity = Number.isFinite(opacityValue) ? opacityValue / 100 : 0.35;
    
    //  NUEVO: Obtener categora seleccionada (por defecto 'area')
    const category = (formData.get('category') || 'area').toString().trim();

    //  NUEVO: Obtener offsets de posicin del nombre
    const labelOffsetX = parseInt(formData.get('labelOffsetX'), 10) || 0;
    const labelOffsetY = parseInt(formData.get('labelOffsetY'), 10) || 0;

    const jerarquia = {};
    const planta = (formData.get('planta') || '').toString().trim();
    const areaGeneral = (formData.get('areaGeneral') || '').toString().trim();
    const subArea = (formData.get('subArea') || '').toString().trim();
    const sistemaEquipo = (formData.get('sistemaEquipo') || '').toString().trim();
    const subSistema = (formData.get('subSistema') || '').toString().trim();
    const seccion = (formData.get('seccion') || '').toString().trim();

    if (planta) jerarquia.planta = planta;
    if (areaGeneral) jerarquia.areaGeneral = areaGeneral;
    if (subArea) jerarquia.subArea = subArea;
    if (sistemaEquipo) jerarquia.sistemaEquipo = sistemaEquipo;
    if (subSistema) jerarquia.subSistema = subSistema;
    if (seccion) jerarquia.seccion = seccion;

    const equiposRaw = (formData.get('equipos') || '').toString();
    const equipos = equiposRaw
      .split(/\r?\n/)
      .map(line => line.trim())
      .filter(Boolean);

    const areaId = Date.now();

    let jerarquiaPath = [];
    if (typeof app?.registerJerarquiaPath === 'function' && Object.keys(jerarquia).length) {
      try {
        jerarquiaPath = app.registerJerarquiaPath(jerarquia, {
          source: 'map-area',
          entityId: areaId,
          meta: {
            mapId: this.state.currentMapId,
            areaName: name
          }
        }) || [];
      } catch (error) {
        console.error(' Error registrando jerarqua del rea:', error);
      }
    }

    const area = {
      id: areaId,
      mapId: this.state.currentMapId,
      name,
      color,
      opacity,
      category, //  NUEVO: Guardar categora
      labelOffsetX, //  NUEVO: Offset horizontal del nombre
      labelOffsetY, //  NUEVO: Offset vertical del nombre
      parentId: null, //  ETAPA 4: ID del rea padre (null = nivel raz)
      children: [], //  ETAPA 4: Array de IDs de reas hijas
      points: [...this.state.tempPoints],
      jerarquia,
      jerarquiaPath,
      equipos,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    try {
      const areas = [...(mapStorage.areas || []), area];
      await mapStorage.saveAreas(areas, { action: 'create', mapId: area.mapId, areaId: area.id, detail: area.name });
      this.state.areas = mapStorage.getAreasByMap(area.mapId);
      this.renderAreaList(this.state.areas);
      this.state.highlightAreaId = area.id;
      this.closeModal();
      this.cancelDrawing();
      this.draw();
      this.showToast('rea guardada correctamente.', 'success');
      this.updateMetaBadge();
    } catch (error) {
      console.error('Error guardando la rea:', error);
      this.showToast('No se pudo guardar el rea. Revisa la consola.', 'error');
    }
  },

  focusArea(areaId) {
    const area = this.state.areas.find(z => z.id == areaId);
    if (!area || !Array.isArray(area.points) || area.points.length < 1) return;

    this.state.highlightAreaId = area.id;

    const xs = area.points.map(p => p.x);
    const ys = area.points.map(p => p.y);
    const minX = Math.min(...xs);
    const maxX = Math.max(...xs);
    const minY = Math.min(...ys);
    const maxY = Math.max(...ys);

    const areaWidth = Math.max(1, maxX - minX);
    const areaHeight = Math.max(1, maxY - minY);
    const canvas = this.elements.canvas;

    const scaleX = (canvas.width * 0.6) / areaWidth;
    const scaleY = (canvas.height * 0.6) / areaHeight;
    const targetScale = Math.min(scaleX, scaleY, this.state.maxScale);

    this.state.scale = Math.max(this.state.minScale, targetScale);
    const centerX = (minX + maxX) / 2;
    const centerY = (minY + maxY) / 2;
    this.state.offsetX = canvas.width / 2 - centerX * this.state.scale;
    this.state.offsetY = canvas.height / 2 - centerY * this.state.scale;

    this.draw();
    this.queueViewportPersist('focus-area');
  },

  updateMetaBadge() {
    const badge = this.elements.metaBadge;
    if (!badge) return;
    if (!this.state.currentMap) {
      badge.textContent = 'Sin mapa';
      return;
    }
    const map = this.state.currentMap;
    const areasCount = this.state.areas.length;
    const dimensions = map.width && map.height ? `${map.width}  ${map.height}px` : 'Dimensiones pendientes';
    const contract = this.getCurrentMapContractState();
    let contractLabel;
    if (contract.allowFreeLevel) {
      contractLabel = 'Modo nivel libre';
    } else if (!contract.hasJerarquia) {
      contractLabel = 'Sin jerarquía asignada';
    } else {
      contractLabel = `Nivel ${this.getMapLevelLabel(contract.mapLevel)}`;
    }
    if (contract.conflicts.length) {
      contractLabel += ' · ⚠ Conflicto';
    }
    badge.textContent = `${map.name} · ${dimensions} · ${areasCount} rea(s) · ${contractLabel}`;
  },

  updateMapJerarquiaBadge() {
    const badge = this.elements?.jerarquiaBadge;
    if (!badge) return;

    const contract = this.getCurrentMapContractState();
    const map = contract.map;
    const applyState = (state) => {
      badge.dataset.state = state;
      badge.dataset.conflict = contract.conflicts.length ? 'true' : 'false';
    };

    if (!map) {
      badge.classList.add('map-jerarquia-badge--empty');
      applyState('idle');
      badge.innerHTML = `
        <div>
          <strong>Sin mapa activo</strong>
          <span class="map-jerarquia-badge__path">Selecciona un mapa para ver su jerarquia.</span>
        </div>
        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Asignar</button>
      `;
      this.renderMapJerarquiaBranch();
      this.renderMapContractSignals(contract);
      return;
    }

    if (contract.allowFreeLevel) {
      badge.classList.remove('map-jerarquia-badge--empty');
       applyState('free');
      badge.innerHTML = `
        <div>
          <strong>Modo nivel libre</strong>
          <span class="map-jerarquia-badge__path">${this.escapeHtml(map.name || 'Mapa sin nombre')} acepta reas sin anclar al rbol corporativo.</span>
        </div>
        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Configurar</button>
      `;
      this.renderMapJerarquiaBranch();
      this.renderMapContractSignals(contract);
      return;
    }

    if (!contract.hasJerarquia) {
      badge.classList.add('map-jerarquia-badge--empty');
      applyState('issue');
      badge.innerHTML = `
        <div>
          <strong>${this.escapeHtml(map.name || 'Mapa sin nombre')}</strong>
          <span class="map-jerarquia-badge__path">Sin jerarquia asignada.</span>
        </div>
        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Asignar</button>
      `;
      this.renderMapJerarquiaBranch();
      this.renderMapContractSignals(contract);
      return;
    }

    const label = this.getJerarquiaPathLabel(contract.path);
    const levelLabel = this.getMapLevelLabel(contract.mapLevel);
    const warningHtml = contract.conflicts.length
      ? `<span style="color: #f97316; font-size: 0.78rem; display: block; margin-top: 4px;">⚠ Este nodo ya est asignado a: ${contract.conflicts.map(item => this.escapeHtml(item.name || `#${item.id}`)).join(', ')}.</span>`
      : '';

    badge.classList.remove('map-jerarquia-badge--empty');
    applyState(contract.conflicts.length ? 'conflict' : 'locked');
    badge.innerHTML = `
      <div>
        <strong>Rama asignada · ${this.escapeHtml(levelLabel)}</strong>
        <span class="map-jerarquia-badge__path">${this.escapeHtml(label)}</span>
        ${warningHtml}
      </div>
        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Editar</button>
    `;
    this.renderMapJerarquiaBranch();
    this.renderMapContractSignals(contract);
  },

  showMapLoadingOverlay(map) {
    const overlay = this.elements.mapLoadingOverlay;
    if (!overlay) return;

    clearTimeout(this.state.mapLoadingHideTimeout);
    this.state.mapLoadingActive = true;
    this.state.mapLoadingProgress = 0;

    const title = map?.name ? `Cargando ${map.name}` : 'Preparando mapa';
    if (this.elements.mapLoadingTitle) {
      this.elements.mapLoadingTitle.textContent = title;
    }
    if (this.elements.mapLoadingStatus) {
      this.elements.mapLoadingStatus.textContent = 'Buscando imagen en la carpeta...';
    }
    if (this.elements.mapLoadingPercent) {
      this.elements.mapLoadingPercent.textContent = '0%';
    }
    if (this.elements.mapLoadingBar) {
      this.elements.mapLoadingBar.style.width = '0%';
    }

    overlay.classList.remove('hidden');
  },

  updateMapLoadingProgress(percent, message = null) {
    if (!this.state.mapLoadingActive) {
      return;
    }
    const overlay = this.elements.mapLoadingOverlay;
    if (!overlay) {
      return;
    }

    const clamped = Math.max(this.state.mapLoadingProgress, Math.min(99, Math.round(percent)));
    this.state.mapLoadingProgress = clamped;

    if (this.elements.mapLoadingBar) {
      this.elements.mapLoadingBar.style.width = `${clamped}%`;
    }
    if (this.elements.mapLoadingPercent) {
      this.elements.mapLoadingPercent.textContent = `${clamped}%`;
    }
    if (message && this.elements.mapLoadingStatus) {
      this.elements.mapLoadingStatus.textContent = message;
    }
  },

  completeMapLoadingProgress(message = 'Mapa listo') {
    if (!this.state.mapLoadingActive) {
      return;
    }

    this.state.mapLoadingProgress = 100;
    if (this.elements.mapLoadingBar) {
      this.elements.mapLoadingBar.style.width = '100%';
    }
    if (this.elements.mapLoadingPercent) {
      this.elements.mapLoadingPercent.textContent = '100%';
    }
    if (this.elements.mapLoadingStatus && message) {
      this.elements.mapLoadingStatus.textContent = message;
    }

    clearTimeout(this.state.mapLoadingHideTimeout);
    this.state.mapLoadingHideTimeout = setTimeout(() => {
      this.hideMapLoadingOverlay();
    }, 450);
  },

  hideMapLoadingOverlay(force = false, message = null) {
    if (!this.elements.mapLoadingOverlay) {
      return;
    }
    if (!this.state.mapLoadingActive && !force) {
      return;
    }

    if (message && this.elements.mapLoadingStatus) {
      this.elements.mapLoadingStatus.textContent = message;
    }

    clearTimeout(this.state.mapLoadingHideTimeout);
    this.state.mapLoadingHideTimeout = null;
    this.state.mapLoadingActive = false;
    this.state.mapLoadingProgress = 0;
    this.elements.mapLoadingOverlay.classList.add('hidden');
    if (this.elements.mapLoadingBar) {
      this.elements.mapLoadingBar.style.width = '0%';
    }
    if (this.elements.mapLoadingPercent) {
      this.elements.mapLoadingPercent.textContent = '0%';
    }
  },

  normalizeMapJerarquiaPath(path = []) {
    if (!Array.isArray(path) || !path.length) {
      return [];
    }

    return path.map((node) => {
      if (!node || !node.id) {
        return null;
      }
      const resolved = this.findJerarquiaNodeInTree(node.id, node.nivel);
      const label = resolved?.nombre || node.nombre || node.id;
      return {
        id: node.id,
        nivel: node.nivel || resolved?.nivel || null,
        label,
        labelLower: (label || '').toString().trim().toLowerCase()
      };
    }).filter(Boolean);
  },

  getAreasMatchingBranch(pathSegments, depth, areasSource = null) {
    if (!Array.isArray(pathSegments) || !pathSegments.length) {
      return Array.isArray(areasSource) ? areasSource : (this.state.areas || []);
    }

    const areasList = Array.isArray(areasSource) ? areasSource : (this.state.areas || []);
    if (!areasList.length) {
      return [];
    }

    const baseIndex = pathSegments[0]?.nivel === 'empresa' ? 1 : 0;
    const targetDepth = typeof depth === 'number' ? depth : pathSegments.length - 1;
    if (targetDepth < baseIndex) {
      return areasList;
    }

    const fieldOrder = this.areaJerarquiaFieldOrder;
    return areasList.filter((area) => {
      const jerarquia = area.jerarquia || {};
      for (let i = baseIndex; i <= targetDepth; i++) {
        const orderIndex = i - baseIndex;
        if (orderIndex < 0) continue;
        const field = fieldOrder[orderIndex];
        if (!field) continue;
        const expected = pathSegments[i]?.labelLower;
        if (!expected) {
          return false;
        }
        const value = (jerarquia[field] || '').toString().trim().toLowerCase();
        if (!value || value !== expected) {
          return false;
        }
      }
      return true;
    });
  },

  countMarkersForAreas(areaList = []) {
    if (!Array.isArray(areaList) || !areaList.length) {
      return 0;
    }

    const areaIds = new Set(areaList.map((area) => String(area.id)));
    if (!areaIds.size) {
      return 0;
    }

    const repuestos = app?.repuestos || [];
    let count = 0;
    repuestos.forEach((repuesto) => {
      if (!Array.isArray(repuesto.ubicaciones)) {
        return;
      }
      repuesto.ubicaciones.forEach((ubicacion) => {
        if (String(ubicacion.mapId) !== String(this.state.currentMapId)) {
          return;
        }
        if (areaIds.has(String(ubicacion.areaId))) {
          count++;
        }
      });
    });
    return count;
  },

  renderMapContractSignals(contract) {
    const container = document.getElementById('mapContractSignals');
    if (!container) return;

    if (!contract || !contract.map) {
      container.innerHTML = '';
      container.classList.add('hidden');
      return;
    }

    const chips = [];
    if (contract.allowFreeLevel) {
      chips.push({
        label: 'Modo nivel libre',
        css: 'map-contract-chip--free',
        hint: 'Este mapa permite reas sin bloquearse a la jerarquía corporativa.'
      });
    } else if (!contract.hasJerarquia) {
      chips.push({
        label: 'Sin jerarquía',
        css: 'map-contract-chip--issue',
        hint: 'Debes asignar una rama antes de dibujar nuevas reas.'
      });
    } else {
      chips.push({
        label: `Nivel ${this.getMapLevelLabel(contract.mapLevel)}`,
        css: 'map-contract-chip--locked',
        hint: this.getJerarquiaPathLabel(contract.path)
      });
    }

    if (!contract.allowFreeLevel && contract.conflicts.length) {
      chips.push({
        label: `Conflicto (${contract.conflicts.length})`,
        css: 'map-contract-chip--conflict',
        hint: `También usan este nivel: ${contract.conflicts.map(item => item.name || `#${item.id}`).join(', ')}`
      });
    }

    if (contract.issues.length) {
      chips.push({
        label: contract.issues[0],
        css: 'map-contract-chip--issue',
        hint: 'Revisa la configuración del mapa para resolverlo.'
      });
    }

    container.innerHTML = chips.map((chip) => `
      <span class="map-contract-chip ${chip.css || ''}" title="${this.escapeHtml(chip.hint || '')}">
        ${this.escapeHtml(chip.label)}
      </span>
    `).join('');
    container.classList.toggle('hidden', chips.length === 0);
  },

  renderMapJerarquiaBranch() {
    const container = this.elements?.jerarquiaBranch;
    if (!container) return;

    const map = this.state.currentMap;
    if (!map) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">Selecciona un mapa para ver su ruta jerarquica.</div>';
      return;
    }

    if (map.allowFreeLevel) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">Este mapa est en modo nivel libre, por lo que no existe una rama corporativa que mostrar.</div>';
      return;
    }

    if (!app || !app.jerarquiaAnidada) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">Configura la jerarqua para habilitar esta vista.</div>';
      return;
    }

    const path = Array.isArray(map.jerarquiaPath) ? map.jerarquiaPath : [];
    if (!path.length) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">Este mapa an no tiene jerarqua asignada.</div>';
      return;
    }

    const normalizedPath = this.normalizeMapJerarquiaPath(path);
    if (!normalizedPath.length) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">No se pudo interpretar la jerarqua asignada.</div>';
      return;
    }

    const activeFilter = this.state.jerarquiaBranchFilter;
    const baseIndex = normalizedPath[0]?.nivel === 'empresa' ? 1 : 0;
    const nodesForRender = normalizedPath
      .map((segment, index) => ({ segment, index }))
      .filter(({ index }) => index >= baseIndex);

    if (!nodesForRender.length) {
      container.innerHTML = '<div class="map-jerarquia-branch-empty">La jerarqua asignada no tiene niveles descendentes configurados.</div>';
      return;
    }

    const nodesHtml = nodesForRender.map(({ segment, index }) => {
      const areasAtLevel = this.getAreasMatchingBranch(normalizedPath, index);
      const markersCount = this.countMarkersForAreas(areasAtLevel);
      const levelLabel = this.jerarquiaLevelConfig[segment.nivel]?.label || `Nivel ${index + 1}`;
      const isActive = activeFilter && activeFilter.mapId === this.state.currentMapId && activeFilter.index === index;
      const stateHint = isActive ? 'Filtro aplicado. Click para limpiar.' : 'Click para filtrar las reas de este nivel.';
      return `
        <div class="map-jerarquia-branch-node ${isActive ? 'is-active' : ''}" data-branch-index="${index}">
          <div class="map-jerarquia-branch-header">
            <span class="map-jerarquia-branch-level">N${index + 1} · ${this.escapeHtml(levelLabel)}</span>
            <span class="map-jerarquia-branch-name">${this.escapeHtml(segment.label)}</span>
          </div>
          <div class="map-jerarquia-branch-stats">
            <span><strong>${areasAtLevel.length}</strong> ${areasAtLevel.length === 1 ? 'rea' : 'reas'}</span>
            <span><strong>${markersCount}</strong> ${markersCount === 1 ? 'marcador' : 'marcadores'}</span>
          </div>
          <div style="font-size: 0.68rem; color: var(--text-muted);">${stateHint}</div>
        </div>
      `;
    }).join('');

    container.innerHTML = nodesHtml;
  },

  getActiveBranchFilterLabel() {
    const filter = this.state.jerarquiaBranchFilter;
    if (!filter || !Array.isArray(filter.pathSnapshot)) {
      return '';
    }
    const node = filter.pathSnapshot[filter.index];
    return node?.label || '';
  },

  toggleJerarquiaBranchFilter(index) {
    const map = this.state.currentMap;
    if (!map) {
      this.showToast('Selecciona un mapa primero.', 'info');
      return;
    }

    const normalizedPath = this.normalizeMapJerarquiaPath(map.jerarquiaPath || []);
    if (!normalizedPath.length) {
      this.showToast('Este mapa an no tiene jerarqua asignada.', 'info');
      return;
    }

    const currentFilter = this.state.jerarquiaBranchFilter;
    if (currentFilter && currentFilter.mapId === this.state.currentMapId && currentFilter.index === index) {
      this.state.jerarquiaBranchFilter = null;
    } else {
      this.state.jerarquiaBranchFilter = {
        mapId: this.state.currentMapId,
        index,
        pathSnapshot: normalizedPath
      };
    }

    this.renderAreaList(this.state.areas);
  },

  clearJerarquiaBranchFilter() {
    if (!this.state.jerarquiaBranchFilter) return;
    this.state.jerarquiaBranchFilter = null;
    this.renderAreaList(this.state.areas);
  },

  applyActiveBranchFilter(areas) {
    const filter = this.state.jerarquiaBranchFilter;
    if (!filter) {
      return areas;
    }

    if (filter.mapId !== this.state.currentMapId) {
      this.state.jerarquiaBranchFilter = null;
      return areas;
    }

    const pathSnapshot = Array.isArray(filter.pathSnapshot)
      ? filter.pathSnapshot
      : this.normalizeMapJerarquiaPath(this.state.currentMap?.jerarquiaPath || []);

    if (!pathSnapshot.length || filter.index >= pathSnapshot.length) {
      this.state.jerarquiaBranchFilter = null;
      return areas;
    }

    return this.getAreasMatchingBranch(pathSnapshot, filter.index, areas);
  },

  updateZoomBadge() {
    const badge = this.elements.zoomBadge;
    if (!badge) return;
    badge.textContent = `${Math.round(this.state.scale * 100)}%`;
  },

  calculateCentroid(points) {
    if (!Array.isArray(points) || points.length === 0) return null;
    const sum = points.reduce((acc, point) => {
      acc.x += point.x;
      acc.y += point.y;
      return acc;
    }, { x: 0, y: 0 });
    return {
      x: sum.x / points.length,
      y: sum.y / points.length
    };
  },

  //  ETAPA 5: Mtodos para vinculacin Repuesto  Mapa
  
  highlightArea(areaId) {
    console.log(' Resaltando rea:', areaId);
    this.state.highlightAreaId = areaId;
    this.draw();
  },

  //  Hacer parpadear un rea para llamar la atencin
  flashArea(areaId, times = 3) {
    console.log(` Haciendo parpadear rea ${areaId} (${times} veces)`);
    let count = 0;
    const interval = setInterval(() => {
      this.state.highlightAreaId = count % 2 === 0 ? areaId : null;
      this.draw();
      count++;
      
      if (count >= times * 2) {
        clearInterval(interval);
        this.state.highlightAreaId = areaId; // Dejar resaltada al final
        this.draw();
      }
    }, 300); // Parpadear cada 300ms
  },

  zoomToArea(areaId) {
    console.log(' Haciendo zoom al rea:', areaId);
    const area = this.state.areas.find(a => String(a.id) === String(areaId));
    
    if (!area || !area.points || area.points.length === 0) {
      console.warn(' rea no encontrada o sin puntos');
      return;
    }

    // Calcular el bounding box del rea
    let minX = Infinity, minY = Infinity;
    let maxX = -Infinity, maxY = -Infinity;

    area.points.forEach(point => {
      if (point.x < minX) minX = point.x;
      if (point.x > maxX) maxX = point.x;
      if (point.y < minY) minY = point.y;
      if (point.y > maxY) maxY = point.y;
    });

    // Calcular el centro del rea
    const centerX = (minX + maxX) / 2;
    const centerY = (minY + maxY) / 2;

    // Calcular el tamao del rea
    const areaWidth = maxX - minX;
    const areaHeight = maxY - minY;

    // Calcular el zoom ptimo (con un margen del 20%)
    const canvas = this.elements.canvas;
    if (!canvas) return;

    const canvasWidth = canvas.width;
    const canvasHeight = canvas.height;

    const scaleX = (canvasWidth * 0.6) / areaWidth;
    const scaleY = (canvasHeight * 0.6) / areaHeight;
    const targetScale = Math.min(scaleX, scaleY, this.state.maxScale);

    // Aplicar zoom y centrado con animacin suave
    this.animateZoomTo(centerX, centerY, targetScale);
  },

  animateZoomTo(targetX, targetY, targetScale, duration = 500) {
    const canvas = this.elements.canvas;
    if (!canvas) return;

    const startScale = this.state.scale;
    const startOffsetX = this.state.offsetX;
    const startOffsetY = this.state.offsetY;

    // Calcular el offset final para centrar el punto
    const finalOffsetX = canvas.width / 2 - targetX * targetScale;
    const finalOffsetY = canvas.height / 2 - targetY * targetScale;

    const startTime = performance.now();

    const animate = (currentTime) => {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // Easing function (ease-in-out)
      const eased = progress < 0.5
        ? 2 * progress * progress
        : 1 - Math.pow(-2 * progress + 2, 2) / 2;

      // Interpolar valores
      this.state.scale = startScale + (targetScale - startScale) * eased;
      this.state.offsetX = startOffsetX + (finalOffsetX - startOffsetX) * eased;
      this.state.offsetY = startOffsetY + (finalOffsetY - startOffsetY) * eased;

      this.draw();
      this.updateZoomBadge();

      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        this.queueViewportPersist('animate-zoom');
      }
    };

    requestAnimationFrame(animate);
  },

  pulseArea(areaId, pulses = 3) {
    console.log(' Animando pulsacin del rea:', areaId);
    let count = 0;
    const interval = setInterval(() => {
      this.state.highlightAreaId = count % 2 === 0 ? areaId : null;
      this.draw();
      count++;
      
      if (count >= pulses * 2) {
        clearInterval(interval);
        this.state.highlightAreaId = areaId; // Dejar resaltada al final
        this.draw();
      }
    }, 300);
  },

  async loadMap(mapId) {
    console.log(' Cargando mapa:', mapId);
    await this.selectMap(mapId);
  },

  async loadMapImageFromStorage(imagePath) {
    try {
      if (!this.state.mapLoadingActive) {
        this.showMapLoadingOverlay(this.state.currentMap);
      }
      this.updateMapLoadingProgress(15, 'Leyendo imagen desde la carpeta...');
      const blob = await fsManager.readFile(imagePath);
      if (!blob) {
        console.warn(' No se pudo cargar la imagen del mapa');
        this.hideMapLoadingOverlay(true, 'No se encontr el archivo de imagen.');
        return;
      }

      const url = URL.createObjectURL(blob);
      const img = new Image();
      
      img.onload = () => {
        this.updateMapLoadingProgress(85, 'Aplicando mapa al lienzo...');
        this.state.currentImage = img;
        this.state.currentImageUrl = url;
        this.configureCanvasForImage(img, { keepViewport: false }); //  FIX: Configurar canvas con imagen escalada
        this.draw();
        this.completeMapLoadingProgress();
        URL.revokeObjectURL(url);
      };

      img.onerror = () => {
        console.error(' Error cargando imagen del mapa');
        URL.revokeObjectURL(url);
        this.hideMapLoadingOverlay(true, 'Error cargando la imagen del mapa.');
      };

      img.src = url;
    } catch (error) {
      console.error(' Error leyendo imagen:', error);
      this.hideMapLoadingOverlay(true, 'Error leyendo la imagen.');
    }
  },

  loadAreasForMap(mapId) {
    const allAreas = mapStorage.areas || [];
    this.state.areas = allAreas.filter(area => String(area.mapId) === String(mapId));
    this.renderAreaList(this.state.areas);
    console.log(` ${this.state.areas.length} reas cargadas para el mapa`);
  },

  //  NUEVO: Activar modo para colocar marcador de repuesto
  activarModoMarcador(repuestoId, mapId, areaId, modoEdicion = false) {
    this.state.modoMarcador = true;
    this.state.marcadorPendiente = {
      repuestoId,
      mapId,
      areaId
    };
    
    // Cambiar cursor
    if (this.elements.canvas) {
      this.elements.canvas.style.cursor = 'crosshair';
    }
    
    // Mostrar instruccin segn modo
    const mensaje = modoEdicion 
      ? ' Haz clic en el rea para cambiar la posicin del marcador'
      : ' Haz clic en el rea resaltada para colocar el marcador';
    
    this.showToast(mensaje, 'info', 5000);
    
    console.log(` Modo marcador activado para repuesto: ${repuestoId} (edicin: ${modoEdicion})`);
  },

  //  NUEVO: Colocar marcador en el mapa
  async colocarMarcador(x, y) {
    if (!this.state.modoMarcador || !this.state.marcadorPendiente) return;
    
    const { repuestoId, mapId, areaId } = this.state.marcadorPendiente;
    
    console.log(' Colocando marcador en:', { x, y });
    console.log('   rea objetivo:', areaId);
    console.log('   reas disponibles:', this.state.areas.length);
    
    //  NUEVA LGICA: Buscar reas cercanas al click (radio aumentado a 300px)
    const areasEncontradas = this.buscarAreasCercanas(x, y, 300);
    
    console.log(' reas encontradas cerca del click:', areasEncontradas);
    
    // Si no hay reas cercanas, buscar especficamente el rea asignada
    if (areasEncontradas.length === 0) {
      const areaAsignada = this.state.areas.find(a => String(a.id) === String(areaId));
      console.log('   Buscando rea asignada:', areaAsignada?.name);
      
      if (areaAsignada) {
        // Calcular distancia al rea asignada
        const distancia = this.distanciaPuntoAArea(x, y, areaAsignada);
        console.log('   Distancia al rea asignada:', distancia, 'px');
        
        // Si est dentro o relativamente cerca (hasta 500px), aceptarlo
        if (distancia <= 500) {
          areasEncontradas.push({ area: areaAsignada, distancia, dentro: this.puntoEnArea(x, y, areaAsignada) });
          console.log('    rea asignada incluida (distancia aceptable)');
        }
      }
    }
    
    // Si TODAVA no hay reas, mostrar error con ms info
    if (areasEncontradas.length === 0) {
      const areaAsignada = this.state.areas.find(a => String(a.id) === String(areaId));
      const distancia = areaAsignada ? Math.round(this.distanciaPuntoAArea(x, y, areaAsignada)) : 'N/A';
      this.showToast(` Click muy lejos del rea "${areaAsignada?.name || 'desconocida'}" (${distancia}px). Haz zoom y acrcate ms al rea resaltada.`, 'warning', 5000);
      return;
    }
    
    // Si hay exactamente 1 rea, usarla directamente
    if (areasEncontradas.length === 1) {
      await this.confirmarMarcador(x, y, areasEncontradas[0].area, repuestoId, mapId);
      return;
    }
    
    // Si hay mltiples reas, mostrar men de seleccin
    this.mostrarMenuSeleccionArea(x, y, areasEncontradas, repuestoId, mapId);
  },

  //  NUEVO: Buscar reas cercanas a un punto
  buscarAreasCercanas(x, y, radio = 100) {
    const areasEncontradas = [];
    
    for (const area of this.state.areas) {
      if (!area.points || area.points.length < 3) continue;
      
      // 1. Verificar si est dentro del rea (prioridad mxima)
      if (this.puntoEnArea(x, y, area)) {
        areasEncontradas.push({ area, distancia: 0, dentro: true });
        continue;
      }
      
      // 2. Calcular distancia al borde del rea
      const distancia = this.distanciaPuntoAArea(x, y, area);
      
      if (distancia <= radio) {
        areasEncontradas.push({ area, distancia, dentro: false });
      }
    }
    
    // Ordenar por distancia (primero las que contienen el punto, luego por cercana)
    areasEncontradas.sort((a, b) => {
      if (a.dentro && !b.dentro) return -1;
      if (!a.dentro && b.dentro) return 1;
      return a.distancia - b.distancia;
    });
    
    return areasEncontradas;
  },

  //  NUEVO: Calcular distancia de un punto al borde de un rea
  distanciaPuntoAArea(x, y, area) {
    let distanciaMin = Infinity;
    
    for (let i = 0; i < area.points.length; i++) {
      const p1 = area.points[i];
      const p2 = area.points[(i + 1) % area.points.length];
      
      const distancia = this.distanciaPuntoASegmento(x, y, p1.x, p1.y, p2.x, p2.y);
      distanciaMin = Math.min(distanciaMin, distancia);
    }
    
    return distanciaMin;
  },

  //  NUEVO: Calcular distancia de un punto a un segmento de lnea
  distanciaPuntoASegmento(px, py, x1, y1, x2, y2) {
    const A = px - x1;
    const B = py - y1;
    const C = x2 - x1;
    const D = y2 - y1;

    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    let param = -1;

    if (lenSq !== 0) param = dot / lenSq;

    let xx, yy;

    if (param < 0) {
      xx = x1;
      yy = y1;
    } else if (param > 1) {
      xx = x2;
      yy = y2;
    } else {
      xx = x1 + param * C;
      yy = y1 + param * D;
    }

    const dx = px - xx;
    const dy = py - yy;
    return Math.sqrt(dx * dx + dy * dy);
  },

  //  NUEVO: Mostrar men contextual para seleccionar rea
  mostrarMenuSeleccionArea(x, y, areasEncontradas, repuestoId, mapId) {
    // Eliminar men previo si existe
    const menuPrevio = document.getElementById('areaSelectionMenu');
    if (menuPrevio) menuPrevio.remove();
    
    // Convertir coordenadas del mapa a coordenadas de pantalla
    const canvas = this.elements.canvas;
    const rect = canvas.getBoundingClientRect();
    const screenX = x * this.state.scale + this.state.offsetX + rect.left;
    const screenY = y * this.state.scale + this.state.offsetY + rect.top;
    
    // Crear men
    const menu = document.createElement('div');
    menu.id = 'areaSelectionMenu';
    menu.style.cssText = `
      position: fixed;
      left: ${screenX}px;
      top: ${screenY}px;
      background: rgba(15, 23, 42, 0.98);
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 10000;
      min-width: 250px;
      max-width: 350px;
      animation: fadeInScale 0.2s ease-out;
    `;
    
    // Ttulo
    const titulo = document.createElement('div');
    titulo.textContent = ' Selecciona el rea';
    titulo.style.cssText = `
      color: #60a5fa;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 14px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.3);
      padding-bottom: 8px;
    `;
    menu.appendChild(titulo);
    
    // Lista de reas
    areasEncontradas.forEach(({ area, distancia, dentro }) => {
      const boton = document.createElement('button');
      const icono = dentro ? '' : '';
      const distanciaTexto = dentro ? 'Click dentro' : `${Math.round(distancia)}px`;
      
      boton.textContent = `${icono} ${area.name}`;
      boton.style.cssText = `
        display: block;
        width: 100%;
        padding: 10px 12px;
        margin: 4px 0;
        background: ${dentro ? 'rgba(16, 185, 129, 0.2)' : 'rgba(59, 130, 246, 0.1)'};
        border: 1px solid ${dentro ? '#10b981' : '#3b82f6'};
        border-radius: 8px;
        color: ${dentro ? '#10b981' : '#60a5fa'};
        cursor: pointer;
        text-align: left;
        font-size: 13px;
        transition: all 0.2s;
        position: relative;
      `;
      
      // Badge de distancia
      const badge = document.createElement('span');
      badge.textContent = distanciaTexto;
      badge.style.cssText = `
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 11px;
        opacity: 0.7;
      `;
      boton.appendChild(badge);
      
      boton.onmouseover = () => {
        boton.style.background = dentro ? 'rgba(16, 185, 129, 0.3)' : 'rgba(59, 130, 246, 0.2)';
        boton.style.transform = 'translateX(4px)';
      };
      boton.onmouseout = () => {
        boton.style.background = dentro ? 'rgba(16, 185, 129, 0.2)' : 'rgba(59, 130, 246, 0.1)';
        boton.style.transform = 'translateX(0)';
      };
      
      boton.onclick = async () => {
        menu.remove();
        await this.confirmarMarcador(x, y, area, repuestoId, mapId);
      };
      
      menu.appendChild(boton);
    });
    
    // Botn cancelar
    const btnCancelar = document.createElement('button');
    btnCancelar.textContent = ' Cancelar';
    btnCancelar.style.cssText = `
      display: block;
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      border-radius: 8px;
      color: #f87171;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    `;
    btnCancelar.onmouseover = () => {
      btnCancelar.style.background = 'rgba(239, 68, 68, 0.2)';
    };
    btnCancelar.onmouseout = () => {
      btnCancelar.style.background = 'rgba(239, 68, 68, 0.1)';
    };
    btnCancelar.onclick = () => menu.remove();
    menu.appendChild(btnCancelar);
    
    document.body.appendChild(menu);
    
    // Cerrar al hacer click fuera
    setTimeout(() => {
      const cerrarMenu = (e) => {
        if (!menu.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', cerrarMenu);
        }
      };
      document.addEventListener('click', cerrarMenu);
    }, 100);
  },

  //  NUEVO: Confirmar y guardar marcador en rea seleccionada
  async confirmarMarcador(x, y, area, repuestoId, mapId) {
    console.log(' rea seleccionada:', area.name);
    console.log(' Coordenadas del marcador:', { x, y });
    
    try {
      const repuesto = app.repuestos.find(r => String(r.id) === String(repuestoId));
      if (!repuesto) {
        this.showToast(' Repuesto no encontrado', 'error');
        return;
      }
      
      //  MODO EDICIN: Actualizar ubicacin existente
      if (window._editandoUbicacion && window._editandoUbicacion.modoEdicion) {
        const { indice } = window._editandoUbicacion;
        
        // Asegurar que existe el array de ubicaciones
        if (!repuesto.ubicaciones || !Array.isArray(repuesto.ubicaciones)) {
          repuesto.ubicaciones = [];
        }
        
        // Si estamos editando pero el array est vaco (migracin de formato antiguo)
        if (repuesto.ubicaciones.length === 0 && repuesto.mapId && repuesto.areaId) {
          repuesto.ubicaciones = [{
            mapId: repuesto.mapId,
            areaId: repuesto.areaId,
            markerX: repuesto.markerX,
            markerY: repuesto.markerY
          }];
          delete repuesto.mapId;
          delete repuesto.areaId;
          delete repuesto.markerX;
          delete repuesto.markerY;
        }
        
        // Actualizar ubicacin especfica
        if (repuesto.ubicaciones[indice]) {
          repuesto.ubicaciones[indice].mapId = mapId;
          repuesto.ubicaciones[indice].areaId = area.id;
          repuesto.ubicaciones[indice].markerX = x;
          repuesto.ubicaciones[indice].markerY = y;
          
          console.log(' Ubicacin actualizada en ndice:', indice);
          this.showToast(` Ubicacin de "${repuesto.nombre}" actualizada en "${area.name}"`, 'success');
        }
        
        // Limpiar modo edicin
        delete window._editandoUbicacion;
      } 
      //  MODO AGREGAR: Crear nueva ubicacin
      else {
        // Inicializar array de ubicaciones si no existe
        if (!repuesto.ubicaciones || !Array.isArray(repuesto.ubicaciones)) {
          repuesto.ubicaciones = [];
        }
        
        // Si hay datos en formato antiguo, migrarlos primero
        if (repuesto.mapId && repuesto.areaId && repuesto.ubicaciones.length === 0) {
          repuesto.ubicaciones.push({
            mapId: repuesto.mapId,
            areaId: repuesto.areaId,
            markerX: repuesto.markerX,
            markerY: repuesto.markerY
          });
          delete repuesto.mapId;
          delete repuesto.areaId;
          delete repuesto.markerX;
          delete repuesto.markerY;
        }
        
        //  VERIFICAR SI YA EXISTE una ubicacin en este mapa/rea (prevenir duplicados)
        const yaExiste = repuesto.ubicaciones.some(ub => 
          String(ub.mapId) === String(mapId) && String(ub.areaId) === String(area.id)
        );
        
        if (yaExiste) {
          console.warn(' Ya existe una ubicacin en este mapa/rea. Actualizando posicin...');
          // Actualizar la existente en lugar de agregar duplicado
          const ubicacionExistente = repuesto.ubicaciones.find(ub =>
            String(ub.mapId) === String(mapId) && String(ub.areaId) === String(area.id)
          );
          if (ubicacionExistente) {
            ubicacionExistente.markerX = x;
            ubicacionExistente.markerY = y;
            this.showToast(` Ubicacin actualizada en "${area.name}"`, 'success');
          }
        } else {
          // Agregar nueva ubicacin (sin duplicado)
          repuesto.ubicaciones.push({
            mapId: mapId,
            areaId: area.id,
            markerX: x,
            markerY: y
          });
          
          console.log(' Nueva ubicacin agregada. Total ubicaciones:', repuesto.ubicaciones.length);
          this.showToast(` "${repuesto.nombre}" ubicado en "${area.name}"`, 'success');
        }
      }
      
      // Guardar cambios
      await app.saveData();
      
      // Desactivar modo marcador
      this.state.modoMarcador = false;
      this.state.marcadorPendiente = null;
      
      if (this.elements.canvas) {
        this.elements.canvas.style.cursor = 'grab';
      }
      
      // Redibujar con el nuevo marcador
      this.draw();
      
      console.log(' Marcador guardado exitosamente');
    } catch (error) {
      console.error(' Error guardando marcador:', error);
      this.showToast(' Error al guardar la ubicacin', 'error');
    }
  },

  //  NUEVO: Verificar si un punto est dentro de un rea
  puntoEnArea(x, y, area) {
    if (!area || !area.points || area.points.length < 3) return false;
    
    // Algoritmo Ray Casting para determinar si el punto est dentro del polgono
    let inside = false;
    for (let i = 0, j = area.points.length - 1; i < area.points.length; j = i++) {
      const xi = area.points[i].x, yi = area.points[i].y;
      const xj = area.points[j].x, yj = area.points[j].y;
      
      const intersect = ((yi > y) !== (yj > y)) && 
                        (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    
    return inside;
  },

  //  NUEVO: Mostrar marcador en el canvas
  showMarker(x, y, label) {
    // Esta funcin se llamar desde el draw() para mostrar el marcador
    this.state.currentMarker = { x, y, label };
    this.draw();
  },

  //  NUEVA FUNCIN: Mostrar mltiples ubicaciones en el mapa
  async mostrarMultiplesUbicaciones(ubicaciones, repuesto) {
    if (!ubicaciones || ubicaciones.length === 0) return;
    
    console.log(` Mostrando ${ubicaciones.length} ubicaciones de "${repuesto.nombre}"`);
    
    // Agrupar ubicaciones por mapa
    const ubicacionesPorMapa = {};
    ubicaciones.forEach(ub => {
      if (!ubicacionesPorMapa[ub.mapId]) {
        ubicacionesPorMapa[ub.mapId] = [];
      }
      ubicacionesPorMapa[ub.mapId].push(ub);
    });
    
    // Si hay ubicaciones en mltiples mapas, preguntar cul mostrar
    const mapIds = Object.keys(ubicacionesPorMapa);
    
    if (mapIds.length > 1) {
      // Mostrar modal de seleccin de mapa
      let mapaSeleccionado = null;
      
      const mapasHTML = mapIds.map(mapId => {
        const mapa = mapStorage.maps.find(m => m.id === parseInt(mapId));
        const count = ubicacionesPorMapa[mapId].length;
        return `<option value="${mapId}">${mapa ? mapa.name : 'Mapa desconocido'} (${count} ubicaciones)</option>`;
      }).join('');
      
      // Usar el primer mapa por defecto
      mapaSeleccionado = parseInt(mapIds[0]);
    } else {
      mapaSeleccionado = parseInt(mapIds[0]);
    }
    
    // Cargar el mapa seleccionado
    await this.loadMap(mapaSeleccionado);
    
    const ubicacionesEnMapa = ubicacionesPorMapa[mapaSeleccionado];
    
    // Esperar a que se cargue el mapa
    setTimeout(() => {
      //  MEJORADO: Calcular zoom proporcional segn nmero de ubicaciones
      if (ubicacionesEnMapa.length > 0) {
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        
        ubicacionesEnMapa.forEach(ub => {
          if (ub.markerX && ub.markerY) {
            minX = Math.min(minX, ub.markerX);
            minY = Math.min(minY, ub.markerY);
            maxX = Math.max(maxX, ub.markerX);
            maxY = Math.max(maxY, ub.markerY);
          }
        });
        
        if (minX === Infinity) return;
        
        const canvas = this.elements.canvas;
        const centerX = (minX + maxX) / 2;
        const centerY = (minY + maxY) / 2;
        const width = maxX - minX;
        const height = maxY - minY;
        
        let targetScale, padding;
        
        //  ZOOM PROPORCIONAL segn cantidad de ubicaciones
        if (ubicacionesEnMapa.length === 1) {
          // UNA ubicacin: Zoom ms cercano (mostrar rea con detalle)
          if (ubicacionesEnMapa[0].areaId) {
            // Guardar ubicaciones resaltadas ANTES de hacer zoom
            this.state.ubicacionesResaltadas = ubicacionesEnMapa.map(ub => ({
              x: ub.markerX,
              y: ub.markerY,
              repuesto: repuesto.nombre,
              descripcion: ub.descripcion
            }));
            
            this.zoomToArea(ubicacionesEnMapa[0].areaId);
            
            // Redibujar para mostrar marcadores resaltados
            setTimeout(() => {
              this.draw();
            }, 100);
            
            return; // zoomToArea ya maneja el zoom
          } else {
            // Si no hay rea, zoom fijo cercano
            targetScale = 1.5;
            this.state.scale = targetScale;
            this.state.offsetX = canvas.width / 2 - centerX * targetScale;
            this.state.offsetY = canvas.height / 2 - centerY * targetScale;
          }
        } else if (ubicacionesEnMapa.length === 2) {
          // DOS ubicaciones: Zoom moderado co