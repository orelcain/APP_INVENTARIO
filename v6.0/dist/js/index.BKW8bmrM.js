var e=Object.defineProperty,t=(t,a,n)=>((t,a,n)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[a]=n)(t,"symbol"!=typeof a?a+"":a,n);!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const a={version:"1.0-mobile",lastUpdate:(new Date).toISOString(),platform:"mobile-embedded",note:"Datos sin multimedia - Solo texto y nmeros para mxima compatibilidad",repuestos:[]};const n=new class{constructor(){this.directoryHandle=null,this.imagesFolder=null,this.isFileSystemMode=!1,this.folderPath="",this.dbName="InventarioFS",this.dbVersion=1}get storageHandle(){return this.directoryHandle}get isConnected(){return this.isFileSystemMode&&!!this.directoryHandle}async saveDirectoryHandle(e){return new Promise((t,a)=>{const n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>a(n.error),n.onsuccess=()=>{const i=n.result.transaction(["directories"],"readwrite");i.objectStore("directories").put({id:"main",handle:e,timestamp:Date.now()}),i.oncomplete=()=>t(!0),i.onerror=()=>a(i.error)},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("directories")||t.createObjectStore("directories",{keyPath:"id"})}})}async loadDirectoryHandle(){return new Promise((e,t)=>{const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=()=>t(a.error),a.onsuccess=()=>{const n=a.result.transaction(["directories"],"readonly").objectStore("directories").get("main");n.onsuccess=()=>{var t;e((null==(t=n.result)?void 0:t.handle)||null)},n.onerror=()=>t(n.error)},a.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("directories")||t.createObjectStore("directories",{keyPath:"id"})}})}async restoreFromPreviousSession(){var e;try{const t=await this.loadDirectoryHandle();if(!t)return!1;const a=await t.queryPermission({mode:"readwrite"});if("granted"===a)return this.directoryHandle=t,await this.ensureImageFolder(),this.folderPath=this.directoryHandle.name,this.isFileSystemMode=!0,this.updateStatusIndicator(!0,this.folderPath),!0;if("prompt"===a){if(!Boolean(null==(e=navigator.userActivation)?void 0:e.isActive))return void 0!==c&&"function"==typeof c.showToast&&c.showToast('Debes usar "Conectar Carpeta" para reactivar los permisos.',"warning"),this.updateStatusIndicator(!1),!1;if("granted"===await t.requestPermission({mode:"readwrite"}))return this.directoryHandle=t,await this.ensureImageFolder(),this.folderPath=this.directoryHandle.name,this.isFileSystemMode=!0,this.updateStatusIndicator(!0,this.folderPath),!0}return!1}catch(t){return!1}}updateStatusIndicator(e,t=""){const a=document.getElementById("connectionBtn"),n=document.getElementById("connectionIcon");a&&n&&(e?(a.style.background="linear-gradient(145deg, #10b981, #059669)",a.style.color="white",a.title=t?` Conectado: ${t}`:" Conectado",n.textContent=""):(a.style.background="linear-gradient(145deg, #ef4444, #dc2626)",a.style.color="white",a.title=" No conectado",n.textContent=""))}async selectFolder(){try{const t=await window.showDirectoryPicker({mode:"readwrite"});let a=t,n=t.name;if("INVENTARIO_PORTABLE"===t.name)try{const e=await t.getDirectoryHandle("INVENTARIO_STORAGE",{create:!1});a=e,n=`${t.name}/${e.name}`}catch(e){const i=await t.getDirectoryHandle("INVENTARIO_STORAGE",{create:!0});a=i,n=`${t.name}/${i.name}`}else if("INVENTARIO_STORAGE"===t.name);else try{const e=await t.getDirectoryHandle("INVENTARIO_STORAGE",{create:!1});a=e,n=`${t.name}/${e.name}`}catch(e){}return this.directoryHandle=a,await this.ensureImageFolder(),await this.saveDirectoryHandle(this.directoryHandle),localStorage.setItem("fsDirectory","enabled"),this.folderPath=n,localStorage.setItem("fsFolderName",this.folderPath),this.isFileSystemMode=!0,this.updateStatusIndicator(!0,n),!0}catch(t){return this.updateStatusIndicator(!1),!1}}async ensureImageFolder(){try{this.imagesFolder=await this.directoryHandle.getDirectoryHandle("imagenes",{create:!0});let e=0;for await(const t of this.imagesFolder.values())e++}catch(e){this.imagesFolder=null}}async saveJSON(e){if(!this.isFileSystemMode)return!1;try{const t=await this.directoryHandle.getFileHandle("inventario.json",{create:!0}),a=await t.createWritable();return await a.write(JSON.stringify(e,null,2)),await a.close(),!0}catch(t){return!1}}async saveImage(e,t){if(!this.isFileSystemMode)return null;try{const a=await this.imagesFolder.getFileHandle(t,{create:!0}),n=await a.createWritable();return await n.write(e),await n.close(),"./imagenes/"+t}catch(a){return null}}async saveImageJerarquica(e,t,a){if(!this.isFileSystemMode)return null;try{const n=await a.getFileHandle(t,{create:!0}),i=await n.createWritable();return await i.write(e),await i.close(),t}catch(n){return null}}async readFile(e){if(!this.isFileSystemMode)return null;try{const t=Array.isArray(e)?e:String(e||"").split("/").filter(Boolean);if(!t.length)return null;let a=this.directoryHandle;for(let e=0;e<t.length-1;e++){const n=t[e];a=await a.getDirectoryHandle(n,{create:!1})}const n=t[t.length-1],i=await a.getFileHandle(n,{create:!1});return await i.getFile()}catch(t){return null}}async deleteImage(e){if(!this.isFileSystemMode)return!1;try{const t=e.replace("./imagenes/","").replace("imagenes/","");return!!t&&(await this.imagesFolder.removeEntry(t),!0)}catch(t){return"NotFoundError"===t.name}}async deleteMultipleImages(e){if(!this.isFileSystemMode)return{deleted:0,failed:0};let t=0,a=0;for(const n of e){await this.deleteImage(n)?t++:a++}return{deleted:t,failed:a}}async getAllImagesInFolder(){if(!this.isFileSystemMode)return[];try{const e=[];for await(const t of this.imagesFolder.values())"file"===t.kind&&e.push(t.name);return e}catch(e){return[]}}async cleanOrphanImages(e){if(!this.isFileSystemMode)return{orphans:0,deleted:0,failed:0,size:0};const t=await this.getAllImagesInFolder(),a=new Set;e.forEach(e=>{e.multimedia&&e.multimedia.filter(e=>"image"===e.type&&e.isFileSystem&&e.url).forEach(e=>{const t=e.url.replace("./imagenes/","").replace("imagenes/","");a.add(t)})});const n=t.filter(e=>!a.has(e));if(0===n.length)return{orphans:0,deleted:0,failed:0,size:0};let i=0;for(const l of n)try{const e=await this.imagesFolder.getFileHandle(l);i+=(await e.getFile()).size}catch(o){}let s=0,r=0;for(const l of n)try{await this.imagesFolder.removeEntry(l),s++}catch(o){r++}return{orphans:n.length,deleted:s,failed:r,size:i}}},i=new class{constructor(){this.dbName="InventarioImagenes",this.dbVersion=1,this.storeName="images",this.db=null}async init(){return new Promise((e,t)=>{const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=()=>{t(a.error)},a.onsuccess=()=>{this.db=a.result,e(this.db)},a.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.storeName)){const e=t.createObjectStore(this.storeName,{keyPath:"id"});e.createIndex("repuestoId","repuestoId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}}})}async saveImage(e,t,a){return this.db||await this.init(),new Promise((n,i)=>{const s=new FileReader;s.onload=()=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),o={id:e,repuestoId:t,data:s.result,type:a.type,size:a.size,name:a.name,timestamp:Date.now()},l=r.put(o);l.onsuccess=()=>{n(!0)},l.onerror=()=>{i(l.error)}},s.onerror=()=>i(s.error),s.readAsDataURL(a)})}async getImage(e){return this.db||await this.init(),new Promise((t,a)=>{const n=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);n.onsuccess=()=>{if(n.result){const e=this.base64ToBlob(n.result.data,n.result.type),a=URL.createObjectURL(e);t({url:a,blob:e,metadata:{type:n.result.type,size:n.result.size,name:n.result.name,timestamp:n.result.timestamp}})}else t(null)},n.onerror=()=>a(n.error)})}async getImagesByRepuesto(e){return this.db||await this.init(),new Promise((t,a)=>{const n=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).index("repuestoId").getAll(e);n.onsuccess=()=>{const e=n.result.map(e=>({id:e.id,url:this.base64ToBlob(e.data,e.type),metadata:{type:e.type,size:e.size,name:e.name,timestamp:e.timestamp}}));t(e)},n.onerror=()=>a(n.error)})}async deleteImage(e){return this.db||await this.init(),new Promise((t,a)=>{const n=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);n.onsuccess=()=>{t(!0)},n.onerror=()=>a(n.error)})}async getStorageStats(){return this.db||await this.init(),new Promise((e,t)=>{const a=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();a.onsuccess=()=>{const t=a.result,n=t.reduce((e,t)=>e+t.size,0),i=t.length;e({count:i,size:n,sizeFormatted:this.formatBytes(n),images:t.map(e=>({id:e.id,repuestoId:e.repuestoId,size:e.size,timestamp:e.timestamp}))})},a.onerror=()=>t(a.error)})}async clearAll(){return this.db||await this.init(),new Promise((e,t)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();a.onsuccess=()=>{e(!0)},a.onerror=()=>t(a.error)})}base64ToBlob(e,t){const a=atob(e.split(",")[1]),n=new ArrayBuffer(a.length),i=new Uint8Array(n);for(let s=0;s<a.length;s++)i[s]=a.charCodeAt(s);return new Blob([n],{type:t})}formatBytes(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]}};"showDirectoryPicker"in window||i.init().then(()=>{}).catch(e=>{});const s=new Map,r=(()=>{const e=new Map;return{on(t,a){if(!t||"function"!=typeof a)return()=>{};e.has(t)||e.set(t,new Set);const n=e.get(t);return n.add(a),()=>{n.delete(a),0===n.size&&e.delete(t)}},emit(t,a={}){const n=e.get(t);n&&0!==n.size&&n.forEach(e=>{try{e(a)}catch(t){}})}}})();window.appEvents=r;const o=new class{constructor(e){this.fsManager=e,this.maps=[],this.areas=[],this.maxBackups=5,this.mapsFileName="mapas.json",this.areasFileName="zonas.json",this.logsDirName="logs",this.logFileName="mapas-history.log",this.mapImagesPath=["imagenes","mapas"],this.backupMapPath=["backups","mapas"],this.backupAreaPath=["backups","zonas"],this.initialized=!1,this.logsDirHandle=null,this.backupMapsDir=null,this.backupAreasDir=null,this.mapImagesDir=null}get rootHandle(){return this.fsManager?this.fsManager.storageHandle:null}setMaxBackups(e){"number"==typeof e&&e>=1&&(this.maxBackups=Math.floor(e))}async init(e={}){const{autoReconnect:t=!0}=e;if(!this.fsManager)return!1;if(!this.fsManager.isConnected&&t&&"function"==typeof this.fsManager.restoreFromPreviousSession)try{await this.fsManager.restoreFromPreviousSession()}catch(a){}return!!this.fsManager.isConnected&&(await this.ensureStructure(),await Promise.all([this.loadMaps(),this.loadAreas()]),this.initialized=!0,!0)}async ensureStructure(){this.rootHandle&&(this.mapImagesDir=await this.ensureDirectory(this.mapImagesPath),this.backupMapsDir=await this.ensureDirectory(this.backupMapPath),this.backupAreasDir=await this.ensureDirectory(this.backupAreaPath),this.logsDirHandle=await this.ensureDirectory([this.logsDirName]),await this.ensureJSONFile(this.mapsFileName,"[]"),await this.ensureJSONFile(this.areasFileName,"[]"),await this.ensureLogFile())}async ensureDirectory(e){let t=this.rootHandle;if(!t)return null;for(const a of e)a&&(t=await t.getDirectoryHandle(a,{create:!0}));return t}async ensureJSONFile(e,t){const a=this.rootHandle;if(a)try{await a.getFileHandle(e)}catch(n){if("NotFoundError"===n.name){const n=await a.getFileHandle(e,{create:!0}),i=await n.createWritable();await i.write(t),await i.close()}}}async ensureLogFile(){if(this.logsDirHandle)try{await this.logsDirHandle.getFileHandle(this.logFileName)}catch(e){if("NotFoundError"===e.name){const e=await this.logsDirHandle.getFileHandle(this.logFileName,{create:!0}),t=await e.createWritable();await t.write(""),await t.close()}}}async loadMaps(){if(!this.fsManager||!this.fsManager.isConnected)return this.maps=[],this.maps;try{const e=await this.rootHandle.getFileHandle(this.mapsFileName,{create:!0}),t=await e.getFile(),a=(await t.text()).trim();let n=[];a&&(n=JSON.parse(a));const i=e=>Array.isArray(e)?e.map(e=>{if(!e)return null;if("string"==typeof e)return{id:e,nivel:null};if("object"==typeof e){const t=e.id??e.value??null;return t?{id:t,nivel:e.nivel??e.level??null}:null}return null}).filter(Boolean):[];this.maps=Array.isArray(n)?n.map(e=>{if(!e||"object"!=typeof e)return{id:Date.now(),name:"Mapa sin nombre",jerarquiaPath:[]};const t={...e};return t.jerarquiaPath=i(e.jerarquiaPath),t}):[]}catch(e){this.maps=[]}return this.maps}async loadAreas(){if(!this.fsManager||!this.fsManager.isConnected)return this.areas=[],this.areas;try{const e=await this.rootHandle.getFileHandle(this.areasFileName,{create:!0}),t=await e.getFile(),a=(await t.text()).trim();let n=[];a&&(n=JSON.parse(a)),this.areas=Array.isArray(n)?n:[]}catch(e){this.areas=[]}return this.areas}async writeJSON(e,t){if(!this.fsManager||!this.fsManager.isConnected)return!1;try{const a=await this.rootHandle.getFileHandle(e,{create:!0}),n=await a.createWritable();return await n.write(JSON.stringify(t,null,2)),await n.close(),!0}catch(a){return!1}}async saveMaps(e,t={}){const a=Array.isArray(e)?e:[];return this.fsManager&&this.fsManager.isConnected?(await this.createBackup(this.mapsFileName,"maps"),await this.writeJSON(this.mapsFileName,a),this.maps=[...a],await this.appendLog({scope:"maps",action:t.action||"save",mapId:t.mapId||null,detail:t.detail||null}),!0):(this.maps=[...a],!1)}async saveAreas(e,t={}){const a=Array.isArray(e)?e:[];return this.fsManager&&this.fsManager.isConnected?(await this.createBackup(this.areasFileName,"areas"),await this.writeJSON(this.areasFileName,a),this.areas=[...a],await this.appendLog({scope:"areas",action:t.action||"save",mapId:t.mapId||null,areaId:t.areaId||null,detail:t.detail||null}),!0):(this.areas=[...a],!1)}async createBackup(e,t){if(!this.fsManager||!this.fsManager.isConnected)return;const a="areas"===t?this.backupAreasDir:this.backupMapsDir;if(a)try{const t=await this.rootHandle.getFileHandle(e),n=await t.getFile(),i=await n.text();if(!i||!i.trim())return;const s=this.formatTimestamp(new Date),r=e.replace(".json",""),o=await a.getFileHandle(`${r}-${s}.json`,{create:!0}),l=await o.createWritable();await l.write(i),await l.close(),await this.rotateBackups(a)}catch(n){n.name}}async rotateBackups(e){if(!e)return;const t=[];try{for await(const a of e.values())"file"===a.kind&&t.push(a.name)}catch(a){return}for(t.sort();t.length>this.maxBackups;){const n=t.shift();try{await e.removeEntry(n)}catch(a){break}}}async appendLog(e){if(e&&"object"==typeof e&&this.logsDirHandle)try{const t={scope:e.scope||"maps",action:e.action||"update",mapId:e.mapId||null,areaId:e.areaId||null,detail:e.detail||null,timestamp:(new Date).toISOString()},a=await this.logsDirHandle.getFileHandle(this.logFileName,{create:!0}),n=await a.getFile(),i=await a.createWritable({keepExistingData:!0});await i.seek(n.size),await i.write(JSON.stringify(t)+"\n"),await i.close()}catch(t){}}async readLog(e=null){if(!this.logsDirHandle)return[];try{const a=await this.logsDirHandle.getFileHandle(this.logFileName,{create:!0}),n=await a.getFile(),i=await n.text();if(!i)return[];const s=i.split("\n").filter(e=>e.trim().length>0),r=[];for(const e of s)try{r.push(JSON.parse(e))}catch(t){}return"number"==typeof e&&e>0?r.slice(-e):r}catch(t){return[]}}async getFileHandleFromPath(e){if(!this.fsManager||!this.fsManager.isConnected)return null;const t=Array.isArray(e)?e:String(e||"").split("/").filter(Boolean);if(!t.length)return null;let a=this.rootHandle;try{for(let e=0;e<t.length;e++){const n=t[e];if(e===t.length-1)return await a.getFileHandle(n,{create:!1});a=await a.getDirectoryHandle(n,{create:!1})}}catch(n){return null}return null}async getMapImage(e){if(!e||!e.imagePath)return null;try{const t=await this.getFileHandleFromPath(e.imagePath);return t?await t.getFile():null}catch(t){return null}}async listMapImageFiles(){if(!this.fsManager||!this.fsManager.isConnected)return[];if(await this.ensureStructure(),!this.mapImagesDir)return[];const e=[];try{for await(const t of this.mapImagesDir.values())"file"===t.kind&&e.push(t.name)}catch(t){}return e}async deleteMapImage(e){if(!this.fsManager||!this.fsManager.isConnected)return{success:!1,reason:"fs-offline"};const t="string"==typeof e?e:e&&e.imagePath?e.imagePath:null;if(!t)return{success:!1,reason:"no-path"};const a=String(t).split("/").filter(Boolean);if(!a.length||!this.rootHandle)return{success:!1,reason:"invalid-path"};try{let e=this.rootHandle;for(let n=0;n<a.length-1;n++)e=await e.getDirectoryHandle(a[n],{create:!1});const t=a[a.length-1];return await e.removeEntry(t),{success:!0,reason:"deleted"}}catch(n){return"NotFoundError"===n.name?{success:!0,reason:"missing"}:{success:!1,reason:"fs-error",error:n}}}async cleanupOrphanMapImages(){if(!this.fsManager||!this.fsManager.isConnected)return{scanned:0,referenced:0,orphans:0,removed:0,failed:[]};await this.ensureStructure();const e=await this.listMapImageFiles();if(!e.length)return{scanned:0,referenced:0,orphans:0,removed:0,failed:[]};const t=new Set((this.maps||[]).map(e=>{if(!e||!e.imagePath)return null;const t=e.imagePath.split("/").filter(Boolean);return t.length?t[t.length-1]:null}).filter(Boolean)),a=e.filter(e=>!t.has(e)),n=[];let i=0;for(const r of a)try{await this.mapImagesDir.removeEntry(r),i++}catch(s){n.push({fileName:r,error:(null==s?void 0:s.message)||"unknown"})}return{scanned:e.length,referenced:t.size,orphans:a.length,removed:i,failed:n}}getMapById(e){return this.maps.find(t=>t.id===e)||null}getAreasByMap(e){return this.areas.filter(t=>t.mapId===e)}formatTimestamp(e=new Date){const t=e=>String(e).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async getMaps(){return await this.loadMaps(),this.maps}async getAreas(){return await this.loadAreas(),this.areas}}(n),l={elements:{},cachedJerarquiaOptions:null,cachedJerarquiaStructure:null,cachedJerarquiaVersion:0,categories:{area:{icon:"",color:"#3b82f6",name:"rea",description:"Zona general de planta"},maquina:{icon:"",color:"#10b981",name:"Mquina",description:"Equipo industrial principal"},estructura:{icon:"",color:"#64748b",name:"Estructura",description:"Componente estructural"},cinta:{icon:"",color:"#f59e0b",name:"Cinta",description:"Transportador o cinta"},componente:{icon:"",color:"#8b5cf6",name:"Componente",description:"Pieza o elemento menor"}},jerarquiaLevelConfig:{empresa:{label:"Empresa",childKey:"areas",childNivel:"area"},area:{label:"rea",childKey:"subAreas",childNivel:"subArea"},subArea:{label:"Sub-rea",childKey:"sistemas",childNivel:"sistema"},sistema:{label:"Sistema",childKey:"subSistemas",childNivel:"subSistema"},subSistema:{label:"Sub-Sistema",childKey:"secciones",childNivel:"seccion"},seccion:{label:"Seccin",childKey:"subSecciones",childNivel:"subSeccion"},subSeccion:{label:"Sub-Seccin",childKey:null,childNivel:null}},areaJerarquiaFieldOrder:["planta","areaGeneral","subArea","sistemaEquipo","subSistema","seccion","detalle"],state:{currentMapId:null,currentMap:null,currentImage:null,currentImageUrl:null,imageLODs:[],imageDimensions:{width:0,height:0},usingBitmapRenderer:!1,scale:1,minScale:.05,maxScale:20,offsetX:0,offsetY:0,isPanning:!1,panStartX:0,panStartY:0,drawing:!1,tempPoints:[],previewPoint:null,highlightAreaId:null,showGrid:!1,showRulers:!1,gridSize:50,showMinimap:!0,mostrarNombresAreas:!0,mostrarPuntosRepuestos:!0,repuestoFiltrado:null,tooltipPinned:!1,pinnedAreaId:null,cascadaEditMode:!1,mostrarSoloConJerarquia:!1,draggedRepuesto:null,dropTargetArea:null,areas:[],categoryFilter:null,jerarquiaBranchFilter:null,selectedAreaIds:[],isMultiSelectMode:!1,isReshapeMode:!1,reshapeAreaId:null,reshapePoints:[],selectedPointIndex:null,isDraggingPoint:!1,hoveredPointIndex:null,hoveredEdgeIndex:null,editingAreaId:null,editingPoints:[],selectedPointIndex:null,isDraggingPoint:!1,animationFrameId:null,needsRedraw:!1,pendingJerarquiaRefresh:!1,pendingCatalogRefresh:!1,lastJerarquiaSync:null,lastCatalogSync:null,tempJerarquiaAssignment:null,mapLoadingActive:!1,mapLoadingProgress:0,mapLoadingHideTimeout:null},viewportState:null,mapViewportStorageKey:"mapViewportState_v1",viewportPersistDelay:600,viewportSaveTimer:null,viewportChangedDuringPan:!1,restoreViewportState(){try{const e=localStorage.getItem(this.mapViewportStorageKey);e&&(this.viewportState=JSON.parse(e))}catch(e){}this.viewportState&&"object"==typeof this.viewportState?(this.viewportState.lastMapId=this.viewportState.lastMapId||null,this.viewportState.views=this.viewportState.views||{}):this.viewportState={lastMapId:null,views:{}}},captureCurrentViewportSnapshot(){if(!this.state.currentMapId)return null;const e=Number(this.state.scale),t=Number(this.state.offsetX),a=Number(this.state.offsetY);if(!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(a))return null;const n=Math.min(this.state.maxScale,Math.max(this.state.minScale,e));return{mapId:this.state.currentMapId,scale:n,offsetX:t,offsetY:a}},getLastViewedMapId(){var e;return(null==(e=this.viewportState)?void 0:e.lastMapId)||null},getPersistedViewportForMap(e){return e&&this.viewportState&&this.viewportState.views&&this.viewportState.views[e]||null},sanitizeViewportSnapshot(e){if(!e||"object"!=typeof e)return null;const t=Number(e.scale),a=Number(e.offsetX),n=Number(e.offsetY);return Number.isFinite(t)&&Number.isFinite(a)&&Number.isFinite(n)?{scale:Math.min(this.state.maxScale,Math.max(this.state.minScale,t)),offsetX:a,offsetY:n}:null},applyViewportSnapshot(e){const t=this.sanitizeViewportSnapshot(e);return!!t&&(this.state.scale=t.scale,this.state.offsetX=t.offsetX,this.state.offsetY=t.offsetY,!0)},queueViewportPersist(e="auto"){this.state.currentMapId&&(this.viewportSaveTimer&&clearTimeout(this.viewportSaveTimer),this.viewportSaveTimer=setTimeout(()=>{this.persistViewportState(e)},this.viewportPersistDelay))},persistViewportState(e="auto"){if(!this.state.currentMapId)return;const t=this.captureCurrentViewportSnapshot();if(!t)return;this.viewportState&&"object"==typeof this.viewportState||(this.viewportState={lastMapId:null,views:{}}),this.viewportState.lastMapId=t.mapId;const a={scale:t.scale,offsetX:t.offsetX,offsetY:t.offsetY,updatedAt:Date.now()};this.viewportState.views[t.mapId]=a;const n=Object.entries(this.viewportState.views);n.length>25&&n.sort((e,t)=>{var a,n;return((null==(a=e[1])?void 0:a.updatedAt)||0)-((null==(n=t[1])?void 0:n.updatedAt)||0)}).slice(0,n.length-25).forEach(([e])=>delete this.viewportState.views[e]);try{localStorage.setItem(this.mapViewportStorageKey,JSON.stringify(this.viewportState))}catch(i){}this.viewportSaveTimer&&(clearTimeout(this.viewportSaveTimer),this.viewportSaveTimer=null)},init(){const e=localStorage.getItem("mapCategories");if(e)try{this.categories=JSON.parse(e)}catch(t){}this.restoreViewportState(),"undefined"!=typeof window&&window.addEventListener&&window.addEventListener("beforeunload",()=>{this.persistViewportState("beforeunload")}),this.elements={shell:document.querySelector(".map-shell"),connectBtn:document.getElementById("mapConnectBtn"),cleanImagesBtn:document.getElementById("mapCleanImagesBtn"),newBtn:document.getElementById("mapNewBtn"),drawBtn:document.getElementById("mapDrawAreaBtn"),saveBtn:document.getElementById("mapSaveAreasBtn"),mapList:document.getElementById("mapList"),areaList:document.getElementById("areaList"),jerarquiaBadge:document.getElementById("mapJerarquiaBadge"),jerarquiaBranch:document.getElementById("mapJerarquiaBranch"),logList:document.getElementById("mapLogList"),logRefreshBtn:document.getElementById("mapLogRefreshBtn"),connectionBadge:document.getElementById("mapConnectionBadge"),status:document.getElementById("mapStatus"),zoomBadge:document.getElementById("mapZoomBadge"),metaBadge:document.getElementById("mapMetaBadge"),toolbar:document.getElementById("mapToolbar"),canvasStage:document.querySelector(".map-canvas-stage"),canvas:document.getElementById("mapCanvas"),hint:document.getElementById("mapHint"),tooltip:document.getElementById("mapTooltip"),minimapContainer:document.getElementById("mapMinimapContainer"),minimap:document.getElementById("mapMinimap"),minimapViewport:document.getElementById("mapMinimapViewport"),modal:document.getElementById("mapModalOverlay"),modalBody:document.getElementById("mapModalBody"),modalTitle:document.getElementById("mapModalTitle"),modalClose:document.getElementById("mapModalClose"),mapLoadingOverlay:document.getElementById("mapLoadingOverlay"),mapLoadingTitle:document.getElementById("mapLoadingTitle"),mapLoadingStatus:document.getElementById("mapLoadingStatus"),mapLoadingBar:document.getElementById("mapLoadingBar"),mapLoadingPercent:document.getElementById("mapLoadingPercent")},this.elements.canvas&&(this.ctx=this.elements.canvas.getContext("2d",{alpha:!1,desynchronized:!0}),this.elements.minimap&&(this.minimapCtx=this.elements.minimap.getContext("2d",{alpha:!0})),this.bindEvents(),this.updateConnectionBadge(),this.resizeCanvas(),o.initialized?this.loadData():n.isConnected?o.init({autoReconnect:!1}).then(()=>this.loadData()).catch(e=>{}):(this.drawMessage("Conecta la carpeta INVENTARIO_STORAGE para comenzar."),this.renderMapList([]),this.renderAreaList([]),this.updateMapJerarquiaBadge()),this.state.pendingJerarquiaRefresh&&this.handleJerarquiaStructureUpdate({silent:!0,reason:"pending-refresh"}),this.state.pendingCatalogRefresh&&this.handleJerarquiaCatalogUpdate({silent:!0,reason:"pending-refresh"}))},bindEvents(){const{connectBtn:e,cleanImagesBtn:t,newBtn:a,drawBtn:n,toolbar:i,logRefreshBtn:s,modalClose:r,modal:o}=this.elements;e&&e.addEventListener("click",()=>this.handleConnect()),t&&t.addEventListener("click",()=>this.cleanOrphanMapImages()),a&&a.addEventListener("click",()=>this.openNewMapModal()),n&&n.addEventListener("click",()=>this.toggleDrawingMode());const l=document.getElementById("mapAddMarkerBtn");l&&l.addEventListener("click",()=>this.toggleModoAgregarMarcador()),i&&i.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const a=t.dataset.action;e.preventDefault(),this.handleToolbarAction(a)}),s&&s.addEventListener("click",()=>this.refreshLog()),r&&r.addEventListener("click",()=>this.closeModal()),o&&o.addEventListener("click",e=>{e.target===o&&this.closeModal()});const d=document.getElementById("mapLogFilterAction"),c=document.getElementById("mapLogFilterScope"),p=document.getElementById("mapLogHelpBtn");d&&d.addEventListener("change",()=>this.refreshLog()),c&&c.addEventListener("change",()=>this.refreshLog()),p&&p.addEventListener("click",()=>this.showHistorialHelp());const u=document.querySelectorAll(".map-category-filter-btn");u.forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.category;this.applyCategoryFilter(t),u.forEach(e=>{e.dataset.category===t?(e.style.background="var(--primary)",e.style.color="white"):(e.style.background="var(--bg-tertiary)",e.style.color="var(--text-primary)")})})});const m=document.getElementById("mapAreaSearch");m&&m.addEventListener("input",()=>{if(this.state.currentMapId){const e=this.state.areas.filter(e=>e.mapId===this.state.currentMapId);this.renderAreaList(e)}}),this.elements.jerarquiaBadge&&this.elements.jerarquiaBadge.addEventListener("click",e=>{const t=e.target;if(!(t instanceof Element))return;t.closest('[data-action="badge-assign-jerarquia"]')&&(e.preventDefault(),e.stopPropagation(),this.state.currentMapId?this.openAssignJerarquiaModal(this.state.currentMapId):this.showToast("Selecciona un mapa primero.","info"))}),this.elements.jerarquiaBranch&&this.elements.jerarquiaBranch.addEventListener("click",e=>{const t=e.target;if(!(t instanceof Element))return;if(t.closest('[data-action="branch-clear-filter"]'))return e.preventDefault(),e.stopPropagation(),void this.clearJerarquiaBranchFilter();const a=t.closest("[data-branch-index]");if(!a)return;const n=parseInt(a.getAttribute("data-branch-index"),10);Number.isNaN(n)||(e.preventDefault(),this.toggleJerarquiaBranchFilter(n))}),this.elements.minimap&&this.elements.minimap.addEventListener("click",e=>{this.handleMinimapClick(e)}),this.registerCanvasEvents(),window.addEventListener("resize",()=>this.handleResize())},async handleConnect(){if("function"!=typeof(null==n?void 0:n.checkFileSystemAPI)||n.checkFileSystemAPI())try{await c.connectWorkspace(!1,!0);setTimeout(()=>{location.reload()},1e3)}catch(e){this.showToast("No se pudo conectar la carpeta: "+((null==e?void 0:e.message)||e),"error")}else this.showToast("Tu navegador no soporta File System Access API. Usa Microsoft Edge o Chrome.","warning")},updateConnectionBadge(){const{connectionBadge:e,status:t}=this.elements;e&&(o.initialized&&n.isConnected?(e.textContent=n.folderPath||"INVENTARIO_STORAGE",e.classList.remove("map-status-badge--off"),e.classList.add("map-status-badge--on"),t&&(t.textContent="Selecciona un mapa o crea uno nuevo para comenzar a trabajar.")):(e.textContent="Sin carpeta",e.classList.remove("map-status-badge--on"),e.classList.add("map-status-badge--off"),t&&(t.textContent="Conecta la carpeta INVENTARIO_STORAGE para habilitar el editor de mapas.")))},async loadData(e={}){if(!o.initialized)return this.renderMapList([]),this.renderAreaList([]),this.drawMessage("Conecta la carpeta INVENTARIO_STORAGE para comenzar."),void this.updateMapJerarquiaBadge();try{e.force&&(await o.ensureStructure(),await Promise.all([o.loadMaps(),o.loadAreas()]));const t=o.maps||[];if(this.renderMapList(t),!t.length)return this.state.currentMapId=null,this.state.currentMap=null,this.state.jerarquiaBranchFilter=null,this.state.areas=[],this.cleanupImage(),this.renderAreaList([]),this.drawMessage("Crea un mapa para comenzar a dibujar zonas."),void this.updateMapJerarquiaBadge();const a=e=>t.some(t=>Number(t.id)===Number(e));let n=this.state.currentMapId&&a(this.state.currentMapId)?this.state.currentMapId:null;if(!n){const e=this.getLastViewedMapId();e&&a(e)&&(n=e)}n||(n=t[0].id);const i=Boolean(this.state.currentMapId&&this.state.currentMapId===n);await this.selectMap(n,{keepViewport:i}),await this.refreshLog()}catch(t){this.showToast("No se pudieron cargar los mapas. Revisa la consola.","error")}},renderMapList(e){const{mapList:t}=this.elements;if(!t)return;if(!Array.isArray(e)||!e.length)return t.classList.remove("map-hierarchy-list"),void(t.innerHTML='<div style="padding: 16px; border: 1px dashed var(--border-color); border-radius: 10px; color: var(--text-secondary); font-size: 0.85rem;">An no hay mapas registrados.</div>');const a=this.buildMapHierarchyTree(e),n=this.renderMapHierarchyGroups(a.children,0);t.classList.add("map-hierarchy-list"),t.innerHTML=n,this.attachMapHierarchyEvents(),this.attachMapCardEvents()},getMapHierarchyPath:e=>e&&Array.isArray(e.jerarquiaPath)&&e.jerarquiaPath.length?e.jerarquiaPath.map(e=>({id:e.id||null,nivel:e.nivel||null,nombre:e.nombre||null})):[{id:"sin-jerarquia",nivel:"sin-nivel",nombre:"Sin jerarqua asignada"}],getJerarquiaNodeName(e){if(!e)return"Sin nombre";const t=this.findJerarquiaNodeInTree(e.id,e.nivel);return(null==t?void 0:t.nombre)||e.nombre||e.id||"Nivel sin nombre"},buildMapHierarchyTree(e){const t={key:"root",label:"root",fullPath:"",children:new Map,maps:[]};return e.forEach(e=>{const a=this.getMapHierarchyPath(e);let n=t;a.forEach((e,t)=>{const i=`${e.id||"nivel"}-${e.nivel||t}`;if(!n.children.has(i)){const s=a.slice(0,t+1);n.children.set(i,{key:i,label:this.getJerarquiaNodeName(e),fullPath:this.getJerarquiaPathLabel(s),nivel:e.nivel||null,children:new Map,maps:[]})}n=n.children.get(i)}),n.maps.push(e)}),t},sortHierarchyChildren:e=>Array.from(e.values()).sort((e,t)=>e.label.localeCompare(t.label||"","es",{sensitivity:"base"})),countMapsInGroup(e){let t=Array.isArray(e.maps)?e.maps.length:0;return e.children&&e.children.size&&(t+=Array.from(e.children.values()).reduce((e,t)=>e+this.countMapsInGroup(t),0)),t},renderMapHierarchyGroups(e,t=0){return e&&e.size?this.sortHierarchyChildren(e).map(e=>{var a;const n=this.countMapsInGroup(e),i=!(!e.children||!e.children.size),s=1===(Array.isArray(e.maps)?e.maps.length:0)?e.maps[0]:null,r=`map-hierarchy-header ${i?"map-hierarchy-header--clickable":"map-hierarchy-header--static"} ${s?"map-hierarchy-header--map":""} ${s&&String(this.state.currentMapId)===String(s.id)?"map-hierarchy-header--active":""}`,o=s?`data-map-id="${s.id}"`:"",l=s?this.renderGroupTooltip(s):"",d=s?this.renderGroupActions(s):"",c=(null==(a=e.children)?void 0:a.size)?`<div class="map-hierarchy-children">${this.renderMapHierarchyGroups(e.children,t+1)}</div>`:"",p=s?[]:e.maps||[],u=p.length?`<div class="map-hierarchy-leaf-list">${p.map(e=>this.renderMapHierarchyLeaf(e)).join("")}</div>`:"";return`\n        <div class="map-hierarchy-group" data-depth="${t}">\n          <div class="${r}" ${o}>\n            <div class="map-hierarchy-header-main">\n              <span class="map-hierarchy-chevron" data-action="toggle-group"></span>\n              <div>\n                <div class="map-hierarchy-label">${this.escapeHtml(e.label)}</div>\n                ${e.fullPath?`<div class="map-hierarchy-path">${this.escapeHtml(e.fullPath)}</div>`:""}\n              </div>\n            </div>\n            <span class="map-hierarchy-count">\n              ${d}\n              ${n} mapa${1===n?"":"s"}\n            </span>\n            ${l}\n          </div>\n          <div class="map-hierarchy-body">\n            ${u}\n            ${c}\n          </div>\n        </div>\n      `}).join(""):""},renderMapCard(e){const t=this.state.currentMapId===e.id,a=Array.isArray(e.jerarquiaPath)&&e.jerarquiaPath.length>0,n=a?this.getJerarquiaPathLabel(e.jerarquiaPath):"Sin jerarqua asignada";return`\n      <article class="map-card ${t?"map-card--active":""}" data-map-id="${e.id}">\n        <div class="map-card-content" data-action="select-map">\n          <div class="map-card-title">${this.escapeHtml(e.name||"Mapa sin nombre")}</div>\n          <div class="map-card-path ${a?"":"map-card-path--empty"}">${this.escapeHtml(n)}</div>\n        </div>\n      </article>\n    `},getAreasCountForMap:e=>o&&Array.isArray(o.areas)?o.areas.filter(t=>t.mapId===e).length:0,renderGroupTooltip(e){if(!e)return"";const t=e.createdAt?new Date(e.createdAt).toLocaleDateString("es-CL"):"",a=e.width&&e.height?`${e.width}  ${e.height}px`:"Dimensiones pendientes",n=this.getAreasCountForMap(e.id),i=Array.isArray(e.jerarquiaPath)&&e.jerarquiaPath.length?this.getJerarquiaPathLabel(e.jerarquiaPath):"";return`<div class="map-hierarchy-tooltip">${[`<span class="map-hierarchy-tooltip-line"><strong>${this.escapeHtml(e.name||"Mapa sin nombre")}</strong></span>`,i?`<span class="map-hierarchy-tooltip-line">Ruta: ${this.escapeHtml(i)}</span>`:null,`<span class="map-hierarchy-tooltip-line">${n} rea(s) registradas</span>`,a?`<span class="map-hierarchy-tooltip-line">Resolucin: ${this.escapeHtml(a)}</span>`:null,t?`<span class="map-hierarchy-tooltip-line">Creado: ${this.escapeHtml(t)}</span>`:null].filter(Boolean).join("")}</div>`},renderGroupActions:e=>`\n      <span class="map-hierarchy-actions">\n        <button class="map-card-btn map-card-btn--link" data-action="assign-jerarquia" data-map-id="${e.id}" title="Asignar jerarqua">Jerarqua</button>\n        <button class="map-card-btn map-card-btn--edit" data-action="edit-map" data-map-id="${e.id}" title="Editar mapa"></button>\n        <button class="map-card-btn map-card-btn--delete" data-action="delete-map" data-map-id="${e.id}" title="Eliminar mapa"></button>\n      </span>\n    `,renderMapHierarchyLeaf(e){if(!e)return"";const t=String(this.state.currentMapId)===String(e.id),a=this.getAreasCountForMap(e.id);return`\n      <div class="map-hierarchy-leaf ${t?"map-hierarchy-leaf--active":""}" data-map-id="${e.id}">\n        <div class="map-hierarchy-leaf-main">\n          <span class="map-hierarchy-leaf-label">${this.escapeHtml(e.name||"Mapa sin nombre")}</span>\n          <span class="map-hierarchy-leaf-meta">${a} rea${1===a?"":"s"}</span>\n        </div>\n        <div class="map-hierarchy-leaf-right">\n          ${this.renderGroupActions(e)}\n        </div>\n        ${this.renderGroupTooltip(e)}\n      </div>\n    `},attachMapHierarchyEvents(){const{mapList:e}=this.elements;e&&(Array.from(e.querySelectorAll('.map-hierarchy-chevron[data-action="toggle-group"]')).forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const a=e.closest(".map-hierarchy-group");a&&a.classList.toggle("map-hierarchy-group--collapsed")})}),Array.from(e.querySelectorAll(".map-hierarchy-header--clickable:not([data-map-id])")).forEach(e=>{e.addEventListener("click",()=>{const t=e.closest(".map-hierarchy-group");t&&t.classList.toggle("map-hierarchy-group--collapsed")})}),Array.from(e.querySelectorAll(".map-hierarchy-header[data-map-id]")).forEach(e=>{e.addEventListener("click",async()=>{const t=e.getAttribute("data-map-id");t&&await this.selectMap(t)})}),Array.from(e.querySelectorAll(".map-hierarchy-leaf[data-map-id]")).forEach(e=>{e.addEventListener("click",async()=>{const t=e.getAttribute("data-map-id");t&&await this.selectMap(t)})}))},attachMapCardEvents(){const{mapList:e}=this.elements;e&&(Array.from(e.querySelectorAll('[data-action="select-map"]')).forEach(e=>{e.addEventListener("click",async e=>{const t=e.target.closest(".map-card"),a=null==t?void 0:t.getAttribute("data-map-id");a&&await this.selectMap(a)})}),Array.from(e.querySelectorAll('[data-action="edit-map"]')).forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const a=e.getAttribute("data-map-id");await this.openEditMapModal(a)})}),Array.from(e.querySelectorAll('[data-action="assign-jerarquia"]')).forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const a=e.getAttribute("data-map-id");await this.openAssignJerarquiaModal(a)})}),Array.from(e.querySelectorAll('[data-action="delete-map"]')).forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const a=e.getAttribute("data-map-id");await this.deleteMap(a)})}))},calcularCorrelativosGlobales(e){if(!c||!c.repuestos||!Array.isArray(c.repuestos))return{};const t={},a={};return c.repuestos.forEach(t=>{if(!t.ubicaciones||!Array.isArray(t.ubicaciones))return;const n=t.ubicaciones.filter(t=>String(t.mapId)===String(e)&&t.markerX&&t.markerY).length;n>0&&(a[t.id]=n)}),c.repuestos.forEach(n=>{if(!n.ubicaciones||!Array.isArray(n.ubicaciones))return;if(!a[n.id])return;let i=0;n.ubicaciones.forEach((s,r)=>{String(s.mapId)===String(e)&&s.markerX&&s.markerY&&(i++,t[n.id]||(t[n.id]={}),t[n.id][r]={numero:i,total:a[n.id]})})}),t},getMarcadoresPorArea(e){if(!c||!c.repuestos||!Array.isArray(c.repuestos))return{};const t=this.state.currentMapId,a={},n=this.calcularCorrelativosGlobales(t);return c.repuestos.forEach(i=>{i.ubicaciones&&Array.isArray(i.ubicaciones)&&i.ubicaciones.forEach((s,r)=>{var o;if(String(s.mapId)!==String(t))return;if(String(s.areaId)!==String(e))return;const l=s.categoria||"Sin categora";a[l]||(a[l]=[]);const d=(null==(o=n[i.id])?void 0:o[r])||{numero:1,total:1};a[l].push({repuesto:i,ubicacion:s,ubicacionIndex:r,numeroCorrelativo:d.numero,totalInstancias:d.total})})}),a},toggleArea(e){const t=e.closest("[data-area-id]");if(!t)return;const a=t.nextElementSibling;if(!a||!a.classList.contains("area-children"))return;const n="none"===a.style.display;a.style.display=n?"block":"none",e.textContent=n?"v":">"},toggleCategoria(e){const t=e.closest(".categoria-group");if(!t)return;const a=t.querySelector(".categoria-marcadores"),n=e.querySelector(".categoria-toggle");if(!a||!n)return;const i="none"===a.style.display;a.style.display=i?"block":"none",n.style.transform=i?"rotate(0deg)":"rotate(-90deg)"},focusOnMarker(e,t){const a=this.state.highlightMarker;if(a&&a.repuestoId===e&&a.ubicacionIndex===t)return;a&&this.stopMarkerAnimation();const n=c.repuestos.find(t=>t.id===e);if(!n||!n.ubicaciones||!n.ubicaciones[t])return;const i=n.ubicaciones[t];if(!i.markerX||!i.markerY)return;const s=this.elements.canvas;if(!s)return;const r=s.width/2,o=s.height/2;this.state.offsetX=r-i.markerX*this.state.scale,this.state.offsetY=o-i.markerY*this.state.scale,this.state.highlightMarker={repuestoId:e,ubicacionIndex:t},this.startMarkerAnimation(),this.draw(),this.queueViewportPersist("focus-marker")},startMarkerAnimation(){if(this.state.markerAnimationId)return;const e=()=>{this.state.highlightMarker?(this.draw(),this.state.markerAnimationId=requestAnimationFrame(e)):this.state.markerAnimationId=null};this.state.markerAnimationId=requestAnimationFrame(e)},stopMarkerAnimation(){this.state.markerAnimationId&&(cancelAnimationFrame(this.state.markerAnimationId),this.state.markerAnimationId=null)},clearMarkerSelection(){this.state.highlightMarker&&(this.state.highlightMarker=null,this.stopMarkerAnimation(),this.scheduleRender())},openEditMarkerModal(e,t){const a=c.repuestos.find(t=>t.id===e);if(!a||!a.ubicaciones||!a.ubicaciones[t])return void this.showToast(" Marcador no encontrado","error");const n=a.ubicaciones[t],i=this.state.areas.find(e=>e.id===n.areaId);let s="N8",r="";const o=i?this.normalizeAreaJerarquia(i.jerarquia):null;if(o){const e={planta:"N2",areaGeneral:"N3",subArea:"N4",sistemaEquipo:"N5",subSistema:"N6",seccion:"N7",detalle:"N8"},t=["detalle","seccion","subSistema","sistemaEquipo","subArea","areaGeneral","planta"];for(const n of t)if(o[n]){s=e[n],r=`Basado en ${o[n]}`;break}const a=parseInt(s.substring(1));a<8&&(s="N"+(a+1),r=`Repuesto dentro de ${r}`)}const l=a.nivelJerarquico||s,d=`\n      <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100000;">\n        <div style="background: var(--bg-secondary); border-radius: 6px; padding: 20px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">\n          <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 1rem; font-weight: 600;">\n             Editar Datos del Repuesto\n          </h3>\n          \n          <div style="margin-bottom: 12px; padding: 10px; background: var(--bg-tertiary); border-radius: 4px;">\n            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Repuesto:</div>\n            <div style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">\n              ${this.escapeHtml(a.nombre)}\n            </div>\n            ${a.codSAP?`<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">SAP: ${a.codSAP}</div>`:""}\n          </div>\n          \n          <div style="margin-bottom: 12px;">\n            <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">\n               Ubicacin Actual:\n            </label>\n            <div style="padding: 8px; background: var(--bg-tertiary); border-radius: 4px; color: var(--text-primary); font-size: 0.85rem;">\n              ${this.escapeHtml(i?i.name:"Desconocida")}\n            </div>\n          </div>\n          \n          <div style="margin-bottom: 12px;">\n            <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">\n               Nivel Jerrquico:\n            </label>\n            ${l!==s&&r?`\n              <div style="margin-bottom: 8px; padding: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 4px;">\n                <div style="font-size: 0.75rem; color: #22c55e; font-weight: 600; margin-bottom: 2px;">\n                   Nivel sugerido: ${s}\n                </div>\n                <div style="font-size: 0.7rem; color: var(--text-secondary);">\n                  ${r}\n                </div>\n                <button onclick="document.getElementById('editMarkerNivel').value='${s}'; this.parentElement.style.display='none';" style="margin-top: 6px; padding: 4px 12px; background: #22c55e; color: white; border: none; border-radius: 3px; font-size: 0.7rem; cursor: pointer; font-weight: 600;">\n                   Aplicar Sugerencia\n                </button>\n              </div>\n            `:""}\n            <select id="editMarkerNivel" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.9rem;">\n              <option value="N1" ${"N1"===l?"selected":""}>N1 - Empresa</option>\n              <option value="N2" ${"N2"===l?"selected":""}>N2 - Planta (Planta Principal, Acopio, etc.)</option>\n              <option value="N3" ${"N3"===l?"selected":""}>N3 - rea General</option>\n              <option value="N4" ${"N4"===l?"selected":""}>N4 - Sub-rea</option>\n              <option value="N5" ${"N5"===l?"selected":""}>N5 - Sistema/Equipo</option>\n              <option value="N6" ${"N6"===l?"selected":""}>N6 - Sub-Sistema</option>\n              <option value="N7" ${"N7"===l?"selected":""}>N7 - Seccin</option>\n              <option value="N8" ${"N8"===l?"selected":""}>N8 - Detalle (predeterminado)</option>\n            </select>\n          </div>\n          \n          <div style="margin-bottom: 12px;">\n            <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">\n               Categora:\n            </label>\n            <select id="editMarkerCategoria" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.9rem;">\n              <option value="Sin categora" ${"Sin categora"===n.categoria?"selected":""}>Sin categora</option>\n              <option value="Componentes" ${"Componentes"===n.categoria?"selected":""}>Componentes</option>\n              <option value="Elctrico" ${"Elctrico"===n.categoria?"selected":""}>Elctrico</option>\n              <option value="Mecnico" ${"Mecnico"===n.categoria?"selected":""}>Mecnico</option>\n              <option value="Hidrulico" ${"Hidrulico"===n.categoria?"selected":""}>Hidrulico</option>\n              <option value="Neumtico" ${"Neumtico"===n.categoria?"selected":""}>Neumtico</option>\n              <option value="Estructura" ${"Estructura"===n.categoria?"selected":""}>Estructura</option>\n              <option value="Seguridad" ${"Seguridad"===n.categoria?"selected":""}>Seguridad</option>\n              <option value="Instrumentacin" ${"Instrumentacin"===n.categoria?"selected":""}>Instrumentacin</option>\n              <option value="Otro" ${"Otro"===n.categoria?"selected":""}>Otro</option>\n            </select>\n          </div>\n          \n          <div style="margin-bottom: 16px; padding: 10px; background: rgba(99,102,241,0.08); border-left: 3px solid #6366f1; border-radius: 4px;">\n            <p style="margin: 0 0 6px 0; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">\n               Sobre el nivel jerrquico:\n            </p>\n            <p style="margin: 0; color: var(--text-secondary); font-size: 0.75rem; line-height: 1.4;">\n              El nivel determina el orden en cascada e inventario. N1 (Empresa) es el ms alto, N8 (Detalle) el ms especfico. Usa los mismos niveles configurados en Configuracin.\n            </p>\n          </div>\n          \n          <div style="display: flex; gap: 8px; justify-content: flex-end;">\n            <button id="editMarkerCancelBtn" style="padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.9rem;">\n              Cancelar\n            </button>\n            <button id="editMarkerSaveBtn" style="padding: 8px 16px; background: var(--primary); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.9rem; font-weight: 600;">\n              Guardar\n            </button>\n          </div>\n        </div>\n      </div>\n    `,p=document.createElement("div");p.innerHTML=d,document.body.appendChild(p);const u=p.querySelector("#editMarkerCancelBtn"),m=p.querySelector("#editMarkerSaveBtn");u.onclick=()=>{document.body.removeChild(p)},m.onclick=()=>{const e=p.querySelector("#editMarkerCategoria").value,n=p.querySelector("#editMarkerNivel").value;a.ubicaciones[t].categoria=e,a.nivelJerarquico=n,c.guardarDatos(),document.body.removeChild(p),this.renderAreaList(this.state.areas),this.showToast(` Repuesto actualizado: Nivel ${n}`,"success")}},renderAreaList(e){const{areaList:t}=this.elements;if(!t)return;this.renderMapJerarquiaBranch();let a=Array.isArray(e)?e:[];this.state.jerarquiaBranchFilter&&(a=this.applyActiveBranchFilter(a)),this.state.categoryFilter&&(a=a.filter(e=>(e.category||"area")===this.state.categoryFilter));const n=document.getElementById("mapAreaSearch");if(n&&n.value.trim()){const e=n.value.trim().toLowerCase();a=a.filter(t=>{const a=(t.name||"").toLowerCase(),n=this.normalizeAreaJerarquia(t.jerarquia),i=Object.values(n).filter(Boolean).join(" ").toLowerCase();return a.includes(e)||i.includes(e)})}const i=this.getActiveBranchFilterLabel(),s=i?`<div class="map-area-filter-alert">Filtrando por jerarqua: <strong>${this.escapeHtml(i)}</strong> <button type="button" data-action="branch-clear-filter">Limpiar</button></div>`:"";if(!Array.isArray(a)||!a.length){let e=this.state.categoryFilter?"No hay reas de la categora seleccionada.":n&&n.value.trim()?`No se encontraron reas con "${n.value.trim()}".`:"No hay reas registradas para este mapa.";if(i&&(e=`No se encontraron reas para el nivel "${i}".`),t.innerHTML=`${s}<div style="padding: 12px; border: 1px dashed var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 0.8rem;">${e}</div>`,i){const e=t.querySelector('[data-action="branch-clear-filter"]');e&&e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.clearJerarquiaBranchFilter()})}return}const r=this.buildHierarchyTree(a);if(t.innerHTML=`${s}${this.renderHierarchyTree(r)}`,i){const e=t.querySelector('[data-action="branch-clear-filter"]');e&&e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.clearJerarquiaBranchFilter()})}Array.from(t.querySelectorAll('[data-action="focus-area"]')).forEach(e=>{e.addEventListener("click",e=>{var t;const a=null==(t=e.target.closest("[data-area-id]"))?void 0:t.getAttribute("data-area-id");a&&this.focusArea(a)})}),Array.from(t.querySelectorAll('[data-action="edit-area-points"]')).forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const a=e.getAttribute("data-area-id");await this.startEditAreaPoints(a)})}),Array.from(t.querySelectorAll('[data-action="edit-area-metadata"]')).forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const a=e.getAttribute("data-area-id");this.openEditAreaMetadataModal(a)})}),Array.from(t.querySelectorAll('[data-action="edit-area-hierarchy"]')).forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const a=e.getAttribute("data-area-id");this.openEditAreaHierarchyModal(a)})}),Array.from(t.querySelectorAll('[data-action="delete-area"]')).forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const a=e.getAttribute("data-area-id");await this.deleteArea(a)})})},handleJerarquiaStructureUpdate(e={}){this.state.lastJerarquiaSync=Date.now(),this.cachedJerarquiaStructure=(null==c?void 0:c.jerarquiaAnidada)||null,this.cachedJerarquiaOptions=this.mergeWithFallbackJerarquiaOptions(this.buildJerarquiaOptionSetsFromStructure(this.cachedJerarquiaStructure)),this.elements&&this.elements.areaList?(this.state.pendingJerarquiaRefresh=!1,Array.isArray(this.state.areas)&&this.state.areas.length&&this.renderAreaList(this.state.areas),null==e||e.silent):this.state.pendingJerarquiaRefresh=!0},handleJerarquiaCatalogUpdate(e={}){this.state.lastCatalogSync=Date.now(),this.cachedJerarquiaOptions=this.mergeWithFallbackJerarquiaOptions(this.buildJerarquiaOptionSetsFromStructure(null==c?void 0:c.jerarquiaAnidada)),this.elements&&this.elements.areaList?(this.state.pendingCatalogRefresh=!1,Array.isArray(this.state.areas)&&this.state.areas.length&&this.renderAreaList(this.state.areas),this.refreshAreaMetadataFormOptions(),null==e||e.silent):this.state.pendingCatalogRefresh=!0},refreshAreaMetadataFormOptions(){if(!document.getElementById("editAreaForm"))return;const e=this.getJerarquiaOptionCatalog();[{id:"plantaList",key:"planta"},{id:"areaGeneralList",key:"areaGeneral"},{id:"subAreaList",key:"subArea"},{id:"sistemaEquipoList",key:"sistemaEquipo"},{id:"subSistemaList",key:"subSistema"},{id:"seccionList",key:"seccion"}].forEach(({id:t,key:a})=>{const n=document.getElementById(t);if(!n)return;const i=Array.isArray(e[a])?e[a]:[];n.innerHTML=i.map(e=>`<option value="${this.escapeHtml(e)}"></option>`).join("")})},openCascadaModal(){const e=document.getElementById("modalCascada"),t=document.getElementById("cascadaContent");if(!e||!t)return void alert("Error: Modal no encontrado. Por favor recarga la pgina.");const a=this.state.currentMap,n=this.state.areas||[];if(!a||!n||0===n.length)return t.innerHTML='\n        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">\n          <div style="font-size: 4rem; margin-bottom: 16px;"></div>\n          <h3 style="margin: 0 0 8px 0;">No hay reas en este mapa</h3>\n          <p style="margin: 0; opacity: 0.7;">Dibuja algunas reas primero para ver la cascada jerrquica</p>\n        </div>\n      ',void(e.style.display="block");const i=this.buildHierarchyTree(n);t.innerHTML=this.renderHierarchyTree(i),this.attachCascadaEventListeners(t),this.updateCascadaStats(n),e.style.display="block",e.style.zIndex="99999";const s=t=>{"Escape"===t.key&&(e.style.display="none",document.removeEventListener("keydown",s))};document.addEventListener("keydown",s);const r=document.getElementById("cascadaSearchInput");r&&(r.value="")},attachCascadaEventListeners(e){Array.from(e.querySelectorAll('[data-action="focus-area"]')).forEach(e=>{e.addEventListener("click",e=>{var t;const a=null==(t=e.target.closest("[data-area-id]"))?void 0:t.getAttribute("data-area-id");a&&(this.focusArea(a),document.getElementById("modalCascada").style.display="none")})}),Array.from(e.querySelectorAll('[data-action="edit-area-points"]')).forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const a=e.getAttribute("data-area-id");await this.startEditAreaPoints(a),document.getElementById("modalCascada").style.display="none"})}),Array.from(e.querySelectorAll('[data-action="edit-area-metadata"]')).forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const a=e.getAttribute("data-area-id");this.openEditAreaMetadataModal(a),document.getElementById("modalCascada").style.display="none"})}),Array.from(e.querySelectorAll('[data-action="edit-area-hierarchy"]')).forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const a=e.getAttribute("data-area-id");this.openEditAreaHierarchyModal(a)})}),Array.from(e.querySelectorAll('[data-action="delete-area"]')).forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const a=e.getAttribute("data-area-id");await this.deleteArea(a),this.openCascadaModal()})})},filterCascada(e){const t=document.getElementById("cascadaContent");if(!t)return;const a=this.state.areas||[];if(!a||0===a.length)return;const n=e.trim()?a.filter(t=>{const a=this.normalizeAreaJerarquia(t.jerarquia),n=e.toLowerCase();return(t.name||"").toLowerCase().includes(n)||Object.values(a).some(e=>(e||"").toLowerCase().includes(n))}):a,i=this.buildHierarchyTree(n);t.innerHTML=n.length>0?this.renderHierarchyTree(i):`<div style="text-align: center; padding: 40px; color: var(--text-secondary);">\n           <div style="font-size: 3rem;"></div>\n           <p>No se encontraron reas con "${e}"</p>\n         </div>`,this.attachCascadaEventListeners(t)},expandAllCascada(){const e=document.getElementById("cascadaContent");if(!e)return;e.querySelectorAll('[onclick*="nextElementSibling.style.display"]').forEach(e=>{const t=e.nextElementSibling,a=e.querySelector(".toggle");t&&a&&(t.style.display="block",a.textContent="v")})},collapseAllCascada(){const e=document.getElementById("cascadaContent");if(!e)return;e.querySelectorAll('[onclick*="nextElementSibling.style.display"]').forEach(e=>{const t=e.nextElementSibling,a=e.querySelector(".toggle");t&&a&&(t.style.display="none",a.textContent=">")})},openEditAreaHierarchyModal(e){const t="string"==typeof e?parseInt(e,10):e,a=this.state.areas.find(e=>e.id===t);if(!a)return void this.showToast("rea no encontrada","error");const n=this.normalizeAreaJerarquia(a.jerarquia),i=this.getJerarquiaOptionCatalog(),s=(e,t)=>Array.isArray(t)&&t.length?`<datalist id="${e}">${t.map(e=>`<option value="${this.escapeHtml(e)}"></option>`).join("")}</datalist>`:"",r=`\n      <div id="modalEditHierarchy" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target.id==='modalEditHierarchy') this.remove()">\n        <div style="background: var(--bg-primary); border-radius: 8px; padding: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">\n          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">\n            <h3 style="margin: 0; color: var(--text-primary);">Editar Jerarqua de rea</h3>\n            <button onclick="document.getElementById('modalEditHierarchy').remove()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer;"></button>\n          </div>\n          \n          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 16px;">\n            <div style="color: var(--text-secondary); font-size: 0.9rem;">\n              <strong style="color: var(--text-primary);">rea:</strong> ${this.escapeHtml(a.name||"Sin nombre")}\n            </div>\n          </div>\n          \n          <form id="formEditHierarchy" style="display: flex; flex-direction: column; gap: 12px;">\n            <div style="display: flex; flex-direction: column; gap: 4px;">\n              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;">N1 - Empresa / Planta</label>\n              <input type="text" name="planta" list="plantaList" placeholder="Ej: Aquachile Antarfood" value="${this.escapeHtml(n.planta||"")}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />\n              ${s("plantaList",i.planta||[])}\n            </div>\n            \n            <div style="display: flex; flex-direction: column; gap: 4px;">\n              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;">N2 - rea General</label>\n              <input type="text" name="areaGeneral" list="areaGeneralList" placeholder="Ej: Planta Principal" value="${this.escapeHtml(n.areaGeneral||"")}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />\n              ${s("areaGeneralList",i.areaGeneral||[])}\n            </div>\n            \n            <div style="display: flex; flex-direction: column; gap: 4px;">\n              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;">N3 - Sub-rea</label>\n              <input type="text" name="subArea" list="subAreaList" placeholder="Ej: Estanques" value="${this.escapeHtml(n.subArea||"")}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />\n              ${s("subAreaList",i.subArea||[])}\n            </div>\n            \n            <div style="display: flex; flex-direction: column; gap: 4px;">\n              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;">N4 - Sistema/Equipo</label>\n              <input type="text" name="sistemaEquipo" list="sistemaEquipoList" placeholder="Ej: Grader Baader" value="${this.escapeHtml(n.sistemaEquipo||"")}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />\n              ${s("sistemaEquipoList",i.sistemaEquipo||[])}\n            </div>\n            \n            <div style="display: flex; flex-direction: column; gap: 4px;">\n              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;">N5 - Sub-Sistema</label>\n              <input type="text" name="subSistema" list="subSistemaList" placeholder="Ej: Motor Principal" value="${this.escapeHtml(n.subSistema||"")}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />\n              ${s("subSistemaList",i.subSistema||[])}\n            </div>\n            \n            <div style="display: flex; flex-direction: column; gap: 4px;">\n              <label style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;">N6 - Seccin</label>\n              <input type="text" name="seccion" list="seccionList" placeholder="Ej: Mdulo 1" value="${this.escapeHtml(n.seccion||"")}" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary);" />\n              ${s("seccionList",i.seccion||[])}\n            </div>\n            \n            <div style="display: flex; gap: 8px; margin-top: 8px;">\n              <button type="button" onclick="document.getElementById('modalEditHierarchy').remove()" style="flex: 1; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); cursor: pointer;">\n                Cancelar\n              </button>\n              <button type="submit" style="flex: 1; padding: 10px; background: var(--primary); border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: 600;">\n                Guardar Jerarqua\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",r);const l=document.getElementById("formEditHierarchy");l.addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(l),n={planta:t.get("planta"),areaGeneral:t.get("areaGeneral"),subArea:t.get("subArea"),sistemaEquipo:t.get("sistemaEquipo"),subSistema:t.get("subSistema"),seccion:t.get("seccion")};a.jerarquia=n,await o.updateArea(a),document.getElementById("modalEditHierarchy").remove(),this.openCascadaModal(),this.showToast(" Jerarqua actualizada","success")})},exportCascada(){const e=this.state.currentMap,t=this.state.areas||[];if(!e||!t||0===t.length)return void alert("No hay datos para exportar");const a=this.buildHierarchyTree(t),n=JSON.stringify(a,null,2),i=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(i),r=document.createElement("a");r.href=s,r.download=`cascada_jerarquica_${e.name||"mapa"}_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)},toggleCascadaEditMode(){this.state.cascadaEditMode=!this.state.cascadaEditMode;const e=document.getElementById("cascadaEditModeBtn");this.state.cascadaEditMode?(e&&(e.classList.add("active"),e.style.background="var(--success)",e.style.color="white"),this.showToast(" Modo edicin activado","success")):(e&&(e.classList.remove("active"),e.style.background="",e.style.color=""),this.showToast(" Modo edicin desactivado","info"))},updateCascadaStats(e){const t=document.getElementById("statsAreas"),a=document.getElementById("statsMarcadores"),n=document.getElementById("statsSinJerarquia");if(!t||!a||!n)return;const i=e.length,s=e.filter(e=>{const t=e.jerarquia||{};return!(t.planta&&"Sin planta"!==t.planta||t.areaGeneral&&"Sin rea"!==t.areaGeneral||t.subArea||t.sistemaEquipo||t.subSistema||t.seccion)}).length;let r=0,o=0;((null==c?void 0:c.repuestos)||[]).forEach(e=>{e.ubicaciones&&Array.isArray(e.ubicaciones)&&e.ubicaciones.forEach(t=>{t.mapaId===this.state.currentMapId&&(r++,e.nivelJerarquico&&""!==e.nivelJerarquico||o++)})}),t.textContent=i,a.textContent=r,n.textContent=s+o;const l=n.parentElement;l.style.color=s+o>0?"#f59e0b":"var(--text-secondary)"},toggleMostrarSoloConJerarquia(){this.state.mostrarSoloConJerarquia=!this.state.mostrarSoloConJerarquia;const e=document.getElementById("btnToggleVacias");this.state.mostrarSoloConJerarquia?(e.textContent=" Mostrar vacas",e.style.background="var(--primary)",e.style.color="white"):(e.textContent=" Ocultar vacas",e.style.background="",e.style.color=""),this.openCascadaModal()},buildHierarchyTree(e){const t={};let a=e;return this.state.mostrarSoloConJerarquia&&(a=e.filter(e=>{const t=e.jerarquia||{};return t.planta&&"Sin planta"!==t.planta||t.areaGeneral&&"Sin rea"!==t.areaGeneral||t.subArea||t.sistemaEquipo||t.subSistema||t.seccion})),a.forEach(e=>{const a=this.normalizeAreaJerarquia(e.jerarquia),n=a.planta||"Sin empresa",i=a.areaGeneral||"Sin rea",s=a.subArea||null,r=a.sistemaEquipo||null,o=a.subSistema||null,l=a.seccion||null;let d=null;t[n]||(t[n]={}),t[n][i]||(t[n][i]={}),s||r||o||l||(d=t[n][i]),s&&(t[n][i][s]||(t[n][i][s]={}),r||o||l||(d=t[n][i][s]),r&&(t[n][i][s][r]||(t[n][i][s][r]={}),o||l||(d=t[n][i][s][r]),o&&(t[n][i][s][r][o]||(t[n][i][s][r][o]={}),l||(d=t[n][i][s][r][o]),l&&(t[n][i][s][r][o][l]||(t[n][i][s][r][o][l]={_areas:[]}),d=t[n][i][s][r][o][l])))),d&&(d._areas||(d._areas=[]),d._areas.find(t=>t.id===e.id)||d._areas.push(e))}),t},renderHierarchyTree(e,t=0){let a="";const n=12*t,i=Object.keys(e).sort((e,t)=>"_areas"===e?1:"_areas"===t?-1:e.localeCompare(t,"es",{sensitivity:"base",numeric:!0}));for(const s of i)if("_areas"===s){[...e[s]].sort((e,t)=>(e.name||"").localeCompare(t.name||"","es",{sensitivity:"base"})).forEach(e=>{a+=this.renderAreaItem(e,n,t)})}else{const i=this.renderHierarchyTree(e[s],t+1),r=i.trim().length>0,o=`<span style="\n          background: rgba(59, 130, 246, 0.2);\n          color: #60a5fa;\n          padding: 1px 4px;\n          border-radius: 2px;\n          font-size: 0.65rem;\n          font-weight: 600;\n          font-family: monospace;\n          min-width: 22px;\n          text-align: center;\n        ">N${Math.max(1,t+1)}</span>`;a+=`\n          <div style="margin-bottom: 1px;">\n            <div style="\n              padding: 4px 6px;\n              padding-left: ${n+6}px;\n              background: rgba(255,255,255,0.02);\n              border-left: 2px solid rgba(100,100,100,0.3);\n              font-size: 0.75rem;\n              font-weight: 600;\n              color: #d4d4d4;\n              cursor: pointer;\n              display: flex;\n              align-items: center;\n              gap: 6px;\n            " onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle').textContent = this.nextElementSibling.style.display === 'none' ? '>' : 'v'">\n              <span class="toggle" style="font-size: 0.7rem; width: 8px; font-family: monospace;">${r?"v":">"}</span>\n              ${o}\n              <span style="flex: 1;">${this.escapeHtml(s)}</span>\n            </div>\n            <div style="display: ${r?"block":"none"};">\n              ${i}\n            </div>\n          </div>\n        `}return a},renderAreaItem(e,t,a=0){const n=e.color||"#3b82f6";e.category;const i=this.getMarcadoresPorArea(e.id),s=Object.values(i).reduce((e,t)=>e+t.length,0),r=`<span style="\n      background: rgba(34, 197, 94, 0.2);\n      color: #4ade80;\n      padding: 1px 4px;\n      border-radius: 2px;\n      font-size: 0.65rem;\n      font-weight: 600;\n      font-family: monospace;\n      margin-left: 4px;\n    ">N${Math.max(1,a+1)}</span>`;let o="";const l=Object.keys(i).sort();return l.length>0&&(o=l.map(e=>{const a=i[e],n=a.map(e=>{const a=e.totalInstancias>1;return`\n          <div class="marker-item" style="\n            padding: 3px 8px;\n            padding-left: ${t+24}px;\n            font-size: 0.72rem;\n            color: #bbb;\n            cursor: pointer;\n            transition: all 0.1s;\n            white-space: nowrap;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            display: flex;\n            align-items: center;\n            gap: 6px;\n            position: relative;\n          " \n          onmouseover="this.style.background='rgba(255,255,255,0.05)'; this.style.color='#fff'; this.querySelector('.marker-edit-btn').style.opacity='1'"\n          onmouseout="this.style.background='transparent'; this.style.color='#bbb'; this.querySelector('.marker-edit-btn').style.opacity='0'">\n            <span onclick="mapController.focusOnMarker('${e.repuesto.id}', ${e.ubicacionIndex})" style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 4px;">\n              <span style="overflow: hidden; text-overflow: ellipsis;">${this.escapeHtml(e.repuesto.nombre||"Sin nombre")}</span>\n              ${a?`<span style="\n                background: #222;\n                color: #fff;\n                padding: 1px 4px;\n                border-radius: 2px;\n                font-size: 0.65rem;\n                font-weight: 600;\n                font-family: monospace;\n                flex-shrink: 0;\n              ">#${e.numeroCorrelativo}</span>`:""}\n            </span>\n            <button \n              class="marker-edit-btn"\n              onclick="event.stopPropagation(); mapController.openEditMarkerModal('${e.repuesto.id}', ${e.ubicacionIndex})" \n              style="\n                opacity: 0;\n                transition: opacity 0.15s;\n                background: none;\n                border: none;\n                color: #888;\n                cursor: pointer;\n                padding: 0;\n                font-size: 0.7rem;\n              " \n              title="Editar marcador">E</button>\n          </div>\n        `}).join("");return`\n          <div class="categoria-group" style="\n            display: block;\n            border-left: 1px solid rgba(255,255,255,0.05);\n            margin-bottom: 1px;\n          ">\n            <div class="categoria-header" style="\n              padding: 3px 8px;\n              padding-left: ${t+16}px;\n              font-size: 0.72rem;\n              font-weight: 500;\n              color: #aaa;\n              cursor: pointer;\n              display: flex;\n              align-items: center;\n              gap: 6px;\n              transition: background 0.1s;\n            "\n            onclick="mapController.toggleCategoria(this)"\n            onmouseover="this.style.background='rgba(255,255,255,0.03)'"\n            onmouseout="this.style.background='transparent'">\n              <span class="categoria-toggle" style="\n                font-size: 0.7rem; \n                font-family: monospace;\n                width: 8px;\n              ">v</span>\n              <span>${e}</span>\n              <span style="\n                font-size: 0.65rem;\n                color: #666;\n                background: rgba(255,255,255,0.05);\n                padding: 1px 5px;\n                border-radius: 3px;\n                margin-left: auto;\n              ">${a.length}</span>\n            </div>\n            <div class="categoria-marcadores" style="display: block;">\n              ${n}\n            </div>\n          </div>\n        `}).join("")),`\n      <div style="\n        padding: 4px 6px;\n        padding-left: ${t+6}px;\n        background: rgba(255,255,255,0.02);\n        border-left: 2px solid ${n};\n        font-size: 0.75rem;\n        font-weight: 500;\n        color: #d4d4d4;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        position: relative;\n        margin-bottom: 1px;\n      "\n      data-area-id="${e.id}"\n      onmouseover="this.querySelector('.map-area-actions').style.opacity='1'"\n      onmouseout="this.querySelector('.map-area-actions').style.opacity='0'">\n        <div class="area-toggle" \n             onclick="mapController.toggleArea(this)" \n             style="\n               cursor: pointer; \n               font-size: 0.7rem;\n               font-family: monospace;\n               user-select: none;\n               width: 8px;\n             ">${s>0?"v":">"}</div>\n        <span style="\n          background: rgba(59, 130, 246, 0.3);\n          color: #60a5fa;\n          padding: 1px 5px;\n          border-radius: 2px;\n          font-size: 0.65rem;\n          font-weight: 700;\n          font-family: monospace;\n        ">REA</span>\n        ${r}\n        <div class="map-area-content" \n             data-action="focus-area" \n             style="flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n          ${this.escapeHtml(e.name||"Area sin nombre")}${s>0?` (${s})`:""}\n        </div>\n        <div class="map-area-actions" style="\n          display: flex; \n          gap: 6px;\n          opacity: 0;\n          transition: opacity 0.15s;\n          font-size: 0.7rem;\n          color: #888;\n        ">\n          <span data-action="edit-area-hierarchy" data-area-id="${e.id}" title="Editar jerarqua" style="cursor: pointer; color: #8b5cf6;">J</span>\n          <span data-action="edit-area-points" data-area-id="${e.id}" title="Editar forma" style="cursor: pointer;">E</span>\n          <span data-action="edit-area-metadata" data-area-id="${e.id}" title="Editar datos" style="cursor: pointer;">C</span>\n          <span data-action="delete-area" data-area-id="${e.id}" title="Eliminar" style="cursor: pointer; color: #c55;">X</span>\n        </div>\n      </div>\n      ${s>0?`\n        <div class="area-children" style="display: block;">\n          ${o}\n        </div>\n      `:""}\n    `},applyCategoryFilter(e){var t;this.state.categoryFilter="all"===e?null:e,this.renderAreaList(this.state.areas);const a="all"===e?"Todas las categoras":(null==(t=this.categories[e])?void 0:t.name)||e;this.showToast(`Filtrando: ${a}`,"info")},async selectMap(e,t={}){if(!e)return;if(!o.initialized)return void this.showToast("Conecta la carpeta primero.","warning");const a="string"==typeof e?parseInt(e,10):e,n=o.getMapById(a);if(!n)return void this.showToast("Mapa no encontrado.","warning");this.state.currentMapId!==n.id&&(this.state.jerarquiaBranchFilter=null),this.state.currentMapId=n.id,this.state.currentMap=n,this.state.areas=o.getAreasByMap(n.id),this.state.highlightAreaId=null;const i=t.keepViewport?null:this.getPersistedViewportForMap(n.id);t.keepViewport||i?i&&this.applyViewportSnapshot(i):(this.state.scale=1,this.state.offsetX=0,this.state.offsetY=0),this.showMapLoadingOverlay(n),await this.loadMapImage(n,{...t,viewportOverride:i}),this.renderMapList(o.maps),this.renderAreaList(this.state.areas),this.updateMetaBadge(),this.updateMapJerarquiaBadge(),this.syncButtonStates(),this.queueViewportPersist("select-map")},async loadMapImage(e,t={}){if(this.cleanupImage(),!e.imagePath)return this.drawMessage("El mapa seleccionado no tiene imagen asociada."),void this.hideMapLoadingOverlay(!0,"Sin imagen asociada.");this.state.mapLoadingActive||this.showMapLoadingOverlay(e),this.updateMapLoadingProgress(10,"Buscando imagen en la carpeta...");try{const a=await o.getMapImage(e);if(!a)return this.drawMessage("No se encontr la imagen del mapa."),void this.hideMapLoadingOverlay(!0,"No se encontr la imagen del mapa.");this.updateMapLoadingProgress(25,"Procesando imagen..."),"undefined"!=typeof window&&"function"==typeof window.createImageBitmap?await this.loadMapImageFromBitmaps(a,e,t):await this.loadMapImageLegacy(a,t)}catch(a){this.drawMessage("No se pudo cargar la imagen del mapa."),this.hideMapLoadingOverlay(!0,"No se pudo cargar la imagen.")}},async loadMapImageFromBitmaps(e,t,a={}){const n={width:Number(null==t?void 0:t.width)||0,height:Number(null==t?void 0:t.height)||0};if(!n.width||!n.height){const t=await this.getImageDimensions(e);n.width=t.width,n.height=t.height}if(!n.width||!n.height)return this.drawMessage("No se pudo determinar el tamao del mapa."),void this.hideMapLoadingOverlay(!0,"No se pudo determinar el tamao del mapa.");this.state.imageDimensions={...n},this.updateMapLoadingProgress(40,"Optimizando resoluciones...");const i=await this.buildImageLODs(e,n,(e,t)=>{this.updateMapLoadingProgress(e,t)});if(!i.length)return this.drawMessage("No se pudo preparar la imagen del mapa."),void this.hideMapLoadingOverlay(!0,"No se pudo preparar la imagen del mapa.");this.state.imageLODs=i,this.state.currentImage=i[i.length-1].bitmap,this.state.currentImageUrl=null,this.state.usingBitmapRenderer=!0,this.updateMapLoadingProgress(90,"Aplicando mapa al lienzo..."),this.configureCanvasForImage({width:n.width,height:n.height},a),this.draw(),this.completeMapLoadingProgress(),this.completeMapLoadingProgress()},async loadMapImageLegacy(e,t={}){const a=URL.createObjectURL(e),n=new Image;this.hideMapLoadingOverlay(!0,"Error cargando la imagen del mapa."),n.onload=()=>{this.updateMapLoadingProgress(85,"Aplicando mapa al lienzo..."),this.state.currentImage=n,this.state.currentImageUrl=a,this.state.imageDimensions={width:n.width,height:n.height},this.state.usingBitmapRenderer=!1,this.state.imageLODs=[],this.configureCanvasForImage(n,t),this.draw()},n.onerror=()=>{URL.revokeObjectURL(a),this.drawMessage("Error cargando la imagen del mapa.")},n.src=a},async buildImageLODs(e,t,a=null){const n=t.width,i=t.height,s=this.getLODTargetWidths(n),r=[];let o=null;const l=s.length||1,d=(e,t)=>{if("function"!=typeof a)return;const n=(e+1)/l,i=Math.min(90,Math.round(45+40*n));a(i,`Escala ${t}px optimizada`)};for(const p of s){const t=p/n,a=Math.max(1,Math.round(i*t));try{o||(o=await createImageBitmap(e));const s=p===n&&a===i?o:await createImageBitmap(o,{resizeWidth:p,resizeHeight:a,resizeQuality:"high"});r.push({width:p,height:a,scale:t,bitmap:s}),d(r.length-1,p)}catch(c){}}return r.sort((e,t)=>e.scale-t.scale),r},getLODTargetWidths(e){const t=[1024,2048,4096,6144,8192].filter(t=>e>1.05*t).concat(e),a=[...new Set(t.map(e=>Math.round(e)))];return a.sort((e,t)=>e-t),a},configureCanvasForImage(e,t={}){const a=this.elements.canvas;if(!a)return;const n=this.elements.canvasStage||a.parentElement;if(n){const e=n.clientWidth,t=n.clientHeight;a.width=e,a.height=t,a.style.width="100%",a.style.height="100%"}else a.width=e.width,a.height=e.height;t.viewportOverride?this.applyViewportSnapshot(t.viewportOverride):t.keepViewport||(this.state.scale=1,this.state.offsetX=0,this.state.offsetY=0),this.updateZoomBadge()},cleanupImage(){if(this.state.currentImageUrl)try{URL.revokeObjectURL(this.state.currentImageUrl)}catch(e){}this.state.currentImageUrl=null,Array.isArray(this.state.imageLODs)&&this.state.imageLODs.length&&this.state.imageLODs.forEach(t=>{var a,n;try{null==(n=null==(a=null==t?void 0:t.bitmap)?void 0:a.close)||n.call(a)}catch(e){}}),this.state.imageLODs=[],this.state.imageDimensions={width:0,height:0},this.state.usingBitmapRenderer=!1,this.state.currentImage=null},handleResize(){this.elements.canvas&&(this.state.currentImage?(this.elements.canvas.style.width="100%",this.elements.canvas.style.height="100%",this.draw()):this.resizeCanvas())},resizeCanvas(){const e=this.elements.canvas;if(e)if(this.state.currentImage)this.handleResize();else{const t=this.elements.canvasStage||e.parentElement,a=t?t.clientWidth:640,n=t?t.clientHeight:480,i=window.devicePixelRatio||1;e.width=Math.max(1,Math.round(a*i)),e.height=Math.max(1,Math.round(n*i)),this.ctx.setTransform(i,0,0,i,0,0),this.drawMessage("Conecta la carpeta INVENTARIO_STORAGE para comenzar.")}},drawMessage(e){const t=this.elements.canvas;if(!t||!this.ctx)return;const a=this.ctx;a.save(),a.setTransform(1,0,0,1,0,0),a.fillStyle="#0f172a",a.fillRect(0,0,t.width,t.height),a.fillStyle="rgba(148, 163, 184, 0.9)",a.font='16px "Segoe UI", sans-serif',a.textAlign="center",a.fillText(e,t.width/2,t.height/2),a.restore()},getVisibleMapBounds(){const e=this.elements.canvas,t=this.state.imageDimensions||{};if(!e||!t.width||!t.height)return null;const a=this.state.scale;return{x:-this.state.offsetX/a,y:-this.state.offsetY/a,width:e.width/a,height:e.height/a,maxWidth:t.width,maxHeight:t.height}},getMapDimensionsSafe(){var e,t;return(null==(e=this.state.imageDimensions)?void 0:e.width)&&(null==(t=this.state.imageDimensions)?void 0:t.height)?{...this.state.imageDimensions}:this.state.currentImage?{width:this.state.currentImage.width,height:this.state.currentImage.height}:{width:0,height:0}},getMinimapBitmap(){var e,t;return(null==(e=this.state.imageLODs)?void 0:e.length)?(null==(t=this.state.imageLODs[0])?void 0:t.bitmap)||null:this.state.currentImage},pickLODForScale(e){const t=this.state.imageLODs;if(!Array.isArray(t)||0===t.length)return null;let a=t[0];for(const n of t){if(!(e>=n.scale||1===n.scale))break;a=n}return a},drawBaseImage(e){if(this.state.usingBitmapRenderer&&this.state.imageLODs.length){const t=this.pickLODForScale(this.state.scale),a=this.getVisibleMapBounds();if(!t||!a)return;const n=Math.max(0,a.x),i=Math.max(0,a.y),s=Math.min(a.maxWidth,a.x+a.width),r=Math.min(a.maxHeight,a.y+a.height),o=Math.max(0,s-n),l=Math.max(0,r-i);if(o<=0||l<=0)return;const d=t.scale,c=n*d,p=i*d,u=o*d,m=l*d;return void e.drawImage(t.bitmap,c,p,u,m,n,i,o,l)}this.state.currentImage&&e.drawImage(this.state.currentImage,0,0)},draw(){const e=this.elements.canvas;if(!e||!this.ctx)return;const t=this.ctx;t.save(),t.setTransform(1,0,0,1,0,0),t.fillStyle="#0f172a",t.fillRect(0,0,e.width,e.height),t.translate(this.state.offsetX,this.state.offsetY),t.scale(this.state.scale,this.state.scale),this.drawBaseImage(t),this.state.showGrid&&this.drawGrid(t),this.drawAreas(t),this.drawTempShape(t),this.drawEditPoints(t),this.state.isReshapeMode&&this.state.reshapeAreaId&&this.drawReshapeHandles(t),this.drawMarkers(t),this.dibujarUbicacionesResaltadas(t),t.restore(),this.updateZoomBadge(),this.state.showRulers&&this.drawRulers(),this.state.showMinimap&&this.getMinimapBitmap()&&this.drawMinimap()},scheduleRender(){this.state.animationFrameId||(this.state.animationFrameId=requestAnimationFrame(()=>{this.draw(),this.state.animationFrameId=null}))},drawCanvas(){this.draw()},drawGrid(e){const t=this.getMapDimensionsSafe();if(!t.width||!t.height)return;const a=this.state.gridSize||50,n=t.width,i=t.height;e.save(),e.strokeStyle="rgba(148, 163, 184, 0.25)",e.lineWidth=1/this.state.scale;for(let s=a;s<n;s+=a)e.beginPath(),e.moveTo(s,0),e.lineTo(s,i),e.stroke();for(let s=a;s<i;s+=a)e.beginPath(),e.moveTo(0,s),e.lineTo(n,s),e.stroke();e.restore()},drawRulers(){if(!this.state.showRulers)return;const e=this.getMapDimensionsSafe();if(!e.width||!e.height)return;const t=this.elements.canvas,a=this.ctx,n=30,i=this.state.gridSize||50;a.save(),a.setTransform(1,0,0,1,0,0),a.fillStyle="rgba(15, 23, 42, 0.9)",a.fillRect(n,0,t.width-n,n),a.fillRect(0,n,n,t.height-n),a.fillStyle="rgba(15, 23, 42, 0.95)",a.fillRect(0,0,n,n),a.font="10px sans-serif",a.textAlign="center",a.textBaseline="middle";const s=-this.state.offsetX/this.state.scale,r=(t.width-this.state.offsetX)/this.state.scale,o=-this.state.offsetY/this.state.scale,l=(t.height-this.state.offsetY)/this.state.scale;a.strokeStyle="rgba(148, 163, 184, 0.5)",a.fillStyle="rgba(226, 232, 240, 0.9)",a.lineWidth=1;for(let d=Math.floor(s/i)*i;d<=r;d+=i){const e=d*this.state.scale+this.state.offsetX;e<n||e>t.width||(a.beginPath(),a.moveTo(e,22),a.lineTo(e,n),a.stroke(),d%(2*i)==0&&a.fillText(Math.round(d).toString(),e,15))}a.textAlign="left";for(let d=Math.floor(o/i)*i;d<=l;d+=i){const e=d*this.state.scale+this.state.offsetY;e<n||e>t.height||(a.beginPath(),a.moveTo(22,e),a.lineTo(n,e),a.stroke(),d%(2*i)==0&&(a.save(),a.translate(15,e),a.rotate(-Math.PI/2),a.textAlign="center",a.fillText(Math.round(d).toString(),0,0),a.restore()))}a.strokeStyle="rgba(148, 163, 184, 0.3)",a.lineWidth=1,a.strokeRect(n,0,t.width-n,n),a.strokeRect(0,n,n,t.height-n),a.restore()},drawAreas(e){Array.isArray(this.state.areas)&&this.state.areas.length&&(e.save(),this.state.areas.forEach(t=>{if(!Array.isArray(t.points)||t.points.length<3)return;const a=t.color||"#3b82f6",n="number"==typeof t.opacity?t.opacity:.35,i=this.state.selectedAreaIds.includes(t.id);if(e.beginPath(),t.points.forEach((t,a)=>{0===a?e.moveTo(t.x,t.y):e.lineTo(t.x,t.y)}),e.closePath(),t.id===this.state.highlightAreaId?e.fillStyle="rgba(251, 191, 36, 0.4)":e.fillStyle=this.hexToRgba(a,n),i?(e.strokeStyle="#10b981",e.lineWidth=4/this.state.scale):t.id===this.state.highlightAreaId?(e.shadowColor="#fbbf24",e.shadowBlur=20/this.state.scale,e.shadowOffsetX=0,e.shadowOffsetY=0,e.strokeStyle="#fbbf24",e.lineWidth=6/this.state.scale):(e.strokeStyle=a,e.lineWidth=2/this.state.scale),e.fill(),e.stroke(),e.shadowBlur=0,this.state.mostrarNombresAreas){const a=this.calculateCentroid(t.points);if(a){e.save();const n=t.labelOffsetX||0,i=t.labelOffsetY||0,s=a.x+n,r=a.y+i,o=28,l=14,d=this.state.zoom||1,c=Math.max(l,o/Math.sqrt(d));e.font=`bold ${c}px "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="middle";const p=t.name||"rea",u=20,m=[];if(p.length<=u)m.push(p);else{const e=p.split(" ");let t="";e.forEach((a,n)=>{const i=t?`${t} ${a}`:a;i.length<=u?t=i:(t&&m.push(t),t=a),n===e.length-1&&t&&m.push(t)})}let h=0;m.forEach(t=>{const a=e.measureText(t);a.width>h&&(h=a.width)});const g=h,b=1.2*c,v=b*m.length,y=Math.max(6,12/Math.sqrt(d)),f=g+2*y,x=v+2*Math.max(4,8/Math.sqrt(d)),S=s-f/2,w=r-x/2,A=this.state.selectedAreaIds.includes(t.id),E=t.id===this.state.highlightAreaId;e.shadowColor="rgba(0, 0, 0, 0.2)",e.shadowBlur=Math.max(4,8/Math.sqrt(d)),e.shadowOffsetX=0,e.shadowOffsetY=Math.max(1,2/Math.sqrt(d));const I=e.createLinearGradient(S,w,S,w+x);A?(I.addColorStop(0,"rgba(209, 250, 229, 0.95)"),I.addColorStop(1,"rgba(167, 243, 208, 0.95)")):E?(I.addColorStop(0,"rgba(254, 249, 195, 0.95)"),I.addColorStop(1,"rgba(253, 230, 138, 0.95)")):(I.addColorStop(0,"rgba(255, 255, 255, 0.92)"),I.addColorStop(1,"rgba(249, 250, 251, 0.92)")),e.fillStyle=I;const $=Math.max(3,6/Math.sqrt(d));e.beginPath(),e.moveTo(S+$,w),e.lineTo(S+f-$,w),e.quadraticCurveTo(S+f,w,S+f,w+$),e.lineTo(S+f,w+x-$),e.quadraticCurveTo(S+f,w+x,S+f-$,w+x),e.lineTo(S+$,w+x),e.quadraticCurveTo(S,w+x,S,w+x-$),e.lineTo(S,w+$),e.quadraticCurveTo(S,w,S+$,w),e.closePath(),e.fill(),e.shadowBlur=0,A?(e.strokeStyle="#10b981",e.lineWidth=3/this.state.scale):E?(e.strokeStyle="#facc15",e.lineWidth=3/this.state.scale):(e.strokeStyle="rgba(0, 0, 0, 0.2)",e.lineWidth=2/this.state.scale),e.stroke(),e.fillStyle=A?"#064e3b":E?"#713f12":"#1f2937",e.shadowColor="rgba(255, 255, 255, 0.8)",e.shadowBlur=3/this.state.scale,e.shadowOffsetX=0,e.shadowOffsetY=0;const k=r-v/2+b/2;m.forEach((t,a)=>{const n=k+a*b;e.fillText(t,s,n)}),e.shadowBlur=0,A&&(e.font=`bold ${.9*c}px "Segoe UI", sans-serif`,e.fillStyle="#10b981",e.shadowBlur=0,e.fillText("",S+f+1.5*y,r)),e.restore()}}}),e.restore())},drawMarkers(e){if(!c||!c.repuestos)return;e.save();const t=this.calcularCorrelativosGlobales(this.state.currentMapId),a=[];c.repuestos.forEach(e=>{var n;if(e.ubicaciones&&Array.isArray(e.ubicaciones)&&e.ubicaciones.forEach((n,i)=>{var s;if(String(n.mapId)===String(this.state.currentMapId)&&n.markerX&&n.markerY){const r=(null==(s=t[e.id])?void 0:s[i])||{numero:1,total:1};a.push({repuesto:e,x:n.markerX,y:n.markerY,areaId:n.areaId,ubicacionIndex:i,numeroCorrelativo:r.numero,totalInstancias:r.total})}}),e.mapId&&String(e.mapId)===String(this.state.currentMapId)&&e.markerX&&e.markerY){const i=(null==(n=t[e.id])?void 0:n[0])||{numero:1,total:1};a.push({repuesto:e,x:e.markerX,y:e.markerY,areaId:e.areaId,ubicacionIndex:0,numeroCorrelativo:i.numero,totalInstancias:i.total})}});let n=a;if(this.state.repuestoFiltrado&&(n=a.filter(e=>String(e.repuesto.id)===String(this.state.repuestoFiltrado))),!this.state.mostrarPuntosRepuestos){if(!this.state.highlightMarker)return void e.restore();n=a.filter(e=>String(e.repuesto.id)===String(this.state.highlightMarker.repuestoId)&&e.ubicacionIndex===this.state.highlightMarker.ubicacionIndex)}if(this.state.marcadorArrastre&&this.state.marcadorArrastre.iniciado){const{info:t,mapX:a,mapY:i}=this.state.marcadorArrastre;this.dibujarMarcadorIndividual(e,t.repuesto,a,i,t.ubicacion.areaId,!0,1,t.ubicacionIndex,t.numeroCorrelativo,t.totalInstancias),n.forEach((a,n)=>{const i=a.repuesto.id===t.repuesto.id&&Math.abs(a.x-t.x)<1&&Math.abs(a.y-t.y)<1;this.dibujarMarcadorIndividual(e,a.repuesto,a.x,a.y,a.areaId,!1,i?.3:1,a.ubicacionIndex,a.numeroCorrelativo,a.totalInstancias)})}else{if(0===n.length)return void e.restore();n.forEach(({repuesto:t,x:a,y:n,areaId:i,ubicacionIndex:s,numeroCorrelativo:r,totalInstancias:o})=>{this.dibujarMarcadorIndividual(e,t,a,n,i,!1,1,s,r,o)})}e.restore()},dibujarMarcadorIndividual(e,t,a,n,i,s=!1,r=1,o=null,l=null,d=1){e.save();const c=this.state.pinAMover&&this.state.pinAMover.editando&&String(t.id)===String(this.state.pinAMover.repuestoId),p=this.state.highlightMarker&&String(t.id)===String(this.state.highlightMarker.repuestoId)&&null!==o&&o===this.state.highlightMarker.ubicacionIndex;e.globalAlpha=s?.8:p?1:r;const u=p?.15*Math.sin(Date.now()/200)+1.15:1,m=Math.max(30,40/this.state.scale)*u,h=Math.max(20,26/this.state.scale)*u;if(p){const t=1.8*h*(.3*Math.sin(Date.now()/300)+.7);for(let s=3;s>=1;s--)e.beginPath(),e.arc(a,n-m/2,t*(1+.15*s),0,2*Math.PI),e.strokeStyle=`rgba(251, 191, 36, ${.2/s})`,e.lineWidth=Math.max(2,4/this.state.scale),e.stroke();const i=e.createRadialGradient(a,n-m/2,0,a,n-m/2,t);i.addColorStop(0,"rgba(251, 191, 36, 0.15)"),i.addColorStop(.7,"rgba(251, 191, 36, 0.05)"),i.addColorStop(1,"rgba(251, 191, 36, 0)"),e.fillStyle=i,e.beginPath(),e.arc(a,n-m/2,1.3*t,0,2*Math.PI),e.fill()}p?(e.shadowColor="rgba(251, 191, 36, 0.8)",e.shadowBlur=25/this.state.scale,e.shadowOffsetX=0,e.shadowOffsetY=8/this.state.scale):(e.shadowColor=s?"rgba(59, 130, 246, 0.6)":c?"rgba(249, 115, 22, 0.6)":"rgba(0, 0, 0, 0.4)",e.shadowBlur=15/this.state.scale,e.shadowOffsetX=0,e.shadowOffsetY=5/this.state.scale);const g=t.cantidad||0,b=t.minimo||5;let v,y;c?(v="#f97316",y="#ea580c"):p?(v="#fbbf24",y="#f59e0b"):s?(v="#3b82f6",y="#2563eb"):0===g?(v="#ef4444",y="#dc2626"):g<b?(v="#f59e0b",y="#d97706"):(v="#10b981",y="#059669"),e.beginPath();const f=h/2;e.arc(a,n-m+f,f,0,2*Math.PI),e.moveTo(a-.5*f,n-f),e.lineTo(a,n),e.lineTo(a+.5*f,n-f),e.fillStyle=v,e.fill(),e.strokeStyle=y,e.lineWidth=Math.max(1.5,2/this.state.scale),e.stroke(),e.shadowBlur=0,e.beginPath(),e.arc(a,n-m+f,.4*f,0,2*Math.PI),e.fillStyle="#ffffff",e.fill();const x=this.state.zoom||1,S=Math.max(10,18/Math.sqrt(x));e.font=`bold ${S}px "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="bottom";let w=t.nombre;w.length>20&&(w=w.substring(0,17)+"...");const A=e.measureText(w).width,E=Math.max(4,8/Math.sqrt(x)),I=Math.max(2.5,5/Math.sqrt(x)),$=a-A/2-E,k=n-m-S-2.5*I,M=A+2*E,C=S+2*I,T=Math.max(2,4/Math.sqrt(x));if(e.shadowColor="rgba(0, 0, 0, 0.3)",e.shadowBlur=Math.max(5,10/Math.sqrt(x)),e.shadowOffsetX=0,e.shadowOffsetY=Math.max(1,2/Math.sqrt(x)),e.beginPath(),e.moveTo($+T,k),e.lineTo($+M-T,k),e.arcTo($+M,k,$+M,k+T,T),e.lineTo($+M,k+C-T),e.arcTo($+M,k+C,$+M-T,k+C,T),e.lineTo($+T,k+C),e.arcTo($,k+C,$,k+C-T,T),e.lineTo($,k+T),e.arcTo($,k,$+T,k,T),e.closePath(),e.fillStyle=s?"rgba(59, 130, 246, 0.95)":"rgba(0, 0, 0, 0.85)",e.fill(),e.strokeStyle=v,e.lineWidth=Math.max(1,1.5/this.state.scale),e.stroke(),e.shadowBlur=0,e.fillStyle="#ffffff",e.fillText(w,a,n-m-1.5*I),g>=0&&!s){const t=Math.max(10,14/this.state.scale),i=a+.7*f,s=n-m+f-.7*f;e.beginPath(),e.arc(i,s,t,0,2*Math.PI),e.fillStyle=0===g?"#dc2626":g<b?"#d97706":"#059669",e.fill(),e.strokeStyle="#ffffff",e.lineWidth=Math.max(1,2/this.state.scale),e.stroke();const r=Math.max(9,12/this.state.scale);e.font=`bold ${r}px "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillStyle="#ffffff",e.fillText(g.toString(),i,s)}if(d>1&&l&&!s){const t=Math.max(9,12/this.state.scale),i=a-.7*f,s=n-m+f-.7*f;e.beginPath(),e.arc(i,s,t,0,2*Math.PI),e.fillStyle="#222222",e.fill(),e.strokeStyle="#ffffff",e.lineWidth=Math.max(1,1.5/this.state.scale),e.stroke();const r=Math.max(8,10/this.state.scale);e.font=`bold ${r}px monospace`,e.textAlign="center",e.textBaseline="middle",e.fillStyle="#ffffff",e.fillText(`#${l}`,i,s)}if(s){const t=Math.max(10,14/this.state.scale);e.font=`bold ${t}px "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="top",e.fillStyle="#3b82f6",e.strokeStyle="#ffffff",e.lineWidth=3/this.state.scale,e.strokeText(" ARRASTRANDO",a,n+10/this.state.scale),e.fillText(" ARRASTRANDO",a,n+10/this.state.scale)}e.restore()},dibujarUbicacionesResaltadas(e){if(!this.state.ubicacionesResaltadas||0===this.state.ubicacionesResaltadas.length)return;if(this.state.marcadorArrastre&&this.state.marcadorArrastre.iniciado)return;const t=Date.now();if((!this.state.ultimaAnimacion||t-this.state.ultimaAnimacion>100)&&(this.state.ultimaAnimacion=t,this.state.pulsoAnimacion=(this.state.pulsoAnimacion||0)+.15),this.state.ubicacionesResaltadas.forEach(({x:t,y:a,repuesto:n,descripcion:i},s)=>{const r=.3*Math.sin(this.state.pulsoAnimacion+.5*s)+.7,o=Math.max(25,40/this.state.scale)*r;e.beginPath(),e.arc(t,a,o,0,2*Math.PI),e.strokeStyle=`rgba(59, 130, 246, ${.5*r})`,e.lineWidth=Math.max(2,4/this.state.scale),e.stroke();const l=Math.max(10,15/this.state.scale);e.beginPath(),e.arc(t,a,l,0,2*Math.PI),e.fillStyle="#3b82f6",e.fill(),e.strokeStyle="#ffffff",e.lineWidth=Math.max(2,3/this.state.scale),e.stroke(),e.beginPath(),e.arc(t,a,.3*l,0,2*Math.PI),e.fillStyle="#ffffff",e.fill()}),this.state.ubicacionesResaltadas&&this.state.ubicacionesResaltadas.length>0&&!this.state.animacionResaltadaActiva){this.state.animacionResaltadaActiva=!0;const e=()=>{this.state.ubicacionesResaltadas&&this.state.ubicacionesResaltadas.length>0?(this.draw(),requestAnimationFrame(e)):this.state.animacionResaltadaActiva=!1};requestAnimationFrame(e)}},async guardarNuevaPosicionMarcador(e,t,a){const{repuesto:n,ubicacionIndex:i,ubicacion:s}=e,r=this.buscarAreasCercanas(t,a,300);if(0===r.length)return this.showToast(" No hay reas cercanas. Coloca el marcador dentro de un rea.","warning"),void this.draw();const o=r[0].area;if(n.ubicaciones&&Array.isArray(n.ubicaciones)){const e=n.ubicaciones[i];e&&(e.markerX=t,e.markerY=a,e.areaId=o.id)}try{await c.saveData(),this.showToast(` Posicin actualizada en "${o.name}"`,"success"),this.draw()}catch(l){this.showToast(" Error al guardar la nueva posicin","error"),n.ubicaciones&&n.ubicaciones[i]&&(n.ubicaciones[i].markerX=s.markerX,n.ubicaciones[i].markerY=s.markerY,n.ubicaciones[i].areaId=s.areaId),this.draw()}},drawTempShape(e){if(this.state.drawing&&0!==this.state.tempPoints.length){if(e.save(),e.strokeStyle="rgba(59, 130, 246, 1)",e.fillStyle="rgba(59, 130, 246, 0.25)",e.lineWidth=Math.max(3,3/this.state.scale),e.lineCap="round",e.lineJoin="round",e.shadowColor="rgba(59, 130, 246, 0.5)",e.shadowBlur=10,e.shadowOffsetX=0,e.shadowOffsetY=0,e.beginPath(),this.state.tempPoints.forEach((t,a)=>{0===a?e.moveTo(t.x,t.y):e.lineTo(t.x,t.y)}),this.state.previewPoint&&e.lineTo(this.state.previewPoint.x,this.state.previewPoint.y),this.state.tempPoints.length>=2&&e.fill(),e.stroke(),e.shadowBlur=0,this.state.tempPoints.forEach((t,a)=>{const n=Math.max(6,8/this.state.scale);e.beginPath(),e.arc(t.x,t.y,n+2/this.state.scale,0,2*Math.PI),e.fillStyle="#ffffff",e.fill(),e.beginPath(),e.arc(t.x,t.y,n,0,2*Math.PI),e.fillStyle=0===a?"#facc15":"#3b82f6",e.fill(),this.state.tempPoints.length>2&&(e.fillStyle="#ffffff",e.font=`bold ${Math.max(10,12/this.state.scale)}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText((a+1).toString(),t.x,t.y))}),this.state.previewPoint&&this.state.tempPoints.length>0){const t=Math.max(4,6/this.state.scale);e.beginPath(),e.arc(this.state.previewPoint.x,this.state.previewPoint.y,t,0,2*Math.PI),e.fillStyle="rgba(59, 130, 246, 0.5)",e.fill(),e.strokeStyle="#3b82f6",e.lineWidth=2/this.state.scale,e.stroke()}e.restore()}},drawEditPoints(e){if(!this.state.editingAreaId||!this.state.editingPoints.length)return;e.save();const t=Math.max(3,3/this.state.scale),a=Math.max(16,16/this.state.scale),n=Math.max(22,22/this.state.scale);e.beginPath(),this.state.editingPoints.forEach((t,a)=>{0===a?e.moveTo(t.x,t.y):e.lineTo(t.x,t.y)}),e.closePath(),e.strokeStyle="#f59e0b",e.lineWidth=t,e.setLineDash([10/this.state.scale,5/this.state.scale]),e.stroke(),e.setLineDash([]),this.state.editingPoints.forEach((t,i)=>{const s=i===this.state.selectedPointIndex,r=s&&this.state.isDraggingPoint,o=s?n:a;r?(e.shadowColor="rgba(245, 158, 11, 0.6)",e.shadowBlur=20/this.state.scale):(e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=15/this.state.scale),e.shadowOffsetX=3/this.state.scale,e.shadowOffsetY=3/this.state.scale,e.beginPath(),e.arc(t.x,t.y,o,0,2*Math.PI),e.fillStyle=r?"rgba(245, 158, 11, 0.7)":s?"rgba(251, 146, 60, 0.7)":"rgba(59, 130, 246, 0.6)",e.fill(),e.shadowColor="transparent",e.shadowBlur=0,e.strokeStyle="white",e.lineWidth=3/this.state.scale,e.stroke(),e.beginPath(),e.arc(t.x,t.y,.4*o,0,2*Math.PI),e.fillStyle="rgba(255, 255, 255, 0.9)",e.fill(),s&&(e.beginPath(),e.arc(t.x,t.y,.65*o,0,2*Math.PI),e.strokeStyle=r?"#fbbf24":"#fb923c",e.lineWidth=2/this.state.scale,e.stroke());const l=Math.max(16,16/this.state.scale);e.font=`bold ${l}px sans-serif`,e.textAlign="center",e.textBaseline="middle";const d=t.y-o-14/this.state.scale,c=String(i+1),p=e.measureText(c),u=5/this.state.scale,m=p.width+2*u,h=l+2*u;e.fillStyle=s?"rgba(245, 158, 11, 0.85)":"rgba(0, 0, 0, 0.75)";const g=t.x-m/2,b=d-h/2,v=5/this.state.scale;e.beginPath(),e.roundRect(g,b,m,h,v),e.fill(),e.strokeStyle=s?"#fbbf24":"white",e.lineWidth=2/this.state.scale,e.stroke(),e.fillStyle="white",e.fillText(c,t.x,d)}),e.restore()},drawReshapeHandles(e){if(!this.state.reshapeAreaId||!this.state.reshapePoints.length)return;e.save();const t=Math.max(3,3/this.state.scale),a=Math.max(8,8/this.state.scale),n=Math.max(12,12/this.state.scale),i=Math.max(10,10/this.state.scale);if(e.beginPath(),this.state.reshapePoints.forEach((t,a)=>{0===a?e.moveTo(t.x,t.y):e.lineTo(t.x,t.y)}),e.closePath(),e.strokeStyle="#3b82f6",e.lineWidth=t,e.setLineDash([8/this.state.scale,4/this.state.scale]),e.stroke(),e.setLineDash([]),null!==this.state.hoveredEdgeIndex&&-1!==this.state.hoveredEdgeIndex){const n=this.state.reshapePoints[this.state.hoveredEdgeIndex],i=this.state.reshapePoints[(this.state.hoveredEdgeIndex+1)%this.state.reshapePoints.length];e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(i.x,i.y),e.strokeStyle="#10b981",e.lineWidth=1.5*t,e.stroke();const s=(n.x+i.x)/2,r=(n.y+i.y)/2;e.beginPath(),e.arc(s,r,.8*a,0,2*Math.PI),e.fillStyle="rgba(16, 185, 129, 0.3)",e.fill(),e.strokeStyle="#10b981",e.lineWidth=2/this.state.scale,e.stroke()}if(this.state.reshapePoints.forEach((t,s)=>{const r=s===this.state.selectedPointIndex,o=s===this.state.hoveredPointIndex,l=r&&this.state.isDraggingPoint;let d=a;r?d=n:o&&(d=i),e.shadowColor=l?"rgba(59, 130, 246, 0.6)":"rgba(0, 0, 0, 0.3)",e.shadowBlur=l?12/this.state.scale:6/this.state.scale,e.shadowOffsetX=2/this.state.scale,e.shadowOffsetY=2/this.state.scale,e.beginPath(),e.arc(t.x,t.y,d,0,2*Math.PI),e.fillStyle=l?"#3b82f6":r?"#60a5fa":o?"#93c5fd":"rgba(255, 255, 255, 0.9)",e.fill(),e.shadowColor="transparent",e.shadowBlur=0,e.strokeStyle=r||l?"#3b82f6":"#64748b",e.lineWidth=2/this.state.scale,e.stroke(),(r||o)&&(e.beginPath(),e.arc(t.x,t.y,.4*d,0,2*Math.PI),e.fillStyle="#3b82f6",e.fill());const c=Math.max(10,10/this.state.scale);e.font=`bold ${c}px sans-serif`,e.textAlign="center",e.textBaseline="middle";const p=t.y-d-10/this.state.scale,u=String(s+1),m=e.measureText(u),h=3/this.state.scale,g=m.width+2*h,b=c+h;e.fillStyle=r?"#3b82f6":"rgba(0, 0, 0, 0.7)";const v=t.x-g/2,y=p-b/2;e.beginPath(),e.roundRect(v,y,g,b,3/this.state.scale),e.fill(),e.fillStyle="white",e.fillText(u,t.x,p)}),this.state.reshapeAreaId){e.restore(),e.save(),e.setTransform(1,0,0,1,0,0);const t=10,a=this.elements.canvas.height-100,n=280,i=90;e.fillStyle="rgba(15, 23, 42, 0.95)",e.beginPath(),e.roundRect(t,a,n,i,8),e.fill(),e.strokeStyle="#3b82f6",e.lineWidth=2,e.stroke(),e.fillStyle="#e2e8f0",e.font="bold 12px sans-serif",e.textAlign="left",e.fillText(" Modo Edicin de Puntos",t+12,a+20),e.font="11px sans-serif",e.fillStyle="#cbd5e1",e.fillText(" Arrastra puntos para moverlos",t+12,a+40),e.fillText(" Click en borde para agregar punto",t+12,a+55),e.fillText(" Selecciona + Delete para eliminar",t+12,a+70);const s=a+i+10,r=32,o={x:t,y:s,width:100,height:r};e.fillStyle="#10b981",e.beginPath(),e.roundRect(o.x,o.y,o.width,o.height,6),e.fill(),e.fillStyle="white",e.font="bold 12px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(" Guardar (Enter)",o.x+o.width/2,o.y+o.height/2);const l={x:t+110,y:s,width:100,height:r};return e.fillStyle="#ef4444",e.beginPath(),e.roundRect(l.x,l.y,l.width,l.height,6),e.fill(),e.fillStyle="white",e.fillText(" Cancelar (Esc)",l.x+l.width/2,l.y+l.height/2),void e.restore()}e.restore()},drawMinimap(){if(!this.minimapCtx||!this.elements.minimap)return;const e=this.getMinimapBitmap();if(!e)return;const t=this.elements.minimap,a=this.minimapCtx,n=this.elements.minimapContainer,i=n.offsetWidth,s=n.offsetHeight;t.width===i&&t.height===s||(t.width=i,t.height=s),a.clearRect(0,0,t.width,t.height),a.fillStyle="rgba(15, 23, 42, 0.5)",a.fillRect(0,0,t.width,t.height);const r=this.getMapDimensionsSafe();if(!r.width||!r.height)return;const o=r.width,l=r.height,d=t.width/o,c=t.height/l,p=.95*Math.min(d,c),u=o*p,m=l*p,h=(t.width-u)/2,g=(t.height-m)/2;a.save(),a.translate(h,g),a.scale(p,p),a.globalAlpha=.6,a.drawImage(e,0,0,e.width,e.height,0,0,o,l),a.globalAlpha=1,this.state.areas.forEach(e=>{!Array.isArray(e.points)||e.points.length<3||(a.beginPath(),e.points.forEach((e,t)=>{0===t?a.moveTo(e.x,e.y):a.lineTo(e.x,e.y)}),a.closePath(),a.fillStyle=e.color?`${e.color}40`:"rgba(59, 130, 246, 0.25)",a.fill(),a.strokeStyle=e.color||"#3b82f6",a.lineWidth=1.5/p,a.stroke())}),a.restore();const b=this.elements.minimapViewport;if(b){const e=this.elements.canvas,a=-this.state.offsetX/this.state.scale,n=-this.state.offsetY/this.state.scale,i=e.width/this.state.scale,s=e.height/this.state.scale,r=h+a*p,o=g+n*p,l=i*p,d=s*p;b.style.left=`${Math.max(0,Math.min(r,t.width))}px`,b.style.top=`${Math.max(0,Math.min(o,t.height))}px`,b.style.width=`${Math.max(0,Math.min(l,t.width-r))}px`,b.style.height=`${Math.max(0,Math.min(d,t.height-o))}px`}},registerCanvasEvents(){const e=this.elements.canvas;e&&(e.addEventListener("mousedown",t=>{if(0===t.button){const a=e.getBoundingClientRect(),n=t.clientX-a.left,i=t.clientY-a.top,s=(n-this.state.offsetX)/this.state.scale,r=(i-this.state.offsetY)/this.state.scale;if(this.state.mostrarNombresAreas&&!this.state.drawing&&!this.state.editingAreaId&&!this.state.modoAgregarMarcadorActivo){let e=!1,a=null;for(const t of this.state.areas){if(!Array.isArray(t.points)||t.points.length<3)continue;const n=this.calculateCentroid(t.points);if(!n)continue;const i=t.labelOffsetX||0,o=t.labelOffsetY||0,l=n.x+i,d=n.y+o,c=t.name||"rea",p=20,u=[];if(c.length<=p)u.push(c);else{const e=c.split(" ");let t="";e.forEach((a,n)=>{const i=t?`${t} ${a}`:a;i.length<=p?t=i:(t&&u.push(t),t=a),n===e.length-1&&t&&u.push(t)})}const m=28,h=14,g=this.state.zoom||1,b=Math.max(h,m/Math.sqrt(g)),v=Math.max(...u.map(e=>e.length))*b*.6,y=1.2*b*u.length,f=v+2*Math.max(6,12/Math.sqrt(g)),x=y+2*Math.max(4,8/Math.sqrt(g)),S=l-f/2,w=d-x/2;if(s>=S&&s<=S+f&&r>=w&&r<=w+x){e=!0,a=t;break}}if(e&&a)return this.state.tooltipPinned&&this.state.pinnedAreaId===a.id?(this.state.tooltipPinned=!1,this.state.pinnedAreaId=null,this.state.highlightAreaId=null,this.elements.tooltip.classList.add("hidden"),this.scheduleRender()):(this.state.tooltipPinned=!0,this.state.pinnedAreaId=a.id,this.state.highlightAreaId=a.id,this.updateTooltip(t),this.scheduleRender()),t.preventDefault(),void t.stopPropagation();!e&&this.state.tooltipPinned&&(this.state.tooltipPinned=!1,this.state.pinnedAreaId=null,this.state.highlightAreaId=null,this.elements.tooltip.classList.add("hidden"),this.scheduleRender()),e||this.clearMarkerSelection()}if(this.state.modoAgregarMarcadorActivo){const e=this.state.areas||[];if(0===e.length)return this.showToast(" Este mapa no tiene reas definidas","warning"),t.preventDefault(),void t.stopPropagation();let a=null;for(const t of e){if(this.puntoEnArea(s,r,t)){a=t;break}}return a?this.abrirModalBusquedaRepuesto(s,r,a):this.showToast(" Debes hacer click dentro de un rea","warning"),t.preventDefault(),void t.stopPropagation()}if(this.state.pinAMover&&this.state.pinAMover.editando){const a=this.detectarClickEnMarcador(s,r);if(a&&String(a.repuesto.id)===String(this.state.pinAMover.repuestoId)&&a.ubicacionIndex===this.state.pinAMover.ubicacionIndex)return this.state.marcadorArrastre={info:a,iniciado:!0,inicioX:n,inicioY:i,tiempoInicio:Date.now(),mapX:s,mapY:r,esEdicionPin:!0},e.style.cursor="grabbing",t.preventDefault(),void t.stopPropagation()}if(!this.state.isReshapeMode&&!this.state.pinAMover){const e=this.detectarClickEnMarcador(s,r);if(e){const a=document.getElementById("tarjetaHoverRepuesto");return a&&a.remove(),this.state.abriendo_tarjeta_fija=!0,setTimeout(()=>{this.fijarTarjetaHoverRepuesto(e,n,i),setTimeout(()=>{this.state.abriendo_tarjeta_fija=!1},150)},10),t.preventDefault(),void t.stopPropagation()}this.state.abriendo_tarjeta_fija||this.cerrarTarjetaFija()}if(this.state.modoMarcador&&this.state.marcadorPendiente)return void this.colocarMarcador(s,r);if(this.state.isReshapeMode&&this.state.reshapeAreaId){const a=e.getBoundingClientRect(),n=t.clientX-a.left,i=t.clientY-a.top,s=e.height-100+90+10,r=32;if(n>=10&&n<=110&&i>=s&&i<=s+r)return void this.saveReshapeChanges();if(n>=120&&n<=220&&i>=s&&i<=s+r)return void this.cancelReshape()}if(this.state.isReshapeMode){const e=this.detectarClickEnMarcador(s,r);if(e)return this.state.marcadorArrastre={info:e,iniciado:!1,inicioX:n,inicioY:i,tiempoInicio:Date.now(),modoEdicion:!0},t.preventDefault(),void t.stopPropagation();const a=this.state.reshapeAreaId?this.findPointAtCursor((t.clientX-this.elements.canvas.getBoundingClientRect().left-this.state.offsetX)/this.state.scale,(t.clientY-this.elements.canvas.getBoundingClientRect().top-this.state.offsetY)/this.state.scale):-1;-1!==a?(this.state.selectedPointIndex=a,this.state.isDraggingPoint=!0):this.handleReshapeClick(t)}else!this.state.isMultiSelectMode||this.state.drawing||this.state.editingAreaId?this.state.editingAreaId?this.handleEditPointMouseDown(t):this.state.drawing?this.addPoint(t):this.beginPan(t):this.handleMultiSelectClick(t)}}),e.addEventListener("mousemove",t=>{if(this.state.marcadorArrastre&&!this.state.marcadorArrastre.iniciado){const a=e.getBoundingClientRect(),n=t.clientX-a.left,i=t.clientY-a.top;Math.sqrt(Math.pow(n-this.state.marcadorArrastre.inicioX,2)+Math.pow(i-this.state.marcadorArrastre.inicioY,2))>5&&(this.state.marcadorArrastre.iniciado=!0,e.style.cursor="grabbing")}if(this.state.marcadorArrastre&&this.state.marcadorArrastre.iniciado){const a=e.getBoundingClientRect(),n=t.clientX-a.left,i=t.clientY-a.top,s=(n-this.state.offsetX)/this.state.scale,r=(i-this.state.offsetY)/this.state.scale;return this.state.marcadorArrastre.mapX=s,this.state.marcadorArrastre.mapY=r,this.state.marcadorArrastre.esEdicionPin&&(this.state.ubicacionesResaltadas=[{x:s,y:r,repuesto:"Nueva posicin",descripcion:"Suelta aqu para guardar"}]),void requestAnimationFrame(()=>this.draw())}if(this.state.isReshapeMode&&this.state.reshapeAreaId)this.handleReshapeMouseMove(t);else if(this.state.isDraggingPoint)this.handleEditPointDrag(t);else if(this.state.editingAreaId)this.updateEditPointHover(t);else if(this.state.drawing)this.updatePreviewPoint(t);else if(this.state.isPanning)this.pan(t);else{const a=e.getBoundingClientRect(),n=t.clientX-a.left,i=t.clientY-a.top,s=(n-this.state.offsetX)/this.state.scale,r=(i-this.state.offsetY)/this.state.scale,o=this.detectarClickEnMarcador(s,r);o?(e.style.cursor=this.state.isReshapeMode?"grab":"pointer",this.mostrarTarjetaHoverRepuesto(o,n,i)):(e.style.cursor="default",this.ocultarTarjetaHoverRepuesto()),this.updateTooltip(t)}}),["mouseup","mouseleave"].forEach(t=>{e.addEventListener(t,t=>{if(this.state.marcadorArrastre){if(this.state.marcadorArrastre.iniciado){const a=e.getBoundingClientRect(),n=t.clientX-a.left,i=t.clientY-a.top,s=(n-this.state.offsetX)/this.state.scale,r=(i-this.state.offsetY)/this.state.scale;this.state.marcadorArrastre.esEdicionPin?e.style.cursor="grab":(this.guardarNuevaPosicionMarcador(this.state.marcadorArrastre.info,s,r),e.style.cursor="default")}else if(this.state.marcadorArrastre.modoEdicion);else if(!this.state.marcadorArrastre.esEdicionPin){Date.now()-this.state.marcadorArrastre.tiempoInicio<300&&this.mostrarMenuMarcador(this.state.marcadorArrastre.info,this.state.marcadorArrastre.inicioX,this.state.marcadorArrastre.inicioY)}this.state.marcadorArrastre=null}else this.state.isReshapeMode&&this.state.isDraggingPoint?(this.state.isDraggingPoint=!1,this.draw()):this.state.isDraggingPoint&&this.handleEditPointMouseUp(),this.endPan()})}),e.addEventListener("wheel",e=>this.handleWheel(e),{passive:!1}),e.addEventListener("dblclick",e=>{this.state.editingAreaId?e.preventDefault():this.state.drawing?(e.preventDefault(),this.finishDrawing()):(this.state.repuestoFiltrado||this.state.ubicacionesResaltadas.length>0)&&(this.state.repuestoFiltrado=null,this.state.ubicacionesResaltadas=[],this.showToast(" Filtro limpiado - Mostrando todos los repuestos","success",2e3),this.draw())}),e.addEventListener("contextmenu",e=>{this.state.editingAreaId?e.preventDefault():this.state.drawing&&(e.preventDefault(),this.finishDrawing())}),document.addEventListener("keydown",e=>{if(this.state.currentMap){if(this.state.isReshapeMode&&this.state.reshapeAreaId){if("Delete"===e.key&&null!==this.state.selectedPointIndex)return e.preventDefault(),void this.deleteSelectedPoint();if("Enter"===e.key)return e.preventDefault(),void this.saveReshapeChanges();if("Escape"===e.key)return e.preventDefault(),void this.cancelReshape()}e.ctrlKey&&"a"===e.key&&this.state.isMultiSelectMode&&(e.preventDefault(),this.selectAllAreas()),"Escape"===e.key&&this.state.selectedAreaIds.length>0&&(e.preventDefault(),this.deselectAllAreas()),"Delete"===e.key&&this.state.selectedAreaIds.length>0&&this.state.isMultiSelectMode&&(e.preventDefault(),this.batchDeleteAreas()),e.ctrlKey&&"b"===e.key&&this.state.selectedAreaIds.length>0&&(e.preventDefault(),this.openBatchOperationsModal())}}))},beginPan(e){const{canvasX:t,canvasY:a}=this.getCanvasCoordinates(e);this.state.isPanning=!0,this.state.panStartX=t-this.state.offsetX,this.state.panStartY=a-this.state.offsetY,this.elements.canvas.style.cursor="grabbing"},pan(e){if(!this.state.isPanning)return;const{canvasX:t,canvasY:a}=this.getCanvasCoordinates(e);this.state.offsetX=t-this.state.panStartX,this.state.offsetY=a-this.state.panStartY,this.scheduleRender(),this.viewportChangedDuringPan=!0},endPan(){this.state.isPanning&&(this.state.isPanning=!1,this.elements.canvas.style.cursor=this.state.drawing?"crosshair":"grab",this.viewportChangedDuringPan&&(this.viewportChangedDuringPan=!1,this.queueViewportPersist("pan")))},handleWheel(e){if(!this.state.currentImage)return;e.preventDefault();const t=e.deltaY>0?.85:1.15,a=this.getCanvasCoordinates(e);this.zoomAt(a.canvasX,a.canvasY,t)},handleEditPointMouseDown(e){if(!this.state.editingAreaId||!this.state.editingPoints.length)return;const{canvasX:t,canvasY:a}=this.getCanvasCoordinates(e);let n=-1,i=1/0;this.state.editingPoints.forEach((e,s)=>{const r=e.x*this.state.scale+this.state.offsetX,o=e.y*this.state.scale+this.state.offsetY,l=r-t,d=o-a,c=Math.sqrt(l*l+d*d);c<50&&c<i&&(i=c,n=s)}),-1!==n&&(this.state.selectedPointIndex=n,this.state.isDraggingPoint=!0,this.elements.canvas.style.cursor="grabbing",this.draw())},handleEditPointDrag(e){if(!this.state.isDraggingPoint||null===this.state.selectedPointIndex)return;const{mapX:t,mapY:a}=this.getMapPoint(e);Number.isFinite(t)&&Number.isFinite(a)&&(this.state.editingPoints[this.state.selectedPointIndex]={x:t,y:a},this.scheduleRender())},handleEditPointMouseUp(){this.state.isDraggingPoint&&(this.state.isDraggingPoint=!1,this.elements.canvas.style.cursor="grab",this.scheduleRender())},updateEditPointHover(e){if(!this.state.editingAreaId||!this.state.editingPoints.length||this.state.isDraggingPoint)return;const{canvasX:t,canvasY:a}=this.getCanvasCoordinates(e);let n=!1;for(const i of this.state.editingPoints){const e=i.x*this.state.scale+this.state.offsetX-t,s=i.y*this.state.scale+this.state.offsetY-a;if(Math.sqrt(e*e+s*s)<50){n=!0;break}}this.elements.canvas.style.cursor=n?"grab":"default"},updateTooltip(e){const t=this.elements.tooltip;if(!t||!this.state.currentImage||this.state.drawing||this.state.editingAreaId)return void(t&&!this.state.tooltipPinned&&t.classList.add("hidden"));if(this.state.tooltipPinned&&this.state.pinnedAreaId){const t=this.state.areas.find(e=>e.id===this.state.pinnedAreaId);if(t)return void this.renderTooltipContent(t,e);this.state.tooltipPinned=!1,this.state.pinnedAreaId=null,this.state.highlightAreaId=null,this.scheduleRender()}const{canvasX:a,canvasY:n}=this.getCanvasCoordinates(e),i=(a-this.state.offsetX)/this.state.scale,s=(n-this.state.offsetY)/this.state.scale;let r=null;if(this.state.mostrarNombresAreas)for(const o of this.state.areas){if(!Array.isArray(o.points)||o.points.length<3)continue;const e=this.calculateCentroid(o.points);if(!e)continue;const t=o.labelOffsetX||0,a=o.labelOffsetY||0,n=e.x+t,l=e.y+a,d=o.name||"rea",c=20,p=[];if(d.length<=c)p.push(d);else{const e=d.split(" ");let t="";e.forEach((a,n)=>{const i=t?`${t} ${a}`:a;i.length<=c?t=i:(t&&p.push(t),t=a),n===e.length-1&&t&&p.push(t)})}const u=28,m=14,h=this.state.zoom||1,g=Math.max(m,u/Math.sqrt(h)),b=Math.max(...p.map(e=>e.length))*g*.6,v=1.2*g*p.length,y=b+2*Math.max(6,12/Math.sqrt(h)),f=v+2*Math.max(4,8/Math.sqrt(h)),x=n-y/2,S=l-f/2;if(i>=x&&i<=x+y&&s>=S&&s<=S+f){r=o;break}}r?this.renderTooltipContent(r,e):t.classList.add("hidden")},renderTooltipContent(e,t){const a=this.elements.tooltip;if(!a)return;const n=this.categories[e.category]||this.categories.area;let i=`\n      <div class="map-tooltip-title">\n        <span>${n.icon}</span>\n        <span>${e.name||"Sin nombre"}</span>\n      </div>\n      <div class="map-tooltip-category">${n.name}</div>\n    `;if(Array.isArray(e.equipos)&&e.equipos.length>0){i+=`\n        <div class="map-tooltip-equipos">\n          <strong>Equipos:</strong>\n          ${e.equipos.slice(0,3).join(", ")}${e.equipos.length>3?` (+${e.equipos.length-3} mas)`:""}\n        </div>\n      `}if(i+=`\n      ${this.state.tooltipPinned&&this.state.pinnedAreaId===e.id?'<div style="font-size: 0.7rem; color: #fbbf24; margin-top: 4px;"> Fijado (click para desfijar)</div>':'<div style="font-size: 0.7rem; color: #888; margin-top: 4px;">Click en el nombre para fijar</div>'}\n      <div style="display: flex; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">\n        <button onclick="mapController.startEditAreaPoints('${e.id}');" style="flex: 1; padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); cursor: pointer; font-size: 0.75rem;">\n          E Forma\n        </button>\n        <button onclick="mapController.openEditAreaMetadataModal('${e.id}');" style="flex: 1; padding: 4px 8px; background: var(--primary); border: none; border-radius: 3px; color: white; cursor: pointer; font-size: 0.75rem; font-weight: 500;">\n          C Datos\n        </button>\n        <button onclick="mapController.deleteArea('${e.id}');" style="padding: 4px 8px; background: #dc2626; border: none; border-radius: 3px; color: white; cursor: pointer; font-size: 0.75rem;">\n          X\n        </button>\n      </div>\n    `,a.innerHTML=i,this.state.tooltipPinned&&this.state.pinnedAreaId===e.id?a.classList.add("pinned"):a.classList.remove("pinned"),!this.state.tooltipPinned){const e=this.elements.canvasStage.getBoundingClientRect();let n=t.clientX-e.left+15,i=t.clientY-e.top+15;const s=a.getBoundingClientRect();n+s.width>e.width&&(n=t.clientX-e.left-s.width-15),i+s.height>e.height&&(i=t.clientY-e.top-s.height-15),a.style.left=`${n}px`,a.style.top=`${i}px`}a.classList.remove("hidden")},isPointInPolygon(e,t){let a=!1;for(let n=0,i=t.length-1;n<t.length;i=n++){const s=t[n].x,r=t[n].y,o=t[i].x,l=t[i].y;r>e.y!=l>e.y&&e.x<(o-s)*(e.y-r)/(l-r)+s&&(a=!a)}return a},zoomAt(e,t,a){const n=Math.max(this.state.minScale,Math.min(this.state.maxScale,this.state.scale*a));if(n===this.state.scale)return;const i=(e-this.state.offsetX)/this.state.scale,s=(t-this.state.offsetY)/this.state.scale;this.state.scale=n,this.state.offsetX=e-i*n,this.state.offsetY=t-s*n,this.updateZoomBadge(),this.draw(),this.queueViewportPersist("zoom")},handleToolbarAction(e){switch(e){case"zoom-in":this.zoomCentered(1.2);break;case"zoom-out":this.zoomCentered(1/1.2);break;case"reset-view":this.resetView();break;case"toggle-nombres-areas":this.toggleNombresAreas();break;case"toggle-puntos-repuestos":this.togglePuntosRepuestos();break;case"toggle-grid":this.toggleGrid();break;case"toggle-minimap":this.toggleMinimap();break;case"toggle-rulers":this.toggleRulers();break;case"toggle-multiselect":this.toggleMultiSelect();break;case"toggle-reshape":this.toggleReshape();break;case"recenter":this.recenter()}},zoomCentered(e){if(!this.state.currentImage)return;const t=this.elements.canvas,a=t.width/2,n=t.height/2;this.zoomAt(a,n,e)},resetView(){this.state.scale=1,this.state.offsetX=0,this.state.offsetY=0,this.updateZoomBadge(),this.draw(),this.queueViewportPersist("reset-view")},recenter(){if(!this.state.currentImage)return;const e=this.elements.canvas,t=this.state.currentImage.width/2*this.state.scale,a=this.state.currentImage.height/2*this.state.scale;this.state.offsetX=e.width/2-t,this.state.offsetY=e.height/2-a,this.draw(),this.queueViewportPersist("recenter")},toggleGrid(){this.state.showGrid=!this.state.showGrid,this.draw(),this.showToast(this.state.showGrid?"Rejilla activada.":"Rejilla desactivada.","info")},toggleNombresAreas(){this.state.mostrarNombresAreas=!this.state.mostrarNombresAreas,this.draw();const e=document.querySelector('[data-action="toggle-nombres-areas"]');e&&(e.style.background=this.state.mostrarNombresAreas?"#3b82f6":"",e.style.color=this.state.mostrarNombresAreas?"white":""),this.showToast(this.state.mostrarNombresAreas?" Nombres de reas visibles":" Nombres de reas ocultos","info")},togglePuntosRepuestos(){this.state.mostrarPuntosRepuestos=!this.state.mostrarPuntosRepuestos,this.draw();const e=document.querySelector('[data-action="toggle-puntos-repuestos"]');e&&(this.state.mostrarPuntosRepuestos?(e.style.background="linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",e.style.color="white",e.style.fontWeight="bold",e.style.boxShadow="0 4px 12px rgba(59, 130, 246, 0.4)",e.style.transform="scale(1.0)"):(e.style.background="linear-gradient(135deg, #4b5563 0%, #374151 100%)",e.style.color="#d1d5db",e.style.fontWeight="normal",e.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.3), inset 0 0 0 2px rgba(239, 68, 68, 0.5)",e.style.transform="scale(0.95)"),e.style.transition="all 0.3s ease"),this.showToast(this.state.mostrarPuntosRepuestos?" Todos los puntos visibles":" Solo marcador seleccionado","info")},syncButtonStates(){const e=document.querySelector('[data-action="toggle-puntos-repuestos"]');e&&(this.state.mostrarPuntosRepuestos?(e.style.background="linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",e.style.color="white",e.style.fontWeight="bold",e.style.boxShadow="0 4px 12px rgba(59, 130, 246, 0.4)",e.style.transform="scale(1.0)"):(e.style.background="linear-gradient(135deg, #4b5563 0%, #374151 100%)",e.style.color="#d1d5db",e.style.fontWeight="normal",e.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.3), inset 0 0 0 2px rgba(239, 68, 68, 0.5)",e.style.transform="scale(0.95)"),e.style.transition="all 0.3s ease");const t=document.querySelector('[data-action="toggle-nombres-areas"]');t&&(t.style.background=this.state.mostrarNombresAreas?"#3b82f6":"",t.style.color=this.state.mostrarNombresAreas?"white":"")},toggleMinimap(){this.state.showMinimap=!this.state.showMinimap,this.elements.minimapContainer&&(this.state.showMinimap?(this.elements.minimapContainer.classList.remove("hidden"),this.drawMinimap()):this.elements.minimapContainer.classList.add("hidden")),this.showToast(this.state.showMinimap?"Minimap activado.":"Minimap desactivado.","info")},handleMinimapClick(e){if(!this.state.currentImage||!this.elements.minimap)return;const t=this.elements.minimap,a=t.getBoundingClientRect(),n=e.clientX-a.left,i=e.clientY-a.top,s=this.state.currentImage.width,r=this.state.currentImage.height,o=t.width/s,l=t.height/r,d=.95*Math.min(o,l),c=s*d,p=r*d,u=(n-(t.width-c)/2)/d,m=(i-(t.height-p)/2)/d,h=this.elements.canvas;this.state.offsetX=-u*this.state.scale+h.width/2,this.state.offsetY=-m*this.state.scale+h.height/2,this.draw(),this.queueViewportPersist("minimap")},toggleRulers(){this.state.showRulers=!this.state.showRulers,this.draw(),this.showToast(this.state.showRulers?"Reglas activadas.":"Reglas desactivadas.","info")},toggleMultiSelect(){this.state.isMultiSelectMode=!this.state.isMultiSelectMode;const e=document.getElementById("mapMultiSelectBtn");this.state.isMultiSelectMode?(e.classList.add("map-btn--primary"),e.textContent=" Modo Activo",this.showHint("Modo seleccin mltiple: Click en reas para seleccionar/deseleccionar. Ctrl+A para seleccionar todas.")):(e.classList.remove("map-btn--primary"),e.textContent=" Seleccin Mltiple",this.state.selectedAreaIds=[],this.updateSelectionBadge(),this.hideHint()),this.draw(),this.showToast(this.state.isMultiSelectMode?" Modo seleccin mltiple activado":" Modo seleccin mltiple desactivado","info")},updateSelectionBadge(){const e=document.getElementById("mapSelectionBadge");e&&(this.state.selectedAreaIds.length>0?(e.textContent=`${this.state.selectedAreaIds.length} seleccionada${1!==this.state.selectedAreaIds.length?"s":""}`,e.style.display="block"):e.style.display="none")},toggleAreaSelection(e){const t=this.state.selectedAreaIds.indexOf(e);t>-1?this.state.selectedAreaIds.splice(t,1):this.state.selectedAreaIds.push(e),this.updateSelectionBadge(),this.draw()},selectAllAreas(){this.state.selectedAreaIds=this.state.areas.map(e=>e.id),this.updateSelectionBadge(),this.draw(),this.showToast(` ${this.state.selectedAreaIds.length} reas seleccionadas`,"success")},deselectAllAreas(){this.state.selectedAreaIds=[],this.updateSelectionBadge(),this.draw(),this.showToast(" Seleccin limpiada","info")},openBatchOperationsModal(){if(0===this.state.selectedAreaIds.length)return void this.showToast(" No hay reas seleccionadas","warning");const e=this.elements.modal,t=this.elements.modalBody;if(!e||!t)return;this.elements.modalTitle.textContent=`Operaciones en lote (${this.state.selectedAreaIds.length} reas)`;const a=Object.entries(this.categories).map(([e,t])=>`<option value="${e}">${t.icon} ${t.name}</option>`).join("");t.innerHTML=`\n      <form id="batchOperationsForm" class="map-area-form">\n        <p style="color: var(--text-secondary); margin-bottom: 16px;">\n          Aplicar cambios a <strong>${this.state.selectedAreaIds.length}</strong> rea(s) seleccionada(s):\n        </p>\n\n        <div class="form-group">\n          <label>Cambiar categora</label>\n          <select name="batchCategory" id="batchCategory">\n            <option value="">No cambiar</option>\n            ${a}\n          </select>\n        </div>\n\n        <div class="form-group">\n          <label>Cambiar color</label>\n          <div style="display: flex; gap: 10px; align-items: center;">\n            <input type="checkbox" id="batchColorEnable" style="width: auto;">\n            <input type="color" name="batchColor" id="batchColor" value="#3b82f6" disabled />\n            <span id="batchColorHex" style="font-family: monospace; color: var(--text-secondary);">#3b82f6</span>\n          </div>\n        </div>\n\n        <div class="form-group">\n          <label>Cambiar opacidad</label>\n          <div style="display: flex; gap: 10px; align-items: center;">\n            <input type="checkbox" id="batchOpacityEnable" style="width: auto;">\n            <input type="range" name="batchOpacity" id="batchOpacity" min="10" max="90" value="35" disabled />\n            <span id="batchOpacityValue" style="min-width: 40px; color: var(--text-secondary);">35%</span>\n          </div>\n        </div>\n\n        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">\n\n        <div class="form-actions">\n          <button type="button" class="map-btn map-btn--danger" onclick="mapController.batchDeleteAreas()">\n             Eliminar todas\n          </button>\n          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>\n          <button type="submit" class="map-btn map-btn--primary">Aplicar cambios</button>\n        </div>\n      </form>\n    `,e.classList.remove("hidden");const n=document.getElementById("batchColorEnable"),i=document.getElementById("batchColor"),s=document.getElementById("batchColorHex");n.addEventListener("change",()=>{i.disabled=!n.checked}),i.addEventListener("input",()=>{s.textContent=i.value});const r=document.getElementById("batchOpacityEnable"),o=document.getElementById("batchOpacity"),l=document.getElementById("batchOpacityValue");r.addEventListener("change",()=>{o.disabled=!r.checked}),o.addEventListener("input",()=>{l.textContent=`${o.value}%`});const d=t.querySelector('[data-action="cancel"]');d&&d.addEventListener("click",()=>this.closeModal());const c=t.querySelector("#batchOperationsForm");c&&c.addEventListener("submit",e=>{e.preventDefault(),this.applyBatchOperations(new FormData(c))})},applyBatchOperations(e){const t=e.get("batchCategory"),a=document.getElementById("batchColorEnable").checked,n=e.get("batchColor"),i=document.getElementById("batchOpacityEnable").checked,s=parseInt(e.get("batchOpacity"))/100;this.state.areas.forEach(e=>{this.state.selectedAreaIds.includes(e.id)&&(t&&(e.category=t),a&&(e.color=n),i&&(e.opacity=s))}),this.saveAreas(),this.draw(),this.renderAreasList(),this.closeModal(),this.showToast(` Cambios aplicados a ${this.state.selectedAreaIds.length} rea(s)`,"success")},batchDeleteAreas(){confirm(`Eliminar ${this.state.selectedAreaIds.length} rea(s) seleccionada(s)?\n\nEsta accin no se puede deshacer.`)&&(this.state.areas=this.state.areas.filter(e=>!this.state.selectedAreaIds.includes(e.id)),this.state.selectedAreaIds=[],this.updateSelectionBadge(),this.saveAreas(),this.draw(),this.renderAreasList(),this.closeModal(),this.showToast(" reas eliminadas correctamente","success"))},handleMultiSelectClick(e){const{canvasX:t,canvasY:a}=this.getCanvasCoordinates(e),n=(t-this.state.offsetX)/this.state.scale,i=(a-this.state.offsetY)/this.state.scale,s=this.findAreaAtPoint(n,i);s&&this.toggleAreaSelection(s.id),e.stopPropagation()},findAreaAtPoint(e,t){for(let a=this.state.areas.length-1;a>=0;a--){const n=this.state.areas[a];if(this.isPointInPolygon({x:e,y:t},n.points))return n}return null},toggleReshape(){this.state.isReshapeMode=!this.state.isReshapeMode;const e=document.getElementById("mapReshapeBtn");this.state.isReshapeMode?(this.state.isMultiSelectMode&&this.toggleMultiSelect(),this.state.drawing&&this.cancelDrawing(),e.classList.add("map-btn--primary"),e.innerHTML=' Modo Activo <span class="info-icon"></span>',this.showHint("Modo Edicin: Click en un rea para editar puntos. Arrastra repuestos para reubicarlos. Click en bordes para agregar puntos, selecciona punto + Delete para eliminar.")):(e.classList.remove("map-btn--primary"),e.innerHTML=' Editar Ubicaciones <span class="info-icon"></span>',this.exitReshapeMode(),this.hideHint()),this.draw(),this.showToast(this.state.isReshapeMode?" Modo edicin activado - Puedes mover reas y repuestos":" Modo edicin desactivado","info")},exitReshapeMode(){this.state.reshapeAreaId=null,this.state.reshapePoints=[],this.state.selectedPointIndex=null,this.state.isDraggingPoint=!1,this.state.hoveredPointIndex=null,this.state.hoveredEdgeIndex=null},startReshapingArea(e){const t=this.state.areas.find(t=>t.id===e);t&&(this.state.reshapeAreaId=e,this.state.reshapePoints=JSON.parse(JSON.stringify(t.points)),this.draw(),this.showToast(` Editando rea: ${t.name}`,"info"))},saveReshapeChanges(){if(!this.state.reshapeAreaId||this.state.reshapePoints.length<3)return void this.showToast(" El rea debe tener mnimo 3 puntos","warning");const e=this.state.areas.find(e=>e.id===this.state.reshapeAreaId);e&&(e.points=JSON.parse(JSON.stringify(this.state.reshapePoints)),this.saveAreas(),this.showToast(" Cambios guardados correctamente","success")),this.exitReshapeMode(),this.draw()},cancelReshape(){this.exitReshapeMode(),this.draw(),this.showToast(" Edicin cancelada","info")},findPointAtCursor(e,t,a=10){if(!this.state.reshapeAreaId)return-1;const n=a/this.state.scale;for(let i=0;i<this.state.reshapePoints.length;i++){const a=this.state.reshapePoints[i],s=a.x-e,r=a.y-t;if(Math.sqrt(s*s+r*r)<n)return i}return-1},findEdgeAtCursor(e,t,a=15){if(!this.state.reshapeAreaId)return-1;const n=a/this.state.scale,i=this.state.reshapePoints;for(let s=0;s<i.length;s++){const a=i[s],r=i[(s+1)%i.length];if(this.pointToLineDistance(e,t,a.x,a.y,r.x,r.y)<n)return s}return-1},pointToLineDistance(e,t,a,n,i,s){const r=i-a,o=s-n,l=r*r+o*o;let d,c,p=-1;0!==l&&(p=((e-a)*r+(t-n)*o)/l),p<0?(d=a,c=n):p>1?(d=i,c=s):(d=a+p*r,c=n+p*o);const u=e-d,m=t-c;return Math.sqrt(u*u+m*m)},addPointToEdge(e,t,a){this.state.reshapePoints.splice(e+1,0,{x:t,y:a}),this.draw(),this.showToast(" Punto agregado","success")},deleteSelectedPoint(){null!==this.state.selectedPointIndex&&(this.state.reshapePoints.length<=3?this.showToast(" El rea debe tener mnimo 3 puntos","warning"):(this.state.reshapePoints.splice(this.state.selectedPointIndex,1),this.state.selectedPointIndex=null,this.draw(),this.showToast(" Punto eliminado","success")))},handleReshapeClick(e){const{canvasX:t,canvasY:a}=this.getCanvasCoordinates(e),n=(t-this.state.offsetX)/this.state.scale,i=(a-this.state.offsetY)/this.state.scale;if(!this.state.reshapeAreaId){const e=this.findAreaAtPoint(n,i);return void(e&&this.startReshapingArea(e.id))}const s=this.findPointAtCursor(n,i);if(-1!==s)return this.state.selectedPointIndex=s,void this.draw();const r=this.findEdgeAtCursor(n,i);-1===r?(this.state.selectedPointIndex=null,this.draw()):this.addPointToEdge(r,n,i)},handleReshapeMouseMove(e){if(!this.state.reshapeAreaId)return;const{canvasX:t,canvasY:a}=this.getCanvasCoordinates(e),n=(t-this.state.offsetX)/this.state.scale,i=(a-this.state.offsetY)/this.state.scale;if(this.state.isDraggingPoint&&null!==this.state.selectedPointIndex)return this.state.reshapePoints[this.state.selectedPointIndex]={x:n,y:i},void this.draw();const s=this.findPointAtCursor(n,i),r=-1===s?this.findEdgeAtCursor(n,i):-1;if(this.state.hoveredPointIndex!==s||this.state.hoveredEdgeIndex!==r){this.state.hoveredPointIndex=s,this.state.hoveredEdgeIndex=r;const e=this.elements.canvas;e.style.cursor=-1!==s?"move":-1!==r?"copy":"default",this.draw()}},getCanvasCoordinates(e){const t=this.elements.canvas,a=t.getBoundingClientRect(),n=t.width/a.width,i=t.height/a.height;return{canvasX:(e.clientX-a.left)*n,canvasY:(e.clientY-a.top)*i}},getMapPoint(e){const{canvasX:t,canvasY:a}=this.getCanvasCoordinates(e);return{mapX:(t-this.state.offsetX)/this.state.scale,mapY:(a-this.state.offsetY)/this.state.scale,canvasX:t,canvasY:a}},addPoint(e){const{mapX:t,mapY:a}=this.getMapPoint(e);if(Number.isFinite(t)&&Number.isFinite(a)){if(this.state.tempPoints.length>=3){const e=this.state.tempPoints[0];if(Math.hypot(e.x-t,e.y-a)<=15)return void this.finishDrawing()}this.state.tempPoints.push({x:t,y:a}),this.draw()}},updatePreviewPoint(e){const{mapX:t,mapY:a}=this.getMapPoint(e);this.state.previewPoint={x:t,y:a},this.scheduleRender()},finishDrawing(){this.state.tempPoints.length<3?this.showToast("Necesitas al menos 3 puntos para crear un rea.","warning"):this.openAreaModal()},toggleDrawingMode(){o.initialized&&this.state.currentMapId?this.state.drawing?this.cancelDrawing():(this.state.drawing=!0,this.state.tempPoints=[],this.state.previewPoint=null,this.state.highlightAreaId=null,this.elements.drawBtn&&(this.elements.drawBtn.textContent="Finalizar rea",this.elements.drawBtn.classList.add("map-btn--primary")),this.showHint("Modo dibujo activo: haz clic para agregar puntos. Doble clic o clic derecho para cerrar."),this.elements.canvas.style.cursor="crosshair"):this.showToast("Selecciona un mapa antes de dibujar una zona.","info")},cancelDrawing(){this.state.drawing=!1,this.state.tempPoints=[],this.state.previewPoint=null,this.elements.drawBtn&&(this.elements.drawBtn.textContent="Dibujar zona",this.elements.drawBtn.classList.remove("map-btn--primary")),this.hideHint(),this.elements.canvas.style.cursor="grab",this.draw()},toggleModoAgregarMarcador(){if(!o.initialized||!this.state.currentMapId)return void this.showToast("Selecciona un mapa primero","info");const e=document.getElementById("mapAddMarkerBtn");this.state.modoAgregarMarcadorActivo?(this.state.modoAgregarMarcadorActivo=!1,e&&(e.textContent=" Agregar Marcador",e.classList.remove("map-btn--danger"),e.classList.add("map-btn--success")),this.elements.canvas&&(this.elements.canvas.style.cursor="grab"),this.hideHint(),this.showToast("Modo agregar marcador desactivado","info")):(this.state.modoAgregarMarcadorActivo=!0,e&&(e.textContent=" Cancelar",e.classList.remove("map-btn--success"),e.classList.add("map-btn--danger")),this.elements.canvas&&(this.elements.canvas.style.cursor="crosshair"),this.showHint("Modo Agregar Marcador: Haz clic dentro de un rea para colocar un marcador"),this.showToast(" Haz clic en un rea para agregar marcador","success"))},abrirModalBusquedaRepuesto(e,t,a){const n=`\n      <div id="modalBusquedaRepuesto" style="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: var(--bg-primary);\n        border: 2px solid var(--border-color);\n        border-radius: 12px;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n        z-index: 10000;\n        width: 90%;\n        max-width: 600px;\n        max-height: 80vh;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n      ">\n        \x3c!-- Header --\x3e\n        <div style="\n          padding: 16px 20px;\n          border-bottom: 1px solid var(--border-color);\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          background: var(--bg-secondary);\n        ">\n          <div>\n            <h3 style="margin: 0; color: var(--text-primary); font-size: 1.1rem;">\n               Seleccionar Repuesto\n            </h3>\n            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: var(--text-muted);">\n              rea: <strong>${a.name}</strong>\n            </p>\n          </div>\n          <button onclick="mapController.cerrarModalBusquedaRepuesto()" style="\n            background: none;\n            border: none;\n            font-size: 1.5rem;\n            cursor: pointer;\n            color: var(--text-muted);\n            padding: 4px 8px;\n            line-height: 1;\n          "></button>\n        </div>\n\n        \x3c!-- Buscador --\x3e\n        <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color);">\n          <input \n            type="text" \n            id="inputBusquedaRepuesto" \n            placeholder=" Escribe para buscar repuesto..."\n            style="\n              width: 100%;\n              padding: 12px 16px;\n              border: 2px solid var(--border-color);\n              border-radius: 8px;\n              font-size: 1rem;\n              background: var(--bg-tertiary);\n              color: var(--text-primary);\n              transition: border-color 0.2s;\n            "\n            autocomplete="off"\n          />\n          \n          \x3c!--  Selector de Categora --\x3e\n          <div style="margin-top: 12px;">\n            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">\n               Categora (opcional):\n            </label>\n            <select \n              id="selectCategoriaMarker" \n              style="\n                width: 100%;\n                padding: 10px 14px;\n                border: 2px solid var(--border-color);\n                border-radius: 6px;\n                font-size: 0.95rem;\n                background: var(--bg-tertiary);\n                color: var(--text-primary);\n                cursor: pointer;\n              "\n            >\n              <option value="Sin categora">Sin categora</option>\n              <option value="Componentes"> Componentes</option>\n              <option value="Elctrico"> Elctrico</option>\n              <option value="Mecnico"> Mecnico</option>\n              <option value="Hidrulico"> Hidrulico</option>\n              <option value="Neumtico"> Neumtico</option>\n              <option value="Estructura"> Estructura</option>\n              <option value="Seguridad"> Seguridad</option>\n              <option value="Instrumentacin"> Instrumentacin</option>\n              <option value="Otro"> Otro</option>\n            </select>\n          </div>\n          \n          <div id="contadorResultados" style="\n            margin-top: 8px;\n            font-size: 0.85rem;\n            color: var(--text-muted);\n          "></div>\n        </div>\n\n        \x3c!-- Lista de resultados --\x3e\n        <div id="listaResultadosRepuestos" style="\n          flex: 1;\n          overflow-y: auto;\n          padding: 8px;\n        "></div>\n\n        \x3c!-- Footer --\x3e\n        <div style="\n          padding: 12px 20px;\n          border-top: 1px solid var(--border-color);\n          background: var(--bg-secondary);\n          display: flex;\n          justify-content: flex-end;\n          gap: 8px;\n        ">\n          <button onclick="mapController.cerrarModalBusquedaRepuesto()" style="\n            padding: 10px 20px;\n            border: 1px solid var(--border-color);\n            border-radius: 6px;\n            background: var(--bg-tertiary);\n            color: var(--text-primary);\n            cursor: pointer;\n            font-size: 0.95rem;\n          ">\n            Cancelar\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Overlay --\x3e\n      <div id="overlayBusquedaRepuesto" onclick="mapController.cerrarModalBusquedaRepuesto()" style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.5);\n        z-index: 9999;\n      "></div>\n    `;this.cerrarModalBusquedaRepuesto(),document.body.insertAdjacentHTML("beforeend",n),this.state.modalBusqueda={x:e,y:t,area:a};const i=document.getElementById("inputBusquedaRepuesto");i&&(i.focus(),i.addEventListener("input",e=>{this.filtrarRepuestos(e.target.value)})),this.filtrarRepuestos("")},filtrarRepuestos(e){const t=document.getElementById("listaResultadosRepuestos"),a=document.getElementById("contadorResultados");if(!t||!c||!c.repuestos)return;const n=e.toLowerCase().trim();let i=c.repuestos;n&&(i=c.repuestos.filter(e=>{const t=(e.nombre||"").toLowerCase(),a=(e.codigo||"").toLowerCase(),i=(e.areaGeneral||e.area||"").toLowerCase(),s=(e.sistemaEquipo||e.equipo||"").toLowerCase();return t.includes(n)||a.includes(n)||i.includes(n)||s.includes(n)})),a&&(a.textContent=`${i.length} repuesto(s) encontrado(s)`),0!==i.length?t.innerHTML=i.map(e=>`\n      <div \n        onclick="mapController.seleccionarRepuestoParaMarcador('${e.id}')"\n        style="\n          padding: 12px 16px;\n          margin-bottom: 8px;\n          border: 1px solid var(--border-color);\n          border-radius: 8px;\n          background: var(--bg-tertiary);\n          cursor: pointer;\n          transition: all 0.2s;\n        "\n        onmouseover="this.style.background='var(--bg-hover)'; this.style.borderColor='var(--primary)';"\n        onmouseout="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border-color)';"\n      >\n        <div style="display: flex; justify-content: space-between; align-items: start;">\n          <div style="flex: 1;">\n            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">\n              ${e.nombre||"Sin nombre"}\n            </div>\n            <div style="font-size: 0.85rem; color: var(--text-muted);">\n              ${e.codigo?`Cdigo: ${e.codigo}`:""}\n              ${e.areaGeneral?`  ${e.areaGeneral}`:""}\n              ${e.sistemaEquipo?`  ${e.sistemaEquipo}`:""}\n            </div>\n          </div>\n          <div style="\n            padding: 4px 8px;\n            background: var(--primary);\n            color: white;\n            border-radius: 4px;\n            font-size: 0.75rem;\n            white-space: nowrap;\n          ">\n            Seleccionar\n          </div>\n        </div>\n      </div>\n    `).join(""):t.innerHTML='\n        <div style="\n          padding: 40px 20px;\n          text-align: center;\n          color: var(--text-muted);\n        ">\n          <div style="font-size: 3rem; margin-bottom: 12px;"></div>\n          <p>No se encontraron repuestos</p>\n        </div>\n      '},async seleccionarRepuestoParaMarcador(e){const t=c.repuestos.find(t=>t.id===e);if(!t||!this.state.modalBusqueda)return;const{x:a,y:n,area:i}=this.state.modalBusqueda,s=this.state.currentMapId,r=document.getElementById("selectCategoriaMarker"),o=r?r.value:"Sin categora";try{t.ubicaciones&&Array.isArray(t.ubicaciones)||(t.ubicaciones=[]),t.ubicaciones.forEach((e,t)=>{});const e=5;if(t.ubicaciones.some(t=>{const r=String(t.mapId)===String(s),o=String(t.areaId)===String(i.id),l=Math.abs(t.markerX-a)<e&&Math.abs(t.markerY-n)<e;return r&&o&&l}))return this.showToast(" Ya hay un marcador en esta posicin","warning"),void this.cerrarModalBusquedaRepuesto();t.ubicaciones.push({mapId:s,areaId:i.id,areaName:i.name,markerX:a,markerY:n,categoria:o});const r=t.ubicaciones.filter(e=>String(e.mapId)===String(s)&&String(e.areaId)===String(i.id)).length;r>1?this.showToast(` "${t.nombre}" agregado (${r} en "${i.name}")`,"success"):this.showToast(` "${t.nombre}" agregado a "${i.name}"`,"success"),await c.saveData(),this.cerrarModalBusquedaRepuesto(),this.draw()}catch(l){this.showToast(" Error al agregar marcador","error")}},cerrarModalBusquedaRepuesto(){const e=document.getElementById("modalBusquedaRepuesto"),t=document.getElementById("overlayBusquedaRepuesto");e&&e.remove(),t&&t.remove(),this.state.modalBusqueda=null},openAreaModal(){const e=this.elements.modal,t=this.elements.modalBody;if(!e||!t)return;this.elements.modalTitle.textContent="Definir nueva rea";const a=this.getJerarquiaOptionCatalog(),n=this.getCurrentMapJerarquiaDefaults(),i=(e,t)=>Array.isArray(t)&&t.length?`<datalist id="${e}">${t.map(e=>`<option value="${this.escapeHtml(e)}"></option>`).join("")}</datalist>`:"",s=Object.entries(this.categories).map(([e,t])=>`<option value="${e}">${t.icon} ${t.name}</option>`).join("");t.innerHTML=`\n      <form id="mapAreaForm" class="map-area-form">\n        <div class="form-group">\n          <label> Categora</label>\n          <select name="category" id="areaCategorySelect" style="font-size: 1rem; padding: 8px;">\n            ${s}\n          </select>\n        </div>\n        <div class="form-group">\n          <label>Nombre del rea</label>\n          <input type="text" name="areaName" required placeholder="Ej: Planta Principal" />\n        </div>\n        <div class="form-row">\n          <div class="form-group">\n            <label>Color</label>\n            <input type="color" name="areaColor" id="areaColorInput" value="#3b82f6" />\n          </div>\n          <div class="form-group">\n            <label>Opacidad</label>\n            <input type="range" name="areaOpacity" min="10" max="90" value="35" />\n          </div>\n        </div>\n        \n        \x3c!--  NUEVO: Controles para posicionar el nombre en el canvas --\x3e\n        <div class="form-group" style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; margin-bottom: 12px;">\n          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n            <span style="font-size: 1.1rem;"></span>\n            <span>Posicin del nombre en el mapa</span>\n          </label>\n          <div class="form-row" style="gap: 12px;">\n            <div class="form-group" style="flex: 1;">\n              <label style="font-size: 0.85rem; color: var(--text-secondary);">Desplazar horizontalmente (X)</label>\n              <input type="number" name="labelOffsetX" value="0" step="10" placeholder="0" \n                     style="text-align: center;" title="Valores positivos mueven a la derecha, negativos a la izquierda" />\n              <small style="color: var(--text-muted); font-size: 0.75rem;"> Izq (-)  |  Der (+) </small>\n            </div>\n            <div class="form-group" style="flex: 1;">\n              <label style="font-size: 0.85rem; color: var(--text-secondary);">Desplazar verticalmente (Y)</label>\n              <input type="number" name="labelOffsetY" value="0" step="10" placeholder="0" \n                     style="text-align: center;" title="Valores positivos mueven hacia abajo, negativos hacia arriba" />\n              <small style="color: var(--text-muted); font-size: 0.75rem;"> Arriba (-)  |  Abajo (+) </small>\n            </div>\n          </div>\n          <small style="display: block; margin-top: 8px; color: var(--text-muted); font-size: 0.8rem;">\n             Ajusta estos valores si el nombre se monta sobre otra rea (puedes editarlo despus)\n          </small>\n        </div>\n        \n        <div class="form-group">\n          <label>Nivel 1  Empresa / Planta</label>\n          <input type="text" name="planta" list="plantaList" placeholder="Ej: Aquachile Antarfood" value="${this.escapeHtml(n.planta||"")}" />\n          ${i("plantaList",a.planta)}\n        </div>\n        <div class="form-group">\n          <label>Nivel 2  rea general</label>\n          <input type="text" name="areaGeneral" list="areaGeneralList" placeholder="Ej: Planta Principal" value="${this.escapeHtml(n.areaGeneral||"")}" />\n          ${i("areaGeneralList",a.areaGeneral)}\n        </div>\n        <div class="form-group">\n          <label>Nivel 3  Sub-rea</label>\n          <input type="text" name="subArea" list="subAreaList" placeholder="Ej: Estanques" value="${this.escapeHtml(n.subArea||"")}" />\n          ${i("subAreaList",a.subArea)}\n        </div>\n        <div class="form-group">\n          <label>Nivel 4  Sistema / Equipo</label>\n          <input type="text" name="sistemaEquipo" list="sistemaEquipoList" placeholder="Ej: Grader Baader" value="${this.escapeHtml(n.sistemaEquipo||"")}" />\n          ${i("sistemaEquipoList",a.sistemaEquipo)}\n        </div>\n        <div class="form-group">\n          <label>Nivel 5  Sub-sistema</label>\n          <input type="text" name="subSistema" list="subSistemaList" placeholder="Ej: Cinta Zeta" value="${this.escapeHtml(n.subSistema||"")}" />\n          ${i("subSistemaList",a.subSistema)}\n        </div>\n        <div class="form-group">\n          <label>Nivel 6  Seccin</label>\n          <input type="text" name="seccion" list="seccionList" placeholder="Ej: Mdulo 1" value="${this.escapeHtml(n.seccion||"")}" />\n          ${i("seccionList",a.seccion)}\n        </div>\n        <div class="form-group">\n          <label>Equipos / mquinas (uno por lnea)</label>\n          <textarea name="equipos" rows="4" placeholder="Ej:\nMotor principal\nBanda transportadora"></textarea>\n        </div>\n        <div class="form-actions">\n          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>\n          <button type="submit" class="map-btn map-btn--primary">Guardar rea</button>\n        </div>\n      </form>\n    `,e.classList.remove("hidden");const r=t.querySelector("#mapAreaForm"),o=t.querySelector('[data-action="cancel"]');o&&o.addEventListener("click",()=>{this.closeModal(),this.cancelDrawing()});const l=t.querySelector("#areaCategorySelect"),d=t.querySelector("#areaColorInput");l&&d&&l.addEventListener("change",e=>{const t=e.target.value;this.categories[t]&&(d.value=this.categories[t].color)}),r&&r.addEventListener("submit",e=>{e.preventDefault(),this.saveAreaFromModal(new FormData(r))})},closeModal(){const e=this.elements.modal;e&&e.classList.add("hidden"),this.elements.modalBody.innerHTML="",this.elements.modalTitle.textContent=""},async saveAreaFromModal(e){const t=(e.get("areaName")||"").toString().trim();if(!t)return void this.showToast("Asigna un nombre a el rea.","warning");const a=(e.get("areaColor")||"#3b82f6").toString(),n=parseInt(e.get("areaOpacity"),10),i=Number.isFinite(n)?n/100:.35,s=(e.get("category")||"area").toString().trim(),r=parseInt(e.get("labelOffsetX"),10)||0,l=parseInt(e.get("labelOffsetY"),10)||0,d={},p=(e.get("planta")||"").toString().trim(),u=(e.get("areaGeneral")||"").toString().trim(),m=(e.get("subArea")||"").toString().trim(),h=(e.get("sistemaEquipo")||"").toString().trim(),g=(e.get("subSistema")||"").toString().trim(),b=(e.get("seccion")||"").toString().trim();p&&(d.planta=p),u&&(d.areaGeneral=u),m&&(d.subArea=m),h&&(d.sistemaEquipo=h),g&&(d.subSistema=g),b&&(d.seccion=b);const v=(e.get("equipos")||"").toString().split(/\r?\n/).map(e=>e.trim()).filter(Boolean),y={id:Date.now(),mapId:this.state.currentMapId,name:t,color:a,opacity:i,category:s,labelOffsetX:r,labelOffsetY:l,parentId:null,children:[],points:[...this.state.tempPoints],jerarquia:d,equipos:v,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};try{const e=[...o.areas||[],y];await o.saveAreas(e,{action:"create",mapId:y.mapId,areaId:y.id,detail:y.name}),this.state.areas=o.getAreasByMap(y.mapId),this.renderAreaList(this.state.areas),this.state.highlightAreaId=y.id,this.closeModal(),this.cancelDrawing(),this.draw(),this.showToast("rea guardada correctamente.","success"),this.updateMetaBadge(),"function"==typeof(null==c?void 0:c.aprenderNuevaOpcion)&&Object.entries(d).forEach(([e,t])=>{t&&c.aprenderNuevaOpcion(e,t)})}catch(f){this.showToast("No se pudo guardar el rea. Revisa la consola.","error")}},focusArea(e){const t=this.state.areas.find(t=>t.id==e);if(!t||!Array.isArray(t.points)||t.points.length<1)return;this.state.highlightAreaId=t.id;const a=t.points.map(e=>e.x),n=t.points.map(e=>e.y),i=Math.min(...a),s=Math.max(...a),r=Math.min(...n),o=Math.max(...n),l=Math.max(1,s-i),d=Math.max(1,o-r),c=this.elements.canvas,p=.6*c.width/l,u=.6*c.height/d,m=Math.min(p,u,this.state.maxScale);this.state.scale=Math.max(this.state.minScale,m);const h=(i+s)/2,g=(r+o)/2;this.state.offsetX=c.width/2-h*this.state.scale,this.state.offsetY=c.height/2-g*this.state.scale,this.draw(),this.queueViewportPersist("focus-area")},updateMetaBadge(){const e=this.elements.metaBadge;if(!e)return;if(!this.state.currentMap)return void(e.textContent="Sin mapa");const t=this.state.currentMap,a=this.state.areas.length,n=t.width&&t.height?`${t.width}  ${t.height}px`:"Dimensiones pendientes";e.textContent=`${t.name}  ${n}  ${a} rea(s)`},updateMapJerarquiaBadge(){var e;const t=null==(e=this.elements)?void 0:e.jerarquiaBadge;if(!t)return;const a=this.state.currentMap;if(!a)return t.classList.add("map-jerarquia-badge--empty"),t.innerHTML='\n        <div>\n          <strong>Sin mapa activo</strong>\n          <span class="map-jerarquia-badge__path">Selecciona un mapa para ver su jerarquia.</span>\n        </div>\n        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Asignar</button>\n      ',void this.renderMapJerarquiaBranch();const n=Array.isArray(a.jerarquiaPath)?a.jerarquiaPath:[];if(!n.length)return t.classList.add("map-jerarquia-badge--empty"),t.innerHTML=`\n        <div>\n          <strong>${this.escapeHtml(a.name||"Mapa sin nombre")}</strong>\n          <span class="map-jerarquia-badge__path">Sin jerarquia asignada.</span>\n        </div>\n        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Asignar</button>\n      `,void this.renderMapJerarquiaBranch();const i=this.getJerarquiaPathLabel(n);t.classList.remove("map-jerarquia-badge--empty"),t.innerHTML=`\n      <div>\n        <strong>Rama asignada</strong>\n        <span class="map-jerarquia-badge__path">${this.escapeHtml(i)}</span>\n      </div>\n        <button type="button" class="map-btn map-btn--ghost" data-action="badge-assign-jerarquia">Editar</button>\n    `,this.renderMapJerarquiaBranch()},showMapLoadingOverlay(e){const t=this.elements.mapLoadingOverlay;if(!t)return;clearTimeout(this.state.mapLoadingHideTimeout),this.state.mapLoadingActive=!0,this.state.mapLoadingProgress=0;const a=(null==e?void 0:e.name)?`Cargando ${e.name}`:"Preparando mapa";this.elements.mapLoadingTitle&&(this.elements.mapLoadingTitle.textContent=a),this.elements.mapLoadingStatus&&(this.elements.mapLoadingStatus.textContent="Buscando imagen en la carpeta..."),this.elements.mapLoadingPercent&&(this.elements.mapLoadingPercent.textContent="0%"),this.elements.mapLoadingBar&&(this.elements.mapLoadingBar.style.width="0%"),t.classList.remove("hidden")},updateMapLoadingProgress(e,t=null){if(!this.state.mapLoadingActive)return;if(!this.elements.mapLoadingOverlay)return;const a=Math.max(this.state.mapLoadingProgress,Math.min(99,Math.round(e)));this.state.mapLoadingProgress=a,this.elements.mapLoadingBar&&(this.elements.mapLoadingBar.style.width=`${a}%`),this.elements.mapLoadingPercent&&(this.elements.mapLoadingPercent.textContent=`${a}%`),t&&this.elements.mapLoadingStatus&&(this.elements.mapLoadingStatus.textContent=t)},completeMapLoadingProgress(e="Mapa listo"){this.state.mapLoadingActive&&(this.state.mapLoadingProgress=100,this.elements.mapLoadingBar&&(this.elements.mapLoadingBar.style.width="100%"),this.elements.mapLoadingPercent&&(this.elements.mapLoadingPercent.textContent="100%"),this.elements.mapLoadingStatus&&e&&(this.elements.mapLoadingStatus.textContent=e),clearTimeout(this.state.mapLoadingHideTimeout),this.state.mapLoadingHideTimeout=setTimeout(()=>{this.hideMapLoadingOverlay()},450))},hideMapLoadingOverlay(e=!1,t=null){this.elements.mapLoadingOverlay&&(this.state.mapLoadingActive||e)&&(t&&this.elements.mapLoadingStatus&&(this.elements.mapLoadingStatus.textContent=t),clearTimeout(this.state.mapLoadingHideTimeout),this.state.mapLoadingHideTimeout=null,this.state.mapLoadingActive=!1,this.state.mapLoadingProgress=0,this.elements.mapLoadingOverlay.classList.add("hidden"),this.elements.mapLoadingBar&&(this.elements.mapLoadingBar.style.width="0%"),this.elements.mapLoadingPercent&&(this.elements.mapLoadingPercent.textContent="0%"))},normalizeMapJerarquiaPath(e=[]){return Array.isArray(e)&&e.length?e.map(e=>{if(!e||!e.id)return null;const t=this.findJerarquiaNodeInTree(e.id,e.nivel),a=(null==t?void 0:t.nombre)||e.nombre||e.id;return{id:e.id,nivel:e.nivel||(null==t?void 0:t.nivel)||null,label:a,labelLower:(a||"").toString().trim().toLowerCase()}}).filter(Boolean):[]},getAreasMatchingBranch(e,t,a=null){var n;if(!Array.isArray(e)||!e.length)return Array.isArray(a)?a:this.state.areas||[];const i=Array.isArray(a)?a:this.state.areas||[];if(!i.length)return[];const s="empresa"===(null==(n=e[0])?void 0:n.nivel)?1:0,r="number"==typeof t?t:e.length-1;if(r<s)return i;const o=this.areaJerarquiaFieldOrder;return i.filter(t=>{var a;const n=t.jerarquia||{};for(let i=s;i<=r;i++){const t=i-s;if(t<0)continue;const r=o[t];if(!r)continue;const l=null==(a=e[i])?void 0:a.labelLower;if(!l)return!1;const d=(n[r]||"").toString().trim().toLowerCase();if(!d||d!==l)return!1}return!0})},countMarkersForAreas(e=[]){if(!Array.isArray(e)||!e.length)return 0;const t=new Set(e.map(e=>String(e.id)));if(!t.size)return 0;const a=(null==c?void 0:c.repuestos)||[];let n=0;return a.forEach(e=>{Array.isArray(e.ubicaciones)&&e.ubicaciones.forEach(e=>{String(e.mapId)===String(this.state.currentMapId)&&t.has(String(e.areaId))&&n++})}),n},renderMapJerarquiaBranch(){var e,t;const a=null==(e=this.elements)?void 0:e.jerarquiaBranch;if(!a)return;const n=this.state.currentMap;if(!n)return void(a.innerHTML='<div class="map-jerarquia-branch-empty">Selecciona un mapa para ver su ruta jerarquica.</div>');if(!c||!c.jerarquiaAnidada)return void(a.innerHTML='<div class="map-jerarquia-branch-empty">Configura la jerarqua para habilitar esta vista.</div>');const i=Array.isArray(n.jerarquiaPath)?n.jerarquiaPath:[];if(!i.length)return void(a.innerHTML='<div class="map-jerarquia-branch-empty">Este mapa an no tiene jerarqua asignada.</div>');const s=this.normalizeMapJerarquiaPath(i);if(!s.length)return void(a.innerHTML='<div class="map-jerarquia-branch-empty">No se pudo interpretar la jerarqua asignada.</div>');const r=this.state.jerarquiaBranchFilter,o="empresa"===(null==(t=s[0])?void 0:t.nivel)?1:0,l=s.map((e,t)=>({segment:e,index:t})).filter(({index:e})=>e>=o);if(!l.length)return void(a.innerHTML='<div class="map-jerarquia-branch-empty">La jerarqua asignada no tiene niveles descendentes configurados.</div>');const d=l.map(({segment:e,index:t})=>{var a;const n=this.getAreasMatchingBranch(s,t),i=this.countMarkersForAreas(n),o=(null==(a=this.jerarquiaLevelConfig[e.nivel])?void 0:a.label)||`Nivel ${t+1}`,l=r&&r.mapId===this.state.currentMapId&&r.index===t,d=l?"Filtro aplicado. Click para limpiar.":"Click para filtrar las reas de este nivel.";return`\n        <div class="map-jerarquia-branch-node ${l?"is-active":""}" data-branch-index="${t}">\n          <div class="map-jerarquia-branch-header">\n            <span class="map-jerarquia-branch-level">N${t+1}  ${this.escapeHtml(o)}</span>\n            <span class="map-jerarquia-branch-name">${this.escapeHtml(e.label)}</span>\n          </div>\n          <div class="map-jerarquia-branch-stats">\n            <span><strong>${n.length}</strong> ${1===n.length?"rea":"reas"}</span>\n            <span><strong>${i}</strong> ${1===i?"marcador":"marcadores"}</span>\n          </div>\n          <div style="font-size: 0.68rem; color: var(--text-muted);">${d}</div>\n        </div>\n      `}).join("");a.innerHTML=d},getActiveBranchFilterLabel(){const e=this.state.jerarquiaBranchFilter;if(!e||!Array.isArray(e.pathSnapshot))return"";const t=e.pathSnapshot[e.index];return(null==t?void 0:t.label)||""},toggleJerarquiaBranchFilter(e){const t=this.state.currentMap;if(!t)return void this.showToast("Selecciona un mapa primero.","info");const a=this.normalizeMapJerarquiaPath(t.jerarquiaPath||[]);if(!a.length)return void this.showToast("Este mapa an no tiene jerarqua asignada.","info");const n=this.state.jerarquiaBranchFilter;n&&n.mapId===this.state.currentMapId&&n.index===e?this.state.jerarquiaBranchFilter=null:this.state.jerarquiaBranchFilter={mapId:this.state.currentMapId,index:e,pathSnapshot:a},this.renderAreaList(this.state.areas)},clearJerarquiaBranchFilter(){this.state.jerarquiaBranchFilter&&(this.state.jerarquiaBranchFilter=null,this.renderAreaList(this.state.areas))},applyActiveBranchFilter(e){var t;const a=this.state.jerarquiaBranchFilter;if(!a)return e;if(a.mapId!==this.state.currentMapId)return this.state.jerarquiaBranchFilter=null,e;const n=Array.isArray(a.pathSnapshot)?a.pathSnapshot:this.normalizeMapJerarquiaPath((null==(t=this.state.currentMap)?void 0:t.jerarquiaPath)||[]);return!n.length||a.index>=n.length?(this.state.jerarquiaBranchFilter=null,e):this.getAreasMatchingBranch(n,a.index,e)},updateZoomBadge(){const e=this.elements.zoomBadge;e&&(e.textContent=`${Math.round(100*this.state.scale)}%`)},calculateCentroid(e){if(!Array.isArray(e)||0===e.length)return null;const t=e.reduce((e,t)=>(e.x+=t.x,e.y+=t.y,e),{x:0,y:0});return{x:t.x/e.length,y:t.y/e.length}},highlightArea(e){this.state.highlightAreaId=e,this.draw()},flashArea(e,t=3){let a=0;const n=setInterval(()=>{this.state.highlightAreaId=a%2==0?e:null,this.draw(),a++,a>=2*t&&(clearInterval(n),this.state.highlightAreaId=e,this.draw())},300)},zoomToArea(e){const t=this.state.areas.find(t=>String(t.id)===String(e));if(!t||!t.points||0===t.points.length)return;let a=1/0,n=1/0,i=-1/0,s=-1/0;t.points.forEach(e=>{e.x<a&&(a=e.x),e.x>i&&(i=e.x),e.y<n&&(n=e.y),e.y>s&&(s=e.y)});const r=(a+i)/2,o=(n+s)/2,l=i-a,d=s-n,c=this.elements.canvas;if(!c)return;const p=.6*c.width/l,u=.6*c.height/d,m=Math.min(p,u,this.state.maxScale);this.animateZoomTo(r,o,m)},animateZoomTo(e,t,a,n=500){const i=this.elements.canvas;if(!i)return;const s=this.state.scale,r=this.state.offsetX,o=this.state.offsetY,l=i.width/2-e*a,d=i.height/2-t*a,c=performance.now(),p=e=>{const t=e-c,i=Math.min(t/n,1),u=i<.5?2*i*i:1-Math.pow(-2*i+2,2)/2;this.state.scale=s+(a-s)*u,this.state.offsetX=r+(l-r)*u,this.state.offsetY=o+(d-o)*u,this.draw(),this.updateZoomBadge(),i<1?requestAnimationFrame(p):this.queueViewportPersist("animate-zoom")};requestAnimationFrame(p)},pulseArea(e,t=3){let a=0;const n=setInterval(()=>{this.state.highlightAreaId=a%2==0?e:null,this.draw(),a++,a>=2*t&&(clearInterval(n),this.state.highlightAreaId=e,this.draw())},300)},async loadMap(e){await this.selectMap(e)},async loadMapImageFromStorage(e){try{this.state.mapLoadingActive||this.showMapLoadingOverlay(this.state.currentMap),this.updateMapLoadingProgress(15,"Leyendo imagen desde la carpeta...");const t=await n.readFile(e);if(!t)return void this.hideMapLoadingOverlay(!0,"No se encontr el archivo de imagen.");const a=URL.createObjectURL(t),i=new Image;i.onload=()=>{this.updateMapLoadingProgress(85,"Aplicando mapa al lienzo..."),this.state.currentImage=i,this.state.currentImageUrl=a,this.configureCanvasForImage(i,{keepViewport:!1}),this.draw(),this.completeMapLoadingProgress(),URL.revokeObjectURL(a)},i.onerror=()=>{URL.revokeObjectURL(a),this.hideMapLoadingOverlay(!0,"Error cargando la imagen del mapa.")},i.src=a}catch(t){this.hideMapLoadingOverlay(!0,"Error leyendo la imagen.")}},loadAreasForMap(e){const t=o.areas||[];this.state.areas=t.filter(t=>String(t.mapId)===String(e)),this.renderAreaList(this.state.areas)},activarModoMarcador(e,t,a,n=!1){this.state.modoMarcador=!0,this.state.marcadorPendiente={repuestoId:e,mapId:t,areaId:a},this.elements.canvas&&(this.elements.canvas.style.cursor="crosshair");const i=n?" Haz clic en el rea para cambiar la posicin del marcador":" Haz clic en el rea resaltada para colocar el marcador";this.showToast(i,"info",5e3)},async colocarMarcador(e,t){if(!this.state.modoMarcador||!this.state.marcadorPendiente)return;const{repuestoId:a,mapId:n,areaId:i}=this.state.marcadorPendiente,s=this.buscarAreasCercanas(e,t,300);if(0===s.length){const a=this.state.areas.find(e=>String(e.id)===String(i));if(a){const n=this.distanciaPuntoAArea(e,t,a);n<=500&&s.push({area:a,distancia:n,dentro:this.puntoEnArea(e,t,a)})}}if(0===s.length){const a=this.state.areas.find(e=>String(e.id)===String(i)),n=a?Math.round(this.distanciaPuntoAArea(e,t,a)):"N/A";return void this.showToast(` Click muy lejos del rea "${(null==a?void 0:a.name)||"desconocida"}" (${n}px). Haz zoom y acrcate ms al rea resaltada.`,"warning",5e3)}1!==s.length?this.mostrarMenuSeleccionArea(e,t,s,a,n):await this.confirmarMarcador(e,t,s[0].area,a,n)},buscarAreasCercanas(e,t,a=100){const n=[];for(const i of this.state.areas){if(!i.points||i.points.length<3)continue;if(this.puntoEnArea(e,t,i)){n.push({area:i,distancia:0,dentro:!0});continue}const s=this.distanciaPuntoAArea(e,t,i);s<=a&&n.push({area:i,distancia:s,dentro:!1})}return n.sort((e,t)=>e.dentro&&!t.dentro?-1:!e.dentro&&t.dentro?1:e.distancia-t.distancia),n},distanciaPuntoAArea(e,t,a){let n=1/0;for(let i=0;i<a.points.length;i++){const s=a.points[i],r=a.points[(i+1)%a.points.length],o=this.distanciaPuntoASegmento(e,t,s.x,s.y,r.x,r.y);n=Math.min(n,o)}return n},distanciaPuntoASegmento(e,t,a,n,i,s){const r=i-a,o=s-n,l=r*r+o*o;let d,c,p=-1;0!==l&&(p=((e-a)*r+(t-n)*o)/l),p<0?(d=a,c=n):p>1?(d=i,c=s):(d=a+p*r,c=n+p*o);const u=e-d,m=t-c;return Math.sqrt(u*u+m*m)},mostrarMenuSeleccionArea(e,t,a,n,i){const s=document.getElementById("areaSelectionMenu");s&&s.remove();const r=this.elements.canvas.getBoundingClientRect(),o=e*this.state.scale+this.state.offsetX+r.left,l=t*this.state.scale+this.state.offsetY+r.top,d=document.createElement("div");d.id="areaSelectionMenu",d.style.cssText=`\n      position: fixed;\n      left: ${o}px;\n      top: ${l}px;\n      background: rgba(15, 23, 42, 0.98);\n      border: 2px solid #3b82f6;\n      border-radius: 12px;\n      padding: 12px;\n      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n      z-index: 10000;\n      min-width: 250px;\n      max-width: 350px;\n      animation: fadeInScale 0.2s ease-out;\n    `;const c=document.createElement("div");c.textContent=" Selecciona el rea",c.style.cssText="\n      color: #60a5fa;\n      font-weight: bold;\n      margin-bottom: 8px;\n      font-size: 14px;\n      border-bottom: 1px solid rgba(59, 130, 246, 0.3);\n      padding-bottom: 8px;\n    ",d.appendChild(c),a.forEach(({area:a,distancia:s,dentro:r})=>{const o=document.createElement("button"),l=r?"Click dentro":`${Math.round(s)}px`;o.textContent=` ${a.name}`,o.style.cssText=`\n        display: block;\n        width: 100%;\n        padding: 10px 12px;\n        margin: 4px 0;\n        background: ${r?"rgba(16, 185, 129, 0.2)":"rgba(59, 130, 246, 0.1)"};\n        border: 1px solid ${r?"#10b981":"#3b82f6"};\n        border-radius: 8px;\n        color: ${r?"#10b981":"#60a5fa"};\n        cursor: pointer;\n        text-align: left;\n        font-size: 13px;\n        transition: all 0.2s;\n        position: relative;\n      `;const c=document.createElement("span");c.textContent=l,c.style.cssText="\n        position: absolute;\n        right: 8px;\n        top: 50%;\n        transform: translateY(-50%);\n        font-size: 11px;\n        opacity: 0.7;\n      ",o.appendChild(c),o.onmouseover=()=>{o.style.background=r?"rgba(16, 185, 129, 0.3)":"rgba(59, 130, 246, 0.2)",o.style.transform="translateX(4px)"},o.onmouseout=()=>{o.style.background=r?"rgba(16, 185, 129, 0.2)":"rgba(59, 130, 246, 0.1)",o.style.transform="translateX(0)"},o.onclick=async()=>{d.remove(),await this.confirmarMarcador(e,t,a,n,i)},d.appendChild(o)});const p=document.createElement("button");p.textContent=" Cancelar",p.style.cssText="\n      display: block;\n      width: 100%;\n      padding: 8px;\n      margin-top: 8px;\n      background: rgba(239, 68, 68, 0.1);\n      border: 1px solid #ef4444;\n      border-radius: 8px;\n      color: #f87171;\n      cursor: pointer;\n      font-size: 12px;\n      transition: all 0.2s;\n    ",p.onmouseover=()=>{p.style.background="rgba(239, 68, 68, 0.2)"},p.onmouseout=()=>{p.style.background="rgba(239, 68, 68, 0.1)"},p.onclick=()=>d.remove(),d.appendChild(p),document.body.appendChild(d),setTimeout(()=>{const e=t=>{d.contains(t.target)||(d.remove(),document.removeEventListener("click",e))};document.addEventListener("click",e)},100)},async confirmarMarcador(e,t,a,n,i){try{const s=c.repuestos.find(e=>String(e.id)===String(n));if(!s)return void this.showToast(" Repuesto no encontrado","error");if(window._editandoUbicacion&&window._editandoUbicacion.modoEdicion){const{indice:n}=window._editandoUbicacion;s.ubicaciones&&Array.isArray(s.ubicaciones)||(s.ubicaciones=[]),0===s.ubicaciones.length&&s.mapId&&s.areaId&&(s.ubicaciones=[{mapId:s.mapId,areaId:s.areaId,markerX:s.markerX,markerY:s.markerY}],delete s.mapId,delete s.areaId,delete s.markerX,delete s.markerY),s.ubicaciones[n]&&(s.ubicaciones[n].mapId=i,s.ubicaciones[n].areaId=a.id,s.ubicaciones[n].markerX=e,s.ubicaciones[n].markerY=t,this.showToast(` Ubicacin de "${s.nombre}" actualizada en "${a.name}"`,"success")),delete window._editandoUbicacion}else{s.ubicaciones&&Array.isArray(s.ubicaciones)||(s.ubicaciones=[]),s.mapId&&s.areaId&&0===s.ubicaciones.length&&(s.ubicaciones.push({mapId:s.mapId,areaId:s.areaId,markerX:s.markerX,markerY:s.markerY}),delete s.mapId,delete s.areaId,delete s.markerX,delete s.markerY);if(s.ubicaciones.some(e=>String(e.mapId)===String(i)&&String(e.areaId)===String(a.id))){const n=s.ubicaciones.find(e=>String(e.mapId)===String(i)&&String(e.areaId)===String(a.id));n&&(n.markerX=e,n.markerY=t,this.showToast(` Ubicacin actualizada en "${a.name}"`,"success"))}else s.ubicaciones.push({mapId:i,areaId:a.id,markerX:e,markerY:t}),this.showToast(` "${s.nombre}" ubicado en "${a.name}"`,"success")}await c.saveData(),this.state.modoMarcador=!1,this.state.marcadorPendiente=null,this.elements.canvas&&(this.elements.canvas.style.cursor="grab"),this.draw()}catch(s){this.showToast(" Error al guardar la ubicacin","error")}},puntoEnArea(e,t,a){if(!a||!a.points||a.points.length<3)return!1;let n=!1;for(let i=0,s=a.points.length-1;i<a.points.length;s=i++){const r=a.points[i].x,o=a.points[i].y,l=a.points[s].x,d=a.points[s].y;o>t!=d>t&&e<(l-r)*(t-o)/(d-o)+r&&(n=!n)}return n},showMarker(e,t,a){this.state.currentMarker={x:e,y:t,label:a},this.draw()},async mostrarMultiplesUbicaciones(e,t){if(!e||0===e.length)return;const a={};e.forEach(e=>{a[e.mapId]||(a[e.mapId]=[]),a[e.mapId].push(e)});const n=Object.keys(a);n.length>1?(n.map(e=>{const t=o.maps.find(t=>t.id===parseInt(e)),n=a[e].length;return`<option value="${e}">${t?t.name:"Mapa desconocido"} (${n} ubicaciones)</option>`}).join(""),parseInt(n[0])):mapaSeleccionado=parseInt(n[0]),await this.loadMap(mapaSeleccionado);const i=a[mapaSeleccionado];setTimeout(()=>{if(i.length>0){let e=1/0,a=1/0,n=-1/0,s=-1/0;if(i.forEach(t=>{t.markerX&&t.markerY&&(e=Math.min(e,t.markerX),a=Math.min(a,t.markerY),n=Math.max(n,t.markerX),s=Math.max(s,t.markerY))}),e===1/0)return;const r=this.elements.canvas,o=(e+n)/2,l=(a+s)/2,d=n-e,c=s-a;let p,u;if(1===i.length){if(i[0].areaId)return this.state.ubicacionesResaltadas=i.map(e=>({x:e.markerX,y:e.markerY,repuesto:t.nombre,descripcion:e.descripcion})),this.zoomToArea(i[0].areaId),void setTimeout(()=>{this.draw()},100);p=1.5,this.state.scale=p,this.state.offsetX=r.width/2-o*p,this.state.offsetY=r.height/2-l*p}else if(2===i.length){u=.8*Math.max(d,c);const e=r.width/(d+u),t=r.height/(c+u);p=Math.min(e,t,1.2),this.state.scale=Math.max(.2,p),this.state.offsetX=r.width/2-o*this.state.scale,this.state.offsetY=r.height/2-l*this.state.scale}else{const e=Math.max(.3,1-.05*i.length);u=Math.max(d,c)*e;const t=r.width/(d+u),a=r.height/(c+u);p=Math.min(t,a,1),this.state.scale=Math.max(.1,p),this.state.offsetX=r.width/2-o*this.state.scale,this.state.offsetY=r.height/2-l*this.state.scale}}[...new Set(i.map(e=>e.areaId))].forEach(e=>{this.flashArea?this.flashArea(e,2):this.highlightArea&&this.highlightArea(e)}),this.state.ubicacionesResaltadas=i.map(e=>({x:e.markerX,y:e.markerY,repuesto:t.nombre,descripcion:e.descripcion})),this.draw(),this.queueViewportPersist("multi-ubicaciones"),c.showToast(` ${i.length} ubicaciones resaltadas en el mapa`,"success")},500)},detectarClickEnMarcador(e,t){if(!c||!c.repuestos)return null;for(const a of c.repuestos){if(a.ubicaciones&&Array.isArray(a.ubicaciones))for(let n=0;n<a.ubicaciones.length;n++){const i=a.ubicaciones[n];if(String(i.mapId)===String(this.state.currentMapId)&&i.markerX&&i.markerY){if(Math.sqrt(Math.pow(e-i.markerX,2)+Math.pow(t-i.markerY,2))<=Math.max(40,Math.min(300,60/this.state.scale)))return{repuesto:a,ubicacionIndex:n,ubicacion:i,x:i.markerX,y:i.markerY}}}if(a.mapId&&String(a.mapId)===String(this.state.currentMapId)&&a.markerX&&a.markerY){if(Math.sqrt(Math.pow(e-a.markerX,2)+Math.pow(t-a.markerY,2))<=Math.max(40,Math.min(300,60/this.state.scale)))return{repuesto:a,ubicacionIndex:0,ubicacion:{mapId:a.mapId,areaId:a.areaId,markerX:a.markerX,markerY:a.markerY,descripcion:a.ubicacionDescripcion},x:a.markerX,y:a.markerY}}}return null},mostrarMenuMarcador(e,t,a){const n=document.getElementById("marcadorContextMenu");n&&n.remove();const{repuesto:i,ubicacionIndex:s,ubicacion:r}=e,l=o.areas.find(e=>e.id===r.areaId),d=l?l.name:"Ubicacin",c=i.imagenes&&i.imagenes.length>0||i.imagen,p=`\n      <div id="marcadorContextMenu" style="\n        position: fixed;\n        left: ${t}px;\n        top: ${a}px;\n        background: var(--bg-primary);\n        border: 2px solid var(--primary);\n        border-radius: 8px;\n        padding: 8px 0;\n        min-width: 220px;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n        z-index: 10000;\n        animation: fadeInScale 0.2s ease;\n      ">\n        <div style="\n          padding: 8px 12px;\n          font-weight: 600;\n          color: var(--primary);\n          border-bottom: 1px solid var(--border-color);\n          font-size: 0.85rem;\n        ">\n           ${i.nombre}\n        </div>\n        <div style="\n          padding: 6px 12px;\n          font-size: 0.75rem;\n          color: var(--text-secondary);\n          border-bottom: 1px solid var(--border-color);\n        ">\n          ${d}\n          ${r.descripcion?`<br><em>"${r.descripcion}"</em>`:""}\n        </div>\n        <button onclick="mapController.verMarcadorEnMapa('${i.id}', ${s})" style="\n          width: 100%;\n          padding: 8px 12px;\n          background: none;\n          border: none;\n          text-align: left;\n          cursor: pointer;\n          color: var(--text-primary);\n          font-size: 0.85rem;\n          transition: all 0.2s;\n        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">\n           Ver en Mapa\n        </button>\n        <button onclick="mapController.moverMarcador('${i.id}', ${s})" style="\n          width: 100%;\n          padding: 8px 12px;\n          background: none;\n          border: none;\n          text-align: left;\n          cursor: pointer;\n          color: var(--text-primary);\n          font-size: 0.85rem;\n          transition: all 0.2s;\n        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">\n           Mover Marcador\n        </button>\n        ${c?`\n        <button onclick="mapController.abrirModalImagenZoom('${i.id}'); document.getElementById('marcadorContextMenu').remove();" style="\n          width: 100%;\n          padding: 8px 12px;\n          background: none;\n          border: none;\n          text-align: left;\n          cursor: pointer;\n          color: var(--text-primary);\n          font-size: 0.85rem;\n          transition: all 0.2s;\n        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">\n           Ver Imagen\n        </button>\n        `:""}\n        <button onclick="app.editarDescripcionUbicacion('${i.id}', ${s}); document.getElementById('marcadorContextMenu').remove();" style="\n          width: 100%;\n          padding: 8px 12px;\n          background: none;\n          border: none;\n          text-align: left;\n          cursor: pointer;\n          color: var(--text-primary);\n          font-size: 0.85rem;\n          transition: all 0.2s;\n        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">\n           Editar Descripcin\n        </button>\n        <button onclick="app.irATarjeta('${i.id}'); document.getElementById('marcadorContextMenu').remove();" style="\n          width: 100%;\n          padding: 8px 12px;\n          background: none;\n          border: none;\n          text-align: left;\n          cursor: pointer;\n          color: var(--text-primary);\n          font-size: 0.85rem;\n          transition: all 0.2s;\n        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">\n           Ver Repuesto\n        </button>\n        <button onclick="app.eliminarUbicacionRepuesto('${i.id}', ${s}); document.getElementById('marcadorContextMenu').remove();" style="\n          width: 100%;\n          padding: 8px 12px;\n          background: none;\n          border: none;\n          text-align: left;\n          cursor: pointer;\n          color: var(--danger);\n          font-size: 0.85rem;\n          border-top: 1px solid var(--border-color);\n          transition: all 0.2s;\n          margin-top: 4px;\n        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">\n           Eliminar Ubicacin\n        </button>\n        <button onclick="document.getElementById('marcadorContextMenu').remove()" style="\n          width: 100%;\n          padding: 6px 12px;\n          background: none;\n          border: none;\n          text-align: center;\n          cursor: pointer;\n          color: var(--text-muted);\n          font-size: 0.75rem;\n          border-top: 1px solid var(--border-color);\n          margin-top: 4px;\n        ">\n          Cerrar\n        </button>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",p),setTimeout(()=>{const e=t=>{const a=document.getElementById("marcadorContextMenu");a&&!a.contains(t.target)&&(a.remove(),document.removeEventListener("click",e))};document.addEventListener("click",e)},100)},async verMarcadorEnMapa(e,t){const a=c.repuestos.find(t=>String(t.id)===String(e));if(!a)return;const n=document.getElementById("marcadorContextMenu");n&&n.remove(),this.cerrarTarjetaFija();let i=a.ubicaciones||[];0===i.length&&a.mapId&&a.areaId&&(i=[{mapId:a.mapId,areaId:a.areaId,markerX:a.markerX,markerY:a.markerY,descripcion:a.ubicacionDescripcion}]);const s=i[t];if(!s)return;const r=o.areas.find(e=>e.id===s.areaId);!r||r.name,this.state.repuestoFiltrado=e,this.showToast(` Filtrando "${a.nombre}" - ${i.length} ubicacin(es). Doble click afuera para limpiar filtro.`,"info",3e3),await this.loadMap(s.mapId),setTimeout(()=>{this.zoomToArea(s.areaId),setTimeout(()=>{const e=i.filter(e=>String(e.mapId)===String(this.state.currentMapId)&&e.markerX&&e.markerY);this.state.ubicacionesResaltadas=e.map(e=>({x:e.markerX,y:e.markerY,repuesto:a.nombre,descripcion:e.descripcion||"Ubicacin del repuesto"})),this.draw()},800)},500)},abrirModalImagenZoomDirecto(e,t){if(!e)return void this.showToast(" No hay imagen para mostrar","error");this.cerrarTarjetaFija();const a=`\n      <div id="modalImagenZoom" style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0, 0, 0, 0.95);\n        z-index: 20000;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        animation: fadeIn 0.2s ease;\n      " onclick="if(event.target.id === 'modalImagenZoom') mapController.cerrarModalImagenZoom()">\n        \x3c!-- Header --\x3e\n        <div style="\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          padding: 16px 24px;\n          background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          z-index: 2;\n        ">\n          <div style="\n            color: white;\n            font-size: 1.2rem;\n            font-weight: 600;\n            text-shadow: 0 2px 4px rgba(0,0,0,0.5);\n          ">\n             ${t||"Imagen"}\n          </div>\n          <button onclick="mapController.cerrarModalImagenZoom(); event.stopPropagation();" style="\n            background: rgba(255, 255, 255, 0.1);\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-radius: 8px;\n            color: white;\n            padding: 8px 16px;\n            font-size: 1.1rem;\n            cursor: pointer;\n            transition: all 0.2s;\n          " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">\n             Cerrar\n          </button>\n        </div>\n        \n        \x3c!-- Indicador de Zoom (solo lectura) --\x3e\n        <div style="\n          position: absolute;\n          bottom: 24px;\n          left: 50%;\n          transform: translateX(-50%);\n          background: rgba(0, 0, 0, 0.8);\n          border: 2px solid rgba(255, 255, 255, 0.2);\n          border-radius: 12px;\n          padding: 12px 24px;\n          z-index: 2;\n          pointer-events: none;\n        ">\n          <span id="zoomImagenLabel" style="\n            color: white;\n            font-weight: 600;\n            font-size: 1.1rem;\n            text-shadow: 0 1px 2px rgba(0,0,0,0.5);\n          "> 100% (usa el scroll para zoom)</span>\n        </div>\n        \n        \x3c!-- Container de imagen con scroll --\x3e\n        <div id="imagenZoomContainer" style="\n          flex: 1;\n          width: 100%;\n          height: 100%;\n          overflow: auto;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          padding: 80px 24px 120px;\n          cursor: grab;\n        ">\n          <img id="imagenZoomable" src="${e}" style="\n            max-width: 100%;\n            max-height: 100%;\n            object-fit: contain;\n            transition: transform 0.2s ease;\n            user-select: none;\n            -webkit-user-drag: none;\n          " draggable="false" onclick="event.stopPropagation()">\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",a),this.state.imagenZoom={scale:1,offsetX:0,offsetY:0,isDragging:!1,startX:0,startY:0};const n=document.getElementById("imagenZoomable"),i=document.getElementById("imagenZoomContainer");n.addEventListener("mousedown",e=>{this.state.imagenZoom.scale>1&&(e.preventDefault(),e.stopPropagation(),this.state.imagenZoom.isDragging=!0,this.state.imagenZoom.startX=e.clientX-this.state.imagenZoom.offsetX,this.state.imagenZoom.startY=e.clientY-this.state.imagenZoom.offsetY,i.style.cursor="grabbing")}),i.addEventListener("mousemove",e=>{this.state.imagenZoom.isDragging&&(this.state.imagenZoom.offsetX=e.clientX-this.state.imagenZoom.startX,this.state.imagenZoom.offsetY=e.clientY-this.state.imagenZoom.startY,this.actualizarTransformImagen())}),i.addEventListener("mouseup",()=>{this.state.imagenZoom.isDragging=!1,this.state.imagenZoom.scale>1&&(i.style.cursor="grab")}),i.addEventListener("mouseleave",()=>{this.state.imagenZoom.isDragging=!1,this.state.imagenZoom.scale>1&&(i.style.cursor="grab")}),i.addEventListener("wheel",e=>{e.preventDefault(),e.stopPropagation();const t=e.deltaY>0?-.1:.1;this.ajustarZoomImagen(t)},{passive:!1});const s=e=>{"Escape"===e.key&&(this.cerrarModalImagenZoom(),document.removeEventListener("keydown",s))};document.addEventListener("keydown",s)},async abrirModalImagenZoom(e){const t=c.repuestos.find(t=>String(t.id)===String(e));if(!t)return;this.cerrarTarjetaFija();let a=null;if(t.imagenes&&t.imagenes.length>0?a=t.imagenes[0].path:t.imagen&&(a=t.imagen),!a)return void this.showToast(" Este repuesto no tiene imagen","error");let n=null;try{n=await c.dirHandle.getFileHandle(a)}catch(s){return void this.showToast(" No se encontr la imagen","error")}const i=`\n      <div id="modalImagenZoom" style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0, 0, 0, 0.95);\n        z-index: 20000;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        animation: fadeIn 0.2s ease;\n      ">\n        \x3c!-- Header --\x3e\n        <div style="\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          padding: 16px 24px;\n          background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          z-index: 2;\n        ">\n          <div style="\n            color: white;\n            font-size: 1.2rem;\n            font-weight: 600;\n            text-shadow: 0 2px 4px rgba(0,0,0,0.5);\n          ">\n             ${t.nombre}\n          </div>\n          <button onclick="mapController.cerrarModalImagenZoom()" style="\n            background: rgba(255, 255, 255, 0.1);\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-radius: 8px;\n            color: white;\n            padding: 8px 16px;\n            font-size: 1.1rem;\n            cursor: pointer;\n            transition: all 0.2s;\n          " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">\n             Cerrar\n          </button>\n        </div>\n        \n        \x3c!-- Indicador de Zoom (solo lectura) --\x3e\n        <div style="\n          position: absolute;\n          bottom: 24px;\n          left: 50%;\n          transform: translateX(-50%);\n          background: rgba(0, 0, 0, 0.8);\n          border: 2px solid rgba(255, 255, 255, 0.2);\n          border-radius: 12px;\n          padding: 12px 24px;\n          z-index: 2;\n          pointer-events: none;\n        ">\n          <span id="zoomImagenLabel" style="\n            color: white;\n            font-weight: 600;\n            font-size: 1.1rem;\n            text-shadow: 0 1px 2px rgba(0,0,0,0.5);\n          "> 100% (usa el scroll para zoom)</span>\n        </div>\n        \n        \x3c!-- Container de imagen con scroll --\x3e\n        <div id="imagenZoomContainer" style="\n          flex: 1;\n          width: 100%;\n          height: 100%;\n          overflow: auto;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          padding: 80px 24px 120px;\n          cursor: grab;\n        ">\n          <img id="imagenZoomable" src="" style="\n            max-width: 100%;\n            max-height: 100%;\n            object-fit: contain;\n            transition: transform 0.2s ease;\n            user-select: none;\n            -webkit-user-drag: none;\n          " draggable="false">\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",i);try{const e=await n.getFile(),t=URL.createObjectURL(e),a=document.getElementById("imagenZoomable");a.src=t,this.state.imagenZoom={scale:1,offsetX:0,offsetY:0,isDragging:!1,startX:0,startY:0};const i=document.getElementById("imagenZoomContainer");a.addEventListener("mousedown",e=>{this.state.imagenZoom.scale>1&&(e.preventDefault(),this.state.imagenZoom.isDragging=!0,this.state.imagenZoom.startX=e.clientX-this.state.imagenZoom.offsetX,this.state.imagenZoom.startY=e.clientY-this.state.imagenZoom.offsetY,i.style.cursor="grabbing")}),i.addEventListener("mousemove",e=>{this.state.imagenZoom.isDragging&&(this.state.imagenZoom.offsetX=e.clientX-this.state.imagenZoom.startX,this.state.imagenZoom.offsetY=e.clientY-this.state.imagenZoom.startY,this.actualizarTransformImagen())}),i.addEventListener("mouseup",()=>{this.state.imagenZoom.isDragging=!1,this.state.imagenZoom.scale>1&&(i.style.cursor="grab")}),i.addEventListener("mouseleave",()=>{this.state.imagenZoom.isDragging=!1,this.state.imagenZoom.scale>1&&(i.style.cursor="grab")}),i.addEventListener("wheel",e=>{e.preventDefault();const t=e.deltaY>0?-.1:.1;this.ajustarZoomImagen(t)},{passive:!1});const s=e=>{"Escape"===e.key&&(this.cerrarModalImagenZoom(),document.removeEventListener("keydown",s))};document.addEventListener("keydown",s)}catch(s){this.showToast(" Error al cargar la imagen","error"),this.cerrarModalImagenZoom()}},ajustarZoomImagen(e){if(!this.state.imagenZoom)return;this.state.imagenZoom.scale=Math.max(.5,Math.min(5,this.state.imagenZoom.scale+e));const t=document.getElementById("imagenZoomContainer");this.state.imagenZoom.scale>1?t.style.cursor="grab":(t.style.cursor="default",this.state.imagenZoom.offsetX=0,this.state.imagenZoom.offsetY=0),this.actualizarTransformImagen()},resetearZoomImagen(){if(!this.state.imagenZoom)return;this.state.imagenZoom.scale=1,this.state.imagenZoom.offsetX=0,this.state.imagenZoom.offsetY=0;document.getElementById("imagenZoomContainer").style.cursor="default",this.actualizarTransformImagen()},actualizarTransformImagen(){const e=document.getElementById("imagenZoomable"),t=document.getElementById("zoomImagenLabel");if(e&&(e.style.transform=`scale(${this.state.imagenZoom.scale}) translate(${this.state.imagenZoom.offsetX/this.state.imagenZoom.scale}px, ${this.state.imagenZoom.offsetY/this.state.imagenZoom.scale}px)`),t){const e=Math.round(100*this.state.imagenZoom.scale);t.textContent=` ${e}%${100===e?" (usa el scroll para zoom)":""}`}},cerrarModalImagenZoom(){const e=document.getElementById("modalImagenZoom");if(e){const t=document.getElementById("imagenZoomable");t&&t.src.startsWith("blob:")&&URL.revokeObjectURL(t.src),e.remove()}this.state.imagenZoom=null},mostrarTarjetaHoverRepuesto(e,t,a){var n;const{repuesto:i,ubicacion:s}=e;if("true"===(null==(n=document.getElementById("tarjetaHoverRepuesto"))?void 0:n.dataset.fija))return;let r=document.getElementById("tarjetaHoverRepuesto");if(r&&r.dataset.repuestoId===String(i.id))return r.style.left=t+20+"px",void(r.style.top=a-10+"px");r&&r.remove(),this.crearTarjetaRepuesto(i,s,t,a,!1)},fijarTarjetaHoverRepuesto(e,t,a){const{repuesto:n,ubicacion:i,ubicacionIndex:s}=e,r=document.getElementById("tarjetaHoverRepuesto");r&&r.remove(),this.crearTarjetaRepuesto(n,i,t,a,!0,s)},crearTarjetaRepuesto(e,t,a,n,i=!1,s=0){const r=o.areas.find(e=>e.id===t.areaId),l=r?r.name:"rea desconocida",d=e.cantidad||0,c=e.minimo||0,p=e.optimo||0,u=this.state.zoom||1,m=Math.max(.6,1/Math.sqrt(u)),h=(1*m).toFixed(2)+"rem",g=(.8*m).toFixed(2)+"rem",b=(.75*m).toFixed(2)+"rem",v=(.7*m).toFixed(2)+"rem",y=(1.1*m).toFixed(2)+"rem",f=(.95*m).toFixed(2)+"rem",x=(.8*m).toFixed(2)+"rem",S=Math.round(300*m),w=Math.round(14*m);let A="",E="";0===d?(A="SIN STOCK",E="#ef4444"):d<c?(A="BAJO",E="#f59e0b"):d>=p?(A="PTIMO",E="#22c55e"):(A="NORMAL",E="#3b82f6");let I="";if(e.multimedia&&e.multimedia.length>0){const t=e.multimedia.filter(e=>"image"===e.type),a=new Set,n=t.filter(e=>{const t=e.url||"";return!(!t||a.has(t))&&(a.add(t),!0)}).slice(0,5);if(n.length>0){const t=Math.round(140*m);I=`\n          <div id="carruselContainer" style="position: relative; margin-bottom: ${Math.round(12*m)}px;">\n            \x3c!-- Imgenes del carrusel --\x3e\n            <div id="carruselImagenes" style="\n              width: 100%;\n              height: ${t}px;\n              position: relative;\n              overflow: hidden;\n              border-radius: ${Math.round(6*m)}px;\n              border: 1px solid rgba(255,255,255,0.1);\n            ">\n              ${n.map((t,a)=>{let n=t.url||"";return n.startsWith("./imagenes/")?n="INVENTARIO_STORAGE/imagenes/"+n.substring(11):n.startsWith("imagenes/")&&(n="INVENTARIO_STORAGE/"+n),`\n                  <div class="carrusel-item" data-index="${a}" \n                    onclick="mapController.abrirModalImagenZoomDirecto('${n.replace(/'/g,"\\'")}', '${e.nombre.replace(/'/g,"\\'")}'); event.stopPropagation();"\n                    style="\n                    position: absolute;\n                    top: 0;\n                    left: 0;\n                    width: 100%;\n                    height: 100%;\n                    background: url('${n}') center/cover no-repeat, linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(37,99,235,0.1) 100%);\n                    opacity: ${0===a?"1":"0"};\n                    transition: opacity 0.3s ease-in-out;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    cursor: zoom-in;\n                  ">\n                    ${n?"":'<div style="font-size: 3rem; opacity: 0.3;"></div>'}\n                    ${n?'<div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; pointer-events: none;"> Click para ampliar</div>':""}\n                  </div>\n                `}).join("")}\n            </div>\n            \n            ${n.length>1?`\n              \x3c!-- Flechas de navegacin --\x3e\n              <button onclick="mapController.anteriorImagenCarrusel(event)" style="\n                position: absolute;\n                left: ${Math.round(8*m)}px;\n                top: 50%;\n                transform: translateY(-50%);\n                background: rgba(0,0,0,0.7);\n                color: white;\n                border: none;\n                border-radius: 50%;\n                width: ${Math.round(32*m)}px;\n                height: ${Math.round(32*m)}px;\n                cursor: pointer;\n                font-size: ${Math.round(18*m)}px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10;\n                transition: all 0.2s;\n              " onmouseenter="this.style.background='rgba(0,0,0,0.9)'" onmouseleave="this.style.background='rgba(0,0,0,0.7)'">\n                \n              </button>\n              <button onclick="mapController.siguienteImagenCarrusel(event)" style="\n                position: absolute;\n                right: ${Math.round(8*m)}px;\n                top: 50%;\n                transform: translateY(-50%);\n                background: rgba(0,0,0,0.7);\n                color: white;\n                border: none;\n                border-radius: 50%;\n                width: ${Math.round(32*m)}px;\n                height: ${Math.round(32*m)}px;\n                cursor: pointer;\n                font-size: ${Math.round(18*m)}px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10;\n                transition: all 0.2s;\n              " onmouseenter="this.style.background='rgba(0,0,0,0.9)'" onmouseleave="this.style.background='rgba(0,0,0,0.7)'">\n                \n              </button>\n              \n              \x3c!-- Indicadores (dots) --\x3e\n              <div style="\n                position: absolute;\n                bottom: ${Math.round(8*m)}px;\n                left: 50%;\n                transform: translateX(-50%);\n                display: flex;\n                gap: ${Math.round(6*m)}px;\n                z-index: 10;\n              ">\n                ${n.map((e,t)=>`\n                  <div class="carrusel-dot" data-index="${t}" style="\n                    width: ${Math.round(8*m)}px;\n                    height: ${Math.round(8*m)}px;\n                    border-radius: 50%;\n                    background: ${0===t?"white":"rgba(255,255,255,0.4)"};\n                    cursor: pointer;\n                    transition: background 0.3s;\n                  " onclick="mapController.irAImagenCarrusel(${t}, event)"></div>\n                `).join("")}\n              </div>\n            `:""}\n          </div>\n        `}}let $="";if(i){const t=`${Math.round(8*m)}px ${Math.round(12*m)}px`,a=Math.round(6*m)+"px",n=Math.round(6*m)+"px";$=`\n        <div style="\n          display: grid;\n          grid-template-columns: 1fr 1fr 1fr;\n          gap: ${n};\n          margin-top: ${Math.round(12*m)}px;\n          padding-top: ${Math.round(12*m)}px;\n          border-top: 1px solid rgba(255,255,255,0.1);\n        ">\n          <button onclick="mapController.verMarcadorEnMapa('${e.id}', ${s}); event.stopPropagation();" style="\n            padding: ${t};\n            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);\n            color: white;\n            border: none;\n            border-radius: ${a};\n            font-size: ${x};\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.2s;\n          " onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform='translateY(0)'">\n             Ver\n          </button>\n          <button onclick="mapController.openEditMarkerModal('${e.id}', ${s}); event.stopPropagation();" style="\n            padding: ${t};\n            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);\n            color: white;\n            border: none;\n            border-radius: ${a};\n            font-size: ${x};\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.2s;\n          " onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform='translateY(0)'">\n            E Datos\n          </button>\n          <button onclick="mapController.moverMarcador('${e.id}', ${s}); event.stopPropagation();" style="\n            padding: ${t};\n            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);\n            color: white;\n            border: none;\n            border-radius: ${a};\n            font-size: ${x};\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.2s;\n          " onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform='translateY(0)'">\n             Mover\n          </button>\n        </div>\n        <div style="\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: ${n};\n          margin-top: ${n};\n        ">\n          <button onclick="mapController.irATarjetaDesdeMapa('${e.id}'); event.stopPropagation();" style="\n            padding: ${t};\n            background: rgba(255,255,255,0.1);\n            color: white;\n            border: 1px solid rgba(255,255,255,0.2);\n            border-radius: ${a};\n            font-size: ${x};\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.2s;\n          " onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">\n             Tarjeta\n          </button>\n          <button onclick="app.eliminarUbicacionRepuesto('${e.id}', ${s}); mapController.cerrarTarjetaFija(); event.stopPropagation();" style="\n            padding: ${t};\n            background: rgba(239, 68, 68, 0.2);\n            color: #ef4444;\n            border: 1px solid #ef4444;\n            border-radius: ${a};\n            font-size: ${x};\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.2s;\n          " onmouseenter="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseleave="this.style.background='rgba(239, 68, 68, 0.2)'">\n             Eliminar\n          </button>\n        </div>\n      `}const k=`\n      <div id="tarjetaHoverRepuesto" \n           data-repuesto-id="${e.id}" \n           data-fija="${i}"\n           style="\n        position: fixed;\n        left: ${a+20}px;\n        top: ${n-10}px;\n        background: rgba(15, 23, 42, 0.98);\n        color: white;\n        border-radius: ${Math.round(12*m)}px;\n        box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.1);\n        z-index: 99999;\n        width: ${S}px;\n        backdrop-filter: blur(20px);\n        animation: fadeInCard 0.2s ease-out;\n        ${i?"pointer-events: auto; cursor: default;":"pointer-events: none;"}\n      ">\n        <style>\n          @keyframes fadeInCard {\n            from { opacity: 0; transform: translateY(10px); }\n            to { opacity: 1; transform: translateY(0); }\n          }\n        </style>\n        \n        <div style="padding: ${w}px;">\n          ${I}\n          \n          \x3c!-- Ttulo --\x3e\n          <div style="font-weight: 700; font-size: ${h}; margin-bottom: ${Math.round(8*m)}px; line-height: 1.3;">\n            ${e.nombre}\n          </div>\n          \n          \x3c!-- Cdigos --\x3e\n          ${e.codigoSAP||e.codigoFabrica?`\n            <div style="font-size: ${b}; opacity: 0.7; margin-bottom: ${Math.round(10*m)}px; font-family: 'Courier New', monospace;">\n              ${e.codigoSAP?`SAP: ${e.codigoSAP}`:""}\n              ${e.codigoSAP&&e.codigoFabrica?" | ":""}\n              ${e.codigoFabrica?`FAB: ${e.codigoFabrica}`:""}\n            </div>\n          `:""}\n          \n          \x3c!-- Stock --\x3e\n          <div style="\n            display: flex;\n            gap: ${Math.round(8*m)}px;\n            margin-bottom: ${Math.round(10*m)}px;\n            padding: ${Math.round(8*m)}px ${Math.round(10*m)}px;\n            background: rgba(255,255,255,0.05);\n            border-radius: ${Math.round(6*m)}px;\n            border-left: ${Math.round(3*m)}px solid ${E};\n          ">\n            <div style="flex: 1;">\n              <div style="font-size: ${v}; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px;">Stock</div>\n              <div style="font-size: ${y}; font-weight: 700; color: ${E};">${d}</div>\n            </div>\n            <div style="flex: 1;">\n              <div style="font-size: ${v}; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px;">Mn</div>\n              <div style="font-size: ${f}; font-weight: 600;">${c}</div>\n            </div>\n            <div style="flex: 1;">\n              <div style="font-size: ${v}; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px;">pt</div>\n              <div style="font-size: ${f}; font-weight: 600;">${p}</div>\n            </div>\n          </div>\n          \n          \x3c!-- Estado --\x3e\n          <div style="\n            display: inline-block;\n            padding: ${Math.round(4*m)}px ${Math.round(10*m)}px;\n            background: ${E}22;\n            border: 1px solid ${E};\n            border-radius: ${Math.round(6*m)}px;\n            font-size: ${v};\n            font-weight: 700;\n            color: ${E};\n            letter-spacing: 0.5px;\n            margin-bottom: ${Math.round(8*m)}px;\n          ">\n            ${A}\n          </div>\n          \n          \x3c!-- Ubicacin --\x3e\n          <div style="\n            font-size: ${g};\n            opacity: 0.8;\n            padding-top: ${Math.round(8*m)}px;\n            border-top: 1px solid rgba(255,255,255,0.1);\n          ">\n             ${l}\n          </div>\n          \n          ${$}\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",k),i&&setTimeout(()=>{const e=t=>{const a=document.getElementById("tarjetaHoverRepuesto"),n=document.getElementById("mapCanvas"),i=n&&n.contains(t.target);if(a&&!a.contains(t.target)){if(i)return;a.remove(),document.removeEventListener("click",e)}};document.addEventListener("click",e)},200)},ocultarTarjetaHoverRepuesto(){const e=document.getElementById("tarjetaHoverRepuesto");e&&"true"!==e.dataset.fija&&e.remove()},cerrarTarjetaFija(){const e=document.getElementById("tarjetaHoverRepuesto");e&&"true"===e.dataset.fija&&e.remove()},siguienteImagenCarrusel(e){e.stopPropagation();const t=document.querySelectorAll(".carrusel-item");if(t.length<=1)return;let a=0;t.forEach((e,t)=>{"1"===e.style.opacity&&(a=t)});const n=(a+1)%t.length;this.mostrarImagenCarrusel(n)},anteriorImagenCarrusel(e){e.stopPropagation();const t=document.querySelectorAll(".carrusel-item");if(t.length<=1)return;let a=0;t.forEach((e,t)=>{"1"===e.style.opacity&&(a=t)});const n=(a-1+t.length)%t.length;this.mostrarImagenCarrusel(n)},irAImagenCarrusel(e,t){t.stopPropagation(),this.mostrarImagenCarrusel(e)},mostrarImagenCarrusel(e){const t=document.querySelectorAll(".carrusel-item"),a=document.querySelectorAll(".carrusel-dot");t.forEach((t,a)=>{t.style.opacity=a===e?"1":"0"}),a.forEach((t,a)=>{t.style.background=a===e?"white":"rgba(255,255,255,0.4)"})},irATarjetaDesdeMapa(e){this.cerrarTarjetaFija(),void 0!==c&&c.irATarjeta&&setTimeout(()=>{c.irATarjeta(e)},100)},async moverMarcador(e,t){const a=c.repuestos.find(t=>String(t.id)===String(e));if(!a)return;const n=document.getElementById("marcadorContextMenu");n&&n.remove();let i=a.ubicaciones||[];0===i.length&&a.mapId&&a.areaId&&(i=[{mapId:a.mapId,areaId:a.areaId,markerX:a.markerX,markerY:a.markerY,descripcion:a.ubicacionDescripcion}],a.ubicaciones=i,delete a.mapId,delete a.areaId,delete a.markerX,delete a.markerY,delete a.ubicacionDescripcion);const s=i[t];if(!s)return;const r=o.areas.find(e=>e.id===s.areaId),l=o.maps.find(e=>e.id===s.mapId),d=r?r.name:"rea desconocida",p=l?l.name:"Mapa desconocido",u=document.getElementById("modalSeleccionUbicacion");u&&u.remove(),c.switchTab("mapa"),this.showToast(" Cargando mapa...","info",1500),setTimeout(async()=>{await this.loadMap(s.mapId),setTimeout(()=>{this.zoomToArea(s.areaId),setTimeout(()=>{this.state.ubicacionesResaltadas=[{x:s.markerX,y:s.markerY,repuesto:a.nombre,descripcion:s.descripcion}],this.draw(),this.mostrarModalMoverPin(a,s,t,d,p)},800)},500)},300)},mostrarModalMoverPin(e,t,a,n,i){this.state.pinAMover={repuestoId:e.id,ubicacionIndex:a,ubicacionOriginal:{...t},editando:!1};const s=`\n      <div id="modalMoverPin" style="\n        position: fixed;\n        top: 80px;\n        right: 20px;\n        background: rgba(30, 41, 59, 0.95);\n        color: white;\n        padding: 16px 20px;\n        border-radius: 12px;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.1);\n        z-index: 10000;\n        width: 320px;\n        backdrop-filter: blur(20px);\n        animation: fadeInRight 0.3s ease-out;\n        cursor: move;\n      " onmousedown="mapController.iniciarArrastreModal(event)">\n        <style>\n          @keyframes fadeInRight {\n            from {\n              transform: translateX(100px);\n              opacity: 0;\n            }\n            to {\n              transform: translateX(0);\n              opacity: 1;\n            }\n          }\n          @keyframes pulse {\n            0%, 100% { transform: scale(1); }\n            50% { transform: scale(1.1); }\n          }\n          #modalMoverPin:hover {\n            background: rgba(30, 41, 59, 0.98);\n          }\n        </style>\n        \n        \x3c!-- Ttulo compacto con drag handle --\x3e\n        <div style="\n          display: flex;\n          align-items: center;\n          gap: 10px;\n          margin-bottom: 14px;\n          padding-bottom: 12px;\n          border-bottom: 1px solid rgba(255,255,255,0.1);\n        ">\n          <div style="\n            font-size: 1.4rem;\n            animation: pulse 2s infinite;\n          "></div>\n          <div style="flex: 1;">\n            <div style="font-size: 0.95rem; font-weight: 700; margin-bottom: 2px;">\n              Mover Pin\n            </div>\n            <div style="font-size: 0.75rem; opacity: 0.7;">\n              ${e.nombre.length>25?e.nombre.substring(0,25)+"...":e.nombre}\n            </div>\n          </div>\n          <button onclick="event.stopPropagation(); mapController.cancelarMoverPin()" style="\n            background: rgba(255,255,255,0.1);\n            border: none;\n            color: white;\n            width: 28px;\n            height: 28px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 1.1rem;\n            transition: all 0.2s;\n            line-height: 1;\n            padding: 0;\n          " onmouseenter="this.style.background='rgba(255,60,60,0.8)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">\n            \n          </button>\n        </div>\n        \n        \x3c!-- Info compacta --\x3e\n        <div style="\n          background: rgba(255,255,255,0.08);\n          padding: 10px 12px;\n          border-radius: 8px;\n          margin-bottom: 14px;\n          border-left: 3px solid #3b82f6;\n          font-size: 0.85rem;\n        ">\n          <div style="opacity: 0.7; margin-bottom: 4px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">\n            Ubicacin Actual\n          </div>\n          <div style="display: flex; flex-direction: column; gap: 3px;">\n            <div> ${i.length>30?i.substring(0,30)+"...":i}</div>\n            <div> ${n.length>30?n.substring(0,30)+"...":n}</div>\n          </div>\n        </div>\n        \n        \x3c!-- Botones compactos --\x3e\n        <div id="botonesIniciales" style="display: flex; gap: 8px;">\n          <button id="btnIniciarMoverPin" onclick="event.stopPropagation(); mapController.iniciarEdicionPin()" style="\n            flex: 1;\n            padding: 10px 16px;\n            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);\n            color: white;\n            border: none;\n            border-radius: 8px;\n            font-size: 0.9rem;\n            font-weight: 700;\n            cursor: pointer;\n            transition: all 0.3s;\n            box-shadow: 0 3px 8px rgba(59, 130, 246, 0.3);\n          " onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 12px rgba(59, 130, 246, 0.4)'" \n             onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 8px rgba(59, 130, 246, 0.3)'">\n             Mover\n          </button>\n          <button onclick="event.stopPropagation(); mapController.cancelarMoverPin()" style="\n            padding: 10px 16px;\n            background: rgba(255,255,255,0.1);\n            color: white;\n            border: 1px solid rgba(255,255,255,0.2);\n            border-radius: 8px;\n            font-size: 0.9rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.2s;\n          " onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">\n            \n          </button>\n        </div>\n        \n        \x3c!-- Botones durante edicin (ocultos inicialmente) --\x3e\n        <div id="botonesEdicion" style="display: none; gap: 8px;">\n          <button id="btnGuardarNuevaPosicion" onclick="event.stopPropagation(); mapController.guardarNuevaPosicionPin()" style="\n            flex: 1;\n            padding: 10px 16px;\n            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);\n            color: white;\n            border: none;\n            border-radius: 8px;\n            font-size: 0.9rem;\n            font-weight: 700;\n            cursor: pointer;\n            transition: all 0.3s;\n            box-shadow: 0 3px 8px rgba(34, 197, 94, 0.3);\n          " onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 12px rgba(34, 197, 94, 0.4)'" \n             onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 8px rgba(34, 197, 94, 0.3)'">\n             Guardar\n          </button>\n          <button onclick="event.stopPropagation(); mapController.cancelarMoverPin()" style="\n            padding: 10px 16px;\n            background: rgba(255,255,255,0.1);\n            color: white;\n            border: 1px solid rgba(255,255,255,0.2);\n            border-radius: 8px;\n            font-size: 0.9rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.2s;\n          " onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">\n            \n          </button>\n        </div>\n        \n        \x3c!--  Ayuda del crculo pulsante --\x3e\n        <div style="\n          margin-top: 12px;\n          padding: 8px 12px;\n          background: rgba(59, 130, 246, 0.15);\n          border-left: 3px solid #3b82f6;\n          border-radius: 6px;\n          font-size: 0.8rem;\n          line-height: 1.4;\n        ">\n          <strong style="color: #60a5fa;"> Crculo azul pulsante:</strong>\n          <div style="opacity: 0.9; margin-top: 4px;">\n            Indica la ubicacin actual del repuesto en el mapa. Al activar "Mover", el pin se volver naranja y podrs arrastrarlo.\n          </div>\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",s)},iniciarArrastreModal(e){if("BUTTON"===e.target.tagName||e.target.closest("button"))return;const t=document.getElementById("modalMoverPin");if(!t)return;this.state.arrastreModal={activo:!0,inicioX:e.clientX,inicioY:e.clientY,modalX:t.offsetLeft,modalY:t.offsetTop},t.style.cursor="grabbing";const a=e=>{if(!this.state.arrastreModal||!this.state.arrastreModal.activo)return;const a=e.clientX-this.state.arrastreModal.inicioX,n=e.clientY-this.state.arrastreModal.inicioY,i=this.state.arrastreModal.modalX+a,s=this.state.arrastreModal.modalY+n,r=window.innerWidth-t.offsetWidth,o=window.innerHeight-t.offsetHeight;t.style.left=Math.max(0,Math.min(i,r))+"px",t.style.top=Math.max(0,Math.min(s,o))+"px",t.style.right="auto"},n=()=>{t&&(t.style.cursor="move"),this.state.arrastreModal=null,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",n)},iniciarEdicionPin(){if(!this.state.pinAMover)return;this.state.pinAMover.editando=!0;const e=document.getElementById("botonesIniciales"),t=document.getElementById("botonesEdicion");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.showToast(" Arrastra el pin naranja a su nueva ubicacin","info",4e3),this.draw()},cancelarMoverPin(){this.state.pinAMover=null,this.state.ubicacionesResaltadas=null;const e=document.getElementById("modalMoverPin");e&&e.remove(),this.draw(),this.showToast(" Movimiento de pin cancelado","info")},async guardarNuevaPosicionPin(){if(!this.state.pinAMover)return;const{repuestoId:e,ubicacionIndex:t}=this.state.pinAMover,a=c.repuestos.find(t=>String(t.id)===String(e));if(!a)return;if(!this.state.ubicacionesResaltadas||0===this.state.ubicacionesResaltadas.length)return void this.showToast(" Debes mover el pin primero","warning");const n=this.state.ubicacionesResaltadas[0],i=this.buscarAreasCercanas(n.x,n.y,300);if(0===i.length)return void this.showToast(" El pin debe estar dentro de un rea","warning");const s=i[0].area;a.ubicaciones&&a.ubicaciones[t]&&(a.ubicaciones[t].markerX=n.x,a.ubicaciones[t].markerY=n.y,a.ubicaciones[t].areaId=s.id);try{await c.saveData(),this.showToast(` Pin movido exitosamente a "${s.name}"`,"success"),this.state.pinAMover=null,this.state.ubicacionesResaltadas=null;const e=document.getElementById("modalMoverPin");e&&e.remove(),this.draw()}catch(r){this.showToast(" Error al guardar la nueva posicin","error")}},openNewMapModal(){if(!o.initialized)return void this.showToast("Conecta la carpeta antes de crear un mapa.","info");const e=this.elements.modal,t=this.elements.modalBody;if(!e||!t)return;this.elements.modalTitle.textContent="Nuevo mapa",t.innerHTML='\n      <form id="mapCreateForm" class="map-area-form">\n        <div class="form-group">\n          <label>Nombre del mapa</label>\n          <input type="text" name="mapName" required placeholder="Ej: Planta principal" />\n        </div>\n        <div class="form-group">\n          <label>Imagen del mapa</label>\n          <input type="file" name="mapImage" accept="image/*" required />\n          <small style="color: var(--text-secondary); font-size: 0.75rem;">Se recomienda usar imgenes en alta resolucin (PNG, JPG o WEBP).</small>\n        </div>\n        <div class="form-actions">\n          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>\n          <button type="submit" class="map-btn map-btn--primary">Guardar mapa</button>\n        </div>\n      </form>\n    ',e.classList.remove("hidden");const a=t.querySelector("#mapCreateForm"),n=t.querySelector('[data-action="cancel"]');n&&n.addEventListener("click",()=>this.closeModal()),a&&a.addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(a);await this.createMapFromForm(t)})},async createMapFromForm(e){const t=(e.get("mapName")||"").toString().trim(),a=e.get("mapImage");if(t)if(a instanceof File)try{await o.ensureStructure();const e=Date.now(),n=(a.name.split(".").pop()||"png").toLowerCase(),i=`map_${e}.${n.length<=5?n:"png"}`;let s=o.mapImagesDir;s||(s=await o.rootHandle.getDirectoryHandle("imagenes",{create:!0}),s=await s.getDirectoryHandle("mapas",{create:!0}),o.mapImagesDir=s);const r=await s.getFileHandle(i,{create:!0}),l=await r.createWritable();await l.write(a),await l.close();const d=await this.getImageDimensions(a),p={id:e,name:t,imagePath:`${o.mapImagesPath.join("/")}/${i}`,width:d.width,height:d.height,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),jerarquiaPath:[]},u=[...o.maps||[],p];await o.saveMaps(u,{action:"create",mapId:p.id,detail:p.name}),this.closeModal(),await this.loadData(),await this.selectMap(p.id),this.showToast("Mapa creado correctamente.","success"),c&&c.jerarquiaAnidada&&this.openAssignJerarquiaModal(p.id)}catch(n){this.showToast("No se pudo crear el mapa. Revisa la consola.","error")}else this.showToast("Selecciona una imagen para el mapa.","warning");else this.showToast("Asigna un nombre al mapa.","warning")},getImageDimensions:async e=>new Promise(t=>{const a=URL.createObjectURL(e),n=new Image;n.onload=()=>{t({width:n.width,height:n.height}),URL.revokeObjectURL(a)},n.onerror=()=>{URL.revokeObjectURL(a),t({width:0,height:0})},n.src=a}),async openEditMapModal(e){const t="string"==typeof e?parseInt(e,10):e,a=o.getMapById(t);if(!a)return void this.showToast("Mapa no encontrado.","warning");const n=this.elements.modal,i=this.elements.modalBody;if(!n||!i)return;this.elements.modalTitle.textContent="Editar mapa",i.innerHTML=`\n      <form id="mapEditForm" class="map-area-form">\n        <div class="form-group">\n          <label>Nombre del mapa</label>\n          <input type="text" name="mapName" required placeholder="Ej: Planta principal" value="${this.escapeHtml(a.name)}" />\n        </div>\n        <div class="form-group">\n          <label>Imagen del mapa (opcional - dejar vaco para mantener actual)</label>\n          <input type="file" name="mapImage" accept="image/*" />\n          <small style="color: var(--text-secondary); font-size: 0.75rem;">\n            Imagen actual: ${a.width}  ${a.height}px\n          </small>\n        </div>\n        <div class="form-group">\n          <label>Jerarqua asignada</label>\n          <div class="map-jerarquia-inline">\n            <span class="map-jerarquia-inline-label">${this.escapeHtml(this.getJerarquiaPathLabel(a.jerarquiaPath))}</span>\n            <button type="button" class="map-btn map-btn--ghost" data-action="open-assign-jerarquia">Editar jerarqua</button>\n          </div>\n        </div>\n        <div class="form-actions">\n          <button type="button" class="map-btn map-btn--ghost" data-action="cancel">Cancelar</button>\n          <button type="submit" class="map-btn map-btn--primary">Guardar cambios</button>\n        </div>\n      </form>\n    `,n.classList.remove("hidden");const s=i.querySelector("#mapEditForm"),r=i.querySelector('[data-action="cancel"]'),l=i.querySelector('[data-action="open-assign-jerarquia"]');r&&r.addEventListener("click",()=>this.closeModal()),l&&l.addEventListener("click",()=>{this.closeModal(),this.openAssignJerarquiaModal(a.id)}),s&&s.addEventListener("submit",async e=>{e.preventDefault();const a=new FormData(s);await this.updateMapFromForm(t,a)})},async updateMapFromForm(e,t){const a=(t.get("mapName")||"").toString().trim(),n=t.get("mapImage");if(!a)return void this.showToast("Asigna un nombre al mapa.","warning");const i=o.getMapById(e);if(i)try{let t={...i,name:a,updatedAt:(new Date).toISOString()};if(n&&n instanceof File&&n.size>0){await o.ensureStructure();const e=Date.now(),a=(n.name.split(".").pop()||"png").toLowerCase(),i=`map_${e}.${a.length<=5?a:"png"}`;let s=o.mapImagesDir;s||(s=await o.rootHandle.getDirectoryHandle("imagenes",{create:!0}),s=await s.getDirectoryHandle("mapas",{create:!0}),o.mapImagesDir=s);const r=await s.getFileHandle(i,{create:!0}),l=await r.createWritable();await l.write(n),await l.close();const d=await this.getImageDimensions(n);t.imagePath=`${o.mapImagesPath.join("/")}/${i}`,t.width=d.width,t.height=d.height}const s=o.maps.map(a=>a.id===e?t:a);await o.saveMaps(s,{action:"update",mapId:e,detail:a}),this.closeModal(),await this.loadData({force:!0}),await this.selectMap(e),this.showToast("Mapa actualizado correctamente.","success")}catch(s){this.showToast("No se pudo actualizar el mapa. Revisa la consola.","error")}else this.showToast("Mapa no encontrado.","warning")},openAssignJerarquiaModal(e){const t="string"==typeof e?parseInt(e,10):e,a=o.getMapById(t);if(!a)return void this.showToast("Mapa no encontrado.","warning");if(!c||!c.jerarquiaAnidada)return void this.showToast("Configura la jerarqua en su pestaa antes de asignarla.","warning");const n=this.elements.modal,i=this.elements.modalBody;if(!n||!i)return;this.state.tempJerarquiaAssignment={mapId:t,path:Array.isArray(a.jerarquiaPath)?[...a.jerarquiaPath]:[]},this.elements.modalTitle.textContent="Asignar jerarqua al mapa",i.innerHTML=`\n      <div class="map-jerarquia-modal">\n        <div class="map-jerarquia-summary">\n          <p><strong>Mapa:</strong> ${this.escapeHtml(a.name||"Mapa sin nombre")}</p>\n          <p class="map-jerarquia-summary-text">Selecciona el nivel exacto dentro de la jerarqua corporativa. Servir para mantener sincronizadas las reas dibujadas y los marcadores.</p>\n          <div class="map-jerarquia-selected" id="mapJerarquiaSelectedPath"></div>\n        </div>\n        <div id="mapJerarquiaSelectorContainer" class="map-jerarquia-selector"></div>\n        <div class="form-actions" style="justify-content: flex-end; gap: 8px;">\n          <button type="button" class="map-btn map-btn--ghost" data-action="cancel-jerarquia">Cancelar</button>\n          <button type="button" class="map-btn map-btn--ghost" data-action="clear-jerarquia">Quitar asignacin</button>\n          <button type="button" class="map-btn map-btn--primary" data-action="confirm-jerarquia">Guardar</button>\n        </div>\n      </div>\n    `,n.classList.remove("hidden"),this.renderJerarquiaSelectorTree({containerId:"mapJerarquiaSelectorContainer",selectedPath:this.state.tempJerarquiaAssignment.path}),this.updateJerarquiaAssignPreview();const s=i.querySelector('[data-action="cancel-jerarquia"]'),r=i.querySelector('[data-action="clear-jerarquia"]'),l=i.querySelector('[data-action="confirm-jerarquia"]');s&&s.addEventListener("click",()=>{this.state.tempJerarquiaAssignment=null,this.closeModal()}),r&&r.addEventListener("click",()=>this.clearJerarquiaAssignment()),l&&l.addEventListener("click",()=>this.applyJerarquiaAssignment())},renderJerarquiaSelectorTree({containerId:e,selectedPath:t=[]}={}){const a="string"==typeof e?document.getElementById(e):e;if(!a)return;if(!c||!c.jerarquiaAnidada)return void(a.innerHTML='<p style="color: var(--text-secondary);">Configura la jerarqua en la pestaa correspondiente.</p>');const n=c.jerarquiaAnidada;if(!n.empresa)return void(a.innerHTML='<p style="color: var(--text-secondary);">No se encontr empresa en la jerarqua.</p>');const i=Array.isArray(t)?t:[],s=`\n      <ul class="jerarquia-selector-tree-root">\n        ${this.buildJerarquiaSelectorHTML({node:n.empresa,nivel:"empresa",path:[],selectedPath:i,childrenOverride:n.areas||[]})}\n      </ul>\n    `;a.innerHTML=s,Array.from(a.querySelectorAll("[data-jerarquia-node]")).forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.getAttribute("data-path");if(t)try{const e=JSON.parse(decodeURIComponent(t));this.handleJerarquiaNodeSelection(e)}catch(a){}})})},buildJerarquiaSelectorHTML({node:e,nivel:t,path:a=[],selectedPath:n=[],childrenOverride:i=null}){var s;if(!e)return"";const r=e.id||`${t}-${Math.random().toString(36).slice(2,7)}`,o=e.nombre||e.name||"Sin nombre",l=[...a,{id:r,nivel:t,nombre:o}],d=this.compareJerarquiaPaths(l,n),c=this.jerarquiaLevelConfig[t]||null,p=null==c?void 0:c.childKey,u=null==c?void 0:c.childNivel,m=Array.isArray(i)?i:p&&Array.isArray(e[p])?e[p]:[],h=u&&Array.isArray(m)&&m.length?`<ul class="jerarquia-selector-children">\n          ${m.map(e=>this.buildJerarquiaSelectorHTML({node:e,nivel:u,path:l,selectedPath:n})).join("")}\n        </ul>`:"",g=encodeURIComponent(JSON.stringify(l)),b=(null==(s=this.jerarquiaLevelConfig[t])?void 0:s.label)||t;return`\n      <li class="jerarquia-selector-item">\n        <button type="button" class="jerarquia-selector-node ${d?"is-selected":""}" data-jerarquia-node="true" data-path="${g}">\n          <span class="jerarquia-selector-level">${this.escapeHtml(b)}</span>\n          <span class="jerarquia-selector-name">${this.escapeHtml(o)}</span>\n        </button>\n        ${h}\n      </li>\n    `},compareJerarquiaPaths:(e,t)=>!(!Array.isArray(e)||!Array.isArray(t))&&(e.length===t.length&&e.every((e,a)=>{const n=t[a];return e.id===n.id&&(e.nivel||null)===(n.nivel||null)})),handleJerarquiaNodeSelection(e){Array.isArray(e)&&(this.state.tempJerarquiaAssignment||(this.state.tempJerarquiaAssignment={mapId:null,path:[]}),this.state.tempJerarquiaAssignment.path=e,this.updateJerarquiaAssignPreview(),this.renderJerarquiaSelectorTree({containerId:"mapJerarquiaSelectorContainer",selectedPath:e}))},updateJerarquiaAssignPreview(){var e;const t=document.getElementById("mapJerarquiaSelectedPath");if(!t)return;const a=(null==(e=this.state.tempJerarquiaAssignment)?void 0:e.path)||[];if(!Array.isArray(a)||!a.length)return void(t.innerHTML='<span class="map-jerarquia-chip map-jerarquia-chip--empty">Sin asignacin</span>');t.innerHTML=a.map(e=>{const t=(null==e?void 0:e.nivel)?this.jerarquiaLevelConfig[e.nivel]:null,a=(null==t?void 0:t.label)||(null==e?void 0:e.nivel)||"";return`<span class="map-jerarquia-chip">${a?`<span class="map-jerarquia-chip-level">${this.escapeHtml(a)}</span>`:""}${`<span class="map-jerarquia-chip-name">${this.escapeHtml((null==e?void 0:e.nombre)||(null==e?void 0:e.id)||"Sin nombre")}</span>`}</span>`}).join('<span class="map-jerarquia-chip-arrow"></span>')},clearJerarquiaAssignment(){this.state.tempJerarquiaAssignment?this.state.tempJerarquiaAssignment.path=[]:this.state.tempJerarquiaAssignment={mapId:null,path:[]},this.updateJerarquiaAssignPreview(),this.renderJerarquiaSelectorTree({containerId:"mapJerarquiaSelectorContainer",selectedPath:[]})},async applyJerarquiaAssignment(){const e=this.state.tempJerarquiaAssignment;if(!e)return void this.showToast("No hay cambios por guardar.","info");if(void 0===e.mapId||null===e.mapId)return void this.showToast("Selecciona un mapa antes de guardar.","warning");const t=o.getMapById(e.mapId);if(!t)return void this.showToast("Mapa no encontrado.","warning");const a=Array.isArray(e.path)?e.path.filter(e=>e&&e.id).map(e=>({id:e.id,nivel:e.nivel||null})):[],n={...t,jerarquiaPath:a,updatedAt:(new Date).toISOString()},i=(o.maps||[]).map(t=>t.id===e.mapId?n:t);try{await o.saveMaps(i,{action:"assign_jerarquia",mapId:e.mapId,detail:t.name}),this.state.currentMapId===e.mapId&&(this.state.currentMap=n,this.state.jerarquiaBranchFilter=null),this.state.tempJerarquiaAssignment=null,this.closeModal(),this.showToast("Jerarqua asignada correctamente.","success"),window.appEvents&&"function"==typeof window.appEvents.emit&&window.appEvents.emit("mapa:jerarquia-asignada",{mapId:e.mapId,jerarquiaPath:a,mapName:t.name}),this.renderMapList(i),await this.selectMap(e.mapId,{keepViewport:!0})}catch(s){this.showToast("No se pudo guardar la jerarqua. Revisa la consola.","error")}},getJerarquiaRootNode(){if(!c||!c.jerarquiaAnidada||!c.jerarquiaAnidada.empresa)return null;const e={...c.jerarquiaAnidada.empresa};return e.areas=c.jerarquiaAnidada.areas||[],e},findJerarquiaNodeInTree(e,t){if(!e)return null;const a=this.getJerarquiaRootNode();if(!a)return null;const n=(a,i)=>{if(!a)return null;if(a.id===e&&(!t||t===i))return a;const s=this.jerarquiaLevelConfig[i];if(!(null==s?void 0:s.childKey)||!(null==s?void 0:s.childNivel))return null;const r=a[s.childKey];if(!Array.isArray(r))return null;for(const e of r){const t=n(e,s.childNivel);if(t)return t}return null};return n(a,"empresa")},getJerarquiaPathLabel(e){if(!Array.isArray(e)||!e.length)return"Sin asignacin";const t=e.map(e=>{const t=this.findJerarquiaNodeInTree(e.id,e.nivel);return(null==t?void 0:t.nombre)||e.nombre||e.id}).filter(Boolean);return t.length?t.join(" > "):e.map(e=>e.id).join(" > ")},getJerarquiaOptionCatalog(){if(this.cachedJerarquiaOptions)return this.cachedJerarquiaOptions;const e=this.buildJerarquiaOptionSetsFromStructure(null==c?void 0:c.jerarquiaAnidada),t=this.mergeWithFallbackJerarquiaOptions(e);return this.cachedJerarquiaOptions=t,t},buildJerarquiaOptionSetsFromStructure(e){const t={planta:[],areaGeneral:[],subArea:[],sistemaEquipo:[],subSistema:[],seccion:[],subSeccion:[]};if(!e||!e.empresa)return t;const a=Object.fromEntries(Object.keys(t).map(e=>[e,new Set])),n=(e,t)=>{e&&t&&a[e].add(t)},i=(e,t)=>{if(!e)return;const a=e.nombre||e.name||e.label||e.id;switch(t){case"empresa":n("planta",a);break;case"area":n("areaGeneral",a);break;case"subArea":n("subArea",a);break;case"sistema":n("sistemaEquipo",a);break;case"subSistema":n("subSistema",a);break;case"seccion":n("seccion",a);break;case"subSeccion":n("subSeccion",a)}const s=this.jerarquiaLevelConfig[t];if(!(null==s?void 0:s.childKey)||!(null==s?void 0:s.childNivel))return;const r=e[s.childKey];Array.isArray(r)&&r.forEach(e=>i(e,s.childNivel))};return i(e.empresa,"empresa"),Object.fromEntries(Object.entries(a).map(([e,t])=>{const a=Array.from(t);return a.sort((e,t)=>e.localeCompare(t||"","es",{sensitivity:"base"})),[e,a]}))},mergeWithFallbackJerarquiaOptions(e={}){const t=JSON.parse(JSON.stringify({planta:[],areaGeneral:[],subArea:[],sistemaEquipo:[],subSistema:[],seccion:[],subSeccion:[],...e}));return[null==c?void 0:c.opcionesJerarquia].forEach(e=>{e&&Object.entries(e).forEach(([e,a])=>{Array.isArray(a)&&a.forEach(a=>((e,a)=>{a&&(Array.isArray(t[e])||(t[e]=[]),t[e].includes(a)||t[e].push(a))})(e,a))})}),Object.keys(t).forEach(e=>{Array.isArray(t[e])&&t[e].sort((e,t)=>e.localeCompare(t||"","es",{sensitivity:"base"}))}),t},normalizeAreaJerarquia(e={}){const t=e||{};return{planta:t.planta||t.nivel1||t.empresa||"",areaGeneral:t.areaGeneral||t.nivel2||"",subArea:t.subArea||t.nivel3||"",sistemaEquipo:t.sistemaEquipo||t.nivel4||"",subSistema:t.subSistema||t.nivel5||"",seccion:t.seccion||t.nivel6||"",subSeccion:t.subSeccion||t.nivel7||"",detalle:t.detalle||""}},getCurrentMapJerarquiaDefaults(){if(!this.state.currentMap||!Array.isArray(this.state.currentMap.jerarquiaPath))return{};const e=this.state.currentMap.jerarquiaPath,t=t=>{const a=e[t];return a?this.getJerarquiaNodeName(a):""};return{planta:t(0),areaGeneral:t(1),subArea:t(2),sistemaEquipo:t(3),subSistema:t(4),seccion:t(5)}},async deleteMap(e){const t="string"==typeof e?parseInt(e,10):e,a=o.getMapById(t);if(!a)return void this.showToast("Mapa no encontrado.","warning");const n=(o.areas||[]).filter(e=>e.mapId===t).length,i=n>0?`Eliminar "${a.name}"? Esto tambin eliminar ${n} rea(s) asociada(s). Esta accin no se puede deshacer.`:`Eliminar "${a.name}"? Esta accin no se puede deshacer.`;if(confirm(i))try{if(n>0){const e=(o.areas||[]).filter(e=>e.mapId!==t);await o.saveAreas(e,{action:"delete-cascade",mapId:t,detail:`${n} reas eliminadas`})}const e=(o.maps||[]).filter(e=>e.id!==t);await o.saveMaps(e,{action:"delete",mapId:t,detail:a.name});let i=null;if(a.imagePath){const e=await o.deleteMapImage(a.imagePath);e.success||"fs-offline"===e.reason||"no-path"===e.reason||(i="El mapa se elimin, pero la imagen no pudo borrarse. Revisa la consola para ms detalles.")}this.state.currentMapId===t&&(this.state.currentMapId=null,this.state.currentMap=null,this.state.areas=[],this.state.jerarquiaBranchFilter=null,this.cleanupImage()),await this.loadData({force:!0}),this.showToast(`Mapa "${a.name}" eliminado correctamente.`,"success"),i&&this.showToast(i,"warning")}catch(s){this.showToast("No se pudo eliminar el mapa. Revisa la consola.","error")}},async cleanOrphanMapImages(){if(o.initialized)try{const e=await o.cleanupOrphanMapImages();if(!e.orphans)return void this.showToast("No hay imgenes hurfanas en la carpeta de mapas.","success");const t=e.removed===e.orphans?`${e.removed} imagen(es) hurfana(s) eliminada(s).`:`Se eliminaron ${e.removed} de ${e.orphans} imgenes hurfanas. Revisa la consola para los errores.`;this.showToast(t,e.removed===e.orphans?"success":"warning")}catch(e){this.showToast("No se pudo limpiar la carpeta de mapas.","error")}else this.showToast("Conecta la carpeta antes de limpiar mapas.","info")},async startEditAreaPoints(e){var t;const a="string"==typeof e?parseInt(e,10):e;if(isNaN(a))return void this.showToast("Error: ID de rea invlido.","error");const n=this.state.areas.find(e=>e.id===a);n&&n.points&&0!==n.points.length?(this.state.drawing&&this.cancelDrawing(),this.state.editingAreaId=a,this.state.editingPoints=JSON.parse(JSON.stringify(n.points)),this.state.selectedPointIndex=null,this.state.highlightAreaId=a,this.state.isDraggingPoint=!1,null==(t=this.elements.drawBtn)||t.classList.remove("map-btn--active"),this.renderAreaList(this.state.areas),this.showEditPointButtons(n.name),this.draw(),this.showToast(` Arrastra cualquier punto para ajustar la forma de "${n.name}"`,"info",4e3)):this.showToast("No se puede editar esta rea.","error")},showEditPointButtons(e){let t=document.getElementById("editPointButtons");t||(t=document.createElement("div"),t.id="editPointButtons",t.style.cssText="\n        position: fixed;\n        bottom: 30px;\n        left: 50%;\n        transform: translateX(-50%);\n        z-index: 10000;\n        display: flex;\n        gap: 12px;\n        padding: 16px 24px;\n        background: rgba(15, 23, 42, 0.95);\n        border: 2px solid #f59e0b;\n        border-radius: 12px;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n        backdrop-filter: blur(10px);\n      ",document.body.appendChild(t)),t.innerHTML=`\n      <div style="display: flex; align-items: center; gap: 12px; color: white; font-size: 0.9rem; font-weight: 500;">\n        <span style="padding-right: 12px; border-right: 1px solid rgba(255, 255, 255, 0.2);">\n           Editando: ${this.escapeHtml(e)}\n        </span>\n        <button id="saveEditPoints" style="\n          padding: 10px 20px;\n          background: #22c55e;\n          color: white;\n          border: none;\n          border-radius: 8px;\n          font-weight: 600;\n          font-size: 0.9rem;\n          cursor: pointer;\n          transition: all 0.2s;\n          box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);\n        " onmouseover="this.style.background='#16a34a'; this.style.transform='translateY(-2px)'" \n           onmouseout="this.style.background='#22c55e'; this.style.transform='translateY(0)'">\n           Guardar cambios\n        </button>\n        <button id="cancelEditPoints" style="\n          padding: 10px 20px;\n          background: #ef4444;\n          color: white;\n          border: none;\n          border-radius: 8px;\n          font-weight: 600;\n          font-size: 0.9rem;\n          cursor: pointer;\n          transition: all 0.2s;\n          box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);\n        " onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-2px)'" \n           onmouseout="this.style.background='#ef4444'; this.style.transform='translateY(0)'">\n           Cancelar\n        </button>\n      </div>\n    `,document.getElementById("saveEditPoints").addEventListener("click",()=>{this.saveEditedAreaPoints()}),document.getElementById("cancelEditPoints").addEventListener("click",()=>{this.exitEditZonePoints(),this.showToast("Edicin cancelada","info")})},hideEditPointButtons(){const e=document.getElementById("editPointButtons");e&&e.remove()},exitEditZonePoints(){this.hideEditPointButtons(),this.state.editingAreaId=null,this.state.editingPoints=[],this.state.selectedPointIndex=null,this.state.isDraggingPoint=!1,this.elements.canvas.style.cursor="default",this.draw()},async saveEditedAreaPoints(){if(!this.state.editingAreaId||0===this.state.editingPoints.length)return;const e=this.state.editingAreaId;if(!o.initialized)return void this.showToast("Error: Sistema de almacenamiento no disponible.","error");const t=o.areas.find(t=>t.id===e);if(!t)return this.showToast("Error: rea no encontrada.","error"),void this.exitEditZonePoints();try{const a={...t,points:[...this.state.editingPoints],updatedAt:(new Date).toISOString()};o.areas=o.areas.map(t=>t.id===e?a:t),await o.saveAreas(o.areas,{action:"update",mapId:this.state.currentMapId,areaId:e,detail:`Editados ${this.state.editingPoints.length} puntos de "${t.name}"`}),this.state.areas=o.getAreasByMap(this.state.currentMapId),this.exitEditZonePoints(),this.renderAreaList(this.state.areas),this.draw(),this.showToast(` Forma de "${t.name}" actualizada correctamente.`,"success")}catch(a){this.showToast("No se pudo guardar los cambios. Revisa la consola.","error")}},async openEditAreaMetadataModal(e){const t="string"==typeof e?parseInt(e,10):e,a=this.state.areas.find(e=>e.id===t);if(!a)return void this.showToast("No se encontr la zona especificada.","error");const n=this.elements.modal,i=this.elements.modalBody;if(!n||!i)return;this.elements.modalTitle.textContent="editar rea";const s=this.normalizeAreaJerarquia(a.jerarquia),r=Array.isArray(a.equipos)?a.equipos.join("\n"):"",o=this.getJerarquiaOptionCatalog(),l=(e,t)=>Array.isArray(t)&&t.length?`<datalist id="${e}">${t.map(e=>`<option value="${this.escapeHtml(e)}"></option>`).join("")}</datalist>`:"",d=Object.entries(this.categories).map(([e,t])=>`<option value="${e}" ${(a.category||"area")===e?"selected":""}>${t.icon} ${t.name} - ${t.description}</option>`).join("");i.innerHTML=`\n      <form id="editAreaForm" class="map-area-form">\n        <div class="form-group">\n          <label>Nombre del rea</label>\n          <input type="text" name="areaName" required placeholder="Ej: Planta Principal" value="${this.escapeHtml(a.name||"")}" />\n        </div>\n        \n        \x3c!--  NUEVO: Selector de categora (dinmico) --\x3e\n        <div class="form-group" style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; margin-bottom: 12px;">\n          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n            <span style="font-size: 1.1rem;"></span>\n            <span>Categora del rea</span>\n          </label>\n          <select name="category" id="editCategorySelect" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.95rem;">\n            ${d}\n          </select>\n          <small style="display: block; margin-top: 8px; color: var(--text-muted); font-size: 0.8rem;">\n             La categora determina el icono y color sugerido del rea. <a href="#" onclick="event.preventDefault(); app.switchTab('configuracion'); app.closeModal();" style="color: var(--info); text-decoration: underline;">Gestionar categoras</a>\n          </small>\n        </div>\n        \n        <div class="form-row">\n          <div class="form-group">\n            <label>Color</label>\n            <input type="color" name="areaColor" value="${a.color||"#3b82f6"}" />\n          </div>\n          <div class="form-group">\n            <label>Opacidad</label>\n            <input type="range" name="areaOpacity" min="10" max="90" value="${Math.round(100*(a.opacity||.35))}" />\n          </div>\n        </div>\n        \n        \x3c!--  NUEVO: Controles para posicionar el nombre en el canvas --\x3e\n        <div class="form-group" style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; margin-bottom: 12px;">\n          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n            <span style="font-size: 1.1rem;"></span>\n            <span>Posicin del nombre en el mapa</span>\n          </label>\n          <div class="form-row" style="gap: 12px;">\n            <div class="form-group" style="flex: 1;">\n              <label style="font-size: 0.85rem; color: var(--text-secondary);">Desplazar horizontalmente (X)</label>\n              <input type="number" name="labelOffsetX" value="${a.labelOffsetX||0}" step="10" placeholder="0" \n                     style="text-align: center;" title="Valores positivos mueven a la derecha, negativos a la izquierda" />\n              <small style="color: var(--text-muted); font-size: 0.75rem;"> Izq (-)  |  Der (+) </small>\n            </div>\n            <div class="form-group" style="flex: 1;">\n              <label style="font-size: 0.85rem; color: var(--text-secondary);">Desplazar verticalmente (Y)</label>\n              <input type="number" name="labelOffsetY" value="${a.labelOffsetY||0}" step="10" placeholder="0" \n                     style="text-align: center;" title="Valores positivos mueven hacia abajo, negativos hacia arriba" />\n              <small style="color: var(--text-muted); font-size: 0.75rem;"> Arriba (-)  |  Abajo (+) </small>\n            </div>\n          </div>\n          <small style="display: block; margin-top: 8px; color: var(--text-muted); font-size: 0.8rem;">\n             Usa estos valores para evitar que los nombres se monten unos sobre otros\n          </small>\n        </div>\n        \n        <div class="form-group">\n          <label>Empresa / Planta (N1)</label>\n          <input type="text" name="planta" list="plantaList" placeholder="Ej: Aquachile Antarfood" value="${this.escapeHtml(s.planta||"")}" />\n          ${l("plantaList",o.planta)}\n        </div>\n        <div class="form-group">\n          <label>rea General (N2)</label>\n          <input type="text" name="areaGeneral" list="areaGeneralList" placeholder="Ej: Planta Principal" value="${this.escapeHtml(s.areaGeneral||"")}" />\n          ${l("areaGeneralList",o.areaGeneral)}\n        </div>\n        <div class="form-group">\n          <label>Sub-rea (N3)</label>\n          <input type="text" name="subArea" list="subAreaList" placeholder="Ej: Estanques" value="${this.escapeHtml(s.subArea||"")}" />\n          ${l("subAreaList",o.subArea)}\n        </div>\n        <div class="form-group">\n          <label>Sistema / Equipo (N4)</label>\n          <input type="text" name="sistemaEquipo" list="sistemaEquipoList" placeholder="Ej: Grader Baader" value="${this.escapeHtml(s.sistemaEquipo||"")}" />\n          ${l("sistemaEquipoList",o.sistemaEquipo)}\n        </div>\n        <div class="form-group">\n          <label>Sub-sistema (N5)</label>\n          <input type="text" name="subSistema" list="subSistemaList" placeholder="Ej: Motor Principal" value="${this.escapeHtml(s.subSistema||"")}" />\n          ${l("subSistemaList",o.subSistema)}\n        </div>\n        <div class="form-group">\n          <label>Seccin (N6)</label>\n          <input type="text" name="seccion" list="seccionList" placeholder="Ej: Mdulo 1" value="${this.escapeHtml(s.seccion||"")}" />\n          ${l("seccionList",o.seccion)}\n        </div>\n        <div class="form-group">\n          <label>Equipos / maquinas (uno por linea)</label>\n          <textarea name="equipos" rows="4" placeholder="Ej:\nMotor principal\nBanda transportadora">${this.escapeHtml(r)}</textarea>\n        </div>\n        <div class="form-actions">\n          <button type="button" class="map-btn map-btn--ghost" id="cancelEditAreaBtn">Cancelar</button>\n          <button type="submit" class="map-btn map-btn--primary">Guardar cambios</button>\n        </div>\n      </form>\n    `,n.classList.remove("hidden");const c=document.getElementById("editCategorySelect"),p=document.querySelector('input[name="areaColor"]');c&&p&&c.addEventListener("change",e=>{const t=e.target.value,a=this.categories[t];a&&a.color&&(p.value=a.color)});const u=document.getElementById("cancelEditAreaBtn");u&&u.addEventListener("click",()=>{this.closeModal()});const m=document.getElementById("editAreaForm");m&&m.addEventListener("submit",async t=>{t.preventDefault(),await this.updateAreaFromForm(e,new FormData(t.target))})},async updateAreaFromForm(e,t){var a,n,i,s,r,l,d,c;try{const p="string"==typeof e?parseInt(e,10):e,u=null==(a=t.get("areaName"))?void 0:a.trim();if(!u)return void this.showToast("El Nombre del rea es obligatorio.","error");const m=t.get("areaColor")||"#3b82f6",h=parseFloat(t.get("areaOpacity"))/100||.35,g=(t.get("category")||"area").toString().trim(),b=parseInt(t.get("labelOffsetX"),10)||0,v=parseInt(t.get("labelOffsetY"),10)||0,y={},f=null==(n=t.get("planta"))?void 0:n.trim(),x=null==(i=t.get("areaGeneral"))?void 0:i.trim(),S=null==(s=t.get("subArea"))?void 0:s.trim(),w=null==(r=t.get("sistemaEquipo"))?void 0:r.trim(),A=null==(l=t.get("subSistema"))?void 0:l.trim(),E=null==(d=t.get("seccion"))?void 0:d.trim();f&&(y.planta=f),x&&(y.areaGeneral=x),S&&(y.subArea=S),w&&(y.sistemaEquipo=w),A&&(y.subSistema=A),E&&(y.seccion=E);const I=((null==(c=t.get("equipos"))?void 0:c.trim())||"").split("\n").map(e=>e.trim()).filter(Boolean),$=o.areas.find(e=>e.id===p);if(!$)return void this.showToast("No se encontr la zona especificada.","error");const k={...$,name:u,color:m,opacity:h,category:g,labelOffsetX:b,labelOffsetY:v,jerarquia:y,equipos:I,updatedAt:(new Date).toISOString()};o.areas=o.areas.map(e=>e.id===p?k:e),await o.saveAreas(o.areas,{action:"update",mapId:this.state.currentMapId,areaId:p,detail:`Actualizada zona "${u}"`}),this.state.areas=o.getAreasByMap(this.state.currentMapId),this.renderAreaList(this.state.areas),this.draw(),this.closeModal(),this.showToast(` Zona "${u}" actualizada correctamente.`,"success")}catch(p){this.showToast("No se pudo actualizar el rea. Revisa la consola.","error")}},async deleteArea(e){const t="string"==typeof e?parseInt(e,10):e;if(isNaN(t)||null==t)return void this.showToast("Error: ID de rea invlido.","error");const a=this.state.areas.find(e=>e.id===t);if(!a)return void this.showToast("No se encontr la zona especificada.","error");if(confirm(`Eliminar la zona "${a.name}"?\n\nEsta accin no se puede deshacer.`))try{o.areas.length;o.areas=o.areas.filter(e=>{const a=e.id!==t;return a});o.areas.length;await o.saveAreas(),this.state.areas=o.getAreasByMap(this.state.currentMapId),this.state.highlightAreaId===t&&(this.state.highlightAreaId=null),this.renderAreaList(this.state.areas),this.drawCanvas(),this.showToast(`Zona "${a.name}" eliminada correctamente.`,"success")}catch(n){this.showToast("No se pudo eliminar el rea. Revisa la consola.","error")}},async refreshLog(){const e=o.initialized?await o.readLog(30):[];this.renderLog(e)},renderLog(e){var t,a;const{logList:n}=this.elements;if(!n)return;if(!Array.isArray(e)||!e.length)return void(n.innerHTML='<div style="color: var(--text-secondary); padding: 12px;">Sin eventos registrados.</div>');const i=(null==(t=document.getElementById("mapLogFilterAction"))?void 0:t.value)||"all",s=(null==(a=document.getElementById("mapLogFilterScope"))?void 0:a.value)||"all",r=e.filter(e=>{const t="all"===i||e.action===i,a="all"===s||e.scope===s;return t&&a});r.length?(n.innerHTML=r.map(e=>{const t=e.timestamp?new Date(e.timestamp).toLocaleString("es-CL",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"",a=e.scope||"maps",n=e.action||"update",i=e.detail?`  ${this.escapeHtml(e.detail)}`:"";let s="#64748b",r="",o="Actualizado";"create"===n?(s="#10b981",r="",o="Creado"):"update"===n?(s="#3b82f6",r="",o="Actualizado"):"delete"===n&&(s="#ef4444",r="",o="Eliminado");const l="maps"===a?"Mapa":"Zona",d=e.mapId||e.zoneId,c=d?"cursor: pointer;":"",p=d?"transition: all 0.2s; &:hover { background: rgba(59, 130, 246, 0.1); }":"";return`\n        <div class="map-log-entry" \n             data-map-id="${e.mapId||""}" \n             data-area-id="${e.zoneId||""}"\n             style="padding: 10px 12px; border-left: 3px solid ${s}; margin-bottom: 6px; border-radius: 4px; background: var(--surface-color); ${c} ${p}">\n          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">\n            <time style="font-size: 0.75rem; color: var(--text-secondary);">${t}</time>\n            <span style="font-size: 0.75rem; padding: 2px 6px; border-radius: 3px; background: ${s}20; color: ${s}; font-weight: 500;">\n              ${r} ${o}\n            </span>\n          </div>\n          <div style="font-size: 0.85rem; color: var(--text-primary);">\n             <strong>${l}</strong>${i}\n          </div>\n        </div>\n      `}).join(""),Array.from(n.querySelectorAll(".map-log-entry")).forEach(e=>{const t=e.getAttribute("data-map-id"),a=e.getAttribute("data-area-id");(t||a)&&e.addEventListener("click",()=>{zoneId&&t?(this.selectMap(parseInt(t,10)),setTimeout(()=>{this.focusArea(parseInt(zoneId,10))},300)):t&&this.selectMap(parseInt(t,10))})})):n.innerHTML='<div style="color: var(--text-secondary); padding: 12px;">No hay eventos que coincidan con los filtros.</div>'},showHistorialHelp(){const e=this.elements.modal,t=this.elements.modalBody;if(!e||!t)return;this.elements.modalTitle.textContent=" Qu es el Historial?",t.innerHTML='\n      <div style="padding: 16px; line-height: 1.6;">\n        <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 1.1rem;"> Registro de actividades</h3>\n        <p style="margin: 0 0 16px 0; color: var(--text-secondary);">\n          El historial registra automticamente todas las acciones que realizas en mapas y zonas, \n          creando un registro de auditora completo con marca de tiempo.\n        </p>\n\n        <h4 style="margin: 16px 0 8px 0; color: var(--text-primary); font-size: 0.95rem;"> Qu se registra?</h4>\n        <ul style="margin: 0 0 16px 0; padding-left: 24px; color: var(--text-secondary);">\n          <li style="margin-bottom: 6px;"> <strong style="color: #10b981;">Creacin</strong>: Cuando creas un nuevo mapa o zona</li>\n          <li style="margin-bottom: 6px;"> <strong style="color: #3b82f6;">Actualizacin</strong>: Cuando editas datos o formas</li>\n          <li style="margin-bottom: 6px;"> <strong style="color: #ef4444;">Eliminacin</strong>: Cuando borras mapas o zonas</li>\n        </ul>\n\n        <h4 style="margin: 16px 0 8px 0; color: var(--text-primary); font-size: 0.95rem;"> Filtros disponibles</h4>\n        <p style="margin: 0 0 8px 0; color: var(--text-secondary);">\n          Usa los selectores para filtrar eventos por:\n        </p>\n        <ul style="margin: 0 0 16px 0; padding-left: 24px; color: var(--text-secondary);">\n          <li style="margin-bottom: 6px;"><strong>Tipo de accin:</strong> Creadas, Actualizadas o Eliminadas</li>\n          <li style="margin-bottom: 6px;"><strong>mbito:</strong> Solo Mapas o Solo Zonas</li>\n        </ul>\n\n        <h4 style="margin: 16px 0 8px 0; color: var(--text-primary); font-size: 0.95rem;"> Navegacin rpida</h4>\n        <p style="margin: 0 0 16px 0; color: var(--text-secondary);">\n          Haz <strong>click en cualquier entrada</strong> del historial para saltar directamente al mapa o zona correspondiente.\n        </p>\n\n        <div style="margin-top: 24px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid #3b82f6;">\n          <p style="margin: 0; color: var(--text-primary); font-size: 0.85rem;">\n            <strong> Tip:</strong> El historial se guarda en archivo <code>mapas-history.log</code> dentro de la carpeta de logs para mantener un registro permanente.\n          </p>\n        </div>\n\n        <div style="margin-top: 20px; display: flex; justify-content: flex-end;">\n          <button type="button" id="closeHistorialHelpBtn" class="map-btn map-btn--primary">Entendido</button>\n        </div>\n      </div>\n    ',e.classList.remove("hidden");const a=document.getElementById("closeHistorialHelpBtn");a&&a.addEventListener("click",()=>{this.closeModal()})},showHint(e){const t=this.elements.hint;t&&(t.textContent=e,t.classList.remove("hidden"))},hideHint(){const e=this.elements.hint;e&&e.classList.add("hidden")},escapeHtml:e=>e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),hexToRgba(e,t=.35){let a=e.replace("#","").trim();3===a.length&&(a=a.split("").map(e=>e+e).join(""));const n=parseInt(a,16);return`rgba(${n>>16&255}, ${n>>8&255}, ${255&n}, ${t})`},showToast(e,t="info"){"function"==typeof(null==c?void 0:c.showToast)&&c.showToast(e,t)}};window.appEvents&&"function"==typeof window.appEvents.on&&(window.appEvents.on("jerarquia:structure-updated",e=>{l.handleJerarquiaStructureUpdate(e||{})}),window.appEvents.on("jerarquia:catalogs-updated",e=>{l.handleJerarquiaCatalogUpdate(e||{})})),window.addEventListener("load",()=>{window.app&&"function"==typeof window.app.initJerarquiaSearch&&window.app.initJerarquiaSearch()});const d={state:{objectives:[],keyResults:[],initiatives:[],filters:{cycle:"all",owner:"all",status:"all",tag:"all",search:""},dataLoaded:!1},elements:{},headerAliasList:[{key:"objective",aliases:["objective","objetivo","okr objetivo","objective name"]},{key:"cycle",aliases:["cycle","ciclo","quarter","periodo","period"]},{key:"objectiveOwner",aliases:["objective owner","owner objetivo","dueno objetivo","responsable objetivo","lider objetivo"]},{key:"owner",aliases:["owner","responsable","lider","lead"]},{key:"team",aliases:["team","equipo","area"]},{key:"objectiveStatus",aliases:["objective status","estado objetivo","status objetivo","estado general"]},{key:"objectiveProgress",aliases:["objective progress","progreso objetivo","avance objetivo","progress objetivo"]},{key:"objectiveCategory",aliases:["category","categoria","pilar","tema"]},{key:"objectiveNotes",aliases:["objective notes","notas objetivo","descripcion objetivo","descripcion general"]},{key:"keyResult",aliases:["key result","resultado clave","kr","resultado okr"]},{key:"krOwner",aliases:["kr owner","responsable rc","responsable resultado","dueno rc","owner rc"]},{key:"krMetric",aliases:["metric","metrica","indicador","measure"]},{key:"krBaseline",aliases:["baseline","linea base","valor inicial"]},{key:"krTarget",aliases:["target","meta","objetivo kr","expected"]},{key:"krCurrent",aliases:["current","actual","valor actual","resultado actual"]},{key:"krProgress",aliases:["kr progress","progreso kr","avance kr","progress rc"]},{key:"krConfidence",aliases:["kr confidence","confidence","confianza","confidence level"]},{key:"krStatus",aliases:["kr status","estado kr","estado rc","status rc"]},{key:"initiatives",aliases:["initiatives","iniciativas","initiative","iniciativa"]},{key:"initiativeOwner",aliases:["initiative owner","owner iniciativa","responsable iniciativa","lider iniciativa"]},{key:"initiativeStatus",aliases:["initiative status","estado iniciativa","status iniciativa"]},{key:"initiativeDue",aliases:["due date","fecha objetivo","fecha limite","deadline","fecha compromiso"]},{key:"confidence",aliases:["confidence global","confianza global"]},{key:"tags",aliases:["tags","etiquetas","labels","temas"]},{key:"alignment",aliases:["alignment","alineacion","alineacion estrategica","pillar"]},{key:"priority",aliases:["priority","prioridad"]},{key:"notes",aliases:["notes","notas","comentarios","observaciones"]}],statusAliasMap:{on_track:["on track","en curso","en marcha","a tiempo","verde","cumpliendo"],at_risk:["at risk","con riesgo","riesgo","amarillo","alerta"],off_track:["off track","retrasado","fuera de plan","rojo","bloqueado","critico","crtico"],completed:["completed","completado","alcanzado","logrado","finalizado","cerrado"],not_started:["not started","sin iniciar","pendiente","por iniciar","no iniciado"],paused:["paused","pausado","en pausa","aplazado"]},init(){this.cacheElements(),this.elements.container&&(this.bindEvents(),this.renderEmptyState())},cacheElements(){this.elements={container:document.getElementById("okr"),summary:document.getElementById("okrSummary"),filters:document.getElementById("okrFilters"),dropzone:document.getElementById("okrDropzone"),fileInput:document.getElementById("okrExcelInput"),filterCycle:document.getElementById("okrFilterCycle"),filterOwner:document.getElementById("okrFilterOwner"),filterStatus:document.getElementById("okrFilterStatus"),filterTag:document.getElementById("okrFilterTag"),searchInput:document.getElementById("okrSearchInput"),resetFilters:document.getElementById("okrResetFilters"),objectives:document.getElementById("okrObjectives"),insights:document.getElementById("okrInsights"),keyResults:document.getElementById("okrKeyResults"),initiatives:document.getElementById("okrInitiatives"),templateBtn:document.getElementById("okrDownloadTemplate"),demoBtn:document.getElementById("okrLoadDemo")}},bindEvents(){const e=this.elements;if(!e.container)return;if(e.fileInput&&e.fileInput.addEventListener("change",e=>{this.handleFileList(e.target.files),e.target.value=""}),e.dropzone){const t=e=>{e.preventDefault(),e.stopPropagation()};["dragenter","dragover"].forEach(a=>{e.dropzone.addEventListener(a,a=>{t(a),e.dropzone.classList.add("is-dragover")})}),["dragleave","dragend","drop"].forEach(a=>{e.dropzone.addEventListener(a,n=>{var i;t(n),"drop"===a&&this.handleFileList(null==(i=n.dataTransfer)?void 0:i.files),e.dropzone.classList.remove("is-dragover")})}),e.dropzone.addEventListener("click",()=>{var t;null==(t=e.fileInput)||t.click()})}if([{el:e.filterCycle,key:"cycle"},{el:e.filterOwner,key:"owner"},{el:e.filterStatus,key:"status"},{el:e.filterTag,key:"tag"}].forEach(({el:e,key:t})=>{e&&e.addEventListener("change",e=>{this.state.filters[t]=e.target.value,this.renderDashboard()})}),e.searchInput){let t;e.searchInput.addEventListener("input",e=>{clearTimeout(t);const a=e.target.value;t=setTimeout(()=>{this.state.filters.search=a,this.renderDashboard()},180)})}e.resetFilters&&e.resetFilters.addEventListener("click",()=>this.resetFilters()),e.templateBtn&&e.templateBtn.addEventListener("click",()=>this.downloadTemplate()),e.demoBtn&&e.demoBtn.addEventListener("click",()=>this.loadDemoData())},async handleFileList(e){if(!e||!e.length)return void this.showToast("No se detect archivo para importar.","warning",2500);const t=e[0];try{const e=await this.readWorkbookFromFile(t),a=this.parseWorkbook(e);this.setData(a),this.showToast(`OKR importados desde ${t.name}`,"success",3200)}catch(a){this.showToast(`Error al procesar el archivo: ${a.message}`,"error",4800)}},readWorkbookFromFile:e=>new Promise((t,a)=>{const n=new FileReader;n.onerror=()=>a(new Error("No se pudo leer el archivo")),n.onload=e=>{var n;try{const a=null==(n=e.target)?void 0:n.result,i=XLSX.read(a,{type:"array"});t(i)}catch(i){a(i)}},n.readAsArrayBuffer(e)}),parseWorkbook(e){var t;if(!e||!(null==(t=e.SheetNames)?void 0:t.length))throw new Error("El archivo no contiene hojas vlidas.");const a=e.SheetNames[0],n=e.Sheets[a],i=XLSX.utils.sheet_to_json(n,{header:1,defval:""});if(!i.length)throw new Error("La hoja seleccionada est vaca.");const s=i[0].map(e=>this.normalizeHeader(e)).map(e=>this.resolveHeaderAlias(e)),r=i.slice(1),o=[];let l="";if(r.forEach(e=>{if(!e||e.every(e=>null==e||""===String(e).trim()))return;const t={};s.forEach((a,n)=>{a&&(t[a]=e[n])}),t.objective&&String(t.objective).trim()||(t.objective=l),t.objective&&String(t.objective).trim()&&(l=t.objective,o.push(t))}),!o.length)throw new Error("No se encontraron filas con objetivos vlidos.");return this.transformRows(o,!0)},normalizeHeader:e=>String(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g," ").trim(),resolveHeaderAlias(e){if(!e)return null;for(const t of this.headerAliasList){if(t.aliases.includes(e))return t.key;if(t.aliases.some(t=>e.startsWith(t)))return t.key}return null},transformRows(e,t=!1){const a=new Map,n=[],i=[];let s=0,r=0;e.forEach(e=>{if(!e)return;const t={...e};if(!t.objective||!String(t.objective).trim())return;const o=String(t.objective).trim(),l=o.toLowerCase();a.has(l)||(s+=1,a.set(l,{id:`obj-${s}`,name:o,owner:t.objectiveOwner||t.owner||"",team:t.team||"",cycle:t.cycle||"",status:this.normalizeStatus(t.objectiveStatus||t.status||null,"objective"),progress:this.clampProgress(this.parsePercent(t.objectiveProgress??t.progress)),confidence:null,category:t.objectiveCategory||"",tags:this.parseTags(t.tags),notes:t.objectiveNotes||t.notes||"",alignment:t.alignment||"",priority:t.priority||"",keyResults:[]}));const d=a.get(l);if(t.cycle&&!d.cycle&&(d.cycle=t.cycle),t.objectiveOwner&&(d.owner=t.objectiveOwner),t.team&&!d.team&&(d.team=t.team),t.objectiveStatus&&(d.status=this.normalizeStatus(t.objectiveStatus,"objective")),void 0!==t.objectiveProgress&&null!==t.objectiveProgress&&""!==t.objectiveProgress&&(d.progress=this.clampProgress(this.parsePercent(t.objectiveProgress))),t.alignment&&(d.alignment=t.alignment),t.priority&&(d.priority=t.priority),t.objectiveNotes&&(d.notes=t.objectiveNotes),t.tags){const e=new Set([...d.tags,...this.parseTags(t.tags)]);d.tags=Array.from(e)}const c=t.keyResult||t.kr||t.resultadoClave,p=c?String(c).trim():"",u=t.krMetric||t.metric||"",m=this.parseNumber(t.krBaseline??t.baseline),h=this.parseNumber(t.krTarget??t.target),g=this.parseNumber(t.krCurrent??t.current),b=this.parsePercent(t.krProgress);let v=null!==b?b:null;null===v&&null!==h&&null!==g&&(null!==m&&h!==m?v=(g-m)/(h-m)*100:0!==h&&(v=g/h*100));const y=this.normalizeStatus(t.krStatus||t.status||null,"kr"),f=this.parseNumber(t.krConfidence??t.confidence),x=t.krOwner||t.owner||d.owner;if(p){r+=1;const e={id:`kr-${r}`,objectiveId:d.id,objectiveName:d.name,name:p,owner:x,metric:u,baseline:m,target:h,current:g,progress:null!==v?this.clampProgress(v):null,status:y,confidence:Number.isFinite(f)?f:null,tags:this.parseTags(t.tags),notes:t.notes||""};d.keyResults.push(e),n.push(e);const a=this.splitText(t.initiatives||t.initiative);a.length&&a.forEach(a=>{if(!a)return;const n=this.parseDate(t.initiativeDue);i.push({id:`init-${i.length+1}`,title:a,owner:t.initiativeOwner||x||d.owner,status:this.normalizeStatus(t.initiativeStatus||t.krStatus||null,"initiative"),due:n,dueLabel:n?this.formatDate(n):"",objectiveId:d.id,objectiveName:d.name,keyResultId:e.id,keyResultName:e.name,cycle:d.cycle,tags:this.parseTags(t.tags)})})}});return{objectives:Array.from(a.values()).map(e=>{const t=e.keyResults.map(e=>e.progress).filter(e=>"number"==typeof e&&!Number.isNaN(e));if((!Number.isFinite(e.progress)||null===e.progress)&&t.length){const a=t.reduce((e,t)=>e+t,0)/t.length;e.progress=this.clampProgress(a)}Number.isFinite(e.progress)||(e.progress=0);const a=e.keyResults.map(e=>e.confidence).filter(e=>"number"==typeof e&&!Number.isNaN(e));return e.confidence=a.length?Number((a.reduce((e,t)=>e+t,0)/a.length).toFixed(1)):null,e}),keyResults:n,initiatives:i}},parseNumber(e){if(null==e||""===e)return null;if("number"==typeof e&&!Number.isNaN(e))return e;const t=String(e).replace(/\s/g,"").replace(/%/g,"").replace(/,/g,".").replace(/[^0-9.+\-]/g,"");if(!t)return null;const a=parseFloat(t);return Number.isFinite(a)?a:null},parsePercent(e){if(null==e||""===e)return null;const t=this.parseNumber(e);if(null===t)return null;const a=String(e).trim();return a.includes("%")?t:Math.abs(t)<=1&&/[.,]\d+/.test(a)?100*t:t},clampProgress:e=>Number.isFinite(e)?Math.max(0,Math.min(150,Number(e))):0,parseDate(e){var t;if(null==e||""===e)return null;if(e instanceof Date&&!Number.isNaN(e.getTime()))return e;if("number"==typeof e&&"undefined"!=typeof XLSX&&(null==(t=null==XLSX?void 0:XLSX.SSF)?void 0:t.parse_date_code)){const t=XLSX.SSF.parse_date_code(e);if(t)return new Date(t.y,t.m-1,t.d)}const a=String(e).trim();if(!a)return null;const n=new Date(a);if(!Number.isNaN(n.getTime()))return n;const i=a.replace(/-/g,"/").split("/");if(3===i.length)if(4===i[0].length){const e=new Date(Number(i[0]),Number(i[1])-1,Number(i[2]));if(!Number.isNaN(e.getTime()))return e}else{const e=Number(i[0]),t=Number(i[1])-1,a=Number(2===i[2].length?`20${i[2]}`:i[2]),n=new Date(a,t,e);if(!Number.isNaN(n.getTime()))return n}return null},formatDate:e=>e instanceof Date&&!Number.isNaN(e.getTime())?e.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:"numeric"}):"",parseTags:e=>null==e||""===e?[]:Array.isArray(e)?e.map(e=>String(e).trim()).filter(Boolean):String(e).split(/[,;|]/).map(e=>e.trim()).filter(Boolean),splitText:e=>e||0===e?Array.isArray(e)?e.map(e=>String(e).trim()).filter(Boolean):String(e).split(/[\n;|]/).map(e=>e.trim()).filter(Boolean):[],normalizeStatus(e,t="objective"){if(null==e||""===e)return"initiative"===t?"not_started":"on_track";const a=this.normalizeHeader(e);if(!a)return"initiative"===t?"not_started":"on_track";for(const[n,i]of Object.entries(this.statusAliasMap))if(i.includes(a)||i.some(e=>a.startsWith(e)))return n;return"objective"===t&&/100/.test(String(e))?"completed":"initiative"===t?"not_started":"on_track"},getStatusColor:e=>({on_track:"var(--success)",at_risk:"var(--warning)",off_track:"var(--danger)",completed:"var(--primary-light)",not_started:"var(--text-muted)",paused:"var(--secondary)"}[e]||"var(--primary-light)"),formatStatusLabel(e){switch(e){case"on_track":return"En curso";case"at_risk":return"Con riesgo";case"off_track":return"Fuera de plan";case"completed":return"Completado";case"paused":return"Pausado";default:return"Pendiente"}},setData(e){if(!e||!Array.isArray(e.objectives))throw new Error("Dataset OKR invlido.");this.state.objectives=e.objectives,this.state.keyResults=e.keyResults||[],this.state.initiatives=e.initiatives||[],this.state.dataLoaded=!0,this.resetFilters(!1),this.updateFilterOptions(),this.renderDashboard()},resetFilters(e=!0){this.state.filters={cycle:"all",owner:"all",status:"all",tag:"all",search:""},this.elements.filterCycle&&(this.elements.filterCycle.value="all"),this.elements.filterOwner&&(this.elements.filterOwner.value="all"),this.elements.filterStatus&&(this.elements.filterStatus.value="all"),this.elements.filterTag&&(this.elements.filterTag.value="all"),this.elements.searchInput&&(this.elements.searchInput.value=""),e&&this.renderDashboard()},updateFilterOptions(){if(!this.elements.container||!this.state.objectives.length)return;const e=new Set,t=new Set,a=new Set,n=new Set;this.state.objectives.forEach(i=>{i.cycle&&e.add(i.cycle),i.owner&&t.add(i.owner),i.status&&a.add(i.status),(i.tags||[]).forEach(e=>n.add(e))}),this.populateSelect(this.elements.filterCycle,e,"Todos"),this.populateSelect(this.elements.filterOwner,t,"Todos"),this.populateSelect(this.elements.filterStatus,a,"Todos",{isStatus:!0}),this.populateSelect(this.elements.filterTag,n,"Todas")},populateSelect(e,t,a,n={}){if(!e)return;const i=e.value||"all",s=Array.from(t).filter(Boolean).sort((e,t)=>String(e).localeCompare(String(t),"es",{sensitivity:"base"}));let r=`<option value="all">${a}</option>`;s.forEach(e=>{const t=n.isStatus?this.formatStatusLabel(e):e;r+=`<option value="${this.escapeHtml(e)}">${this.escapeHtml(t)}</option>`}),e.innerHTML=r,s.includes(i)?e.value=i:e.value="all"},applyFilters(){if(!this.state.objectives.length)return[];const{cycle:e,owner:t,status:a,tag:n,search:i}=this.state.filters,s=(i||"").trim().toLowerCase();return this.state.objectives.filter(i=>{if("all"!==e&&i.cycle!==e)return!1;if("all"!==t&&i.owner!==t)return!1;if("all"!==a&&i.status!==a)return!1;if("all"!==n&&!(i.tags||[]).includes(n))return!1;if(s){if(![i.name,i.owner,i.cycle,i.team,(i.tags||[]).join(" "),i.keyResults.map(e=>`${e.name} ${e.owner} ${e.metric}`).join(" ")].join(" ").toLowerCase().includes(s))return!1}return!0})},renderDashboard(){if(!this.elements.container)return;if(!this.state.objectives.length)return void this.renderEmptyState();const e=this.applyFilters();this.lastFilteredIds=new Set(e.map(e=>e.id)),this.toggleFilters(!0),this.toggleInsights(!0),this.renderSummary(e),this.renderObjectives(e),this.renderKeyResults(e),this.renderInitiatives(e)},renderSummary(e){var t;const a=this.elements.summary;if(!a)return;if(!this.state.objectives.length)return a.classList.remove("is-visible"),void(a.innerHTML="");if(a.classList.add("is-visible"),!e.length)return void(a.innerHTML='\n        <div class="okr-empty-panel">\n          <strong>Sin coincidencias con los filtros aplicados.</strong>\n          <span>Ajusta los criterios para visualizar tus OKR.</span>\n        </div>\n      ');const n=e.length,i=this.state.keyResults.filter(e=>this.lastFilteredIds.has(e.objectiveId)),s=n?e.reduce((e,t)=>e+(Number.isFinite(t.progress)?t.progress:0),0)/n:0,r=i.filter(e=>Number.isFinite(e.confidence)),o=r.length?r.reduce((e,t)=>e+t.confidence,0)/r.length:null,l=e.filter(e=>"at_risk"===e.status).length,d=e.filter(e=>"off_track"===e.status).length,c=e.filter(e=>"completed"===e.status).length,p=(null==(t=this.state.initiatives.filter(e=>this.lastFilteredIds.has(e.objectiveId)).filter(e=>e.due).sort((e,t)=>e.due-t.due).slice(0,1)[0])?void 0:t.dueLabel)||"Sin hitos prximos",u=i.filter(e=>"at_risk"===e.status||"off_track"===e.status).length;a.innerHTML=`\n      <div class="okr-summary-grid">\n        <article class="okr-summary-card">\n          <span class="okr-summary-label">Objetivos activos</span>\n          <span class="okr-summary-value">${this.formatNumber(n)}</span>\n          <span class="okr-summary-sub">${this.formatNumber(i.length)} resultados clave</span>\n        </article>\n        <article class="okr-summary-card">\n          <span class="okr-summary-label">Avance promedio</span>\n          <span class="okr-summary-value">${this.formatDecimal(s,0)}%</span>\n          <span class="okr-summary-sub">${null===o?"Sin dato de confianza":`Confianza media ${this.formatDecimal(o,1)}/10`}</span>\n        </article>\n        <article class="okr-summary-card">\n          <span class="okr-summary-label">Estado del portfolio</span>\n          <span class="okr-summary-value">${this.formatNumber(c)} </span>\n          <span class="okr-summary-sub">${this.formatNumber(l)} con riesgo  ${this.formatNumber(d)} fuera de plan</span>\n        </article>\n        <article class="okr-summary-card">\n          <span class="okr-summary-label">Prximo hito</span>\n          <span class="okr-summary-value">${this.escapeHtml(p)}</span>\n          <span class="okr-summary-sub">${u?`${this.formatNumber(u)} resultados clave necesitan foco`:"Sin alertas"}</span>\n        </article>\n      </div>\n    `},renderObjectives(e){const t=this.elements.objectives;t&&(this.state.objectives.length?e.length?t.innerHTML=e.map(e=>this.renderObjectiveCard(e)).join(""):t.innerHTML='\n        <div class="okr-empty">\n          <h3>No hay resultados para los filtros actuales</h3>\n          <p>Ampla la bsqueda o restablece los filtros para visualizar tus OKR.</p>\n        </div>\n      ':t.innerHTML="")},renderObjectiveCard(e){const t=Number.isFinite(e.progress)?Math.round(e.progress):0,a=3.6*Math.max(0,Math.min(100,t)),n=this.getStatusColor(e.status),i=(e.tags||[]).length?`<div class="okr-tags">${e.tags.map(e=>`<span class="okr-chip tag">${this.escapeHtml(e)}</span>`).join("")}</div>`:"",s=[e.alignment?`<span class="okr-meta-item">Alinea: ${this.escapeHtml(e.alignment)}</span>`:"",Number.isFinite(e.confidence)?`<span class="okr-meta-item">Confianza ${this.formatDecimal(e.confidence,1)}/10</span>`:"",e.priority?`<span class="okr-meta-item">Prioridad ${this.escapeHtml(e.priority)}</span>`:""].filter(Boolean).join(""),r=e.keyResults.length?e.keyResults.map(e=>this.renderKeyResultChip(e)).join(""):'<div class="okr-empty-panel">Agrega resultados clave para este objetivo.</div>';return`\n      <article class="okr-card" data-okr-objective="${e.id}">\n        <header class="okr-card-header">\n          <div class="okr-progress-ring" style="--progress:${a}; --progress-color:${n};">\n            <span>${this.formatDecimal(t,0)}%</span>\n          </div>\n          <div class="okr-card-title">\n            <h3>${this.escapeHtml(e.name)}</h3>\n            <div class="okr-card-meta">\n              <span class="okr-chip status status-${e.status}">${this.formatStatusLabel(e.status)}</span>\n              ${e.cycle?`<span class="okr-chip muted">${this.escapeHtml(e.cycle)}</span>`:""}\n              ${e.owner?`<span class="okr-chip muted"> ${this.escapeHtml(e.owner)}</span>`:""}\n              ${e.team?`<span class="okr-chip muted"> ${this.escapeHtml(e.team)}</span>`:""}\n            </div>\n          </div>\n        </header>\n        <div class="okr-card-body">\n          ${e.notes?`<p class="okr-card-notes">${this.escapeHtml(e.notes)}</p>`:""}\n          ${s?`<div class="okr-metadata-line">${s}</div>`:""}\n          <div class="okr-kr-list">\n            ${r}\n          </div>\n          ${i}\n        </div>\n      </article>\n    `},renderKeyResultChip(e){const t=Number.isFinite(e.progress)?`${this.formatDecimal(e.progress,0)}%`:"--",a=[];Number.isFinite(e.current)&&a.push(`Actual ${this.formatDecimal(e.current,1)}`),Number.isFinite(e.target)&&a.push(`Meta ${this.formatDecimal(e.target,1)}`);const n=a.length?a.join("  "):e.metric?this.escapeHtml(e.metric):"",i=Number.isFinite(e.confidence)?`<span class="okr-chip mini muted">Confianza ${this.formatDecimal(e.confidence,1)}</span>`:"";return`\n      <div class="okr-kr-card">\n        <div class="okr-kr-top">\n          <span class="okr-kr-name">${this.escapeHtml(e.name)}</span>\n          <span class="okr-kr-progress" style="color:${this.getStatusColor(e.status)};">${t}</span>\n        </div>\n        ${n?`<div class="okr-kr-meta">${n}</div>`:""}\n        <div class="okr-kr-footer">\n          ${e.owner?`<span class="okr-chip mini muted"> ${this.escapeHtml(e.owner)}</span>`:""}\n          <span class="okr-chip mini status status-${e.status||"on_track"}">${this.formatStatusLabel(e.status)}</span>\n          ${i}\n        </div>\n      </div>\n    `},renderKeyResults(e){const t=this.elements.keyResults;if(!t)return;if(!this.state.objectives.length)return void(t.innerHTML="");if(!e.length)return void(t.innerHTML='<div class="okr-empty-panel">No hay resultados clave para los filtros actuales.</div>');const a=this.state.keyResults.filter(e=>this.lastFilteredIds.has(e.objectiveId));if(!a.length)return void(t.innerHTML='<div class="okr-empty-panel">Agrega resultados clave para ver mtricas de foco.</div>');const n=[...a].sort((e,t)=>{const a=e=>{switch(e){case"off_track":return 0;case"at_risk":return 1;case"not_started":return 2;case"on_track":return 3;case"completed":return 4;default:return 5}},n=a(e.status)-a(t.status);if(0!==n)return n;return(Number.isFinite(e.progress)?e.progress:101)-(Number.isFinite(t.progress)?t.progress:101)}).slice(0,6);t.innerHTML=n.map(e=>{const t=Number.isFinite(e.progress)?`${this.formatDecimal(e.progress,0)}%`:"--";return`\n        <div class="okr-kr-row">\n          <div class="okr-row-top">\n            <span class="okr-row-title">${this.escapeHtml(e.name)}</span>\n            <span class="okr-kr-progress">${t}</span>\n          </div>\n          <div class="okr-row-meta">\n            <span>${this.escapeHtml(e.objectiveName)}</span>\n            ${e.owner?`<span> ${this.escapeHtml(e.owner)}</span>`:""}\n            <span>${this.formatStatusLabel(e.status)}</span>\n            ${Number.isFinite(e.confidence)?`<span>Confianza ${this.formatDecimal(e.confidence,1)}</span>`:""}\n          </div>\n        </div>\n      `}).join("")},renderInitiatives(e){const t=this.elements.initiatives;if(!t)return;if(!this.state.objectives.length)return void(t.innerHTML="");if(!e.length)return void(t.innerHTML='<div class="okr-empty-panel">No hay iniciativas para los filtros aplicados.</div>');const a=this.state.initiatives.filter(e=>this.lastFilteredIds.has(e.objectiveId));if(!a.length)return void(t.innerHTML='<div class="okr-empty-panel">Registra iniciativas con fechas objetivo para planificar.</div>');const n=a.slice().sort((e,t)=>e.due&&t.due?e.due-t.due:e.due?-1:t.due?1:e.title.localeCompare(t.title,"es",{sensitivity:"base"})).slice(0,6);t.innerHTML=n.map(e=>`\n      <div class="okr-initiative-row">\n        <div class="okr-row-top">\n          <span class="okr-row-title">${this.escapeHtml(e.title)}</span>\n          <span class="okr-chip mini status status-${e.status||"not_started"}">${this.formatStatusLabel(e.status)}</span>\n        </div>\n        <div class="okr-row-meta">\n          <span>Objetivo: ${this.escapeHtml(e.objectiveName)}</span>\n          ${e.owner?`<span> ${this.escapeHtml(e.owner)}</span>`:""}\n          <span>${e.dueLabel?`Fecha: ${this.escapeHtml(e.dueLabel)}`:"Sin fecha"}</span>\n        </div>\n      </div>\n    `).join("")},renderEmptyState(){this.elements.container&&(this.toggleFilters(!1),this.toggleInsights(!1),this.elements.summary&&(this.elements.summary.classList.remove("is-visible"),this.elements.summary.innerHTML=""),this.elements.objectives&&(this.elements.objectives.innerHTML='\n        <div class="okr-empty">\n          <h3>Importa tus OKR para empezar</h3>\n          <p>Descarga la plantilla de Excel o arrastra tu archivo existente para visualizar objetivos, resultados clave e iniciativas.</p>\n          <ul>\n            <li>Una fila por Resultado Clave asociado a su Objetivo.</li>\n            <li>Incluye columnas de mtrica, meta, actual y confianza.</li>\n            <li>Opcional: iniciativas, fecha objetivo, etiquetas y notas.</li>\n          </ul>\n        </div>\n      '),this.elements.keyResults&&(this.elements.keyResults.innerHTML='<div class="okr-empty-panel">Aqu vers los resultados clave que requieren atencin.</div>'),this.elements.initiatives&&(this.elements.initiatives.innerHTML='<div class="okr-empty-panel">Registra iniciativas para seguir los hitos crticos.</div>'))},toggleFilters(e){this.elements.filters&&this.elements.filters.classList.toggle("is-active",Boolean(e))},toggleInsights(e){this.elements.insights&&this.elements.insights.classList.toggle("okr-hidden",!e)},showToast(e,t="info",a=3200){void 0!==c&&"function"==typeof c.showToast&&c.showToast(e,t,a)},downloadTemplate(){try{const e=["Ciclo","Objetivo","Dueo Objetivo","Estado Objetivo","Progreso Objetivo","Resultado Clave","Dueo RC","Mtrica","Lnea Base","Meta","Actual","Confianza","Estado RC","Iniciativa","Dueo Iniciativa","Estado Iniciativa","Fecha Objetivo","Etiquetas","Notas"],t=[["Q1 2026","Incrementar conversin web","Marketing","En curso","35","Aumentar conversin del 1,8% al 2,5%","Camila Soto","% conversin","1.8","2.5","2.1","6","Con riesgo","Optimizar flujo de compra","UX Team","En curso","2026-02-15","Growth;Web","Prioridad mobile"],["Q1 2026","Incrementar conversin web","","","","Reducir tiempo de carga a 2s","TI","Segundos","3.8","2","2.6","7","En curso","Auditora de performance","TI","En curso","2026-01-30","Tecnologa",""],["Q1 2026","Incrementar conversin web","","","","Generar 300 leads va referidos","Growth","Leads","0","300","120","5","En riesgo","Disear incentivos","Growth","Pendiente","2026-03-10","Alianzas",""]],a=XLSX.utils.aoa_to_sheet([e,...t]),n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,a,"OKR"),XLSX.writeFile(n,"plantilla_OKR_visual.xlsx"),this.showToast("Plantilla OKR descargada.","success",2800)}catch(e){this.showToast("No se pudo generar la plantilla","error",3200)}},loadDemoData(){try{const e=this.buildDemoRows(),t=this.transformRows(e,!0);this.setData(t),this.showToast("Demo OKR cargada.","success",2800)}catch(e){this.showToast("No se pudo cargar la demo","error",3200)}},buildDemoRows:()=>[{objective:"Incrementar conversin web",cycle:"Q1 2026",objectiveOwner:"Marketing",objectiveStatus:"En curso",objectiveProgress:"35%",keyResult:"Aumentar la tasa de conversin del 1,8% al 2,5%",krOwner:"Camila Soto",krMetric:"% conversin",krBaseline:"1.8",krTarget:"2.5",krCurrent:"2.1",krConfidence:"6",krStatus:"Con riesgo",initiatives:"Optimizar flujo de compra;Validar mensajes clave",initiativeOwner:"UX Team",initiativeStatus:"En curso",initiativeDue:"2026-02-15",tags:"Growth;Web",notes:"Prioridad mobile"},{objective:"Incrementar conversin web",cycle:"Q1 2026",objectiveOwner:"Marketing",keyResult:"Reducir tiempo de carga promedio a 2 segundos",krOwner:"Equipo TI",krMetric:"Segundos / pgina",krBaseline:"3.8",krTarget:"2",krCurrent:"2.6",krConfidence:"7",krStatus:"En curso",initiatives:"Auditora de performance;Implementar CDN",initiativeOwner:"Equipo TI",initiativeStatus:"En curso",initiativeDue:"2026-01-30",tags:"Tecnologa;Performance"},{objective:"Incrementar conversin web",cycle:"Q1 2026",objectiveOwner:"Marketing",keyResult:"Generar 300 leads nuevos va programa de referidos",krOwner:"Growth",krMetric:"Leads",krTarget:"300",krCurrent:"120",krConfidence:"5",krStatus:"Con riesgo",initiatives:"Disear incentivos referidos",initiativeOwner:"Growth",initiativeStatus:"Pendiente",initiativeDue:"2026-03-10",tags:"Alianzas"},{objective:"Reducir churn de clientes enterprise",cycle:"Q1 2026",objectiveOwner:"Customer Success",objectiveStatus:"Con riesgo",objectiveProgress:"48%",keyResult:"Reducir el churn del 8% al 5%",krOwner:"Ana Villar",krMetric:"% churn",krBaseline:"8",krTarget:"5",krCurrent:"6.1",krConfidence:"4",krStatus:"Con riesgo",initiatives:"Implementar programa de health checks",initiativeOwner:"Customer Success",initiativeStatus:"En curso",initiativeDue:"2026-02-05",tags:"Retention;Clientes",notes:"Enfoque en cuentas clave"},{objective:"Reducir churn de clientes enterprise",cycle:"Q1 2026",objectiveOwner:"Customer Success",keyResult:"Lograr NPS promedio de 45 puntos",krOwner:"Equipo CX",krMetric:"NPS",krBaseline:"32",krTarget:"45",krCurrent:"41",krConfidence:"7",krStatus:"En curso",initiatives:"Disear playbook de onboarding avanzado",initiativeOwner:"Equipo CX",initiativeStatus:"En curso",initiativeDue:"2026-02-20",tags:"Experiencia"},{objective:"Escalar plataforma de datos",cycle:"Q1 2026",objectiveOwner:"Tecnologa",objectiveStatus:"En curso",keyResult:"Migrar 80% de cargas a arquitectura evento-driven",krOwner:"Data Engineering",krMetric:"% workloads",krTarget:"80",krCurrent:"52",krConfidence:"8",krStatus:"En curso",initiatives:"Habilitar bus de eventos para facturacin",initiativeOwner:"Data Engineering",initiativeStatus:"En curso",initiativeDue:"2026-02-28",tags:"Plataforma;Data",alignment:"Eficiencia operacional"}],formatNumber(e,t={}){const a=Number(e);return Number.isFinite(a)?a.toLocaleString("es-ES",t):"0"},formatDecimal(e,t=0){const a=Number(e);return Number.isFinite(a)?a.toLocaleString("es-ES",{minimumFractionDigits:t,maximumFractionDigits:t}):0===t?"0":Number(0).toFixed(t)},escapeHtml:e=>null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),renderSAPTree(){const e=document.getElementById("sapTreeContainer");if(!e)return;const t=this.getFilteredJerarquiaData();if(!t||0===t.length)return e.innerHTML='<div style="padding: 20px; text-align: center; color: #666;">No hay datos para mostrar</div>',void this.updateSAPTreeCount(0);const a=this.buildTreeStructure(t);e.innerHTML=this.renderTreeNodes(a,0),this.updateSAPTreeCount(t.length)},getFilteredJerarquiaData(){var e,t,a,n,i,s,r;const o=(null==(e=document.getElementById("filtro_planta"))?void 0:e.value)||"",l=(null==(t=document.getElementById("filtro_area"))?void 0:t.value)||"",d=(null==(a=document.getElementById("filtro_subarea"))?void 0:a.value)||"",c=(null==(n=document.getElementById("filtro_sistemaEquipo"))?void 0:n.value)||"",p=(null==(i=document.getElementById("filtro_subsistema"))?void 0:i.value)||"",u=(null==(s=document.getElementById("filtro_seccion"))?void 0:s.value)||"",m=(null==(r=document.getElementById("filtro_detalle"))?void 0:r.value)||"";let h=this.repuestos.filter(e=>(!o||e.planta===o)&&((!l||e.areaGeneral===l)&&((!d||e.subArea===d)&&((!c||e.sistemaEquipo===c)&&((!p||e.subSistema===p)&&((!u||e.seccion===u)&&(!m||e.detalle===m)))))));const g=new Map;return h.forEach(e=>{const t=e.planta||"Sin Planta",a=e.areaGeneral||"Sin rea",n=e.subArea||"Sin Sub-rea",i=e.sistemaEquipo||"Sin Sistema",s=e.subSistema||"Sin Sub-Sistema",r=e.seccion||"",o=e.detalle||"";let l=`${t}|${a}|${n}|${i}`;"Sin Sub-Sistema"!==s&&(l+=`|${s}`,r&&(l+=`|${r}`,o&&(l+=`|${o}`))),g.has(l)||g.set(l,{planta:t,area:a,subarea:n,sistema:i,subsistema:"Sin Sub-Sistema"!==s?s:null,seccion:r||null,detalle:o||null,count:0,repuestos:[]});const d=g.get(l);d.count++,d.repuestos.push(e)}),Array.from(g.values())},buildTreeStructure(e){const t={};return e.forEach(e=>{t[e.planta]||(t[e.planta]={label:e.planta,type:"planta",children:{},count:0,repuestos:[]}),t[e.planta].count+=e.count;const a=e.area;t[e.planta].children[a]||(t[e.planta].children[a]={label:e.area,type:"area",children:{},count:0,repuestos:[]}),t[e.planta].children[a].count+=e.count;const n=e.subarea;t[e.planta].children[a].children[n]||(t[e.planta].children[a].children[n]={label:e.subarea,type:"subarea",children:{},count:0,repuestos:[]}),t[e.planta].children[a].children[n].count+=e.count;const i=e.sistema;if(t[e.planta].children[a].children[n].children[i]||(t[e.planta].children[a].children[n].children[i]={label:e.sistema,type:"sistema",children:{},count:0,repuestos:[]}),t[e.planta].children[a].children[n].children[i].count+=e.count,e.subsistema){const s=e.subsistema;if(t[e.planta].children[a].children[n].children[i].children[s]||(t[e.planta].children[a].children[n].children[i].children[s]={label:e.subsistema,type:"subsistema",children:{},count:0,repuestos:[]}),t[e.planta].children[a].children[n].children[i].children[s].count+=e.count,e.seccion){const r=e.seccion;if(t[e.planta].children[a].children[n].children[i].children[s].children[r]||(t[e.planta].children[a].children[n].children[i].children[s].children[r]={label:e.seccion,type:"seccion",children:{},count:0,repuestos:[]}),t[e.planta].children[a].children[n].children[i].children[s].children[r].count+=e.count,e.detalle){const o=e.detalle;t[e.planta].children[a].children[n].children[i].children[s].children[r].children[o]={label:e.detalle,type:"detalle",count:e.count,repuestos:e.repuestos||[]}}else t[e.planta].children[a].children[n].children[i].children[s].children[r].repuestos.push(...e.repuestos||[])}else t[e.planta].children[a].children[n].children[i].children[s].repuestos.push(...e.repuestos||[])}else t[e.planta].children[a].children[n].children[i].repuestos.push(...e.repuestos||[])}),t},renderTreeNodes(e,t){let a="";return Object.keys(e).forEach(n=>{var i;const s=e[n],r=s.children&&Object.keys(s.children).length>0,o=`sap-node-${Math.random().toString(36).substr(2,9)}`;let l="";("planta"===s.type||"area"===s.type||"subarea"===s.type||"sistema"===s.type||"subsistema"===s.type||"seccion"===s.type||"detalle"===s.type)&&(l="");const d=t>7?7:t,c=8+20*d,p=s.label||n||"",u=p.split(" - "),m=u.length>1?(null==(i=u.shift())?void 0:i.trim())||p:n||p,h=u.length?u.join(" - ").trim():p,g=this.escapeHtml(m),b=this.escapeHtml(h),v=(p||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'"),y=(s.type||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");a+=`\n        <div class="sap-tree-node" data-level="${d}">\n          <div class="sap-tree-item indent-${d}" data-node-id="${o}" data-type="${s.type}" style="--indent:${c}px">\n            ${r?`\n              <span class="sap-tree-toggle" onclick="app.sapTreeToggleNode('${o}')"></span>\n            `:'\n              <span class="sap-tree-toggle-placeholder" style="width: 16px; display: inline-block;"></span>\n            '}\n            <span class="sap-tree-icon">${l}</span>\n            <span class="sap-tree-code">${g}</span>\n            <span class="sap-tree-label" onclick="app.sapTreeSelectNode('${o}', '${v}', '${y}')">${b}</span>\n            ${s.count>0?`<span class="sap-tree-badge">${s.count}</span>`:""}\n          </div>\n          ${r?`\n            <div class="sap-tree-children" data-parent="${o}" style="display: none;">\n              ${this.renderTreeNodes(s.children,t+1)}\n            </div>\n          `:""}\n        </div>\n      `}),a},sapTreeToggleNode(e){const t=document.querySelector(`[data-node-id="${e}"]`),a=document.querySelector(`[data-parent="${e}"]`),n=null==t?void 0:t.querySelector(".sap-tree-toggle");if(!a||!n)return;"none"!==a.style.display?(a.style.display="none",n.textContent="",t.classList.remove("expanded")):(a.style.display="block",n.textContent="",t.classList.add("expanded"))},sapTreeSelectNode(e,t,a){document.querySelectorAll(".sap-tree-item.selected").forEach(e=>{e.classList.remove("selected")});const n=document.querySelector(`[data-node-id="${e}"]`);n&&(n.classList.add("selected"),this.showToast(`Seleccionado: ${t}`,"info"))},sapTreeExpandAll(){document.querySelectorAll(".sap-tree-children").forEach(e=>{e.style.display="block"}),document.querySelectorAll(".sap-tree-toggle").forEach(e=>{e.textContent=""}),document.querySelectorAll(".sap-tree-item").forEach(e=>{e.classList.add("expanded")})},sapTreeCollapseAll(){document.querySelectorAll(".sap-tree-children").forEach(e=>{e.style.display="none"}),document.querySelectorAll(".sap-tree-toggle").forEach(e=>{e.textContent=""}),document.querySelectorAll(".sap-tree-item").forEach(e=>{e.classList.remove("expanded")})},sapTreeRefresh(){this.renderSAPTree()},updateSAPTreeCount(e){const t=document.getElementById("sapTreeCount");t&&(t.textContent=e)}},c=new class{constructor(){t(this,"ubicacionesActuales",[]),t(this,"currentImageFile",null),t(this,"currentOptimizeSize",1200),t(this,"currentQuality",.85),t(this,"draggedSAPNode",null),t(this,"jerarquiaData",{nivel1:[],nivel2:[],nivel3:[],nivel4:[],nivel5:[],nivel6:[],nivel7:[],nivel8:[]}),t(this,"jerarquiaCurrentLevel",1),t(this,"jerarquiaEditingId",null),t(this,"jerarquiaSearchTerm",""),t(this,"jerarquiaCollapsedState",{}),t(this,"draggedItemId",null),this.repuestos=[],this.conteoData={},this.conteoActivo=!1,this.currentView="cards",this.currentTab="inventario",this.mapTool="select",this.mapObjects=[],this.mapImage=null,this.currentMultimedia=[],this.currentDocuments=[],this.currentEditingId=null,this.currentPage=1,this.itemsPerPage="auto",this.itemsPerPageManual=21,this.viewMode=localStorage.getItem("viewMode")||"auto",this.isEdge=this.detectEdge(),this.isEdgeIOS=!1,this.filteredRepuestos=[],this.showPrecio=!1,this.autocompleteData={codProv:[],tipo:[],area:[],equipo:[]},this.lightboxMedias=[],this.lightboxIndex=0,this.canvas=null,this.ctx=null,this.listSortField="codSAP",this.listSortOrder="asc",this.columnWidths=["50px","0.9fr","1.5fr","160px","220px"],this.currentJerarquiaPalette="palette-visual",this.lastVisualV2Refresh=0,this.historyStack=[],this.redoStack=[],this.maxHistorySize=50,this.draggedSAPNode=null,this.dropPosition=null,this.wizardState={currentStep:1,totalSteps:0,steps:[],indicators:[],stepsVisited:new Set([1]),maxCompletedStep:1,nextBtn:null,prevBtn:null,saveBtn:null,pendingInvalidField:null,lastValidationError:null},this.handleWizardNext=this.handleWizardNext.bind(this),this.handleWizardPrev=this.handleWizardPrev.bind(this),this.handleWizardIndicatorClick=this.handleWizardIndicatorClick.bind(this),this.notifications=[],this.unreadNotifications=0,this.notificationPanel=null,this.notificationBell=null;try{const e=localStorage.getItem("notifications");e&&(this.notifications=JSON.parse(e))}catch(e){this.notifications=[]}this.usarVersionCascada=!0,this.sistemaPorEquipo={Grader:["Pocket 1","Pocket 2","Pocket 3","Pocket 4","Cinta Z","Cinta Aceleracin 1","Cinta Aceleracin 2","Cinta Larga","Sistema Hidrulico","Sistema Neumtico","Panel Elctrico Principal","Tablero Control","Motor Principal","Otro"],Compresor:["Motor Principal","Tanque Almacenamiento","Vlvulas Control","Sistema Refrigeracin","Panel Control","Filtros Aire","Otro"],Bomba:["Motor Elctrico","Impulsor","Carcasa","Sellos Mecnicos","Rodamientos","Base y Acople","Vlvulas","Otro"],Transportador:["Banda/Cadena","Motor Traccin","Rodillos","Tensor","Estructura Soporte","Sistema Guas","Otro"],default:["Motor","Transmisin","Sistema Elctrico","Sistema Hidrulico","Sistema Neumtico","Estructura","Controles","Otro"]},this.customSistemas=this.loadCustomSistemas(),this.plantaBase="Aquachile Antarfood Chonchi",this.jerarquiaAnidada=null,this.loadJerarquiaAnidada(),window.toggleVersionUbicaciones=()=>{this.usarVersionCascada=!this.usarVersionCascada;const e=document.getElementById("repuestoModal");e&&e.classList.contains("show")&&(this.usarVersionCascada?this.renderUbicacionesCascada():this.renderUbicaciones())},this.nivelJerarquiaImagenes=parseInt(localStorage.getItem("nivelJerarquiaImagenes"))||1,this.renombrarImagenesAutomaticamente="false"!==localStorage.getItem("renombrarImagenesAuto"),this.eliminarImagenAntiguaAlMover="true"===localStorage.getItem("eliminarImagenAntigua"),this.longitudMaximaNombreArchivo=100,this.opcionesJerarquiaPredefinidas={areaGeneral:["Planta Principal","Acopio","Planta Yal","Estanques Agua","Estanque Inox","Entretecho","Bodega General","Zona Externa","rea de Mantencin","GENERAL"],subArea:["Zona Norte","Zona Sur","Piso 1","Piso 2","Sector A","Sector B","Pasillo Central","Lnea 1","Lnea 2"],sistemaEquipo:["Grader Marel","Compresor Atlas Copco","Cinta Transportadora 1","Cinta Transportadora 2","Bomba Principal","Sistema Hidrulico","Panel Elctrico Central","Grader","Compresor 01","Compresor 02"],subSistema:["Motor Principal","Sistema de Lubricacin","Tablero de Control","Pocket 1","Pocket 2","Pocket 3","Pocket 4","Cinta Z","Cinta Aceleracin 1","Cinta Aceleracin 2","Panel Elctrico"],seccion:["Panel Elctrico","Controles","Sistema Hidrulico","Sistema Neumtico","Zona de Corte","Sistema de Refrigeracin","Vlvulas Control"]},this.opcionesJerarquia={},this.loadOpcionesPersonalizadas(),this.jerarquiaNiveles=[{id:"planta",nombre:"Empresa",requerido:!0,visible:!0},{id:"areaGeneral",nombre:"rea General",requerido:!0,visible:!0},{id:"subArea",nombre:"Sub-rea",requerido:!1,visible:!1},{id:"sistemaEquipo",nombre:"Sistema/Equipo",requerido:!1,visible:!0},{id:"subSistema",nombre:"Sub-Sistema",requerido:!1,visible:!1},{id:"seccion",nombre:"Seccin",requerido:!1,visible:!1},{id:"detalle",nombre:"Detalle/Ubicacin",requerido:!1,visible:!1}],this.isMobile=this.detectMobile(),this.hasFileSystemAPI=this.checkFileSystemAPI(),this.storageMode=this.hasFileSystemAPI?"filesystem":"indexeddb",this.fsManager=n}detectMobile(){const e=navigator.userAgent.toLowerCase(),t=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(e),a="ontouchstart"in window||navigator.maxTouchPoints>0,n=window.innerWidth<768;return t||a&&n}checkFileSystemAPI(){return"showDirectoryPicker"in window}detectEdge(){const e=navigator.userAgent.toLowerCase(),t=e.includes("edg/"),a=e.includes("edge/"),n=/iphone|ipad|ipod/.test(e);return t&&n?(this.isEdgeIOS=!0,!0):(this.isEdgeIOS=!1,t||a)}showBrowserWarning(){if(!this.isMobile||this.hasFileSystemAPI)return this.isEdge&&this.isEdgeIOS?void this.showEdgeIOSInfo():void 0;this.showMobileSimplifiedBanner()}showEdgeIOSInfo(){const e=document.createElement("div");e.id="edge-ios-info-banner",e.innerHTML='\n      <div style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        z-index: 99999;\n        background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));\n        color: white;\n        padding: 12px 16px;\n        box-shadow: var(--shadow-lg);\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        gap: 12px;\n        animation: slideDown 0.5s ease-out;\n        font-size: 0.9rem;\n      ">\n        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">\n          <span style="font-size: 1.5rem;"></span>\n          <div>\n            <strong>Edge Mvil Detectado</strong>  \n             Cmara +  Galera/iCloud disponibles\n          </div>\n        </div>\n        <button onclick="document.getElementById(\'edge-ios-info-banner\').style.display=\'none\'" \n                style="\n                  padding: 6px 12px;\n                  background: rgba(255,255,255,0.2);\n                  color: white;\n                  border: 1px solid rgba(255,255,255,0.3);\n                  border-radius: 4px;\n                  cursor: pointer;\n                  font-size: 0.85rem;\n                  font-weight: 600;\n                "\n                onmouseover="this.style.background=\'rgba(255,255,255,0.3)\'"\n                onmouseout="this.style.background=\'rgba(255,255,255,0.2)\'">\n           Entendido\n        </button>\n      </div>\n      <style>\n        @keyframes slideDown {\n          from { transform: translateY(-100%); opacity: 0; }\n          to { transform: translateY(0); opacity: 1; }\n        }\n        @media (max-width: 768px) {\n          #edge-ios-info-banner > div {\n            font-size: 0.85rem;\n          }\n        }\n      </style>\n    ',document.body.insertBefore(e,document.body.firstChild),setTimeout(()=>{const e=document.getElementById("edge-ios-info-banner");e&&(e.style.transition="opacity 0.5s ease-out",e.style.opacity="0",setTimeout(()=>e.remove(),500))},5e3)}showMobileSimplifiedBanner(){const e=document.createElement("div");e.id="mobile-simplified-banner",e.innerHTML='\n      <div style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        z-index: 99999;\n        background: linear-gradient(135deg, rgba(139, 92, 246, 0.95), rgba(124, 58, 237, 0.95));\n        color: white;\n        padding: 14px 16px;\n        box-shadow: var(--shadow-lg);\n        animation: slideDown 0.5s ease-out;\n        font-size: 0.85rem;\n      ">\n        <div style="display: flex; flex-direction: column; gap: 10px;">\n          <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">\n            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">\n              <span style="font-size: 1.8rem;"></span>\n              <div>\n                <strong style="font-size: 1rem; display: block; margin-bottom: 3px;">\n                  Modo Mvil Simplificado\n                </strong>\n                <span style="opacity: 0.95; font-size: 0.8rem;">\n                  Solo datos  Sin fotos\n                </span>\n              </div>\n            </div>\n            <button onclick="document.getElementById(\'mobile-simplified-banner\').style.display=\'none\'" \n                    style="\n                      padding: 6px 12px;\n                      background: rgba(255,255,255,0.2);\n                      color: white;\n                      border: 1px solid rgba(255,255,255,0.3);\n                      border-radius: 4px;\n                      cursor: pointer;\n                      font-size: 0.8rem;\n                      font-weight: 600;\n                      white-space: nowrap;\n                    ">\n               Entendido\n            </button>\n          </div>\n          \n          <div style="\n            background: rgba(255,255,255,0.15);\n            padding: 10px 12px;\n            border-radius: 6px;\n            line-height: 1.5;\n            font-size: 0.8rem;\n          ">\n            <strong style="display: block; margin-bottom: 6px;"> Funciones activas:</strong>\n            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.75rem;">\n              <span> Ver inventario</span>\n              <span> Conteo rpido</span>\n              <span> Agregar repuestos</span>\n              <span> Buscar/Filtrar</span>\n              <span> Editar datos</span>\n              <span> Eliminar items</span>\n            </div>\n            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.75rem;">\n               <strong>Para fotos:</strong> Usa la versin de PC\n            </div>\n          </div>\n        </div>\n      </div>\n      <style>\n        @keyframes slideDown {\n          from { transform: translateY(-100%); opacity: 0; }\n          to { transform: translateY(0); opacity: 1; }\n        }\n      </style>\n    ',document.body.insertBefore(e,document.body.firstChild),setTimeout(()=>{const e=document.getElementById("mobile-simplified-banner");e&&(e.style.transition="opacity 0.5s ease-out",e.style.opacity="0",setTimeout(()=>e.remove(),500))},8e3)}getBrowserName(){const e=navigator.userAgent.toLowerCase();return e.includes("firefox")?"Mozilla Firefox":e.includes("chrome")&&!e.includes("edg")?"Google Chrome":e.includes("safari")&&!e.includes("chrome")?"Safari":e.includes("opera")||e.includes("opr")?"Opera":"Navegador Desconocido"}normalizeMultimediaItem(e,t=0){if(!e||"object"!=typeof e)return e;const a={...e};let n=a.type??a.tipo??"";n="string"==typeof n?n.trim().toLowerCase():"";const i={image:"image",imagen:"image",img:"image",foto:"image",picture:"image",video:"video",vdeo:"video",document:"document",documento:"document",doc:"document",archivo:"document"};if(i[n]?a.type=i[n]:n&&(a.type=n),a.name||(a.name=a.filename||a.originalName||a.nombreArchivo||`archivo_${t+1}`),a.url||(a.path?a.url=a.path:a.ruta?a.url=a.ruta:a.location?a.url=a.location:a.filename&&(a.url=`./imagenes/${a.filename}`)),a.size||(a.size=a.sizeBytes||a.tamano||a.originalSize||0),"image"===a.type&&void 0===a.isFileSystem&&"string"==typeof a.url){(a.url.startsWith("./")||a.url.startsWith("imagenes/")||a.url.startsWith("/imagenes/"))&&(a.isFileSystem=!0)}return a}async getImageUrl(e){if(!e)return null;if("string"==typeof e)return e.startsWith("data:image")?e:e.startsWith("img_")&&"indexeddb"===this.storageMode||e.startsWith("./imagenes/")||e.startsWith("imagenes/")?await this.loadImageFromFileSystem(e):e;if("image"===e.type&&e.url)return!0===e.isFileSystem||e.isIndexedDB&&e.url.startsWith("img_")||e.url.startsWith("./imagenes/")||e.url.startsWith("imagenes/")||e.url.startsWith("/imagenes/")?await this.loadImageFromFileSystem(e.url):e.url;if(e.tipo&&e.url){const t="string"==typeof e.tipo?e.tipo.toLowerCase():"";if(["imagen","image","img","foto"].includes(t))return e.esArchivoExterno,e.url}return null}async loadImageFromFileSystem(e){if(e.startsWith("data:image"))return e;if(e.startsWith("img_")&&"indexeddb"===this.storageMode)try{const t=await i.getImage(e);if(t&&t.url)return t.url}catch(t){return null}if(!n.isFileSystemMode||!n.imagesFolder){return e.startsWith("./")?e:e.startsWith("/")?`.${e}`:e.startsWith("imagenes/")?`./${e}`:e}try{let t=e.replace("./","").replace(/^imagenes\//,"");if(t.includes("/")){const e=t.split("/");t=e[e.length-1]}return await async function(e,t){if(s.has(e))return s.get(e).url;const a=await t();return a&&s.set(e,{url:a,timestamp:Date.now(),filename:e}),a}(t,async()=>{const e=await n.imagesFolder.getFileHandle(t),a=await e.getFile();return URL.createObjectURL(a)})}catch(t){return null}}getPlaceholderImage(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAACWCAYAAACb3McZAAAACXBIWXMAAAsTAAALEwEAmpwYAAADGklEQVR4nO3dy0pDQRRF0ZOI///L4sPIQNAY86h0n7X2gDvJoKu7TqeqngEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgP/q9cV7AK7w+uXlbYwxvr5/f/sewKV+hOPx+Ph8fHwc3wW40I9wjDHG4/Fx8R7Ahb6F4/n5+eE9gAt9C8cY4+49gAt9D8er9wAu9CMcz+N1eA/gQj/CMcZr8x7AhSYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgFv6AyRmU3vlastLAAAAAElFTkSuQmCC"}async getFirstImage(e){if(!e||!Array.isArray(e)||0===e.length)return this.getPlaceholderImage();for(const t of e){const e=await this.getImageUrl(t);if(e)return e}return this.getPlaceholderImage()}loadCustomSistemas(){try{const e=localStorage.getItem("inventarioCustomSistemas");return e?JSON.parse(e):{}}catch(e){return{}}}saveCustomSistemas(){try{localStorage.setItem("inventarioCustomSistemas",JSON.stringify(this.customSistemas))}catch(e){this.showAlert("Error al guardar sistemas personalizados","error")}}addCustomSistema(e,t){if(!e||!t||""===t.trim())return;this.customSistemas[e]||(this.customSistemas[e]=[]);const a=t.trim();return!(this.sistemaPorEquipo[e]||this.sistemaPorEquipo.default).includes(a)&&!this.customSistemas[e].includes(a)&&(this.customSistemas[e].push(a),this.saveCustomSistemas(),!0)}deleteCustomSistema(e,t){if(!this.customSistemas[e])return!1;const a=this.customSistemas[e].indexOf(t);return a>-1&&(this.customSistemas[e].splice(a,1),0===this.customSistemas[e].length&&delete this.customSistemas[e],this.saveCustomSistemas(),!0)}editCustomSistema(e,t,a){if(!this.customSistemas[e]||!a||""===a.trim())return!1;const n=this.customSistemas[e].indexOf(t);if(n>-1){const t=a.trim();return(this.sistemaPorEquipo[e]||this.sistemaPorEquipo.default).includes(t)||this.customSistemas[e].includes(t)?(this.showAlert("Este sistema ya existe","warning"),!1):(this.customSistemas[e][n]=t,this.saveCustomSistemas(),!0)}return!1}loadOpcionesPersonalizadas(){try{const e=localStorage.getItem("inventarioOpcionesJerarquia");e?this.opcionesJerarquia=JSON.parse(e):(this.opcionesJerarquia=JSON.parse(JSON.stringify(this.opcionesJerarquiaPredefinidas)),this.saveOpcionesPersonalizadas({reason:"bootstrap-opciones",meta:{origen:"loadOpcionesPersonalizadas"}}))}catch(e){this.opcionesJerarquia=JSON.parse(JSON.stringify(this.opcionesJerarquiaPredefinidas))}}saveOpcionesPersonalizadas(e={}){try{const t={};Object.keys(this.opcionesJerarquia).forEach(e=>{t[e]=[...this.opcionesJerarquia[e]]}),localStorage.setItem("inventarioOpcionesJerarquia",JSON.stringify(t));const a={scope:"opcionesJerarquia",...e,catalogs:this.opcionesJerarquia};a.reason||(a.reason="save"),this.emitAppEvent("jerarquia:catalogs-updated",a)}catch(t){}}loadJerarquiaAnidada(){try{const e=localStorage.getItem("inventarioJerarquiaAnidada"),t=e?null:localStorage.getItem("jerarquiaAnidada");if(e||t){const a=e||t;this.jerarquiaAnidada=JSON.parse(a),this.jerarquiaAnidada.plantas&&!this.jerarquiaAnidada.areas&&(this.jerarquiaAnidada.areas=this.jerarquiaAnidada.plantas,delete this.jerarquiaAnidada.plantas,this.saveJerarquiaAnidada({reason:"migracion-plantas",meta:{origen:"legacy-planta"}})),e||this.saveJerarquiaAnidada({reason:"sincronizacion-legado",meta:{origen:"legacy-sync"}})}else this.jerarquiaAnidada=this.crearEstructuraJerarquicaBase(),this.saveJerarquiaAnidada({reason:"crear-estructura-base",meta:{origen:"init"}})}catch(e){this.jerarquiaAnidada=this.crearEstructuraJerarquicaBase()}}crearEstructuraJerarquicaBase(){return{empresa:{nombre:"Aquachile Antarfood Chonchi",id:"empresa_principal"},areas:[{id:"area_planta_principal",nombre:"Planta Principal",subAreas:[{id:"eviscerado",nombre:"Eviscerado",sistemas:[{id:"grader",nombre:"Grader",subSistemas:[{id:"cinta_larga_grader",nombre:"Cinta Larga Grader",secciones:[{id:"sistema_electrico",nombre:"Sistema Elctrico",subSecciones:[{id:"panel_control",nombre:"Panel de Control"},{id:"cableado",nombre:"Cableado"}]},{id:"sistema_mecanico",nombre:"Sistema Mecnico",subSecciones:[{id:"rodamientos",nombre:"Rodamientos"},{id:"correa",nombre:"Correa"}]}]},{id:"motor_principal",nombre:"Motor Principal",secciones:[{id:"alimentacion_electrica",nombre:"Alimentacin Elctrica",subSecciones:[]}]}]}]},{id:"filete",nombre:"Filete",sistemas:[]}]},{id:"acopio",nombre:"Acopio",subAreas:[]}]}}emitAppEvent(e,t={}){if(!e||!window.appEvents||"function"!=typeof window.appEvents.emit)return;const a={source:"inventario",...t};"timestamp"in a||(a.timestamp=Date.now());try{window.appEvents.emit(e,a)}catch(n){}}saveJerarquiaAnidada(e={}){try{localStorage.setItem("inventarioJerarquiaAnidada",JSON.stringify(this.jerarquiaAnidada)),localStorage.setItem("jerarquiaAnidada",JSON.stringify(this.jerarquiaAnidada));const t={scope:"jerarquiaAnidada",...e,jerarquia:this.jerarquiaAnidada};t.reason||(t.reason="save"),this.emitAppEvent("jerarquia:structure-updated",t)}catch(t){}}aprenderNuevaOpcion(e,t){if(!e||!t||""===t.trim())return!1;if(!this.opcionesJerarquia[e])return!1;const a=t.trim();return!this.opcionesJerarquia[e].includes(a)&&(this.opcionesJerarquia[e].push(a),this.saveOpcionesPersonalizadas({reason:"aprender-opcion",meta:{nivel:e,valor:a}}),"configuracion"===this.currentTab&&this.renderListasGestion(),!0)}eliminarOpcionJerarquia(e,t){if(!this.opcionesJerarquia[e])return!1;const a=this.opcionesJerarquia[e].indexOf(t);return a>-1&&(this.opcionesJerarquia[e].splice(a,1),this.saveOpcionesPersonalizadas({reason:"eliminar-opcion",meta:{nivel:e,valor:t}}),this.limpiarOpcionDeRepuestos(e,t),!0)}limpiarOpcionDeRepuestos(e,t){let a=0;this.repuestos.forEach(n=>{n.ubicaciones&&Array.isArray(n.ubicaciones)&&n.ubicaciones.forEach(n=>{n[e]===t&&(n[e]="",a++)})}),a>0&&(this.guardarDatos(),this.showAlert(`Se elimin "${t}" de ${a} ubicacin(es)`,"success"))}agregarOpcionJerarquia(e,t){if(!e||!t||""===t.trim())return this.showToast(" Debes ingresar un valor","warning"),!1;this.opcionesJerarquia[e]||(this.opcionesJerarquia[e]=[]);const a=t.trim();return this.opcionesJerarquia[e].includes(a)?(this.showToast(" Esta opcin ya existe","warning"),!1):(this.opcionesJerarquia[e].push(a),this.opcionesJerarquia[e].sort(),this.saveOpcionesPersonalizadas({reason:"agregar-opcion",meta:{nivel:e,valor:a}}),this.showToast(` "${a}" agregado correctamente`,"success"),!0)}toggleNivelesConfig(){const e=document.getElementById("nivelesConfigPanel");"none"===e.style.display?(e.style.display="block",this.renderNivelesConfig()):e.style.display="none"}renderNivelesConfig(){const e=document.getElementById("nivelesCheckboxes");if(!e)return;let t="";this.jerarquiaNiveles.forEach((e,a)=>{"planta"!==e.id&&"areaGeneral"!==e.id&&(t+=`\n        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-primary); border-radius: 6px; cursor: pointer; border: 2px solid ${e.visible?"var(--success)":"var(--border-color)"};">\n          <input type="checkbox" \n                 ${e.visible?"checked":""}\n                 onchange="app.toggleNivelVisibilidad('${e.id}', this.checked)"\n                 style="cursor: pointer;">\n          <span style="font-weight: 600; font-size: 0.85rem;">${a+1}. ${e.nombre}</span>\n        </label>\n      `)}),e.innerHTML=t}toggleNivelVisibilidad(e,t){const a=this.jerarquiaNiveles.find(t=>t.id===e);a&&(a.visible=t,this.renderNivelesDinamicos(),this.updateJerarquiaPreview())}renderNivelesDinamicos(){const e=document.getElementById("nivelesDinamicosContainer");if(!e)return;let t="",a=3;this.jerarquiaNiveles.forEach(e=>{"planta"!==e.id&&"areaGeneral"!==e.id&&(t+=`\n        <div class="form-group" style="opacity: ${e.visible?"1":"0.5"};">\n          <label style="display: flex; align-items: center; gap: 8px;">\n            <input type="checkbox" \n                   ${e.visible?"checked":""}\n                   onchange="app.toggleNivelVisibilidad('${e.id}', this.checked)"\n                   style="width: 18px; height: 18px; cursor: pointer;">\n            <span style="font-weight: 700; color: var(--primary); min-width: 20px;">${a}.</span>\n            <span style="flex: 1;">${e.nombre}:</span>\n            ${e.requerido?'<span style="background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700;">OBLIGATORIO</span>':'<span style="background: var(--text-secondary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem;">Opcional</span>'}\n          </label>\n          <input type="text" \n                 class="form-control nivel-input" \n                 id="nivel_${e.id}" \n                 data-nivel="${e.id}"\n                 ${e.requerido?"required":""}\n                 ${e.visible?"":"disabled"}\n                 placeholder="Ej: ${this.getPlaceholderParaNivel(e.id)}"\n                 onchange="app.updateJerarquiaPreview()"\n                 style="margin-left: 26px;">\n        </div>\n      `,a++)}),e.innerHTML=t}getPlaceholderParaNivel(e){return{subArea:"Zona Norte, Piso 1, Sector A",sistemaEquipo:"Grader, Compresor 01, Bomba Principal",subSistema:"Pocket 1, Motor Principal, Cinta Z",seccion:"Sistema Hidrulico, Panel Elctrico, Controles",detalle:"Lado Izquierdo, Bastidor Superior, Vlvula V3"}[e]||"Ingrese valor"}updateJerarquiaPreview(){const e=document.getElementById("jerarquiaPreviewText");if(!e)return;const t=[];t.push(this.plantaBase),this.jerarquiaNiveles.forEach(e=>{if("planta"===e.id)return;const a=document.getElementById(`nivel_${e.id}`);a&&""!==a.value.trim()&&t.push(a.value.trim())}),t.length>0?e.innerHTML=t.map(e=>`<span style="font-weight: 600;">${e}</span>`).join(' <span style="color: var(--success); font-weight: bold;"></span> '):e.innerHTML='<span style="color: var(--text-secondary); font-style: italic;">Complete los campos para ver la ruta</span>'}generarUbicacionResumida(e){if(e.ubicaciones&&Array.isArray(e.ubicaciones)&&e.ubicaciones.length>0)return e.ubicaciones.map(e=>{const t=[];return e.areaGeneral&&t.push(e.areaGeneral),e.sistemaEquipo&&t.push(e.sistemaEquipo),e.subSistema&&t.push(e.subSistema),t.length>0?t.join("  "):"Sin detalles"}).join(' <span style="color: var(--warning);">|</span> ');const t=[],a=e.areaGeneral||e.area||"";a&&t.push(a);const n=e.sistemaEquipo||e.equipo||"";n&&t.push(n);const i=e.subSistema||e.sistema||"";return i&&t.push(i),0===t.length?'<em style="color: var(--text-secondary);">Sin ubicacin</em>':t.join("  ")}agregarUbicacion(){const e={id:Date.now(),areaGeneral:"",subArea:"",sistemaEquipo:"",subSistema:"",seccion:"",detalle:""};this.ubicacionesActuales.push(e),this.usarVersionCascada?this.renderUbicacionesCascada():this.renderUbicaciones()}eliminarUbicacion(e){this.ubicacionesActuales=this.ubicacionesActuales.filter(t=>t.id!==e),this.usarVersionCascada?this.renderUbicacionesCascada():this.renderUbicaciones()}renderUbicacionesCascada(){const e=document.getElementById("ubicacionesContainer");if(!e)return;if(e.classList.add("sap-ubicaciones-grid"),0===this.ubicacionesActuales.length)return void this.agregarUbicacion();const t=this.ubicacionesActuales.map((e,t)=>`\n      <section class="sap-ubicacion-card">\n        <div class="sap-ubicacion-card-header">\n          <div class="sap-ubicacion-card-title">\n            <span class="sap-ubicacion-index">${t+1}</span>\n            <span>Ubicacin ${t+1}</span>\n          </div>\n          ${this.ubicacionesActuales.length>1?`\n            <button type="button" onclick="app.eliminarUbicacion(${e.id})" class="btn sap-btn-remove btn-sm">\n              Eliminar\n            </button>\n          `:""}\n        </div>\n\n        <div class="sap-ubicacion-body">\n          <div class="form-group sap-field-group">\n            <label class="sap-step-label">\n              <span class="sap-step-number">1</span>\n              <span>Empresa</span>\n            </label>\n            <input type="text" class="form-control" value="Aquachile Antarfood Chonchi" readonly>\n          </div>\n\n          <div class="form-group sap-field-group">\n            <label class="sap-step-label">\n              <span class="sap-step-number">2</span>\n              <span>rea General: *</span>\n            </label>\n            <select class="form-control ubicacion-select-cascada"\n                    data-ubicacion-id="${e.id}"\n                    data-field="areaGeneral"\n                    data-nivel="area">\n              <option value="">-- Seleccionar rea --</option>\n            </select>\n          </div>\n\n          <div class="form-group sap-field-group">\n            <label class="sap-step-label">\n              <span class="sap-step-number">3</span>\n              <span>Sub-rea</span>\n            </label>\n            <select class="form-control ubicacion-select-cascada"\n                    data-ubicacion-id="${e.id}"\n                    data-field="subArea"\n                    data-nivel="subArea"\n                    disabled>\n              <option value="">-- Primero selecciona rea --</option>\n            </select>\n          </div>\n\n          <div class="form-group sap-field-group">\n            <label class="sap-step-label">\n              <span class="sap-step-number">4</span>\n              <span>Sistema/Equipo</span>\n            </label>\n            <select class="form-control ubicacion-select-cascada"\n                    data-ubicacion-id="${e.id}"\n                    data-field="sistemaEquipo"\n                    data-nivel="sistema"\n                    disabled>\n              <option value="">-- Primero selecciona Sub-rea --</option>\n            </select>\n          </div>\n\n          <div class="form-group sap-field-group">\n            <label class="sap-step-label">\n              <span class="sap-step-number">5</span>\n              <span>Sub-Sistema</span>\n            </label>\n            <select class="form-control ubicacion-select-cascada"\n                    data-ubicacion-id="${e.id}"\n                    data-field="subSistema"\n                    data-nivel="subSistema"\n                    disabled>\n              <option value="">-- Primero selecciona Sistema --</option>\n            </select>\n          </div>\n\n          <div class="form-group sap-field-group">\n            <label class="sap-step-label">\n              <span class="sap-step-number">6</span>\n              <span>Seccin</span>\n            </label>\n            <select class="form-control ubicacion-select-cascada"\n                    data-ubicacion-id="${e.id}"\n                    data-field="seccion"\n                    data-nivel="seccion"\n                    disabled>\n              <option value="">-- Primero selecciona Sub-Sistema --</option>\n            </select>\n          </div>\n\n          <div class="form-group sap-field-group">\n            <label class="sap-step-label">\n              <span class="sap-step-number">7</span>\n              <span>Sub-Seccin</span>\n            </label>\n            <select class="form-control ubicacion-select-cascada"\n                    data-ubicacion-id="${e.id}"\n                    data-field="subSeccion"\n                    data-nivel="subSeccion"\n                    disabled>\n              <option value="">-- Primero selecciona Seccin --</option>\n            </select>\n          </div>\n\n          <div class="form-group sap-field-group">\n            <label class="sap-step-label">\n              <span class="sap-step-number">8</span>\n              <span>Detalle / Ubicacin especfica</span>\n            </label>\n            <input type="text"\n                   class="form-control ubicacion-input"\n                   data-ubicacion-id="${e.id}"\n                   data-field="detalle"\n                   value="${e.detalle||""}"\n                   placeholder="Ej: Lado izquierdo, Estante 2 Nivel 3, Bastidor superior">\n            <small class="sap-step-hint"> Campo libre para precisar la ubicacin exacta en terreno.</small>\n          </div>\n        </div>\n      </section>\n    `).join("");e.innerHTML=t,this.inicializarSelectsCascada(),this.configurarListenersCascada(),document.querySelectorAll(".ubicacion-input").forEach(e=>{e.addEventListener("input",e=>{const t=parseInt(e.target.dataset.ubicacionId),a=e.target.dataset.field,n=this.ubicacionesActuales.find(e=>e.id===t);n&&(n[a]=e.target.value)})}),this.actualizarIndicadorVersion()}inicializarSelectsCascada(){this.ubicacionesActuales.forEach(e=>{this.cargarOpcionesSelect(e.id,"area",{}),e.areaGeneral&&this.cargarOpcionesSelect(e.id,"subArea",{area:e.areaGeneral}),e.areaGeneral&&e.subArea&&this.cargarOpcionesSelect(e.id,"sistema",{area:e.areaGeneral,subArea:e.subArea}),e.areaGeneral&&e.subArea&&e.sistemaEquipo&&this.cargarOpcionesSelect(e.id,"subSistema",{area:e.areaGeneral,subArea:e.subArea,sistema:e.sistemaEquipo}),e.areaGeneral&&e.subArea&&e.sistemaEquipo&&e.subSistema&&this.cargarOpcionesSelect(e.id,"seccion",{area:e.areaGeneral,subArea:e.subArea,sistema:e.sistemaEquipo,subSistema:e.subSistema}),e.areaGeneral&&e.subArea&&e.sistemaEquipo&&e.subSistema&&e.seccion&&this.cargarOpcionesSelect(e.id,"subSeccion",{area:e.areaGeneral,subArea:e.subArea,sistema:e.sistemaEquipo,subSistema:e.subSistema,seccion:e.seccion})})}cargarOpcionesSelect(e,t,a){const n=document.querySelector(`select[data-ubicacion-id="${e}"][data-nivel="${t}"]`);if(!n)return;const i=this.getOpcionesJerarquicasCascada(t,a),s=this.ubicacionesActuales.find(t=>t.id===e),r=s?s[n.dataset.field]:"";let o=`<option value="">-- Seleccionar ${this.getNombreNivel(t)} --</option>`;i.forEach(e=>{o+=`<option value="${e}" ${e===r?"selected":""}>${e}</option>`}),n.innerHTML=o,n.disabled=0===i.length}getNombreNivel(e){return{area:"rea",subArea:"Sub-rea",sistema:"Sistema",subSistema:"Sub-Sistema",seccion:"Seccin",subSeccion:"Sub-Seccin"}[e]||e}configurarListenersCascada(){document.querySelectorAll(".ubicacion-select-cascada").forEach(e=>{e.addEventListener("change",e=>{const t=parseInt(e.target.dataset.ubicacionId),a=e.target.dataset.field,n=e.target.dataset.nivel,i=e.target.value,s=this.ubicacionesActuales.find(e=>e.id===t);s&&(s[a]=i,this.resetearNivelesInferiores(s,n),this.actualizarSiguienteNivel(t,n,s))})})}resetearNivelesInferiores(e,t){const a=["area","subArea","sistema","subSistema","seccion","subSeccion"],n=a.indexOf(t);if(-1===n)return;const i={area:"areaGeneral",subArea:"subArea",sistema:"sistemaEquipo",subSistema:"subSistema",seccion:"seccion",subSeccion:"subSeccion"};for(let s=n+1;s<a.length;s++){const t=i[a[s]];t&&e[t]&&(e[t]="")}}actualizarSiguienteNivel(e,t,a){const n={area:"subArea",subArea:"sistema",sistema:"subSistema",subSistema:"seccion",seccion:"subSeccion"}[t];if(!n)return;const i={};a.areaGeneral&&(i.area=a.areaGeneral),a.subArea&&(i.subArea=a.subArea),a.sistemaEquipo&&(i.sistema=a.sistemaEquipo),a.subSistema&&(i.subSistema=a.subSistema),a.seccion&&(i.seccion=a.seccion),this.cargarOpcionesSelect(e,n,i);const s=document.querySelector(`select[data-ubicacion-id="${e}"][data-nivel="${n}"]`);s&&(s.disabled=!1)}renderUbicaciones(){const e=document.getElementById("ubicacionesContainer");if(!e)return;if(e.classList.remove("sap-ubicaciones-grid"),0===this.ubicacionesActuales.length)return void this.agregarUbicacion();let t=`<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(${this.ubicacionesActuales.length<=2?"350px":"320px"}, 1fr)); gap: 16px;">`;this.ubicacionesActuales.forEach((e,a)=>{t+=`\n        <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; border: 2px solid var(--border-color);">\n          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">\n            <h5 style="margin: 0; color: var(--text-primary); font-size: 0.95rem; font-weight: 600;">\n              Ubicacin ${a+1}\n            </h5>\n            ${this.ubicacionesActuales.length>1?`\n              <button type="button" onclick="app.eliminarUbicacion(${e.id})" class="btn btn-danger" style="padding: 4px 10px; font-size: 0.75rem;">\n                Eliminar\n              </button>\n            `:""}\n          </div>\n          \n          \x3c!-- Nivel 1: Empresa (fijo) --\x3e\n          <div class="form-group" style="margin-bottom: 10px;">\n            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">\n              <span style="font-weight: 700; color: var(--primary);">1.</span>\n              <span>Empresa:</span>\n            </label>\n            <input type="text" class="form-control" value="Aquachile Antarfood Chonchi" readonly style="background: var(--bg-secondary); cursor: not-allowed; font-size: 0.85rem;">\n          </div>\n          \n          \x3c!-- Nivel 2: rea General --\x3e\n          <div class="form-group" style="margin-bottom: 10px;">\n            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">\n              <span style="font-weight: 700; color: var(--primary);">2.</span>\n              <span>rea General: *</span>\n            </label>\n            <input type="text" \n                   class="form-control ubicacion-input" \n                   data-ubicacion-id="${e.id}"\n                   data-field="areaGeneral"\n                   value="${e.areaGeneral}"\n                   list="areaGeneralList-${e.id}"\n                   placeholder="Ej: Planta Principal, Acopio"\n                   style="font-size: 0.85rem;">\n            <datalist id="areaGeneralList-${e.id}">\n              ${this.opcionesJerarquia.areaGeneral.map(e=>`<option value="${e}">`).join("")}\n            </datalist>\n          </div>\n          \n          \x3c!-- Nivel 3: Sub-rea --\x3e\n          <div class="form-group" style="margin-bottom: 10px;">\n            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">\n              <span style="font-weight: 700; color: var(--primary);">3.</span>\n              <span>Sub-rea:</span>\n            </label>\n            <input type="text" \n                   class="form-control ubicacion-input" \n                   data-ubicacion-id="${e.id}"\n                   data-field="subArea"\n                   value="${e.subArea}"\n                   list="subAreaList-${e.id}"\n                   placeholder="Ej: Zona Norte, Piso 1"\n                   style="font-size: 0.85rem;">\n            <datalist id="subAreaList-${e.id}">\n              ${this.opcionesJerarquia.subArea.map(e=>`<option value="${e}">`).join("")}\n            </datalist>\n          </div>\n          \n          \x3c!-- Nivel 4: Sistema/Equipo --\x3e\n          <div class="form-group" style="margin-bottom: 10px;">\n            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">\n              <span style="font-weight: 700; color: var(--primary);">4.</span>\n              <span>Sistema/Equipo:</span>\n            </label>\n            <input type="text" \n                   class="form-control ubicacion-input" \n                   data-ubicacion-id="${e.id}"\n                   data-field="sistemaEquipo"\n                   value="${e.sistemaEquipo}"\n                   list="sistemaEquipoList-${e.id}"\n                   placeholder="Ej: Grader Marel, Compresor 01"\n                   style="font-size: 0.85rem;">\n            <datalist id="sistemaEquipoList-${e.id}">\n              ${this.opcionesJerarquia.sistemaEquipo.map(e=>`<option value="${e}">`).join("")}\n            </datalist>\n          </div>\n          \n          \x3c!-- Nivel 5: Sub-Sistema --\x3e\n          <div class="form-group" style="margin-bottom: 10px;">\n            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">\n              <span style="font-weight: 700; color: var(--primary);">5.</span>\n              <span>Sub-Sistema:</span>\n            </label>\n            <input type="text" \n                   class="form-control ubicacion-input" \n                   data-ubicacion-id="${e.id}"\n                   data-field="subSistema"\n                   value="${e.subSistema}"\n                   list="subSistemaList-${e.id}"\n                   placeholder="Ej: Pocket 1, Motor Principal"\n                   style="font-size: 0.85rem;">\n            <datalist id="subSistemaList-${e.id}">\n              ${this.opcionesJerarquia.subSistema.map(e=>`<option value="${e}">`).join("")}\n            </datalist>\n          </div>\n          \n          \x3c!-- Nivel 6: Seccin --\x3e\n          <div class="form-group" style="margin-bottom: 10px;">\n            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">\n              <span style="font-weight: 700; color: var(--primary);">6.</span>\n              <span>Seccin:</span>\n            </label>\n            <input type="text" \n                   class="form-control ubicacion-input" \n                   data-ubicacion-id="${e.id}"\n                   data-field="seccion"\n                   value="${e.seccion}"\n                   list="seccionList-${e.id}"\n                   placeholder="Ej: Sistema Hidrulico, Panel Elctrico"\n                   style="font-size: 0.85rem;">\n            <datalist id="seccionList-${e.id}">\n              ${this.opcionesJerarquia.seccion.map(e=>`<option value="${e}">`).join("")}\n            </datalist>\n          </div>\n          \n          \x3c!-- Nivel 7: Detalle --\x3e\n          <div class="form-group" style="margin-bottom: 0;">\n            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">\n              <span style="font-weight: 700; color: var(--primary);">7.</span>\n              <span>Detalle / Ubicacin Especfica:</span>\n            </label>\n            <input type="text" \n                   class="form-control ubicacion-input" \n                   data-ubicacion-id="${e.id}"\n                   data-field="detalle"\n                   value="${e.detalle}"\n                   placeholder="Ej: Lado Izquierdo, Estante 2 Nivel 3, Bastidor Superior"\n                   style="font-size: 0.85rem;">\n            <small style="color: var(--text-secondary); font-size: 0.7rem; display: block; margin-top: 4px;">\n               Campo de texto libre para referencia exacta de ubicacin\n            </small>\n          </div>\n        </div>\n      `}),t+="</div>",e.innerHTML=t,document.querySelectorAll(".ubicacion-input").forEach(e=>{e.addEventListener("input",e=>{const t=parseInt(e.target.dataset.ubicacionId),a=e.target.dataset.field,n=this.ubicacionesActuales.find(e=>e.id===t);n&&(n[a]=e.target.value)})}),this.actualizarIndicadorVersion(),this.ajustarAnchoModal()}actualizarIndicadorVersion(){}ajustarAnchoModal(){const e=document.querySelector(".modal-content");if(!e)return;const t=window.innerWidth;if(e.style.removeProperty("width"),e.style.removeProperty("max-width"),e.style.removeProperty("height"),e.style.removeProperty("max-height"),e.style.removeProperty("margin-top"),e.style.removeProperty("margin-bottom"),t<=768)return e.style.width="calc(100vw - 24px)",e.style.maxWidth="calc(100vw - 24px)",e.style.height="auto",e.style.maxHeight="calc(100vh - 40px)",e.style.marginTop="20px",void(e.style.marginBottom="20px");const a=Math.max(32,Math.round(.02*t)),n=Math.min(t-2*a,1200),i=Math.max(10,Math.round(.02*window.innerHeight)),s=Math.max(20,Math.round(.04*window.innerHeight));e.style.width=n+"px",e.style.maxWidth=n+"px",e.style.height="auto",e.style.maxHeight="92vh",e.style.marginTop=i+"px",e.style.marginBottom=s+"px"}getOpcionesJerarquicasCascada(e,t={}){if(!this.jerarquiaAnidada||!this.jerarquiaAnidada.areas)return[];const a=[];try{switch(e){case"area":this.jerarquiaAnidada.areas.forEach(e=>{e.nombre&&a.push(e.nombre)});break;case"subArea":if(!t.area)return[];const e=this.jerarquiaAnidada.areas.find(e=>e.nombre===t.area);e&&e.subAreas&&e.subAreas.forEach(e=>{e.nombre&&a.push(e.nombre)});break;case"sistema":if(!t.area||!t.subArea)return[];const n=this.jerarquiaAnidada.areas.find(e=>e.nombre===t.area);if(n&&n.subAreas){const e=n.subAreas.find(e=>e.nombre===t.subArea);e&&e.sistemas&&e.sistemas.forEach(e=>{e.nombre&&a.push(e.nombre)})}break;case"subSistema":if(!t.area||!t.subArea||!t.sistema)return[];const i=this.jerarquiaAnidada.areas.find(e=>e.nombre===t.area);if(i&&i.subAreas){const e=i.subAreas.find(e=>e.nombre===t.subArea);if(e&&e.sistemas){const n=e.sistemas.find(e=>e.nombre===t.sistema);n&&n.subSistemas&&n.subSistemas.forEach(e=>{e.nombre&&a.push(e.nombre)})}}break;case"seccion":if(!(t.area&&t.subArea&&t.sistema&&t.subSistema))return[];const s=this.jerarquiaAnidada.areas.find(e=>e.nombre===t.area);if(s&&s.subAreas){const e=s.subAreas.find(e=>e.nombre===t.subArea);if(e&&e.sistemas){const n=e.sistemas.find(e=>e.nombre===t.sistema);if(n&&n.subSistemas){const e=n.subSistemas.find(e=>e.nombre===t.subSistema);e&&e.secciones&&e.secciones.forEach(e=>{e.nombre&&a.push(e.nombre)})}}}break;case"subSeccion":if(!(t.area&&t.subArea&&t.sistema&&t.subSistema&&t.seccion))return[];const r=this.jerarquiaAnidada.areas.find(e=>e.nombre===t.area);if(r&&r.subAreas){const e=r.subAreas.find(e=>e.nombre===t.subArea);if(e&&e.sistemas){const n=e.sistemas.find(e=>e.nombre===t.sistema);if(n&&n.subSistemas){const e=n.subSistemas.find(e=>e.nombre===t.subSistema);if(e&&e.secciones){const n=e.secciones.find(e=>e.nombre===t.seccion);n&&n.subSecciones&&n.subSecciones.forEach(e=>{e.nombre&&a.push(e.nombre)})}}}}break;default:return[]}return a}catch(n){return[]}}mostrarEjemplosCategoria(e){const t=document.getElementById("ejemplosCategoria");if(!t)return;const a={Repuesto:"Ejemplos: filtros, rodamientos, vlvulas, correas, motores",Insumo:"Ejemplos: brochas, guantes, grasas, pinturas, cintas adhesivas",Herramienta:"Ejemplos: taladros, llaves, destornilladores, martillos",EPP:"Ejemplos: cascos, lentes, arneses, guantes de seguridad",Qumico:"Ejemplos: desengrasantes, cidos, solventes, desinfectantes"};e&&a[e]?(t.textContent=a[e],t.style.color="#7A9AB8"):(t.textContent="Selecciona una categora para ver ejemplos",t.style.color="#94a3b8")}mostrarJerarquia(e){const t=this.repuestos.find(t=>t.id===e);if(!t)return;let a=[];a=t.ubicaciones&&Array.isArray(t.ubicaciones)&&t.ubicaciones.length>0?t.ubicaciones:[{areaGeneral:t.areaGeneral||t.area,subArea:t.subArea,sistemaEquipo:t.sistemaEquipo||t.equipo,subSistema:t.subSistema||t.sistema,seccion:t.seccion,detalle:t.detalle||t.detalleUbicacion}];const n=t.planta||this.plantaBase,i=this.construirArbolJerarquia(a,n,t.nombre),s=`\n      <div style="width: 90vw; max-width: 1400px; max-height: 85vh; background: var(--card-bg); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">\n        \n        \x3c!-- Header --\x3e\n        <div style="padding: 20px 24px; background: var(--primary); border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;">\n          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">\n            <h3 style="margin: 0; color: #ffffff; font-size: 1.3rem; font-weight: 600;">\n               Ubicacin del Repuesto\n            </h3>\n            <button onclick="app.closeCustomModal()" \n                    style="background: rgba(255,255,255,0.15); border: none; color: white; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 18px; transition: all 0.2s;"\n                    onmouseover="this.style.background='rgba(255,255,255,0.25)'"\n                    onmouseout="this.style.background='rgba(255,255,255,0.15)'"></button>\n          </div>\n          <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">\n            <div style="font-size: 0.9rem; font-weight: 600; color: #ffffff;">${t.nombre}</div>\n            ${t.codSAP?`<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">SAP: ${t.codSAP}</div>`:""}\n            <div style="margin-left: auto; font-size: 0.7rem; color: rgba(255,255,255,0.75); background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 12px; font-weight: 500;">\n              ${a.length} ${1===a.length?"Ubicacin":"Ubicaciones"}\n            </div>\n          </div>\n        </div>\n        \n        \x3c!-- rea del rbol con scroll --\x3e\n        <div style="flex: 1; overflow: auto; background: var(--bg-secondary); padding: 20px;">\n          ${i}\n        </div>\n        \n        \x3c!-- Footer --\x3e\n        <div style="padding: 14px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border); flex-shrink: 0; display: flex; justify-content: center;">\n          <button onclick="app.closeCustomModal()" \n                  style="padding: 12px 48px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.2s;"\n                  onmouseover="this.style.opacity='0.9'"\n                  onmouseout="this.style.opacity='1'">\n            Cerrar\n          </button>\n        </div>\n        \n      </div>\n    `;this.showCustomModal(s)}construirArbolJerarquia(e,t,a){if(0===e.length)return'<div style="text-align: center; color: var(--text-secondary); padding: 40px; font-size: 0.95rem;">Sin ubicaciones registradas</div>';const n=this.construirNodosArbol(e,t,["areaGeneral","subArea","sistemaEquipo","subSistema","seccion","nombreRepuesto","detalle"],a);let i=0;const s=[],r=240,o=70,l=(e,t=0)=>{const a=110*t+50;if(e.hijos&&0!==e.hijos.length){const n=e.hijos.map(e=>l(e,t+1)),i=(Math.min(...n)+Math.max(...n))/2;return s.push({...e,x:i,y:a,nivel:t,posicionesHijos:n}),i}{const n=270*i+50;return s.push({...e,x:n,y:a,nivel:t}),i++,n}};n.forEach(e=>l(e));let d=`<svg width="${Math.max(...s.map(e=>e.x))+r+100}" height="${Math.max(...s.map(e=>e.y))+o+60}" style="font-family: system-ui, -apple-system, sans-serif; display: block; min-width: 100%;">`;d+='\n      <defs>\n        <filter id="sombra" x="-30%" y="-30%" width="160%" height="160%">\n          <feGaussianBlur in="SourceAlpha" stdDeviation="4"/>\n          <feOffset dx="0" dy="3" result="offsetblur"/>\n          <feComponentTransfer>\n            <feFuncA type="linear" slope="0.15"/>\n          </feComponentTransfer>\n          <feMerge>\n            <feMergeNode/>\n            <feMergeNode in="SourceGraphic"/>\n          </feMerge>\n        </filter>\n      </defs>\n    ',s.forEach(e=>{if(e.hijos&&e.hijos.length>0){const t=e.x+120,a=e.y+o;e.hijos.forEach((n,i)=>{const r=s.find(t=>t.valor===n.valor&&t.nivel===e.nivel+1);if(r){const n=r.x+120,o=r.y,l=a+25;if(d+=`<line x1="${t}" y1="${a}" x2="${t}" y2="${l}" stroke="#94a3b8" stroke-width="2" opacity="0.6"/>`,e.hijos.length>1&&0===i){const t=s.find(t=>t.valor===e.hijos[e.hijos.length-1].valor&&t.nivel===e.nivel+1);if(t){const e=t.x+120;d+=`<line x1="${n}" y1="${l}" x2="${e}" y2="${l}" stroke="#94a3b8" stroke-width="2" opacity="0.6"/>`}}d+=`<line x1="${n}" y1="${l}" x2="${n}" y2="${o}" stroke="#94a3b8" stroke-width="2" opacity="0.6"/>`}})}});const c=[{fondo:"#C4A882",borde:"#A68F6D",texto:"#ffffff"},{fondo:"#6B8499",borde:"#5A7188",texto:"#ffffff"},{fondo:"#7D8A97",borde:"#6A7784",texto:"#ffffff"},{fondo:"#8897A8",borde:"#7586a7",texto:"#ffffff"},{fondo:"#939FAB",borde:"#808C98",texto:"#ffffff"},{fondo:"#A1B0BC",borde:"#8E9DA9",texto:"#ffffff"},{fondo:"#7FA396",borde:"#6C9083",texto:"#ffffff"},{fondo:"#6D9488",borde:"#5A8175",texto:"#ffffff"}];return s.forEach(e=>{const t=e.ubicaciones&&e.ubicaciones.length>0,a=c[e.nivel]||c[c.length-1];d+="<g>",d+=t?`<rect x="${e.x}" y="${e.y}" width="240" height="70" rx="8" \n                  fill="#6D9488" \n                  stroke="#5A8175" \n                  stroke-width="2.5"\n                  filter="url(#sombra)"/>`:`<rect x="${e.x}" y="${e.y}" width="240" height="70" rx="8" \n                  fill="${a.fondo}" \n                  stroke="${a.borde}" \n                  stroke-width="2"\n                  filter="url(#sombra)"/>`,e.etiqueta&&(d+=`<text x="${e.x+120}" y="${e.y+15}" \n                  text-anchor="middle" \n                  fill="rgba(255,255,255,0.65)" \n                  font-size="9" \n                  font-weight="600"\n                  letter-spacing="0.8"\n                  pointer-events="none">${e.etiqueta.toUpperCase()}</text>`);const n=this.dividirTextoEnLineas(e.valor,32),i=e.y+(1===n.length?41:33);n.forEach((t,a)=>{d+=`<text x="${e.x+120}" y="${i+17*a}" \n                  text-anchor="middle" \n                  dominant-baseline="middle" \n                  fill="#ffffff" \n                  font-size="13.5" \n                  font-weight="600"\n                  pointer-events="none">${t}</text>`}),t&&(d+=`<text x="${e.x+120}" y="${e.y+o-10}" \n                  text-anchor="middle" \n                  fill="rgba(255,255,255,0.9)" \n                  font-size="8.5" \n                  font-weight="700"\n                  letter-spacing="0.5"\n                  pointer-events="none"> UBICACIN ${e.ubicaciones.join(", ")}</text>`),d+="</g>"}),d+="</svg>",`<div style="width: 100%; height: 100%; overflow: auto; display: flex; align-items: center; justify-content: center;">${d}</div>`}dividirTextoEnLineas(e,t){if(e.length<=t)return[e];const a=e.split(" "),n=[];let i="";return a.forEach(e=>{(i+e).length<=t?i+=(i?" ":"")+e:(i&&n.push(i),i=e)}),i&&n.push(i),n.slice(0,3)}filtrarPorJerarquia(e,t){const a={planta:"planta",areaGeneral:"areaGeneral",subArea:"subArea",sistemaEquipo:"sistemaEquipo",subSistema:"subSistema",seccion:"seccion",detalle:"detalle"}[e]||e,n=this.repuestos.filter(e=>e.ubicaciones&&Array.isArray(e.ubicaciones)?e.ubicaciones.some(e=>e[a]===t):e[a]===t);this.mostrarResultadosFiltro(e,t,n)}mostrarResultadosFiltro(e,t,a){let n=`\n      <div style="padding: clamp(20px, 3vw, 32px); background: var(--card-bg); border-radius: 16px; width: 95vw; max-width: 1800px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">\n        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 16px; flex-shrink: 0; flex-wrap: wrap; gap: 12px;">\n          <div>\n            <h3 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: clamp(1.1rem, 2vw, 1.4rem); font-weight: 600;">\n              Repuestos en ${{planta:"Empresa",areaGeneral:"rea General",subArea:"Sub-rea",sistemaEquipo:"Sistema/Equipo",subSistema:"Sub-Sistema",seccion:"Seccin",detalle:"Detalle"}[e]||e}\n            </h3>\n            <div style="font-size: clamp(0.8rem, 1.5vw, 0.9rem); color: var(--text-secondary); font-weight: 500;">\n              "${t}"\n            </div>\n          </div>\n          <div style="display: flex; gap: 12px; align-items: center;">\n            <div style="font-size: 0.75rem; color: var(--text-secondary); background: var(--bg-secondary); padding: 6px 14px; border-radius: 20px; font-weight: 600;">\n              ${a.length} Repuesto${1!==a.length?"s":""}\n            </div>\n            <button onclick="app.closeCustomModal()" style="background: var(--bg-secondary); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; color: var(--text-primary); font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='var(--bg-secondary)'">\n              Cerrar\n            </button>\n          </div>\n        </div>\n        \n        <div style="flex: 1; overflow-y: auto; padding-right: 8px;">\n    `;0===a.length?n+='\n        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">\n          <div style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></div>\n          <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">No hay repuestos</div>\n          <div style="font-size: 0.9rem;">No se encontraron repuestos en esta ubicacin</div>\n        </div>\n      ':(n+='<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(min(300px, 100%), 1fr)); gap: 16px;">',a.forEach(e=>{let t=null;if(e.multimedia&&e.multimedia.length>0){const a=e.multimedia.find(e=>e.isFileSystem&&e.url);t=a?a.url:e.multimedia[0].url}n+=`\n          <div style="background: var(--bg-primary); border: 2px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; cursor: pointer;" \n               onclick="app.editRepuesto('${e.id}')"\n               onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'"\n               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">\n            \n            ${t?`\n              <div style="height: 180px; background: var(--bg-secondary); position: relative; overflow: hidden;">\n                <img src="${t}" \n                     style="width: 100%; height: 100%; object-fit: cover;" \n                     onerror="this.parentElement.innerHTML='<div style=\\'height: 180px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 3rem; opacity: 0.3;\\'></div>'">\n              </div>\n            `:'\n              <div style="height: 180px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 3rem; opacity: 0.3;">\n                \n              </div>\n            '}\n            \n            <div style="padding: 16px;">\n              <div style="font-weight: 600; font-size: 1rem; color: var(--text-primary); margin-bottom: 8px; line-height: 1.3;">\n                ${e.nombre}\n              </div>\n              \n              ${e.codSAP?`\n                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">\n                  <span style="font-weight: 600;">SAP:</span> ${e.codSAP}\n                </div>\n              `:""}\n              \n              <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">\n                ${e.tipo?`<span style="font-size: 0.7rem; background: var(--bg-secondary); padding: 4px 8px; border-radius: 6px; color: var(--text-secondary); font-weight: 600;">${e.tipo}</span>`:""}\n                <span style="font-size: 0.7rem; background: ${e.cantidad>e.minimo?"#d1fae5":"#fee2e2"}; color: ${e.cantidad>e.minimo?"#065f46":"#991b1b"}; padding: 4px 8px; border-radius: 6px; font-weight: 600;">Stock: ${e.cantidad}</span>\n              </div>\n            </div>\n          </div>\n        `}),n+="</div>"),n+="\n        </div>\n      </div>\n    ",this.showCustomModal(n)}construirNodosArbol(e,t,a,n){const i={nivel:-1,campo:"planta",valor:t||"Aquachile Antarfood Chonchi",etiqueta:"Empresa",hijos:[],ubicaciones:[]},s={areaGeneral:"rea General",subArea:"Sub-rea",sistemaEquipo:"Sistema/Equipo",subSistema:"Sub-Sistema",seccion:"Seccin",nombreRepuesto:"Repuesto",detalle:"Detalle Ubicacin"};return e.forEach((e,t)=>{let r=i,o=null;a.forEach((t,a)=>{let i=e[t];if("nombreRepuesto"===t&&(i=n),!i||""===i.trim())return;let l=r.hijos.find(e=>e.campo===t&&e.valor===i);l||(l={nivel:a,campo:t,valor:i,etiqueta:s[t]||t,hijos:[],ubicaciones:[]},r.hijos.push(l)),o=l,r=l}),o&&o.ubicaciones.push(t+1)}),[i]}showCustomModal(e){let t=document.getElementById("customModalOverlay");t||(t=document.createElement("div"),t.id="customModalOverlay",t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.8);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 10000;\n        padding: 20px;\n      ",t.onclick=e=>{e.target===t&&this.closeCustomModal()},document.body.appendChild(t)),t.innerHTML=`\n      <div style="max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">\n        ${e}\n      </div>\n    `,t.style.display="flex",this.addEscapeListener()}closeCustomModal(){const e=document.getElementById("customModalOverlay");e&&(e.style.display="none"),this.removeEscapeListener()}addEscapeListener(){this.escapeHandler||(this.escapeHandler=e=>{if("Escape"===e.key){const e=document.getElementById("customModalOverlay");if(e&&"flex"===e.style.display)return void this.closeCustomModal();const t=document.getElementById("modal");if(t&&t.classList.contains("active"))return void this.closeModal()}}),document.addEventListener("keydown",this.escapeHandler)}removeEscapeListener(){this.escapeHandler&&document.removeEventListener("keydown",this.escapeHandler)}normalizarNombreCarpeta(e){return e&&""!==e.trim()?e.trim().toUpperCase().replace(/[]/gi,"A").replace(/[]/gi,"E").replace(/[]/gi,"I").replace(/[]/gi,"O").replace(/[]/gi,"U").replace(/[]/gi,"N").replace(/[^A-Z0-9\s_-]/g,"").replace(/\s+/g,"_").replace(/_+/g,"_").substring(0,50):"_SIN_NOMBRE"}generarNombreArchivo(e,t=0){return`${(e.codSAP||"SAP_PENDIENTE").replace(/[^a-zA-Z0-9_-]/g,"").substring(0,20)}_${e.nombre.toUpperCase().trim().replace(/[]/gi,"A").replace(/[]/gi,"E").replace(/[]/gi,"I").replace(/[]/gi,"O").replace(/[]/gi,"U").replace(/[]/gi,"N").replace(/[^A-Z0-9\s]/g,"").replace(/\s+/g,"_").substring(0,40)}_${Date.now()}${t>0?`_${t+1}`:""}.webp`}generarRutaImagen(e){const t=["imagenes"];return e.areaGeneral&&""!==e.areaGeneral.trim()?t.push(this.normalizarNombreCarpeta(e.areaGeneral)):t.push("_SIN_UBICACION"),this.nivelJerarquiaImagenes>=2&&e.sistemaEquipo&&""!==e.sistemaEquipo.trim()&&t.push(this.normalizarNombreCarpeta(e.sistemaEquipo)),this.nivelJerarquiaImagenes>=3&&e.subSistema&&""!==e.subSistema.trim()&&t.push(this.normalizarNombreCarpeta(e.subSistema)),"./"+t.join("/")}async crearCarpetasJerarquicas(e){if(!this.fsManager)throw new Error("FileSystemManager no est inicializado");if(!this.fsManager.rootFolder)throw new Error("Root folder no est disponible. Conectaste la carpeta?");try{let t=await this.fsManager.rootFolder.getDirectoryHandle("imagenes",{create:!0});const a=e.areaGeneral&&""!==e.areaGeneral.trim()?this.normalizarNombreCarpeta(e.areaGeneral):"_SIN_UBICACION";if(t=await t.getDirectoryHandle(a,{create:!0}),this.nivelJerarquiaImagenes>=2&&e.sistemaEquipo&&""!==e.sistemaEquipo.trim()){const a=this.normalizarNombreCarpeta(e.sistemaEquipo);t=await t.getDirectoryHandle(a,{create:!0})}if(this.nivelJerarquiaImagenes>=3&&e.subSistema&&""!==e.subSistema.trim()){const a=this.normalizarNombreCarpeta(e.subSistema);t=await t.getDirectoryHandle(a,{create:!0})}return t}catch(t){return await this.fsManager.rootFolder.getDirectoryHandle("imagenes",{create:!0})}}async navegarACarpeta(e){const t=e.replace("./","").split("/");let a=this.fsManager.rootFolder;for(const n of t)a=await a.getDirectoryHandle(n);return a}async limpiarCarpetasVacias(){try{const e=await this.fsManager.rootFolder.getDirectoryHandle("imagenes");for await(const[t,a]of e.entries()){if("directory"!==a.kind)continue;let n=!1;const i=await e.getDirectoryHandle(t);for await(const e of i.values())if("file"===e.kind){n=!0;break}n||await e.removeEntry(t,{recursive:!0})}}catch(e){}}async moverImagenSiCambiaUbicacion(e,t,a){if(!n||!n.isFileSystemMode)return;if(!t||!a)return;if(0===t.length||0===a.length)return;const i=t[0],s=a[0];if(this.normalizarNombreCarpeta(i.areaGeneral||"")===this.normalizarNombreCarpeta(s.areaGeneral||""))return;let r=0;for(const n of e.multimedia||[])if("image"===n.type&&n.isFileSystem)try{const e=n.url.split("/").pop(),t=this.generarRutaImagen(i),a=await this.navegarACarpeta(t),o=await a.getFileHandle(e),l=await o.getFile(),d=await this.crearCarpetasJerarquicas(s);if(await this.fsManager.saveImageJerarquica(l,e,d)){const t=this.generarRutaImagen(s);n.url=`${t}/${e}`,this.eliminarImagenAntiguaAlMover&&await a.removeEntry(e),r++}}catch(o){}r>0&&(this.showToast(` ${r} imagen(es) movida(s) a nueva ubicacin`,"success"),await this.limpiarCarpetasVacias())}async connectWorkspace(e=!1,t=!1){try{let i=!1;if(i=t?await n.selectFolder():await n.restoreFromPreviousSession(),!i)return this.updateAllConnectionBadges(!1),!1;if(void 0!==o&&!o.initialized)try{await o.init({autoReconnect:!1})}catch(a){}this.updateAllConnectionBadges(!0);return!e||!this.repuestos||0===this.repuestos.length?(await this.loadData(),await this.render(),window.addNotificationToCampana(" Carpeta conectada y datos cargados","success")):window.addNotificationToCampana(" Carpeta reconectada - Datos preservados","success"),!0}catch(a){return this.updateAllConnectionBadges(!1),this.showToast(" Error al conectar carpeta: "+a.message,"error"),!1}}updateAllConnectionBadges(e){const t=e?n.folderPath||"Conectada":"";"function"==typeof n.updateStatusIndicator&&n.updateStatusIndicator(e,t),void 0!==l&&l.updateConnectionBadge&&(l.updateConnectionBadge(),e&&(null==o?void 0:o.initialized)&&setTimeout(()=>{l.loadData({force:!0}).catch(e=>{})},300)),void 0!==u&&u.actualizarEstadoUI&&setTimeout(()=>{u.actualizarEstadoUI()},200)}async init(){this.showBrowserWarning();try{localStorage.removeItem("inventario_backups_marcadores")}catch(n){}void 0!==u&&setTimeout(()=>{u.renderStorageUI(),u.loadICloudPathConfig()},100),await this.loadData(),this.setupEvents(),this.setupDelegatedEvents(),this.setupPhotoInputs(),this.applyViewModeStyles(),this.updateViewModeInfo(),await this.render(),this.renderFilters();const e=localStorage.getItem("autocompleteData");if(e)try{this.autocompleteData=JSON.parse(e)}catch(n){this.updateAutocompleteData()}else this.updateAutocompleteData();this.setupAutocomplete();const t=localStorage.getItem("jerarquiaLevels");if(t)try{this.jerarquiaData=JSON.parse(t)}catch(n){this.jerarquiaData={nivel1:[],nivel2:[],nivel3:[],nivel4:[],nivel5:[],nivel6:[],nivel7:[],nivel8:[]}}else this.jerarquiaData={nivel1:[{id:"1",name:"Planta Principal",description:"Sede central",timestamp:Date.now()}],nivel2:[{id:"2",name:"Produccin",description:"",timestamp:Date.now()},{id:"3",name:"Mantenimiento",description:"",timestamp:Date.now()}],nivel3:[{id:"4",name:"Lnea 1",description:"",timestamp:Date.now()},{id:"5",name:"Lnea 2",description:"",timestamp:Date.now()}],nivel4:[{id:"6",name:"Mquina A",description:"",timestamp:Date.now()},{id:"7",name:"Mquina B",description:"",timestamp:Date.now()}],nivel5:[],nivel6:[],nivel7:[],nivel8:[]},localStorage.setItem("jerarquiaLevels",JSON.stringify(this.jerarquiaData));const a=document.getElementById("equipo");a&&a.addEventListener("blur",()=>{const e=a.value.trim();e&&this.cargarSistemasPorEquipo(e)}),this.isEdge&&(this.isEdgeIOS||this.hasFileSystemAPI),setTimeout(()=>{this.initNotificationSystem()},100)}setupPhotoInputs(){const e=document.getElementById("mobile-photo-buttons"),t=document.getElementById("galleryInput"),a=document.getElementById("imagenFile"),n=document.querySelector(".multimedia-section");if(this.isMobile&&!this.hasFileSystemAPI){n&&(n.style.display="none");if(n?n.parentElement:null){if(!document.getElementById("mobile-no-photos-message")){const e=document.createElement("div");e.id="mobile-no-photos-message",e.style.cssText="\n            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1));\n            padding: 16px;\n            border-radius: 8px;\n            border-left: 4px solid var(--info);\n            margin: 16px 0;\n            color: var(--text-secondary);\n            font-size: 0.9rem;\n            line-height: 1.6;\n          ",e.innerHTML='\n            <strong style="color: var(--info); display: block; margin-bottom: 6px;"> Modo Mvil Simplificado</strong>\n            Las fotos no estn disponibles en dispositivos mviles.<br>\n            <strong>Funciones activas:</strong> Ver, Agregar, Editar, Eliminar, Conteo.\n            <br><br>\n             <strong>Para fotos:</strong> Usa la versin de PC con todas las funcionalidades.\n          ',n.parentNode.insertBefore(e,n)}}return}this.isMobile&&this.hasFileSystemAPI?(e&&(e.style.display="flex"),t&&(t.style.display="none"),a&&(a.style.display="none"),n&&(n.style.display="block")):(e&&(e.style.display="none"),t&&(t.style.display="block"),a&&(a.style.display="none"),n&&(n.style.display="block"))}setupDelegatedEvents(){document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const a=t.dataset.action,n=t.dataset.id;"edit"===a?this.openModal("edit",n):"delete"===a?confirm("Eliminar este repuesto?")&&this.deleteRepuesto(n):"lightbox"===a?this.openLightbox(n):"contar"===a?this.abrirModalConteoIndividual(n):"goto-card"===a?this.irATarjeta(n):"verMapa"===a&&this.verRepuestoEnMapa(n)}),document.addEventListener("change",e=>{const t=e.target;if(!t.dataset||!t.dataset.action)return;const a=t.dataset.action,n=t.dataset.id;"update-conteo"===a&&this.updateConteo(n,t.value)}),document.addEventListener("keydown",e=>{const t=document.getElementById("lightbox");if(t&&t.classList.contains("active")){if("Escape"!==e.key&&"Esc"!==e.key)return"ArrowLeft"===e.key||"Left"===e.key?(e.preventDefault(),void this.lightboxPrev()):"ArrowRight"===e.key||"Right"===e.key?(e.preventDefault(),void this.lightboxNext()):void 0;this.closeLightbox()}})}initWizard(e={}){const{initialStep:t=1,focusFirstField:a=!1}=e,n=document.getElementById("wizardTimeline"),i=document.querySelector(".wizard-step-container");if(!n||!i)return;const s=Array.from(i.querySelectorAll(".wizard-step")),r=Array.from(n.querySelectorAll(".wizard-step-indicator"));this.wizardState.steps=s,this.wizardState.indicators=r,this.wizardState.timeline=n,this.wizardState.container=i,this.wizardState.totalSteps=s.length,this.wizardState.currentStep=Math.min(t,s.length||t),this.wizardState.maxCompletedStep=this.wizardState.currentStep,this.wizardState.stepsVisited=new Set([this.wizardState.currentStep]),this.wizardState.pendingInvalidField=null,this.wizardState.lastValidationError=null,this.wizardState.nextBtn=document.querySelector(".btn-next-step"),this.wizardState.prevBtn=document.querySelector(".btn-prev-step"),this.wizardState.saveBtn=document.getElementById("btnGuardarRepuesto"),this.wizardState.nextBtn&&(this.wizardState.nextBtn.removeEventListener("click",this.handleWizardNext),this.wizardState.nextBtn.addEventListener("click",this.handleWizardNext)),this.wizardState.prevBtn&&(this.wizardState.prevBtn.removeEventListener("click",this.handleWizardPrev),this.wizardState.prevBtn.addEventListener("click",this.handleWizardPrev)),r.forEach(e=>{e.removeEventListener("click",this.handleWizardIndicatorClick),e.addEventListener("click",this.handleWizardIndicatorClick),e.classList.remove("is-error")}),s.forEach(e=>e.classList.remove("wizard-step--invalid")),this.updateWizardUI(),a&&this.focusWizardField(this.wizardState.currentStep),setTimeout(()=>this.ajustarAnchoModal(),120)}updateWizardUI(){if(!this.wizardState.steps||0===this.wizardState.steps.length)return;const{steps:e,indicators:t,currentStep:a,totalSteps:n,nextBtn:i,prevBtn:s,saveBtn:r}=this.wizardState;if(e.forEach(e=>{const t=Number(e.dataset.step)===a;e.classList.toggle("wizard-step--active",t)}),t.forEach(e=>{const t=Number(e.dataset.step),n=t===a;e.classList.toggle("is-active",n),e.classList.toggle("is-completed",t<a),e.disabled=!1,e.classList.remove("is-disabled"),e.setAttribute("aria-current",n?"step":"false"),e.setAttribute("aria-disabled","false")}),s){const e=1===a;s.disabled=e,s.setAttribute("aria-disabled",e?"true":"false");const t=s.querySelector(".btn-text");t&&(t.textContent=this.getWizardPrevLabel(a))}if(i){const e=a>=n;i.classList.toggle("is-hidden",e),i.disabled=e,i.setAttribute("aria-hidden",e?"true":"false"),i.setAttribute("aria-disabled",e?"true":"false"),i.dataset.stepTarget=Math.min(a+1,n);const t=i.querySelector(".btn-text");t&&(t.textContent=this.getWizardNextLabel(a))}if(r){const e=a>=n;r.classList.toggle("is-visible",e),r.setAttribute("aria-hidden",e?"false":"true"),r.tabIndex=e?0:-1}}setWizardStep(e,t={}){if(!this.wizardState.steps||0===this.wizardState.steps.length)return;const{focusFirstField:a=!0}=t,n=this.wizardState.totalSteps||this.wizardState.steps.length;if(e<1||e>n)return;this.wizardState.currentStep=e,this.wizardState.stepsVisited||(this.wizardState.stepsVisited=new Set),this.wizardState.stepsVisited.add(e),"number"!=typeof this.wizardState.maxCompletedStep?this.wizardState.maxCompletedStep=e:this.wizardState.maxCompletedStep=Math.max(this.wizardState.maxCompletedStep,e),this.updateWizardUI(),a&&this.focusWizardField(e);const i=this.wizardState.pendingInvalidField;if(i){const t=i.closest(".wizard-step");if(t&&Number(t.dataset.step)===Number(e)){const e=i;setTimeout(()=>{"function"==typeof e.reportValidity&&e.reportValidity(),"function"==typeof e.focus&&e.focus(),this.wizardState.pendingInvalidField=null},140)}else t||(this.wizardState.pendingInvalidField=null)}setTimeout(()=>this.ajustarAnchoModal(),140)}focusWizardField(e){if(!this.wizardState.steps||0===this.wizardState.steps.length)return;const t=this.wizardState.steps.find(t=>Number(t.dataset.step)===Number(e));if(!t)return;let a=t.querySelector('input:not([type="hidden"]):not([disabled]):not([readonly]), select:not([disabled]), textarea:not([disabled])');a||(a=t.querySelector("button:not([disabled])")),a&&setTimeout(()=>{"function"==typeof a.focus&&a.focus()},160)}getWizardStepName(e){if(!e||!this.wizardState.indicators)return`Paso ${e}`;const t=this.wizardState.indicators.find(t=>Number(t.dataset.step)===Number(e));if(t){const e=t.querySelector(".wizard-step-label");if(e)return e.textContent.trim()}return{1:"Identificacin",2:"Stock y polticas",3:"Ubicaciones",4:"Multimedia"}[e]||`Paso ${e}`}getWizardNextLabel(e){const t=this.getWizardStepName(e+1);return!t||t.startsWith("Paso")?"Siguiente paso":`Ir a ${t.toLowerCase()}`}getWizardPrevLabel(e){if(e<=1)return" Anterior";return` ${this.getWizardStepName(e-1)}`}validateWizardStep(e,t={}){var a,n;if(!this.wizardState.steps||0===this.wizardState.steps.length)return!0;const{reportValidity:i=!0}=t,s=this.wizardState.steps.find(t=>Number(t.dataset.step)===Number(e));if(!s)return!0;const r=null==(a=this.wizardState.indicators)?void 0:a.find(t=>Number(t.dataset.step)===Number(e));s.classList.remove("wizard-step--invalid"),null==r||r.classList.remove("is-error"),this.wizardState.lastValidationError=null;const o=s.querySelectorAll("input, select, textarea");for(const l of o)if(!l.disabled&&!l.checkValidity()){s.classList.add("wizard-step--invalid"),null==r||r.classList.add("is-error"),this.wizardState.lastValidationError={step:Number(e),type:"field-invalid",fieldName:l.name||l.id||(null==(n=l.dataset)?void 0:n.field)||null};const t=this.wizardState.currentStep===Number(e);return i&&t&&"function"==typeof l.reportValidity?(l.reportValidity(),"function"==typeof l.focus&&l.focus()):this.wizardState.pendingInvalidField=l,!1}if(3===Number(e)){this.sincronizarUbicacionesDesdeDOM();if(0===(this.ubicacionesActuales||[]).filter(e=>e.areaGeneral&&""!==e.areaGeneral.trim()).length){s.classList.add("wizard-step--invalid"),null==r||r.classList.add("is-error"),this.wizardState.lastValidationError={step:Number(e),type:"ubicaciones-vacias"};const t=s.querySelector('[data-field="areaGeneral"]');return t&&(this.wizardState.pendingInvalidField=t),!1}}if(this.wizardState.pendingInvalidField){const t=this.wizardState.pendingInvalidField.closest(".wizard-step");t&&Number(t.dataset.step)!==Number(e)||(this.wizardState.pendingInvalidField=null)}return!0}handleWizardNext(e){if(e&&e.preventDefault(),!this.wizardState.totalSteps)return;const t=this.wizardState.currentStep||1;t>=this.wizardState.totalSteps||this.setWizardStep(t+1)}handleWizardPrev(e){e&&e.preventDefault();const t=this.wizardState.currentStep||1;t<=1||this.setWizardStep(t-1)}handleWizardIndicatorClick(e){e.preventDefault();const t=e.currentTarget;if(!t||t.disabled)return;const a=Number(t.dataset.step);if(!a||!this.wizardState.totalSteps)return;a!==(this.wizardState.currentStep||1)&&this.setWizardStep(a)}async cleanBase64ImagesFromLocalStorage(){if(n.isFileSystemMode)try{const e=localStorage.getItem("inventarioData");if(!e)return;const t=JSON.parse(e);let a=0,n=new Blob([e]).size;if(t.forEach(e=>{if(e.multimedia&&e.multimedia.length>0){const t=e.multimedia.filter(e=>{const t=e.url&&e.url.startsWith("data:image");return t&&a++,!t});e.multimedia=t}}),a>0){const e=JSON.stringify(t);localStorage.setItem("inventarioData",e);((n-new Blob([e]).size)/1024).toFixed(2)}}catch(e){}}async repararImagenesRotas(){if(n.isFileSystemMode&&n.imagesFolder)try{const t=[];for await(const e of n.imagesFolder.values())if("file"===e.kind){e.name.toLowerCase().match(/\.(jpg|jpeg|png|webp|gif)$/i)&&t.push(e.name)}let a=0,i=0;for(const s of this.repuestos){if(!s.multimedia||0===s.multimedia.length)continue;const r=[];for(const o of s.multimedia){if("image"!==o.type){r.push(o);continue}let l=o.url;l.startsWith("./imagenes/")?l=l.substring(11):l.startsWith("imagenes/")&&(l=l.substring(9));try{await n.imagesFolder.getFileHandle(l),r.push(o)}catch(e){const o=await this.buscarImagenPorNombre(s.nombre,t);if(o){const e=await n.imagesFolder.getFileHandle(o),t=await e.getFile();r.push({type:"image",url:`./imagenes/${o}`,name:o,size:t.size,isFileSystem:!0}),a++}else i++}}s.multimedia=r}a>0||i>0?(await this.saveData(),this.showToast(` ${a} reparadas, ${i} referencias rotas eliminadas`,"success"),this.actualizarVistaActual()):this.showToast(" No se encontraron imgenes rotas","info")}catch(e){this.showToast(" Error al reparar imgenes","error")}}async buscarImagenPorNombre(e,t){const a=e.toUpperCase().trim().replace(/\s+/g,"_");let n=t.find(e=>e.replace(/\.(jpg|jpeg|png|webp|gif)$/i,"").toUpperCase().replace(/\s+/g,"_")===a);if(n)return n;if(n=t.find(e=>{const t=e.toUpperCase();return a.split("_").filter(e=>e.length>3).every(e=>t.includes(e))}),n)return n;const i=t.filter(e=>{const t=e.toUpperCase();return a.split("_").filter(e=>e.length>3).some(e=>t.includes(e))});return i.length>0?(i.sort((e,t)=>{var a,n;const i=parseInt((null==(a=e.match(/^(\d+)_/))?void 0:a[1])||"0");return parseInt((null==(n=t.match(/^(\d+)_/))?void 0:n[1])||"0")-i}),i[0]):null}async vincularImagenesSilencioso(){try{await this.repararImagenesRotas()}catch(e){}}async loadData(){if(n.isFileSystemMode)try{const e=await n.directoryHandle.getFileHandle("inventario.json"),t=await e.getFile(),a=await t.text(),i=JSON.parse(a);this.repuestos=i.map((e,t)=>(e.id&&"undefined"!==e.id&&"null"!==e.id?e.id=String(e.id):e.id=`repuesto-${Date.now()}-${t}`,e.multimedia&&Array.isArray(e.multimedia)||(e.multimedia=[]),e)),this.limpiarFormatoAntiguoUbicaciones();const s=this.repuestos.filter(e=>e.multimedia&&e.multimedia.length>0).length;this.repuestos.length;return void this.loadMapData()}catch(t){}if(this.isMobile&&!this.hasFileSystemAPI&&void 0!==a&&a.repuestos&&a.repuestos.length>0)return this.repuestos=a.repuestos.map((e,t)=>(e.id&&"undefined"!==e.id&&"null"!==e.id?e.id=String(e.id):e.id=`repuesto-${Date.now()}-${t}`,e.multimedia=[],e)),this.limpiarFormatoAntiguoUbicaciones(),localStorage.setItem("inventarioData",JSON.stringify(this.repuestos)),void this.loadMapData();const e=localStorage.getItem("inventarioData");if(e)try{const t=JSON.parse(e);this.repuestos=t.map((e,t)=>(e.id&&"undefined"!==e.id&&"null"!==e.id?e.id=String(e.id):e.id=`repuesto-${Date.now()}-${t}`,e.multimedia&&Array.isArray(e.multimedia)||(e.multimedia=[]),e)),this.limpiarFormatoAntiguoUbicaciones();new Set(this.repuestos.map(e=>e.id)).size!==this.repuestos.length&&(this.repuestos=this.repuestos.map((e,t)=>(e.id=`repuesto-${Date.now()}-${t}`,e)),this.saveData())}catch(i){this.loadDefaultData()}else this.loadDefaultData();this.loadMapData()}loadMapData(){const e=localStorage.getItem("mapData");if(e)try{this.mapObjects=JSON.parse(e)}catch(a){this.mapObjects=[]}const t=localStorage.getItem("mapImage");t&&(this.mapImage=t)}limpiarFormatoAntiguoUbicaciones(){let e=0;this.repuestos.forEach(t=>{t.ubicaciones&&Array.isArray(t.ubicaciones)&&t.ubicaciones.length>0&&(t.mapId||t.markerX||t.markerY||t.areaId)&&(delete t.mapId,delete t.areaId,delete t.markerX,delete t.markerY,delete t.ubicacionDescripcion,e++)}),e>0&&this.saveData().catch(e=>{})}loadDefaultData(){this.repuestos=[{id:1,nombre:"Extintor Polvo Qumico ABC 10kg",codSAP:"EXT-001",codProv:"PROV-EXT-001",cantidad:15,minimo:10,optimo:20,precio:45e3,planta:"Aquachile Antarfood Chonchi",descripcion:"Extintor tipo ABC para fuegos clase A, B y C",multimedia:[],ubicaciones:[]},{id:2,nombre:"Botiqun Primeros Auxilios Completo",codSAP:"BOT-001",codProv:"PROV-BOT-001",cantidad:8,minimo:5,optimo:12,precio:35e3,planta:"Aquachile Antarfood Chonchi",descripcion:"Botiqun con elementos bsicos de primeros auxilios",multimedia:[],ubicaciones:[]},{id:3,nombre:"Vlvula Mariposa 6 Pulgadas",codSAP:"VAL-MA-006",codProv:"PROV-VAL-006",cantidad:12,minimo:8,optimo:15,precio:125e3,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",descripcion:"Vlvula mariposa para control de flujo en tuberas principales",multimedia:[],ubicaciones:[]},{id:4,nombre:"Sensor de Temperatura PT100",codSAP:"SEN-TMP-100",codProv:"PROV-SEN-100",cantidad:20,minimo:15,optimo:25,precio:28e3,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",descripcion:"Sensor de temperatura tipo PT100 rango -50C a +200C",multimedia:[],ubicaciones:[]},{id:5,nombre:"Filtro de Cartucho 5 Micras",codSAP:"FIL-CAR-005",codProv:"PROV-FIL-005",cantidad:30,minimo:20,optimo:40,precio:15e3,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",descripcion:"Cartucho de filtro de 5 micras para agua de proceso",multimedia:[],ubicaciones:[]},{id:6,nombre:"Bomba Centrfuga 5HP",codSAP:"BOM-CEN-5HP",codProv:"PROV-BOM-5HP",cantidad:4,minimo:2,optimo:6,precio:45e4,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",descripcion:"Bomba centrfuga 5HP para recirculacin de agua",multimedia:[],ubicaciones:[]},{id:7,nombre:"Rodamiento SKF 6205-2RS",codSAP:"ROD-SKF-6205",codProv:"SKF-6205-2RS",cantidad:25,minimo:15,optimo:30,precio:18500,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",descripcion:"Rodamiento rgido de bolas con sellos de goma",multimedia:[],ubicaciones:[]},{id:8,nombre:"Sello Mecnico 25mm",codSAP:"SEL-MEC-025",codProv:"PROV-SEL-025",cantidad:8,minimo:5,optimo:12,precio:65e3,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",descripcion:"Sello mecnico para eje de 25mm en bombas",multimedia:[],ubicaciones:[]},{id:9,nombre:"Impulsor de Bomba Acero Inox",codSAP:"IMP-BOM-INOX",codProv:"PROV-IMP-INOX",cantidad:6,minimo:3,optimo:8,precio:185e3,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",descripcion:"Impulsor de acero inoxidable 316L para bomba centrfuga",multimedia:[],ubicaciones:[]},{id:10,nombre:"Carcasa de Bomba Con Bridas",codSAP:"CAR-BOM-BRID",codProv:"PROV-CAR-BRID",cantidad:3,minimo:2,optimo:5,precio:32e4,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",descripcion:"Carcasa de bomba centrfuga con bridas de conexin",multimedia:[],ubicaciones:[]},{id:11,nombre:"O-Ring Viton 25x3mm",codSAP:"ORI-VIT-25X3",codProv:"PROV-ORI-25X3",cantidad:50,minimo:30,optimo:60,precio:3500,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",seccion:"Seccin de Sellado",descripcion:"O-Ring de Viton para sellado de alta temperatura",multimedia:[],ubicaciones:[]},{id:12,nombre:"Junta Tapa Bomba Tefln",codSAP:"JUN-TAP-TEF",codProv:"PROV-JUN-TEF",cantidad:15,minimo:10,optimo:20,precio:8500,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",seccion:"Seccin de Sellado",descripcion:"Junta de tefln para tapa de bomba centrfuga",multimedia:[],ubicaciones:[]},{id:13,nombre:"Tornillo Allen M8x40 Inox A4",codSAP:"TOR-ALL-M8X40",codProv:"DIN912-M8X40-A4",cantidad:100,minimo:50,optimo:150,precio:450,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",seccion:"Seccin de Sellado",detalle:"Conjunto de Fijacin",descripcion:"Tornillo allen cabeza cilndrica M8x40mm acero inox A4-70",multimedia:[],ubicaciones:[]},{id:14,nombre:"Arandela Presin M8 Inox",codSAP:"ARA-PRE-M8",codProv:"DIN127-M8-INOX",cantidad:150,minimo:80,optimo:200,precio:150,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",seccion:"Seccin de Sellado",detalle:"Conjunto de Fijacin",descripcion:"Arandela de presin (grower) M8 acero inoxidable",multimedia:[],ubicaciones:[]}]}async cargarDatosPrueba(){if(!confirm(" AGREGAR DATOS DE PRUEBA\n\nDeseas agregar 14 repuestos de prueba a tus datos existentes?\n\nTus "+this.repuestos.length+" repuestos actuales NO se borrarn.\n\nLos datos de prueba tendrn IDs desde 9000 en adelante para fcil identificacin."))return;const e=[{id:9001,nombre:" Extintor Polvo Qumico ABC 10kg",codSAP:"TEST-EXT-001",codProv:"TEST-PROV-EXT-001",cantidad:15,minimo:10,optimo:20,precio:45e3,planta:"Aquachile Antarfood Chonchi",descripcion:" TEST - Extintor tipo ABC para fuegos clase A, B y C",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/FF6B35/FFFFFF?text=Extintor+ABC",nombre:"extintor_test.jpg"}],ubicaciones:[]},{id:9002,nombre:" Botiqun Primeros Auxilios Completo",codSAP:"TEST-BOT-001",codProv:"TEST-PROV-BOT-001",cantidad:8,minimo:5,optimo:12,precio:35e3,planta:"Aquachile Antarfood Chonchi",descripcion:" TEST - Botiqun con elementos bsicos de primeros auxilios",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/4ECDC4/FFFFFF?text=Botiquin",nombre:"botiquin_test.jpg"}],ubicaciones:[]},{id:9003,nombre:" Vlvula Mariposa 6 Pulgadas",codSAP:"TEST-VAL-MA-006",codProv:"TEST-PROV-VAL-006",cantidad:12,minimo:8,optimo:15,precio:125e3,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",descripcion:" TEST - Vlvula mariposa para control de flujo",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/F7B731/FFFFFF?text=Valvula+Mariposa",nombre:"valvula_test.jpg"}],ubicaciones:[]},{id:9004,nombre:" Sensor de Temperatura PT100",codSAP:"TEST-SEN-TMP-100",codProv:"TEST-PROV-SEN-100",cantidad:20,minimo:15,optimo:25,precio:28e3,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",descripcion:" TEST - Sensor PT100 rango -50C a +200C",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/5F27CD/FFFFFF?text=Sensor+PT100",nombre:"sensor_test.jpg"}],ubicaciones:[]},{id:9005,nombre:" Filtro de Cartucho 5 Micras",codSAP:"TEST-FIL-CAR-005",codProv:"TEST-PROV-FIL-005",cantidad:30,minimo:20,optimo:40,precio:15e3,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",descripcion:" TEST - Cartucho de filtro de 5 micras",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/00B894/FFFFFF?text=Filtro+5um",nombre:"filtro_test.jpg"}],ubicaciones:[]},{id:9006,nombre:" Bomba Centrfuga 5HP",codSAP:"TEST-BOM-CEN-5HP",codProv:"TEST-PROV-BOM-5HP",cantidad:4,minimo:2,optimo:6,precio:45e4,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",descripcion:" TEST - Bomba centrfuga 5HP",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/0984E3/FFFFFF?text=Bomba+5HP",nombre:"bomba_test.jpg"}],ubicaciones:[]},{id:9007,nombre:" Rodamiento SKF 6205-2RS",codSAP:"TEST-ROD-SKF-6205",codProv:"TEST-SKF-6205-2RS",cantidad:25,minimo:15,optimo:30,precio:18500,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",descripcion:" TEST - Rodamiento rgido de bolas",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/6C5CE7/FFFFFF?text=Rodamiento+SKF",nombre:"rodamiento_test.jpg"}],ubicaciones:[]},{id:9008,nombre:" Sello Mecnico 25mm",codSAP:"TEST-SEL-MEC-025",codProv:"TEST-PROV-SEL-025",cantidad:8,minimo:5,optimo:12,precio:65e3,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",descripcion:" TEST - Sello mecnico para eje 25mm",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/FD79A8/FFFFFF?text=Sello+Mecanico",nombre:"sello_test.jpg"}],ubicaciones:[]},{id:9009,nombre:" Impulsor de Bomba Acero Inox",codSAP:"TEST-IMP-BOM-INOX",codProv:"TEST-PROV-IMP-INOX",cantidad:6,minimo:3,optimo:8,precio:185e3,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",descripcion:" TEST - Impulsor acero inoxidable 316L",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/A29BFE/FFFFFF?text=Impulsor+Inox",nombre:"impulsor_test.jpg"}],ubicaciones:[]},{id:9010,nombre:" Carcasa de Bomba Con Bridas",codSAP:"TEST-CAR-BOM-BRID",codProv:"TEST-PROV-CAR-BRID",cantidad:3,minimo:2,optimo:5,precio:32e4,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",descripcion:" TEST - Carcasa con bridas de conexin",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/74B9FF/FFFFFF?text=Carcasa+Bomba",nombre:"carcasa_test.jpg"}],ubicaciones:[]},{id:9011,nombre:" O-Ring Viton 25x3mm",codSAP:"TEST-ORI-VIT-25X3",codProv:"TEST-PROV-ORI-25X3",cantidad:50,minimo:30,optimo:60,precio:3500,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",seccion:"Seccin de Sellado",descripcion:" TEST - O-Ring Viton alta temperatura",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/55EFC4/000000?text=O-Ring+Viton",nombre:"oring_test.jpg"}],ubicaciones:[]},{id:9012,nombre:" Junta Tapa Bomba Tefln",codSAP:"TEST-JUN-TAP-TEF",codProv:"TEST-PROV-JUN-TEF",cantidad:15,minimo:10,optimo:20,precio:8500,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",seccion:"Seccin de Sellado",descripcion:" TEST - Junta de tefln para tapa",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/FFEAA7/000000?text=Junta+Teflon",nombre:"junta_test.jpg"}],ubicaciones:[]},{id:9013,nombre:" Tornillo Allen M8x40 Inox A4",codSAP:"TEST-TOR-ALL-M8X40",codProv:"TEST-DIN912-M8X40-A4",cantidad:100,minimo:50,optimo:150,precio:450,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",seccion:"Seccin de Sellado",detalle:"Conjunto de Fijacin",descripcion:" TEST - Tornillo allen M8x40mm inox A4-70",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/DFE6E9/000000?text=Tornillo+M8x40",nombre:"tornillo_test.jpg"}],ubicaciones:[]},{id:9014,nombre:" Arandela Presin M8 Inox",codSAP:"TEST-ARA-PRE-M8",codProv:"TEST-DIN127-M8-INOX",cantidad:150,minimo:80,optimo:200,precio:150,planta:"Aquachile Antarfood Chonchi",areaGeneral:"rea de Produccin",subArea:"Sistema de Agua",sistemaEquipo:"Bomba Principal BP-01",subSistema:"Sistema Hidrulico",seccion:"Seccin de Sellado",detalle:"Conjunto de Fijacin",descripcion:" TEST - Arandela grower M8 inoxidable",multimedia:[{tipo:"imagen",url:"https://via.placeholder.com/400x300/B2BEC3/000000?text=Arandela+M8",nombre:"arandela_test.jpg"}],ubicaciones:[]}];this.repuestos.push(...e),await this.saveData(),this.renderRepuestos(),this.mostrarToast(" 14 repuestos de prueba agregados con xito\n\n Bscalos con el emoji  o con IDs 9001-9014\n Datos guardados automticamente","success",6e3)}async saveData(){this.showToast(" Guardando...","info",1e4);try{if(this.isMobile&&!this.hasFileSystemAPI&&void 0!==a&&(a.repuestos=this.repuestos.map(e=>{const{multimedia:t,...a}=e;return a}),a.lastUpdate=(new Date).toISOString()),n.isFileSystemMode){if(!1!==await n.saveJSON(this.repuestos))return this.showToast("Guardado en carpeta (sin lmites)","success",2e3),u&&u.backupManager&&u.backupManager.marcarCambiosPendientes(),!0}const e=JSON.stringify(this.repuestos),t=(e.length/1048576).toFixed(2);if(t>9){this.showToast(` DATOS NO GUARDADOS: ${t}MB excede lmite de navegador (10MB)`,"error",8e3);return confirm(` PROBLEMA CRTICO\n\n Tamao: ${t}MB\n Lmite navegador: ~10MB\n Repuestos: ${this.repuestos.length}\n\n TUS CAMBIOS SE PERDERN AL REFRESCAR\n\nSOLUCIONES:\n1. Activar " Modo Carpeta" (capacidad ilimitada)\n2. Exportar JSON sin imgenes\n3. Reducir cantidad de repuestos\n\nExportar AHORA los datos actuales (sin imgenes)?`)&&this.exportJSONSinImagenes(),!1}return localStorage.setItem("inventarioData",e),t>7?this.showToast(` ADVERTENCIA: ${t}MB/10MB - Activa " Modo Carpeta" para sin lmites`,"warning",6e3):t>4&&this.showToast(`Guardado: ${t}MB`,"info",3e3),!0}catch(e){if("QuotaExceededError"===e.name){const e=(JSON.stringify(this.repuestos).length/1048576).toFixed(2);this.showToast(` LMITE EXCEDIDO (${e}MB). Activa " Modo Carpeta"!`,"error",1e4)}else this.showToast(" Error al guardar: "+e.message,"error");return!1}}calcularTiempoTranscurrido(e){const t=Date.now()-e,a=Math.floor(t/1e3),n=Math.floor(a/60),i=Math.floor(n/60),s=Math.floor(i/24);return s>0?`${s} da${1===s?"":"s"}`:i>0?`${i} hora${1===i?"":"s"}`:n>0?`${n} minuto${1===n?"":"s"}`:"menos de 1 minuto"}setupEvents(){var e,t,a;let n;document.querySelectorAll(".nav-tab").forEach(e=>{e.addEventListener("click",()=>this.switchTab(e.dataset.tab))}),document.querySelectorAll(".view-btn").forEach(e=>{e.addEventListener("click",()=>this.switchView(e.dataset.view))}),null==(e=document.getElementById("searchInput"))||e.addEventListener("input",()=>{this.currentPage=1,this.renderInventario()}),document.addEventListener("click",e=>{e.target.classList.contains("filter-chip")&&(document.querySelectorAll(".filter-chip").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),this.currentPage=1,this.renderInventario())}),null==(t=document.getElementById("btnIniciarConteo"))||t.addEventListener("click",()=>this.iniciarConteo()),null==(a=document.getElementById("btnFinalizarConteo"))||a.addEventListener("click",()=>this.finalizarConteo()),window.addEventListener("resize",()=>{"auto"===this.viewMode&&"auto"===this.itemsPerPage&&(clearTimeout(n),n=setTimeout(()=>{this.updateViewModeInfo(),this.currentPage=1,this.renderInventario()},500))}),this.setupCanvas()}setupCanvas(){if(this.canvas=document.getElementById("mapCanvas"),!this.canvas)return;this.ctx=this.canvas.getContext("2d");const e=()=>{this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.renderMap()};e(),window.addEventListener("resize",e),this.canvas.addEventListener("click",e=>this.handleMapClick(e))}toggleMapSection(e){const t=e.closest(".map-section");t.classList.toggle("map-section--collapsed");const a=e.querySelector("h3").textContent.trim(),n=t.classList.contains("map-section--collapsed"),i=JSON.parse(localStorage.getItem("mapCollapsedSections")||"[]");if(n)i.includes(a)||i.push(a);else{const e=i.indexOf(a);e>-1&&i.splice(e,1)}localStorage.setItem("mapCollapsedSections",JSON.stringify(i))}restoreMapSectionsState(){const e=JSON.parse(localStorage.getItem("mapCollapsedSections")||"[]");document.querySelectorAll(".map-section").forEach(t=>{const a=t.querySelector(".map-section-header h3").textContent.trim();e.includes(a)&&t.classList.add("map-section--collapsed")})}switchTab(e){document.querySelectorAll(".tab-content").forEach(e=>e.style.display="none"),document.getElementById(e).style.display="block",document.querySelectorAll(".nav-tab").forEach(e=>e.classList.remove("active")),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),this.currentTab=e,"jerarquia"===e?setTimeout(()=>{this.renderJerarquiaTree(),this.initJerarquiaSearch()},100):"stats"===e?this.renderStats():"valores"===e?this.renderValores():"okr"===e?d.renderDashboard():"configuracion"===e?(this.renderListasGestion(),void 0!==u&&u.actualizarEstadoUI&&setTimeout(()=>u.actualizarEstadoUI(),50),void 0!==p&&p.actualizarUI&&setTimeout(()=>p.actualizarUI(),100),setTimeout(()=>{["storage-config","export-config","backup-config","listas-config","herramientas-config"].forEach(e=>{const t=document.getElementById(e+"-content"),a=document.getElementById(e+"-icon");t&&a&&("closed"===(localStorage.getItem("config-"+e)||"closed")?(t.style.display="none",a.textContent=""):(t.style.display="block",a.textContent=""))})},150)):"mapa"===e?setTimeout(()=>{var e;this.restoreMapSectionsState();if("undefined"!=typeof window&&window.mapController&&l.elements&&l.elements.canvas)try{if("function"==typeof l.handleResize?l.handleResize():"function"==typeof l.resizeCanvas&&l.resizeCanvas(),l.state.currentMapId)"function"==typeof l.draw&&l.draw();else{const t=null==(e=l.loadData)?void 0:e.call(l);t&&"function"==typeof t.catch&&t.catch(e=>{})}}catch(t){}else this.canvas&&this.ctx||this.setupCanvas(),this.renderMap()},100):"conteo"===e&&this.renderConteo()}switchView(e){this.currentView=e,document.querySelectorAll(".view-btn").forEach(e=>e.classList.remove("active")),document.querySelector(`[data-view="${e}"]`).classList.add("active"),this.renderInventario()}calculateAutoItemsPerPage(){if("mobile"===this.viewMode)return 10;if("desktop"===this.viewMode)return 21;const e=window.innerWidth;let t;t=e<768?1:e<1200?2:e<1600?4:e<1920?5:6;return t*(e<768?10:3)}getItemsPerPage(){return"auto"===this.itemsPerPage?this.calculateAutoItemsPerPage():parseInt(this.itemsPerPage)||this.itemsPerPageManual}changeItemsPerPage(e){this.itemsPerPage=e,"auto"!==e&&(this.itemsPerPageManual=parseInt(e)),this.currentPage=1,this.renderInventario()}changeViewMode(e){this.viewMode=e,localStorage.setItem("viewMode",e),this.applyViewModeStyles(),this.updateViewModeInfo(),this.currentPage=1,this.renderInventario()}applyViewModeStyles(){document.body.classList.remove("force-mobile","force-desktop"),"mobile"===this.viewMode?document.body.classList.add("force-mobile"):"desktop"===this.viewMode&&document.body.classList.add("force-desktop")}updateViewModeInfo(){const e=document.getElementById("viewModeSelect"),t=document.getElementById("currentViewModeText");if(e&&(e.value=this.viewMode),t){const e=window.innerWidth;let a="";if("auto"===this.viewMode){a=` Auto - Detectado: ${e<768?"Mvil":e<1200?"Tablet":"Desktop"} (${e}px)`}else"mobile"===this.viewMode?a=" Modo Mvil Forzado (1 columna, botones grandes)":"desktop"===this.viewMode&&(a=" Modo PC Forzado (5-8 columnas, mxima densidad)");t.textContent=a}this.updateEdgeBanner()}updateEdgeBanner(){const e=document.getElementById("edgeStatusBadge"),t=document.getElementById("edgeDownloadSection");e&&(this.isEdge?(e.textContent=" EDGE DETECTADO",e.style.background="rgba(16, 185, 129, 0.3)"):(e.textContent=" NO EDGE",e.style.background="rgba(220, 38, 38, 0.3)")),t&&(t.style.display=this.isEdge?"none":"block")}render(){this.renderInventario(),this.renderFilters()}renderFilters(){const e=[...new Set(this.repuestos.map(e=>e.areaGeneral||e.area).filter(e=>e))].sort(),t=[...new Set(this.repuestos.map(e=>e.sistemaEquipo||e.equipo).filter(e=>e))].sort(),a=[...new Set(this.repuestos.map(e=>e.tipo).filter(e=>e))].sort(),n=document.getElementById("filterArea"),i=document.getElementById("filterEquipo"),s=document.getElementById("filterTipo");n&&(n.innerHTML='<option value="">Todas las reas</option>'+e.map(e=>`<option value="${e}">${e}</option>`).join("")),i&&(i.innerHTML='<option value="">Todos los Sistemas/Equipos</option>'+t.map(e=>`<option value="${e}">${e}</option>`).join("")),s&&(s.innerHTML='<option value="">Todos los Tipos</option>'+a.map(e=>`<option value="${e}">${e}</option>`).join(""))}applyFilters(){this.currentPage=1,this.renderInventario()}getFilteredRepuestos(){var e,t,a,n,i;const s=(null==(e=document.getElementById("searchInput"))?void 0:e.value.toLowerCase())||"",r=(null==(t=document.getElementById("filterArea"))?void 0:t.value)||"",o=(null==(a=document.getElementById("filterEquipo"))?void 0:a.value)||"",l=(null==(n=document.getElementById("filterTipo"))?void 0:n.value)||"",d=(null==(i=document.getElementById("filterStock"))?void 0:i.value)||"";return this.filtrosJerarquicosActivos,this.repuestos.filter(e=>{const t=!s||e.codSAP&&e.codSAP.toLowerCase().includes(s)||e.nombre&&e.nombre.toLowerCase().includes(s)||e.tipo&&e.tipo.toLowerCase().includes(s)||e.codProv&&e.codProv.toLowerCase().includes(s)||e.planta&&e.planta.toLowerCase().includes(s)||e.areaGeneral&&e.areaGeneral.toLowerCase().includes(s)||e.subArea&&e.subArea.toLowerCase().includes(s)||e.sistemaEquipo&&e.sistemaEquipo.toLowerCase().includes(s)||e.subSistema&&e.subSistema.toLowerCase().includes(s)||e.seccion&&e.seccion.toLowerCase().includes(s)||e.detalle&&e.detalle.toLowerCase().includes(s)||e.area&&e.area.toLowerCase().includes(s)||e.equipo&&e.equipo.toLowerCase().includes(s)||e.sistema&&e.sistema.toLowerCase().includes(s)||e.detalleUbicacion&&e.detalleUbicacion.toLowerCase().includes(s),a=!r||e.areaGeneral===r||e.area===r,n=!o||e.sistemaEquipo===o||e.equipo===o,i=!l||e.tipo===l;let c=!0;if(this.filtrosJerarquicosActivos){const t=this.filtrosJerarquicosActivos;t.repuestoId?c=e.id===t.repuestoId:(t.planta&&e.planta!==t.planta&&(c=!1),t.areaGeneral&&e.areaGeneral!==t.areaGeneral&&(c=!1),t.subArea&&e.subArea!==t.subArea&&(c=!1),t.sistemaEquipo&&e.sistemaEquipo!==t.sistemaEquipo&&(c=!1),t.subSistema&&e.subSistema!==t.subSistema&&(c=!1),t.seccion&&e.seccion!==t.seccion&&(c=!1),t.detalle&&e.detalle!==t.detalle&&(c=!1))}let p=!0;const u=e.minimo||e.stockMinimo||5,m=e.optimo||2*u;return"agotado"===d?p=0===e.cantidad:"critico"===d?p=e.cantidad>0&&e.cantidad<u:"adecuado"===d?p=e.cantidad>=u&&e.cantidad<m:"optimo"===d&&(p=e.cantidad>=m),t&&a&&n&&i&&p&&c})}async renderInventario(){if(this.filteredRepuestos=this.getFilteredRepuestos(),this.isMobile&&!this.hasFileSystemAPI)return void(await this.renderMobileListView(this.filteredRepuestos));const e=this.getItemsPerPage(),t=Math.ceil(this.filteredRepuestos.length/e);this.currentPage>t&&(this.currentPage=t||1);const a=(this.currentPage-1)*e,n=a+e,i=this.filteredRepuestos.slice(a,n);"cards"===this.currentView?await this.renderCards(i):await this.renderList(i),this.updatePagination()}async renderCards(e){const t=document.getElementById("cardsGrid"),a=document.getElementById("listView");if(t.style.display="grid",a.style.display="none",0===e.length)return void(t.innerHTML='<div class="text-center" style="grid-column: 1/-1; padding: 60px; color: var(--gray-500);">No se encontraron repuestos</div>');const n=await Promise.all(e.map(async e=>{const t=e.multimedia||[],a=await this.getFirstImage(t);return{...e,imageUrl:a}}));t.innerHTML=n.map(e=>{const t=e.multimedia||[],a=e.imageUrl,n=e.minimo||e.stockMinimo||5,i=e.cantidad||0,s=e.optimo||10;let r=0;if(n>0)if(i<n)r=i/n*50;else if(i<s){r=50+50*((i-n)/(s-n))}else r=100;let o="#6B8E7F";return o=0===i?"#C76B6B":i<n?"#D4976C":i>=n&&i<s?"#5B7C99":"#6B8E7F",`\n      <div class="repuesto-card">\n        <div class="card-image" data-action="lightbox" data-id="${e.id}" style="cursor: pointer; position: relative;">\n          ${a?`<img src="${a}" alt="${e.nombre}" data-blob-url="${a}" onload="console.log(' Imagen cargada en DOM:', this.alt)" onerror="console.error(' ERROR onerror - Imagen fall en DOM:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">\n          <div class="no-image" style="display:none;">Sin imagen</div>`:'<div class="no-image">Sin imagen</div>'}\n          ${t.length>1?`<div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">+${t.length-1}</div>`:""}\n        </div>\n        <div class="card-content">\n          <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 6px;">\n            <h3 style="margin: 0; font-weight: 500; color: var(--text-primary); font-size: 1rem;">${e.nombre}</h3>\n            <div style="display: flex; gap: 6px; width: 100%;">\n              <button class="btn-add-location" onclick="app.agregarUbicacionMapa('${e.id}')" title="Aadir nueva ubicacin en el mapa">\n                Aadir Ubicacin\n              </button>\n              <button class="btn-view-map" onclick="app.verRepuestoEnMapa('${e.id}')" title="Ver ubicaciones en el mapa">\n                Ver en Mapa\n              </button>\n            </div>\n          </div>\n          <div class="card-info">\n            ${e.codSAP?`<div class="info-row"><span class="info-label">Cd. SAP:</span><span class="info-value" style="font-weight: 500; color: var(--primary);">${e.codSAP}</span></div>`:""}\n            ${e.codProv?`<div class="info-row"><span class="info-label">Cd. Proveedor:</span><span class="info-value" style="font-weight: 500; color: var(--text-secondary);">${e.codProv}</span></div>`:""}\n          </div>\n          ${e.tipo?`<div class="info-row"><span class="info-label">Tipo:</span><span class="info-value">${e.tipo}</span></div>`:""}\n          ${e.categoria?`<div class="info-row"><span class="info-label">Categora:</span><span class="info-value" style="font-weight: 500; font-size: 0.85rem; padding: 2px 8px; border-radius: 4px; display: inline-block; background: rgba(91, 139, 180, 0.15); color: var(--primary); border: 1px solid rgba(91, 139, 180, 0.3);">${e.categoria}</span></div>`:""}\n          \n          \x3c!-- Datos Tcnicos (si existen) --\x3e\n          ${e.datosTecnicos?`\n            <div style="background: rgba(91, 139, 180, 0.08); border-left: 2px solid var(--primary); padding: 8px 10px; border-radius: 4px; margin: 8px 0;">\n              <div style="font-size: 0.7rem; font-weight: 600; color: var(--primary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">\n                Datos Tcnicos\n              </div>\n              <div style="font-size: 0.78rem; color: var(--text-primary); line-height: 1.5; font-family: 'Segoe UI', Arial, sans-serif; white-space: pre-line; word-break: break-word;">${e.datosTecnicos}</div>\n            </div>\n          `:""}\n          \n          <div class="card-info">\n            ${this.showPrecio&&e.precio>0?`<div class="info-row precio-info"><span class="info-label">Precio:</span><span class="info-value">$${e.precio.toFixed(2)}</span></div>`:""}\n            \n            <div style="background: rgba(51, 65, 85, 0.6); padding: 6px; border-radius: 4px; margin-top: 6px; border-left: 2px solid ${o};">\n              \n              \x3c!-- Texto descriptivo del estado --\x3e\n              <div style="\n                font-size: 0.68rem;\n                color: ${o};\n                font-weight: 500;\n                margin-bottom: 5px;\n                line-height: 1.3;\n              ">\n                ${(()=>{if(0===i)return"Stock agotado. Requiere reposicin urgente.";if(i<n){return`Stock insuficiente: ${i} de ${n} unid. mnimas. Faltan ${n-i} unid.`}if(i>=n&&i<s){return`Stock adecuado: ${i} unid. disponibles (+${i-n} sobre mnimo).`}return`Stock ptimo: ${i} unid. disponibles (+${i-s} sobre ptimo).`})()}\n              </div>\n              \n              \x3c!-- BARRA VISUAL DE STOCK SIMPLIFICADA --\x3e\n              <div style="\n                position: relative;\n                width: 100%;\n                height: 20px;\n                background: rgba(15, 23, 42, 0.8);\n                border-radius: 4px;\n                overflow: hidden;\n                margin-bottom: 4px;\n                border: 1px solid ${o}40;\n              ">\n                \x3c!-- Barra de progreso sin gradiente --\x3e\n                <div style="\n                  position: absolute;\n                  left: 0;\n                  top: 0;\n                  height: 100%;\n                  width: ${r}%;\n                  background: ${o};\n                  transition: width 0.3s ease;\n                "></div>\n                \n                \x3c!-- Contenido superpuesto --\x3e\n                <div style="\n                  position: absolute;\n                  top: 0;\n                  left: 0;\n                  width: 100%;\n                  height: 100%;\n                  display: flex;\n                  justify-content: center;\n                  align-items: center;\n                  padding: 0 10px;\n                  z-index: 3;\n                ">\n                  \x3c!-- Centro: Unidades --\x3e\n                  <div style="display: flex; align-items: center; gap: 6px;">\n                    <span style="font-size: 0.85rem; font-weight: 600; color: white;">${i}</span>\n                    <span style="font-size: 0.65rem; color: rgba(255,255,255,0.65);">/</span>\n                    <span style="font-size: 0.75rem; font-weight: 500; color: rgba(255,255,255,0.85);">${n}</span>\n                    <span style="font-size: 0.65rem; color: rgba(255,255,255,0.75); font-weight: 400;">unid.</span>\n                  </div>\n                </div>\n              </div>\n              \n              <div style="display: grid; grid-template-columns: repeat(${e.cantidadInstalada>0?"4":"3"}, 1fr); gap: 4px; margin-bottom: 4px;">\n                ${e.cantidadInstalada>0?`\n                <div style="text-align: center; background: rgba(91, 155, 122, 0.12); padding: 2px; border-radius: 3px; border: 1px solid rgba(91, 155, 122, 0.25);">\n                  <div style="font-size: 0.5rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 1px;">En Uso</div>\n                  <div style="font-size: 0.7rem; font-weight: 600; color: var(--success);">${e.cantidadInstalada}</div>\n                </div>\n                `:""}\n                <div style="text-align: center;">\n                  <div style="font-size: 0.5rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 1px;">Mnimo</div>\n                  <div style="font-size: 0.7rem; font-weight: 600; color: var(--warning);">${n}</div>\n                </div>\n                <div style="text-align: center; background: rgba(91, 139, 180, 0.15); padding: 2px; border-radius: 3px; border: 1px solid rgba(91, 139, 180, 0.25);">\n                  <div style="font-size: 0.5rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 1px;">Stock</div>\n                  <div style="font-size: 0.75rem; font-weight: 700; color: ${o};">${i}</div>\n                </div>\n                <div style="text-align: center;">\n                  <div style="font-size: 0.5rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 1px;">ptimo</div>\n                  <div style="font-size: 0.7rem; font-weight: 600; color: var(--success);">${s}</div>\n                </div>\n              </div>\n              \n              \x3c!-- Informacin de ltimo conteo --\x3e\n              <div style="\n                font-size: 0.6rem;\n                color: var(--text-secondary);\n                padding: 4px 5px;\n                background: rgba(15, 23, 42, 0.4);\n                border-radius: 3px;\n                margin-top: 4px;\n                text-align: center;\n              ">\n                ${e.ultimoConteo?`\n                  <span style="color: rgba(255,255,255,0.75); font-size: 0.65rem;">ltima verificacin: ${new Date(e.ultimoConteo).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"2-digit"})} - ${new Date(e.ultimoConteo).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}</span>\n                `:'\n                  <span style="color: var(--warning); font-size: 0.65rem;">Pendiente de verificacin</span>\n                '}\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class="card-footer" style="display: flex; justify-content: center; align-items: center; gap: 8px; padding: 8px 12px;">\n          <button class="card-btn" style="\n            background: var(--primary);\n            color: white;\n            border: 1px solid rgba(91, 139, 180, 0.3);\n            padding: 8px 14px;\n            border-radius: 4px;\n            font-weight: 500;\n            font-size: 0.75rem;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            flex: 1;\n            max-width: 90px;\n          " data-action="edit" data-id="${e.id}" \n          onmouseover="this.style.background='#6a9dc4'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.15)';"\n          onmouseout="this.style.background='var(--primary)'; this.style.boxShadow='none';">\n            Editar\n          </button>\n          \n          <button class="card-btn" style="\n            background: var(--success);\n            color: white;\n            border: 1px solid rgba(91, 155, 122, 0.3);\n            padding: 8px 14px;\n            border-radius: 4px;\n            font-weight: 500;\n            font-size: 0.75rem;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            flex: 1;\n            max-width: 90px;\n          " data-action="contar" data-id="${e.id}"\n          onmouseover="this.style.background='#6bae89'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.15)';"\n          onmouseout="this.style.background='var(--success)'; this.style.boxShadow='none';">\n            Contar\n          </button>\n          \n          <button class="card-btn" style="\n            background: var(--danger);\n            color: white;\n            border: 1px solid rgba(184, 107, 107, 0.3);\n            padding: 8px 14px;\n            border-radius: 4px;\n            font-weight: 500;\n            font-size: 0.75rem;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            flex: 1;\n            max-width: 90px;\n          " data-action="delete" data-id="${e.id}"\n          onmouseover="this.style.background='#c88080'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.15)';"\n          onmouseout="this.style.background='var(--danger)'; this.style.boxShadow='none';">\n            Eliminar\n          </button>\n        </div>\n      </div>\n      `}).join("")}renderList(e){const t=document.getElementById("cardsGrid"),a=document.getElementById("listView");if(t.style.display="none",a.style.display="block",0===e.length)return void(a.innerHTML='<div class="text-center" style="padding: 60px; color: var(--gray-500);">No se encontraron repuestos</div>');const n=this.listSortField||"codSAP",i=this.listSortOrder||"asc",s={N1:1,N2:2,N3:3,N4:4,N5:5,N6:6,N7:7,N8:8},r=[...e].sort((e,t)=>{const a=s[e.nivelJerarquico]||8,r=s[t.nivelJerarquico]||8;if(a!==r)return a-r;let o,l;if("stock"===n)o=e.cantidad||0,l=t.cantidad||0;else if("stockPercent"===n){const a=2*(e.minimo||5),n=2*(t.minimo||5);o=(e.cantidad||0)/a*100,l=(t.cantidad||0)/n*100}else o=(e[n]||"").toString().toLowerCase(),l=(t[n]||"").toString().toLowerCase();return"asc"===i?o>l?1:o<l?-1:0:o<l?1:o>l?-1:0});a.innerHTML=`\n      <div class="list-header" id="listHeader">\n        <div class="list-header-cell ${"codSAP"===n?"active":""}" onclick="app.sortList('codSAP')" style="min-width: 50px;" data-col="0">\n          <span>Ub.</span>\n          <div class="resize-handle" data-col="0"></div>\n        </div>\n        <div class="list-header-cell ${"codSAP"===n?"active":""}" onclick="app.sortList('codSAP')" data-col="1">\n          <span>Cdigos</span>\n          <span class="sort-icon"></span>\n          <div class="resize-handle" data-col="1"></div>\n        </div>\n        <div class="list-header-cell ${"nombre"===n?"active":""}" onclick="app.sortList('nombre')" data-col="2">\n          <span>Nombre</span>\n          <span class="sort-icon"></span>\n          <div class="resize-handle" data-col="2"></div>\n        </div>\n        <div class="list-header-cell ${"stock"===n||"stockPercent"===n?"active":""}" onclick="app.sortList('stock')" data-col="3">\n          <span>Stock (Mn/Act/pt)</span>\n          <span class="sort-icon"></span>\n          <div class="resize-handle" data-col="3"></div>\n        </div>\n        <div data-col="4">Acciones</div>\n      </div>\n      ${r.map(e=>{const t=e.minimo||e.stockMinimo||5,a=e.cantidad||0,n=e.optimo||10;let i="#6B8E7F",s="Normal";0===a?(i="#C76B6B",s="Sin Stock"):a<t?(i="#D4976C",s="Crtico"):a<=n&&(i="#5B7C99",s="Bajo");let r="";e.codSAP&&(r+=`<div style="font-weight: 600; color: #718096; font-size: 0.7rem; display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">\n            <span style="color: var(--text-secondary); font-weight: 500; font-size: 0.65rem;">SAP:</span>\n            <span style="color: #5B7C99; font-weight: 700; font-size: 0.8rem;">${e.codSAP}</span>\n          </div>`),e.codProv&&(r+=`<div style="font-weight: 600; color: #718096; font-size: 0.7rem; display: flex; align-items: center; gap: 4px;">\n            <span style="color: var(--text-secondary); font-weight: 500; font-size: 0.65rem;">Proveedor:</span>\n            <span style="color: #7A9AB8;">${e.codProv}</span>\n          </div>`),r||(r='<span style="color: var(--gray-400); font-size: 0.65rem;">Sin cdigo</span>');return e.planta||this.plantaBase,this.jerarquiaNiveles.forEach(t=>{if("planta"===t.id)return;let a=e[t.id];a||"areaGeneral"!==t.id||(a=e.area),a||"sistemaEquipo"!==t.id||(a=e.equipo),a||"subSistema"!==t.id||(a=e.sistema),a||"detalle"!==t.id||(a=e.detalleUbicacion),a&&t.id}),`\n        <div class="list-row">\n          <div data-label="Ubicacin" style="display: flex; align-items: center; justify-content: center;">\n            <button class="btn-hierarchy" onclick="app.mostrarJerarquia('${e.id}')" title="Ver jerarqua completa" style="width: auto; padding: 4px 8px; font-size: 0.7rem;">\n              Ver\n            </button>\n          </div>\n          <div data-label="Cdigos" style="line-height: 1.2;">\n            ${r}\n          </div>\n          <div data-label="Nombre" style="line-height: 1.2;">\n            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">\n              ${e.nivelJerarquico?`<span style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; font-size: 0.6rem; font-weight: 700; padding: 2px 6px; border-radius: 3px; letter-spacing: 0.5px;">${e.nivelJerarquico}</span>`:""}\n              <div style="font-weight: 600; color: var(--text-primary); font-size: 0.8rem;">${e.nombre}</div>\n            </div>\n            ${e.tipo?`<div style="color: var(--text-secondary); font-size: 0.65rem; margin-top: 1px;"><span style="font-weight: 600;">Tipo:</span> ${e.tipo}</div>`:""}\n          </div>\n          <div data-label="Stock (Mn/Act/pt)" class="stock-visual">\n            <div style="display: flex; gap: 4px; align-items: center; justify-content: space-around; margin-bottom: 2px; padding: 0;">\n              <div style="text-align: center; flex: 1;">\n                <div style="font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0px;">Mn</div>\n                <div style="font-weight: 700; font-size: 0.75rem; color: #D4976C; line-height: 1;">${t}</div>\n              </div>\n              <div style="text-align: center; background: rgba(91, 124, 153, 0.25); padding: 3px 6px; border-radius: 3px; flex: 1;">\n                <div style="font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0px;">Act</div>\n                <div style="font-weight: 700; font-size: 0.85rem; color: ${i}; line-height: 1;">${a}</div>\n              </div>\n              <div style="text-align: center; flex: 1;">\n                <div style="font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0px;">pt</div>\n                <div style="font-weight: 700; font-size: 0.75rem; color: #6B8E7F; line-height: 1;">${n}</div>\n              </div>\n            </div>\n            \n            ${(()=>{let e=0,i="#C76B6B";if(0===a)e=0,i="#C76B6B";else if(a<t)e=a/t*50,i="#D4976C";else if(a>=t&&a<n){e=50+50*((a-t)/(n-t)),i="#5B7C99"}else e=100,i="#6B8E7F";return`\n              <div style="margin: 2px 0 2px 0;">\n                <div style="position: relative; width: 100%; height: 4px; background: rgba(100, 116, 139, 0.2); border-radius: 2px; overflow: visible;">\n                  <div style="\n                    position: absolute;\n                    left: 0;\n                    top: 0;\n                    height: 100%;\n                    width: ${e}%;\n                    background: ${i};\n                    border-radius: 2px;\n                    transition: width 0.4s ease;\n                    box-shadow: 0 0 4px ${i}80;\n                  "></div>\n                  \n                  <div style="\n                    position: absolute;\n                    left: 50%;\n                    top: 0px;\n                    width: 1px;\n                    height: 4px;\n                    background: #D4976C;\n                    transform: translateX(-50%);\n                    z-index: 2;\n                  "></div>\n                  \n                  <div style="\n                    position: absolute;\n                    right: 0;\n                    top: 0px;\n                    width: 1px;\n                    height: 4px;\n                    background: #6B8E7F;\n                    z-index: 2;\n                  "></div>\n                </div>\n                \n                <div style="display: flex; justify-content: space-between; font-size: 0.45rem; color: var(--text-secondary); margin-top: 1px;">\n                  <span>0</span>\n                  <span style="color: #D4976C; font-weight: 600;">Mn</span>\n                  <span style="color: #6B8E7F; font-weight: 600;">pt</span>\n                </div>\n              </div>\n              `})()}\n            \n            <div style="font-size: 0.6rem; color: ${i}; font-weight: 600; text-align: center; margin-top: 0px; line-height: 1;">${s}</div>\n          </div>\n          <div class="list-actions">\n            <button class="btn" style="\n              background: #557566;\n              color: white;\n              border: 1px solid #6B8E7F;\n              padding: 6px 8px;\n              font-size: 0.65rem;\n              border-radius: 4px;\n              font-weight: 600;\n              cursor: pointer;\n              transition: all 0.2s;\n              box-shadow: 0 1px 3px rgba(0,0,0,0.15);\n              white-space: nowrap;\n              line-height: 1.1;\n              width: 55px;\n              flex: 0 0 55px;\n            " data-action="contar" data-id="${e.id}"\n            onmouseover="this.style.background='#6B8E7F'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'"\n            onmouseout="this.style.background='#557566'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.15)'">\n              Contar\n            </button>\n            <button class="btn" style="\n              background: #4A6278;\n              color: white;\n              border: 1px solid #5B7C99;\n              padding: 6px 8px;\n              font-size: 0.65rem;\n              border-radius: 4px;\n              font-weight: 600;\n              cursor: pointer;\n              transition: all 0.2s;\n              box-shadow: 0 1px 3px rgba(0,0,0,0.15);\n              white-space: nowrap;\n              line-height: 1.1;\n              width: 55px;\n              flex: 0 0 55px;\n            " data-action="edit" data-id="${e.id}"\n            onmouseover="this.style.background='#5B7C99'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'"\n            onmouseout="this.style.background='#4A6278'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.15)'">\n              Editar\n            </button>\n            <button class="btn" style="\n              background: #A85555;\n              color: white;\n              border: 1px solid #C76B6B;\n              padding: 6px 8px;\n              font-size: 0.65rem;\n              border-radius: 4px;\n              font-weight: 600;\n              cursor: pointer;\n              transition: all 0.2s;\n              box-shadow: 0 1px 3px rgba(0,0,0,0.15);\n              white-space: nowrap;\n              line-height: 1.1;\n              width: 55px;\n              flex: 0 0 55px;\n            " data-action="delete" data-id="${e.id}"\n            onmouseover="this.style.background='#C76B6B'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'"\n            onmouseout="this.style.background='#A85555'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.15)'">\n              Eliminar\n            </button>\n          </div>\n        </div>\n        `}).join("")}\n    `,setTimeout(()=>{this.applyColumnWidths(),this.setupColumnResize()},100)}applyColumnWidths(){const e=document.getElementById("listHeader");if(!e)return;const t=this.columnWidths.join(" ");e.style.gridTemplateColumns=t,document.querySelectorAll(".list-row").forEach(e=>{e.style.gridTemplateColumns=t})}async renderMobileListView(e){const t=document.getElementById("cardsGrid"),a=document.getElementById("listView");if(t.style.display="none",a.style.display="block",0===e.length)return void(a.innerHTML='<div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);"> No se encontraron repuestos</div>');const n=e.length,i=e.reduce((e,t)=>e+(t.cantidad||0),0),s=e.filter(e=>{const t=e.minimo||e.stockMinimo||5;return e.cantidad>0&&e.cantidad<=t}).length,r=e.filter(e=>0===e.cantidad).length;a.innerHTML=`\n      \x3c!-- HEADER STICKY CON TOTALES - CORPORATIVO --\x3e\n      <div style="\n        position: sticky;\n        top: 0;\n        z-index: 100;\n        background: linear-gradient(135deg, #003B5C 0%, #004d73 100%);\n        backdrop-filter: blur(10px);\n        padding: 16px;\n        margin: -16px -16px 16px -16px;\n        border-radius: 0 0 12px 12px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.4);\n        border-bottom: 3px solid #C75300;\n      ">\n        <div style="display: flex; justify-content: space-between; align-items: center; color: white; margin-bottom: 12px;">\n          <div style="font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">\n            <span style="display: inline-block; width: 8px; height: 8px; background: #0095DA; border-radius: 50%;"></span>\n            ${n} Repuestos\n          </div>\n          <div style="font-size: 0.9rem; font-weight: 600; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 6px;">\n            ${i} unid.\n          </div>\n        </div>\n        <div style="display: flex; gap: 8px; font-size: 0.75rem; flex-wrap: wrap;">\n          ${r>0?`<span style="background: rgba(139, 90, 90, 0.9); padding: 5px 10px; border-radius: 6px; font-weight: 600; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${r} sin stock</span>`:""}\n          ${s>0?`<span style="background: rgba(199, 83, 0, 0.9); padding: 5px 10px; border-radius: 6px; font-weight: 600; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${s} bajo</span>`:""}\n          <span style="background: rgba(82, 120, 83, 0.9); padding: 5px 10px; border-radius: 6px; font-weight: 600; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${n-r-s} OK</span>\n        </div>\n      </div>\n\n      \x3c!-- LISTA DE REPUESTOS --\x3e\n      <div style="display: flex; flex-direction: column; gap: 12px;">\n        ${e.map(e=>{const t=e.minimo||e.stockMinimo||5,a=e.cantidad||0,n=e.optimo||10,i=Math.min(a/n*100,100);let s="#6B8E7F",r="OK";return 0===a?(s="#C76B6B",r="Sin Stock"):a<t?(s="#D4976C",r="Crtico"):a<n&&(s="#5B7C99",r="Bajo"),`\n            <div style="\n              background: var(--bg-secondary);\n              border: 2px solid var(--border-color);\n              border-left: 4px solid ${s};\n              border-radius: 12px;\n              padding: 12px;\n              transition: all 0.2s ease;\n            " ontouchstart="this.style.transform='scale(0.98)'" ontouchend="this.style.transform='scale(1)'">\n              \n              \x3c!-- HEADER: Nombre y Stock --\x3e\n              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; gap: 12px;">\n                <div style="flex: 1; min-width: 0;">\n                  <div style="font-weight: 700; font-size: 0.95rem; color: var(--text-primary); margin-bottom: 4px; word-wrap: break-word;">\n                    ${e.nombre}\n                  </div>\n                  ${e.tipo?`<div style="font-size: 0.75rem; color: var(--text-secondary);">${e.tipo}</div>`:""}\n                </div>\n                \x3c!-- Stock 3 valores: Mnimo/Actual/ptimo --\x3e\n                <div style="\n                  background: #334155;\n                  border-left: 3px solid ${s};\n                  border-radius: 6px;\n                  padding: 8px;\n                  min-width: 160px;\n                ">\n                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; text-align: center;">\n                    <div>\n                      <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-secondary);">Mn</div>\n                      <div style="font-weight: 700; color: #C75300; font-size: 0.95rem;">${t}</div>\n                    </div>\n                    <div style="background: rgba(91,124,153,0.2); padding: 4px; border-radius: 4px;">\n                      <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-secondary);">Act</div>\n                      <div style="font-weight: 700; color: ${s}; font-size: 1.1rem;">${a}</div>\n                    </div>\n                    <div>\n                      <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-secondary);">pt</div>\n                      <div style="font-weight: 700; color: #527853; font-size: 0.95rem;">${n}</div>\n                    </div>\n                  </div>\n                  <div style="font-size: 0.65rem; color: ${s}; font-weight: 600; margin-top: 4px; text-align: center;">${r}</div>\n                </div>\n              </div>\n\n              \x3c!-- BARRA DE PROGRESO --\x3e\n              <div style="\n                width: 100%;\n                height: 6px;\n                background: rgba(100, 116, 139, 0.2);\n                border-radius: 3px;\n                overflow: hidden;\n                margin-bottom: 10px;\n              ">\n                <div style="\n                  width: ${i}%;\n                  height: 100%;\n                  background: ${s};\n                  transition: width 0.3s ease;\n                "></div>\n              </div>\n\n              \x3c!-- INFO: Cdigos y Ubicacin --\x3e\n              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; font-size: 0.8rem;">\n                <div style="background: var(--bg-primary); padding: 6px 8px; border-radius: 6px;">\n                  <div style="color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 2px;">Cd. SAP</div>\n                  <div style="font-weight: 600; color: var(--primary);">${e.codSAP||"N/A"}</div>\n                </div>\n                <div style="background: var(--bg-primary); padding: 6px 8px; border-radius: 6px;">\n                  <div style="color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 2px;">Cd. Prov</div>\n                  <div style="font-weight: 600; color: var(--info);">${e.codProv||"N/A"}</div>\n                </div>\n              </div>\n\n              <div style="display: flex; gap: 6px; margin-bottom: 12px; font-size: 0.75rem; flex-wrap: wrap;">\n                <span style="background: var(--bg-primary); padding: 4px 8px; border-radius: 6px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px;">\n                  <span style="display: inline-block; width: 6px; height: 6px; background: #5B7C99; border-radius: 50%;"></span>\n                  ${e.area||"Sin rea"}\n                </span>\n                <span style="background: var(--bg-primary); padding: 4px 8px; border-radius: 6px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px;">\n                  <span style="display: inline-block; width: 6px; height: 6px; background: #C75300; border-radius: 50%;"></span>\n                  ${e.equipo||"Sin equipo"}\n                </span>\n                ${e.ultimoConteo?`\n                <span style="background: var(--bg-primary); padding: 4px 8px; border-radius: 6px; color: var(--text-secondary); font-size: 0.7rem;">\n                  Contado: ${new Date(e.ultimoConteo).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit"})}\n                </span>\n                `:""}\n              </div>\n\n              \x3c!-- BOTONES DE ACCIN CORPORATIVOS --\x3e\n              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">\n                <button \n                  onclick="app.abrirModalConteoIndividual('${e.id}')"\n                  style="\n                    background: linear-gradient(135deg, #527853, #3d5a3e);\n                    color: white;\n                    border: none;\n                    padding: 12px 8px;\n                    border-radius: 8px;\n                    font-weight: 600;\n                    font-size: 0.85rem;\n                    cursor: pointer;\n                    transition: all 0.2s;\n                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n                  "\n                  ontouchstart="this.style.transform='scale(0.95)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'"\n                  ontouchend="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'"\n                >\n                  Contar\n                </button>\n                <button \n                  onclick="app.editarRepuesto('${e.id}')"\n                  style="\n                    background: linear-gradient(135deg, #004d73, #003B5C);\n                    color: white;\n                    border: none;\n                    padding: 12px 8px;\n                    border-radius: 8px;\n                    font-weight: 600;\n                    font-size: 0.85rem;\n                    cursor: pointer;\n                    transition: all 0.2s;\n                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n                  "\n                  ontouchstart="this.style.transform='scale(0.95)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'"\n                  ontouchend="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'"\n                >\n                  Editar\n                </button>\n                <button \n                  onclick="app.deleteRepuesto('${e.id}')"\n                  style="\n                    background: linear-gradient(135deg, #8B5A5A, #6B4444);\n                    color: white;\n                    border: none;\n                    padding: 12px 8px;\n                    border-radius: 8px;\n                    font-weight: 600;\n                    font-size: 0.85rem;\n                    cursor: pointer;\n                    transition: all 0.2s;\n                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n                  "\n                  ontouchstart="this.style.transform='scale(0.95)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'"\n                  ontouchend="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'"\n                >\n                  Eliminar\n                </button>\n              </div>\n\n              ${e.ultimoConteo?`\n                <div style="\n                  margin-top: 10px;\n                  padding: 6px 8px;\n                  background: rgba(59, 130, 246, 0.1);\n                  border-radius: 6px;\n                  font-size: 0.7rem;\n                  color: var(--text-secondary);\n                  text-align: center;\n                ">\n                   ltimo conteo: ${new Date(e.ultimoConteo).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"2-digit"})}\n                  ${new Date(e.ultimoConteo).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}\n                </div>\n              `:'\n                <div style="\n                  margin-top: 10px;\n                  padding: 6px 8px;\n                  background: rgba(245, 158, 11, 0.1);\n                  border-radius: 6px;\n                  font-size: 0.7rem;\n                  color: var(--warning);\n                  text-align: center;\n                ">\n                   An no se ha contado este repuesto\n                </div>\n              '}\n            </div>\n          `}).join("")}\n      </div>\n    `;const o=document.getElementById("pagination");o&&(o.style.display="none")}sortList(e){this.listSortField===e?this.listSortOrder="asc"===this.listSortOrder?"desc":"asc":(this.listSortField=e,this.listSortOrder="asc"),this.render();const t="asc"===this.listSortOrder?"Ascendente ":"Descendente ",a={codSAP:"Cdigos",nombre:"Nombre",area:"rea",equipo:"Equipo",stock:"Stock",stockPercent:"Stock %"}[e]||e;this.showToast(`Ordenando por: ${a} (${t})`,"info",2e3)}setupColumnResize(){const e=document.getElementById("listHeader");if(!e)return;const t=e.querySelectorAll(".resize-handle");let a=!1,n=null,i=0,s=0,r=null,o=null;const l=localStorage.getItem("inventario_columnWidths");if(l)try{this.columnWidths=JSON.parse(l)}catch(d){}t.forEach(t=>{t.addEventListener("mousedown",l=>{l.stopPropagation(),a=!0,n=t,o=parseInt(t.dataset.col),r=e.children[o],i=l.pageX,s=r.offsetWidth,e.classList.add("resizing"),t.classList.add("resizing"),document.body.style.cursor="col-resize",document.body.style.userSelect="none"})});document.addEventListener("mousemove",t=>{if(!a)return;const n=t.pageX-i,r=Math.max(50,s+n);this.columnWidths[o]=`${r}px`;const l=this.columnWidths.join(" ");e.style.gridTemplateColumns=l,document.querySelectorAll(".list-row").forEach(e=>{e.style.gridTemplateColumns=l})}),document.addEventListener("mouseup",()=>{if(a){a=!1,e.classList.remove("resizing"),n&&n.classList.remove("resizing"),document.body.style.cursor="",document.body.style.userSelect="";try{localStorage.setItem("inventario_columnWidths",JSON.stringify(this.columnWidths))}catch(d){}n=null,r=null,o=null}})}updatePagination(){const e=this.getItemsPerPage(),t=Math.ceil(this.filteredRepuestos.length/e),a=this.filteredRepuestos.length,n=(this.currentPage-1)*e+1,i=Math.min(this.currentPage*e,a),s=document.getElementById("pagination"),r=document.getElementById("pageNumbers"),o=document.getElementById("btnPrevPage"),l=document.getElementById("btnNextPage"),d=document.getElementById("btnFirstPage"),c=document.getElementById("btnLastPage"),p=document.getElementById("itemsPerPageSelect"),u=document.getElementById("itemsPerPageInfo"),m=document.getElementById("jumpToPage");if(m&&(m.max=t,m.placeholder=`1-${t}`),p&&(p.value=this.itemsPerPage),u&&"auto"===this.itemsPerPage){const t=window.innerWidth;let a=t<768?"Mvil":t<1200?"Tablet":t<1600?"Desktop":t<1920?"Ultra-wide":"4K";u.textContent=`(${e} items - ${a})`,u.style.display="inline"}else u&&(u.style.display="none");if(s&&(s.style.display="flex"),!r)return;o&&(o.disabled=1===this.currentPage),l&&(l.disabled=this.currentPage===t),d&&(d.disabled=1===this.currentPage),c&&(c.disabled=this.currentPage===t);let h=[];h=t<=7?Array.from({length:t},(e,t)=>t+1):this.currentPage<=4?[1,2,3,4,5,"...",t]:this.currentPage>=t-3?[1,"...",t-4,t-3,t-2,t-1,t]:[1,"...",this.currentPage-1,this.currentPage,this.currentPage+1,"...",t],r.innerHTML=h.map(e=>{if("..."===e)return'<span style="color: var(--text-secondary); padding: 0 12px; opacity: 0.6; font-weight: 600;"></span>';const t=e===this.currentPage;return`\n        <button \n          onclick="app.goToPage(${e})" \n          class="btn page-number-btn ${t?"btn-primary page-active":"btn-secondary"}"\n          ${t?"disabled":""}\n        >\n          ${e}\n        </button>\n      `}).join("")+`\n      <span class="pagination-status">\n        ${n}-${i} de ${a}\n      </span>\n    `}goToPage(e){const t=this.getItemsPerPage(),a=Math.ceil(this.filteredRepuestos.length/t);this.currentPage="last"===e?a:Math.max(1,Math.min(e,a)),this.renderInventario(),window.scrollTo({top:0,behavior:"smooth"})}nextPage(){const e=this.getItemsPerPage(),t=Math.ceil(this.filteredRepuestos.length/e);this.currentPage<t&&(this.currentPage++,this.renderInventario(),window.scrollTo({top:0,behavior:"smooth"}))}previousPage(){this.currentPage>1&&(this.currentPage--,this.renderInventario(),window.scrollTo({top:0,behavior:"smooth"}))}jumpToPage(){const e=document.getElementById("jumpToPage"),t=parseInt(e.value);if(!t||isNaN(t))return void alert("Por favor ingresa un nmero de pgina vlido");const a=this.getItemsPerPage(),n=Math.ceil(this.filteredRepuestos.length/a);t<1||t>n?alert(`El nmero de pgina debe estar entre 1 y ${n}`):(this.currentPage=t,this.renderInventario(),window.scrollTo({top:0,behavior:"smooth"}),e.value="")}async openModal(e,t=null){this.currentEditingId=t,this.currentMultimedia=[],this.currentDocuments=[];const a=document.getElementById("modalEyebrow"),i=document.getElementById("modalSubtitle"),s=document.getElementById("modalLastUpdate"),r=document.getElementById("modalMultimediaCount");a&&(a.textContent="edit"===e?"Actualizacin de inventario":"Nuevo registro"),i&&(i.textContent="edit"===e?"Revisa cantidades, ubicaciones y multimedia antes de confirmar los cambios.":"Completa los campos obligatorios marcados con * y define al menos una ubicacin corporativa."),s&&(s.textContent="edit"===e?"Sin registro":"Se generar al guardar"),r&&(r.textContent="Sin archivos",r.classList.add("sap-meta-chip--empty")),this.refreshModalMultimediaBadge(),document.getElementById("modalTitle").textContent="edit"===e?"Editar Repuesto":"Agregar Repuesto",document.getElementById("repuestoForm").reset(),this.initWizard({focusFirstField:!1});const o=document.getElementById("imagePreview"),l=document.getElementById("documentsList");o&&(o.innerHTML="",setTimeout(()=>{o.innerHTML=""},10)),l&&(l.innerHTML="",setTimeout(()=>{l.innerHTML=""},10));const d=document.getElementById("btnGuardarRepuesto"),c=null==d?void 0:d.querySelector(".btn-text"),p=null==d?void 0:d.querySelector(".btn-loading");d&&c&&p&&(d.disabled=!1,d.style.opacity="1",d.style.cursor="pointer",c.style.display="inline",p.style.display="none"),this.ubicacionesActuales=[];if("edit"===e&&t){let e=this.repuestos.find(e=>{const a=String(t).trim(),n=String(e.id).trim();return e.id===t||(e.id==t||(n===a||n.replace(/\s+/g,"")===a.replace(/\s+/g,"")))});if(!e&&this.repuestos.length<100&&this.repuestos.forEach((e,t)=>{}),e){document.getElementById("repuestoId").value=e.id,document.getElementById("codSAP").value=e.codSAP||"",document.getElementById("codProv").value=e.codProv||"",document.getElementById("tipo").value=e.tipo||"",document.getElementById("categoria").value=e.categoria||"",document.getElementById("nombre").value=e.nombre||"",e.ubicaciones&&Array.isArray(e.ubicaciones)&&e.ubicaciones.length>0?this.ubicacionesActuales=e.ubicaciones.map(e=>({id:Date.now()+Math.random(),areaGeneral:e.areaGeneral||"",subArea:e.subArea||"",sistemaEquipo:e.sistemaEquipo||"",subSistema:e.subSistema||"",seccion:e.seccion||"",detalle:e.detalle||""})):this.ubicacionesActuales=[{id:Date.now(),areaGeneral:e.areaGeneral||e.area||"",subArea:e.subArea||"",sistemaEquipo:e.sistemaEquipo||e.equipo||"",subSistema:e.subSistema||e.sistema||"",seccion:e.seccion||"",detalle:e.detalle||e.detalleUbicacion||""}],this.usarVersionCascada?this.renderUbicacionesCascada():this.renderUbicaciones(),document.getElementById("cantidad").value=e.cantidad||0,document.getElementById("cantidadInstalada").value=e.cantidadInstalada||0,document.getElementById("minimo").value=e.minimo||e.stockMinimo||5,document.getElementById("optimo").value=e.optimo||10,document.getElementById("precio").value=e.precio||0,document.getElementById("datosTecnicos").value=e.datosTecnicos||"";const t=e.multimedia||[];if(s){const t=(e=>{if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t.toLocaleString("es-CL",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})})(e.ultimaModificacion||e.fechaActualizacion||e.updatedAt);s.textContent=t||"Sin registro"}if(t.length>0){const a=t.map((e,t)=>this.normalizeMultimediaItem(e,t));e.multimedia=a;const i=n&&n.isFileSystemMode;this.currentMultimedia=a.filter(e=>{if(!e||!e.type)return!1;const t=e.type.toLowerCase();return("image"===t||"video"===t)&&(!i||"string"!=typeof e.url||!e.url.startsWith("data:image"))}),this.currentDocuments=a.filter(e=>!(!e||!e.type)&&"document"===e.type.toLowerCase()),this.refreshModalMultimediaBadge(),i&&0===this.currentMultimedia.length&&a.some(e=>"image"===e.type),await this.updateMultimediaPreview()}else this.refreshModalMultimediaBadge()}else this.showToast(" Error: Repuesto no encontrado","error")}else this.agregarUbicacion(),this.refreshModalMultimediaBadge();document.getElementById("modal").classList.add("active"),this.addEscapeListener(),this.setupEnterNavigation(),setTimeout(()=>{this.ajustarAnchoModal(),this.setWizardStep(1,{focusFirstField:!1})},120)}closeModal(){document.getElementById("modal").classList.remove("active"),this.removeEscapeListener(),this.removeEnterNavigation()}setupEnterNavigation(){const e=document.getElementById("repuestoForm");if(!e)return;this.enterNavigationHandler=t=>{if("Enter"!==t.key)return;if("TEXTAREA"===t.target.tagName)return;t.preventDefault();const a=Array.from(e.querySelectorAll('input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled])')).filter(e=>null!==e.offsetParent),n=a.indexOf(t.target);n>-1&&n<a.length-1?a[n+1].focus():t.target.blur()},e.addEventListener("keydown",this.enterNavigationHandler)}removeEnterNavigation(){const e=document.getElementById("repuestoForm");e&&this.enterNavigationHandler&&e.removeEventListener("keydown",this.enterNavigationHandler)}updateUbicacionPreview(){const e=document.getElementById("area").value.trim(),t=document.getElementById("equipo").value.trim(),a=document.getElementById("sistema").value,n=document.getElementById("detalleUbicacion").value.trim(),i=document.getElementById("ubicacionPreview"),s=document.getElementById("ubicacionPreviewText"),r=[];e&&r.push(e),t&&r.push(t),a&&r.push(a),n&&r.push(n),r.length>0?(s.innerHTML=r.map((e,t)=>`<span style="display: inline-flex; align-items: center; gap: 4px;"><span>${["","","",""][t]||""}</span><span>${e}</span></span>`).join(' <span style="color: var(--primary); font-weight: bold;"></span> '),i.style.display="block"):i.style.display="none"}cargarSistemasPorEquipo(e){const t=document.getElementById("sistemaDatalist");if(!t)return;let a=[...this.sistemaPorEquipo[e]||this.sistemaPorEquipo.default,...this.customSistemas[e]||[]];a=[...new Set(a)],a.sort((e,t)=>"Otro"===e?1:"Otro"===t?-1:e.localeCompare(t,"es")),t.innerHTML="",a.forEach(e=>{const a=document.createElement("option");a.value=e,t.appendChild(a)})}async compressImageToBlob(e,t=800,a=.85){return new Promise(n=>{const i=new FileReader;i.onload=e=>{const i=new Image;i.onload=()=>{const e=document.createElement("canvas");let s=i.width,r=i.height;(s>t||r>t)&&(s>r?(r=r*t/s,s=t):(s=s*t/r,r=t)),e.width=s,e.height=r;const o=e.getContext("2d");o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.fillStyle="#FFFFFF",o.fillRect(0,0,s,r),o.drawImage(i,0,0,s,r),e.toBlob(e=>{n(e||null)},"image/webp",a)},i.onerror=()=>{n(null)},i.src=e.target.result},i.onerror=()=>{n(null)},i.readAsDataURL(e)})}async compressImage(e,t=800,a=.85){return new Promise(n=>{const i=new FileReader;i.onload=e=>{const i=new Image;i.onload=()=>{const e=document.createElement("canvas");let s=i.width,r=i.height;(s>t||r>t)&&(s>r?(r=r*t/s,s=t):(s=s*t/r,r=t)),e.width=s,e.height=r;const o=e.getContext("2d");o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.fillStyle="#FFFFFF",o.fillRect(0,0,s,r),o.drawImage(i,0,0,s,r);let l=null,d="webp";try{l=e.toDataURL("image/webp",a),(!l.startsWith("data:image/webp")||l.length>12e4)&&(d="jpeg",l=e.toDataURL("image/jpeg",a))}catch(u){d="jpeg",l=e.toDataURL("image/jpeg",a)}let c=a,p=0;for(;l.length>1e5&&c>.5&&p<5;)c-=.08,l=e.toDataURL(`image/${d}`,c),p++;(l.length/1024).toFixed(1);n(l)},i.onerror=()=>{n(null)},i.src=e.target.result},i.onerror=()=>{n(null)},i.readAsDataURL(e)})}async handleImageWithOptimizer(e){const t=Array.from(e.target.files);if(0!==t.length){for(const e of t)await this.showOptimizerModal(e);e.target.value=""}}async showOptimizerModal(e){return this.currentImageFile=e,new Promise(t=>{const a=document.getElementById("optimizerModal"),n=document.getElementById("optimizerOriginal");document.getElementById("optimizerOptimized");const i=document.getElementById("originalSize"),s=document.getElementById("originalDimensions");a.classList.add("active");const r=new FileReader;r.onload=async a=>{const r=new Image;r.onload=async()=>{n.src=a.target.result,i.textContent=`Tamao: ${(e.size/1024).toFixed(1)} KB`,s.textContent=`${r.width}  ${r.height} px`,await this.updateOptimizedPreview(a.target.result,r.width,r.height),this.optimizerResolve=t},r.src=a.target.result},r.readAsDataURL(e)})}async updateOptimizedPreview(e,t,a){const n=document.getElementById("optimizerOptimized"),i=document.getElementById("optimizedSize"),s=document.getElementById("optimizedDimensions"),r=document.getElementById("savingsBadge"),o=document.createElement("canvas"),l=o.getContext("2d"),d=new Image;d.onload=()=>{let e=t,c=a;if("original"!==this.currentOptimizeSize){const t=this.currentOptimizeSize;(e>t||c>t)&&(e>c?(c=c/e*t,e=t):(e=e/c*t,c=t))}o.width=e,o.height=c,l.drawImage(d,0,0,e,c);const p=o.toDataURL("image/webp",this.currentQuality);n.src=p;const u=.75*p.length,m=this.currentImageFile.size,h=((m-u)/m*100).toFixed(1);i.textContent=`Tamao: ${(u/1024).toFixed(1)} KB`,s.textContent=`${Math.round(e)}  ${Math.round(c)} px`,r.innerHTML=`Ahorro: <strong>${h}%</strong>`,r.style.background=h>50?"var(--success)":h>30?"var(--warning)":"var(--danger)",this.currentOptimizedDataUrl=p},d.src=e}setOptimizeSize(e){this.currentOptimizeSize=e,document.querySelectorAll(".size-btn").forEach(t=>{t.classList.remove("active"),t.dataset.size==e&&t.classList.add("active")});const t=document.getElementById("optimizerOriginal");if(t.src){const e=new Image;e.onload=()=>{this.updateOptimizedPreview(t.src,e.width,e.height)},e.src=t.src}}updateQuality(e){this.currentQuality=e/100,document.getElementById("qualityValue").textContent=e+"%";const t=document.getElementById("optimizerOriginal");if(t.src){const e=new Image;e.onload=()=>{this.updateOptimizedPreview(t.src,e.width,e.height)},e.src=t.src}}async applyOptimization(){var e,t;document.getElementById("optimizerModal").style.display="none";const a=await this.dataURLtoBlob(this.currentOptimizedDataUrl);this.currentMultimedia||(this.currentMultimedia=[]);if(n&&n.isFileSystemMode){const i=Date.now(),s=(null==(e=document.getElementById("codSAP"))?void 0:e.value)||"SAP",r=(null==(t=document.getElementById("nombre"))?void 0:t.value)||"REPUESTO",o=this.currentMultimedia.length+1,l=`${i}_${s.replace(/[^a-zA-Z0-9]/g,"_").substring(0,20)}_${r.replace(/[^a-zA-Z0-9]/g,"_").substring(0,30)}_foto${o}.webp`,d=await n.saveImage(a,l);if(d){const e={type:"image",url:d,name:this.currentImageFile.name,size:a.size,isFileSystem:!0};this.currentMultimedia.push(e)}}else{URL.createObjectURL(a);const e={type:"image",url:this.currentOptimizedDataUrl,name:this.currentImageFile.name,size:a.size,blob:a};this.currentMultimedia.push(e)}await this.updateMultimediaPreview(),this.showToast(`Imagen optimizada agregada (${(a.size/1024).toFixed(1)} KB)`,"success"),this.optimizerResolve&&this.optimizerResolve()}skipOptimization(){document.getElementById("optimizerModal").style.display="none";const e=new FileReader;e.onload=async e=>{var t,a;this.currentMultimedia||(this.currentMultimedia=[]);if(n&&n.isFileSystemMode){const e=Date.now(),n=(null==(t=document.getElementById("codSAP"))?void 0:t.value)||"SAP",i=(null==(a=document.getElementById("nombre"))?void 0:a.value)||"REPUESTO",s=this.currentMultimedia.length+1,r=`${e}_${n.replace(/[^a-zA-Z0-9]/g,"_").substring(0,20)}_${i.replace(/[^a-zA-Z0-9]/g,"_").substring(0,30)}_foto${s}.${this.currentImageFile.name.split(".").pop()}`,o=await this.fsManager.saveImage(this.currentImageFile,r);o&&this.currentMultimedia.push({type:"image",url:o,name:this.currentImageFile.name,size:this.currentImageFile.size,isFileSystem:!0})}else this.currentMultimedia.push({type:"image",url:e.target.result,name:this.currentImageFile.name,size:this.currentImageFile.size,blob:this.currentImageFile});this.updateImagePreview(),this.showToast("Imagen original agregada","info"),this.optimizerResolve&&this.optimizerResolve()},e.readAsDataURL(this.currentImageFile)}closeOptimizer(){document.getElementById("optimizerModal").classList.remove("active"),this.optimizerResolve&&this.optimizerResolve()}dataURLtoBlob(e){return new Promise(t=>{const a=e.split(","),n=a[0].match(/:(.*?);/)[1],i=atob(a[1]);let s=i.length;const r=new Uint8Array(s);for(;s--;)r[s]=i.charCodeAt(s);t(new Blob([r],{type:n}))})}updateImagePreview(){const e=document.getElementById("imagePreview");if(!this.currentMultimedia||0===this.currentMultimedia.filter(e=>"image"===e.type).length)return e.innerHTML="",void this.refreshModalMultimediaBadge();const t=this.currentMultimedia.filter(e=>"image"===e.type);e.innerHTML=t.map((e,t)=>`\n      <div class="preview-item">\n        <img src="${e.url}" alt="Preview ${t+1}">\n        <button type="button" class="preview-delete" onclick="app.removeMultimedia(${t})"></button>\n        <div class="preview-info">${(e.size/1024).toFixed(1)} KB</div>\n      </div>\n    `).join(""),this.refreshModalMultimediaBadge()}async handleMultimedia(e,t){var a,s;const r=Array.from(e.target.files);if(0!==r.length)if("image"===t){this.currentMultimedia||(this.currentMultimedia=[]);const t=document.getElementById("imagePreview"),l=n&&n.isFileSystemMode,d="indexeddb"===this.storageMode;let c="Optimizando imgenes...";l?c="Guardando en carpeta...":d&&(c=" Guardando en IndexedDB..."),t.innerHTML=`<div style="padding: 16px; color: var(--primary); font-weight: 600;"> ${c}</div>`,r.length>5&&this.showToast(`Procesando ${r.length} imgenes...`,"info");let p=0,u=0,m=0;for(const e of r)try{if(p+=e.size,l){const t=await this.compressImageToBlob(e);if(t){const n=Date.now(),i=(null==(a=document.getElementById("codSAP"))?void 0:a.value)||"SAP",r=(null==(s=document.getElementById("nombre"))?void 0:s.value)||"REPUESTO",o=this.currentMultimedia.length+1,l=i.replace(/[^a-zA-Z0-9]/g,"_").substring(0,20),d=`${n}_${l}_${r.replace(/[^a-zA-Z0-9]/g,"_").substring(0,30)}_foto${o}.webp`,c=await this.fsManager.saveImage(t,d);if(c){this.currentMultimedia.some(a=>{if(a.name===e.name)return!0;if(a.url===c)return!0;const n=Math.abs(a.size-t.size)<1e3,i=a.name&&e.name&&a.name.toLowerCase().replace(/\.[^/.]+$/,"")===e.name.toLowerCase().replace(/\.[^/.]+$/,"");return n&&i})||(this.currentMultimedia.push({type:"image",url:c,name:e.name,size:t.size,isFileSystem:!0}),u+=t.size,m++)}}}else if(d){const t=await this.compressImageToBlob(e);if(t){const a=Date.now(),n=`img_${a}_${e.name.replace(/[^a-zA-Z0-9._-]/g,"_")}`,s=this.currentEditingId||"temp";await i.saveImage(n,s,t);this.currentMultimedia.some(a=>{if(a.url===n)return!0;if(a.name===e.name)return!0;const i=Math.abs(a.size-t.size)<1e3,s=a.name&&e.name&&a.name.toLowerCase().replace(/\.[^/.]+$/,"")===e.name.toLowerCase().replace(/\.[^/.]+$/,"");return i&&s})||(this.currentMultimedia.push({type:"image",url:n,name:e.name,size:t.size,isIndexedDB:!0}),u+=t.size,m++)}}else{const t=await this.compressImage(e);if(t){this.currentMultimedia.some(a=>{if(a.name===e.name)return!0;const n=Math.abs((a.size||0)-t.length)<5e3,i=a.name&&e.name&&a.name.toLowerCase().replace(/\.[^/.]+$/,"")===e.name.toLowerCase().replace(/\.[^/.]+$/,"");return n&&i})||(u+=t.length,this.currentMultimedia.push({type:"image",url:t,name:e.name,size:t.length}),m++)}}}catch(o){this.showToast(` Error con ${e.name}`,"error")}(100*(1-u/p)).toFixed(0),(u/1048576).toFixed(2);e.target.value="",await this.updateMultimediaPreview();const h=d?" Mvil":l?" PC":" Local";this.showToast(` ${m} imagen(es) guardadas [${h}] - Total: ${this.currentMultimedia.length}`,"success")}else if("document"===t){this.currentDocuments||(this.currentDocuments=[]);let t=r.length,a=0;r.forEach(e=>{if(e.size>4194304)return this.showToast(` ${e.name} muy grande (mx 4MB)`,"error"),t--,void(0===t&&this.refreshModalMultimediaBadge());const n=new FileReader;n.onload=n=>{this.currentDocuments.push({type:"document",url:n.target.result,name:e.name,size:e.size,mimeType:e.type}),a++,t--,0===t&&(this.showToast(` ${a} documento(s) agregado(s) - Total: ${this.currentDocuments.length}`,"success"),this.refreshModalMultimediaBadge())},n.readAsDataURL(e)}),t<=0&&this.refreshModalMultimediaBadge(),e.target.value=""}}refreshModalMultimediaBadge(){const e=document.getElementById("modalMultimediaCount");if(!e)return;const t=(this.currentMultimedia||[]).filter(e=>"image"===e.type).length,a=(this.currentDocuments||[]).length,n=t+a;if(0===n)return e.textContent="Sin archivos",void e.classList.add("sap-meta-chip--empty");const i=[];let s;t&&i.push(`${t} img`),a&&i.push(`${a} doc`),1===n?s=t?"1 archivo (1 img)":"1 archivo (1 doc)":(s=`${n} archivos`,i.length&&(s+=` (${i.join("  ")})`)),e.textContent=s,e.classList.remove("sap-meta-chip--empty")}async updateMultimediaPreview(e=null){const t=document.getElementById("imagePreview");if(!t)return;if(e)return void(t.innerHTML=`<div style="padding: 16px; color: var(--primary); font-weight: 600;"> ${e}</div>`);if(!this.currentMultimedia||0===this.currentMultimedia.length)return t.innerHTML='<div style="padding: 16px; color: var(--text-secondary); font-size: 0.85rem;"> No hay imgenes cargadas. Usa el botn "Click para seleccionar imgenes" arriba.</div>',void this.refreshModalMultimediaBadge();const a=[],n=new Set;this.currentMultimedia.forEach(e=>{const t=e.url||e.name||Math.random();n.has(t)||(n.add(t),a.push(e))}),this.currentMultimedia=a;const i=[];for(let r=0;r<this.currentMultimedia.length;r++){const e=this.currentMultimedia[r];try{const t=await this.getImageUrl(e);if(!t){i.push('\n            <div style="position: relative; display: inline-block; margin: 5px; width: 120px; height: 120px; background: rgba(255,0,0,0.1); border-radius: 8px; border: 2px dashed var(--danger); display: flex; align-items: center; justify-content: center;">\n              <div style="text-align: center; font-size: 0.7rem; color: var(--danger);">\n                <div style="font-size: 1.5rem;"></div>\n                <div>Error</div>\n              </div>\n            </div>\n          ');continue}const a=e.size?(e.size/1024).toFixed(0):"??",n=t.includes(".webp")||t.startsWith("data:image/webp")||t.startsWith("blob:")?"WebP":"JPEG",s="WebP"===n?"var(--success)":"var(--info)";i.push(`\n          <div style="position: relative; display: inline-block; margin: 5px;">\n            <img src="${t}" \n                 style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid var(--gray-300); box-shadow: 0 2px 8px rgba(0,0,0,0.1);"\n                 onload="console.log(' [IMG] Cargada en DOM: ${e.name||"img-"+r}')"\n                 onerror="console.error(' [IMG] Error en DOM:', this.src.substring(0,50)); this.style.border='2px solid red';">\n            <button onclick="app.removeMultimedia(${r})" type="button" \n                    style="position: absolute; top: 4px; right: 4px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); line-height: 1;"></button>\n            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 4px 6px; border-radius: 4px; font-size: 0.7rem; display: flex; justify-content: space-between; align-items: center;">\n              <span style="font-weight: 600;">${a}KB</span>\n              <span style="background: ${s}; padding: 2px 6px; border-radius: 3px; font-size: 0.65rem; font-weight: 700;">${n}</span>\n            </div>\n          </div>\n        `)}catch(s){i.push('\n          <div style="position: relative; display: inline-block; margin: 5px; width: 120px; height: 120px; background: rgba(255,0,0,0.1); border-radius: 8px; border: 2px dashed var(--danger); display: flex; align-items: center; justify-content: center;">\n            <div style="text-align: center; font-size: 0.7rem; color: var(--danger);">\n              <div style="font-size: 1.5rem;"></div>\n              <div>Error</div>\n            </div>\n          </div>\n        ')}}0===i.length?t.innerHTML='<div style="padding: 16px; color: var(--danger); font-size: 0.85rem;"> No se pudieron cargar las imgenes.</div>':t.innerHTML=i.join(""),this.refreshModalMultimediaBadge()}async removeMultimedia(e){if(this.currentMultimedia&&this.currentMultimedia[e]){const t=this.currentMultimedia[e];if(t.isFileSystem&&t.url&&n.isFileSystemMode){await n.deleteImage(t.url)}this.currentMultimedia.splice(e,1),await this.updateMultimediaPreview(),this.showToast(" Imagen eliminada","success")}}sincronizarUbicacionesDesdeDOM(){Array.isArray(this.ubicacionesActuales)&&this.ubicacionesActuales.forEach((e,t)=>{if(!e||!e.id)return;document.querySelectorAll(`[data-ubicacion-id="${e.id}"]`).forEach(t=>{const a=t.dataset.field;a&&(e[a]=t.value)})})}async saveRepuesto(e){var t,a;if(e.preventDefault(),this.wizardState&&this.wizardState.totalSteps){const e=this.wizardState.totalSteps,t=this.wizardState.currentStep||1;if(t<e){if(this.validateWizardStep(t))this.setWizardStep(t+1);else{const e=this.wizardState.lastValidationError;"ubicaciones-vacias"===(null==e?void 0:e.type)?this.showToast("Agrega al menos una ubicacin corporativa antes de continuar.","warning"):this.showToast("Completa los campos obligatorios antes de continuar.","warning")}return}for(let a=1;a<=e;a++){const e=a===t;if(!this.validateWizardStep(a,{reportValidity:e})){const e=this.getWizardStepName(a);this.setWizardStep(a,{focusFirstField:!0});const t=this.wizardState.lastValidationError;return void("ubicaciones-vacias"===(null==t?void 0:t.type)?this.showToast("Define al menos un rea General antes de guardar.","warning"):this.showToast(`Revisa los pendientes en "${e}".`,"warning"))}}}const i=document.getElementById("btnGuardarRepuesto"),s=i.querySelector(".btn-text"),r=i.querySelector(".btn-loading");i.disabled=!0,i.style.opacity="0.7",i.style.cursor="wait",s.style.display="none",r.style.display="inline-flex",r.style.alignItems="center";try{const e=this.currentEditingId||Date.now().toString()+Math.random(),o=[...this.currentMultimedia||[],...this.currentDocuments||[]];let l=null;if(this.currentEditingId){const e=this.repuestos.find(e=>e.id===this.currentEditingId);e&&e.ubicaciones&&(l=JSON.parse(JSON.stringify(e.ubicaciones)))}this.sincronizarUbicacionesDesdeDOM(),this.ubicacionesActuales.forEach((e,t)=>{});const d=this.ubicacionesActuales.filter(e=>e.areaGeneral&&""!==e.areaGeneral.trim());if(0===d.length)return i.disabled=!1,i.style.opacity="1",i.style.cursor="pointer",s.style.display="inline",r.style.display="none",void this.showToast(" Debes especificar al menos un rea General","error");const c=d.map((e,t)=>{const a={};return e.areaGeneral&&(a.areaGeneral=e.areaGeneral.trim()),e.subArea&&e.subArea.trim()&&(a.subArea=e.subArea.trim()),e.sistemaEquipo&&e.sistemaEquipo.trim()&&(a.sistemaEquipo=e.sistemaEquipo.trim()),e.subSistema&&e.subSistema.trim()&&(a.subSistema=e.subSistema.trim()),e.seccion&&e.seccion.trim()&&(a.seccion=e.seccion.trim()),e.subSeccion&&e.subSeccion.trim()&&(a.subSeccion=e.subSeccion.trim()),e.detalle&&e.detalle.trim()&&(a.detalle=e.detalle.trim()),e.mapId&&(a.mapId=e.mapId),e.areaId&&(a.areaId=e.areaId),void 0!==e.markerX&&(a.markerX=e.markerX),void 0!==e.markerY&&(a.markerY=e.markerY),e.descripcion&&e.descripcion.trim()&&(a.descripcion=e.descripcion.trim()),a});c.forEach(e=>{e.areaGeneral&&this.aprenderNuevaOpcion("areaGeneral",e.areaGeneral),e.subArea&&this.aprenderNuevaOpcion("subArea",e.subArea),e.sistemaEquipo&&this.aprenderNuevaOpcion("sistemaEquipo",e.sistemaEquipo),e.subSistema&&this.aprenderNuevaOpcion("subSistema",e.subSistema),e.seccion&&this.aprenderNuevaOpcion("seccion",e.seccion),e.subSeccion&&this.aprenderNuevaOpcion("subSeccion",e.subSeccion)}),this.sincronizarJerarquiaDesdeUbicaciones(c);const p=document.getElementById("tipo").value.trim(),u=document.getElementById("codProv").value.trim();p&&!this.autocompleteData.tipo.includes(p)&&(this.autocompleteData.tipo.push(p),this.autocompleteData.tipo.sort(),localStorage.setItem("autocompleteData",JSON.stringify(this.autocompleteData)),"configuracion"===this.currentTab&&this.renderListasGestion()),u&&!this.autocompleteData.codProv.includes(u)&&(this.autocompleteData.codProv.push(u),this.autocompleteData.codProv.sort(),localStorage.setItem("autocompleteData",JSON.stringify(this.autocompleteData)),"configuracion"===this.currentTab&&this.renderListasGestion());const m={id:e,codSAP:document.getElementById("codSAP").value,codProv:document.getElementById("codProv").value,tipo:document.getElementById("tipo").value,categoria:document.getElementById("categoria").value,nombre:document.getElementById("nombre").value,ubicaciones:c,planta:this.plantaBase,areaGeneral:c[0].areaGeneral||"",subArea:c[0].subArea||"",sistemaEquipo:c[0].sistemaEquipo||"",subSistema:c[0].subSistema||"",seccion:c[0].seccion||"",detalle:c[0].detalle||"",area:c[0].areaGeneral||"",equipo:c[0].sistemaEquipo||"",sistema:c[0].subSistema||"",detalleUbicacion:c[0].detalle||"",cantidad:parseInt(document.getElementById("cantidad").value)||0,cantidadInstalada:parseInt(document.getElementById("cantidadInstalada").value)||0,minimo:parseInt(document.getElementById("minimo").value)||5,optimo:parseInt(document.getElementById("optimo").value)||10,precio:parseFloat(document.getElementById("precio").value)||0,datosTecnicos:document.getElementById("datosTecnicos").value.trim()||"",multimedia:o,ultimaModificacion:(new Date).toISOString(),ultimoConteo:null};if(this.currentEditingId){const e=this.repuestos.findIndex(e=>e.id===this.currentEditingId);if(-1!==e){const i=this.repuestos[e];m.ultimoConteo=i.ultimoConteo||null,y("edit",{original:JSON.parse(JSON.stringify(i)),edited:JSON.parse(JSON.stringify(m))}),this.repuestos[e]=m;const s=1===c.length?"1 ubicacin afectada":`${c.length} ubicaciones afectadas`,r=0===o.length?"sin adjuntos":`${o.length} adjunto${1===o.length?"":"s"}`;if(this.showToast(` Repuesto actualizado  ${s}  ${r}`,"success"),l&&n.isFileSystemMode&&this.renombrarImagenesAutomaticamente){const n=null==(t=l[0])?void 0:t.areaGeneral,i=null==(a=c[0])?void 0:a.areaGeneral;n&&i&&n!==i&&(await this.moverImagenSiCambiaUbicacion(m,l,c),this.repuestos[e]=m,await this.saveData())}}}else{y("add",JSON.parse(JSON.stringify(m))),this.repuestos.unshift(m);const e=1===c.length?"1 ubicacin definida":`${c.length} ubicaciones definidas`,t=0===o.length?"sin adjuntos":`${o.length} adjunto${1===o.length?"":"s"}`;this.showToast(` Repuesto agregado  ${e}  ${t}`,"success")}await this.saveData(),this.updateAutocompleteData(),await this.render(),this.renderFilters(),this.closeModal()}catch(o){this.showToast(" Error al guardar: "+o.message,"error"),i.disabled=!1,i.style.opacity="1",i.style.cursor="pointer",s.style.display="inline",r.style.display="none"}}async deleteRepuesto(e){if(!confirm("Eliminar este repuesto?"))return;const t=this.repuestos.find(t=>t.id===e);if(t){if(y("delete",JSON.parse(JSON.stringify(t))),t.multimedia&&n.isFileSystemMode){const e=t.multimedia.filter(e=>"image"===e.type&&e.isFileSystem&&e.url).map(e=>e.url);if(e.length>0){await n.deleteMultipleImages(e)}}this.repuestos=this.repuestos.filter(t=>t.id!==e),await this.saveData(),await this.render(),this.renderFilters(),this.showToast(" Repuesto e imgenes eliminados","success")}}updateAutocompleteData(){const e=new Set,t=new Set,a=new Set,n=new Set,i=new Set,s=new Set,r=new Set,o=new Set,l=new Set;this.repuestos.forEach(d=>{d.codProv&&e.add(d.codProv),d.tipo&&t.add(d.tipo);const c=d.areaGeneral||d.area;c&&a.add(c),d.subArea&&n.add(d.subArea);const p=d.sistemaEquipo||d.equipo;p&&i.add(p);const u=d.subSistema||d.sistema;u&&s.add(u),d.seccion&&r.add(d.seccion),d.subSeccion&&o.add(d.subSeccion);const m=d.detalle||d.detalleUbicacion;m&&l.add(m)}),this.autocompleteData={codProv:Array.from(e).sort(),tipo:Array.from(t).sort(),areaGeneral:Array.from(a).sort(),subArea:Array.from(n).sort(),sistemaEquipo:Array.from(i).sort(),subSistema:Array.from(s).sort(),seccion:Array.from(r).sort(),subSeccion:Array.from(o).sort(),detalle:Array.from(l).sort()},this.renderListasGestion()}renderListasGestion(){[{id:"tipo",nombre:"Tipo",field:"tipo",esJerarquia:!1}].forEach(e=>{const t=document.getElementById(`lista${e.id.charAt(0).toUpperCase()+e.id.slice(1)}`);if(!t)return;const a=e.esJerarquia?this.opcionesJerarquia[e.field]||[]:this.autocompleteData[e.field]||[];0===a.length?t.innerHTML=`<div style="text-align: center; color: var(--text-secondary); padding: 10px;">No hay ${e.nombre.toLowerCase()}s registrados</div>`:t.innerHTML=a.map((t,a)=>`\n          <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--bg-secondary); margin-bottom: 4px; border-radius: 4px;">\n            <span style="color: var(--text-primary); font-size: 0.9rem; flex: 1;">${t}</span>\n            <div style="display: flex; gap: 4px;">\n              <button onclick="app.editarItemLista('${e.field}', ${a}, '${t.replace(/'/g,"\\'")}')" \n                      style="background: var(--info); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">\n                Editar\n              </button>\n              <button onclick="app.eliminarItemLista('${e.field}', '${t.replace(/'/g,"\\'")}')" \n                      style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">\n                Eliminar\n              </button>\n            </div>\n          </div>\n        `).join("")}),this.renderCategoriasAreasConfig(),this.renderJerarquiaTree()}renderCategoriasAreasConfig(){const e=document.getElementById("listaCategoriasAreas"),t=document.getElementById("mensajeNoCategoriasAreas");if(!e)return;const a=void 0!==l&&l.categories?l.categories:{},n=Object.entries(a).map(([e,t])=>({id:e,icon:t.icon,name:t.name,color:t.color,description:t.description}));0===n.length?(e.style.display="none",t&&(t.style.display="block")):(e.style.display="grid",t&&(t.style.display="none"),e.innerHTML=n.map(e=>`\n        <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid ${e.color}; transition: all 0.2s; position: relative; overflow: hidden;">\n          \x3c!-- Fondo con color de categora (sutil) --\x3e\n          <div style="position: absolute; top: 0; right: 0; bottom: 0; width: 60px; background: linear-gradient(90deg, transparent, ${e.color}20); pointer-events: none;"></div>\n          \n          \x3c!-- Icono y color --\x3e\n          <div style="display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 60px; position: relative; z-index: 1;">\n            <span style="font-size: 2rem; line-height: 1;">${e.icon}</span>\n            <div style="width: 40px; height: 24px; background: ${e.color}; border-radius: 6px; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>\n          </div>\n          \n          \x3c!-- Informacin --\x3e\n          <div style="flex: 1; min-width: 0; position: relative; z-index: 1;">\n            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">\n              <span style="color: var(--text-primary); font-weight: 700; font-size: 1rem;">${e.name}</span>\n              <span style="color: var(--text-muted); font-size: 0.7rem; font-family: monospace; background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">${e.color}</span>\n            </div>\n            <p style="color: var(--text-secondary); font-size: 0.8rem; margin: 0; line-height: 1.4;">${e.description}</p>\n          </div>\n          \n          \x3c!-- Botones de accin --\x3e\n          <div style="display: flex; gap: 6px; position: relative; z-index: 1;">\n            <button onclick="app.editarCategoria('${e.id}')" \n                    title="Editar categora"\n                    style="background: var(--info); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"\n                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"\n                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">\n              <span></span> Editar\n            </button>\n            <button onclick="app.eliminarCategoria('${e.id}')" \n                    title="Eliminar categora"\n                    style="background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"\n                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"\n                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">\n              <span></span> Eliminar\n            </button>\n          </div>\n        </div>\n      `).join(""))}agregarItemLista(e){if(["areaGeneral","subArea","sistemaEquipo","subSistema","seccion","subSeccion"].includes(e))return void this.showToast(" Administra este nivel desde la pestana Jerarquia > Arbol corporativo.","info");const t="nuevo"+{tipo:"Tipo",areaGeneral:"AreaGeneral",subArea:"SubArea",sistemaEquipo:"SistemaEquipo",subSistema:"SubSistema",seccion:"Seccion",detalle:"Detalle"}[e],a=document.getElementById(t);if(!a)return;const n=a.value.trim();if(!n)return void this.showToast(" Ingresa un valor","error");(this.autocompleteData[e]||[]).includes(n)?this.showToast(" Este valor ya existe","warning"):(this.autocompleteData[e]||(this.autocompleteData[e]=[]),this.autocompleteData[e].push(n),this.autocompleteData[e].sort(),localStorage.setItem("autocompleteData",JSON.stringify(this.autocompleteData)),a.value="",this.renderListasGestion(),this.showToast(` ${n} agregado correctamente`,"success"))}editarItemLista(e,t,a){const n=prompt("Editar valor:",a);if(!n||""===n.trim())return;const i=n.trim();["areaGeneral","subArea","sistemaEquipo","subSistema","seccion","subSeccion"].includes(e)?this.showToast(" Este nivel se edita desde Jerarquia > Arbol corporativo.","info"):this.autocompleteData[e].includes(i)&&i!==a?this.showToast(" Este valor ya existe","warning"):(this.autocompleteData[e][t]=i,this.autocompleteData[e].sort(),localStorage.setItem("autocompleteData",JSON.stringify(this.autocompleteData)),this.renderListasGestion(),this.showToast(` Valor actualizado: ${i}`,"success"))}eliminarItemLista(e,t){if(!confirm(`Eliminar "${t}" de la lista de ${{tipo:"Tipos",areaGeneral:"reas Generales",subArea:"Sub-reas",sistemaEquipo:"Sistemas/Equipos",subSistema:"Sub-Sistemas",seccion:"Secciones",detalle:"Detalles"}[e]}?\n\n Esta opcin tambin se eliminar de todos los repuestos que la usen.`))return;if(["areaGeneral","subArea","sistemaEquipo","subSistema","seccion","subSeccion"].includes(e))return void this.showToast(" Este nivel se elimina desde la pestana Jerarquia.","info");const a=this.autocompleteData[e].indexOf(t);a>-1&&this.autocompleteData[e].splice(a,1),localStorage.setItem("autocompleteData",JSON.stringify(this.autocompleteData)),this.renderListasGestion(),this.showToast(` ${t} eliminado`,"success")}renderJerarquiaTree(){var e,t;const a=document.getElementById("jerarquiaTreeContainer");if(a)if(this.jerarquiaAnidada)try{a.classList.add("jerarquia-tree-restoring"),a.classList.remove("jerarquia-tree-ready"),a.style.setProperty("background","#1e2229"),a.style.setProperty("padding","40px"),a.style.setProperty("overflow","visible"),a.style.setProperty("min-height","600px"),a.style.setProperty("height","auto");const n=this.buildTreeHTML_Visual();if(a.innerHTML=n,setTimeout(()=>{try{this.restoreExpandStates()}finally{requestAnimationFrame(()=>{a.classList.remove("jerarquia-tree-restoring"),a.classList.add("jerarquia-tree-ready")})}},100),"function"==typeof this.buildJerarquiaSearchIndex){this.buildJerarquiaSearchIndex();const a=document.getElementById("jerarquiaTreeSearchInput"),n=a?a.value.trim():"";if(n){const a=null==(e=this.jerarquiaSearchState)?void 0:e.isFilterActive,i=null==(t=this.jerarquiaSearchState)?void 0:t.activeMatch;this.performJerarquiaSearch(n),a&&i&&this.focusJerarquiaSearchResult(i)}else"function"==typeof this.clearJerarquiaSearchHighlights&&this.clearJerarquiaSearchHighlights(),this.resetJerarquiaTreeView(),this.updateJerarquiaSearchStatus("")}this.updateUndoRedoButtons()}catch(n){a.innerHTML=`<p style="color: var(--danger); padding: 20px;">Error renderizando rbol: ${n.message}</p>`}else a.innerHTML='<p style="color: var(--danger); padding: 20px;">Error: No se pudo cargar la jerarqua. Usa el botn "Guardar Cambios" en Configuracin.</p>'}buildTreeHTML(){if(!this.jerarquiaAnidada)return"<p>Error: No hay datos de jerarqua</p>";const{empresa:e,areas:t}=this.jerarquiaAnidada;if(!e||!t)return"<p>Error: Estructura de jerarqua incompleta</p>";const a=e=>{if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML};let n='<div class="jerarquia-tree-sap">';if(n+=`\n      <div class="sap-node sap-node-empresa">\n        <div class="sap-node-content">\n          <span class="sap-node-id">${a(e.id||"EMP-01")}</span>\n          <span class="sap-node-name">${a(e.nombre)}</span>\n          <div class="sap-node-actions">\n            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('empresa')" title="Editar empresa">\n              Editar Empresa\n            </button>\n          </div>\n        </div>\n      </div>\n    `,t&&t.length>0){const i=e.id||"EMP-01";n+=t.map((e,t)=>this.buildAreaHTML(e,t,i,a)).join("")}return n+='\n      <div class="sap-add-root">\n        <button class="sap-btn sap-btn-add" onclick="app.agregarNodoJerarquia(\'area\')">\n          + Nueva rea\n        </button>\n      </div>\n    ',n+='\n      <div class="undo-redo-controls">\n        <button class="undo-redo-btn undo-btn" onclick="app.undo()" title="Deshacer (Ctrl+Z)" id="sap-undo-btn">\n          \n        </button>\n        <button class="undo-redo-btn redo-btn" onclick="app.redo()" title="Rehacer (Ctrl+Y)" id="sap-redo-btn">\n          \n        </button>\n      </div>\n    ',n+="</div>",n}getVisualTypeOrder(){return["area","subArea","sistema","subSistema","seccion","subSeccion"]}getVisualChildKeyMap(){return{empresa:"areas",area:"subAreas",subArea:"sistemas",sistema:"subSistemas",subSistema:"secciones",seccion:"subSecciones",subSeccion:null}}getVisualChildTypeMap(){return{area:"subArea",subArea:"sistema",sistema:"subSistema",subSistema:"seccion",seccion:"subSeccion",subSeccion:null}}getVisualDisplayLabels(){return{empresa:"Empresa",area:"rea",subArea:"Sub-rea",sistema:"Sistema",subSistema:"Sub-Sistema",seccion:"Seccin",subSeccion:"Sub-Seccin"}}getVisualParentMap(){return{area:"empresa",subArea:"area",sistema:"subArea",subSistema:"sistema",seccion:"subSistema",subSeccion:"seccion"}}sanitizeVisualText(e,t=""){const a=e??t;return this.escapeHtml?this.escapeHtml(String(a)):String(a)}getVisualFallbackId(e,t=[]){const a=this.getVisualDisplayLabels(),n=Array.isArray(t)&&t.length>0?t.map(e=>Number.isFinite(e)?e+1:e).join("."):"1";return`${a[e]||"Nodo"}-${n}`}getLegacyNodeId(e,t){return e?Array.isArray(t)?`${e}_${t.join(",")}`:"number"==typeof t&&Number.isFinite(t)||"string"==typeof t&&""!==t.trim()?`${e}_${t}`:`${e}_root`:null}getLegacyIdFromNodeContent(e){if(!e)return null;const t=e.getAttribute("data-legacy-id");if(t)return t;const a=e.closest(".tree-node");if(!a)return null;const n=a.getAttribute("data-node-type"),i=a.getAttribute("data-node-index");return n?i&&""!==i.trim()?`${n}_${i}`:`${n}_root`:null}isLegacyNodeId(e){return"string"==typeof e&&/^(empresa|area|subArea|sistema|subSistema|seccion|subSeccion)_[0-9]+(?:,[0-9]+)*$/.test(e)}buildTreeHTML_Visual(){if(!this.jerarquiaAnidada)return"<p>Error: No hay datos de jerarqua</p>";const{empresa:e,areas:t}=this.jerarquiaAnidada;if(!e||!t)return"<p>Error: Estructura de jerarqua incompleta</p>";const a=this.getVisualDisplayLabels(),n=(e,t="")=>{const a=e??t;return this.escapeHtml?this.escapeHtml(String(a)):String(a)};let i='<div class="visual-v2-tree-container"><div class="tree-container"><div class="tree-node" data-node-type="empresa">';const s=`empresa_${n(e.id,"EMP-01")}`,r=this.getLegacyNodeId("empresa",n(e.id,"EMP-01")),o=this.getNodeExpandState(s,r);if(i+=`\n      <div class="node-content" data-level="1" data-node-id="${s}" data-legacy-id="${r}">\n        <span class="node-toggle ${o?"expanded":"collapsed"}" onclick="app.toggleVisualNodeChildren(this)"></span>\n        <span class="node-id">${n(e.id,"EMP-01")}</span>\n        <span class="node-name">${n(e.nombre,"Empresa")}</span>\n        <span class="node-level">${a.empresa}</span>\n        <div class="node-actions">\n          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('empresa')" title="Editar empresa">Editar</button>\n          <button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('area')" title="Agregar rea">+ rea</button>\n        </div>\n      </div>\n    `,Array.isArray(t)&&t.length>0){i+=`<div class="tree-children" style="display: ${o?"block":"none"};">`,t.forEach((e,t)=>{i+=this.buildVisualAreaNode(e,t,s)}),i+="</div>"}return i+="</div></div></div>",i}buildVisualAreaNode(e,t,a){const n=this.getVisualDisplayLabels(),i=this.getVisualChildTypeMap().area,s=i?n[i]:null,r=Array.isArray(e&&e.subAreas)&&e.subAreas.length>0,o=r?"":"",l=this.sanitizeVisualText(e&&e.id?e.id:null,this.getVisualFallbackId("area",[t])),d=this.sanitizeVisualText(e&&e.nombre?e.nombre:null,`${n.area} ${t+1}`),c=`${t}`,p=`${a}_area_${t}`,u=this.getLegacyNodeId("area",c),m=this.getNodeExpandState(p,u);let h=`<div class="tree-node" data-node-type="area" data-node-index="${c}">`;if(h+=`\n      <div class="node-content" data-level="2" data-node-id="${p}" data-legacy-id="${u}">\n        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('area', '${c}')" title="Mover nodo"></span>\n        ${r?`<span class="node-toggle ${m?"expanded":"collapsed"}" onclick="app.toggleVisualNodeChildren(this)">${o}</span>`:'<span style="width: 16px; display: inline-block;"></span>'}\n        <span class="node-id">${l}</span>\n        <span class="node-name">${d}</span>\n        <span class="node-level">${n.area}</span>\n        <div class="node-actions">\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('area', '${c}', -1)" title="Subir"></button>\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('area', '${c}', 1)" title="Bajar"></button>\n          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('area', ${t})" title="Editar rea">Editar</button>\n          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('area', ${t})" title="Eliminar rea">Eliminar</button>\n          ${i&&s?`<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${i}', ${t})" title="Agregar ${s}">+ ${s}</button>`:""}\n        </div>\n      </div>\n    `,r){h+=`<div class="tree-children" style="display: ${m?"block":"none"};">`,e.subAreas.forEach((e,a)=>{h+=this.buildVisualSubAreaNode(e,t,a,p)}),h+="</div>"}return h+="</div>",h}buildVisualSubAreaNode(e,t,a,n){const i=this.getVisualDisplayLabels(),s=this.getVisualChildTypeMap().subArea,r=s?i[s]:null,o=Array.isArray(e&&e.sistemas)&&e.sistemas.length>0,l=o?"":"",d=this.sanitizeVisualText(e&&e.id?e.id:null,this.getVisualFallbackId("subArea",[t,a])),c=this.sanitizeVisualText(e&&e.nombre?e.nombre:null,`${i.subArea} ${a+1}`),p=`${t},${a}`,u=`${n}_subarea_${a}`,m=this.getLegacyNodeId("subArea",p),h=this.getNodeExpandState(u,m);let g=`<div class="tree-node" data-node-type="subArea" data-node-index="${p}">`;if(g+=`\n      <div class="node-content" data-level="3" data-node-id="${u}" data-legacy-id="${m}">\n        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('subArea', '${p}')" title="Mover nodo"></span>\n        ${o?`<span class="node-toggle ${h?"expanded":"collapsed"}" onclick="app.toggleVisualNodeChildren(this)">${l}</span>`:'<span style="width: 16px; display: inline-block;"></span>'}\n        <span class="node-id">${d}</span>\n        <span class="node-name">${c}</span>\n        <span class="node-level">${i.subArea}</span>\n        <div class="node-actions">\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subArea', '${p}', -1)" title="Subir"></button>\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subArea', '${p}', 1)" title="Bajar"></button>\n          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('subArea', ${t}, ${a})" title="Editar sub-rea">Editar</button>\n          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('subArea', ${t}, ${a})" title="Eliminar sub-rea">Eliminar</button>\n          ${s&&r?`<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${s}', ${t}, ${a})" title="Agregar ${r}">+ ${r}</button>`:""}\n        </div>\n      </div>\n    `,o){g+=`<div class="tree-children" style="display: ${h?"block":"none"};">`,e.sistemas.forEach((e,n)=>{g+=this.buildVisualSistemaNode(e,t,a,n,u)}),g+="</div>"}return g+="</div>",g}buildVisualSistemaNode(e,t,a,n,i){const s=this.getVisualDisplayLabels(),r=this.getVisualChildTypeMap().sistema,o=r?s[r]:null,l=Array.isArray(e&&e.subSistemas)&&e.subSistemas.length>0,d=l?"":"",c=this.sanitizeVisualText(e&&e.id?e.id:null,this.getVisualFallbackId("sistema",[t,a,n])),p=this.sanitizeVisualText(e&&e.nombre?e.nombre:null,`${s.sistema} ${n+1}`),u=`${t},${a},${n}`,m=`${i}_sistema_${n}`,h=this.getLegacyNodeId("sistema",u),g=this.getNodeExpandState(m,h),b=g?"block":"none";let v=`<div class="tree-node" data-node-type="sistema" data-node-index="${u}">`;return v+=`\n      <div class="node-content" data-level="4" data-node-id="${m}" data-legacy-id="${h}">\n        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('sistema', '${u}')" title="Mover nodo"></span>\n        ${l?`<span class="node-toggle ${g?"expanded":"collapsed"}" onclick="app.toggleVisualNodeChildren(this)">${d}</span>`:'<span style="width: 16px; display: inline-block;"></span>'}\n        <span class="node-id">${c}</span>\n        <span class="node-name">${p}</span>\n        <span class="node-level">${s.sistema}</span>\n        <div class="node-actions">\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('sistema', '${u}', -1)" title="Subir"></button>\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('sistema', '${u}', 1)" title="Bajar"></button>\n          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('sistema', ${t}, ${a}, ${n})" title="Editar sistema">Editar</button>\n          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('sistema', ${t}, ${a}, ${n})" title="Eliminar sistema">Eliminar</button>\n          ${r&&o?`<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${r}', ${t}, ${a}, ${n})" title="Agregar ${o}">+ ${o}</button>`:""}\n        </div>\n      </div>\n    `,l&&(v+=`<div class="tree-children" style="display: ${b};">`,e.subSistemas.forEach((e,i)=>{v+=this.buildVisualSubSistemaNode(e,t,a,n,i,m)}),v+="</div>"),v+="</div>",v}buildVisualSubSistemaNode(e,t,a,n,i,s){const r=this.getVisualDisplayLabels(),o=this.getVisualChildTypeMap().subSistema,l=o?r[o]:null,d=Array.isArray(e&&e.secciones)&&e.secciones.length>0,c=d?"":"",p=this.sanitizeVisualText(e&&e.id?e.id:null,this.getVisualFallbackId("subSistema",[t,a,n,i])),u=this.sanitizeVisualText(e&&e.nombre?e.nombre:null,`${r.subSistema} ${i+1}`),m=`${t},${a},${n},${i}`,h=`${s}_subSistema_${i}`,g=this.getLegacyNodeId("subSistema",m),b=this.getNodeExpandState(h,g),v=b?"block":"none";let y=`<div class="tree-node" data-node-type="subSistema" data-node-index="${m}">`;return y+=`\n      <div class="node-content" data-level="5" data-node-id="${h}" data-legacy-id="${g}">\n        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('subSistema', '${m}')" title="Mover nodo"></span>\n        ${d?`<span class="node-toggle ${b?"expanded":"collapsed"}" onclick="app.toggleVisualNodeChildren(this)">${c}</span>`:'<span style="width: 16px; display: inline-block;"></span>'}\n        <span class="node-id">${p}</span>\n        <span class="node-name">${u}</span>\n        <span class="node-level">${r.subSistema}</span>\n        <div class="node-actions">\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subSistema', '${m}', -1)" title="Subir"></button>\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subSistema', '${m}', 1)" title="Bajar"></button>\n          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('subSistema', ${t}, ${a}, ${n}, ${i})" title="Editar sub-sistema">Editar</button>\n          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('subSistema', ${t}, ${a}, ${n}, ${i})" title="Eliminar sub-sistema">Eliminar</button>\n          ${o&&l?`<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${o}', ${t}, ${a}, ${n}, ${i})" title="Agregar ${l}">+ ${l}</button>`:""}\n        </div>\n      </div>\n    `,d&&(y+=`<div class="tree-children" style="display: ${v};">`,e.secciones.forEach((e,s)=>{y+=this.buildVisualSeccionNode(e,t,a,n,i,s,h)}),y+="</div>"),y+="</div>",y}buildVisualSeccionNode(e,t,a,n,i,s,r){const o=this.getVisualDisplayLabels(),l=this.getVisualChildTypeMap().seccion,d=l?o[l]:null,c=Array.isArray(e&&e.subSecciones)&&e.subSecciones.length>0,p=c?"":"",u=this.sanitizeVisualText(e&&e.id?e.id:null,this.getVisualFallbackId("seccion",[t,a,n,i,s])),m=this.sanitizeVisualText(e&&e.nombre?e.nombre:null,`${o.seccion} ${s+1}`),h=`${t},${a},${n},${i},${s}`,g=`${r}_seccion_${s}`,b=this.getLegacyNodeId("seccion",h),v=this.getNodeExpandState(g,b),y=v?"block":"none";let f=`<div class="tree-node" data-node-type="seccion" data-node-index="${h}">`;return f+=`\n      <div class="node-content" data-level="6" data-node-id="${g}" data-legacy-id="${b}">\n        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('seccion', '${h}')" title="Mover nodo"></span>\n        ${c?`<span class="node-toggle ${v?"expanded":"collapsed"}" onclick="app.toggleVisualNodeChildren(this)">${p}</span>`:'<span style="width: 16px; display: inline-block;"></span>'}\n        <span class="node-id">${u}</span>\n        <span class="node-name">${m}</span>\n        <span class="node-level">${o.seccion}</span>\n        <div class="node-actions">\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('seccion', '${h}', -1)" title="Subir"></button>\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('seccion', '${h}', 1)" title="Bajar"></button>\n          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('seccion', ${t}, ${a}, ${n}, ${i}, ${s})" title="Editar seccin">Editar</button>\n          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('seccion', ${t}, ${a}, ${n}, ${i}, ${s})" title="Eliminar seccin">Eliminar</button>\n          ${l&&d?`<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${l}', ${t}, ${a}, ${n}, ${i}, ${s})" title="Agregar ${d}">+ ${d}</button>`:""}\n        </div>\n      </div>\n    `,c&&(f+=`<div class="tree-children" style="display: ${y};">`,e.subSecciones.forEach((e,r)=>{f+=this.buildVisualSubSeccionNode(e,t,a,n,i,s,r,g)}),f+="</div>"),f+="</div>",f}buildVisualSubSeccionNode(e,t,a,n,i,s,r,o){const l=this.getVisualDisplayLabels(),d=this.getVisualChildTypeMap().subSeccion,c=d?l[d]:null,p=this.sanitizeVisualText(e&&e.id?e.id:null,this.getVisualFallbackId("subSeccion",[t,a,n,i,s,r])),u=this.sanitizeVisualText(e&&e.nombre?e.nombre:null,`${l.subSeccion} ${r+1}`),m=`${t},${a},${n},${i},${s},${r}`;let h=`<div class="tree-node" data-node-type="subSeccion" data-node-index="${m}">`;return h+=`\n      <div class="node-content" data-level="7" data-node-id="${`${o}_subSeccion_${r}`}" data-legacy-id="${this.getLegacyNodeId("subSeccion",m)}">\n        <span class="drag-handle" onclick="event.stopPropagation(); app.openVisualMoveModal('subSeccion', '${m}')" title="Mover nodo"></span>\n        <span style="width: 16px; display: inline-block;"></span>\n        <span class="node-id">${p}</span>\n        <span class="node-name">${u}</span>\n        <span class="node-level">${l.subSeccion}</span>\n        <div class="node-actions">\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subSeccion', '${m}', -1)" title="Subir"></button>\n          <button class="node-btn node-btn-move" onclick="event.stopPropagation(); app.reordenarVisualNodo('subSeccion', '${m}', 1)" title="Bajar"></button>\n          <button class="node-btn node-btn-edit" onclick="event.stopPropagation(); app.editarNodoJerarquia('subSeccion', ${t}, ${a}, ${n}, ${i}, ${s}, ${r})" title="Editar sub-seccin">Editar</button>\n          <button class="node-btn node-btn-delete" onclick="event.stopPropagation(); app.eliminarNodoJerarquia('subSeccion', ${t}, ${a}, ${n}, ${i}, ${s}, ${r})" title="Eliminar sub-seccin">Eliminar</button>\n          ${d&&c?`<button class="node-btn node-btn-add" onclick="event.stopPropagation(); app.agregarNodoJerarquia('${d}', ${t}, ${a}, ${n}, ${i}, ${s}, ${r})" title="Agregar ${c}">+ ${c}</button>`:""}\n        </div>\n      </div>\n    `,h+="</div>",h}getVisualCollectionInfo(e,t){if(!this.jerarquiaAnidada)return null;if("area"===e)return{collection:Array.isArray(this.jerarquiaAnidada.areas)?this.jerarquiaAnidada.areas:[],parentNode:this.jerarquiaAnidada,parentType:"empresa",parentIndices:[]};const a=this.getVisualParentMap()[e];if(!a)return null;const n=Array.isArray(t)&&t.length>0?t.slice(0,-1):[],i="empresa"===a?this.jerarquiaAnidada.empresa:this.getVisualNodeByTypeAndIndices(a,n);if(!i)return null;const s=this.getVisualChildKeyMap()[a];return s?(Array.isArray(i[s])||(i[s]=[]),{collection:i[s],parentNode:i,parentType:a,parentIndices:n}):null}getVisualNodeByTypeAndIndices(e,t){if(!this.jerarquiaAnidada)return null;if("empresa"===e)return this.jerarquiaAnidada.empresa||null;const a=Array.isArray(t)?t.map(e=>Number(e)):[],n=this.getVisualChildKeyMap(),i=this.getVisualTypeOrder();if(!Array.isArray(this.jerarquiaAnidada.areas))return null;let s=this.jerarquiaAnidada.areas,r=null;for(let o=0;o<i.length;o++){const t=i[o],l=a[o];if(!Number.isFinite(l))return null;if(!Array.isArray(s)||l<0||l>=s.length)return null;if(r=s[l],t===e)return r||null;const d=n[t];if(!d)return null;s=r?r[d]:null}return null}reordenarVisualNodo(e,t,a){if(!a||"number"!=typeof a)return;let n=[];if(Array.isArray(t)?n=t.map(e=>Number(e)):"number"==typeof t?n=[Number(t)]:"string"==typeof t&&""!==t.trim()&&(n=t.split(",").map(e=>Number(e.trim())).filter(e=>!Number.isNaN(e))),n.some(e=>Number.isNaN(e)))return void this.showMoveNotification("Movimiento invlido ",!0);if(0===n.length&&"area"!==e)return void this.showMoveNotification("No se pudo mover el elemento ",!0);const i=this.getVisualCollectionInfo(e,n);if(!i||!Array.isArray(i.collection))return void this.showMoveNotification("Movimiento no disponible ",!0);const s=(n.length>0?n[n.length-1]:0)+a;if(s<0||s>=i.collection.length)return void this.showMoveNotification(a<0?"Ya est en la parte superior ":"Ya est en la parte inferior ",!0);const r=[...n],o=[...n];0===o.length?o[0]=s:o[o.length-1]=s,this.moveOrReorderSAPNodes(e,r,o,!0)}openVisualMoveModal(e,t){this.showMoveNotification("Mover nodo (modal en desarrollo)",!0)}toggleVisualNodeChildren(e){const t=e.closest(".node-content"),a=t.closest(".tree-node"),n=a.querySelector(":scope > .tree-children");if(!n)return;let i=t.getAttribute("data-node-id");if(!i){i=`${a.getAttribute("data-node-type")||"node"}_${a.getAttribute("data-node-index")||"unknown"}`,t.setAttribute("data-node-id",i)}const s="none"===n.style.display,r=this.getLegacyIdFromNodeContent(t);s?(n.style.display="block",e.textContent="",e.classList.remove("collapsed"),e.classList.add("expanded"),this.saveNodeExpandState(i,!0,r)):(n.style.display="none",e.textContent="",e.classList.remove("expanded"),e.classList.add("collapsed"),this.saveNodeExpandState(i,!1,r))}restoreExpandStates(){try{const e="jerarquia_expand_state",t=JSON.parse(localStorage.getItem(e)||"{}");if(0===Object.keys(t).length)return;let a=0,n=0,i=0;const s=document.querySelectorAll(".node-content[data-node-id]"),r=[];s.forEach(e=>{const t=e.getAttribute("data-node-id");t&&r.push(t)});const o=Object.keys(t),l=o.filter(e=>!r.includes(e)),d=r.filter(e=>!o.includes(e));let c=[];l.length>0&&(c=l.filter(e=>this.isLegacyNodeId(e))),d.length;let p=0,u=!1;if(s.forEach((e,s)=>{const r=e.getAttribute("data-node-id");let o=t[r],l=!1;const d=this.getLegacyIdFromNodeContent(e);if(void 0===o&&d&&void 0!==t[d]&&(o=t[d],t[r]=o,d!==r&&(delete t[d],p++,u=!0,l=!0)),void 0===o)return void i++;const c=e.closest(".tree-node"),m=e.querySelector(".node-toggle"),h=c?c.querySelector(":scope > .tree-children"):null;if(!h||!m)return void n++;!0===o?(h.style.display="block",m.classList.remove("collapsed"),m.classList.add("expanded")):(h.style.display="none",m.classList.remove("expanded"),m.classList.add("collapsed")),a++}),c.length>0){const e=c.filter(e=>void 0!==t[e]);e.forEach(e=>{delete t[e]}),e.length>0&&(u=!0)}(p>0||u)&&localStorage.setItem(e,JSON.stringify(t))}catch(e){}}saveNodeExpandState(e,t,a=null){try{const n="jerarquia_expand_state";let i=JSON.parse(localStorage.getItem(n)||"{}");i[e]=t,a&&a!==e&&void 0!==i[a]&&delete i[a],localStorage.setItem(n,JSON.stringify(i));localStorage.getItem(n)}catch(n){}}getNodeExpandState(e,t=null){try{const a="jerarquia_expand_state",n=JSON.parse(localStorage.getItem(a)||"{}");let i=n[e];void 0===i&&t&&void 0!==n[t]&&(i=n[t],n[e]=i,t!==e&&delete n[t],localStorage.setItem(a,JSON.stringify(n)));return void 0===i||i}catch(a){return!0}}clearNodeExpandStates(){try{localStorage.removeItem("jerarquia_expand_state")}catch(e){}}buildAreaHTML(e,t,a,n){const i=`area_children_${t}`,s="open"===this.getTreeNodeState(i),r=s?"":"",o=`${a}-${e.id||`AREA-${t+1}`}`,l=Array.isArray(e.subAreas)&&e.subAreas.length>0?e.subAreas.map((e,a)=>this.buildSubAreaHTML(e,t,a,o,n)).join(""):'<div class="sap-empty">Sin sub-areas</div>';return`\n  <div class="sap-node" draggable="true" data-node-type="area" data-node-index="${t}"\n           ondragstart="app.onDragStartSAP(event, 'area', ${t})"\n           ondragover="app.onDragOverSAP(event)"\n           ondragleave="app.onDragLeaveSAP(event)"\n           ondrop="app.onDropSAP(event, 'area', ${t})"\n           ondragend="app.onDragEndSAP(event)">\n        <div class="sap-node-content">\n          <span class="sap-node-drag-handle"></span>\n          <span class="sap-node-expand" onclick="app.toggleTreeChildren('${i}')">${r}</span>\n          <span class="sap-node-id">${n(o)}</span>\n          <span class="sap-node-name" onclick="app.toggleTreeChildren('${i}')">${n(e.nombre||"Sin nombre")}</span>\n          <div class="sap-node-actions">\n            <button class="sap-btn sap-btn-subnivel" onclick="app.agregarNodoJerarquia('subArea', ${t})" title="Agregar sub-rea">+ Sub-rea</button>\n            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('area', ${t})" title="Editar area">Editar</button>\n            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('area', ${t})" title="Eliminar area">Eliminar</button>\n          </div>\n        </div>\n        <div id="${i}" class="sap-children" style="display: ${s?"block":"none"};">\n          ${l}\n        </div>\n      </div>\n    `}buildSubAreaHTML(e,t,a,n,i){const s=`subarea_children_${t}_${a}`,r="open"===this.getTreeNodeState(s),o=r?"":"",l=`${n}-${e.id||`SUBA-${a+1}`}`,d=Array.isArray(e.sistemas)&&e.sistemas.length>0?e.sistemas.map((e,n)=>this.buildSistemaHTML(e,t,a,n,l,i)).join(""):'<div class="sap-empty">Sin sistemas</div>';return`\n  <div class="sap-node" draggable="true" data-node-type="subArea" data-node-index="${t},${a}"\n           ondragstart="app.onDragStartSAP(event, 'subArea', ${t}, ${a})"\n           ondragover="app.onDragOverSAP(event)"\n           ondragleave="app.onDragLeaveSAP(event)"\n           ondrop="app.onDropSAP(event, 'subArea', ${t}, ${a})"\n           ondragend="app.onDragEndSAP(event)">\n        <div class="sap-node-content">\n          <span class="sap-node-drag-handle"></span>\n          <span class="sap-node-expand" onclick="app.toggleTreeChildren('${s}')">${o}</span>\n          <span class="sap-node-id">${i(l)}</span>\n          <span class="sap-node-name" onclick="app.toggleTreeChildren('${s}')">${i(e.nombre||"Sin nombre")}</span>\n          <div class="sap-node-actions">\n            <button class="sap-btn sap-btn-subnivel" onclick="app.agregarNodoJerarquia('sistema', ${t}, ${a})" title="Agregar sistema">+ Sistema</button>\n            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('subArea', ${t}, ${a})" title="Editar sub-area">Editar</button>\n            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('subArea', ${t}, ${a})" title="Eliminar sub-area">Eliminar</button>\n          </div>\n        </div>\n        <div id="${s}" class="sap-children" style="display: ${r?"block":"none"};">\n          ${d}\n        </div>\n      </div>\n    `}buildSistemaHTML(e,t,a,n,i,s){const r=`sistema_children_${t}_${a}_${n}`,o="open"===this.getTreeNodeState(r),l=o?"":"",d=`${i}-${e.id||`SIS-${n+1}`}`,c=Array.isArray(e.subSistemas)&&e.subSistemas.length>0?e.subSistemas.map((e,i)=>this.buildSubSistemaHTML(e,t,a,n,i,d,s)).join(""):'<div class="sap-empty">Sin sub-sistemas</div>';return`\n  <div class="sap-node" draggable="true" data-node-type="sistema" data-node-index="${t},${a},${n}"\n           ondragstart="app.onDragStartSAP(event, 'sistema', ${t}, ${a}, ${n})"\n           ondragover="app.onDragOverSAP(event)"\n           ondragleave="app.onDragLeaveSAP(event)"\n           ondrop="app.onDropSAP(event, 'sistema', ${t}, ${a}, ${n})"\n           ondragend="app.onDragEndSAP(event)">\n        <div class="sap-node-content">\n          <span class="sap-node-drag-handle"></span>\n          <span class="sap-node-expand" onclick="app.toggleTreeChildren('${r}')">${l}</span>\n          <span class="sap-node-id">${s(d)}</span>\n          <span class="sap-node-name" onclick="app.toggleTreeChildren('${r}')">${s(e.nombre||"Sin nombre")}</span>\n          <div class="sap-node-actions">\n            <button class="sap-btn sap-btn-subnivel" onclick="app.agregarNodoJerarquia('subSistema', ${t}, ${a}, ${n})" title="Agregar sub-sistema">+ Sub-Sistema</button>\n            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('sistema', ${t}, ${a}, ${n})" title="Editar sistema">Editar</button>\n            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('sistema', ${t}, ${a}, ${n})" title="Eliminar sistema">Eliminar</button>\n          </div>\n        </div>\n        <div id="${r}" class="sap-children" style="display: ${o?"block":"none"};">\n          ${c}\n        </div>\n      </div>\n    `}buildSubSistemaHTML(e,t,a,n,i,s,r){const o=`subsistema_children_${t}_${a}_${n}_${i}`,l="open"===this.getTreeNodeState(o),d=l?"":"",c=`${s}-${e.id||`SS-${i+1}`}`,p=Array.isArray(e.secciones)&&e.secciones.length>0?e.secciones.map((e,s)=>this.buildSeccionHTML(e,t,a,n,i,s,c,r)).join(""):'<div class="sap-empty">Sin secciones</div>';return`\n  <div class="sap-node" draggable="true" data-node-type="subSistema" data-node-index="${t},${a},${n},${i}"\n           ondragstart="app.onDragStartSAP(event, 'subSistema', ${t}, ${a}, ${n}, ${i})"\n           ondragover="app.onDragOverSAP(event)"\n           ondragleave="app.onDragLeaveSAP(event)"\n           ondrop="app.onDropSAP(event, 'subSistema', ${t}, ${a}, ${n}, ${i})"\n           ondragend="app.onDragEndSAP(event)">\n        <div class="sap-node-content">\n          <span class="sap-node-drag-handle"></span>\n          <span class="sap-node-expand" onclick="app.toggleTreeChildren('${o}')">${d}</span>\n          <span class="sap-node-id">${r(c)}</span>\n          <span class="sap-node-name" onclick="app.toggleTreeChildren('${o}')">${r(e.nombre||"Sin nombre")}</span>\n          <div class="sap-node-actions">\n            <button class="sap-btn sap-btn-subnivel" onclick="app.agregarNodoJerarquia('seccion', ${t}, ${a}, ${n}, ${i})" title="Agregar seccin">+ Seccin</button>\n            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('subSistema', ${t}, ${a}, ${n}, ${i})" title="Editar sub-sistema">Editar</button>\n            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('subSistema', ${t}, ${a}, ${n}, ${i})" title="Eliminar sub-sistema">Eliminar</button>\n          </div>\n        </div>\n        <div id="${o}" class="sap-children" style="display: ${l?"block":"none"};">\n          ${p}\n        </div>\n      </div>\n    `}buildSeccionHTML(e,t,a,n,i,s,r,o){const l=`seccion_children_${t}_${a}_${n}_${i}_${s}`,d="open"===this.getTreeNodeState(l),c=d?"":"",p=`${r}-${e.id||`SEC-${s+1}`}`,u=Array.isArray(e.subSecciones)&&e.subSecciones.length>0?e.subSecciones.map((e,r)=>this.buildSubSeccionHTML(e,t,a,n,i,s,r,p,o)).join(""):'<div class="sap-empty">Sin sub-secciones</div>';return`\n  <div class="sap-node" draggable="true" data-node-type="seccion" data-node-index="${t},${a},${n},${i},${s}"\n           ondragstart="app.onDragStartSAP(event, 'seccion', ${t}, ${a}, ${n}, ${i}, ${s})"\n           ondragover="app.onDragOverSAP(event)"\n           ondragleave="app.onDragLeaveSAP(event)"\n           ondrop="app.onDropSAP(event, 'seccion', ${t}, ${a}, ${n}, ${i}, ${s})"\n           ondragend="app.onDragEndSAP(event)">\n        <div class="sap-node-content">\n          <span class="sap-node-drag-handle"></span>\n          <span class="sap-node-expand" onclick="app.toggleTreeChildren('${l}')">${c}</span>\n          <span class="sap-node-id">${o(p)}</span>\n          <span class="sap-node-name" onclick="app.toggleTreeChildren('${l}')">${o(e.nombre||"Sin nombre")}</span>\n          <div class="sap-node-actions">\n            <button class="sap-btn sap-btn-subnivel" onclick="app.agregarNodoJerarquia('subSeccion', ${t}, ${a}, ${n}, ${i}, ${s})" title="Agregar sub-seccin">+ Sub-Seccin</button>\n            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('seccion', ${t}, ${a}, ${n}, ${i}, ${s})" title="Editar seccion">Editar</button>\n            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('seccion', ${t}, ${a}, ${n}, ${i}, ${s})" title="Eliminar seccion">Eliminar</button>\n          </div>\n        </div>\n        <div id="${l}" class="sap-children" style="display: ${d?"block":"none"};">\n          ${u}\n        </div>\n      </div>\n    `}buildSubSeccionHTML(e,t,a,n,i,s,r,o,l){return`\n  <div class="sap-node sap-node-leaf" draggable="true" data-node-type="subSeccion" data-node-index="${t},${a},${n},${i},${s},${r}"\n           ondragstart="app.onDragStartSAP(event, 'subSeccion', ${t}, ${a}, ${n}, ${i}, ${s}, ${r})"\n           ondragover="app.onDragOverSAP(event)"\n           ondragleave="app.onDragLeaveSAP(event)"\n           ondrop="app.onDropSAP(event, 'subSeccion', ${t}, ${a}, ${n}, ${i}, ${s}, ${r})"\n           ondragend="app.onDragEndSAP(event)">\n        <div class="sap-node-content">\n          <span class="sap-node-drag-handle"></span>\n          <span class="sap-node-spacer"></span>\n          <span class="sap-node-id">${l(`${o}-${e.id||`SSEC-${r+1}`}`)}</span>\n          <span class="sap-node-name">${l(e.nombre||"Sin nombre")}</span>\n          <div class="sap-node-actions">\n            <button class="sap-btn sap-btn-edit" onclick="app.editarNodoJerarquia('subSeccion', ${t}, ${a}, ${n}, ${i}, ${s}, ${r})" title="Editar sub-seccion">Editar</button>\n            <button class="sap-btn sap-btn-delete" onclick="app.eliminarNodoJerarquia('subSeccion', ${t}, ${a}, ${n}, ${i}, ${s}, ${r})" title="Eliminar sub-seccion">Eliminar</button>\n          </div>\n        </div>\n      </div>\n    `}toggleTreeNode(e){const t=document.getElementById(e);if(!t)return;const a=document.querySelector(`[onclick*="'${e}'"]`);"none"===t.style.display?(t.style.display="block",a&&(a.textContent="")):(t.style.display="none",a&&(a.textContent=""))}toggleTreeChildren(e){const t=document.getElementById(e);if(!t)return;const a=document.querySelector(`[onclick*="${e}"]`);"none"===t.style.display?(t.style.display="block",a&&a.classList.contains("sap-node-expand")&&(a.textContent=""),localStorage.setItem("tree-"+e,"open")):(t.style.display="none",a&&a.classList.contains("sap-node-expand")&&(a.textContent=""),localStorage.setItem("tree-"+e,"closed"))}sincronizarJerarquiaDesdeUbicaciones(e){if(!Array.isArray(e)||0===e.length)return;if(!this.jerarquiaAnidada||!Array.isArray(this.jerarquiaAnidada.areas))return;let t=!1;e.forEach((e,a)=>{if(!e.areaGeneral)return;let n=this.jerarquiaAnidada.areas.find(t=>t.nombre===e.areaGeneral);if(n||(n={id:`area_${Date.now()}_${Math.random()}`,nombre:e.areaGeneral,subAreas:[]},this.jerarquiaAnidada.areas.push(n),t=!0),!e.subArea)return;Array.isArray(n.subAreas)||(n.subAreas=[]);let i=n.subAreas.find(t=>t.nombre===e.subArea);if(i||(i={id:`subarea_${Date.now()}_${Math.random()}`,nombre:e.subArea,sistemas:[]},n.subAreas.push(i),t=!0),!e.sistemaEquipo)return;Array.isArray(i.sistemas)||(i.sistemas=[]);let s=i.sistemas.find(t=>t.nombre===e.sistemaEquipo);if(s||(s={id:`sistema_${Date.now()}_${Math.random()}`,nombre:e.sistemaEquipo,subSistemas:[]},i.sistemas.push(s),t=!0),!e.subSistema)return;Array.isArray(s.subSistemas)||(s.subSistemas=[]);let r=s.subSistemas.find(t=>t.nombre===e.subSistema);if(r||(r={id:`subsistema_${Date.now()}_${Math.random()}`,nombre:e.subSistema,secciones:[]},s.subSistemas.push(r),t=!0),!e.seccion)return;Array.isArray(r.secciones)||(r.secciones=[]);let o=r.secciones.find(t=>t.nombre===e.seccion);if(o||(o={id:`seccion_${Date.now()}_${Math.random()}`,nombre:e.seccion,subSecciones:[]},r.secciones.push(o),t=!0),!e.subSeccion)return;Array.isArray(o.subSecciones)||(o.subSecciones=[]);let l=o.subSecciones.find(t=>t.nombre===e.subSeccion);l||(l={id:`subseccion_${Date.now()}_${Math.random()}`,nombre:e.subSeccion},o.subSecciones.push(l),t=!0)}),t&&(this.saveJerarquiaAnidada({reason:"sincronizar-desde-ubicaciones",meta:{origen:"sincronizarJerarquiaDesdeUbicaciones"}}),"configuracion"===this.currentTab&&this.renderJerarquiaTree())}getTreeNodeState(e){return localStorage.getItem("tree-"+e)||"closed"}setTreeNodeState(e,t){e&&localStorage.setItem("tree-"+e,t)}onDragStartSAP(e,t,...a){this.draggedSAPNode={type:t,indices:a};const n=e.target.closest(".sap-node");if(n.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.target.innerHTML),!document.getElementById("sap-drop-indicator")){const e=document.createElement("div");e.id="sap-drop-indicator",e.className="sap-drop-indicator",document.body.appendChild(e)}document.querySelectorAll(".sap-node").forEach(e=>{(e.dataset.nodeType||this.getNodeTypeFromElement(e))===t&&e!==n&&e.classList.add("valid-drop-target")})}onDragOverSAP(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".sap-node");if(!t||t.classList.contains("dragging"))return void this.hideDropIndicator();this.isValidDropTarget(t)?(t.classList.add("drag-valid"),t.classList.remove("drag-invalid"),t.classList.add("drag-over"),this.showDropIndicator(t,e)):(t.classList.add("drag-invalid"),t.classList.remove("drag-valid","drag-over"),this.hideDropIndicator())}isValidDropTarget(e){if(!this.draggedSAPNode)return!1;return this.draggedSAPNode.type===(e.dataset.nodeType||this.getNodeTypeFromElement(e))}getNodeTypeFromElement(e){const t=e.getAttribute("ondragstart");if(!t)return null;const a=t.match(/onDragStartSAP\(event,\s*'(\w+)'/);return a?a[1]:null}showDropIndicator(e,t){const a=document.getElementById("sap-drop-indicator");if(!a)return;const n=e.getBoundingClientRect(),i=t.clientY<n.top+n.height/2;a.style.top=i?`${n.top+window.scrollY}px`:`${n.bottom+window.scrollY}px`,a.style.left=`${n.left}px`,a.style.width=`${n.width}px`,a.classList.add("active"),this.dropPosition=i?"before":"after"}hideDropIndicator(){const e=document.getElementById("sap-drop-indicator");e&&e.classList.remove("active")}onDragLeaveSAP(e){const t=e.target.closest(".sap-node");t&&t.classList.remove("drag-over","drag-valid","drag-invalid")}onDropSAP(e,t,...a){e.preventDefault(),e.stopPropagation();const n=e.target.closest(".sap-node");if(n&&n.classList.remove("drag-over","drag-valid","drag-invalid"),this.hideDropIndicator(),!this.draggedSAPNode)return;const{type:i,indices:s}=this.draggedSAPNode;if(i===t&&JSON.stringify(s)===JSON.stringify(a))return;if(i!==t)return;let r=[...a];const o=r.length-1;"after"===this.dropPosition&&r[o]++;const l=JSON.stringify(s.slice(0,-1))===JSON.stringify(a.slice(0,-1));l&&s[s.length-1]<r[o]&&r[o]--,this.moveOrReorderSAPNodes(i,s,r,l)}onDragEndSAP(e){const t=e.target.closest(".sap-node");t&&t.classList.remove("dragging"),this.draggedSAPNode=null,this.dropPosition=null,document.querySelectorAll(".drag-over, .drag-valid, .drag-invalid, .valid-drop-target").forEach(e=>{e.classList.remove("drag-over","drag-valid","drag-invalid","valid-drop-target")}),this.hideDropIndicator()}moveOrReorderSAPNodes(e,t,a,n){const i=this.jerarquiaAnidada;this.saveHistoryState(n?"reorder-"+e:"move-"+e);try{switch(e){case"area":const[e]=t,[s]=a;if(e===s)return;const r=i.areas.splice(e,1)[0];i.areas.splice(s,0,r);break;case"subArea":const[o,l]=t,[d,c]=a;if(n){const e=i.areas[o].subAreas.splice(l,1)[0];i.areas[o].subAreas.splice(c,0,e)}else{const e=i.areas[o].subAreas.splice(l,1)[0];i.areas[d].subAreas.splice(c,0,e)}break;case"sistema":const[p,u,m]=t,[h,g,b]=a;if(n){const e=i.areas[p].subAreas[u].sistemas.splice(m,1)[0];i.areas[p].subAreas[u].sistemas.splice(b,0,e)}else{const e=i.areas[p].subAreas[u].sistemas.splice(m,1)[0];i.areas[h].subAreas[g].sistemas||(i.areas[h].subAreas[g].sistemas=[]),i.areas[h].subAreas[g].sistemas.splice(b,0,e)}break;case"subSistema":const[v,y,f,x]=t,[S,w,A,E]=a;if(n){const e=i.areas[v].subAreas[y].sistemas[f].subSistemas.splice(x,1)[0];i.areas[v].subAreas[y].sistemas[f].subSistemas.splice(E,0,e)}else{const e=i.areas[v].subAreas[y].sistemas[f].subSistemas.splice(x,1)[0];i.areas[S].subAreas[w].sistemas[A].subSistemas||(i.areas[S].subAreas[w].sistemas[A].subSistemas=[]),i.areas[S].subAreas[w].sistemas[A].subSistemas.splice(E,0,e)}break;case"seccion":const[I,$,k,M,C]=t,[T,q,P,L,B]=a;if(n){const e=i.areas[I].subAreas[$].sistemas[k].subSistemas[M].secciones.splice(C,1)[0];i.areas[I].subAreas[$].sistemas[k].subSistemas[M].secciones.splice(B,0,e)}else{const e=i.areas[I].subAreas[$].sistemas[k].subSistemas[M].secciones.splice(C,1)[0];i.areas[T].subAreas[q].sistemas[P].subSistemas[L].secciones||(i.areas[T].subAreas[q].sistemas[P].subSistemas[L].secciones=[]),i.areas[T].subAreas[q].sistemas[P].subSistemas[L].secciones.splice(B,0,e)}break;case"subSeccion":const[N,z,j,D,F,O]=t,[R,H,J,_,G,U]=a;if(n){const e=i.areas[N].subAreas[z].sistemas[j].subSistemas[D].secciones[F].subSecciones.splice(O,1)[0];i.areas[N].subAreas[z].sistemas[j].subSistemas[D].secciones[F].subSecciones.splice(U,0,e)}else{const e=i.areas[N].subAreas[z].sistemas[j].subSistemas[D].secciones[F].subSecciones.splice(O,1)[0];i.areas[R].subAreas[H].sistemas[J].subSistemas[_].secciones[G].subSecciones||(i.areas[R].subAreas[H].sistemas[J].subSistemas[_].secciones[G].subSecciones=[]),i.areas[R].subAreas[H].sistemas[J].subSistemas[_].secciones[G].subSecciones.splice(U,0,e)}break;default:return}localStorage.setItem("jerarquiaAnidada",JSON.stringify(i)),this.showMoveNotification(n?"Elemento reordenado ":"Elemento movido entre contenedores "),this.renderJerarquiaTree()}catch(s){this.showMoveNotification("Error al mover elemento ",!0)}}showMoveNotification(e,t=!1){const a=document.createElement("div");a.style.cssText=`\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: ${t?"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)":"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"};\n      color: white;\n      padding: 15px 25px;\n      border-radius: 10px;\n      box-shadow: 0 4px 15px rgba(0,0,0,0.3);\n      z-index: 10000;\n      font-weight: 600;\n      animation: slideInRight 0.3s ease-out;\n    `,a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>a.remove(),300)},2e3)}saveHistoryState(e="drag-drop"){const t={action:e,timestamp:Date.now(),jerarquia:JSON.parse(JSON.stringify(this.jerarquiaAnidada))};this.historyStack.push(t),this.historyStack.length>this.maxHistorySize&&this.historyStack.shift(),this.redoStack=[],this.updateUndoRedoButtons()}undo(){if(0===this.historyStack.length)return;const e={action:"current",timestamp:Date.now(),jerarquia:JSON.parse(JSON.stringify(this.jerarquiaAnidada))};this.redoStack.push(e);const t=this.historyStack.pop();this.jerarquiaAnidada=t.jerarquia,localStorage.setItem("jerarquiaAnidada",JSON.stringify(this.jerarquiaAnidada)),this.renderJerarquiaTree(),this.updateUndoRedoButtons()}redo(){if(0===this.redoStack.length)return;const e={action:"before-redo",timestamp:Date.now(),jerarquia:JSON.parse(JSON.stringify(this.jerarquiaAnidada))};this.historyStack.push(e);const t=this.redoStack.pop();this.jerarquiaAnidada=t.jerarquia,localStorage.setItem("jerarquiaAnidada",JSON.stringify(this.jerarquiaAnidada)),this.renderJerarquiaTree(),this.updateUndoRedoButtons()}updateUndoRedoButtons(){const e=document.getElementById("undo-btn"),t=document.getElementById("redo-btn");e&&(e.disabled=0===this.historyStack.length,e.setAttribute("data-tooltip",this.historyStack.length>0?`Deshacer (${this.historyStack.length})`:"No hay acciones")),t&&(t.disabled=0===this.redoStack.length,t.setAttribute("data-tooltip",this.redoStack.length>0?`Rehacer (${this.redoStack.length})`:"No hay acciones")),this.visualV2&&"function"==typeof this.visualV2.setUndoRedoState&&this.visualV2.setUndoRedoState({canUndo:this.historyStack.length>0,canRedo:this.redoStack.length>0})}initUndoRedoKeyboardShortcuts(){document.addEventListener("keydown",e=>{!e.ctrlKey&&!e.metaKey||"z"!==e.key||e.shiftKey?(e.ctrlKey||e.metaKey)&&("y"===e.key||e.shiftKey&&"z"===e.key)&&(e.preventDefault(),this.redo()):(e.preventDefault(),this.undo())})}generarAbreviatura(e){if(!e||""===e.trim())return"";let t=e.trim().toUpperCase();const a=["DE","DEL","LA","EL","LOS","LAS","Y","A","EN","CON","PARA","POR"];let n=t.split(/[\s\-_]+/).filter(e=>e&&!a.includes(e));if(0===n.length&&(n=t.split(/[\s\-_]+/).filter(e=>e)),1===n.length){const e=n[0];return e.length<=4?e:e.substring(0,4)}let i=n.map(e=>e[0]).join("");if(i.length>=3&&i.length<=4)return i;if(i.length>4)return i.substring(0,4);if(2===n.length&&i.length<3)return n[0].substring(0,2)+n[1].substring(0,2);let s=t.replace(/[AEIOU\s\-_]/g,"");return s.length>=3?s.substring(0,4):t.replace(/[\s\-_]/g,"").substring(0,4)}async agregarNodoJerarquia(e,...t){const a={area:"Nueva area (N2)",subArea:"Nueva Sub-area (N3)",sistema:"Nuevo Sistema (N4)",subSistema:"Nuevo Sub-Sistema (N5)",seccion:"Nueva Seccion (N6)",subSeccion:"Nueva Sub-Seccion (N7)"}[e]||"Nuevo Elemento",n={area:"Ejemplo: AREA-01, PLANT-PRIN",subArea:"Ejemplo: EVIS, FILET, EMPAR",sistema:"Ejemplo: GRAD, GEA, BOMB-01",subSistema:"Ejemplo: CINTA-L, MOT-PRIN",seccion:"Ejemplo: SIST-ELEC, SIST-MEC",subSeccion:"Ejemplo: PANEL-CTL, CABLEADO"}[e]||"",i=await this.showDualInputModalWithAbbrev(`Agregar ${a}`,"Codigo/ID abreviado:","",n,"Nombre completo:","",!0);if(null===i||""===i.input1.trim()||""===i.input2.trim())return void this.showToast("Operacion cancelada","warning");const s={id:i.input1.trim().toUpperCase(),nombre:i.input2.trim()};"area"===e&&(s.subAreas=[]),"subArea"===e&&(s.sistemas=[]),"sistema"===e&&(s.subSistemas=[]),"subSistema"===e&&(s.secciones=[]),"seccion"===e&&(s.subSecciones=[]);try{if("area"===e)this.jerarquiaAnidada.areas.push(s);else if("subArea"===e){const[e]=t;this.jerarquiaAnidada.areas[e].subAreas.push(s)}else if("sistema"===e){const[e,a]=t;this.jerarquiaAnidada.areas[e].subAreas[a].sistemas.push(s)}else if("subSistema"===e){const[e,a,n]=t;this.jerarquiaAnidada.areas[e].subAreas[a].sistemas[n].subSistemas.push(s)}else if("seccion"===e){const[e,a,n,i]=t;this.jerarquiaAnidada.areas[e].subAreas[a].sistemas[n].subSistemas[i].secciones.push(s)}else if("subSeccion"===e){const[e,a,n,i,r]=t;this.jerarquiaAnidada.areas[e].subAreas[a].sistemas[n].subSistemas[i].secciones[r].subSecciones.push(s)}this.saveJerarquiaAnidada({reason:"agregar-nodo",meta:{tipo:e,indices:t}}),this.renderJerarquiaTree(),this.showToast(` ${a} agregado: ${i.input2}`,"success")}catch(r){this.showToast(" Error al agregar elemento","error")}}async editarNodoJerarquia(e,...t){try{let a,n="Elemento",i="";if("empresa"===e)a=this.jerarquiaAnidada.empresa,n="Empresa (N1)",i="Ejemplo: AQ-IN-CHO (Empresa-Tipo-Ubicacin)";else if("area"===e){const[e]=t;a=this.jerarquiaAnidada.areas[e],n="rea (N2)",i="Ejemplo: AREA-01, PLANT-PRIN"}else if("subArea"===e){const[e,s]=t;a=this.jerarquiaAnidada.areas[e].subAreas[s],n="Sub-rea (N3)",i="Ejemplo: EVIS, FILET, EMPAR"}else if("sistema"===e){const[e,s,r]=t;a=this.jerarquiaAnidada.areas[e].subAreas[s].sistemas[r],n="Sistema (N4)",i="Ejemplo: GRAD, GEA, BOMB-01"}else if("subSistema"===e){const[e,s,r,o]=t;a=this.jerarquiaAnidada.areas[e].subAreas[s].sistemas[r].subSistemas[o],n="Sub-Sistema (N5)",i="Ejemplo: CINTA-L, MOT-PRIN"}else if("seccion"===e){const[e,s,r,o,l]=t;a=this.jerarquiaAnidada.areas[e].subAreas[s].sistemas[r].subSistemas[o].secciones[l],n="Seccin (N6)",i="Ejemplo: SIST-ELEC, SIST-MEC"}else if("subSeccion"===e){const[e,s,r,o,l,d]=t;a=this.jerarquiaAnidada.areas[e].subAreas[s].sistemas[r].subSistemas[o].secciones[l].subSecciones[d],n="Sub-Seccin (N7)",i="Ejemplo: PANEL-CTL, CABLEADO"}if(!a)return void this.showToast(" Elemento no encontrado","error");const s=await this.showDualInputModalWithAbbrev(`Editar ${n}`,"Cdigo/ID abreviado:",a.id||"",i,"Nombre completo:",a.nombre,!1);if(null===s)return void this.showToast(" Operacin cancelada","warning");if(""===s.input1.trim())return void this.showToast(" El cdigo/ID no puede estar vaco","warning");if(""===s.input2.trim())return void this.showToast(" El nombre no puede estar vaco","warning");a.id=s.input1.trim().toUpperCase(),a.nombre=s.input2.trim(),this.saveJerarquiaAnidada({reason:"editar-nodo",meta:{tipo:e,indices:t}}),this.renderJerarquiaTree(),this.showToast(` ${n} actualizado`,"success")}catch(a){this.showToast(" Error al editar elemento","error")}}async eliminarNodoJerarquia(e,...t){try{let a,n,i=!1;if("empresa"===e)return void this.showToast(" No se puede eliminar la empresa raz","warning");if("area"===e){const[e]=t;a=this.jerarquiaAnidada.areas[e],n="rea",i=a.subAreas&&a.subAreas.length>0}else if("subArea"===e){const[e,s]=t;a=this.jerarquiaAnidada.areas[e].subAreas[s],n="Sub-rea",i=a.sistemas&&a.sistemas.length>0}else if("sistema"===e){const[e,s,r]=t;a=this.jerarquiaAnidada.areas[e].subAreas[s].sistemas[r],n="Sistema",i=a.subSistemas&&a.subSistemas.length>0}else if("subSistema"===e){const[e,s,r,o]=t;a=this.jerarquiaAnidada.areas[e].subAreas[s].sistemas[r].subSistemas[o],n="Sub-Sistema",i=a.secciones&&a.secciones.length>0}else if("seccion"===e){const[e,s,r,o,l]=t;a=this.jerarquiaAnidada.areas[e].subAreas[s].sistemas[r].subSistemas[o].secciones[l],n="Seccin",i=a.subSecciones&&a.subSecciones.length>0}else if("subSeccion"===e){const[e,s,r,o,l,d]=t;a=this.jerarquiaAnidada.areas[e].subAreas[s].sistemas[r].subSistemas[o].secciones[l].subSecciones[d],n="Sub-Seccin",i=!1}if(!a)return void this.showToast(" Elemento no encontrado","error");if(i)return void this.showToast(` No se puede eliminar "${a.nombre}" porque tiene elementos hijos. Elimina primero los hijos.`,"warning");if(!(await this.showConfirmModal(`Est seguro de eliminar "${a.nombre}"?\n\nEsta accin no se puede deshacer.`)))return void this.showToast(" Operacin cancelada","warning");if("area"===e){const[e]=t;this.jerarquiaAnidada.areas.splice(e,1)}else if("subArea"===e){const[e,a]=t;this.jerarquiaAnidada.areas[e].subAreas.splice(a,1)}else if("sistema"===e){const[e,a,n]=t;this.jerarquiaAnidada.areas[e].subAreas[a].sistemas.splice(n,1)}else if("subSistema"===e){const[e,a,n,i]=t;this.jerarquiaAnidada.areas[e].subAreas[a].sistemas[n].subSistemas.splice(i,1)}else if("seccion"===e){const[e,a,n,i,s]=t;this.jerarquiaAnidada.areas[e].subAreas[a].sistemas[n].subSistemas[i].secciones.splice(s,1)}else if("subSeccion"===e){const[e,a,n,i,s,r]=t;this.jerarquiaAnidada.areas[e].subAreas[a].sistemas[n].subSistemas[i].secciones[s].subSecciones.splice(r,1)}this.saveJerarquiaAnidada({reason:"eliminar-nodo",meta:{tipo:e,indices:t,nombre:(null==a?void 0:a.nombre)||null}}),this.renderJerarquiaTree(),this.showToast(` ${n} eliminado: ${a.nombre}`,"success")}catch(a){this.showToast(" Error al eliminar elemento","error")}}guardarCambiosJerarquia(){this.saveJerarquiaAnidada({reason:"guardar-manual",meta:{origen:"boton-guardar-jerarquia"}}),this.showToast(" Jerarqua guardada correctamente","success"),document.getElementById("btnGuardarJerarquia").style.display="none"}marcarCambiosPendientesJerarquia(){const e=document.getElementById("btnGuardarJerarquia");e&&(e.style.display="block")}agregarNuevaCategoria(){const e=document.getElementById("modal"),t=document.querySelector(".modal-content");e&&t&&(t.innerHTML='\n      <span class="close" onclick="app.cerrarModalCategoria()">&times;</span>\n      <h2 style="color: var(--primary); margin-bottom: 20px; font-size: 1.5rem;"> Nueva Categora de rea</h2>\n      <form id="formNuevaCategoria" style="display: flex; flex-direction: column; gap: 16px;">\n        \n        <div>\n          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">\n            ID de la Categora *\n          </label>\n          <input type="text" id="categoriaId" required \n                 placeholder="ej: plataforma, tanque, bomba"\n                 style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.95rem;">\n          <small style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-top: 4px;">\n            Solo minsculas, sin espacios ni caracteres especiales\n          </small>\n        </div>\n\n        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">\n          <div>\n            <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">\n              Icono * (Emoji)\n            </label>\n            <input type="text" id="categoriaIcon" required maxlength="2"\n                   placeholder=""\n                   style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1.5rem; text-align: center;">\n          </div>\n          \n          <div>\n            <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">\n              Nombre *\n            </label>\n            <input type="text" id="categoriaName" required \n                   placeholder="ej: Plataforma"\n                   style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.95rem;">\n          </div>\n        </div>\n\n        <div>\n          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">\n            Color *\n          </label>\n          <div style="display: flex; gap: 10px; align-items: center;">\n            <input type="color" id="categoriaColor" required value="#3b82f6"\n                   style="width: 60px; height: 40px; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; background: none;">\n            <input type="text" id="categoriaColorHex" value="#3b82f6" pattern="^#[0-9A-Fa-f]{6}$"\n                   placeholder="#3b82f6"\n                   style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-family: monospace; font-size: 0.95rem;">\n          </div>\n        </div>\n\n        <div>\n          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">\n            Descripcin *\n          </label>\n          <textarea id="categoriaDescription" required rows="2"\n                    placeholder="Descripcin breve de esta categora"\n                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.9rem; resize: vertical; font-family: inherit;"></textarea>\n        </div>\n\n        <div style="display: flex; gap: 10px; margin-top: 10px;">\n          <button type="submit" \n                  style="flex: 1; background: var(--success); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem;">\n             Crear Categora\n          </button>\n          <button type="button" onclick="app.cerrarModalCategoria()" \n                  style="flex: 1; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem;">\n             Cancelar\n          </button>\n        </div>\n      </form>\n    ',e.style.display="block",setTimeout(()=>{const e=document.getElementById("categoriaColor"),t=document.getElementById("categoriaColorHex");e&&t&&(e.addEventListener("input",()=>{t.value=e.value}),t.addEventListener("input",()=>{/^#[0-9A-Fa-f]{6}$/.test(t.value)&&(e.value=t.value)}));const a=document.getElementById("formNuevaCategoria");a&&a.addEventListener("submit",e=>{e.preventDefault(),this.guardarNuevaCategoria()})},100))}guardarNuevaCategoria(){const e=document.getElementById("categoriaId").value.trim().toLowerCase(),t=document.getElementById("categoriaIcon").value.trim(),a=document.getElementById("categoriaName").value.trim(),n=document.getElementById("categoriaColor").value,i=document.getElementById("categoriaDescription").value.trim();/^[a-z0-9_]+$/.test(e)?l.categories[e]?this.showToast(" Ya existe una categora con este ID","error"):(l.categories[e]={icon:t,name:a,color:n,description:i},localStorage.setItem("mapCategories",JSON.stringify(l.categories)),this.showToast(` Categora "${a}" creada exitosamente`,"success"),this.renderCategoriasAreasConfig(),l.renderAreasList(),this.cerrarModalCategoria()):this.showToast(" El ID solo puede contener letras minsculas, nmeros y guiones bajos","error")}cerrarModalCategoria(){const e=document.getElementById("modal");if(e){e.style.display="none";const t=document.querySelector(".modal-content");t&&(t.innerHTML="")}}editarCategoria(e){const t=l.categories[e];if(!t)return;const a=document.getElementById("modal"),n=document.querySelector(".modal-content");a&&n&&(n.innerHTML=`\n      <span class="close" onclick="app.cerrarModalCategoria()">&times;</span>\n      <h2 style="color: var(--primary); margin-bottom: 20px; font-size: 1.5rem;"> Editar Categora: ${t.name}</h2>\n      <form id="formEditarCategoria" style="display: flex; flex-direction: column; gap: 16px;">\n        \n        <div>\n          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">\n            ID de la Categora\n          </label>\n          <input type="text" value="${e}" disabled\n                 style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-muted); font-size: 0.95rem; cursor: not-allowed;">\n          <small style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-top: 4px;">\n            El ID no se puede modificar\n          </small>\n        </div>\n\n        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">\n          <div>\n            <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">\n              Icono * (Emoji)\n            </label>\n            <input type="text" id="editCategoriaIcon" required maxlength="2" value="${t.icon}"\n                   style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1.5rem; text-align: center;">\n          </div>\n          \n          <div>\n            <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">\n              Nombre *\n            </label>\n            <input type="text" id="editCategoriaName" required value="${t.name}"\n                   style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.95rem;">\n          </div>\n        </div>\n\n        <div>\n          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">\n            Color *\n          </label>\n          <div style="display: flex; gap: 10px; align-items: center;">\n            <input type="color" id="editCategoriaColor" required value="${t.color}"\n                   style="width: 60px; height: 40px; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; background: none;">\n            <input type="text" id="editCategoriaColorHex" value="${t.color}" pattern="^#[0-9A-Fa-f]{6}$"\n                   style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-family: monospace; font-size: 0.95rem;">\n          </div>\n        </div>\n\n        <div>\n          <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem;">\n            Descripcin *\n          </label>\n          <textarea id="editCategoriaDescription" required rows="2"\n                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.9rem; resize: vertical; font-family: inherit;">${t.description}</textarea>\n        </div>\n\n        <div style="display: flex; gap: 10px; margin-top: 10px;">\n          <button type="submit" \n                  style="flex: 1; background: var(--info); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem;">\n             Guardar Cambios\n          </button>\n          <button type="button" onclick="app.cerrarModalCategoria()" \n                  style="flex: 1; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem;">\n             Cancelar\n          </button>\n        </div>\n      </form>\n    `,a.style.display="block",setTimeout(()=>{const e=document.getElementById("editCategoriaColor"),t=document.getElementById("editCategoriaColorHex");e&&t&&(e.addEventListener("input",()=>{t.value=e.value}),t.addEventListener("input",()=>{/^#[0-9A-Fa-f]{6}$/.test(t.value)&&(e.value=t.value)}));const a=document.getElementById("formEditarCategoria");a&&a.addEventListener("submit",e=>{e.preventDefault(),c.actualizarCategoria("${categoryId}")})},100))}actualizarCategoria(e){const t=document.getElementById("editCategoriaIcon").value.trim(),a=document.getElementById("editCategoriaName").value.trim(),n=document.getElementById("editCategoriaColor").value,i=document.getElementById("editCategoriaDescription").value.trim();l.categories[e]={icon:t,name:a,color:n,description:i},localStorage.setItem("mapCategories",JSON.stringify(l.categories)),l.state.areas.forEach(t=>{t.category===e&&(t.color=n)}),l.saveAreas(),l.draw(),this.showToast(` Categora "${a}" actualizada exitosamente`,"success"),this.renderCategoriasAreasConfig(),l.renderAreasList(),this.cerrarModalCategoria()}eliminarCategoria(e){const t=l.categories[e];if(!t)return;const a=l.state.areas.filter(t=>t.category===e).length;let n=`Eliminar la categora "${t.name}"?`;a>0&&(n+=`\n\n ADVERTENCIA: ${a} rea(s) del mapa usan esta categora.\nSe restablecern a la categora por defecto "rea".`),confirm(n)&&(a>0&&(l.state.areas.forEach(t=>{t.category===e&&(t.category="area",t.color=l.categories.area.color)}),l.saveAreas(),l.draw(),l.renderAreasList()),delete l.categories[e],localStorage.setItem("mapCategories",JSON.stringify(l.categories)),this.showToast(` Categora "${t.name}" eliminada`,"success"),this.renderCategoriasAreasConfig())}setupAutocomplete(){["codProv","tipo","area","equipo"].forEach(e=>{const t=document.getElementById(e),a=document.getElementById(`autocomplete-${e}`);t&&a&&(t.addEventListener("input",()=>{const n=t.value.trim();if(!n)return void a.classList.remove("active");const i=this.autocompleteData[e].filter(e=>e.toLowerCase().includes(n.toLowerCase()));0!==i.length?(a.innerHTML=i.map(t=>`\n          <div class="autocomplete-item" onclick="app.selectAutocomplete('${e}', '${t.replace(/'/g,"\\'")}')">\n            ${t}\n          </div>\n        `).join(""),a.classList.add("active")):a.classList.remove("active")}),t.addEventListener("blur",()=>{setTimeout(()=>a.classList.remove("active"),200)}))})}selectAutocomplete(e,t){document.getElementById(e).value=t,document.getElementById(`autocomplete-${e}`).classList.remove("active")}async openLightbox(e){const t=this.repuestos.find(t=>t.id===e);if(!t)return;if(!t.multimedia||0===t.multimedia.length)return;if(this.lightboxMedias=t.multimedia.filter(e=>"image"===e.type||"video"===e.type),0===this.lightboxMedias.length)return;this.lightboxIndex=0;document.getElementById("lightbox").classList.add("active"),await this.showLightbox()}async showLightbox(){const e=this.lightboxMedias[this.lightboxIndex],t=document.getElementById("lightboxContent");if(t.innerHTML='<div style="color: white; text-align: center; padding: 40px;">Cargando...</div>',"video"===e.type)t.innerHTML=`<video src="${e.url}" controls autoplay style="max-width: 100%; max-height: 90vh;"></video>`;else{let i=e.url;if(e.isFileSystem&&n.isFileSystemMode&&!i.startsWith("blob:"))try{const t=e.url.replace("./imagenes/",""),a=await n.imagesFolder.getFileHandle(t),s=await a.getFile();i=URL.createObjectURL(s)}catch(a){return void(t.innerHTML='<div style="color: white; text-align: center; padding: 40px;">Error al cargar la imagen</div>')}t.innerHTML=`<img id="lightboxImage" src="${i}" style="max-width: 100%; max-height: 90vh; transition: transform 0.2s ease; cursor: grab;" alt="Imagen ampliada">`,setTimeout(()=>{const e=document.getElementById("lightboxImage");if(e){let a=1,n=!1,i=0,s=0,r=0,o=0;t.addEventListener("wheel",t=>{t.preventDefault();const n=t.deltaY>0?-.1:.1;a=Math.max(1,Math.min(5,a+n)),1===a?(r=0,o=0,e.style.cursor="grab"):e.style.cursor=a>1?"grab":"default",e.style.transform=`translate(${r/a}px, ${o/a}px) scale(${a})`},{passive:!1}),e.addEventListener("mousedown",t=>{a>1&&(t.preventDefault(),n=!0,i=t.clientX-r,s=t.clientY-o,e.style.cursor="grabbing")}),document.addEventListener("mousemove",t=>{n&&(r=t.clientX-i,o=t.clientY-s,e.style.transform=`translate(${r/a}px, ${o/a}px) scale(${a})`)}),document.addEventListener("mouseup",()=>{n&&(n=!1,e.style.cursor=a>1?"grab":"default")}),e.addEventListener("dblclick",t=>{t.preventDefault(),a=1,r=0,o=0,e.style.cursor="grab",e.style.transform="translate(0px, 0px) scale(1)"})}},100)}document.getElementById("lightboxCounter").textContent=`${this.lightboxIndex+1} / ${this.lightboxMedias.length}`}closeLightbox(){document.getElementById("lightbox").classList.remove("active")}async lightboxPrev(){this.lightboxIndex=(this.lightboxIndex-1+this.lightboxMedias.length)%this.lightboxMedias.length,await this.showLightbox()}async lightboxNext(){this.lightboxIndex=(this.lightboxIndex+1)%this.lightboxMedias.length,await this.showLightbox()}renderValores(){const e=document.getElementById("valoresResumen");document.getElementById("valoresTabContent");const t=this.repuestos.reduce((e,t)=>e+(t.precio||0)*(t.cantidad||0),0),a=this.repuestos.length>0?t/this.repuestos.length:0,n={};this.repuestos.forEach(e=>{const t=e.area||"Sin rea";n[t]||(n[t]={cantidad:0,valor:0,repuestos:[]});const a=(e.precio||0)*(e.cantidad||0);n[t].cantidad++,n[t].valor+=a,n[t].repuestos.push({nombre:e.nombre,codSAP:e.codSAP,cantidad:e.cantidad,precio:e.precio||0,valor:a})});const i={};this.repuestos.forEach(e=>{const t=e.equipo||"Sin Equipo";i[t]||(i[t]={cantidad:0,valor:0}),i[t].cantidad++,i[t].valor+=(e.precio||0)*(e.cantidad||0)});const s={};this.repuestos.forEach(e=>{const t=e.tipo||"Sin Tipo";s[t]||(s[t]={cantidad:0,valor:0}),s[t].cantidad++,s[t].valor+=(e.precio||0)*(e.cantidad||0)});const r=this.repuestos.map(e=>({nombre:e.nombre,codSAP:e.codSAP||"",area:e.area,cantidad:e.cantidad,precio:e.precio||0,valor:(e.precio||0)*(e.cantidad||0)})).filter(e=>e.valor>0).sort((e,t)=>t.valor-e.valor).slice(0,10);e.innerHTML=`\n      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">\n        <div>\n          <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 4px; color: #94a3b8;">$${t.toLocaleString("es-ES",{minimumFractionDigits:2})}</div>\n          <div style="opacity: 0.85; font-size: 1.1rem; color: var(--text-secondary);">Valor Total del Inventario</div>\n        </div>\n        <div>\n          <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 4px; color: #94a3b8;">$${a.toLocaleString("es-ES",{minimumFractionDigits:2})}</div>\n          <div style="opacity: 0.85; font-size: 1.1rem; color: var(--text-secondary);">Valor Promedio por Repuesto</div>\n        </div>\n        <div>\n          <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 4px; color: #94a3b8;">${this.repuestos.length}</div>\n          <div style="opacity: 0.85; font-size: 1.1rem; color: var(--text-secondary);">Total de Repuestos</div>\n        </div>\n      </div>\n    `,this.valoresData={areaStats:n,equipoStats:i,tipoStats:s,topValiosos:r,valorTotal:t},this.switchValoresTab("area")}switchValoresTab(e){document.querySelectorAll(".tab-valores").forEach(e=>{e.style.background="var(--bg-primary)",e.style.color="var(--text-secondary)",e.style.border="1px solid var(--border-color)",e.style.boxShadow="none"});const t=document.getElementById(`tab${e.charAt(0).toUpperCase()+e.slice(1)}`);t.style.background="var(--primary)",t.style.color="white",t.style.border="none",t.style.boxShadow="0 0 15px rgba(59, 130, 246, 0.5)";const a=document.getElementById("valoresTabContent"),n=this.valoresData;let i="";if("area"===e){Object.entries(n.areaStats).sort((e,t)=>t[1].valor-e[1].valor).forEach(([e,t])=>{const a=(t.valor/n.valorTotal*100).toFixed(1),s=t.repuestos.sort((e,t)=>t.valor-e.valor).slice(0,5);i+=`\n          <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">\n            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">\n              <h3 style="margin: 0; color: var(--primary); font-size: 1.2rem;">${e}</h3>\n              <div style="text-align: right;">\n                <div style="font-size: 1.5rem; font-weight: bold; color: #7A9AB8;">$${t.valor.toLocaleString("es-ES",{minimumFractionDigits:2})}</div>\n                <div style="font-size: 0.85rem; color: var(--gray-500);">${a}% del total</div>\n              </div>\n            </div>\n            <div style="display: flex; gap: 20px; margin-bottom: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px;">\n              <div><strong>${t.cantidad}</strong> repuestos</div>\n              <div><strong>$${(t.valor/t.cantidad).toLocaleString("es-ES",{minimumFractionDigits:2})}</strong> promedio</div>\n            </div>\n            <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Top 5 ms valiosos:</div>\n            <div style="display: grid; gap: 6px;">\n              ${s.map((e,t)=>`\n                <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-primary); border-radius: 6px; font-size: 0.9rem;">\n                  <span><strong>${t+1}.</strong> ${e.nombre} ${e.codSAP?`(${e.codSAP})`:""}</span>\n                  <span style="font-weight: 600; color: #7A9AB8;">$${e.valor.toLocaleString("es-ES",{minimumFractionDigits:2})}</span>\n                </div>\n              `).join("")}\n            </div>\n          </div>\n        `})}else if("equipo"===e){const e=Object.entries(n.equipoStats).sort((e,t)=>t[1].valor-e[1].valor);i+='<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">',e.forEach(([e,t])=>{const a=(t.valor/n.valorTotal*100).toFixed(1);i+=`\n          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; border-left: 4px solid var(--info); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">\n            <h4 style="margin: 0 0 12px 0; color: var(--info);">${e}</h4>\n            <div style="font-size: 1.3rem; font-weight: bold; color: #7A9AB8; margin-bottom: 4px;">$${t.valor.toLocaleString("es-ES",{minimumFractionDigits:2})}</div>\n            <div style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 8px;">${a}% del total</div>\n            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--gray-200); font-size: 0.9rem;">\n              <span>${t.cantidad} repuestos</span>\n              <span>$${(t.valor/t.cantidad).toFixed(2)} prom.</span>\n            </div>\n          </div>\n        `}),i+="</div>"}else if("tipo"===e){const e=Object.entries(n.tipoStats).sort((e,t)=>t[1].valor-e[1].valor);i+='<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">',e.forEach(([e,t])=>{const a=(t.valor/n.valorTotal*100).toFixed(1);i+=`\n          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; border-left: 4px solid var(--secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">\n            <h4 style="margin: 0 0 12px 0; color: var(--secondary);">${e}</h4>\n            <div style="font-size: 1.3rem; font-weight: bold; color: #7A9AB8; margin-bottom: 4px;">$${t.valor.toLocaleString("es-ES",{minimumFractionDigits:2})}</div>\n            <div style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 8px;">${a}% del total</div>\n            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--gray-200); font-size: 0.9rem;">\n              <span>${t.cantidad} repuestos</span>\n              <span>$${(t.valor/t.cantidad).toFixed(2)} prom.</span>\n            </div>\n          </div>\n        `}),i+="</div>"}else"top"===e&&(i+=`\n        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">\n          <h3 style="margin: 0 0 16px 0; color: var(--primary);">Top 10 Repuestos Ms Valiosos</h3>\n          <div style="display: grid; gap: 12px;">\n            ${n.topValiosos.map((e,t)=>`\n                <div style="display: grid; grid-template-columns: 40px 1fr auto; gap: 12px; align-items: center; padding: 12px; background: ${t<3?"linear-gradient(135deg, rgba(91, 124, 153, 0.15) 0%, rgba(122, 154, 184, 0.15) 100%)":"var(--bg-primary)"}; border-radius: 8px; border-left: 4px solid ${t<3?"var(--primary)":"var(--border-color)"}; border: 1px solid var(--border-color);">\n                  <div style="font-size: 1.5rem; text-align: center; font-weight: 700; color: var(--primary);">${t+1}</div>\n                  <div>\n                    <div style="font-weight: 600; color: var(--text-primary);">${e.nombre}</div>\n                    <div style="font-size: 0.85rem; color: var(--text-secondary);">\n                      ${e.codSAP}  ${e.area}  ${e.cantidad} unidades\n                    </div>\n                  </div>\n                  <div style="text-align: right;">\n                    <div style="font-size: 1.3rem; font-weight: bold; color: #7A9AB8;">$${e.valor.toLocaleString("es-ES",{minimumFractionDigits:2})}</div>\n                    <div style="font-size: 0.8rem; color: var(--text-muted);">$${e.precio.toFixed(2)} c/u</div>\n                  </div>\n                </div>\n              `).join("")}\n          </div>\n        </div>\n      `);a.innerHTML=i}iniciarConteo(){this.conteoActivo=!0,this.conteoData={},this.conteoFiltros={search:"",estado:"todos",area:"todas",orden:"codigo"},this.conteoAgrupadoPorArea=!1,this.repuestos.forEach(e=>{this.conteoData[e.id]={original:e.cantidad,nuevo:e.cantidad,contado:!1}});const e=[...new Set(this.repuestos.map(e=>e.area||"Sin rea"))].sort();document.getElementById("conteoFilterArea").innerHTML='<option value="todas">Todas las reas</option>'+e.map(e=>`<option value="${e}">${e}</option>`).join(""),document.getElementById("conteoSearch").addEventListener("input",e=>{this.conteoFiltros.search=e.target.value.toLowerCase(),this.renderConteo()}),document.getElementById("conteoFilterEstado").addEventListener("change",e=>{this.conteoFiltros.estado=e.target.value,this.renderConteo()}),document.getElementById("conteoFilterArea").addEventListener("change",e=>{this.conteoFiltros.area=e.target.value,this.renderConteo()}),document.getElementById("conteoOrden").addEventListener("change",e=>{this.conteoFiltros.orden=e.target.value,this.renderConteo()}),document.getElementById("btnIniciarConteo").style.display="none",document.getElementById("btnFinalizarConteo").style.display="block",document.getElementById("conteoFilters").style.display="block",document.getElementById("conteoProgress").style.display="block",this.renderConteo()}finalizarConteo(){const e=[],t=[];let a=0,n=0;Object.keys(this.conteoData).forEach(i=>{const s=this.conteoData[i];if(s.contado){a++;const n=s.nuevo-s.original;if(0!==n){const a=this.repuestos.find(e=>e.id===i);e.push({repuesto:a,diferencia:n}),Math.abs(n/(s.original||1))>.2&&t.push({repuesto:a,diferencia:n,porcentaje:(n/(s.original||1)*100).toFixed(1)})}}else n++});let i=`<div style="text-align: left; max-height: 400px; overflow-y: auto;">\n      <h3 style="color: var(--primary); margin-bottom: 16px;">Resumen del Conteo</h3>\n      <div style="display: grid; gap: 12px; margin-bottom: 20px;">\n        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">\n          <strong>Total contados:</strong> ${a} de ${this.repuestos.length}\n        </div>\n        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">\n          <strong>Sin contar:</strong> ${n} productos (mantendrn cantidad actual)\n        </div>\n        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">\n          <strong>Con diferencias:</strong> ${e.length} productos\n        </div>\n      </div>`;t.length>0&&(i+=`<div style="padding: 12px; background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 8px; margin-bottom: 16px;">\n        <strong style="color: #ef4444;"> Diferencias Grandes (>20%):</strong>\n        <ul style="margin-top: 8px;">\n          ${t.slice(0,5).map(e=>`<li>${e.repuesto.codSAP}: ${e.diferencia>0?"+":""}${e.diferencia} (${e.porcentaje}%)</li>`).join("")}\n          ${t.length>5?`<li>...y ${t.length-5} ms</li>`:""}\n        </ul>\n      </div>`),i+='<p style="margin-top: 16px;"><strong>Deseas aplicar estos cambios?</strong></p></div>',confirm(i)&&(Object.keys(this.conteoData).forEach(e=>{const t=this.conteoData[e];if(t.contado){const a=this.repuestos.find(t=>t.id===e);a&&(a.cantidad=t.nuevo)}}),this.guardarHistorialConteo({fecha:(new Date).toISOString(),totalContados:a,sinContar:n,cambios:e.length,grandesDiferencias:t.length}),this.conteoActivo=!1,this.saveData(),this.render(),document.getElementById("btnIniciarConteo").style.display="block",document.getElementById("btnFinalizarConteo").style.display="none",document.getElementById("conteoFilters").style.display="none",document.getElementById("conteoProgress").style.display="none",this.showToast(` Conteo aplicado: ${e.length} cambios, ${n} sin modificar`,"success"))}renderConteo(){const e=document.getElementById("conteoGrid");if(!this.conteoActivo){const t=this.repuestos.length,a=this.repuestos.filter(e=>0===e.cantidad).length,n=this.repuestos.filter(e=>e.cantidad>0&&e.cantidad<=(e.minimo||5)).length,i="#0f172a",s="#cbd5e1",r="#334155";return void(e.innerHTML=`\n        <div style="max-width: 600px; margin: 0 auto; padding: 40px 20px; text-align: center;">\n          <div style="font-size: 4rem; margin-bottom: 20px;"></div>\n          <h2 style="color: #60a5fa; margin-bottom: 16px;">Conteo de Inventario</h2>\n          <p style="color: ${s}; margin-bottom: 32px; line-height: 1.8;">\n            Inicia un conteo fsico para actualizar las cantidades reales de los repuestos\n          </p>\n          \n          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 32px;">\n            <div style="background: ${i}; padding: 20px; border-radius: 12px; border: 1px solid ${r};">\n              <div style="font-size: 2rem; font-weight: 700; color: #60a5fa;">${t}</div>\n              <div style="font-size: 0.9rem; color: ${s}; margin-top: 4px;">Total Repuestos</div>\n            </div>\n            <div style="background: ${i}; padding: 20px; border-radius: 12px; border: 1px solid ${r};">\n              <div style="font-size: 2rem; font-weight: 700; color: #fbbf24;">${n}</div>\n              <div style="font-size: 0.9rem; color: ${s}; margin-top: 4px;">Stock Bajo</div>\n            </div>\n            <div style="background: ${i}; padding: 20px; border-radius: 12px; border: 1px solid ${r};">\n              <div style="font-size: 2rem; font-weight: 700; color: #f87171;">${a}</div>\n              <div style="font-size: 0.9rem; color: ${s}; margin-top: 4px;">Sin Stock</div>\n            </div>\n          </div>\n          \n          <div style="background: #0f172a; color: #22d3ee; padding: 16px; border-radius: 12px; margin-bottom: 24px; border: 1px solid #334155;">\n            <strong> Consejo:</strong> Usa la cmara de tu mvil para escanear cdigos mientras cuentas\n          </div>\n          \n          <button class="btn btn-success" style="font-size: 1.1rem; padding: 16px 32px;" onclick="app.iniciarConteo()">\n            Iniciar Conteo\n          </button>\n        </div>\n      `)}let t=this.repuestos.filter(e=>{const t=this.conteoData[e.id],a=this.conteoFiltros.search,n=this.conteoFiltros.estado,i=this.conteoFiltros.area;if(a){if(!(e.codSAP.toLowerCase().includes(a)||e.nombre.toLowerCase().includes(a)||(e.area||"").toLowerCase().includes(a)))return!1}return!("contados"===n&&!t.contado)&&(("no-contados"!==n||!t.contado)&&(("diferencias"!==n||t.nuevo!==t.original)&&("todas"===i||(e.area||"Sin rea")===i)))});const a=this.conteoFiltros.orden;t.sort((e,t)=>{if("codigo"===a)return e.codSAP.localeCompare(t.codSAP);if("nombre"===a)return e.nombre.localeCompare(t.nombre);if("area"===a)return(e.area||"").localeCompare(t.area||"");if("diferencia"===a){const a=Math.abs(this.conteoData[e.id].nuevo-this.conteoData[e.id].original);return Math.abs(this.conteoData[t.id].nuevo-this.conteoData[t.id].original)-a}if("no-contados"===a){return(this.conteoData[e.id].contado?1:0)-(this.conteoData[t.id].contado?1:0)}return 0});const n=Object.values(this.conteoData).filter(e=>e.contado).length,i=this.repuestos.length,s=(n/i*100).toFixed(0);document.getElementById("conteoProgressBar").style.width=`${s}%`,document.getElementById("conteoProgressText").textContent=`${n} de ${i} repuestos contados (${s}%)  Mostrando ${t.length}`,this.conteoAgrupadoPorArea?e.innerHTML=this.renderConteoAgrupado(t):e.innerHTML=t.map(e=>{const t=this.conteoData[e.id],a=t.nuevo-t.original,n=(e.multimedia||[]).find(e=>"image"===e.type),i=t.original>0?(a/t.original*100).toFixed(1):0,s=Math.abs(i)>20;return`\n        <div class="conteo-card-responsive ${s?"conteo-alerta":""}">\n          ${n?`\n            <div class="conteo-img-wrapper">\n              <img src="${n.url}" class="conteo-img" alt="${e.nombre}">\n            </div>\n          `:""}\n          \n          <div class="conteo-info">\n            <div class="conteo-header">\n              <div>\n                <strong class="conteo-codigo">${e.codSAP}</strong>\n                <span class="conteo-nombre">${e.nombre}</span>\n                ${e.area?`<span class="conteo-area">${e.area}</span>`:""}\n              </div>\n            </div>\n            \n            <div class="conteo-stats">\n              <div class="conteo-stat-item">\n                <span class="conteo-stat-label">En Sistema:</span>\n                <span class="conteo-stat-value">${t.original}</span>\n              </div>\n              ${0!==a?`\n                <div class="conteo-stat-item">\n                  <span class="conteo-stat-label">Diferencia:</span>\n                  <span class="conteo-diferencia ${a>0?"positiva":"negativa"}">\n                    ${a>0?"+":""}${a} (${i}%)\n                  </span>\n                </div>\n              `:'<div class="conteo-stat-item"><span class="conteo-igual"> Igual</span></div>'}\n              ${s?'<div class="conteo-revisar"> REVISAR</div>':""}\n            </div>\n          </div>\n          \n          <div class="conteo-control">\n            <label class="conteo-label">Cantidad Fsica:</label>\n            <div class="conteo-input-group">\n              <button class="conteo-btn-minus" onclick="app.ajustarConteo('${e.id}', -1)" type="button">\n                <span class="btn-symbol"></span>\n              </button>\n              <input \n                type="number" \n                class="conteo-input-number" \n                value="${t.nuevo}" \n                min="0"\n                id="conteo-${e.id}"\n                data-action="update-conteo" \n                data-id="${e.id}"\n                placeholder="0"\n              >\n              <button class="conteo-btn-plus" onclick="app.ajustarConteo('${e.id}', 1)" type="button">\n                <span class="btn-symbol">+</span>\n              </button>\n            </div>\n          </div>\n        </div>\n        `}).join("")}renderConteoAgrupado(e){const t={};return e.forEach(e=>{const a=e.area||"Sin rea";t[a]||(t[a]=[]),t[a].push(e)}),Object.keys(t).sort().map(e=>{const a=t[e],n=a.filter(e=>this.conteoData[e.id].contado).length,i="conteo-area-"+e.replace(/\s/g,"-");return`\n        <div style="margin-bottom: 24px; border: 2px solid var(--border-color); border-radius: 12px; overflow: hidden;">\n          <div onclick="app.toggleConteoArea('${i}')" \n            style="background: var(--bg-secondary); padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">\n            <div>\n              <h3 style="margin: 0; color: var(--primary); font-size: 1.1rem;">\n                <span id="${i}-icon" style="display: inline-block; transition: transform 0.3s;"></span>\n                ${e}\n              </h3>\n            </div>\n            <div style="text-align: right; font-size: 0.9rem; color: var(--text-secondary);">\n              <strong style="color: var(--success);">${n}/${a.length}</strong> contados\n            </div>\n          </div>\n          <div id="${i}" style="padding: 12px;">\n            ${a.map(e=>{const t=this.conteoData[e.id],a=t.nuevo-t.original,n=(e.multimedia||[]).find(e=>"image"===e.type);return`\n                <div class="conteo-item" style="display: grid; grid-template-columns: ${n?"auto 1fr":"1fr"}; gap: 12px; margin-bottom: 12px;">\n                  ${n?`<img src="${n.url}" style="width: 70px; height: 70px; object-fit: cover; border-radius: 8px;">`:""}\n                  <div style="flex: 1;">\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n                      <div>\n                        <strong style="color: var(--primary);">${e.codSAP}</strong><br>\n                        <span style="font-size: 0.9rem; color: var(--text-secondary);">${e.nombre}</span>\n                      </div>\n                      <div style="text-align: right; font-size: 0.85rem;">\n                        <div>Sistema: ${t.original}</div>\n                        ${0!==a?`<div style="font-weight: 700; color: ${a>0?"var(--success)":"var(--danger)"};">${a>0?"+":""}${a}</div>`:""}\n                      </div>\n                    </div>\n                    <input type="number" class="conteo-input" value="${t.nuevo}" min="0" \n                      data-action="update-conteo" data-id="${e.id}" placeholder="Cantidad fsica"\n                      style="width: 100%; padding: 10px; font-size: 1.1rem; text-align: center; font-weight: 700;">\n                  </div>\n                </div>\n              `}).join("")}\n          </div>\n        </div>\n      `}).join("")}toggleConteoArea(e){const t=document.getElementById(e),a=document.getElementById(e+"-icon");"none"===t.style.display?(t.style.display="block",a.style.transform="rotate(0deg)",a.textContent=""):(t.style.display="none",a.style.transform="rotate(-90deg)",a.textContent="")}updateConteo(e,t){if(this.conteoData[e]){const a=parseInt(t)||0;this.conteoData[e].nuevo=a,this.conteoData[e].contado=!0,this.renderConteo()}}ajustarConteo(e,t){const a=document.getElementById(`conteo-${e}`);if(!a)return;const n=parseInt(a.value)||0,i=Math.max(0,n+t);a.value=i,this.updateConteo(e,i)}abrirModalConteoIndividual(e){const t=this.repuestos.find(t=>t.id===e);if(!t)return void this.showToast(" Repuesto no encontrado","error");const a="#4A5568",n="#5A6778",i="#5B7C99",s="#6B8E7F",r="#D4976C",o="#C76B6B",l=t.minimo||t.stockMinimo||5,d=t.cantidad||0,c=0===d?"AGOTADO":d<=l?"BAJO":"OK",p=0===d?o:d<=l?r:s,u=`\n      <div class="modal-backdrop-custom" id="modalConteoIndividual">\n        <div class="modal-dialog-custom" style="max-width: 540px; animation: slideUp 0.3s ease-out;">\n          <div class="modal-content-custom" style="border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid ${a};">\n            \n            \x3c!-- HEADER MINIMALISTA CON NUEVA PALETA --\x3e\n            <div class="modal-header-custom" style="background: ${a}; color: #F7FAFC; padding: 20px 24px; border-bottom: 3px solid ${i};">\n              <div style="display: flex; align-items: center; gap: 12px; flex: 1;">\n                <span style="font-size: 1.8rem; opacity: 0.9;"></span>\n                <div>\n                  <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: white;">Conteo Individual</h3>\n                  <p style="margin: 4px 0 0 0; opacity: 0.7; font-size: 0.8rem;">Actualiza la cantidad fsica en inventario</p>\n                </div>\n              </div>\n              <button class="close-btn" onclick="app.cerrarModalConteoIndividual()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 32px; height: 32px; border-radius: 6px; font-size: 1.3rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'"></button>\n            </div>\n            \n            <div class="modal-body-custom" style="padding: 24px;">\n              \n              \x3c!-- CARD DE INFORMACIN DEL PRODUCTO - MINIMALISTA --\x3e\n              <div style="background: #1e293b; border: 1px solid #334155; padding: 16px; border-radius: 8px; margin-bottom: 18px;">\n                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">\n                  <h4 style="margin: 0; font-size: 1rem; color: #e2e8f0; font-weight: 600; max-width: 70%;">${t.nombre}</h4>\n                  <span style="background: ${p}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; opacity: 0.95;"> ${c}</span>\n                </div>\n                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.8rem; color: #A0AEC0;">\n                  <div style="display: flex; align-items: center; gap: 6px;">\n                    <span style="color: ${i}; opacity: 0.8;"></span>\n                    <span><strong style="color: #F7FAFC;">rea:</strong> ${t.area||"N/A"}</span>\n                  </div>\n                  <div style="display: flex; align-items: center; gap: 6px;">\n                    <span style="color: ${i}; opacity: 0.8;"></span>\n                    <span><strong style="color: #F7FAFC;">Equipo:</strong> ${t.equipo||"N/A"}</span>\n                  </div>\n                  <div style="display: flex; align-items: center; gap: 6px;">\n                    <span style="color: ${i}; opacity: 0.8;"></span>\n                    <span><strong style="color: #F7FAFC;">SAP:</strong> ${t.codSAP||"N/A"}</span>\n                  </div>\n                  <div style="display: flex; align-items: center; gap: 6px;">\n                    <span style="color: ${i}; opacity: 0.8;"></span>\n                    <span><strong style="color: #F7FAFC;">Tipo:</strong> ${t.tipo||"N/A"}</span>\n                  </div>\n                </div>\n              </div>\n\n              \x3c!-- CANTIDAD ACTUAL EN SISTEMA - PALETA NIEBLA --\x3e\n              <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 14px; margin-bottom: 20px; align-items: center;">\n                <div style="background: ${a}; padding: 14px; border-radius: 8px; text-align: center; border-left: 3px solid ${i};">\n                  <div style="font-size: 0.75rem; color: #A0AEC0; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;"> En Sistema</div>\n                  <div style="font-size: 2.2rem; color: ${i}; font-weight: 700; line-height: 1;">${d}</div>\n                  <div style="font-size: 0.7rem; color: #718096; margin-top: 4px;">unidades</div>\n                </div>\n                \n                <div style="font-size: 1.5rem; color: ${n}; opacity: 0.6;"></div>\n                \n                <div style="background: ${a}; padding: 14px; border-radius: 8px; text-align: center; border-left: 3px solid ${r};">\n                  <div style="font-size: 0.75rem; color: #A0AEC0; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;"> Mnimo</div>\n                  <div style="font-size: 2.2rem; color: ${r}; font-weight: 700; line-height: 1;">${l}</div>\n                  <div style="font-size: 0.7rem; color: #718096; margin-top: 4px;">requerido</div>\n                </div>\n              </div>\n\n              \x3c!-- INFORMACIN DE LTIMO CONTEO - MINIMALISTA --\x3e\n              ${t.ultimoConteo?`\n                <div style="background: #1e293b; padding: 10px 14px; border-radius: 6px; margin-bottom: 18px; border-left: 3px solid #527853; display: flex; align-items: center; gap: 10px;">\n                  <span style="font-size: 1.2rem; opacity: 0.8;"></span>\n                  <div>\n                    <div style="font-size: 0.75rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">ltimo conteo</div>\n                    <div style="font-size: 0.85rem; color: #cbd5e1; font-weight: 600; margin-top: 3px;">\n                      ${new Date(t.ultimoConteo).toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}\n                    </div>\n                  </div>\n                </div>\n              `:'\n                <div style="background: #1e293b; padding: 10px 14px; border-radius: 6px; margin-bottom: 18px; border-left: 3px solid #8B5A5A; display: flex; align-items: center; gap: 10px;">\n                  <span style="font-size: 1.2rem; opacity: 0.8;"></span>\n                  <div>\n                    <div style="font-size: 0.75rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Sin conteo previo</div>\n                    <div style="font-size: 0.8rem; color: #cbd5e1; margin-top: 3px;">Este es el primer conteo que se registrar</div>\n                  </div>\n                </div>\n              '}\n\n              \x3c!-- SECCIN DE CONTEO - MINIMALISTA --\x3e\n              <div style="margin-bottom: 18px;">\n                <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 12px; color: #cbd5e1; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">\n                  <span style="font-size: 1.1rem; opacity: 0.8;"></span>\n                  Nueva Cantidad Fsica:\n                </label>\n                \n                \x3c!-- CONTADOR MINIMALISTA CON BOTONES +/- --\x3e\n                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 14px;">\n                  <button \n                    class="btn" \n                    onclick="const input = document.getElementById('inputConteoIndividual'); input.value = Math.max(0, parseInt(input.value || 0) - 1); input.focus();" \n                    style="background: ${o}; color: #F7FAFC; font-size: 2rem; font-weight: 700; padding: 0; min-width: 65px; height: 65px; border-radius: 8px; border: 1px solid #A85555; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;"\n                    onmouseover="this.style.background='#A85555'"\n                    onmouseout="this.style.background='${o}'"\n                    title="Disminuir cantidad">\n                    \n                  </button>\n                  \n                  <input \n                    type="number" \n                    id="inputConteoIndividual" \n                    class="form-control" \n                    value="${d}" \n                    min="0" \n                    style="font-size: 2.2rem; text-align: center; font-weight: 700; flex: 1; height: 65px; border: 2px solid ${i}; border-radius: 8px; background: #3A4556; color: #F7FAFC; transition: all 0.2s;"\n                    onfocus="this.style.borderColor='${i}'; this.style.background='${a}'"\n                    onblur="this.style.borderColor='${n}'; this.style.background='#3A4556'"\n                    autofocus\n                  />\n                  \n                  <button \n                    class="btn" \n                    onclick="const input = document.getElementById('inputConteoIndividual'); input.value = parseInt(input.value || 0) + 1; input.focus();" \n                    style="background: ${s}; color: #F7FAFC; font-size: 2rem; font-weight: 700; padding: 0; min-width: 65px; height: 65px; border-radius: 8px; border: 1px solid #557566; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;"\n                    onmouseover="this.style.background='#557566'"\n                    onmouseout="this.style.background='${s}'"\n                    title="Aumentar cantidad">\n                    +\n                  </button>\n                </div>\n                \n                \x3c!-- BOTONES RPIDOS MINIMALISTAS --\x3e\n                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">\n                  <button class="btn btn-sm" onclick="document.getElementById('inputConteoIndividual').value = 0; document.getElementById('inputConteoIndividual').focus();" \n                    style="background: ${a}; color: #F7FAFC; padding: 10px 8px; border-radius: 6px; border: 1px solid #5A6778; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;"\n                    onmouseover="this.style.background='${o}'; this.style.borderColor='#A85555'"\n                    onmouseout="this.style.background='${a}'; this.style.borderColor='#5A6778'">\n                     Vaco (0)\n                  </button>\n                  <button class="btn btn-sm" onclick="document.getElementById('inputConteoIndividual').value = ${d}; document.getElementById('inputConteoIndividual').focus();" \n                    style="background: ${a}; color: #F7FAFC; padding: 10px 8px; border-radius: 6px; border: 1px solid #5A6778; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;"\n                    onmouseover="this.style.background='${i}'; this.style.borderColor='#4A6278'"\n                    onmouseout="this.style.background='${a}'; this.style.borderColor='#5A6778'">\n                     = Sistema\n                  </button>\n                  <button class="btn btn-sm" onclick="document.getElementById('inputConteoIndividual').value = ${l}; document.getElementById('inputConteoIndividual').focus();" \n                    style="background: ${a}; color: #F7FAFC; padding: 10px 8px; border-radius: 6px; border: 1px solid #5A6778; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;"\n                    onmouseover="this.style.background='${r}'; this.style.borderColor='#B8825A'"\n                    onmouseout="this.style.background='${a}'; this.style.borderColor='#5A6778'">\n                     = Mnimo\n                  </button>\n                </div>\n              </div>\n\n              \x3c!-- NOTA INFORMATIVA CON NUEVA PALETA --\x3e\n              <div style="background: #3A4556; padding: 12px 14px; border-radius: 6px; border-left: 3px solid ${n}; font-size: 0.8rem; color: #A0AEC0; display: flex; gap: 10px; align-items: start;">\n                <span style="font-size: 1.1rem; line-height: 1; opacity: 0.7;"></span>\n                <div>\n                  <strong style="display: block; margin-bottom: 3px; color: #cbd5e1; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Nota:</strong>\n                  Se actualizar la cantidad y se registrar la fecha/hora del conteo automticamente.\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- FOOTER CON NUEVA PALETA --\x3e\n            <div class="modal-footer-custom" style="display: flex; gap: 10px; justify-content: flex-end; padding: 16px 24px; background: #2D3748; border-top: 1px solid ${a};">\n              <button class="btn" onclick="app.cerrarModalConteoIndividual()" \n                style="background: ${a}; color: #F7FAFC; padding: 10px 24px; font-weight: 600; border-radius: 6px; border: 1px solid #5A6778; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;"\n                onmouseover="this.style.background='#5A6778'"\n                onmouseout="this.style.background='${a}'">\n                 Cancelar\n              </button>\n              <button class="btn" onclick="app.guardarConteoIndividual('${e}')" \n                style="background: ${s}; color: #F7FAFC; padding: 10px 28px; font-weight: 600; border-radius: 6px; border: 1px solid #557566; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;"\n                onmouseover="this.style.background='#557566'"\n                onmouseout="this.style.background='${s}'">\n                 Guardar Conteo\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      <style>\n        @keyframes slideUp {\n          from {\n            opacity: 0;\n            transform: translateY(30px);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0);\n          }\n        }\n      </style>\n    `,m=document.createElement("div");m.innerHTML=u,document.body.appendChild(m),setTimeout(()=>{const e=document.getElementById("inputConteoIndividual");e&&(e.focus(),e.select())},100);const h=e=>{"Escape"===e.key&&(this.cerrarModalConteoIndividual(),document.removeEventListener("keydown",h))};document.addEventListener("keydown",h);const g=t=>{"Enter"===t.key&&"inputConteoIndividual"===t.target.id&&(this.guardarConteoIndividual(e),document.removeEventListener("keydown",g))};document.addEventListener("keydown",g)}cerrarModalConteoIndividual(){const e=document.getElementById("modalConteoIndividual");e&&e.parentElement.remove()}async guardarConteoIndividual(e){const t=document.getElementById("inputConteoIndividual");if(!t)return;const a=parseInt(t.value)||0,n=this.repuestos.find(t=>t.id===e);if(!n)return void this.showToast(" Error: Repuesto no encontrado","error");const i=n.cantidad;this.cerrarModalConteoIndividual(),n.cantidad=a,n.ultimoConteo=(new Date).toISOString(),n.ultimaModificacion=(new Date).toISOString();if(!(await this.saveData()))return this.showToast(" Error al guardar el conteo","error"),void(n.cantidad=i);const s=a-i,r=0!==s?` (${s>0?"+":""}${s})`:"",o=(new Date).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"});this.showToast(`Conteo guardado: <strong>${n.nombre}</strong><br>${i}  ${a}${r}<br>${o}`,"success",4e3),await this.renderInventario()}accionMasivaConteo(e){if("copiar-sistema"===e){if(!confirm("Copiar las cantidades del sistema a todos los productos fsicos?"))return;Object.keys(this.conteoData).forEach(e=>{this.conteoData[e].nuevo=this.conteoData[e].original,this.conteoData[e].contado=!0}),this.showToast(" Cantidades del sistema copiadas","success")}else if("resetear"===e){if(!confirm("Resetear todo el conteo? Se perdern los cambios."))return;Object.keys(this.conteoData).forEach(e=>{this.conteoData[e].nuevo=this.conteoData[e].original,this.conteoData[e].contado=!1}),this.showToast(" Conteo reseteado","info")}else if("aplicar-no-contados"===e){let e=0;Object.keys(this.conteoData).forEach(t=>{this.conteoData[t].contado||(this.conteoData[t].nuevo=this.conteoData[t].original,e++)}),this.showToast(` Cantidad del sistema aplicada a ${e} productos no contados`,"success")}this.renderConteo()}toggleAgruparPorArea(){this.conteoAgrupadoPorArea=!this.conteoAgrupadoPorArea,document.getElementById("btnAgruparTexto").textContent=this.conteoAgrupadoPorArea?"Vista Normal":"Agrupar por rea",this.renderConteo()}guardarHistorialConteo(e){const t=JSON.parse(localStorage.getItem("historialConteos")||"[]");t.unshift(e),t.length>20&&t.pop(),localStorage.setItem("historialConteos",JSON.stringify(t))}async exportarJSON(){if(this.fsManager.directoryHandle)try{const e={version:"2.4",exportDate:(new Date).toISOString(),repuestos:this.repuestos.map(e=>({id:e.id,codSAP:e.codSAP,codProv:e.codProv,tipo:e.tipo,nombre:e.nombre,area:e.area,equipo:e.equipo,cantidad:e.cantidad,minimo:e.minimo,precio:e.precio,multimedia:[]})),mapa:this.mapObjects||[]},t=JSON.stringify(e,null,2),a=new Blob([t],{type:"application/json"}),n="repuestos.json",i=await this.fsManager.directoryHandle.getFileHandle(n,{create:!0}),s=await i.createWritable();await s.write(a),await s.close(),this.registrarSincronizacion({tipo:"exportacion",fecha:(new Date).toISOString(),productos:this.repuestos.length,archivo:n,tamao:(a.size/1024).toFixed(2)+" KB"}),this.showToast(` JSON exportado: ${n} (${(a.size/1024).toFixed(2)} KB)`,"success")}catch(e){this.showToast(" Error al exportar: "+e.message,"error")}else this.showToast(" Primero debes seleccionar una carpeta","warning")}async importarJSON(){var e;if(this.fsManager.directoryHandle)try{const t=await this.fsManager.directoryHandle.getFileHandle("repuestos.json"),a=await t.getFile(),n=await a.text(),i=JSON.parse(n),s=(null==(e=i.repuestos)?void 0:e.length)||0;if(!confirm(` Archivo encontrado: repuestos.json\n\nProductos en archivo: ${s}\nProductos actuales: ${this.repuestos.length}\n\nCmo deseas importar?\n\n ACEPTAR = FUSIONAR (actualizar datos, mantener imgenes locales)\n CANCELAR = Cancelar operacin`))return void this.showToast("Importacin cancelada","info");const r=i.repuestos.map(e=>{const t=this.repuestos.find(t=>t.id===e.id||t.codSAP===e.codSAP);return t?{...e,multimedia:t.multimedia||[]}:{...e,multimedia:[]}}),o=r.length-this.repuestos.length,l=Math.min(r.length,this.repuestos.length);this.repuestos=r,i.mapa&&(this.mapObjects=i.mapa,localStorage.setItem("mapData",JSON.stringify(this.mapObjects))),this.saveData(),this.updateAutocompleteData(),this.render(),this.renderFilters(),this.registrarSincronizacion({tipo:"importacion",fecha:(new Date).toISOString(),productos:r.length,nuevos:o>0?o:0,actualizados:l,archivo:"repuestos.json",tamao:(a.size/1024).toFixed(2)+" KB"}),this.showToast(` Importacin completa: ${l} actualizados, ${o>0?o:0} nuevos`,"success")}catch(t){"NotFoundError"===t.name?this.showToast(" No se encontr repuestos.json en la carpeta","warning"):this.showToast(" Error al importar: "+t.message,"error")}else this.showToast(" Primero debes seleccionar una carpeta","warning")}registrarSincronizacion(e){const t=JSON.parse(localStorage.getItem("historialSincronizaciones")||"[]");t.unshift(e),t.length>50&&t.pop(),localStorage.setItem("historialSincronizaciones",JSON.stringify(t))}verHistorialSincronizaciones(){const e=JSON.parse(localStorage.getItem("historialSincronizaciones")||"[]");if(0===e.length)return void this.showToast(" No hay sincronizaciones registradas","info");const t=`\n      <div style="max-height: 500px; overflow-y: auto;">\n        <h3 style="color: var(--primary); margin-bottom: 16px;"> Historial de Sincronizaciones</h3>\n        <div style="display: grid; gap: 12px;">\n          ${e.slice(0,20).map((e,t)=>{const a=new Date(e.fecha),n=(e.tipo,""),i="exportacion"===e.tipo?"var(--success)":"var(--info)";return`\n              <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${i};">\n                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n                  <strong style="color: ${i};">${n} ${e.tipo.toUpperCase()}</strong>\n                  <span style="font-size: 0.85rem; color: var(--text-secondary);">\n                    ${a.toLocaleDateString()} ${a.toLocaleTimeString()}\n                  </span>\n                </div>\n                <div style="font-size: 0.9rem; color: var(--text-secondary);">\n                   Productos: ${e.productos} |  ${e.archivo} (${e.tamao})\n                  ${e.nuevos?`<br> Nuevos: ${e.nuevos} |  Actualizados: ${e.actualizados}`:""}\n                </div>\n              </div>\n            `}).join("")}\n        </div>\n        ${e.length>20?`<div style="text-align: center; padding: 12px; color: var(--text-secondary);">... y ${e.length-20} ms</div>`:""}\n      </div>\n    `,a=document.getElementById("modal"),n=a.querySelector(".modal-content");n.innerHTML,n.innerHTML=t+'<div style="text-align: center; margin-top: 20px;"><button class="btn btn-secondary" onclick="document.getElementById(\'modal\').style.display=\'none\'">Cerrar</button></div>',a.style.display="flex"}filtrarEscalonado(e,t){const a=document.getElementById("filtro_planta"),n=document.getElementById("filtro_area"),i=document.getElementById("filtro_subarea"),s=document.getElementById("filtro_sistemaEquipo"),r=document.getElementById("filtro_subsistema"),o=document.getElementById("filtro_seccion"),l=document.getElementById("filtro_detalle"),d=document.getElementById("btnLimpiarFiltros"),c=a.value||n.value||i.value||s.value||r.value||o.value||l.value;if(d.style.display=c?"inline-block":"none",1===e&&t){n.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===t&&e.areaGeneral).map(e=>e.areaGeneral))].sort();n.innerHTML='<option value=""> Todas las reas</option>',e.forEach(e=>{n.innerHTML+=`<option value="${e}">${e}</option>`}),i.style.display="none",i.value="",s.style.display="none",s.value="",r.style.display="none",r.value="",o.style.display="none",o.value="",l.style.display="none",l.value=""}else if(2===e&&t){i.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===a.value&&e.areaGeneral===t&&e.subArea).map(e=>e.subArea))].sort();i.innerHTML='<option value=""> Todas las sub-reas</option>',e.forEach(e=>{i.innerHTML+=`<option value="${e}">${e}</option>`}),s.style.display="none",s.value="",r.style.display="none",r.value="",o.style.display="none",o.value="",l.style.display="none",l.value=""}else if(3===e&&t){s.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===a.value&&e.areaGeneral===n.value&&e.subArea===t&&e.sistemaEquipo).map(e=>e.sistemaEquipo))].sort();s.innerHTML='<option value=""> Todos los sistemas</option>',e.forEach(e=>{s.innerHTML+=`<option value="${e}">${e}</option>`}),r.style.display="none",r.value="",o.style.display="none",o.value="",l.style.display="none",l.value=""}else if(4===e&&t){r.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===a.value&&e.areaGeneral===n.value&&e.subArea===i.value&&e.sistemaEquipo===t&&e.subSistema).map(e=>e.subSistema))].sort();r.innerHTML='<option value=""> Todos los sub-sistemas</option>',e.forEach(e=>{r.innerHTML+=`<option value="${e}">${e}</option>`}),o.style.display="none",o.value="",l.style.display="none",l.value=""}else if(5===e&&t){o.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===a.value&&e.areaGeneral===n.value&&e.subArea===i.value&&e.sistemaEquipo===s.value&&e.subSistema===t&&e.seccion).map(e=>e.seccion))].sort();o.innerHTML='<option value=""> Todas las secciones</option>',e.forEach(e=>{o.innerHTML+=`<option value="${e}">${e}</option>`}),l.style.display="none",l.value=""}else if(6===e&&t){l.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===a.value&&e.areaGeneral===n.value&&e.subArea===i.value&&e.sistemaEquipo===s.value&&e.subSistema===r.value&&e.seccion===t&&e.detalle).map(e=>e.detalle))].sort();l.innerHTML='<option value=""> Todos los detalles</option>',e.forEach(e=>{l.innerHTML+=`<option value="${e}">${e}</option>`})}this.actualizarBreadcrumbFiltros(),this.renderSAPTree()}actualizarBreadcrumbFiltros(){var e,t,a,n,i,s,r;const o=document.getElementById("filtrosBreadcrumb"),l=document.getElementById("breadcrumbPath"),d=(null==(e=document.getElementById("filtro_planta"))?void 0:e.value)||"",c=(null==(t=document.getElementById("filtro_area"))?void 0:t.value)||"",p=(null==(a=document.getElementById("filtro_subarea"))?void 0:a.value)||"",u=(null==(n=document.getElementById("filtro_sistemaEquipo"))?void 0:n.value)||"",m=(null==(i=document.getElementById("filtro_subsistema"))?void 0:i.value)||"",h=(null==(s=document.getElementById("filtro_seccion"))?void 0:s.value)||"",g=(null==(r=document.getElementById("filtro_detalle"))?void 0:r.value)||"";if(!(d||c||p||u||m||h||g))return void(o.style.display="none");let b=[];d&&b.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${d}</span>`),c&&b.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${c}</span>`),p&&b.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${p}</span>`),u&&b.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${u}</span>`),m&&b.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${m}</span>`),h&&b.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${h}</span>`),g&&b.push(`<span style="background: rgba(91, 139, 180, 0.15); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${g}</span>`),l.innerHTML=b.join(' <span style="opacity: 0.6;"></span> '),o.style.display="flex"}limpiarFiltrosJerarquia(){document.getElementById("filtro_planta").value="",document.getElementById("filtro_area").value="",document.getElementById("filtro_area").style.display="none",document.getElementById("filtro_subarea").value="",document.getElementById("filtro_subarea").style.display="none",document.getElementById("filtro_sistemaEquipo").value="",document.getElementById("filtro_sistemaEquipo").style.display="none",document.getElementById("filtro_subsistema").value="",document.getElementById("filtro_subsistema").style.display="none",document.getElementById("filtro_seccion").value="",document.getElementById("filtro_seccion").style.display="none",document.getElementById("filtro_detalle").value="",document.getElementById("filtro_detalle").style.display="none",document.getElementById("btnLimpiarFiltros").style.display="none",document.getElementById("filtrosBreadcrumb").style.display="none",this.renderSAPTree()}openJerarquiaModal(){const e=localStorage.getItem("jerarquiaLevels");if(e)try{this.jerarquiaData=JSON.parse(e)}catch(n){}document.getElementById("modalJerarquia").style.display="flex",this.jerarquiaSearchTerm="";const t=document.getElementById("jerarquiaSearchInput");t&&(t.value=""),this.updateJerarquiaSearchVisualState();const a=document.getElementById("jerarquiaResultsSummary");a&&(a.textContent=""),this.switchJerarquiaLevel(1)}closeJerarquiaModal(){document.getElementById("modalJerarquia").style.display="none",this.jerarquiaEditingId=null,this.cancelJerarquiaItem()}switchJerarquiaLevel(e){this.jerarquiaCurrentLevel=e,this.jerarquiaEditingId=null;document.querySelectorAll(".jerarquia-tab").forEach(t=>{parseInt(t.getAttribute("data-level"))===e?t.classList.add("active"):t.classList.remove("active")});document.getElementById("jerarquiaLevelTitle").textContent=[" Nivel 1 - Planta"," Nivel 2 - rea General"," Nivel 3 - Sub rea"," Nivel 4 - Sistema/Equipo"," Nivel 5 - Sub Sistema"," Nivel 6 - Seccin"," Nivel 7 - Detalle"," Nivel 8 - Componente"][e-1],document.getElementById("jerarquiaForm").style.display="none",this.renderJerarquiaList()}renderJerarquiaList(){const e=this.jerarquiaCurrentLevel,t=`nivel${e}`,a=this.jerarquiaData[t]||[],n=document.getElementById("jerarquiaList");if(!n)return;const i=(this.jerarquiaSearchTerm||"").trim(),s=i.toLowerCase(),r=(e="")=>{const t=this.escapeHtml(e||"");if(!i)return t;try{const e=new RegExp(i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");return t.replace(e,e=>`<mark>${e}</mark>`)}catch(a){return t}},o=(e,t)=>{if(!t)return!0;return!!`${e.name||""} ${e.description||""}`.toLowerCase().includes(t)||!!Array.isArray(e.subitems)&&e.subitems.some(e=>o(e,t))},l=s?a.filter(e=>o(e,s)):a;if(this.updateJerarquiaResultsSummary({total:a.length,filtered:l.length,searchTerm:i,level:e}),0===l.length){const e=s?`No encontramos resultados para "${this.escapeHtml(this.jerarquiaSearchTerm)}" en este nivel.`:"No hay elementos en este nivel";return void(n.innerHTML=`\n        <div style="text-align: center; padding: 40px; color: var(--text-muted);">\n          <p>${e}</p>\n          ${s?'\n            <button class="jerarquia-toolbar-btn" style="margin-top: 12px;" onclick="app.clearJerarquiaSearch()">Limpiar bsqueda</button>\n          ':'\n            <p style="font-size: 0.9rem; margin-top: 8px;">Haz clic en " Agregar Nuevo" para crear el primero</p>\n          '}\n        </div>\n      `)}const d=(t,a=!1)=>{const n=new Date(t.timestamp).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),i=(e=>Array.isArray(e.subitems)?s?e.subitems.filter(e=>o(e,s)):e.subitems:[])(t),l=i.length>0,c=a?"jerarquia-subitem":"jerarquia-item",p=a?"jerarquia-subitem-header":"jerarquia-item-header",u=a?"jerarquia-subitem-name":"jerarquia-item-name",m=!s&&this.isJerarquiaItemCollapsed(e,t.id),h=!!s||!m,g=m?"Expandir subniveles":"Colapsar subniveles";let b=`\n        <div class="${c}" draggable="true" data-item-id="${t.id}"\n             ondragstart="app.onDragStart(event, '${t.id}')"\n             ondragover="app.onDragOver(event)"\n             ondragleave="app.onDragLeave(event)"\n             ondrop="app.onDrop(event, '${t.id}')"\n             ondragend="app.onDragEnd(event)">\n          <div class="${p}">\n            <div class="jerarquia-item-info">\n              ${l?`\n                <button class="jerarquia-item-toggle ${m?"collapsed":""}" data-toggle-id="${t.id}" onclick="app.toggleSubitems('${t.id}', event)" title="${g}" aria-expanded="${h}">\n                  \n                </button>\n              `:'<span style="width: 28px;"></span>'}\n              <div class="jerarquia-item-content">\n                <div class="${u}" onclick="app.toggleSubitems('${t.id}', event)">${r(t.name)}</div>\n                ${t.description?`<div class="jerarquia-item-desc">${r(t.description)}</div>`:""}\n                ${a?"":`<div class="jerarquia-item-meta">Creado: ${n}</div>`}\n              </div>\n            </div>\n            <div class="jerarquia-item-actions">\n              ${a?"":`\n                <button class="jerarquia-item-btn jerarquia-item-btn-subnivel" onclick="app.addSubnivel('${t.id}')">\n                   Subnivel\n                </button>\n              `}\n              <button class="jerarquia-item-btn jerarquia-item-btn-edit" onclick="app.editJerarquiaItem('${t.id}', ${a})">\n                 Editar\n              </button>\n              <button class="jerarquia-item-btn jerarquia-item-btn-delete" onclick="app.deleteJerarquiaItem('${t.id}', ${a})">\n                 Eliminar\n              </button>\n            </div>\n          </div>\n      `;return l&&(b+=`<div class="jerarquia-subitems ${h?"expanded":""}" id="subitems-${t.id}">`,i.forEach(e=>{b+=d(e,!0)}),b+="</div>"),b+="</div>",b};n.innerHTML=l.map(e=>d(e,!1)).join("")}updateJerarquiaResultsSummary({total:e,filtered:t,searchTerm:a,level:n}){const i=document.getElementById("jerarquiaResultsSummary"),s=document.getElementById("jerarquiaStatsPills");if(!i)return;const r=["Nivel 1  Planta","Nivel 2  rea general","Nivel 3  Sub rea","Nivel 4  Sistema/Equipo","Nivel 5  Sub Sistema","Nivel 6  Seccin","Nivel 7  Detalle","Nivel 8  Componente"][n-1]||`Nivel ${n}`,o=0===e?"Sin registros":t===e?`${e} registro${1!==e?"s":""}`:`${t} coincidencia${1!==t?"s":""} de ${e}`,l=[`<span class="jerarquia-results-tag">${a?"Bsqueda activa":"Explorando"}  ${r}</span>`];if(a&&l.push(`<span class="jerarquia-results-highlight">${this.escapeHtml(a)}</span>`),l.push(`<span>${o}</span>`),i.innerHTML=l.join(""),!s)return;const d=`nivel${n}`,c=this.jerarquiaData[d]||[],p=c.filter(e=>Array.isArray(e.subitems)&&e.subitems.length>0).length,u=c.filter(e=>!(e.description||"").trim()).length;s.innerHTML=`\n      <div class="jerarquia-stat-pill" title="Registros totales en ${r}">\n        <span class="pill-label">Registros</span>\n        <strong>${c.length}</strong>\n      </div>\n      <div class="jerarquia-stat-pill" title="Elementos que ya tienen subniveles">\n        <span class="pill-label">Con subniveles</span>\n        <strong>${p}</strong>\n      </div>\n      <div class="jerarquia-stat-pill" title="Elementos sin descripcin">\n        <span class="pill-label">Sin descripcin</span>\n        <strong>${u}</strong>\n      </div>\n    `}addJerarquiaItem(){this.jerarquiaEditingId=null;const e=document.getElementById("jerarquiaForm");e.style.display="block",document.getElementById("jerarquiaItemName").value="",document.getElementById("jerarquiaItemDesc").value="",e.scrollIntoView({behavior:"smooth",block:"nearest"})}saveJerarquiaItem(){const e=document.getElementById("jerarquiaItemName").value.trim(),t=document.getElementById("jerarquiaItemDesc").value.trim();if(!e)return void this.mostrarToast(" El nombre es obligatorio","warning");const a=`nivel${this.jerarquiaCurrentLevel}`;if(this.jerarquiaEditingId){const n=this.jerarquiaData[a].findIndex(e=>e.id===this.jerarquiaEditingId);-1!==n&&(this.jerarquiaData[a][n].name=e,this.jerarquiaData[a][n].description=t,this.mostrarToast(" Item actualizado exitosamente","success"))}else{const n={id:Date.now().toString(),name:e,description:t,timestamp:Date.now()};this.jerarquiaData[a].push(n),this.mostrarToast(" Item creado exitosamente","success")}localStorage.setItem("jerarquiaLevels",JSON.stringify(this.jerarquiaData)),this.sincronizarJerarquiaConAutocompletado(),this.cancelJerarquiaItem(),this.renderJerarquiaList(),"none"!==document.getElementById("jerarquia").style.display&&this.renderSAPTree();const n=document.getElementById("jerarquiaTreeContainer");n&&null!==n.offsetParent&&this.renderJerarquiaTree()}cancelJerarquiaItem(){this.jerarquiaEditingId=null;document.getElementById("jerarquiaForm").style.display="none",document.getElementById("jerarquiaItemName").value="",document.getElementById("jerarquiaItemDesc").value=""}toggleSubitems(e){const t=document.getElementById(`subitems-${e}`),a=event.target;t&&(t.classList.toggle("expanded"),a&&a.classList.contains("jerarquia-item-toggle")&&a.classList.toggle("collapsed"))}addSubnivel(e){const t=`nivel${this.jerarquiaCurrentLevel}`,a=this.jerarquiaData[t].find(t=>t.id===e);if(!a)return void this.mostrarToast(" Item padre no encontrado","error");const n=prompt("Nombre del subnivel:");if(!n||!n.trim())return;const i=prompt("Descripcin (opcional):")||"";a.subitems||(a.subitems=[]);const s={id:`${e}-${Date.now()}`,name:n.trim(),description:i.trim(),timestamp:Date.now()};a.subitems.push(s),localStorage.setItem("jerarquiaLevels",JSON.stringify(this.jerarquiaData)),this.mostrarToast(" Subnivel creado exitosamente","success"),this.renderJerarquiaList()}editJerarquiaItem(e,t=!1){const a=`nivel${this.jerarquiaCurrentLevel}`;let n=null;if(t){for(const r of this.jerarquiaData[a])if(r.subitems&&(n=r.subitems.find(t=>t.id===e),n))break}else n=this.jerarquiaData[a].find(t=>t.id===e);if(!n)return void this.mostrarToast(" Item no encontrado","error");const i=prompt("Editar nombre:",n.name);if(null===i)return;if(!i.trim())return void this.mostrarToast(" El nombre no puede estar vaco","warning");const s=prompt("Editar descripcin:",n.description||"");null!==s&&(n.name=i.trim(),n.description=s.trim(),localStorage.setItem("jerarquiaLevels",JSON.stringify(this.jerarquiaData)),this.sincronizarJerarquiaConAutocompletado(),this.mostrarToast(" Item actualizado exitosamente","success"),this.renderJerarquiaList())}deleteJerarquiaItem(e,t=!1){const a=`nivel${this.jerarquiaCurrentLevel}`;let n=null,i=null;if(t){for(const r of this.jerarquiaData[a])if(r.subitems&&(n=r.subitems.find(t=>t.id===e),n)){i=r;break}}else n=this.jerarquiaData[a].find(t=>t.id===e);if(!n)return void this.mostrarToast(" Item no encontrado","error");if(!confirm(`Eliminar "${n.name}"?\n\nEsta accin no se puede deshacer.`))return;t&&i?i.subitems=i.subitems.filter(t=>t.id!==e):this.jerarquiaData[a]=this.jerarquiaData[a].filter(t=>t.id!==e),localStorage.setItem("jerarquiaLevels",JSON.stringify(this.jerarquiaData)),this.sincronizarJerarquiaConAutocompletado(),this.mostrarToast(" Item eliminado exitosamente","success"),this.renderJerarquiaList(),"none"!==document.getElementById("jerarquia").style.display&&this.renderSAPTree();const s=document.getElementById("jerarquiaTreeContainer");s&&null!==s.offsetParent&&this.renderJerarquiaTree()}onDragStart(e,t){this.draggedItemId=t,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.target.innerHTML)}onDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".jerarquia-item, .jerarquia-subitem");t&&!t.classList.contains("dragging")&&t.classList.add("drag-over")}onDragLeave(e){const t=e.target.closest(".jerarquia-item, .jerarquia-subitem");t&&t.classList.remove("drag-over")}onDrop(e,t){e.preventDefault(),e.stopPropagation();const a=e.target.closest(".jerarquia-item, .jerarquia-subitem");if(a&&a.classList.remove("drag-over"),this.draggedItemId===t)return;const n=`nivel${this.jerarquiaCurrentLevel}`,i=this.jerarquiaData[n],s=i.findIndex(e=>e.id===this.draggedItemId),r=i.findIndex(e=>e.id===t);if(-1!==s&&-1!==r){const e=i[s];i.splice(s,1),i.splice(r,0,e),localStorage.setItem("jerarquiaLevels",JSON.stringify(this.jerarquiaData)),this.mostrarToast(" Orden actualizado","success"),this.renderJerarquiaList()}}onDragEnd(e){e.target.classList.remove("dragging"),this.draggedItemId=null,document.querySelectorAll(".drag-over").forEach(e=>{e.classList.remove("drag-over")})}sincronizarJerarquiaConAutocompletado(){const e={nivel1:"planta",nivel2:"area",nivel3:"subarea",nivel4:"sistema",nivel5:"subsistema",nivel6:"seccion",nivel7:"detalle",nivel8:"ubicacion"};Object.keys(e).forEach(t=>{const a=e[t],n=this.jerarquiaData[t]||[];this.autocompleteData[a]=n.map(e=>e.name)}),localStorage.setItem("autocompleteData",JSON.stringify(this.autocompleteData))}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}inicializarFiltrosJerarquia(){const e=[...new Set(this.repuestos.map(e=>e.planta).filter(Boolean))].sort(),t=document.getElementById("filtro_planta");t&&(t.innerHTML='<option value=""> Todas las plantas</option>',e.forEach(e=>{t.innerHTML+=`<option value="${e}">${e}</option>`}))}formatNumber(e,t={}){const a=Number(e);return Number.isFinite(a)?a.toLocaleString("es-ES",t):"0"}formatDecimal(e,t=0){const a=Number(e);return Number.isFinite(a)?a.toLocaleString("es-ES",{minimumFractionDigits:t,maximumFractionDigits:t}):0===t?"0":Number(0).toFixed(t)}escapeHtml(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}renderSAPTree(){const e=document.getElementById("sapTreeContainer");if(!e)return;if(!this.jerarquiaData)return e.innerHTML='<div class="sap-tree-empty">No hay estructura jerrquica configurada. <br>Usa el botn " Gestionar Niveles" para crear la jerarqua.</div>',void this.updateSAPTreeCount(0);const t=this.buildJerarquiaTreeHTML();e.innerHTML=t;let a=0;Object.keys(this.jerarquiaData).forEach(e=>{a+=(this.jerarquiaData[e]||[]).length}),this.updateSAPTreeCount(a)}buildJerarquiaTreeHTML(){const e=this.jerarquiaData.nivel1||[];if(0===e.length)return'<div class="sap-tree-empty">No hay plantas configuradas. <br>Usa " Gestionar Niveles" para agregar elementos.</div>';let t='<div class="sap-tree">';return e.forEach((e,a)=>{t+=`\n        <div class="sap-node sap-node-level-1" data-id="${e.id}">\n          <div class="sap-node-header" onclick="app.sapTreeToggleNode('planta_${a}')">\n            <span class="sap-node-icon"></span>\n            <span class="sap-node-label">${this.escapeHtml(e.name)}</span>\n            ${e.description?`<span class="sap-node-desc">(${this.escapeHtml(e.description)})</span>`:""}\n            <span class="sap-node-toggle"></span>\n          </div>\n          <div class="sap-node-children" id="planta_${a}">\n            ${this.buildNivel2HTML(a)}\n          </div>\n        </div>\n      `}),t+="</div>",t}buildNivel2HTML(e){const t=this.jerarquiaData.nivel2||[];if(0===t.length)return'<div class="sap-tree-empty-child">Sin reas generales</div>';let a="";return t.forEach((t,n)=>{a+=`\n        <div class="sap-node sap-node-level-2" data-id="${t.id}">\n          <div class="sap-node-header" onclick="app.sapTreeToggleNode('area_${e}_${n}')">\n            <span class="sap-node-icon"></span>\n            <span class="sap-node-label">${this.escapeHtml(t.name)}</span>\n            <span class="sap-node-toggle"></span>\n          </div>\n          <div class="sap-node-children" id="area_${e}_${n}">\n            ${this.buildNivel3HTML(e,n)}\n          </div>\n        </div>\n      `}),a}buildNivel3HTML(e,t){const a=this.jerarquiaData.nivel3||[];if(0===a.length)return'<div class="sap-tree-empty-child">Sin sub-reas</div>';let n="";return a.forEach((a,i)=>{n+=`\n        <div class="sap-node sap-node-level-3" data-id="${a.id}">\n          <div class="sap-node-header" onclick="app.sapTreeToggleNode('subarea_${e}_${t}_${i}')">\n            <span class="sap-node-icon"></span>\n            <span class="sap-node-label">${this.escapeHtml(a.name)}</span>\n            <span class="sap-node-toggle"></span>\n          </div>\n          <div class="sap-node-children" id="subarea_${e}_${t}_${i}">\n            ${this.buildNivel4HTML(e,t,i)}\n          </div>\n        </div>\n      `}),n}buildNivel4HTML(e,t,a){const n=this.jerarquiaData.nivel4||[];if(0===n.length)return'<div class="sap-tree-empty-child">Sin sistemas/equipos</div>';let i="";return n.forEach((n,s)=>{i+=`\n        <div class="sap-node sap-node-level-4" data-id="${n.id}">\n          <div class="sap-node-header" onclick="app.sapTreeToggleNode('sistema_${e}_${t}_${a}_${s}')">\n            <span class="sap-node-icon"></span>\n            <span class="sap-node-label">${this.escapeHtml(n.name)}</span>\n            <span class="sap-node-toggle"></span>\n          </div>\n          <div class="sap-node-children" id="sistema_${e}_${t}_${a}_${s}">\n            <div class="sap-tree-empty-child"> Sub-sistemas,  Secciones y  Detalles disponibles...</div>\n          </div>\n        </div>\n      `}),i}sapTreeToggleNode(e){const t=document.getElementById(e);if(!t)return;const a="none"!==t.style.display;t.style.display=a?"none":"block";const n=t.previousElementSibling;if(n){const e=n.querySelector(".sap-node-toggle");e&&(e.textContent="")}}renderSAPTree_OLD(){const e=document.getElementById("sapTreeContainer");if(!e)return;const t=this.getFilteredJerarquiaData();if(!t||0===t.length)return e.innerHTML='<div style="padding: 20px; text-align: center; color: #666;">No hay datos para mostrar</div>',void this.updateSAPTreeCount(0);const a=this.buildTreeStructure(t);e.innerHTML=this.renderTreeNodes(a,0),this.updateSAPTreeCount(t.length)}getFilteredJerarquiaData(){var e,t,a,n,i,s,r;const o=(null==(e=document.getElementById("filtro_planta"))?void 0:e.value)||"",l=(null==(t=document.getElementById("filtro_area"))?void 0:t.value)||"",d=(null==(a=document.getElementById("filtro_subarea"))?void 0:a.value)||"",c=(null==(n=document.getElementById("filtro_sistemaEquipo"))?void 0:n.value)||"",p=(null==(i=document.getElementById("filtro_subsistema"))?void 0:i.value)||"",u=(null==(s=document.getElementById("filtro_seccion"))?void 0:s.value)||"",m=(null==(r=document.getElementById("filtro_detalle"))?void 0:r.value)||"";return this.repuestos.filter(e=>(!o||e.planta===o)&&((!l||e.areaGeneral===l)&&((!d||e.subArea===d)&&((!c||e.sistemaEquipo===c)&&((!p||e.subSistema===p)&&((!u||e.seccion===u)&&(!m||e.detalle===m)))))))}buildTreeStructure(e){const t={};return e.forEach(e=>{const a=e.planta||"Sin Planta";t[a]||(t[a]={_count:0,_children:{}}),t[a]._count++;const n=e.areaGeneral||"Sin rea";t[a]._children[n]||(t[a]._children[n]={_count:0,_children:{}}),t[a]._children[n]._count++;const i=e.subArea||"Sin Sub-rea";t[a]._children[n]._children[i]||(t[a]._children[n]._children[i]={_count:0,_children:{}}),t[a]._children[n]._children[i]._count++;const s=e.sistemaEquipo||"Sin Sistema";t[a]._children[n]._children[i]._children[s]||(t[a]._children[n]._children[i]._children[s]={_count:0,_children:{}}),t[a]._children[n]._children[i]._children[s]._count++;const r=e.subSistema||"Sin Sub-Sistema";t[a]._children[n]._children[i]._children[s]._children[r]||(t[a]._children[n]._children[i]._children[s]._children[r]={_count:0,_children:{}}),t[a]._children[n]._children[i]._children[s]._children[r]._count++;const o=e.seccion||"Sin Seccin";t[a]._children[n]._children[i]._children[s]._children[r]._children[o]||(t[a]._children[n]._children[i]._children[s]._children[r]._children[o]={_count:0,_children:{}}),t[a]._children[n]._children[i]._children[s]._children[r]._children[o]._count++;const l=e.detalle||"Sin Detalle";t[a]._children[n]._children[i]._children[s]._children[r]._children[o]._children[l]||(t[a]._children[n]._children[i]._children[s]._children[r]._children[o]._children[l]={_count:0,_items:[]}),t[a]._children[n]._children[i]._children[s]._children[r]._children[o]._children[l]._count++,t[a]._children[n]._children[i]._children[s]._children[r]._children[o]._children[l]._items.push(e)}),t}renderTreeNodes(e,t,a={}){const n=["","","","","","",""][t]||"",i=["planta","areaGeneral","subArea","sistemaEquipo","subSistema","seccion","detalle"][t];let s="",r=0;return Object.keys(e).sort().forEach(o=>{const l=e[o],d=`node-${t}-${r++}`,c=l._children&&Object.keys(l._children).length>0,p=l._items&&l._items.length>0,u={...a,[i]:o},m=JSON.stringify(u).replace(/"/g,"&quot;");s+=`\n        <div class="sap-tree-item" data-level="${t}">\n          <div class="sap-tree-item-content">\n            ${c||p?`<span class="sap-tree-toggle" onclick="app.sapTreeToggleNode('${d}')"></span>`:'<span style="width:16px;display:inline-block;"></span>'}\n            <span class="sap-tree-icon">${n}</span>\n            <span class="sap-tree-label" onclick='app.sapTreeSelectNode("${d}", "${o}", "node", ${t}, ${m})'>${o}</span>\n            <span class="sap-tree-badge">${l._count||0}</span>\n          </div>\n          <div class="sap-tree-children" id="${d}" style="display:none;">\n      `,c&&(s+=this.renderTreeNodes(l._children,t+1,u)),p&&l._items.forEach(e=>{const a=(e.nombre||"Sin nombre").replace(/"/g,"&quot;");s+=`\n            <div class="sap-tree-item sap-tree-leaf" data-level="${t+1}">\n              <div class="sap-tree-item-content">\n                <span style="width:16px;display:inline-block;"></span>\n                <span class="sap-tree-icon"></span>\n                <span class="sap-tree-label" onclick="app.sapTreeSelectNode('item-${e.id}', '${e.codSAP||"N/A"} - ${a}', 'item')">${e.codSAP||"N/A"} - ${e.nombre}</span>\n                <span class="sap-tree-badge">${e.cantidad||0}</span>\n              </div>\n            </div>\n          `}),s+="\n          </div>\n        </div>\n      "}),s}sapTreeToggleNode(e){var t;const a=document.getElementById(e),n=null==(t=null==a?void 0:a.previousElementSibling)?void 0:t.querySelector(".sap-tree-toggle");a&&n&&("none"===a.style.display?(a.style.display="block",n.textContent=""):(a.style.display="none",n.textContent=""))}sapTreeSelectNode(e,t,a,n,i){var s;document.querySelectorAll(".sap-tree-item.selected").forEach(e=>e.classList.remove("selected"));const r=null==(s=document.querySelector(`[onclick*="${e}"]`))?void 0:s.closest(".sap-tree-item");if(r&&r.classList.add("selected"),"item"===a){const t=e.replace("item-","");return void this.openModal("edit",t)}"node"===a&&i&&(this.aplicarFiltroJerarquico(i),this.showToast(` Filtrando por: ${t}`,"info",2e3),setTimeout(()=>{var e;null==(e=document.querySelector('[data-tab="inventario"]'))||e.click()},500))}aplicarFiltroJerarquico(e){this.filtrosJerarquicosActivos=e,this.switchTab("inventario"),this.applyFilters()}sapTreeExpandAll(){document.querySelectorAll(".sap-tree-children").forEach(e=>e.style.display="block"),document.querySelectorAll(".sap-tree-toggle").forEach(e=>e.textContent="")}sapTreeCollapseAll(){document.querySelectorAll(".sap-tree-children").forEach(e=>e.style.display="none"),document.querySelectorAll(".sap-tree-toggle").forEach(e=>e.textContent="")}sapTreeRefresh(){this.renderSAPTree(),this.showToast(" rbol actualizado","success",1500)}sapTreeSearch(e){if(!document.getElementById("sapTreeContainer"))return;if(!(e=e.toLowerCase().trim()))return void document.querySelectorAll(".sap-tree-item").forEach(e=>{e.style.display="",e.classList.remove("search-highlight")});let t=0;document.querySelectorAll(".sap-tree-item").forEach(a=>{var n;const i=a.querySelector(".sap-tree-label");if(i){if(i.textContent.toLowerCase().includes(e)){a.style.display="",a.classList.add("search-highlight"),t++;let e=a.parentElement;for(;e;){if(e.classList&&e.classList.contains("sap-tree-children")){e.style.display="block";const t=null==(n=e.previousElementSibling)?void 0:n.querySelector(".sap-tree-toggle");t&&(t.textContent="")}e=e.parentElement}}else a.style.display="none",a.classList.remove("search-highlight")}}),0===t?this.showToast(" No se encontraron resultados","warning",2e3):this.showToast(` ${t} resultado(s) encontrado(s)`,"success",1500)}sapTreeClearSearch(){const e=document.getElementById("sapTreeSearch");e&&(e.value="",this.sapTreeSearch(""))}updateSAPTreeCount(e){const t=document.getElementById("sapTreeCount");t&&(t.textContent=e)}renderJerarquia(){this.renderJerarquiaFiltrada(this.repuestos),this.actualizarContadorJerarquia()}toggleTree(e){const t=document.getElementById(e),a=document.getElementById(`${e}-toggle`);if(!t||!a)return;t.classList.toggle("expanded")?(a.classList.add("expanded"),a.textContent=""):(a.classList.remove("expanded"),a.textContent="")}toggleAllTree(){const e=document.querySelectorAll(".tree-children"),t=document.querySelectorAll(".tree-toggle"),a=document.getElementById("toggleAllIcon"),n=document.getElementById("toggleAllText");if(!e.length)return;Array.from(e).some(e=>e.classList.contains("expanded"))?(e.forEach(e=>e.classList.remove("expanded")),t.forEach(e=>{e.classList.remove("expanded"),e.textContent=""}),a&&(a.textContent=""),n&&(n.textContent="Expandir Todo")):(e.forEach(e=>e.classList.add("expanded")),t.forEach(e=>{e.classList.add("expanded"),e.textContent=""}),a&&(a.textContent=""),n&&(n.textContent="Contraer Todo"))}inicializarFiltrosJerarquia(){const e=[...new Set(this.repuestos.map(e=>e.planta).filter(Boolean))].sort(),t=document.getElementById("filtro_planta");t.innerHTML='<option value=""> Todas las plantas</option>',e.forEach(e=>{t.innerHTML+=`<option value="${e}">${e}</option>`})}filtrarEscalonado(e,t){const a=document.getElementById("filtro_planta"),n=document.getElementById("filtro_area"),i=document.getElementById("filtro_subarea"),s=document.getElementById("filtro_sistema"),r=document.getElementById("filtro_subsistema"),o=document.getElementById("filtro_seccion"),l=document.getElementById("filtro_detalle"),d=document.getElementById("btnLimpiarFiltros"),c=a.value,p=n.value;i.value,s.value,r.value,o.value,l.value;if(1===e&&t){n.style.display="block",d.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===t&&e.areaGeneral).map(e=>e.areaGeneral))].sort();n.innerHTML='<option value=""> Todas las reas</option>',e.forEach(e=>{n.innerHTML+=`<option value="${e}">${e}</option>`}),i.style.display="none",i.value="",s.style.display="none",s.value="",r.style.display="none",r.value="",o.style.display="none",o.value="",l.style.display="none",l.value=""}else if(2===e&&t){i.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===c&&e.areaGeneral===t&&e.subArea).map(e=>e.subArea))].sort();i.innerHTML='<option value=""> Todas las sub-reas</option>',e.forEach(e=>{i.innerHTML+=`<option value="${e}">${e}</option>`}),s.style.display="none",s.value="",r.style.display="none",r.value="",o.style.display="none",o.value="",l.style.display="none",l.value=""}else if(3===e&&t){s.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===c&&e.areaGeneral===p&&e.subArea===t&&e.sistemaEquipo).map(e=>e.sistemaEquipo))].sort();s.innerHTML='<option value=""> Todos los sistemas</option>',e.forEach(e=>{s.innerHTML+=`<option value="${e}">${e}</option>`}),r.style.display="none",r.value="",o.style.display="none",o.value="",l.style.display="none",l.value=""}else if(4===e&&t){r.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===a.value&&e.areaGeneral===n.value&&e.subArea===i.value&&e.sistemaEquipo===t&&e.subSistema).map(e=>e.subSistema))].sort();r.innerHTML='<option value=""> Todos los sub-sistemas</option>',e.forEach(e=>{r.innerHTML+=`<option value="${e}">${e}</option>`}),o.style.display="none",o.value="",l.style.display="none",l.value=""}else if(5===e&&t){o.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===a.value&&e.areaGeneral===n.value&&e.subArea===i.value&&e.sistemaEquipo===s.value&&e.subSistema===t&&e.seccion).map(e=>e.seccion))].sort();o.innerHTML='<option value=""> Todas las secciones</option>',e.forEach(e=>{o.innerHTML+=`<option value="${e}">${e}</option>`}),l.style.display="none",l.value=""}else if(6===e&&t){l.style.display="block";const e=[...new Set(this.repuestos.filter(e=>e.planta===a.value&&e.areaGeneral===n.value&&e.subArea===i.value&&e.sistemaEquipo===s.value&&e.subSistema===r.value&&e.seccion===t&&e.detalle).map(e=>e.detalle))].sort();l.innerHTML='<option value=""> Todos los detalles</option>',e.forEach(e=>{l.innerHTML+=`<option value="${e}">${e}</option>`})}this.actualizarBreadcrumbFiltros(),this.aplicarFiltrosJerarquia()}actualizarBreadcrumbFiltros(){const e=document.getElementById("filtrosBreadcrumb"),t=document.getElementById("breadcrumbPath"),a=document.getElementById("filtro_planta").value,n=document.getElementById("filtro_area").value,i=document.getElementById("filtro_subarea").value,s=document.getElementById("filtro_sistema").value,r=document.getElementById("filtro_subsistema").value,o=document.getElementById("filtro_seccion").value,l=document.getElementById("filtro_detalle").value;if(!(a||n||i||s||r||o||l))return void(e.style.display="none");let d=[];a&&d.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${a}</span>`),n&&d.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${n}</span>`),i&&d.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${i}</span>`),s&&d.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${s}</span>`),r&&d.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${r}</span>`),o&&d.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${o}</span>`),l&&d.push(`<span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;"><strong></strong> ${l}</span>`),t.innerHTML=d.join(' <span style="opacity: 0.6;"></span> '),e.style.display="flex"}aplicarFiltrosJerarquia(){const e=document.getElementById("filtro_planta").value,t=document.getElementById("filtro_area").value,a=document.getElementById("filtro_subarea").value,n=document.getElementById("filtro_sistema").value,i=document.getElementById("filtro_subsistema").value,s=document.getElementById("filtro_seccion").value,r=document.getElementById("filtro_detalle").value;if(!(e||t||a||n||i||s||r))return void this.renderJerarquia();const o=this.repuestos.filter(o=>(!e||o.planta===e)&&((!t||o.areaGeneral===t)&&((!a||o.subArea===a)&&((!n||o.sistemaEquipo===n)&&((!i||o.subSistema===i)&&((!s||o.seccion===s)&&(!r||o.detalle===r)))))));document.getElementById("repuestosVisibles").textContent=o.length,this.renderJerarquiaFiltrada(o),this.renderSAPTree()}limpiarFiltrosJerarquia(){document.getElementById("filtro_planta").value="",document.getElementById("filtro_area").value="",document.getElementById("filtro_area").style.display="none",document.getElementById("filtro_subarea").value="",document.getElementById("filtro_subarea").style.display="none",document.getElementById("filtro_sistema").value="",document.getElementById("filtro_sistema").style.display="none",document.getElementById("filtro_subsistema").value="",document.getElementById("filtro_subsistema").style.display="none",document.getElementById("filtro_seccion").value="",document.getElementById("filtro_seccion").style.display="none",document.getElementById("filtro_detalle").value="",document.getElementById("filtro_detalle").style.display="none",document.getElementById("btnLimpiarFiltros").style.display="none",document.getElementById("filtrosBreadcrumb").style.display="none",this.renderJerarquia(),this.renderSAPTree()}irAInventarioConFiltro(e){this.filtrosJerarquicosActivos=e;const t=document.getElementById("quitarFiltrosJerarquicosBtn");t&&(t.style.display="inline-block"),this.switchTab("inventario"),setTimeout(()=>{this.renderInventario()},50);const a={planta:" Planta",areaGeneral:" rea",subArea:" Sub-rea",sistemaEquipo:" Sistema",subSistema:" Sub-Sistema",seccion:" Seccin",detalle:" Detalle"},n=["detalle","seccion","subSistema","sistemaEquipo","subArea","areaGeneral","planta"].find(t=>e[t]);n&&this.showToast(` Filtrando por ${a[n]}: ${e[n]}`,"info")}irAInventarioConRepuesto(e){const t=this.repuestos.find(t=>t.id===e);if(!t)return;this.filtrosJerarquicosActivos={repuestoId:e};const a=document.getElementById("quitarFiltrosJerarquicosBtn");a&&(a.style.display="inline-block"),this.switchTab("inventario"),setTimeout(()=>{this.renderInventario()},50);const n=t.nombre||t.codSAP||"Repuesto";this.showToast(` Mostrando repuesto: ${n}`,"info")}buscarEnJerarquia(e){const t=document.getElementById("searchResultsJerarquia");if(!e||e.trim().length<2)return void(t.style.display="none");const a=e.toLowerCase().trim(),n=[];this.repuestos.forEach(e=>{(e.codSAP&&e.codSAP.toLowerCase().includes(a)||e.nombre&&e.nombre.toLowerCase().includes(a))&&n.push({tipo:"repuesto",id:e.id,nombre:e.nombre,codSAP:e.codSAP,stock:e.cantidad,ubicacion:[e.planta,e.areaGeneral,e.sistemaEquipo].filter(e=>e).join(" > ")})});const i=new Map;this.repuestos.forEach(e=>{if(e.planta&&e.planta.toLowerCase().includes(a)){const t=JSON.stringify({tipo:"planta",valor:e.planta,nivel:"Planta"});i.has(t)||i.set(t,{data:JSON.parse(t),count:0}),i.get(t).count++}if(e.areaGeneral&&e.areaGeneral.toLowerCase().includes(a)){const t=JSON.stringify({tipo:"areaGeneral",valor:e.areaGeneral,nivel:"rea",planta:e.planta});i.has(t)||i.set(t,{data:JSON.parse(t),count:0}),i.get(t).count++}if(e.subArea&&e.subArea.toLowerCase().includes(a)){const t=JSON.stringify({tipo:"subArea",valor:e.subArea,nivel:"Sub-rea",planta:e.planta,areaGeneral:e.areaGeneral});i.has(t)||i.set(t,{data:JSON.parse(t),count:0}),i.get(t).count++}if(e.sistemaEquipo&&e.sistemaEquipo.toLowerCase().includes(a)){const t=JSON.stringify({tipo:"sistemaEquipo",valor:e.sistemaEquipo,nivel:"Sistema",planta:e.planta,areaGeneral:e.areaGeneral,subArea:e.subArea});i.has(t)||i.set(t,{data:JSON.parse(t),count:0}),i.get(t).count++}if(e.subSistema&&e.subSistema.toLowerCase().includes(a)){const t=JSON.stringify({tipo:"subSistema",valor:e.subSistema,nivel:"Sub-Sistema",planta:e.planta,areaGeneral:e.areaGeneral,subArea:e.subArea,sistemaEquipo:e.sistemaEquipo});i.has(t)||i.set(t,{data:JSON.parse(t),count:0}),i.get(t).count++}if(e.seccion&&e.seccion.toLowerCase().includes(a)){const t=JSON.stringify({tipo:"seccion",valor:e.seccion,nivel:"Seccin",planta:e.planta,areaGeneral:e.areaGeneral,subArea:e.subArea,sistemaEquipo:e.sistemaEquipo,subSistema:e.subSistema});i.has(t)||i.set(t,{data:JSON.parse(t),count:0}),i.get(t).count++}if(e.detalle&&e.detalle.toLowerCase().includes(a)){const t=JSON.stringify({tipo:"detalle",valor:e.detalle,nivel:"Detalle",planta:e.planta,areaGeneral:e.areaGeneral,subArea:e.subArea,sistemaEquipo:e.sistemaEquipo,subSistema:e.subSistema,seccion:e.seccion});i.has(t)||i.set(t,{data:JSON.parse(t),count:0}),i.get(t).count++}});const s=Array.from(i.values());let r="";0===s.length&&0===n.length?r='<div style="padding: 16px; text-align: center; color: var(--gray-500);">No se encontraron resultados</div>':(s.length>0&&(r+='<div style="padding: 8px; background: var(--bg-light); border-bottom: 1px solid var(--border-color); font-weight: bold; color: var(--primary-color);"> Niveles Jerrquicos</div>',s.slice(0,10).forEach(e=>{const t=e.data,a=e.count,n={};t.planta&&(n.planta=t.planta),t.areaGeneral&&(n.areaGeneral=t.areaGeneral),t.subArea&&(n.subArea=t.subArea),t.sistemaEquipo&&(n.sistemaEquipo=t.sistemaEquipo),t.subSistema&&(n.subSistema=t.subSistema),t.seccion&&(n.seccion=t.seccion),t.detalle&&(n.detalle=t.detalle);const i=JSON.stringify(n).replace(/"/g,"&quot;");r+=`\n            <div \n              onclick="app.irAInventarioConFiltro(${i}); document.getElementById('searchJerarquia').value = ''; app.buscarEnJerarquia('');" \n              style="\n                padding: 12px;\n                border-bottom: 1px solid var(--border-color);\n                cursor: pointer;\n                transition: background 0.2s;\n                background: var(--bg-primary);\n              "\n              onmouseover="this.style.background='var(--bg-secondary)'"\n              onmouseout="this.style.background='var(--bg-primary)'"\n            >\n              <div style="display: flex; justify-content: space-between; align-items: center;">\n                <div style="font-weight: 600; color: var(--text-primary);">\n                  ${t.nivel}: ${t.valor}\n                </div>\n                <div style="background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">\n                  ${a} repuesto${1!==a?"s":""}\n                </div>\n              </div>\n              <div style="font-size: 0.85rem; color: var(--gray-500); margin-top: 4px;">\n                ${[t.planta,t.areaGeneral,t.subArea].filter(e=>e).join(" > ")}\n              </div>\n            </div>\n          `})),n.length>0&&(r+='<div style="padding: 8px; background: var(--bg-light); border-bottom: 1px solid var(--border-color); font-weight: bold; color: var(--primary-color);"> Repuestos</div>',n.slice(0,15).forEach(e=>{r+=`\n            <div \n              onclick="app.irAInventarioConRepuesto('${e.id}'); document.getElementById('searchJerarquia').value = ''; app.buscarEnJerarquia('');" \n              style="\n                padding: 12px;\n                border-bottom: 1px solid var(--border-color);\n                cursor: pointer;\n                transition: background 0.2s;\n                background: var(--bg-primary);\n              "\n              onmouseover="this.style.background='var(--bg-secondary)'"\n              onmouseout="this.style.background='var(--bg-primary)'"\n            >\n              <div style="font-weight: 600; color: var(--text-primary);">\n                ${e.codSAP||"N/A"} - ${e.nombre}\n              </div>\n              <div style="font-size: 0.85rem; color: var(--gray-500); margin-top: 4px; display: flex; justify-content: space-between;">\n                <span>${e.ubicacion||"Sin ubicacin"}</span>\n                <span style="color: var(--primary-color);">Stock: ${e.stock}</span>\n              </div>\n            </div>\n          `})),s.length+n.length>25&&(r+='<div style="padding: 8px; text-align: center; color: var(--gray-500); font-size: 0.85rem;">Mostrando primeros 25 resultados...</div>')),t.innerHTML=r,t.style.display="block"}renderJerarquiaFiltrada(e){const t={};e.forEach(e=>{const a=e.planta||"Sin Clasificar";t[a]||(t[a]={});const n=e.areaGeneral||" Inventario General";t[a][n]||(t[a][n]={});const i=e.subArea||"Sin Sub-rea";t[a][n][i]||(t[a][n][i]={});const s=e.sistemaEquipo||"Sin Sistema";t[a][n][i][s]||(t[a][n][i][s]={});const r=e.subSistema||"Sin Sub-Sistema";t[a][n][i][s][r]||(t[a][n][i][s][r]={});const o=e.seccion||"Sin Seccin";t[a][n][i][s][r][o]||(t[a][n][i][s][r][o]={});const l=e.detalle||"Repuestos";t[a][n][i][s][r][o][l]||(t[a][n][i][s][r][o][l]=[]),t[a][n][i][s][r][o][l].push(e)});const a=document.getElementById("treeContainer");if(0===e.length)return void(a.innerHTML='<div class="text-center" style="padding: 60px; color: var(--gray-500);">No hay repuestos en este nivel</div>');let n="",i=0;Object.keys(t).sort().forEach(e=>{const a="node-"+i++;n+=`\n        <div class="tree-node tree-area">\n          <div class="tree-item" onclick="app.toggleTree('${a}')">\n            <span class="tree-toggle expanded" id="${a}-toggle"></span>\n            <span> ${e}</span>\n          </div>\n          <div class="tree-children expanded" id="${a}">\n      `;const s=(e,t=[])=>(Array.isArray(e)?t.push(...e):Object.values(e).forEach(e=>s(e,t)),t);s(t[e]).forEach(e=>{n+=`\n          <div class="tree-node tree-repuesto">\n            <div class="tree-item" style="display: flex; align-items: center; gap: 8px; padding-left: 40px;">\n              <span style="flex: 1;"> ${e.codSAP||"N/A"} - ${e.nombre}</span>\n              <span style="font-size: 0.85rem; color: var(--gray-500);">Stock: ${e.cantidad}</span>\n              <button onclick="app.irAInventarioConRepuesto('${e.id}')" style="\n                padding: 4px 12px;\n                font-size: 0.8rem;\n                background: var(--primary-color);\n                color: white;\n                border: none;\n                border-radius: 4px;\n                cursor: pointer;\n              " title="Ver en inventario"> Ver</button>\n            </div>\n          </div>\n        `}),n+="</div></div>"}),a.innerHTML=n}actualizarContadorJerarquia(){const e=document.getElementById("repuestosVisibles");e&&(e.textContent=this.repuestos.length)}irATarjeta(e,t=!1){if(t){const t=this.repuestos.find(t=>t.id===e);t&&this.aplicarFiltrosDesdeJerarquia(t)}this.switchTab("inventario"),setTimeout(()=>{var t;const a=null==(t=document.querySelector(`[data-id="${e}"]`))?void 0:t.closest(".repuesto-card");a?(a.scrollIntoView({behavior:"smooth",block:"center"}),a.style.transition="all 0.3s ease",a.style.transform="scale(1.05)",a.style.boxShadow="0 0 30px rgba(59, 130, 246, 0.6)",a.style.borderColor="#3b82f6",setTimeout(()=>{a.style.transform="",a.style.boxShadow="",a.style.borderColor=""},2e3),this.showToast(" Producto localizado","success")):this.showToast(" Producto no encontrado en vista actual","warning")},300)}aplicarFiltrosDesdeJerarquia(e){this.filtrosJerarquicosActivos={planta:e.planta,areaGeneral:e.areaGeneral,subArea:e.subArea,sistemaEquipo:e.sistemaEquipo,subSistema:e.subSistema,seccion:e.seccion};const t=document.getElementById("quitarFiltrosJerarquicosBtn");t&&(t.style.display="inline-block"),this.renderInventario()}quitarFiltrosJerarquicos(){this.filtrosJerarquicosActivos=null;const e=document.getElementById("quitarFiltrosJerarquicosBtn");e&&(e.style.display="none"),this.renderInventario(),this.showToast(" Filtros jerrquicos eliminados","success")}async agregarUbicacionMapa(e){if(!n.isConnected){this.showToast(" Conectando al sistema de archivos...","info");if(!(await c.connectWorkspace(!1,!0)))return this.showToast(" No se pudo conectar al sistema de archivos","error"),void this.switchTab("configuracion")}if(!o.initialized)return void this.showToast(" Error: Sistema de mapas no inicializado","error");const t=this.repuestos.find(t=>String(t.id)===String(e));t?this.abrirModalAsignarAreaMapa(e,t):this.showToast(" Repuesto no encontrado","error")}async verRepuestoEnMapa(e){if(!n.isConnected){this.showToast(" Conectando al sistema de archivos...","info");if(!(await c.connectWorkspace(!1,!0)))return this.showToast(" No se pudo conectar al sistema de archivos","error"),void this.switchTab("configuracion")}if(!o.initialized)return void this.showToast(" Error: Sistema de mapas no inicializado","error");const t=this.repuestos.find(t=>String(t.id)===String(e));if(!t)return void this.showToast(" Repuesto no encontrado","error");let a=[];t.ubicaciones&&Array.isArray(t.ubicaciones)&&t.ubicaciones.length>0?(a=t.ubicaciones.filter(e=>e.mapId&&e.areaId),(t.mapId||t.markerX||t.markerY)&&(delete t.mapId,delete t.areaId,delete t.markerX,delete t.markerY,delete t.ubicacionDescripcion,this.saveData().catch(e=>{}))):t.mapId&&t.areaId&&(a=[{mapId:t.mapId,areaId:t.areaId,markerX:t.markerX,markerY:t.markerY,descripcion:t.ubicacionDescripcion}]),0!==a.length?this.mostrarModalSeleccionUbicacion(t,a):this.showToast(' Este repuesto no tiene ubicaciones. Usa " Aadir Ubicacin" para agregarlo al mapa.',"info",4e3)}mostrarModalSeleccionUbicacion(e,t){const a=document.querySelectorAll("#modalSeleccionUbicacion");a.length>0&&a.forEach(e=>e.remove());let n="";t.forEach((t,a)=>{var i,s;const r=o.maps.find(e=>e.id===t.mapId),d=o.areas.find(e=>e.id===t.areaId),c=r?r.name:"Mapa desconocido",p=d?d.name:"rea desconocida",u=d&&(null==(s=null==(i=null==l?void 0:l.categories)?void 0:i[d.category])?void 0:s.icon)||"",m=t.descripcion||"";n+=`\n        <div style="\n          padding: 16px;\n          background: var(--bg-secondary);\n          border: 2px solid var(--border-color);\n          border-radius: 12px;\n          margin-bottom: 12px;\n          transition: all 0.3s ease;\n          box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n        " \n        class="ubicacion-item" \n        data-index="${a}"\n        onmouseenter="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"\n        onmouseleave="this.style.borderColor='var(--border-color)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">\n          \n          <div style="display: flex; align-items: start; gap: 14px;">\n            \x3c!-- Checkbox --\x3e\n            <input type="checkbox" \n                   id="ubicacion-check-${a}" \n                   class="ubicacion-checkbox"\n                   style="\n                     margin-top: 6px; \n                     width: 20px; \n                     height: 20px; \n                     cursor: pointer;\n                     accent-color: var(--primary);\n                   "\n                   onchange="app.toggleUbicacionSeleccion(${a})">\n            \n            \x3c!-- Contenido principal --\x3e\n            <div style="flex: 1;">\n              \x3c!-- Encabezado con cono y nombre --\x3e\n              <div style="\n                display: flex; \n                align-items: center; \n                gap: 8px;\n                font-weight: 700; \n                font-size: 1.05rem;\n                margin-bottom: 8px;\n                color: var(--text-primary);\n              ">\n                <span style="font-size: 1.4rem;">${u}</span>\n                <span>${p}</span>\n              </div>\n              \n              \x3c!-- Nombre del mapa --\x3e\n              <div style="\n                font-size: 0.9rem; \n                color: var(--text-secondary); \n                margin-bottom: 10px;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n              ">\n                <span style="opacity: 0.7;"></span>\n                <span>${c}</span>\n              </div>\n              \n              \x3c!-- Descripcin --\x3e\n              ${m?`\n                <div style="\n                  font-size: 0.9rem; \n                  color: var(--text-primary);\n                  background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);\n                  padding: 10px 14px;\n                  border-radius: 8px;\n                  margin: 10px 0;\n                  border-left: 4px solid var(--primary);\n                  box-shadow: 0 1px 3px rgba(0,0,0,0.08);\n                  line-height: 1.5;\n                ">\n                  <div style="font-weight: 600; font-size: 0.75rem; color: var(--primary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">\n                     Descripcin\n                  </div>\n                  ${m}\n                </div>\n              `:'\n                <div style="\n                  font-size: 0.85rem; \n                  color: var(--text-muted);\n                  font-style: italic;\n                  margin: 8px 0;\n                  padding: 8px;\n                  background: var(--bg-tertiary);\n                  border-radius: 6px;\n                  text-align: center;\n                ">\n                  Sin descripcin personalizada\n                </div>\n              '}\n              \n              \x3c!-- Coordenadas --\x3e\n              ${t.markerX&&t.markerY?`\n                <div style="\n                  font-size: 0.8rem; \n                  color: var(--text-muted); \n                  margin-top: 8px;\n                  font-family: 'Courier New', monospace;\n                  background: var(--bg-tertiary);\n                  display: inline-block;\n                  padding: 4px 10px;\n                  border-radius: 4px;\n                ">\n                   (${Math.round(t.markerX)}, ${Math.round(t.markerY)})\n                </div>\n              `:""}\n              \n              \x3c!-- Botones de accin --\x3e\n              <div style="\n                display: grid; \n                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));\n                gap: 8px; \n                margin-top: 14px;\n              ">\n                <button onclick="app.verUbicacionIndividual('${e.id}', ${a})" style="\n                  padding: 10px 14px;\n                  background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%);\n                  color: white;\n                  border: none;\n                  border-radius: 8px;\n                  font-size: 0.85rem;\n                  cursor: pointer;\n                  font-weight: 600;\n                  transition: all 0.2s ease;\n                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n                "\n                onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"\n                onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">\n                   Ver en Mapa\n                </button>\n                \n                <button onclick="app.editarDescripcionUbicacion('${e.id}', ${a})" style="\n                  padding: 10px 14px;\n                  background: linear-gradient(135deg, var(--info) 0%, #117a8b 100%);\n                  color: white;\n                  border: none;\n                  border-radius: 8px;\n                  font-size: 0.85rem;\n                  cursor: pointer;\n                  font-weight: 600;\n                  transition: all 0.2s ease;\n                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n                "\n                onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"\n                onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">\n                   Editar Nota\n                </button>\n                \n                <button onclick="app.editarUbicacionRepuesto('${e.id}', ${a})" style="\n                  padding: 10px 14px;\n                  background: linear-gradient(135deg, var(--warning) 0%, #d39e00 100%);\n                  color: white;\n                  border: none;\n                  border-radius: 8px;\n                  font-size: 0.85rem;\n                  cursor: pointer;\n                  font-weight: 600;\n                  transition: all 0.2s ease;\n                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n                "\n                onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"\n                onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">\n                   Mover Pin\n                </button>\n                \n                <button onclick="app.eliminarUbicacionRepuesto('${e.id}', ${a})" style="\n                  padding: 10px 14px;\n                  background: linear-gradient(135deg, var(--danger) 0%, #bd2130 100%);\n                  color: white;\n                  border: none;\n                  border-radius: 8px;\n                  font-size: 0.85rem;\n                  cursor: pointer;\n                  font-weight: 600;\n                  transition: all 0.2s ease;\n                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n                "\n                onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"\n                onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">\n                   Eliminar\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      `});const i=`\n      <div class="modal active" id="modalSeleccionUbicacion" style="z-index: 10000;">\n        <div class="modal-content" style="max-width: 700px;">\n          <button class="modal-close" onclick="document.getElementById('modalSeleccionUbicacion').remove()"></button>\n          \n          \x3c!-- Ttulo del modal --\x3e\n          <div class="modal-title" style="\n            background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%);\n            color: white;\n            padding: 20px 24px;\n            margin: -20px -24px 20px;\n            border-radius: 12px 12px 0 0;\n            box-shadow: 0 4px 8px rgba(0,0,0,0.1);\n          ">\n            <div style="font-size: 1.4rem; font-weight: 700; margin-bottom: 6px;">\n               Ubicaciones del Repuesto\n            </div>\n            <div style="font-size: 1.1rem; opacity: 0.95;">\n              ${e.nombre}\n            </div>\n          </div>\n          \n          <div style="padding: 0 24px 24px;">\n            \x3c!-- Contador de ubicaciones --\x3e\n            <div style="\n              margin-bottom: 20px; \n              padding: 14px 18px;\n              background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);\n              border-radius: 10px;\n              border-left: 4px solid var(--accent);\n              box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n            ">\n              <div style="display: flex; align-items: center; gap: 10px;">\n                <span style="font-size: 1.8rem;"></span>\n                <div>\n                  <div style="font-weight: 600; font-size: 1.05rem;">\n                    ${t.length} ${1===t.length?"Ubicacin":"Ubicaciones"} Registradas\n                  </div>\n                  <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 2px;">\n                    Selecciona una o varias ubicaciones para visualizar\n                  </div>\n                </div>\n              </div>\n            </div>\n            \n            \x3c!-- Lista de ubicaciones --\x3e\n            <div style="max-height: 450px; overflow-y: auto; margin-bottom: 20px; padding-right: 8px;">\n              ${n}\n            </div>\n            \n            \x3c!-- Botones principales --\x3e\n            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">\n              <button onclick="app.verTodasLasUbicaciones('${e.id}')" class="btn btn-primary" style="\n                padding: 14px 20px;\n                background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%);\n                color: white;\n                border: none;\n                border-radius: 10px;\n                font-size: 1rem;\n                font-weight: 700;\n                cursor: pointer;\n                transition: all 0.3s ease;\n                box-shadow: 0 4px 8px rgba(0,0,0,0.15);\n              "\n              onmouseenter="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)';"\n              onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';">\n                 Ver Todas en Mapa\n              </button>\n              \n              <button id="btnVerSeleccionadas" onclick="app.verUbicacionesSeleccionadas('${e.id}')" class="btn btn-accent" style="\n                padding: 14px 20px;\n                background: linear-gradient(135deg, var(--accent) 0%, #218838 100%);\n                color: white;\n                border: none;\n                border-radius: 10px;\n                font-size: 1rem;\n                font-weight: 700;\n                cursor: pointer;\n                transition: all 0.3s ease;\n                box-shadow: 0 4px 8px rgba(0,0,0,0.15);\n                opacity: 0.5;\n              "\n              disabled\n              onmouseenter="if(!this.disabled) { this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'; }"\n              onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';">\n                 Ver Seleccionadas (<span id="countSeleccionadas">0</span>)\n              </button>\n            </div>\n            \n            \x3c!-- Botn cerrar --\x3e\n            <button onclick="document.getElementById('modalSeleccionUbicacion').remove()" class="btn btn-secondary" style="\n              width: 100%; \n              padding: 12px;\n              background: var(--bg-tertiary);\n              color: var(--text-primary);\n              border: 2px solid var(--border-color);\n              border-radius: 8px;\n              font-size: 0.95rem;\n              font-weight: 600;\n              cursor: pointer;\n              transition: all 0.2s ease;\n            "\n            onmouseenter="this.style.background='var(--bg-secondary)'; this.style.borderColor='var(--text-muted)';"\n            onmouseleave="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border-color)';">\n              Cerrar\n            </button>\n          </div>\n        </div>\n      </div>\n    `,s=document.getElementById("modalSeleccionUbicacion");s&&s.remove(),document.body.insertAdjacentHTML("beforeend",i),window._ubicacionesSeleccionadas=new Set}toggleUbicacionSeleccion(e){window._ubicacionesSeleccionadas||(window._ubicacionesSeleccionadas=new Set);document.getElementById(`ubicacion-check-${e}`).checked?window._ubicacionesSeleccionadas.add(e):window._ubicacionesSeleccionadas.delete(e);const t=window._ubicacionesSeleccionadas.size,a=document.getElementById("countSeleccionadas"),n=document.getElementById("btnVerSeleccionadas");a&&(a.textContent=t),n&&(n.disabled=0===t,n.style.opacity=0===t?"0.5":"1",n.style.cursor=0===t?"not-allowed":"pointer")}verUbicacionIndividual(e,t){const a=this.repuestos.find(t=>String(t.id)===String(e));if(!a)return;let n=a.ubicaciones||[];0===n.length&&a.mapId&&a.areaId&&(n=[{mapId:a.mapId,areaId:a.areaId,markerX:a.markerX,markerY:a.markerY,descripcion:a.ubicacionDescripcion}]);if(!n[t])return;const i=document.getElementById("modalSeleccionUbicacion");i&&i.remove(),this.switchTab("mapa"),setTimeout(()=>{void 0!==l&&l.moverMarcador?l.moverMarcador(e,t):this.showToast(" Sistema de mapas no disponible","error")},300)}verTodasLasUbicaciones(e){const t=this.repuestos.find(t=>String(t.id)===String(e));if(!t)return;let a=t.ubicaciones||[];0===a.length&&t.mapId&&t.areaId&&(a=[{mapId:t.mapId,areaId:t.areaId,markerX:t.markerX,markerY:t.markerY,descripcion:t.ubicacionDescripcion}]);const n=document.getElementById("modalSeleccionUbicacion");n&&n.remove(),this.switchTab("mapa"),this.showToast(` Mostrando ${a.length} ubicaciones de "${t.nombre}"`,"info"),setTimeout(()=>{l&&l.mostrarMultiplesUbicaciones&&l.mostrarMultiplesUbicaciones(a,t)},300)}verUbicacionesSeleccionadas(e){if(!window._ubicacionesSeleccionadas||0===window._ubicacionesSeleccionadas.size)return void this.showToast(" Selecciona al menos una ubicacin","warning");const t=this.repuestos.find(t=>String(t.id)===String(e));if(!t)return;let a=t.ubicaciones||[];0===a.length&&t.mapId&&t.areaId&&(a=[{mapId:t.mapId,areaId:t.areaId,markerX:t.markerX,markerY:t.markerY,descripcion:t.ubicacionDescripcion}]);const n=Array.from(window._ubicacionesSeleccionadas).map(e=>a[e]).filter(e=>e),i=document.getElementById("modalSeleccionUbicacion");i&&i.remove(),this.switchTab("mapa"),this.showToast(` Mostrando ${n.length} ubicaciones seleccionadas`,"info"),setTimeout(()=>{l&&l.mostrarMultiplesUbicaciones&&l.mostrarMultiplesUbicaciones(n,t)},300)}async editarDescripcionUbicacion(e,t){const a=this.repuestos.find(t=>String(t.id)===String(e));if(!a)return;let n=a.ubicaciones||[];0===n.length&&a.mapId&&a.areaId&&(n=[{mapId:a.mapId,areaId:a.areaId,markerX:a.markerX,markerY:a.markerY,descripcion:a.ubicacionDescripcion||""}],a.ubicaciones=n,delete a.mapId,delete a.areaId,delete a.markerX,delete a.markerY,delete a.ubicacionDescripcion);const i=n[t];if(!i)return;const s=o.areas.find(e=>e.id===i.areaId),r=s?s.name:"ubicacin",l=i.descripcion||"",d=prompt(`Descripcin para "${r}":\n\nEjemplo: "Al lado de la mquina BAADER 200, tercer estante"`,l);if(null!==d){i.descripcion=d.trim();try{await this.saveData(),this.showToast(" Descripcin actualizada","success"),this.refrescarModalUbicaciones(e)}catch(c){this.showToast(" Error al guardar","error")}}}refrescarModalUbicaciones(e){const t=this.repuestos.find(t=>String(t.id)===String(e));if(!t)return;let a=t.ubicaciones||[];0===a.length&&t.mapId&&t.areaId&&(a=[{mapId:t.mapId,areaId:t.areaId,markerX:t.markerX,markerY:t.markerY,descripcion:t.ubicacionDescripcion}]);document.querySelectorAll("#modalSeleccionUbicacion").forEach((e,t)=>{e.remove()}),0!==a.length?setTimeout(()=>{this.mostrarModalSeleccionUbicacion(t,a)},150):this.showToast(" El repuesto ya no tiene ubicaciones","info")}seleccionarYMostrarUbicacion(e,t){const a=this.repuestos.find(t=>String(t.id)===String(e));if(!a)return;let n=a.ubicaciones||[];0===n.length&&a.mapId&&a.areaId&&(n=[{mapId:a.mapId,areaId:a.areaId,markerX:a.markerX,markerY:a.markerY}]);const i=n[t];if(!i)return;const s=document.getElementById("modalSeleccionUbicacion");s&&s.remove(),this.mostrarRepuestoEnMapa(i,a)}async editarUbicacionRepuesto(e,t){const a=this.repuestos.find(t=>String(t.id)===String(e));if(!a)return;let n=a.ubicaciones||[];0===n.length&&a.mapId&&a.areaId&&(n=[{mapId:a.mapId,areaId:a.areaId,markerX:a.markerX,markerY:a.markerY}],a.ubicaciones=n,delete a.mapId,delete a.areaId,delete a.markerX,delete a.markerY);const i=n[t];if(!i)return;const s=o.areas.find(e=>e.id===i.areaId),r=s?s.name:"el rea",d=document.getElementById("modalSeleccionUbicacion");d&&d.remove(),window._editandoUbicacion||(window._editandoUbicacion={}),window._editandoUbicacion.repuestoId=e,window._editandoUbicacion.indice=t,window._editandoUbicacion.modoEdicion=!0,this.switchTab("mapa"),this.showToast(" Editando ubicacin... Cargando mapa","info"),setTimeout(()=>{l&&l.loadMap&&l.loadMap(i.mapId),setTimeout(()=>{l&&l.zoomToArea&&l.zoomToArea(i.areaId),setTimeout(()=>{l&&l.flashArea?l.flashArea(i.areaId,3):l&&l.highlightArea&&l.highlightArea(i.areaId),l&&l.activarModoMarcador&&l.activarModoMarcador(e,i.mapId,i.areaId,!0),setTimeout(()=>{this.showToast(` Haz click en "${r}" para cambiar la posicin del marcador`,"info",6e3)},1e3)},600)},500)},300)}async eliminarUbicacionRepuesto(e,t){const a=this.repuestos.find(t=>String(t.id)===String(e));if(!a)return;let n=a.ubicaciones||[];if(0===n.length&&a.mapId&&a.areaId&&(n=[{mapId:a.mapId,areaId:a.areaId,markerX:a.markerX,markerY:a.markerY}],a.ubicaciones=n,delete a.mapId,delete a.areaId,delete a.markerX,delete a.markerY),t<0||t>=n.length)return;const i=n[t],s=o.areas.find(e=>e.id===i.areaId),r=s?s.name:"desconocida";if(confirm(`Eliminar la ubicacin en "${r}"?\n\nEsta accin no se puede deshacer.`)){n.splice(t,1),0===n.length&&delete a.ubicaciones;try{await this.saveData(),this.showToast(` Ubicacin eliminada de "${a.nombre}"`,"success"),this.refrescarModalUbicaciones(e),l&&l.draw&&l.draw()}catch(d){this.showToast(" Error al eliminar ubicacin","error")}}}mostrarRepuestoEnMapa(e,t){this.switchTab("mapa"),setTimeout(()=>{void 0!==l&&l?(l.loadMap&&l.loadMap(e.mapId),setTimeout(()=>{l.highlightArea&&l.highlightArea(e.areaId),l.zoomToArea&&l.zoomToArea(e.areaId),l.pulseArea&&l.pulseArea(e.areaId),e.markerX&&e.markerY&&l.showMarker&&l.showMarker(e.markerX,e.markerY,t.nombre),this.showToast(` Ubicacin de "${t.nombre}" mostrada en el mapa`,"success")},500)):this.showToast(" Sistema de mapas no disponible","error")},300)}abrirModalAsignarAreaMapa(e,t){if(void 0===o||!o)return void this.showToast(" Sistema de mapas no disponible","error");const a=o.maps||[];if(!a||0===a.length)return void this.showToast(' No hay mapas creados. Crea un mapa primero en la pestaa "MAPA"',"warning");const n=o.areas||[];if(!n||0===n.length)return void this.showToast(' No hay reas creadas en los mapas. Dibuja reas primero en la pestaa "MAPA"',"warning");const i={};n.forEach(e=>{if(!i[e.mapId]){const t=a.find(t=>t.id===e.mapId);i[e.mapId]={mapa:t,areas:[]}}i[e.mapId].areas.push(e)});let s="";Object.values(i).forEach(e=>{s+=`<optgroup label=" ${e.mapa.name}">`,e.areas.forEach(e=>{const t=l&&l.categories&&l.categories[e.category]?l.categories[e.category].icon:"";s+=`<option value="${e.mapId}|${e.id}">${t} ${e.name}</option>`}),s+="</optgroup>"});const r=`\n      <div class="modal active" id="modalAsignarArea" style="z-index: 10000;">\n        <div class="modal-content" style="max-width: 600px;">\n          <button class="modal-close" onclick="document.getElementById('modalAsignarArea').remove()"></button>\n          <div class="modal-title"> Asignar ubicacin en mapa: ${t.nombre}</div>\n          \n          <div style="padding: 20px;">\n            <p style="margin-bottom: 20px; color: var(--text-secondary); line-height: 1.6;">\n              Selecciona el rea donde se encuentra <strong>"${t.nombre}"</strong>. \n              Luego podrs colocar un marcador en el lugar exacto dentro del rea.\n            </p>\n            \n            <div class="form-group">\n              <label style="font-weight: 600; margin-bottom: 8px; display: block;">rea del mapa:</label>\n              <select id="areaMapaSelect" style="\n                width: 100%;\n                padding: 12px;\n                font-size: 1rem;\n                border: 2px solid var(--border);\n                border-radius: 8px;\n                background: var(--surface);\n                color: var(--text);\n              ">\n                <option value="">-- Selecciona un rea --</option>\n                ${s}\n              </select>\n            </div>\n            \n            <div style="display: flex; gap: 12px; margin-top: 24px;">\n              <button onclick="document.getElementById('modalAsignarArea').remove()" class="btn btn-secondary" style="flex: 1;">\n                Cancelar\n              </button>\n              <button onclick="app.confirmarAsignacionArea('${e}')" class="btn btn-primary" style="flex: 1;">\n                Siguiente: Colocar Marcador \n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,d=document.getElementById("modalAsignarArea");d&&d.remove(),document.body.insertAdjacentHTML("beforeend",r)}async confirmarAsignacionArea(e){const t=document.getElementById("areaMapaSelect").value;if(!t)return void this.showToast(" Selecciona un rea","warning");const[a,n]=t.split("|").map(e=>parseInt(e)),i=o.areas.find(e=>e.id===n),s=i?i.name:"el rea seleccionada",r=document.getElementById("modalAsignarArea");r&&r.remove(),this.switchTab("mapa"),this.showToast(` Cargando mapa... Haz click DENTRO de "${s}" para marcar la ubicacin`,"info",6e3),setTimeout(()=>{l&&l.loadMap&&l.loadMap(a),setTimeout(()=>{l&&l.zoomToArea&&l.zoomToArea(n),setTimeout(()=>{l&&l.flashArea?l.flashArea(n,3):l&&l.highlightArea&&l.highlightArea(n),l&&l.activarModoMarcador&&l.activarModoMarcador(e,a,n),setTimeout(()=>{this.showToast(` Haz click DENTRO del rea "${s}" (resaltada) para colocar el marcador`,"info",8e3)},1500)},600)},500)},300)}selectTool(e){var t;this.mapTool=e,document.querySelectorAll(".tool-btn[data-tool]").forEach(e=>e.classList.remove("active")),null==(t=document.querySelector(`[data-tool="${e}"]`))||t.classList.add("active")}loadMapImage(e){const t=e.target.files[0];if(!t)return;this.showToast(" Cargando imagen...","info");const a=new FileReader;a.onerror=e=>{this.showToast(" Error al leer archivo","error")},a.onload=e=>{try{this.mapImage=e.target.result,localStorage.setItem("mapImage",this.mapImage),this.renderMap(),this.showToast(" Imagen de mapa cargada","success")}catch(t){this.showToast(" Error al guardar imagen","error")}},a.readAsDataURL(t),e.target.value=""}handleMapClick(e){const t=this.canvas.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;if(l&&l.state&&l.state.modoMarcador){const e=(a-l.state.offsetX)/l.state.scale,t=(n-l.state.offsetY)/l.state.scale;return void l.colocarMarcador(e,t)}if("rect"===this.mapTool){const e=prompt("Nombre del rea:");e&&(this.mapObjects.push({type:"rect",x:a,y:n,w:150,h:100,name:e}),this.renderMap(),this.saveMap())}else if("circle"===this.mapTool){const e=prompt("Nombre del rea:");e&&(this.mapObjects.push({type:"circle",x:a,y:n,r:60,name:e}),this.renderMap(),this.saveMap())}else if("machine"===this.mapTool){const e=prompt("Nombre de la mquina:");e&&(this.mapObjects.push({type:"machine",x:a,y:n,name:e}),this.renderMap(),this.saveMap())}}renderMap(){if(this.ctx)if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#0f172a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.mapImage){const e=new Image;e.onerror=()=>{this.showToast(" Error al cargar imagen","error"),this.drawMapObjects()},e.onload=()=>{try{const t=Math.min(this.canvas.width/e.width,this.canvas.height/e.height),a=(this.canvas.width-e.width*t)/2,n=(this.canvas.height-e.height*t)/2;this.ctx.drawImage(e,a,n,e.width*t,e.height*t),this.drawMapObjects()}catch(t){this.drawMapObjects()}},e.src=this.mapImage}else this.ctx.fillStyle="#94a3b8",this.ctx.font="20px sans-serif",this.ctx.textAlign="center",this.ctx.fillText("Carga una imagen de fondo",this.canvas.width/2,this.canvas.height/2),this.drawMapObjects();else setTimeout(()=>this.setupCanvas(),100)}drawMapObjects(){this.mapObjects.forEach(e=>{this.ctx.fillStyle="rgba(99, 102, 241, 0.3)",this.ctx.strokeStyle="#6366f1",this.ctx.lineWidth=3,"rect"===e.type?(this.ctx.fillRect(e.x,e.y,e.w,e.h),this.ctx.strokeRect(e.x,e.y,e.w,e.h)):"circle"===e.type?(this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke()):"machine"===e.type&&(this.ctx.fillStyle="#ef4444",this.ctx.fillRect(e.x-15,e.y-15,30,30)),this.ctx.fillStyle="#1f2937",this.ctx.font="bold 14px sans-serif",this.ctx.fillText(e.name,e.x+5,e.y-10)})}saveMap(){localStorage.setItem("mapData",JSON.stringify(this.mapObjects)),this.showToast("Mapa guardado","success")}renderStats(){const e=this.repuestos.length,t=this.repuestos.filter(e=>0===e.cantidad).length,a=this.repuestos.filter(e=>e.cantidad>0&&e.cantidad<=(e.minimo||e.stockMinimo||5)).length,n=e-t-a,i=this.repuestos.reduce((e,t)=>e+t.precio*t.cantidad,0),s=this.repuestos.filter(e=>e.multimedia&&e.multimedia.length>0).length,r=new Set(this.repuestos.map(e=>e.area)).size,o=new Set(this.repuestos.map(e=>e.equipo)).size,l=new Set(this.repuestos.map(e=>e.tipo).filter(e=>e)).size,d=e>0?(n/e*100).toFixed(1):0,c=s>0?(s/e*100).toFixed(1):0,p=t+a,u=p>.3*e?"ALTO":p>.15*e?"MEDIO":"BAJO",m=p>.3*e?"var(--danger)":p>.15*e?"var(--warning)":"var(--success)";document.getElementById("statsGrid").innerHTML=`\n      <div class="stats-card" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none;">\n        <div class="stat-value">${e}</div>\n        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Total Repuestos</div>\n      </div>\n      <div class="stats-card" style="border-left-color: var(--danger);">\n        <div class="stat-value" style="color: var(--danger);">${t}</div>\n        <div class="stat-label">Sin Stock</div>\n        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">${(t/e*100).toFixed(1)}% del total</div>\n      </div>\n      <div class="stats-card" style="border-left-color: var(--warning);">\n        <div class="stat-value" style="color: var(--warning);">${a}</div>\n        <div class="stat-label">Stock Bajo</div>\n        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">${(a/e*100).toFixed(1)}% del total</div>\n      </div>\n      <div class="stats-card" style="border-left-color: var(--success);">\n        <div class="stat-value" style="color: var(--success);">${n}</div>\n        <div class="stat-label">Stock OK</div>\n        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--success);">${d}% saludable</div>\n      </div>\n      <div class="stats-card" style="border-left-color: ${m};">\n        <div class="stat-value" style="color: ${m};">${u}</div>\n        <div class="stat-label">Nivel de Alerta</div>\n        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">${p} crticos</div>\n      </div>\n      <div class="stats-card" style="border-left-color: var(--success);">\n        <div class="stat-value" style="color: var(--success);">$${i.toLocaleString("es-ES",{minimumFractionDigits:2})}</div>\n        <div class="stat-label">Valor Inventario</div>\n        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">\n           Ver pestaa "Valores" para desglose\n        </div>\n      </div>\n      <div class="stats-card" style="border-left-color: var(--info);">\n        <div class="stat-value" style="color: var(--info);">${c}%</div>\n        <div class="stat-label">Cobertura Multimedia</div>\n        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">${s} de ${e}</div>\n      </div>\n      <div class="stats-card">\n        <div class="stat-value">${r+o+l}</div>\n        <div class="stat-label">Clasificaciones</div>\n        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);">${r} reas, ${o} equipos, ${l} tipos</div>\n      </div>\n    `;const h={};this.repuestos.forEach(e=>{h[e.area]||(h[e.area]={total:0,valor:0,sinStock:0,bajoStock:0,ok:0}),h[e.area].total++,h[e.area].valor+=e.precio*e.cantidad;const t=e.minimo||e.stockMinimo||5;0===e.cantidad?h[e.area].sinStock++:e.cantidad<=t?h[e.area].bajoStock++:h[e.area].ok++});const g="#334155",b="#60a5fa",v="#cbd5e1";let y=`<div style="background: #1e293b; border: 1px solid ${g}; padding: 24px; border-radius: 12px; box-shadow: var(--card-shadow); margin-top: 20px;">`;y+=`<h3 style="margin-bottom: 20px; color: ${b}; display: flex; align-items: center; gap: 10px;"><span style="font-size: 1.5rem;"></span> Dashboard por rea</h3>`,y+='<div style="display: grid; gap: 16px;">',Object.keys(h).sort().forEach(e=>{const t=h[e],a=(t.ok/t.total*100).toFixed(0);(t.bajoStock/t.total*100).toFixed(0),(t.sinStock/t.total*100).toFixed(0),y+=`\n        <div style="padding: 20px; background: #0f172a; border-radius: 12px; border-left: 4px solid #3b82f6; border: 1px solid ${g};">\n          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">\n            <div>\n              <strong style="color: ${b}; font-size: 1.1rem;">${e}</strong>\n              <div style="font-size: 0.85rem; color: ${v}; margin-top: 4px;">\n                ${t.total} repuestos | Valor: $${t.valor.toLocaleString("es-ES",{minimumFractionDigits:2})}\n              </div>\n            </div>\n            <div style="text-align: right;">\n              <div style="font-weight: 700; font-size: 1.2rem; color: ${b};">${a}%</div>\n              <div style="font-size: 0.75rem; color: ${v};">saludable</div>\n            </div>\n          </div>\n          \n          <div style="display: flex; gap: 2px; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 8px;">\n            <div style="flex: ${t.ok}; background: var(--success);" title="Stock OK: ${t.ok}"></div>\n            <div style="flex: ${t.bajoStock}; background: var(--warning);" title="Stock Bajo: ${t.bajoStock}"></div>\n            <div style="flex: ${t.sinStock}; background: var(--danger);" title="Sin Stock: ${t.sinStock}"></div>\n          </div>\n          \n          <div style="display: flex; gap: 16px; font-size: 0.85rem;">\n            <span style="color: var(--success);">${t.ok} OK</span>\n            <span style="color: var(--warning);">${t.bajoStock} Bajo</span>\n            <span style="color: var(--danger);">${t.sinStock} Sin stock</span>\n          </div>\n        </div>\n      `}),y+="</div></div>",document.getElementById("statsDetails").innerHTML=y}exportJSON(){if(0!==this.repuestos.length)try{const e={repuestos:this.repuestos,mapa:this.mapObjects,fecha:(new Date).toISOString(),version:"2.0"},t=JSON.stringify(e,null,2),a=(t.length/1048576).toFixed(2);parseFloat(a)>10&&this.showToast(`Exportando archivo grande (${a}MB)...`,"info");const n=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=`inventario_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(i),100),this.showToast(`JSON exportado (${a}MB)`,"success")}catch(e){this.showToast(" Error al exportar: "+e.message,"error")}else this.showToast(" No hay datos para exportar","warning")}exportJSONSinImagenes(){if(0!==this.repuestos.length)try{const e={repuestos:this.repuestos.map(e=>({id:e.id,codSAP:e.codSAP,codProv:e.codProv,tipo:e.tipo,nombre:e.nombre,area:e.area,equipo:e.equipo,cantidad:e.cantidad,minimo:e.minimo,precio:e.precio,multimedia:[]})),mapa:this.mapObjects,fecha:(new Date).toISOString(),version:"2.0",nota:" EXPORTACIN SIN IMGENES - Datos reducidos para navegador"},t=JSON.stringify(e,null,2),a=(t.length/1048576).toFixed(2),n=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=`inventario_SIN_IMAGENES_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(i),100),this.showToast(` JSON sin imgenes exportado (${a}MB) - ${this.repuestos.length} repuestos`,"success",6e3)}catch(e){this.showToast(" Error al exportar: "+e.message,"error")}else this.showToast(" No hay datos para exportar","warning")}importJSON(e){const t=e.target.files[0];if(!t)return;const a=(t.size/1048576).toFixed(2);if(a>50){if(!confirm(`Archivo muy grande (${a}MB).\n\n Esto podra tardar varios segundos.\n\n El sistema soporta archivos grandes.\n\nContinuar con la importacin?`))return void(e.target.value="")}else a>10&&this.showToast(`Importando ${a}MB - Puede tardar unos segundos...`,"info");this.showToast(" Importando datos...","info");const n=new FileReader;n.onerror=t=>{this.showToast(" Error al leer archivo","error"),e.target.value=""},n.onload=t=>{try{const a=JSON.parse(t.target.result);let n=[];if(a.repuestos&&Array.isArray(a.repuestos))n=a.repuestos;else{if(!Array.isArray(a))return this.showToast(" Formato invlido","warning"),void(e.target.value="");n=a}if(!confirm(`Importar ${n.length} repuestos? Esto reemplazar los datos actuales.`))return void(e.target.value="");this.repuestos=n.map((e,t)=>({id:e.id||`imported-${Date.now()}-${t}`,codSAP:e.codSAP||"",codProv:e.codProv||"",tipo:e.tipo||"",nombre:e.nombre||e.tipo||"",area:e.area||"General",equipo:e.equipo||"Sin equipo",cantidad:parseInt(e.cantidad)||0,minimo:parseInt(e.minimo||e.stockMinimo)||5,precio:parseFloat(e.precio)||0,multimedia:e.multimedia||[]})),a.mapa&&Array.isArray(a.mapa)&&(this.mapObjects=a.mapa,localStorage.setItem("mapData",JSON.stringify(this.mapObjects))),this.saveData(),this.updateAutocompleteData(),this.render(),this.renderFilters(),this.showToast(` ${this.repuestos.length} repuestos importados`,"success")}catch(a){this.showToast(" Error al importar: "+a.message,"error")}},n.readAsText(t),e.target.value=""}exportExcel(){if(0!==this.repuestos.length)try{const e=this.repuestos.map(e=>({"Cdigo SAP":e.codSAP||""," Cdigo Proveedor":e.codProv||"",Tipo:e.tipo||"",Nombre:e.nombre||"",rea:e.area||"",Equipo:e.equipo||"",Cantidad:e.cantidad||0," Stock Mnimo":e.minimo||5,"Precio Unitario":e.precio||0," Valor Total":(e.precio||0)*(e.cantidad||0)," Estado":0===e.cantidad?"SIN STOCK":e.cantidad<=(e.minimo||5)?"STOCK BAJO":"OK"," Multimedia":(e.multimedia||[]).length,Documentos:(e.multimedia||[]).filter(e=>"document"===e.type).length})),t=this.repuestos.filter(e=>0===e.cantidad).length,a=this.repuestos.filter(e=>e.cantidad>0&&e.cantidad<=(e.minimo||5)).length,n=this.repuestos.length-t-a,i=this.repuestos.reduce((e,t)=>e+(t.precio||0)*(t.cantidad||0),0),s=[{Indicador:"Total Repuestos",Valor:this.repuestos.length},{Indicador:" Stock OK",Valor:n},{Indicador:" Stock Bajo",Valor:a},{Indicador:" Sin Stock",Valor:t},{Indicador:"",Valor:""},{Indicador:"Valor Total Inventario",Valor:`$${i.toFixed(2)}`},{Indicador:"Valor Promedio por Repuesto",Valor:`$${(i/this.repuestos.length).toFixed(2)}`},{Indicador:"",Valor:""},{Indicador:" Fecha de Exportacin",Valor:(new Date).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}],r={};this.repuestos.forEach(e=>{r[e.area]||(r[e.area]={cantidad:0,valor:0,sinStock:0}),r[e.area].cantidad++,r[e.area].valor+=(e.precio||0)*(e.cantidad||0),0===e.cantidad&&r[e.area].sinStock++});const o=Object.entries(r).map(([e,t])=>({rea:e,"Total Repuestos":t.cantidad," Sin Stock":t.sinStock,"Valor Total":`$${t.valor.toFixed(2)}`})),l={};this.repuestos.forEach(e=>{l[e.equipo]||(l[e.equipo]={cantidad:0,valor:0,stockBajo:0}),l[e.equipo].cantidad++,l[e.equipo].valor+=(e.precio||0)*(e.cantidad||0),e.cantidad<=(e.minimo||5)&&l[e.equipo].stockBajo++});const d=Object.entries(l).map(([e,t])=>({Equipo:e,"Total Repuestos":t.cantidad," Stock Bajo/Sin Stock":t.stockBajo,"Valor Total":`$${t.valor.toFixed(2)}`})),c=this.repuestos.filter(e=>e.cantidad<=(e.minimo||5)).map(e=>({" Prioridad":0===e.cantidad?"CRTICA":"MEDIA","Cdigo SAP":e.codSAP||"",Nombre:e.nombre,"Stock Actual":e.cantidad," Stock Mnimo":e.minimo||5," Dficit":(e.minimo||5)-e.cantidad,rea:e.area,Equipo:e.equipo})).sort((e,t)=>e["Stock Actual"]-t["Stock Actual"]),p=XLSX.utils.book_new(),u=XLSX.utils.json_to_sheet(e),m=XLSX.utils.json_to_sheet(s),h=XLSX.utils.json_to_sheet(o),g=XLSX.utils.json_to_sheet(d),b=XLSX.utils.json_to_sheet(c);u["!cols"]=[{wch:15},{wch:18},{wch:15},{wch:30},{wch:15},{wch:20},{wch:10},{wch:12},{wch:12},{wch:12},{wch:12},{wch:10},{wch:10}],m["!cols"]=[{wch:35},{wch:25}],h["!cols"]=[{wch:20},{wch:15},{wch:12},{wch:15}],g["!cols"]=[{wch:25},{wch:15},{wch:20},{wch:15}],b["!cols"]=[{wch:12},{wch:15},{wch:30},{wch:12},{wch:12},{wch:10},{wch:15},{wch:20}];const v=[{Categora:"Stock OK",Cantidad:n,Porcentaje:parseFloat((n/this.repuestos.length*100).toFixed(1))},{Categora:"Stock Bajo",Cantidad:a,Porcentaje:parseFloat((a/this.repuestos.length*100).toFixed(1))},{Categora:"Sin Stock",Cantidad:t,Porcentaje:parseFloat((t/this.repuestos.length*100).toFixed(1))}],y=XLSX.utils.json_to_sheet(v);y["!cols"]=[{wch:20},{wch:12},{wch:12}];const f=Object.entries(r).sort((e,t)=>t[1].cantidad-e[1].cantidad).slice(0,10).map(([e,t])=>({rea:e,"Total Repuestos":t.cantidad,"Sin Stock":t.sinStock,Valor:parseFloat(t.valor.toFixed(2))})),x=XLSX.utils.json_to_sheet(f);x["!cols"]=[{wch:25},{wch:15},{wch:12},{wch:15}];const S=Object.entries(l).sort((e,t)=>t[1].valor-e[1].valor).slice(0,10).map(([e,t])=>({Equipo:e,"Valor Total":parseFloat(t.valor.toFixed(2)),Cantidad:t.cantidad,Alertas:t.stockBajo})),w=XLSX.utils.json_to_sheet(S);w["!cols"]=[{wch:30},{wch:15},{wch:12},{wch:12}];const A={};this.repuestos.forEach(e=>{const t=e.tipo||"Sin Tipo";A[t]||(A[t]={cantidad:0,valor:0}),A[t].cantidad++,A[t].valor+=(e.precio||0)*(e.cantidad||0)});const E=Object.entries(A).sort((e,t)=>t[1].cantidad-e[1].cantidad).map(([e,t])=>({Tipo:e,Cantidad:t.cantidad,Porcentaje:parseFloat((t.cantidad/this.repuestos.length*100).toFixed(1)),Valor:parseFloat(t.valor.toFixed(2))})),I=XLSX.utils.json_to_sheet(E);I["!cols"]=[{wch:20},{wch:12},{wch:12},{wch:15}];const $=this.repuestos.map(e=>({nombre:e.nombre,codSAP:e.codSAP||"",valor:(e.precio||0)*(e.cantidad||0),cantidad:e.cantidad,precio:e.precio||0})).filter(e=>e.valor>0).sort((e,t)=>t.valor-e.valor).slice(0,15).map(e=>({Repuesto:e.nombre.substring(0,35),"Cdigo SAP":e.codSAP,"Valor Total":parseFloat(e.valor.toFixed(2)),Cantidad:e.cantidad,"Precio Unit":parseFloat(e.precio.toFixed(2))})),k=XLSX.utils.json_to_sheet($);k["!cols"]=[{wch:35},{wch:15},{wch:15},{wch:12},{wch:12}],XLSX.utils.book_append_sheet(p,u,"Inventario"),XLSX.utils.book_append_sheet(p,m,"Resumen"),XLSX.utils.book_append_sheet(p,h," Por rea"),XLSX.utils.book_append_sheet(p,g,"Por Equipo"),XLSX.utils.book_append_sheet(p,b," Alertas"),XLSX.utils.book_append_sheet(p,y," Graf-Estado Stock"),XLSX.utils.book_append_sheet(p,x," Graf-Top reas"),XLSX.utils.book_append_sheet(p,w," Graf-Top Equipos"),XLSX.utils.book_append_sheet(p,I," Graf-Por Tipo"),XLSX.utils.book_append_sheet(p,k," Graf-Top Valiosos");const M=`Inventario_${(new Date).toISOString().replace(/[:.]/g,"-").slice(0,-5)}.xlsx`;XLSX.writeFile(p,M),this.showToast(` Excel exportado con 10 hojas: ${M}`,"success",4e3)}catch(e){this.showToast(" Error al exportar: "+e.message,"error")}else this.showToast(" No hay datos para exportar","warning")}togglePrecio(){const e=document.getElementById("togglePrecioBtn");this.showPrecio=!this.showPrecio,this.showPrecio?e.classList.add("active"):e.classList.remove("active"),this.render()}toggleView(e,t){e.parentElement.querySelectorAll(".view-toggle-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),this.currentView=t,this.render()}updateConnectionStatus(){const e=document.getElementById("connectionBtn");if(!e)return;n&&n.isFileSystemMode?(e.classList.remove("disconnected"),e.classList.add("connected"),e.textContent="Conectado"):(e.classList.remove("connected"),e.classList.add("disconnected"),e.textContent="Desconectado")}startConnectionMonitoring(){this.updateConnectionStatus(),setInterval(()=>{this.updateConnectionStatus()},2e3)}showStorageInfo(){const e=(JSON.stringify(this.repuestos).length/1048576).toFixed(2),t=this.repuestos.reduce((e,t)=>e+(t.multimedia?t.multimedia.filter(e=>"image"===e.type).length:0),0),a=this.repuestos.reduce((e,t)=>e+(t.multimedia?t.multimedia.filter(e=>"document"===e.type).length:0),0),i=n&&n.isFileSystemMode,s="#f8fafc",r="#334155",o="#0f172a",l="#cbd5e1",d=document.createElement("div");d.style.cssText="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;",d.innerHTML=`\n      <div style="background: #1e293b; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 32px; border: 2px solid ${r};">\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">\n          <h2 style="color: #60a5fa; margin: 0;">Informacin de Almacenamiento</h2>\n          <button onclick="this.closest('div[style*=fixed]').remove()" style="background: #334155; border: none; font-size: 1.5rem; cursor: pointer; color: ${s}; width: 36px; height: 36px; border-radius: 8px; transition: all 0.2s;"></button>\n        </div>\n        \n        ${i?`\n        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);">\n          <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">\n            <span style="font-size: 2rem;"></span> MODO CARPETA ACTIVO\n          </div>\n          <div style="font-size: 0.95rem; opacity: 0.95;"> Carpeta: ${n.folderPath||"Conectada"}</div>\n          <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 6px;"> Capacidad ilimitada | Datos en disco</div>\n        </div>\n        \n        <div style="background: ${o}; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #10b981;">\n          <div style="font-size: 1.2rem; font-weight: 600; color: ${s}; margin-bottom: 4px;">Solo Metadata en Memoria</div>\n          <div style="font-size: 2rem; font-weight: 700; color: #10b981;">${e} MB</div>\n          <div style="color: ${l}; font-size: 0.85rem; margin-top: 4px;">Las imgenes NO cuentan para este tamao</div>\n        </div>\n        `:`\n        <div style="background: ${o}; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">\n          <div style="font-size: 2.5rem; font-weight: 700; color: #60a5fa; margin-bottom: 8px;">${e} MB</div>\n          <div style="color: ${s}; font-size: 1.1rem; font-weight: 600;">Tamao en LocalStorage</div>\n          <div style="color: ${l}; font-size: 0.85rem; margin-top: 4px;"> Lmite: ~10MB | Incluye imgenes en base64</div>\n        </div>\n        `}\n        \n        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px;">\n          <div style="background: ${o}; padding: 16px; border-radius: 12px; text-align: center; border: 1px solid ${r};">\n            <div style="font-size: 1.8rem; font-weight: 700; color: #60a5fa;">${this.repuestos.length}</div>\n            <div style="color: ${s}; font-size: 0.9rem; margin-top: 4px;">Repuestos</div>\n          </div>\n          <div style="background: ${o}; padding: 16px; border-radius: 12px; text-align: center; border: 1px solid ${r};">\n            <div style="font-size: 1.8rem; font-weight: 700; color: #22d3ee;">${t}</div>\n            <div style="color: ${s}; font-size: 0.9rem; margin-top: 4px;">Imgenes</div>\n          </div>\n          <div style="background: ${o}; padding: 16px; border-radius: 12px; text-align: center; border: 1px solid ${r};">\n            <div style="font-size: 1.8rem; font-weight: 700; color: #fbbf24;">${a}</div>\n            <div style="color: ${s}; font-size: 0.9rem; margin-top: 4px;">Documentos</div>\n          </div>\n        </div>\n        \n        ${i?'\n        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">\n          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;"> MODO CARPETA - SIN LMITES</div>\n          <div style="font-size: 0.95rem; line-height: 1.6;">\n             <strong>Capacidad ilimitada:</strong> 1,000+ imgenes sin problema<br>\n             <strong>Almacenamiento:</strong> inventario.json + carpeta imagenes/<br>\n            <strong>Portable:</strong> Copia la carpeta completa a otro PC<br>\n            <strong>Imgenes:</strong> Archivos WebP en disco (no en memoria)<br>\n             <strong>Sin lmites:</strong> Solo depende del espacio en disco\n          </div>\n        </div>\n        \n        <div style="background: var(--info); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">\n          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;">Cmo llevar tu inventario a otro PC?</div>\n          <div style="font-size: 0.95rem; line-height: 1.6;">\n            <strong>1.</strong> Copia la carpeta completa donde seleccionaste guardar<br>\n            <strong>2.</strong> Llvala a otro PC (USB, nube, red)<br>\n            <strong>3.</strong> Abre este HTML y activa "Modo Carpeta"<br>\n            <strong>4.</strong> Selecciona la carpeta copiada<br>\n            <strong>5.</strong> Listo! Todo tu inventario estar disponible\n          </div>\n        </div>\n        ':'\n        <div style="background: var(--info); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">\n          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;">INFO Lmites del Sistema</div>\n          <div style="font-size: 0.95rem; line-height: 1.6;">\n             LocalStorage: ~5-10MB segn navegador<br>\n             Archivos JSON: Sin lmite (exportar/importar)<br>\n             <strong>Imgenes: Formato WebP</strong> (mejor que JPEG)<br>\n             Compresin inteligente: 800px, calidad 85%, ~100KB<br>\n             Sistema optimizado para 500+ repuestos con fotos\n          </div>\n        </div>\n        \n        <div style="background: var(--success); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">\n          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;"> Tecnologa de Compresin</div>\n          <div style="font-size: 0.95rem; line-height: 1.6;">\n            <strong>WebP:</strong> 30% ms ligero que JPEG con mejor calidad<br>\n            <strong>Fallback:</strong> JPEG de alta calidad si WebP no disponible<br>\n            <strong>Optimizacin:</strong> 800px mx, calidad adaptativa 85-50%<br>\n            <strong>Resultado:</strong> Imgenes ntidas de ~100KB<br>\n            <strong>Reduccin tpica:</strong> 80-95% del tamao original\n          </div>\n        </div>\n        \n        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">\n          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;"> Muchas imgenes? Activa MODO CARPETA</div>\n          <div style="font-size: 0.95rem; line-height: 1.6;">\n            Click en <strong>" Modo Carpeta"</strong> (esquina inferior derecha)<br>\n             Capacidad ILIMITADA | Portable | Sin lmites de 10MB\n          </div>\n        </div>\n        '}\n        \n        <div style="background: var(--warning); color: white; padding: 16px; border-radius: 12px; margin-bottom: 20px;">\n          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;"> Tip Profesional</div>\n          <div style="font-size: 0.95rem; line-height: 1.6;">\n            <strong>Para archivos muy grandes (>50MB):</strong><br>\n             El sistema los soporta sin problemas<br>\n             La importacin puede tardar 5-10 segundos<br>\n             Todo se mantiene embebido en el HTML+JSON<br>\n             Puedes tener cientos de fotos sin problema<br>\n             Solo el LocalStorage temporal tiene lmite\n          </div>\n        </div>\n        \n        <div style="display: flex; gap: 12px;">\n          <button onclick="app.exportJSON(); this.closest('div[style*=fixed]').remove();" style="flex: 1; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">\n            Exportar Ahora\n          </button>\n          <button onclick="this.closest('div[style*=fixed]').remove();" style="flex: 1; padding: 14px; background: #334155; color: ${s}; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.2s;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#334155'">\n            Cerrar\n          </button>\n        </div>\n      </div>\n    `,document.body.appendChild(d),d.addEventListener("click",e=>{e.target===d&&d.remove()})}diagnosticIDs(){const e=[],t=new Map;if(this.repuestos.forEach((a,n)=>{var i;a.id,a.id,a.nombre,a.codSAP,null==(i=a.multimedia)||i.length,a.id?"undefined"===a.id||"null"===a.id?e.push(` Repuesto ${n} con ID invlido: ${a.id}`):t.has(a.id)&&e.push(` ID duplicado "${a.id}": ndices ${t.get(a.id)} y ${n}`):e.push(` Repuesto ${n} sin ID: ${a.nombre}`),t.set(a.id,n)}),e.length>0){e.forEach(e=>{});confirm(`Se encontraron ${e.length} problema(s) con los IDs.\n\nQuieres regenerar todos los IDs automticamente?\n\n(Esto solucionar los problemas pero cambiar los IDs)`)&&(this.repuestos=this.repuestos.map((e,t)=>{e.id;return e.id=`repuesto-${Date.now()}-${t}`,e}),this.saveData(),this.render(),this.showToast(" IDs regenerados correctamente","success"))}else this.showToast(" Todos los IDs estn correctos","success")}showExportMenu(){const e=document.createElement("div");e.style.cssText="position: fixed; top: 80px; right: 20px; background: var(--bg-secondary); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.5), 0 0 20px rgba(59, 130, 246, 0.3); padding: 8px; z-index: 10000; min-width: 220px; border: 1px solid var(--border-color);";const t="width: 100%; padding: 12px; background: transparent; border: none; text-align: left; cursor: pointer; border-radius: 8px; font-weight: 600; color: var(--text-primary); transition: all 0.2s;",a="var(--bg-tertiary)",i=n.isFileSystemMode?`\n      <div style="border-top: 1px solid var(--border-color); margin: 4px 0; padding-top: 4px;">\n        <button onclick="app.cleanOrphanImages(); this.parentElement.parentElement.remove();" style="${t} color: #f59e0b;" onmouseover="this.style.background='${a}'" onmouseout="this.style.background='transparent'">\n           Limpiar Imgenes Hurfanas\n        </button>\n      </div>\n    `:"";e.innerHTML=`\n      <button onclick="app.exportJSON(); this.parentElement.remove();" style="${t}" onmouseover="this.style.background='${a}'" onmouseout="this.style.background='transparent'">\n         Exportar JSON\n      </button>\n      <button onclick="app.exportExcel(); this.parentElement.remove();" style="${t}" onmouseover="this.style.background='${a}'" onmouseout="this.style.background='transparent'">\n         Exportar Excel\n      </button>\n      ${i}\n    `,document.body.appendChild(e),setTimeout(()=>{document.addEventListener("click",function t(a){e.contains(a.target)||(e.remove(),document.removeEventListener("click",t))})},100)}async cleanOrphanImages(){if(!n.isFileSystemMode)return void this.showToast(" Funcin solo disponible en modo FileSystem","warning");if(confirm(" Limpieza de Imgenes Hurfanas\n\nEsta funcin buscar y eliminar imgenes que estn en la carpeta\npero que ya no estn vinculadas a ningn producto.\n\n Esta accin NO se puede deshacer.\n\nDeseas continuar?")){this.showToast(" Analizando carpeta de imgenes...","info",3e3);try{const e=await n.cleanOrphanImages(this.repuestos);if(0===e.orphans)return void this.showToast(" No se encontraron imgenes hurfanas. Carpeta limpia.","success",5e3);const t=(e.size/1024/1024).toFixed(2),a=` Limpieza completada:\n\n Imgenes hurfanas: ${e.orphans}\n Eliminadas exitosamente: ${e.deleted}\n Errores: ${e.failed}\n Espacio liberado: ${t} MB\n\n Tu carpeta est ms limpia y optimizada.`;alert(a),this.showToast(` ${e.deleted} imgenes hurfanas eliminadas (${t} MB liberados)`,"success",6e3)}catch(e){this.showToast(" Error durante la limpieza: "+e.message,"error")}}}showToast(e,t="info",a=null){["Carpeta conectada","Carpeta reconectada","Modo Carpeta DESACTIVADO","Repuesto actualizado","Jerarqua actualizada","Modo edicin","Posicin actualizada","Filtro limpiado","datos cargados"].some(t=>e.includes(t));return"function"==typeof window.addNotificationToCampana&&window.addNotificationToCampana(e,t),null}initNotificationSystem_ROTO(){}initNotificationSystem(){window.toggleCampana=function(){const e=document.getElementById("notificationPanel");e&&(e.classList.contains("active")?e.classList.remove("active"):e.classList.add("active"))},document.addEventListener("click",function(e){const t=document.getElementById("notificationPanel"),a=document.getElementById("notificationBell");t&&a&&!t.contains(e.target)&&!a.contains(e.target)&&t.classList.contains("active")&&t.classList.remove("active")})}diagnosticoCampana(){const e=document.getElementById("notificationBell"),t=document.getElementById("notificationPanel");if(!e||!t)return;getEventListeners&&getEventListeners(e),window.getComputedStyle(e),window.getComputedStyle(t);try{t.classList.contains("active")?t.classList.remove("active"):t.classList.add("active")}catch(a){}e.addEventListener("click",function t(a){e.removeEventListener("click",t)})}initializeToastHub(){this.toastHubHistory||(this.toastHubHistory=[],this.createToastHubElements())}createToastHubElements(){const e=document.createElement("div");e.className="toast-hub-overlay",e.addEventListener("click",()=>this.closeToastHub()),document.body.appendChild(e);const t=document.createElement("div");t.className="toast-hub",t.innerHTML='\n      <div class="toast-hub-header">\n        <h3 class="toast-hub-title">\n           Notificaciones\n          <span class="toast-hub-counter">0</span>\n        </h3>\n        <button class="toast-hub-close" onclick="app.closeToastHub()"></button>\n      </div>\n      <div class="toast-hub-content" id="toastHubContent">\n        <div style="text-align: center; padding: 40px 20px; color: #64748b;">\n          No hay notificaciones\n        </div>\n      </div>\n    ',document.body.appendChild(t);const a=document.createElement("button");a.className="toast-hub-trigger",a.innerHTML='\n      \n      <span class="toast-hub-trigger-badge">0</span>\n    ',a.addEventListener("click",()=>this.openToastHub()),document.body.appendChild(a),this.toastHubElements={overlay:e,hub:t,trigger:a,content:t.querySelector("#toastHubContent"),counter:t.querySelector(".toast-hub-counter"),badge:a.querySelector(".toast-hub-trigger-badge")}}addToToastHub(e,t){this.initializeToastHub();const a=new Date,n={id:Date.now()+Math.random(),message:e,type:t,timestamp:a,timeString:a.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})};this.toastHubHistory.unshift(n),this.toastHubHistory.length>20&&(this.toastHubHistory=this.toastHubHistory.slice(0,20)),this.updateToastHubTrigger()}updateToastHubTrigger(){if(!this.toastHubElements)return;const e=this.toastHubHistory.length,t=document.querySelectorAll(".toast").length;e>0||t>=3?(this.toastHubElements.trigger.classList.add("active"),this.toastHubElements.badge.textContent=e,this.toastHubElements.counter.textContent=e):this.toastHubElements.trigger.classList.remove("active")}openToastHub(){this.initializeToastHub(),document.querySelectorAll(".toast").forEach(e=>{e.style.animationPlayState="paused"}),this.renderToastHubContent(),this.toastHubElements.overlay.classList.add("active"),this.toastHubElements.hub.classList.add("active")}closeToastHub(){this.toastHubElements&&(document.querySelectorAll(".toast").forEach(e=>{e.style.animationPlayState="running"}),this.toastHubElements.overlay.classList.remove("active"),this.toastHubElements.hub.classList.remove("active"))}renderToastHubContent(){if(!this.toastHubElements||!this.toastHubHistory.length)return void(this.toastHubElements&&(this.toastHubElements.content.innerHTML='\n          <div style="text-align: center; padding: 40px 20px; color: #64748b;">\n            No hay notificaciones\n          </div>\n        '));const e=this.toastHubHistory.map(e=>{const t={success:{accent:"#059669",icon:""},error:{accent:"#dc2626",icon:""},warning:{accent:"#d97706",icon:""},info:{accent:"#2563eb",icon:""}},a=t[e.type]||t.info;return`\n        <div class="toast-hub-item toast-hub-item-${e.type}" \n             style="--toast-accent: ${a.accent}">\n          <div class="toast-hub-item-content">\n            ${e.message}\n          </div>\n          <div class="toast-hub-item-icon">${a.icon}</div>\n          <div class="toast-hub-item-time">${e.timeString}</div>\n          <button class="toast-hub-item-delete" \n                  onclick="app.removeFromToastHub('${e.id}')"\n                  title="Eliminar notificacin"></button>\n        </div>\n      `}).join("");this.toastHubElements.content.innerHTML=e}removeFromToastHub(e){this.toastHubHistory=this.toastHubHistory.filter(t=>t.id!=e),this.renderToastHubContent(),this.updateToastHubTrigger()}clearToastHub(){this.toastHubHistory=[],this.renderToastHubContent(),this.updateToastHubTrigger()}showActionToast(e,t="info",a=[],n=null){const i=this.showToast(e,t,n||8e3);if(a.length>0){const e=document.createElement("div");e.style.cssText="\n        margin-top: 12px;\n        padding-top: 12px;\n        border-top: 1px solid rgba(255,255,255,0.1);\n        display: flex;\n        gap: 8px;\n        justify-content: flex-end;\n      ",a.forEach(t=>{const a=document.createElement("button");a.textContent=t.label,a.style.cssText=`\n          background: ${t.primary?"rgba(255,255,255,0.2)":"transparent"};\n          color: white;\n          border: 1px solid rgba(255,255,255,0.3);\n          border-radius: 6px;\n          padding: 6px 12px;\n          font-size: 0.8rem;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.2s;\n        `,a.addEventListener("mouseenter",()=>{a.style.background=t.primary?"rgba(255,255,255,0.3)":"rgba(255,255,255,0.1)",a.style.borderColor="rgba(255,255,255,0.5)"}),a.addEventListener("mouseleave",()=>{a.style.background=t.primary?"rgba(255,255,255,0.2)":"transparent",a.style.borderColor="rgba(255,255,255,0.3)"}),a.addEventListener("click",e=>{e.stopPropagation(),"function"==typeof t.onClick&&t.onClick(),setTimeout(()=>{i.classList.add("fade-out"),setTimeout(()=>i.remove(),400)},100)}),e.appendChild(a)}),i.querySelector("div").appendChild(e)}return i}demoToasts(){this.clearToastHub(),setTimeout(()=>{this.showToast(" Sistema Toast Hub activado - Colores corporativos sutiles","info")},500),setTimeout(()=>{this.showToast(" Hover sobre cualquier toast pausar TODOS automticamente","success")},1500),setTimeout(()=>{this.showToast(" Cuando hay ms de 3 toasts, aparece botn flotante ","warning")},2500),setTimeout(()=>{this.showToast(" Toast #4 - Ahora debe aparecer el botn flotante","info")},3500),setTimeout(()=>{this.showToast(" Toast #5 - Shift+Click abre Toast Hub centralizado","error")},4500),setTimeout(()=>{this.showToast(" Toast #6 - Click normal cierra, Shift+Click abre hub","info")},5500),setTimeout(()=>{},6500)}demoActionToasts(){this.showActionToast(" Quieres activar el modo Toast Hub como predeterminado?","info",[{label:"Ms tarde",onClick:()=>this.showToast(" Configuracin pospuesta","info")},{label:"Activar",primary:!0,onClick:()=>this.showToast(" Toast Hub activado por defecto","success")}])}demoToastHub(){for(let e=1;e<=6;e++)setTimeout(()=>{this.showToast(` Toast de prueba ${e}/6 - Diseo corporativo`,e%2==0?"success":"info")},800*e);setTimeout(()=>{},5e3)}showConfirmToast(e,t,a=null){return this.showActionToast(e,"warning",[{label:"Cancelar",onClick:a||(()=>{})},{label:"Confirmar",primary:!0,onClick:t}],1e4)}repositionToasts(){const e=document.querySelectorAll(".toast");let t=20;e.forEach((a,n)=>{a.style.transition="bottom 0.3s cubic-bezier(0.16, 1, 0.3, 1)",a.style.bottom=`${t}px`;const i=a.offsetHeight||70;t+=i+16;const s=a.querySelector(".toast-counter");s&&(s.textContent=n+1,s.style.display=e.length>=3?"flex":"none"),setTimeout(()=>{a.style.transition="all 0.3s cubic-bezier(0.16, 1, 0.3, 1)"},300)})}initNotificationSystemCORRECTO(){try{if(this.notificationBell=document.getElementById("notificationBell"),this.notificationPanel=document.getElementById("notificationPanel"),!this.notificationBell||!this.notificationPanel)return;this.notificationBell.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.toggleNotificationPanel()}),document.addEventListener("click",e=>{this.notificationPanel.contains(e.target)||this.notificationBell.contains(e.target)||this.closeNotificationPanel()}),this.updateUnreadCount(),this.renderNotifications()}catch(e){}}addNotification(e,t="info"){const a={id:Date.now()+Math.random(),message:e,type:t,timestamp:(new Date).toISOString(),read:!1,icon:this.getNotificationIcon(t)};return this.notifications.unshift(a),this.notifications.length>50&&(this.notifications=this.notifications.slice(0,50)),this.saveNotifications(),this.updateUnreadCount(),this.renderNotifications(),a}getNotificationIcon(e){return{info:"",success:"",warning:"",error:""}[e]||""}updateUnreadCount(){try{this.unreadNotifications=this.notifications?this.notifications.filter(e=>!e.read).length:0;const e=document.getElementById("notificationCounter"),t=this.notificationBell;if(!e||!t)return;this.unreadNotifications>0?(e.textContent=this.unreadNotifications,e.classList.add("active"),t.classList.add("has-unread")):(e.classList.remove("active"),t.classList.remove("has-unread"))}catch(e){}}toggleNotificationPanel(){try{if(!this.notificationPanel)return;this.notificationPanel.classList.contains("active")?this.closeNotificationPanel():this.openNotificationPanel()}catch(e){}}openNotificationPanel(){try{if(!this.notificationPanel)return;this.notificationPanel.classList.add("active"),this.notifications&&Array.isArray(this.notifications)&&(this.notifications.forEach(e=>e.read=!0),this.saveNotifications(),this.updateUnreadCount(),this.renderNotifications())}catch(e){}}closeNotificationPanel(){try{if(!this.notificationPanel)return;this.notificationPanel.classList.remove("active")}catch(e){}}renderNotifications(){const e=document.getElementById("notificationList");0!==this.notifications.length?e.innerHTML=this.notifications.map(e=>`\n      <div class="notification-item ${e.read?"":"unread"}" data-id="${e.id}">\n        <div class="notification-item-icon">${e.icon}</div>\n        <div class="notification-item-content">\n          <div class="notification-item-message">${e.message}</div>\n          <div class="notification-item-time">\n            <span></span>\n            <span>${this.formatNotificationTime(e.timestamp)}</span>\n          </div>\n        </div>\n        <button class="notification-item-delete" onclick="app.deleteNotification('${e.id}')" title="Eliminar">\n          \n        </button>\n      </div>\n    `).join(""):e.innerHTML='\n        <div class="notification-empty">\n          <div class="notification-empty-icon"></div>\n          <div class="notification-empty-text">No hay notificaciones</div>\n        </div>\n      '}formatNotificationTime(e){const t=new Date(e),a=new Date-t,n=Math.floor(a/6e4),i=Math.floor(n/60),s=Math.floor(i/24);return n<1?"Ahora":n<60?`${n}m`:i<24?`${i}h`:s<7?`${s}d`:t.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"})}deleteNotification(e){this.notifications=this.notifications.filter(t=>t.id!=e),this.saveNotifications(),this.updateUnreadCount(),this.renderNotifications()}markAllNotificationsAsRead(){this.notifications.forEach(e=>e.read=!0),this.saveNotifications(),this.updateUnreadCount(),this.renderNotifications(),this.showToast(" Todas las notificaciones marcadas como ledas","success")}clearAllNotifications(){0!==this.notifications.length?(this.notifications=[],this.saveNotifications(),this.updateUnreadCount(),this.renderNotifications(),this.showToast(" Todas las notificaciones eliminadas","success")):this.showToast(" No hay notificaciones para limpiar","info")}saveNotifications(){try{localStorage.setItem("notifications",JSON.stringify(this.notifications))}catch(e){}}showInputModal(e,t=""){return new Promise(a=>{const n=e=>e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):"",i=document.createElement("div");i.className="custom-modal-overlay",i.innerHTML=`\n        <div class="custom-modal">\n          <div class="custom-modal-title">${n(e)}</div>\n          <input type="text" class="custom-modal-input" value="${n(t)}" autofocus>\n          <div class="custom-modal-buttons">\n            <button class="custom-modal-btn custom-modal-btn-secondary" data-action="cancel">Cancelar</button>\n            <button class="custom-modal-btn custom-modal-btn-primary" data-action="accept">Aceptar</button>\n          </div>\n        </div>\n      `,document.body.appendChild(i);const s=i.querySelector(".custom-modal-input"),r=i.querySelector('[data-action="accept"]'),o=i.querySelector('[data-action="cancel"]');setTimeout(()=>{s.focus(),s.select()},100);const l=e=>{i.remove(),a(e)};r.onclick=()=>l(s.value),o.onclick=()=>l(null),s.onkeydown=e=>{"Enter"===e.key&&l(s.value),"Escape"===e.key&&l(null)},i.onclick=e=>{e.target===i&&l(null)}})}showDualInputModal(e,t,a="",n="",i,s="",r=""){return new Promise(o=>{const l=e=>e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):"",d=document.createElement("div");d.className="custom-modal-overlay",d.innerHTML=`\n        <div class="custom-modal" style="min-width: 450px;">\n          <div class="custom-modal-title">${l(e)}</div>\n          <div style="margin-bottom: 16px;">\n            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">\n              ${l(t)}\n            </label>\n            <input type="text" class="custom-modal-input" id="modal-input-1" value="${l(a)}" placeholder="${l(n)}" style="text-transform: uppercase;">\n            ${n?`<small style="display: block; margin-top: 4px; color: var(--text-muted); font-size: 11px;">${l(n)}</small>`:""}\n          </div>\n          <div style="margin-bottom: 20px;">\n            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">\n              ${l(i)}\n            </label>\n            <input type="text" class="custom-modal-input" id="modal-input-2" value="${l(s)}" placeholder="${l(r)}">\n          </div>\n          <div class="custom-modal-buttons">\n            <button class="custom-modal-btn custom-modal-btn-secondary" data-action="cancel">Cancelar</button>\n            <button class="custom-modal-btn custom-modal-btn-primary" data-action="accept">Guardar</button>\n          </div>\n        </div>\n      `,document.body.appendChild(d);const c=d.querySelector("#modal-input-1"),p=d.querySelector("#modal-input-2"),u=d.querySelector('[data-action="accept"]'),m=d.querySelector('[data-action="cancel"]');setTimeout(()=>{c.focus(),c.select()},100);const h=e=>{d.remove(),o(e)};u.onclick=()=>h({input1:c.value,input2:p.value}),m.onclick=()=>h(null),c.onkeydown=e=>{"Enter"===e.key&&(e.preventDefault(),p.focus(),p.select()),"Escape"===e.key&&h(null)},p.onkeydown=e=>{"Enter"===e.key&&h({input1:c.value,input2:p.value}),"Escape"===e.key&&h(null)},d.onclick=e=>{e.target===d&&h(null)}})}showDualInputModalWithAbbrev(e,t,a="",n="",i,s="",r="",o=!0){return new Promise(l=>{const d=e=>e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):"",c=document.createElement("div");c.className="custom-modal-overlay",c.innerHTML=`\n        <div class="custom-modal" style="min-width: 450px;">\n          <div class="custom-modal-title">${d(e)}</div>\n          <div style="margin-bottom: 20px;">\n            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">\n              ${d(i)}\n            </label>\n            <input type="text" class="custom-modal-input" id="modal-input-2" value="${d(s)}" placeholder="${d(r||"Ingrese el nombre completo")}" autofocus>\n          </div>\n          <div style="margin-bottom: 16px;">\n            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">\n              ${d(t)}\n              ${o?'<span style="color: var(--info); font-size: 11px; font-weight: normal;"> (se sugiere automticamente)</span>':""}\n            </label>\n            <input type="text" class="custom-modal-input" id="modal-input-1" value="${d(a)}" placeholder="${d(n)}" style="text-transform: uppercase;">\n            ${n?`<small style="display: block; margin-top: 4px; color: var(--text-muted); font-size: 11px;">${d(n)}</small>`:""}\n          </div>\n          <div class="custom-modal-buttons">\n            <button class="custom-modal-btn custom-modal-btn-secondary" data-action="cancel">Cancelar</button>\n            <button class="custom-modal-btn custom-modal-btn-primary" data-action="accept">Guardar</button>\n          </div>\n        </div>\n      `,document.body.appendChild(c);const p=c.querySelector("#modal-input-1"),u=c.querySelector("#modal-input-2"),m=c.querySelector('[data-action="accept"]'),h=c.querySelector('[data-action="cancel"]');let g=!!a;o&&(u.addEventListener("input",()=>{if(!g){const e=this.generarAbreviatura(u.value);p.value=e}}),p.addEventListener("input",()=>{g=!0})),setTimeout(()=>{u.focus(),u.select()},100);const b=e=>{c.remove(),l(e)};m.onclick=()=>b({input1:p.value,input2:u.value}),h.onclick=()=>b(null),u.onkeydown=e=>{"Enter"===e.key&&(e.preventDefault(),p.focus(),p.select()),"Escape"===e.key&&b(null)},p.onkeydown=e=>{"Enter"===e.key&&b({input1:p.value,input2:u.value}),"Escape"===e.key&&b(null)},c.onclick=e=>{e.target===c&&b(null)}})}showConfirmModal(e){return new Promise(t=>{const a=document.createElement("div");var n;a.className="custom-modal-overlay",a.innerHTML=`\n        <div class="custom-modal">\n          <div class="custom-modal-title">Confirmar accin</div>\n          <div class="custom-modal-message">${(n=e,n?String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):"").replace(/\n/g,"<br>")}</div>\n          <div class="custom-modal-buttons">\n            <button class="custom-modal-btn custom-modal-btn-secondary" data-action="cancel">Cancelar</button>\n            <button class="custom-modal-btn custom-modal-btn-primary" data-action="accept">Aceptar</button>\n          </div>\n        </div>\n      `,document.body.appendChild(a);const i=a.querySelector('[data-action="accept"]'),s=a.querySelector('[data-action="cancel"]'),r=e=>{a.remove(),t(e)};i.onclick=()=>r(!0),s.onclick=()=>r(!1),document.addEventListener("keydown",function e(t){"Escape"===t.key&&(r(!1),document.removeEventListener("keydown",e))}),a.onclick=e=>{e.target===a&&r(!1)}})}};c.startConnectionMonitoring(),c.initUndoRedoKeyboardShortcuts();const p={inactivityTimer:null,inactivityDelay:6e4,hayCambiosPendientes:!1,backupEnProgreso:!1,ultimoBackupTimestamp:null,inactivityStartTime:null,countdownInterval:null,init(){["mousemove","mousedown","keypress","scroll","touchstart","click"].forEach(e=>{document.addEventListener(e,()=>this.reiniciarTimer(),{passive:!0})}),this.reiniciarTimer(),setInterval(()=>this.actualizarUI(),1e3),setTimeout(()=>this.actualizarUI(),1e3)},marcarCambiosPendientes(){this.hayCambiosPendientes=!0,this.actualizarUI()},reiniciarTimer(){this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.inactivityStartTime=Date.now(),this.inactivityTimer=setTimeout(()=>{this.ejecutarBackupSiNecesario()},this.inactivityDelay)},async ejecutarBackupSiNecesario(){if(this.hayCambiosPendientes){if(!this.backupEnProgreso)if(n.isFileSystemMode){this.backupEnProgreso=!0,this.mostrarBarraProgreso();try{await this.crearBackupConProgreso(),this.hayCambiosPendientes=!1,this.ultimoBackupTimestamp=Date.now(),this.actualizarProgreso(100),this.actualizarUI(),await new Promise(e=>setTimeout(e,800)),c.showToast(" Backup automtico creado","success",3e3)}catch(e){c.showToast(" Error creando backup automtico","error")}finally{this.backupEnProgreso=!1,this.ocultarBarraProgreso()}}else c&&c.showToast&&c.showToast(" FileSystem no conectado - Backup omitido","warning",3e3)}else c&&c.showToast&&c.showToast(" No hay cambios para respaldar","info",3e3)},async crearBackupConProgreso(){if(!u||"function"!=typeof u.crearBackupAutomatico)throw new Error("Funcin de backup no disponible");const e=setInterval(()=>{const e=document.getElementById("backupProgressFill");if(e){const t=parseFloat(e.style.width)||0;t<90&&this.actualizarProgreso(t+10)}},200);try{await u.crearBackupAutomatico()}finally{clearInterval(e)}},mostrarBarraProgreso(){const e=document.getElementById("backupProgressBar");e&&(e.style.display="block",this.actualizarProgreso(0))},ocultarBarraProgreso(){const e=document.getElementById("backupProgressBar");e&&setTimeout(()=>{e.style.display="none"},1e3)},actualizarProgreso(e){const t=document.getElementById("backupProgressFill"),a=document.getElementById("backupProgressPercent");t&&(t.style.width=`${e}%`),a&&(a.textContent=`${Math.round(e)}%`)},actualizarUI(){const e=document.getElementById("backupStatusIcon"),t=document.getElementById("backupStatusText"),a=document.getElementById("backupLastTime"),i=document.getElementById("backupNextTime"),s=document.getElementById("backupPendingChanges");if(!e||!t)return;if(!n.isFileSystemMode)return e.textContent="",t.textContent="Sistema desactivado (FileSystem no conectado)",t.style.color="var(--text-secondary)",a&&(a.textContent="---"),i&&(i.textContent="---"),void(s&&(s.style.display="none"));if(this.backupEnProgreso?(e.textContent="",t.textContent="Creando backup...",t.style.color="var(--info)"):this.hayCambiosPendientes?(e.textContent="",t.textContent="Cambios pendientes - Esperando inactividad",t.style.color="var(--warning)",s&&(s.style.display="block")):(e.textContent="",t.textContent="Sistema activo - Todo respaldado",t.style.color="var(--success)",s&&(s.style.display="none")),a)if(this.ultimoBackupTimestamp){const e=Math.floor((Date.now()-this.ultimoBackupTimestamp)/6e4);if(0===e)a.textContent="Hace menos de 1 min";else if(e<60)a.textContent=`Hace ${e} min`;else{const t=Math.floor(e/60);a.textContent=`Hace ${t}h ${e%60}min`}}else a.textContent="Sin backups an";const r=document.getElementById("backupCountdown");if(r)if(n.isFileSystemMode)if(this.backupEnProgreso)r.textContent="Creando...",r.style.color="var(--info)";else if(this.hayCambiosPendientes)if(this.inactivityStartTime){const e=Date.now()-this.inactivityStartTime,t=Math.max(0,this.inactivityDelay-e),a=Math.ceil(t/1e3);if(a<=0)r.textContent="0:00",r.style.color="var(--warning)";else{const e=Math.floor(a/60),t=a%60;r.textContent=`${e}:${t.toString().padStart(2,"0")}`,r.style.color=a<=10?"var(--error)":a<=30?"var(--warning)":"var(--success)"}}else r.textContent="1:00",r.style.color="var(--text-primary)";else r.textContent="Sin cambios",r.style.color="var(--text-secondary)";else r.textContent="---",r.style.color="var(--text-secondary)";i&&(this.hayCambiosPendientes?(i.textContent="En inactividad (1 min)",i.style.color="var(--warning)"):(i.textContent="Al detectar cambios",i.style.color="var(--text-primary)"))}},u={renderStorageUI(){const e=document.getElementById("storage-config-content");c.isMobile;if(c.hasFileSystemAPI){const t="enabled"===localStorage.getItem("fsDirectory");e.innerHTML=`\n        <h3 style="color: var(--text-primary); margin-bottom: 16px; font-size: 1.1rem; font-weight: 600;">Almacenamiento</h3>\n        \n        <div style="display: grid; gap: 12px;">\n          <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">\n            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">\n              <strong style="color: var(--text-primary); font-size: 0.95rem;">Estado:</strong>\n              <span id="config-fs-status" style="padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">\n                ${n.isFileSystemMode?" Conectado":" No conectado"}\n              </span>\n            </div>\n            <div id="config-fs-path" style="color: var(--text-secondary); font-size: 0.85rem; font-family: monospace; padding: 10px; background: rgba(0,0,0,0.15); border-radius: 6px; min-height: 40px;">\n              ${n.folderPath||(t?"Carpeta guardada (click Conectar)":"Sistema no configurado")}\n            </div>\n          </div>\n          \n          ${t&&!n.isFileSystemMode?'\n            \x3c!-- Botn Conectar cuando hay carpeta guardada pero no est conectado --\x3e\n            <button onclick="configuracion.conectarRapido()" class="btn btn-success" style="width: 100%; padding: 14px; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;">\n              <span style="font-size: 1.2rem;"></span>\n              <span>Conectar</span>\n            </button>\n          ':""}\n          \n          ${n.isFileSystemMode?'\n            \x3c!-- Botn Desconectar cuando est conectado --\x3e\n            <button onclick="configuracion.desconectar()" class="btn" style="width: 100%; padding: 14px; font-size: 1rem; background: var(--danger); color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">\n              <span style="font-size: 1.2rem;"></span>\n              <span>Desconectar</span>\n            </button>\n          ':""}\n          \n          \x3c!-- Botn Cambiar Carpeta (siempre visible) --\x3e\n          <button onclick="configuracion.seleccionarCarpetaTrabajo()" class="btn ${n.isFileSystemMode?"btn-secondary":"btn-primary"}" style="width: 100%; padding: ${n.isFileSystemMode?"12px":"14px"}; font-size: ${n.isFileSystemMode?"0.9rem":"1rem"};">\n            ${n.isFileSystemMode?" Cambiar Carpeta":" Seleccionar Carpeta"}\n          </button>\n          \n          ${n.isFileSystemMode?'\n            <button onclick="configuracion.vincularImagenesAutomaticamente()" class="btn btn-success" style="width: 100%; padding: 12px; font-size: 0.95rem;">\n               Vincular Imgenes\n            </button>\n          ':""}\n        </div>\n      `}else e.innerHTML='\n        <h3 style="color: var(--text-primary); margin-bottom: 16px; font-size: 1.1rem; font-weight: 600;">Almacenamiento Mvil</h3>\n        \n        <div style="display: grid; gap: 12px;">\n          <div id="mobile-storage-stats" style="background: var(--bg-primary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">\n            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">\n              <strong style="color: var(--text-primary); font-size: 0.95rem;">Almacenamiento:</strong>\n              <span id="mobile-storage-size" style="padding: 6px 12px; background: var(--primary); color: white; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">\n                0 MB\n              </span>\n            </div>\n            <div style="display: flex; justify-content: space-between; color: var(--text-secondary); font-size: 0.85rem;">\n              <span>Imgenes:</span>\n              <strong id="mobile-storage-count" style="color: var(--primary);">0</strong>\n            </div>\n          </div>\n          \n          <button onclick="configuracion.actualizarEstadisticasMovil()" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 0.95rem;">\n            Actualizar Estadsticas\n          </button>\n          \n          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">\n            <button onclick="configuracion.exportarJSONConImagenesMovil()" class="btn btn-success" style="padding: 12px; font-size: 0.85rem;">\n              Exportar\n            </button>\n            <button onclick="configuracion.importarJSONConImagenesMovil()" class="btn btn-primary" style="padding: 12px; font-size: 0.85rem;">\n              Importar\n            </button>\n          </div>\n          \n          <button onclick="configuracion.limpiarCacheMovil()" class="btn" style="width: 100%; padding: 12px; font-size: 0.9rem; background: var(--danger); color: white;">\n            Limpiar Imgenes\n          </button>\n        </div>\n      ',setTimeout(()=>this.actualizarEstadisticasMovil(),500)},async actualizarEstadisticasMovil(){try{const e=await i.getStorageStats();document.getElementById("mobile-storage-size").textContent=e.sizeFormatted,document.getElementById("mobile-storage-count").textContent=e.count}catch(e){}},async limpiarCacheMovil(){if(confirm(" ADVERTENCIA\n\nEsto eliminar TODAS las imgenes almacenadas en IndexedDB.\nLos datos del inventario (nombres, cdigos, etc.) NO se eliminarn.\n\nEsts seguro de continuar?"))try{await i.clearAll(),await this.actualizarEstadisticasMovil(),c.showToast(" Todas las imgenes eliminadas","success"),await c.loadData(),await c.render()}catch(e){c.showToast(" Error al limpiar cach","error")}},async exportarJSONConImagenesMovil(){try{const t={version:"2.5-mobile",exportDate:(new Date).toISOString(),platform:c.isMobile?"mobile":"desktop",storageMode:c.storageMode,repuestos:[]};for(const l of c.repuestos){const a={...l};if(l.multimedia&&l.multimedia.length>0){const t=[];for(const a of l.multimedia)if("image"===a.type)if(a.isIndexedDB&&a.url.startsWith("img_"))try{const e=await i.getImage(a.url);if(e&&e.url){const n=await fetch(e.url),i=await n.blob(),s=await this.blobToBase64(i);t.push({type:"image",url:s,name:a.name,size:a.size})}}catch(e){}else"string"==typeof a.url&&a.url.startsWith("data:image")?t.push(a):a.isFileSystem;a.multimedia=t}t.repuestos.push(a)}const a=JSON.stringify(t,null,2),n=new Blob([a],{type:"application/json"}),s=(n.size/1048576).toFixed(2),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.download=`inventario_movil_${(new Date).toISOString().split("T")[0]}.json`,o.click(),URL.revokeObjectURL(r),c.showToast(` Inventario exportado (${s}MB) con imgenes`,"success")}catch(t){c.showToast(" Error al exportar: "+t.message,"error")}},async importarJSONConImagenesMovil(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async e=>{const t=e.target.files[0];if(t)try{const e=await t.text(),a=JSON.parse(e);if(!a.repuestos||!Array.isArray(a.repuestos))throw new Error("Formato de JSON invlido");const n=this.getICloudPath();for(const t of a.repuestos)if(t.multimedia&&t.multimedia.length>0){const e=[];for(const a of t.multimedia)if("image"===a.type){let s=null,r=a.name||"imagen.webp";if(a.url&&a.url.startsWith("data:image"))s=await this.base64ToBlob(a.url);else if(n&&a.name)continue;if(s){const a=`img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;await i.saveImage(a,t.id,s),e.push({type:"image",url:a,name:r,size:s.size,isIndexedDB:!0})}}t.multimedia=e}c.repuestos=a.repuestos,localStorage.setItem("repuestos",JSON.stringify(c.repuestos)),await c.loadData(),await c.render(),await this.actualizarEstadisticasMovil(),c.showToast(` ${a.repuestos.length} repuestos importados`,"success")}catch(a){c.showToast(" Error al importar: "+a.message,"error")}},e.click()},blobToBase64:e=>new Promise((t,a)=>{const n=new FileReader;n.onloadend=()=>t(n.result),n.onerror=a,n.readAsDataURL(e)}),base64ToBlob:e=>new Promise(t=>{fetch(e).then(e=>e.blob()).then(e=>t(e))}),async conectarRapido(){try{await c.connectWorkspace(!0,!1),this.renderStorageUI()}catch(e){c.showToast(' Error al conectar. Intenta "Cambiar Carpeta".',"error")}},async desconectar(){if(confirm("Desconectar carpeta INVENTARIO_STORAGE?\n\nLos datos no se perdern, pero debers reconectar para continuar trabajando."))try{n.isFileSystemMode=!1,n.directoryHandle=null,n.imagesFolder=null,n.folderPath="",o&&(o.initialized=!1,o.isConnected=!1),c.updateAllConnectionBadges(!1),this.renderStorageUI(),c.showToast(" Desconectado - Datos guardados","info")}catch(e){c.showToast(" Error al desconectar","error")}},async seleccionarCarpetaTrabajo(){try{await c.connectWorkspace(!1,!0)}catch(e){c.showToast(" Error al seleccionar carpeta","error")}},actualizarEstadoUI(){this.renderStorageUI()},async exportarJSON(){if(n.isFileSystemMode)try{await c.exportarJSON(),c.showToast(" JSON exportado correctamente a la carpeta","success")}catch(e){c.showToast(" Error al exportar JSON","error")}else c.showToast(" Primero debes seleccionar una carpeta","warning")},async exportarExcel(){try{await c.exportarExcel(),c.showToast(" Excel exportado a Descargas","success")}catch(e){c.showToast(" Error al exportar Excel","error")}},async exportarJSONLigero(){try{const e=c.repuestos.map(e=>{const{multimedia:t,...a}=e;return a}),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download=`inventario_sin_imagenes_${(new Date).toISOString().split("T")[0]}.json`,n.click(),URL.revokeObjectURL(a),c.showToast(" JSON ligero exportado a Descargas","success")}catch(e){c.showToast(" Error al exportar JSON ligero","error")}},async importarJSONFusion(){if(n.isFileSystemMode)try{await c.importarJSON(),c.showToast(" Datos fusionados correctamente","success")}catch(e){c.showToast(" Error al importar JSON","error")}else c.showToast(" Primero debes seleccionar una carpeta","warning")},async importarArchivoExterno(){if(!confirm(" ADVERTENCIA\n\nEsta accin REEMPLAZAR completamente el inventario actual.\nSe perdern todos los datos y multimedia actuales.\n\nEsts seguro de continuar?"))return;const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async e=>{const t=e.target.files[0];if(t)try{const e=await t.text(),a=JSON.parse(e);if(!Array.isArray(a))throw new Error("El archivo no contiene un array vlido");c.repuestos=a.map((e,t)=>(e.id||(e.id=`repuesto-${Date.now()}-${t}`),e.multimedia&&Array.isArray(e.multimedia)||(e.multimedia=[]),e)),await c.saveData(),await c.render(),c.renderFilters(),c.updateAutocompleteData(),c.showToast(` ${a.length} repuestos importados correctamente`,"success")}catch(a){c.showToast(" Error al importar archivo: "+a.message,"error")}},e.click()},async convertirImagenesWebP(){if(!n.isFileSystemMode||!n.imagesFolder)return void c.showToast(" Primero debes seleccionar una carpeta","warning");if(confirm(" CONVERSIN A WEBP\n\nSe convertirn todas las imgenes JPG/PNG a formato WebP.\nLos archivos originales se ELIMINARN despus de la conversin.\n\nDeseas continuar?"))try{const t=document.getElementById("conversion-status"),a=document.getElementById("conversion-progress"),i=document.getElementById("conversion-bar");t.style.display="block";const s=[];for await(const e of n.imagesFolder.values())if("file"===e.kind){const t=e.name.toLowerCase();(t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".png"))&&s.push(e)}if(0===s.length)return c.showToast(" No se encontraron imgenes JPG/PNG para convertir","info"),void(t.style.display="none");a.textContent=`0 / ${s.length}`;let r=0;for(const o of s)try{const e=await o.getFile(),t=new Image,l=await e,d=URL.createObjectURL(l);await new Promise((e,a)=>{t.onload=e,t.onerror=a,t.src=d});const p=document.createElement("canvas");p.width=t.width,p.height=t.height;p.getContext("2d").drawImage(t,0,0);const u=await new Promise(e=>{p.toBlob(e,"image/webp",.85)});URL.revokeObjectURL(d);const m=e.name.replace(/\.(jpg|jpeg|png)$/i,".webp"),h=await n.imagesFolder.getFileHandle(m,{create:!0}),g=await h.createWritable();await g.write(u),await g.close(),await n.imagesFolder.removeEntry(e.name),c.repuestos.forEach(t=>{t.multimedia&&Array.isArray(t.multimedia)&&t.multimedia.forEach(t=>{t.url&&t.url.includes(e.name)&&(t.url=t.url.replace(/\.(jpg|jpeg|png)$/i,".webp"),t.name=t.name?t.name.replace(/\.(jpg|jpeg|png)$/i,".webp"):m)})}),r++,a.textContent=`${r} / ${s.length}`,i.style.width=r/s.length*100+"%"}catch(e){}await c.saveData(),c.showToast(` ${r} imgenes convertidas a WebP`,"success"),setTimeout(()=>{t.style.display="none",i.style.width="0%"},3e3)}catch(e){c.showToast(" Error durante la conversin","error")}},async verEstadisticasAlmacenamiento(){if(n.isFileSystemMode&&n.imagesFolder)try{let e=0,t=0;const a={};for await(const c of n.imagesFolder.values())if("file"===c.kind){e++;const n=await c.getFile();t+=n.size;const i=n.name.split(".").pop().toLowerCase();a[i]=(a[i]||0)+1}const i=(t/1048576).toFixed(2);let s=localStorage.getItem("fsFolderName")||"INVENTARIO_PORTABLE";s.includes("INVENTARIO_STORAGE")&&(s=s.split("/")[0].split("\\")[0]);const r=` Carpeta base: ${s}`,o=` Storage: ${s}/INVENTARIO_STORAGE`,l=` Imgenes: ${s}/INVENTARIO_STORAGE/imagenes/`,d=` JSON: ${s}/INVENTARIO_STORAGE/inventario.json`,p=localStorage.getItem("inventarioData");let u=0,m=0;if(p){u=(new Blob([p]).size/1048576).toFixed(2);JSON.parse(p).forEach(e=>{e.multimedia&&e.multimedia.length>0&&e.multimedia.forEach(e=>{e.url&&e.url.startsWith("data:image")&&m++})})}let h=" ESTADSTICAS DE ALMACENAMIENTO\n\n";h+="\n",h+=" RUTAS ACTIVAS:\n",h+="\n",h+=`${r}\n`,h+=`${o}\n`,h+=`${l}\n`,h+=`${d}\n\n`,h+="\n",h+=" IMGENES EN FILESYSTEM:\n",h+="\n",h+=` Total de archivos: ${e}\n`,h+=` Espacio ocupado: ${i} MB\n`,h+=" Sin lmites de almacenamiento\n\n",h+=" Por formato:\n";for(const[n,c]of Object.entries(a))h+=`   ${n.toUpperCase()}: ${c} archivos\n`;h+="\n\n",h+=" REPUESTOS:\n",h+="\n",h+=` Con imgenes: ${c.repuestos.filter(e=>e.multimedia&&e.multimedia.length>0).length}\n`,h+=` Sin imgenes: ${c.repuestos.filter(e=>!e.multimedia||0===e.multimedia.length).length}\n`,h+=` Total: ${c.repuestos.length}\n\n`,h+="\n",h+=" LOCALSTORAGE (Solo datos):\n",h+="\n",h+=` Tamao: ${u} MB\n`,h+=` Imgenes base64 obsoletas: ${m}\n`,h+=(0===m?" LIMPIO - Solo guarda nombres/precios/cantidades":' Usar botn "Limpiar Imgenes localStorage"')+"\n\n",h+="\n",h+=" RESUMEN:\n",h+="\n",h+=` Todas las referencias desde: ${s}\n`,h+=" Imgenes: FileSystem (sin lmites)\n",h+=" Datos: JSON + localStorage (backup)\n",h+=" Sin referencias externas\n";let g=`\n        \x3c!-- Seccin Rutas --\x3e\n        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--primary);">\n          <h3 style="margin: 0 0 16px 0; color: var(--primary); display: flex; align-items: center; gap: 10px; font-size: 1.3rem;">\n            <span style="font-size: 1.5rem;"></span>\n            <span>Rutas Activas</span>\n          </h3>\n          <div style="display: grid; gap: 12px; font-size: 0.9rem;">\n            \n            \x3c!-- Carpeta Base --\x3e\n            <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--primary);">\n              <div style="display: flex; align-items: start; gap: 12px;">\n                <span style="font-size: 1.8rem;"></span>\n                <div style="flex: 1;">\n                  <strong style="color: var(--primary); font-size: 1.05rem;">Carpeta Base</strong>\n                  <div style="font-family: 'Courier New', monospace; color: var(--text-primary); margin: 6px 0; background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 4px;">\n                    ${s}\n                  </div>\n                  <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; margin-top: 8px;">\n                     <strong>Carpeta principal del proyecto.</strong> Contiene el archivo HTML de la aplicacin y la carpeta INVENTARIO_STORAGE. Es portable: puedes copiarla a cualquier ubicacin (PC, USB, disco externo).\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- Storage --\x3e\n            <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--info);">\n              <div style="display: flex; align-items: start; gap: 12px;">\n                <span style="font-size: 1.8rem;"></span>\n                <div style="flex: 1;">\n                  <strong style="color: var(--info); font-size: 1.05rem;">Carpeta Storage</strong>\n                  <div style="font-family: 'Courier New', monospace; color: var(--text-primary); margin: 6px 0; background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 4px;">\n                    ${s}/INVENTARIO_STORAGE\n                  </div>\n                  <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; margin-top: 8px;">\n                     <strong>Almacenamiento central de datos.</strong> Contiene el archivo JSON con toda la informacin de repuestos (nombres, precios, cantidades, etc.) y la carpeta de imgenes. Se crea automticamente al seleccionar la carpeta base.\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- Imgenes --\x3e\n            <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--success);">\n              <div style="display: flex; align-items: start; gap: 12px;">\n                <span style="font-size: 1.8rem;"></span>\n                <div style="flex: 1;">\n                  <strong style="color: var(--success); font-size: 1.05rem;">Carpeta Imgenes</strong>\n                  <div style="font-family: 'Courier New', monospace; color: var(--text-primary); margin: 6px 0; background: rgba(16, 185, 129, 0.1); padding: 8px 12px; border-radius: 4px;">\n                    ${s}/INVENTARIO_STORAGE/imagenes/\n                  </div>\n                  <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; margin-top: 8px;">\n                     <strong>Todas las fotos de repuestos.</strong> Almacenamiento ilimitado usando FileSystem Access API. Las imgenes se guardan como archivos fsicos (JPG, PNG, WebP). El sistema solo guarda las rutas en el JSON, no las imgenes en base64.\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- JSON --\x3e\n            <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--warning);">\n              <div style="display: flex; align-items: start; gap: 12px;">\n                <span style="font-size: 1.8rem;"></span>\n                <div style="flex: 1;">\n                  <strong style="color: var(--warning); font-size: 1.05rem;">Archivo JSON Principal</strong>\n                  <div style="font-family: 'Courier New', monospace; color: var(--text-primary); margin: 6px 0; background: rgba(245, 158, 11, 0.1); padding: 8px 12px; border-radius: 4px;">\n                    ${s}/INVENTARIO_STORAGE/inventario.json\n                  </div>\n                  <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; margin-top: 8px;">\n                     <strong>Base de datos completa del inventario.</strong> Contiene: nombres, cdigos SAP, categoras, reas, equipos, cantidades, stock mnimo, precios, historial de conteos y rutas a las imgenes. Se actualiza automticamente cada vez que guardas cambios.\n                  </div>\n                </div>\n              </div>\n            </div>\n\n          </div>\n        </div>\n\n        \x3c!-- Grid 2 columnas --\x3e\n        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">\n          \n          \x3c!-- Imgenes FileSystem --\x3e\n          <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); padding: 20px; border-radius: 12px; border: 2px solid var(--success);">\n            <h3 style="margin: 0 0 16px 0; color: var(--success); display: flex; align-items: center; gap: 10px; font-size: 1.2rem;">\n              <span style="font-size: 1.4rem;"></span>\n              <span>Imgenes FileSystem</span>\n            </h3>\n            \n            <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; margin-bottom: 14px;">\n              <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6;">\n                 <strong>Almacenamiento ilimitado.</strong> Las imgenes se guardan como archivos fsicos en tu disco. No hay lmites de tamao o cantidad. Solo se guardan las rutas en el JSON.\n              </div>\n            </div>\n            \n            <div style="display: grid; gap: 12px;">\n              <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px;">\n                <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${e}</div>\n                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">Total de archivos</div>\n                <div style="font-size: 0.75rem; color: var(--success); font-weight: 600;"> Sin lmites</div>\n              </div>\n              \n              <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px;">\n                <div style="font-size: 2rem; font-weight: 700; color: var(--info);">${i} MB</div>\n                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">Espacio ocupado</div>\n                <div style="font-size: 0.75rem; color: var(--info);">Archivos fsicos en disco</div>\n              </div>\n              \n              <div style="background: linear-gradient(135deg, var(--success), #059669); color: white; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 0.95rem;">\n                <div style="font-size: 1.5rem; margin-bottom: 4px;"></div>\n                <div>Capacidad ilimitada</div>\n                <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 4px;">FileSystem Access API</div>\n              </div>\n            </div>\n            \n            ${Object.keys(a).length>0?`\n            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">\n              <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">Por formato:</div>\n              <div style="display: grid; gap: 8px;">\n                ${Object.entries(a).map(([e,t])=>`\n                  <div style="display: flex; justify-content: space-between; background: var(--bg-primary); padding: 8px 12px; border-radius: 6px;">\n                    <span style="color: var(--text-primary); font-weight: 500;">${e.toUpperCase()}</span>\n                    <span style="color: var(--success); font-weight: 700;">${t} archivos</span>\n                  </div>\n                `).join("")}\n              </div>\n            </div>\n            `:""}\n          </div>\n\n          \x3c!-- Repuestos --\x3e\n          <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1)); padding: 20px; border-radius: 12px; border: 2px solid var(--secondary);">\n            <h3 style="margin: 0 0 16px 0; color: var(--secondary); display: flex; align-items: center; gap: 10px; font-size: 1.2rem;">\n              <span style="font-size: 1.4rem;"></span>\n              <span>Repuestos en Inventario</span>\n            </h3>\n            \n            <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; margin-bottom: 14px;">\n              <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6;">\n                 <strong>Productos registrados en el sistema.</strong> Cada repuesto tiene: nombre, cdigo SAP, categora, rea, equipo, cantidad actual, stock mnimo, precio e historial de conteos.\n              </div>\n            </div>\n            \n            <div style="display: grid; gap: 12px;">\n              <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px;">\n                <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${c.repuestos.filter(e=>e.multimedia&&e.multimedia.length>0).length}</div>\n                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;"> Con imgenes</div>\n                <div style="font-size: 0.75rem; color: var(--success);">Totalmente identificados</div>\n              </div>\n              \n              <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px;">\n                <div style="font-size: 2rem; font-weight: 700; color: ${c.repuestos.filter(e=>!e.multimedia||0===e.multimedia.length).length>0?"var(--warning)":"var(--success)"};">${c.repuestos.filter(e=>!e.multimedia||0===e.multimedia.length).length}</div>\n                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;"> Sin imgenes</div>\n                ${c.repuestos.filter(e=>!e.multimedia||0===e.multimedia.length).length>0?'\n                  <div style="font-size: 0.75rem; color: var(--warning);">Pendientes de fotografiar</div>\n                ':'\n                  <div style="font-size: 0.75rem; color: var(--success);">Todos tienen fotos</div>\n                '}\n              </div>\n              \n              <div style="background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; padding: 14px; border-radius: 8px; text-align: center;">\n                <div style="font-size: 2rem; font-weight: 700;">${c.repuestos.length}</div>\n                <div style="font-size: 0.85rem; margin-bottom: 4px;"> Total registrados</div>\n                <div style="font-size: 0.75rem; opacity: 0.9;">En inventario completo</div>\n              </div>\n              \n              ${c.repuestos.filter(e=>!e.multimedia||0===e.multimedia.length).length>0?'\n                <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid var(--warning);">\n                  <div style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5;">\n                     <strong>Tip:</strong> Usa el botn <strong>"Vincular Imgenes de la Carpeta"</strong> en Configuracin para asociar automticamente las fotos con los repuestos.\n                  </div>\n                </div>\n              ':""}\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- localStorage --\x3e\n        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid ${0===m?"var(--success)":"var(--warning)"};">\n          <h3 style="margin: 0 0 16px 0; color: ${0===m?"var(--success)":"var(--warning)"}; display: flex; align-items: center; gap: 10px; font-size: 1.2rem;">\n            <span style="font-size: 1.4rem;"></span>\n            <span>localStorage (Backup del navegador)</span>\n          </h3>\n          \n          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">\n            <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">\n               <strong>Copia de seguridad automtica en el navegador.</strong> Guarda una copia de los datos (nombres, cdigos, precios, cantidades) como respaldo. Lmite: 5-10 MB. <strong>NO debe contener imgenes</strong> para evitar saturar el espacio.\n            </div>\n          </div>\n          \n          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">\n            <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; text-align: center;">\n              <div style="font-size: 1.8rem; font-weight: 700; color: var(--info);">${u} MB</div>\n              <div style="font-size: 0.85rem; color: var(--text-secondary);">Tamao usado</div>\n              <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">Lmite: ~10 MB</div>\n            </div>\n            \n            <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; text-align: center;">\n              <div style="font-size: 1.8rem; font-weight: 700; color: ${0===m?"var(--success)":"var(--danger)"};">${m}</div>\n              <div style="font-size: 0.85rem; color: var(--text-secondary);">Imgenes base64</div>\n              <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">Debe ser: 0</div>\n            </div>\n            \n            <div style="background: ${0===m?"var(--success)":"var(--warning)"}; color: white; padding: 14px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 600; font-size: 0.95rem;">\n              <div style="font-size: 1.8rem; margin-bottom: 6px;"></div>\n              <div>${0===m?"LIMPIO":"Necesita limpieza"}</div>\n            </div>\n          </div>\n          \n          ${0===m?'\n            <div style="margin-top: 12px; padding: 14px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid var(--success);">\n              <div style="color: var(--success); font-weight: 600; margin-bottom: 6px;"> Estado ptimo</div>\n              <div style="color: var(--text-secondary); font-size: 0.85rem;">\n                Solo contiene datos esenciales (nombres, precios, cantidades). Las imgenes se cargan desde FileSystem, dejando el localStorage libre para su funcin de backup.\n              </div>\n            </div>\n          ':`\n            <div style="margin-top: 12px; padding: 14px; background: rgba(199, 83, 0, 0.15); border-radius: 8px; border-left: 4px solid #C75300;">\n              <div style="color: #C75300; font-weight: 600; margin-bottom: 6px;"> Requiere limpieza</div>\n              <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 8px;">\n                Contiene ${m} imgenes base64 obsoletas que ocupan espacio innecesario.\n              </div>\n              <div style="background: #334155; padding: 10px; border-radius: 6px; font-size: 0.85rem; color: #cbd5e1; border: 1px solid #475569;">\n                <strong style="color: #e2e8f0;"> Solucin:</strong> Ve a <strong style="color: #C75300;">Configuracin  Herramientas Adicionales  Limpiar Imgenes localStorage</strong>\n              </div>\n            </div>\n          `}\n        </div>\n\n        \x3c!-- Resumen Final --\x3e\n        <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 24px; border-radius: 12px; text-align: center;">\n          <h3 style="margin: 0 0 16px 0; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; gap: 10px;">\n            <span style="font-size: 1.6rem;"></span>\n            <span>Resumen</span>\n          </h3>\n          \n          <div style="display: grid; gap: 10px; text-align: left; font-size: 1rem;">\n            <div style="display: flex; align-items: center; gap: 10px;">\n              <span style="font-size: 1.4rem;"></span>\n              <span>Todas las referencias desde: <strong>${s}</strong></span>\n            </div>\n            <div style="display: flex; align-items: center; gap: 10px;">\n              <span style="font-size: 1.4rem;"></span>\n              <span>Imgenes: <strong>FileSystem (sin lmites)</strong></span>\n            </div>\n            <div style="display: flex; align-items: center; gap: 10px;">\n              <span style="font-size: 1.4rem;"></span>\n              <span>Datos: <strong>JSON + localStorage (backup)</strong></span>\n            </div>\n            <div style="display: flex; align-items: center; gap: 10px;">\n              <span style="font-size: 1.4rem;"></span>\n              <span>Sin referencias externas</span>\n            </div>\n          </div>\n        </div>\n      `;document.getElementById("estadisticasContent").innerHTML=g,document.getElementById("modalEstadisticas").style.display="block"}catch(e){c.showToast(" Error al obtener estadsticas","error")}else c.showToast(" Primero debes seleccionar una carpeta","warning")},async limpiarCacheTemporal(){if(confirm(" LIMPIAR CACH\n\nSe eliminarn los datos temporales y cach del navegador.\nLos datos del inventario NO se vern afectados.\n\nContinuar?"))try{const e=localStorage.getItem("inventarioData"),t=localStorage.getItem("fsDirectory"),a=localStorage.getItem("fsFolderName");localStorage.clear(),e&&localStorage.setItem("inventarioData",e),t&&localStorage.setItem("fsDirectory",t),a&&localStorage.setItem("fsFolderName",a),c.showToast(" Cach limpiado correctamente","success")}catch(e){c.showToast(" Error al limpiar cach","error")}},async limpiarImagenesLocalStorage(){if(confirm(" LIMPIAR IMGENES DE LOCALSTORAGE\n\nSe eliminarn todas las imgenes base64 almacenadas en localStorage.\nEsto liberar espacio y evitar conflictos.\n\n Los datos de repuestos NO se borrarn (nombres, precios, cantidades)\n Las imgenes de FileSystem NO se vern afectadas\n\nContinuar?"))try{const e=localStorage.getItem("inventarioData");if(!e)return void c.showToast(" No hay datos en localStorage","info");const t=JSON.parse(e);let a=0,n=new Blob([e]).size/1024;t.forEach(e=>{if(e.multimedia&&e.multimedia.length>0){const t=e.multimedia.filter(e=>{const t=e.url&&e.url.startsWith("data:image");return t&&a++,!t});e.multimedia=t}});const i=JSON.stringify(t);localStorage.setItem("inventarioData",i);const s=new Blob([i]).size/1024,r=n-s,o=` Limpieza completada:\n\n ${a} imgenes base64 eliminadas\n Tamao anterior: ${n.toFixed(2)} KB\n Tamao actual: ${s.toFixed(2)} KB\n Espacio liberado: ${r.toFixed(2)} KB\n\n Ahora solo se usan imgenes de FileSystem (sin lmites)`;alert(o),c.showToast(` ${a} imgenes eliminadas - ${r.toFixed(0)} KB liberados`,"success")}catch(e){c.showToast(" Error al limpiar localStorage: "+e.message,"error")}},async vincularImagenesAutomaticamente(){if(!n.isFileSystemMode||!n.imagesFolder)return void c.showToast(" Primero debes seleccionar una carpeta","warning");if(confirm(" REPARAR Y VINCULAR IMGENES\n\nEsta funcin har lo siguiente:\n\n Detectar imgenes rotas (archivos que ya no existen)\n Buscar reemplazos automticos por nombre\n Vincular repuestos sin imgenes\n Usa timestamps para encontrar las versiones ms recientes\n\n INTELIGENTE: Busca coincidencias por nombre del repuesto\n\nContinuar?"))try{c.showToast(" Reparando y vinculando imgenes...","info"),await c.repararImagenesRotas()}catch(e){c.showToast(" Error: "+e.message,"error")}},async exportarHTMLConDatosEmbebidos(){try{const e=c.repuestos.map(e=>{const{multimedia:t,...a}=e;return a}),t=await fetch(window.location.href);let a=await t.text();const n=`const EMBEDDED_DATA = {\n  version: '1.0-mobile',\n  lastUpdate: '${(new Date).toISOString()}',\n  platform: 'mobile-embedded',\n  note: 'Datos sin multimedia - Solo texto y nmeros para mxima compatibilidad',\n  repuestos: ${JSON.stringify(e,null,2)}\n};`,i=/const EMBEDDED_DATA = \{[\s\S]*?\};/;if(!i.test(a))return void c.showToast(" Error: No se encontr EMBEDDED_DATA","error");a=a.replace(i,n);const s=new Blob([a],{type:"text/html;charset=utf-8"}),r=(s.size/1048576).toFixed(2),o=URL.createObjectURL(s),l=document.createElement("a");l.href=o,l.download=`inventario_MOVIL_${(new Date).toISOString().split("T")[0]}.html`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(o);const d=` HTML para mvil exportado:\n\n ${e.length} repuestos incluidos\n Tamao: ${r} MB\n Fecha: ${(new Date).toLocaleString("es-ES")}\n\n Para sincronizar:\n1. Copia este HTML al mvil\n2. brelo en Edge iOS\n3. Listo! Vers todos los datos actualizados\n\n Las fotos NO se incluyen (solo datos)`;alert(d),c.showToast(` HTML mvil exportado: ${e.length} repuestos`,"success")}catch(e){c.showToast(" Error al exportar HTML: "+e.message,"error")}},saveICloudPath(e){if(!e||""===e.trim())return void c.showToast(" Por favor ingresa un nombre de carpeta","warning");const t=e.trim();localStorage.setItem("icloudImagePath",t);const a=document.getElementById("icloud-path-status");a&&(a.style.display="block",a.style.background="rgba(16, 185, 129, 0.1)",a.style.borderLeft="4px solid var(--success)",a.style.color="var(--success)",a.innerHTML=`\n        <strong> Ruta guardada:</strong><br>\n        <code style="background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;">\n          iCloud Drive/${t}/\n        </code>\n      `,setTimeout(()=>{a.style.display="none"},5e3)),c.showToast(` Ruta iCloud guardada: ${t}`,"success")},clearICloudPath(){localStorage.removeItem("icloudImagePath");const e=document.getElementById("icloudImagePath");e&&(e.value="");const t=document.getElementById("icloud-path-status");t&&(t.style.display="block",t.style.background="rgba(220, 38, 38, 0.1)",t.style.borderLeft="4px solid var(--danger)",t.style.color="var(--danger)",t.innerHTML="<strong> Ruta eliminada</strong>",setTimeout(()=>{t.style.display="none"},3e3)),c.showToast(" Ruta iCloud eliminada","info")},getICloudPath:()=>localStorage.getItem("icloudImagePath")||null,loadICloudPathConfig(){const e=this.getICloudPath(),t=document.getElementById("icloudImagePath");t&&e&&(t.value=e)},async crearBackupAutomatico(){if(!n.isFileSystemMode||!n.directoryHandle)return null;try{const i=await n.directoryHandle.getDirectoryHandle("backups",{create:!0}),s=await i.getDirectoryHandle("automaticos",{create:!0}),r=[];for await(const t of s.values())if("directory"===t.kind&&t.name.startsWith("backup_"))try{const e=await t.getDirectoryHandle().then(e=>e.getFileHandle("datos.json",{create:!1})),a=await e.getFile();r.push({name:t.name,handle:t,timestamp:a.lastModified})}catch(e){r.push({name:t.name,handle:t,timestamp:0})}for(r.sort((e,t)=>e.timestamp-t.timestamp);r.length>=5;){const t=r.shift();try{await s.removeEntry(t.name,{recursive:!0})}catch(e){}}const l=new Date,d=l.getFullYear(),p=String(l.getMonth()+1).padStart(2,"0"),u=String(l.getDate()).padStart(2,"0"),m=String(l.getHours()).padStart(2,"0"),h=String(l.getMinutes()).padStart(2,"0"),g=String(l.getSeconds()).padStart(2,"0"),b=`backup_${`${d}-${p}-${u}_${m}-${h}-${g}`}`,v=await s.getDirectoryHandle(b,{create:!0});let y=[],f=[],x=0,S=0;if(o&&o.initialized)try{y=await o.getMaps(),f=await o.getAreas(),x=y.length,S=f.length}catch(t){}let w=0;c.repuestos.forEach(e=>{e.ubicaciones&&Array.isArray(e.ubicaciones)&&(w+=e.ubicaciones.length)});const A=new Set;c.repuestos.forEach(e=>{if(e.imagen){const t=e.imagen.split("/").pop();A.add(t)}e.multimedia&&Array.isArray(e.multimedia)&&e.multimedia.forEach(e=>{if(e.url){const t=e.url.split("/").pop();A.add(t)}})});const E=A.size,I={timestamp:(new Date).toISOString(),version:"5.3.2",tipo:"BACKUP_COMPLETO",estadisticas:{totalRepuestos:c.repuestos.length,totalMapas:x,totalAreas:S,totalUbicacionesEnMapas:w,totalImagenes:E},repuestos:c.repuestos,mapas:y,areas:f,metadata:{navegador:navigator.userAgent,plataforma:navigator.platform,idioma:navigator.language}},$=await v.getFileHandle("datos.json",{create:!0}),k=await $.createWritable();await k.write(JSON.stringify(I,null,2)),await k.close();let M=0;try{if(A.size>0){const e=await v.getDirectoryHandle("imagenes",{create:!0}),t=await n.directoryHandle.getDirectoryHandle("imagenes",{create:!1});for(const n of A)try{const a=await t.getFileHandle(n,{create:!1}),i=await a.getFile(),s=await e.getFileHandle(n,{create:!0}),r=await s.createWritable();await r.write(await i.arrayBuffer()),await r.close(),M++}catch(a){}}}catch(a){}return b}catch(t){return null}},async listarBackups(){var e;if(!n.isFileSystemMode||!n.directoryHandle)return c.showToast(" Primero debes seleccionar una carpeta","warning"),[];try{const a=await n.directoryHandle.getDirectoryHandle("backups",{create:!0}),i=await a.getDirectoryHandle("automaticos",{create:!0}),s=[];for await(const n of i.values())if("directory"===n.kind&&n.name.startsWith("backup_"))try{const t=await i.getDirectoryHandle(n.name),a=await t.getFileHandle("datos.json",{create:!1}),r=await a.getFile(),o=JSON.parse(await r.text()),l=o.estadisticas||{};s.push({name:n.name,handle:t,timestamp:r.lastModified,fecha:new Date(r.lastModified).toLocaleString("es-ES"),size:(r.size/1024).toFixed(2)+" KB",totalRepuestos:l.totalRepuestos||o.totalRepuestos||(null==(e=o.repuestos)?void 0:e.length)||0,totalMapas:l.totalMapas||0,totalAreas:l.totalAreas||0,totalUbicaciones:l.totalUbicacionesEnMapas||0,totalImagenes:l.totalImagenes||0,version:o.version||"N/A",tipo:o.tipo||"BACKUP"})}catch(t){}return s.sort((e,t)=>t.timestamp-e.timestamp),s}catch(a){return[]}},async restaurarBackup(e){var t;try{const i=e,s=await i.getFileHandle("datos.json",{create:!1}),r=await s.getFile(),d=JSON.parse(await r.text());let p=0;d.repuestos&&d.repuestos.forEach(e=>{if(e.ubicaciones&&Array.isArray(e.ubicaciones)){const t=e.ubicaciones.filter(e=>e.mapId&&void 0!==e.markerX&&void 0!==e.markerY);t.length,p+=t.length}});const u=d.estadisticas||{};if(!confirm(` RESTAURAR BACKUP COMPLETO\n\n Backup: ${e.name}\n Fecha: ${new Date(r.lastModified).toLocaleString("es-ES")}\n Repuestos: ${u.totalRepuestos||(null==(t=d.repuestos)?void 0:t.length)||0}\n Mapas: ${u.totalMapas||0}\n reas: ${u.totalAreas||0}\n Ubicaciones en mapas: ${u.totalUbicaciones||0}\n Imgenes: ${u.totalImagenes||0}\n Versin: ${d.version||"N/A"}\n\n Esto reemplazar TODOS los datos actuales (repuestos, mapas, reas, imgenes).\n\nContinuar con la restauracin completa?`))return;c.repuestos=d.repuestos||[];let m=0;c.repuestos.forEach(e=>{if(e.ubicaciones&&Array.isArray(e.ubicaciones)){const t=e.ubicaciones.filter(e=>e.mapId&&void 0!==e.markerX&&void 0!==e.markerY);t.length,m+=t.length}}),await c.saveData();let h=0;c.repuestos.forEach(e=>{if(e.ubicaciones&&Array.isArray(e.ubicaciones)){const t=e.ubicaciones.filter(e=>e.mapId&&void 0!==e.markerX&&void 0!==e.markerY);h+=t.length}}),o&&o.initialized&&(d.mapas&&Array.isArray(d.mapas)&&await o.saveMaps(d.mapas,{action:"restore_backup",detail:"Restauracin desde backup"}),d.areas&&Array.isArray(d.areas)&&await o.saveAreas(d.areas,{action:"restore_backup",detail:"Restauracin desde backup"}));let g=0;try{const e=await i.getDirectoryHandle("imagenes",{create:!1}),t=await n.directoryHandle.getDirectoryHandle("imagenes",{create:!0});for await(const n of e.values())if("file"===n.kind)try{const e=await n.getFile(),a=await t.getFileHandle(n.name,{create:!0}),i=await a.createWritable();await i.write(await e.arrayBuffer()),await i.close(),g++}catch(a){}}catch(a){}await c.render(),c.renderFilters(),c.updateAutocompleteData(),l&&"function"==typeof l.loadData&&await l.loadData({force:!0});let b=0;c.repuestos.forEach(e=>{e.ubicaciones&&Array.isArray(e.ubicaciones)&&(b+=e.ubicaciones.filter(e=>e.mapId&&void 0!==e.markerX&&void 0!==e.markerY).length)});const v=` Backup completo restaurado:\n ${u.totalRepuestos||0} repuestos\n ${u.totalMapas||0} mapas\n ${u.totalAreas||0} reas\n ${b} ubicaciones en mapas\n ${g} imgenes restauradas`;c.showToast(v,"success",8e3)}catch(i){c.showToast(" Error al restaurar backup: "+i.message,"error")}},mostrarModal(e){const t=document.getElementById("modalDetalles"),a=document.getElementById("modalDetallesContenido");return!(!t||!a)&&(a.innerHTML=e,t.style.display="block",!0)},cerrarModal(){const e=document.getElementById("modalDetalles");e&&(e.style.display="none")},async descargarUltimoZip(e){try{const t=await n.directoryHandle.getDirectoryHandle("backups",{create:!1}),a=await t.getDirectoryHandle("zip",{create:!1}),i=await a.getFileHandle(e,{create:!1}),s=await i.getFile(),r=URL.createObjectURL(s),o=document.createElement("a");o.href=r,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r),c.showToast(` Descargando ${e} a la carpeta Downloads del navegador...`,"success",4e3),this.cerrarModal()}catch(t){c.showToast(" Error al descargar el archivo ZIP","error")}},mostrarProgresoPDF(e,t){const a=document.getElementById("modalDetalles"),n=document.getElementById("modalDetallesContenido");if(!a||!n)return;const i=`\n      <div class="modal-content" style="max-width: 500px; text-align: center;">\n        <h3 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center; gap: 10px; justify-content: center;">\n          <span style="font-size: 32px;"></span>\n          <span>Generando PDF</span>\n        </h3>\n        \n        <div style="margin: 20px 0;">\n          <div style="font-size: 48px; font-weight: bold; color: #2196F3; margin-bottom: 10px;">\n            ${Math.round(e)}%\n          </div>\n          <div style="color: #666; font-size: 14px; margin-bottom: 20px;">\n            ${t}\n          </div>\n        </div>\n        \n        <div style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; position: relative;">\n          <div style="height: 100%; background: linear-gradient(90deg, #2196F3, #1976D2); width: ${e}%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">\n            <span style="color: white; font-size: 12px; font-weight: bold; position: absolute; width: 100%; text-align: center;">\n              ${Math.round(e)}%\n            </span>\n          </div>\n        </div>\n        \n        <div style="margin-top: 20px; padding: 12px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #2196F3;">\n          <p style="margin: 0; font-size: 13px; color: #0d47a1;">\n             Por favor espera... Este proceso puede tardar varios minutos dependiendo de la cantidad de repuestos e imgenes.\n          </p>\n        </div>\n      </div>\n    `;n.innerHTML=i,a.style.display="flex"},async mostrarGestionBackups(){const e=await this.listarBackups();let t=`\n      <div style="max-height: 400px; overflow-y: auto;">\n        <h3 style="margin: 0 0 16px 0; color: var(--primary);">\n           Historial de Backups (${e.length}/5)\n        </h3>\n    `;0===e.length?t+='\n        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">\n          <div style="font-size: 3rem; margin-bottom: 16px;"></div>\n          <p>No hay backups disponibles</p>\n          <p style="font-size: 0.9rem; margin-top: 8px;">\n            Los backups se crean automticamente al guardar cambios\n          </p>\n        </div>\n      ':e.forEach((e,a)=>{t+=`\n          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--primary);">\n            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">\n              <div style="flex: 1;">\n                <strong style="color: var(--text-primary);">${e.name}</strong>\n                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">\n                   ${e.fecha}\n                </div>\n              </div>\n              <span style="background: var(--primary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; white-space: nowrap;">\n                ${0===a?" Reciente":`#${a+1}`}\n              </span>\n            </div>\n            \n            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 10px; font-size: 0.8rem;">\n              <div style="background: rgba(59, 130, 246, 0.1); padding: 6px; border-radius: 4px; text-align: center;">\n                <div style="color: var(--text-secondary); font-size: 0.7rem;"> Repuestos</div>\n                <div style="color: var(--primary); font-weight: 600;">${e.totalRepuestos}</div>\n              </div>\n              <div style="background: rgba(16, 185, 129, 0.1); padding: 6px; border-radius: 4px; text-align: center;">\n                <div style="color: var(--text-secondary); font-size: 0.7rem;"> Mapas</div>\n                <div style="color: #10b981; font-weight: 600;">${e.totalMapas}</div>\n              </div>\n              <div style="background: rgba(245, 158, 11, 0.1); padding: 6px; border-radius: 4px; text-align: center;">\n                <div style="color: var(--text-secondary); font-size: 0.7rem;"> reas</div>\n                <div style="color: #f59e0b; font-weight: 600;">${e.totalAreas}</div>\n              </div>\n              <div style="background: rgba(139, 92, 246, 0.1); padding: 6px; border-radius: 4px; text-align: center;">\n                <div style="color: var(--text-secondary); font-size: 0.7rem;"> Ubicaciones</div>\n                <div style="color: #8b5cf6; font-weight: 600;">${e.totalUbicaciones}</div>\n              </div>\n            </div>\n            \n            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 10px;">\n              <span> ${e.size}</span>\n              <span> ${e.totalImagenes} imgenes</span>\n              <span> v${e.version}</span>\n            </div>\n            \n            <button onclick="configuracion.restaurarBackupPorIndice(${a})" \n                    class="btn btn-primary" \n                    style="width: 100%; padding: 10px; font-size: 0.9rem;">\n               Restaurar Este Backup Completo\n            </button>\n          </div>\n        `}),t+='\n      </div>\n      <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">\n        <button onclick="configuracion.crearBackupManual()" \n                class="btn btn-success" \n                style="width: 100%; padding: 12px;">\n           Crear Backup Manual Ahora\n        </button>\n      </div>\n    ',this.mostrarModal(t)},async crearBackupManual(){const e=await this.crearBackupAutomatico();if(e){const t=`INVENTARIO_STORAGE/backups/automaticos/${e}`,a=(await this.listarBackups())[0],n=`\n        <div style="text-align: center; padding: 20px;">\n          <div style="font-size: 3rem; margin-bottom: 16px;"></div>\n          <h3 style="color: var(--success); margin-bottom: 16px;">Backup Completo Creado</h3>\n          \n          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin: 20px 0; text-align: left;">\n            <div style="margin-bottom: 12px;">\n              <strong style="color: var(--text-primary);"> Ruta:</strong>\n              <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 6px; font-family: monospace; font-size: 0.85rem; color: var(--primary); word-break: break-all;">\n                ${t}\n              </div>\n            </div>\n            \n            <div style="margin-bottom: 12px;">\n              <strong style="color: var(--text-primary);"> Fecha:</strong>\n              <div style="color: var(--text-secondary); margin-top: 4px;">\n                ${(new Date).toLocaleString("es-ES")}\n              </div>\n            </div>\n            \n            ${a?`\n            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">\n              <strong style="color: var(--text-primary); display: block; margin-bottom: 12px;"> Contenido del Backup:</strong>\n              \n              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">\n                <div style="background: rgba(59, 130, 246, 0.15); padding: 10px; border-radius: 6px; text-align: center;">\n                  <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 4px;"> Repuestos</div>\n                  <div style="color: var(--primary); font-weight: 700; font-size: 1.2rem;">${a.totalRepuestos}</div>\n                </div>\n                \n                <div style="background: rgba(16, 185, 129, 0.15); padding: 10px; border-radius: 6px; text-align: center;">\n                  <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 4px;"> Mapas</div>\n                  <div style="color: #10b981; font-weight: 700; font-size: 1.2rem;">${a.totalMapas}</div>\n                </div>\n                \n                <div style="background: rgba(245, 158, 11, 0.15); padding: 10px; border-radius: 6px; text-align: center;">\n                  <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 4px;"> reas</div>\n                  <div style="color: #f59e0b; font-weight: 700; font-size: 1.2rem;">${a.totalAreas}</div>\n                </div>\n                \n                <div style="background: rgba(139, 92, 246, 0.15); padding: 10px; border-radius: 6px; text-align: center;">\n                  <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 4px;"> Ubicaciones</div>\n                  <div style="color: #8b5cf6; font-weight: 700; font-size: 1.2rem;">${a.totalUbicaciones}</div>\n                </div>\n              </div>\n              \n              <div style="margin-top: 10px; text-align: center; font-size: 0.85rem; color: var(--text-secondary);">\n                 ${a.totalImagenes} imgenes   ${a.size}\n              </div>\n            </div>\n            `:""}\n          </div>\n          \n          <div style="display: grid; gap: 10px; margin-top: 20px;">\n            <button onclick="configuracion.abrirCarpetaBackups()" class="btn btn-primary" style="width: 100%; padding: 12px;">\n               Ir a Ver Carpeta de Backups\n            </button>\n            \n            <button onclick="configuracion.cerrarModal()" class="btn btn-secondary" style="width: 100%; padding: 12px;">\n              Cerrar\n            </button>\n          </div>\n        </div>\n      `;this.mostrarModal(n)}else c.showToast(" No se pudo crear el backup. Verifica que FileSystem est conectado.","warning")},async abrirCarpetaBackups(){try{if(!n.isFileSystemMode||!n.directoryHandle)return void c.showToast(" FileSystem no est activo","warning");const e=n.directoryHandle.name||"INVENTARIO_STORAGE",t=`\n        <div class="modal-content" style="max-width: 500px;">\n          <h3 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">\n             <span>Ubicacin de Backups Automticos</span>\n          </h3>\n          \n          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">\n            <p style="margin: 0 0 10px 0; font-weight: bold; color: #495057;">Ruta completa:</p>\n            <code style="display: block; padding: 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; word-break: break-all; font-size: 13px;">\n              ${`${e}\\backups\\automaticos`}\n            </code>\n          </div>\n          \n          <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">\n            <p style="margin: 0 0 10px 0; font-weight: bold; color: #1976D2;"> Cmo llegar?</p>\n            <ol style="margin: 0; padding-left: 20px; color: #495057; font-size: 14px;">\n              <li>Abre el Explorador de Archivos (Windows + E)</li>\n              <li>Navega a la carpeta donde est INVENTARIO_STORAGE</li>\n              <li>Entra en: <strong>backups  automaticos</strong></li>\n            </ol>\n          </div>\n          \n          <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ffc107;">\n            <p style="margin: 0; font-size: 13px; color: #856404;">\n               <strong>Nota:</strong> Por seguridad, los navegadores no permiten abrir carpetas automticamente.\n              Debes navegar manualmente usando el Explorador de Archivos.\n            </p>\n          </div>\n          \n          <div style="margin-top: 20px;">\n            <button onclick="configuracion.cerrarModal()" class="btn btn-primary" style="width: 100%; padding: 12px;">\n              Entendido\n            </button>\n          </div>\n        </div>\n      `;this.mostrarModal(t)}catch(e){c.showToast(" Navega manualmente a: INVENTARIO_STORAGE\\backups\\automaticos","warning",5e3)}},_backupsCache:[],async restaurarBackupPorIndice(e){const t=await this.listarBackups();t[e]&&(await this.restaurarBackup(t[e].handle),this.cerrarModal())},mostrarOpcionesPDF(){this.mostrarModal('\n      <div class="modal-content" style="max-width: 600px;">\n        <h3 style="margin: 0 0 20px 0; color: #2c3e50;"> Exportar Inventario a PDF</h3>\n        \n        <div style="display: flex; flex-direction: column; gap: 16px;">\n          \n          \x3c!-- Exportacin por jerarqua (nica opcin) --\x3e\n          <div style="background: var(--bg-primary); padding: 14px; border-radius: 8px; border: 2px solid var(--primary);">\n            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">\n              <span style="font-weight: 600; color: var(--text-primary); font-size: 1.1rem;"> Exportar por Nivel Jerrquico</span>\n            </div>\n            <p style="margin: 0 0 16px 0; font-size: 0.85rem; color: var(--text-secondary);">\n              Selecciona la planta/empresa y opcionalmente profundiza en niveles especficos\n            </p>\n            \n            \x3c!-- Selectores de jerarqua (siempre visibles) --\x3e\n            <div id="jerarquiaSelectors">\n              <div style="display: flex; flex-direction: column; gap: 10px;">\n                \n                \x3c!-- Nivel 1: Planta/Empresa --\x3e\n                <div>\n                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">\n                     Planta/Empresa <span style="color: #e74c3c;">*</span>\n                  </label>\n                  <select id="nivel_planta" onchange="configuracion.actualizarNivelesJerarquia(1)" class="form-control" style="width: 100%;">\n                    <option value="">-- Seleccionar Planta --</option>\n                  </select>\n                </div>\n                \n                \x3c!-- Nivel 2: rea General --\x3e\n                <div id="container_areaGeneral" style="display: none;">\n                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">\n                    1 rea General\n                  </label>\n                  <select id="nivel_areaGeneral" onchange="configuracion.actualizarNivelesJerarquia(2)" class="form-control" style="width: 100%;">\n                    <option value="">-- Todas (detener aqu) --</option>\n                  </select>\n                </div>\n                \n                \x3c!-- Nivel 3: Sub-rea --\x3e\n                <div id="container_subArea" style="display: none;">\n                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">\n                    2 Sub-rea\n                  </label>\n                  <select id="nivel_subArea" onchange="configuracion.actualizarNivelesJerarquia(3)" class="form-control" style="width: 100%;">\n                    <option value="">-- Todas (detener aqu) --</option>\n                  </select>\n                </div>\n                \n                \x3c!-- Nivel 4: Sistema/Equipo --\x3e\n                <div id="container_sistemaEquipo" style="display: none;">\n                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">\n                    3 Sistema/Equipo\n                  </label>\n                  <select id="nivel_sistemaEquipo" onchange="configuracion.actualizarNivelesJerarquia(4)" class="form-control" style="width: 100%;">\n                    <option value="">-- Todos (detener aqu) --</option>\n                  </select>\n                </div>\n                \n                \x3c!-- Nivel 5: Sub-Sistema --\x3e\n                <div id="container_subSistema" style="display: none;">\n                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">\n                    4 Sub-Sistema\n                  </label>\n                  <select id="nivel_subSistema" onchange="configuracion.actualizarNivelesJerarquia(5)" class="form-control" style="width: 100%;">\n                    <option value="">-- Todos (detener aqu) --</option>\n                  </select>\n                </div>\n                \n                \x3c!-- Nivel 6: Seccin --\x3e\n                <div id="container_seccion" style="display: none;">\n                  <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">\n                    5 Seccin\n                  </label>\n                  <select id="nivel_seccion" class="form-control" style="width: 100%;">\n                    <option value="">-- Todas (detener aqu) --</option>\n                  </select>\n                </div>\n                \n              </div>\n              \n              \x3c!-- Opciones adicionales --\x3e\n              <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">\n                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">\n                  <input type="checkbox" id="incluirArbolJerarquico" checked style="width: 16px; height: 16px;">\n                  <span style="font-size: 0.9rem;"> Incluir rbol jerrquico en pgina 1</span>\n                </label>\n                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">\n                  <input type="checkbox" id="agruparPorNiveles" checked style="width: 16px; height: 16px;">\n                  <span style="font-size: 0.9rem;"> Agrupar repuestos por niveles</span>\n                </label>\n              </div>\n              \n              \x3c!-- Vista previa de conteo --\x3e\n              <div id="previewConteo" style="display: none; margin-top: 12px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid var(--primary);">\n                <div style="font-size: 0.85rem; color: var(--text-secondary);">\n                  <strong style="color: var(--primary);">Vista previa:</strong><br>\n                  <span id="conteoRepuestos">0 repuestos</span> sern exportados\n                </div>\n              </div>\n            </div>\n          </div>\n          \n          \x3c!-- Botones de accin --\x3e\n          <div style="display: flex; gap: 10px; margin-top: 8px;">\n            <button onclick="configuracion.ejecutarExportPDF()" class="btn btn-success" style="flex: 1; padding: 12px; font-weight: 600;">\n               Exportar PDF\n            </button>\n            <button onclick="configuracion.cerrarModal()" class="btn btn-secondary" style="padding: 12px 20px;">\n              Cancelar\n            </button>\n          </div>\n        </div>\n      </div>\n    '),this.cargarOpcionesNivel("planta",null)},toggleExportOptions(e){},cargarOpcionesNivel(e,t={}){const a=document.getElementById(`nivel_${e}`);if(!a)return;const n=new Set;c.repuestos.forEach(a=>{let i=!0;for(const[e,n]of Object.entries(t||{}))if(n&&a[e]!==n){i=!1;break}i&&a[e]&&n.add(a[e])}),a.innerHTML="areaGeneral"===e?'<option value="">-- Seleccionar --</option>':'<option value="">-- Todos (detener aqu) --</option>',Array.from(n).sort().forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)})},actualizarNivelesJerarquia(e){const t={1:{campo:"planta",siguiente:"areaGeneral",container:"container_areaGeneral"},2:{campo:"areaGeneral",siguiente:"subArea",container:"container_subArea"},3:{campo:"subArea",siguiente:"sistemaEquipo",container:"container_sistemaEquipo"},4:{campo:"sistemaEquipo",siguiente:"subSistema",container:"container_subSistema"},5:{campo:"subSistema",siguiente:"seccion",container:"container_seccion"}},a=t[e];if(!a)return;const n=document.getElementById(`nivel_${a.campo}`).value,i={};e>=1&&(i.planta=document.getElementById("nivel_planta").value),e>=2&&(i.areaGeneral=document.getElementById("nivel_areaGeneral").value),e>=3&&(i.subArea=document.getElementById("nivel_subArea").value),e>=4&&(i.sistemaEquipo=document.getElementById("nivel_sistemaEquipo").value),e>=5&&(i.subSistema=document.getElementById("nivel_subSistema").value);const s=document.getElementById(a.container);if(n)s.style.display="block",this.cargarOpcionesNivel(a.siguiente,i);else if(s.style.display="none",e<5){const a=t[e+1];a&&(document.getElementById(a.container).style.display="none")}this.actualizarConteoPreview()},actualizarConteoPreview(){const e=document.getElementById("previewConteo"),t=document.getElementById("conteoRepuestos");if(!e||!t)return;const a={},n=document.getElementById("nivel_planta").value;if(n){a.planta=n;const e=document.getElementById("nivel_areaGeneral").value;if(e){a.areaGeneral=e;const t=document.getElementById("nivel_subArea").value;if(t){a.subArea=t;const e=document.getElementById("nivel_sistemaEquipo").value;if(e){a.sistemaEquipo=e;const t=document.getElementById("nivel_subSistema").value;if(t){a.subSistema=t;const e=document.getElementById("nivel_seccion").value;e&&(a.seccion=e)}}}}}let i=0;c.repuestos.forEach(e=>{let t=!0;for(const[n,i]of Object.entries(a))if(i&&e[n]!==i){t=!1;break}t&&i++}),Object.keys(a).length>0?(e.style.display="block",t.textContent=`${i} repuesto${1!==i?"s":""}`):e.style.display="none"},async ejecutarExportPDF(){const e=document.getElementById("nivel_planta").value;if(!e)return void c.showToast(" Selecciona al menos una Planta/Empresa","warning");const t={};t.planta=e;const a=document.getElementById("nivel_areaGeneral").value;if(a){t.areaGeneral=a;const e=document.getElementById("nivel_subArea").value;if(e){t.subArea=e;const a=document.getElementById("nivel_sistemaEquipo").value;if(a){t.sistemaEquipo=a;const e=document.getElementById("nivel_subSistema").value;if(e){t.subSistema=e;const a=document.getElementById("nivel_seccion").value;a&&(t.seccion=a)}}}}const n=document.getElementById("incluirArbolJerarquico").checked,i=document.getElementById("agruparPorNiveles").checked;this.cerrarModal(),await this.exportarPDFJerarquico(t,n,i)},async exportarPDFJerarquico(e,t,a){const n=c.repuestos.filter(t=>{for(const[a,n]of Object.entries(e))if(n&&t[a]!==n)return!1;return!0});0!==n.length?await this.exportarPDFCompleto(e,n,t,a):c.showToast(" No hay repuestos en esta jerarqua","warning")},async exportarPDFPorArea(e){const t=c.repuestos.filter(t=>t.area===e);0!==t.length?await this.exportarPDFCompleto(e,t):c.showToast(` No hay repuestos en el rea: ${e}`,"error")},async exportarPDFCompleto(e=null,t=null,a=!1,i=!1){if(window.jspdf&&window.jspdf.jsPDF)try{if(!n.isFileSystemMode||!n.directoryHandle){if(confirm(" SISTEMA DE ARCHIVOS NO CONECTADO\n\nNo has conectado la carpeta INVENTARIO_STORAGE.\nLas imgenes NO aparecern en el PDF (solo placeholders).\n\nDeseas conectar la carpeta ahora antes de exportar el PDF?"))try{return await n.requestDirectoryAccess(),await this.exportarPDFCompleto(t,e,a,i)}catch(s){alert("No se pudo conectar la carpeta. El PDF se generar SIN IMGENES.")}}if(n.isFileSystemMode&&n.directoryHandle&&!n.imagesFolder)try{n.imagesFolder=await n.directoryHandle.getDirectoryHandle("imagenes",{create:!1})}catch(s){}let o="Inventario Completo";if(e&&"object"==typeof e){const t=[];e.areaGeneral&&t.push(e.areaGeneral),e.subArea&&t.push(e.subArea),e.sistemaEquipo&&t.push(e.sistemaEquipo),e.subSistema&&t.push(e.subSistema),e.seccion&&t.push(e.seccion),o=t.join(" > ")}else"string"==typeof e&&(o=`rea: ${e}`);this.mostrarProgresoPDF(0,`Exportando: ${o}...`);const{jsPDF:l}=window.jspdf,d=new l,p=e=>e?String(e).replace(/\u00E1/g,"a").replace(/\u00C1/g,"A").replace(/\u00E9/g,"e").replace(/\u00C9/g,"E").replace(/\u00ED/g,"i").replace(/\u00CD/g,"I").replace(/\u00F3/g,"o").replace(/\u00D3/g,"O").replace(/\u00FA/g,"u").replace(/\u00DA/g,"U").replace(/\u00F1/g,"n").replace(/\u00D1/g,"N").replace(/\u00FC/g,"u").replace(/\u00DC/g,"U").replace(/\u00E7/g,"c").replace(/\u00C7/g,"C").replace(/[\u2018\u2019\u201C\u201D]/g,"").replace(/[^\x00-\x7F]/g,""):"";let u=10;const m=d.internal.pageSize.height,h=d.internal.pageSize.width,g=10,b=50,v=35,y=()=>{d.internal.getNumberOfPages();d.setFontSize(7),d.setTextColor(150,150,150),d.text("v5.3.2",h-g-10,m-5,{align:"right"})},f=(e=15)=>u+e>m-g&&(y(),d.addPage(),u=10,!0),x=e=>new Promise(t=>{const a=new Image;a.onload=()=>{const e=a.width,n=a.height,i=e/n;let s,r;const o=b/e,l=v/n,d=Math.min(o,l,.15);s=e*d,r=n*d;s<20&&r<20&&(i>1?(s=20,r=s/i):(r=20,s=r*i)),s=Math.round(10*s)/10,r=Math.round(10*r)/10,t({width:s,height:r,aspectRatio:i,debeRotar:!1,originalWidth:e,originalHeight:n})},a.onerror=()=>t({width:40,height:30,aspectRatio:1.33,debeRotar:!1}),a.src=e}),S="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAACWCAYAAACb3McZAAAACXBIWXMAAAsTAAALEwEAmpwYAAADGklEQVR4nO3dy0pDQRRF0ZOI///L4sPIQNAY86h0n7X2gDvJoKu7TqeqngEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgP/q9cV7AK7w+uXlbYwxvr5/f/sewKV+hOPx+Ph8fHwc3wW40I9wjDHG4/Fx8R7Ahb6F4/n5+eE9gAt9C8cY4+49gAt9D8er9wAu9CMcz+N1eA/gQj/CMcZr8x7AhSYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTqGkSwlhPoKZJCGM9gZomIYz1BGqahDDWE6hpEsJYT6CmSQhjPYGaJiGM9QRqmoQw1hOoaRLCWE+gpkkIYz2BmiYhjPUEapqEMNYTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgFv6AyRmU3vlastLAAAAAElFTkSuQmCC",w=async e=>{try{if(e.multimedia&&Array.isArray(e.multimedia)){const t=e.multimedia.find(e=>"image"===e.type);if(t&&t.url){let e=t.url;if(e.startsWith("./imagenes/")?e=e.substring(11):e.startsWith("imagenes/")?e=e.substring(9):e.startsWith("INVENTARIO_STORAGE/imagenes/")&&(e=e.substring(28)),n.isFileSystemMode&&n.imagesFolder)try{const t=await n.imagesFolder.getFileHandle(e),a=await t.getFile(),i=await Promise.race([new Promise(e=>{const t=new FileReader;t.onload=()=>{e(t.result)},t.onerror=t=>{e(null)},t.readAsDataURL(a)}),new Promise(e=>setTimeout(()=>{e(null)},5e3))]);return i||S}catch(s){return S}}}}catch(s){}return S};this.mostrarProgresoPDF(5,"Creando portada del documento...");const A=t||c.repuestos;let E="Inventario de Repuestos",I="Todos los repuestos";e&&"object"==typeof e?e.seccion?(E=e.seccion,I=`Seccion dentro de ${e.subSistema||"sistema"}`):e.subSistema?(E=e.subSistema,I=`Sub-Sistema dentro de ${e.sistemaEquipo||"equipo"}`):e.sistemaEquipo?(E=e.sistemaEquipo,I=e.subArea?`Sistema/Equipo dentro de ${e.subArea}`:`Sistema/Equipo dentro de ${e.areaGeneral}`):e.subArea?(E=e.subArea,I=`Sub-Area dentro de ${e.areaGeneral||"area general"}`):e.areaGeneral&&(E=e.areaGeneral,I="Area General"):"Inventario Completo"!==o&&(E=o),d.setFontSize(18),d.setTextColor(59,130,246),d.text(p(E),h/2,20,{align:"center"}),d.setFontSize(9),d.setTextColor(100,100,100),d.text(p(I),h/2,26,{align:"center"}),d.text(`${(new Date).toLocaleDateString("es-ES")} | Total: ${A.length} repuestos`,h/2,31,{align:"center"});const $=A.filter(e=>0===e.cantidad).length,k=A.filter(e=>e.cantidad>0&&e.cantidad<=(e.minimo||5)).length,M=A.length-$-k;if(u=39,d.setFontSize(8),d.setTextColor(60,60,60),d.text(`Stock OK: ${M} | Stock Bajo: ${k} | Sin Stock: ${$}`,h/2,u,{align:"center"}),a&&e&&"object"==typeof e){u=48,d.setFontSize(9),d.setTextColor(80,80,80),d.setFont(void 0,"bold"),d.text("ESTRUCTURA JERARQUICA",h/2,u,{align:"center"}),d.setFont(void 0,"normal"),u+=3,d.setDrawColor(150,150,150),d.setLineWidth(.2),d.line(g+30,u,h-g-30,u),u+=8;const t=(()=>{const e={empresa:"Aquachile Antarfood Chonchi",areasGenerales:{}};return A.forEach(t=>{const a=t.areaGeneral||t.area||"Sin Clasificar";e.areasGenerales[a]||(e.areasGenerales[a]={total:0,subAreas:{}}),e.areasGenerales[a].total++;const n=t.subArea;if(n){e.areasGenerales[a].subAreas[n]||(e.areasGenerales[a].subAreas[n]={total:0,sistemas:{}}),e.areasGenerales[a].subAreas[n].total++;const i=t.sistemaEquipo||t.equipo;if(i){e.areasGenerales[a].subAreas[n].sistemas[i]||(e.areasGenerales[a].subAreas[n].sistemas[i]={total:0,subSistemas:{}}),e.areasGenerales[a].subAreas[n].sistemas[i].total++;const s=t.subSistema;if(s){e.areasGenerales[a].subAreas[n].sistemas[i].subSistemas[s]||(e.areasGenerales[a].subAreas[n].sistemas[i].subSistemas[s]={total:0,secciones:{}}),e.areasGenerales[a].subAreas[n].sistemas[i].subSistemas[s].total++;const r=t.seccion;if(r){e.areasGenerales[a].subAreas[n].sistemas[i].subSistemas[s].secciones[r]||(e.areasGenerales[a].subAreas[n].sistemas[i].subSistemas[s].secciones[r]={total:0,detalles:{}}),e.areasGenerales[a].subAreas[n].sistemas[i].subSistemas[s].secciones[r].total++;const o=t.detalle;o&&(e.areasGenerales[a].subAreas[n].sistemas[i].subSistemas[s].secciones[r].detalles[o]||(e.areasGenerales[a].subAreas[n].sistemas[i].subSistemas[s].secciones[r].detalles[o]=0),e.areasGenerales[a].subAreas[n].sistemas[i].subSistemas[s].secciones[r].detalles[o]++)}}}}}),e})(),a=10;let n=u;const i=3.5,s=20;d.setFontSize(6.5),d.setDrawColor(180,180,180),d.setLineWidth(.15);const r=(t,a)=>1!==t&&(2===t?e.areaGeneral===a&&!e.subArea:3===t?e.subArea===a&&!e.sistemaEquipo:4===t?e.sistemaEquipo===a&&!e.subSistema:5===t?e.subSistema===a&&!e.seccion:6===t?e.seccion===a&&!e.detalle:7===t&&e.detalle===a);d.setFont(void 0,"normal"),d.setTextColor(100,100,100),d.text(p(`${t.empresa} (${A.length})`),a+2,n);const o=n;n+=i;Object.keys(t.areasGenerales).sort().forEach((l,c)=>{const u=t.areasGenerales[l],g=a+s,b=n;d.setDrawColor(180,180,180),0===c&&d.line(a,o,a,b),d.line(a,b,g,b);r(2,l)?(d.setFont(void 0,"bold"),d.setTextColor(220,38,38)):(d.setFont(void 0,"normal"),d.setTextColor(100,100,100)),d.text(p(`${l} (${u.total})`),g+2,b);n+=i;Object.keys(u.subAreas).sort().forEach((t,a)=>{const o=u.subAreas[t],c=g+s,v=n;d.setDrawColor(180,180,180),0===a&&d.line(g,b,g,v),d.line(g,v,c,v);r(3,t)&&e.areaGeneral===l?(d.setFont(void 0,"bold"),d.setTextColor(220,38,38)):(d.setFont(void 0,"normal"),d.setTextColor(120,120,120)),d.text(p(`${t} (${o.total})`),c+2,v);n+=i;Object.keys(o.sistemas).sort().forEach((a,u)=>{const g=o.sistemas[a],b=c+s,f=n;d.setDrawColor(180,180,180),0===u&&d.line(c,v,c,f),d.line(c,f,b,f);r(4,a)&&e.areaGeneral===l&&e.subArea===t?(d.setFont(void 0,"bold"),d.setTextColor(220,38,38)):(d.setFont(void 0,"normal"),d.setTextColor(140,140,140)),d.text(p(`${a} (${g.total})`),b+2,f);n+=i;Object.keys(g.subSistemas).sort().forEach((o,c)=>{const u=g.subSistemas[o],v=b+s,x=n;d.setDrawColor(200,200,200),0===c&&d.line(b,f,b,x),d.line(b,x,v,x);r(5,o)&&e.areaGeneral===l&&e.subArea===t&&e.sistemaEquipo===a?(d.setFont(void 0,"bold"),d.setTextColor(220,38,38)):(d.setFont(void 0,"normal"),d.setTextColor(160,160,160)),d.text(p(`${o} (${u.total})`),v+2,x);n+=i;Object.keys(u.secciones).sort().forEach((c,g)=>{const b=u.secciones[c],f=v+s,S=n;d.setDrawColor(220,220,220),0===g&&d.line(v,x,v,S),d.line(v,S,f,S);r(6,c)&&e.areaGeneral===l&&e.subArea===t&&e.sistemaEquipo===a&&e.subSistema===o?(d.setFont(void 0,"bold"),d.setTextColor(220,38,38)):(d.setFont(void 0,"normal"),d.setTextColor(180,180,180)),d.text(p(`${c} (${b.total})`),f+2,S),n+=i;Object.keys(b.detalles).sort().forEach((u,g)=>{const v=b.detalles[u],x=f+s,w=n;d.setDrawColor(230,230,230),0===g&&d.line(f,S,f,w),d.line(f,w,x,w);r(7,u)&&e.areaGeneral===l&&e.subArea===t&&e.sistemaEquipo===a&&e.subSistema===o&&e.seccion===c?(d.setFont(void 0,"bold"),d.setTextColor(220,38,38)):(d.setFont(void 0,"normal"),d.setTextColor(200,200,200)),d.text(p(`${u} (${v})`),x+2,w),n+=i,n>m-20&&(y(),d.addPage(),n=10,d.setFontSize(8),d.setTextColor(80,80,80),d.setFont(void 0,"bold"),d.text("ESTRUCTURA JERARQUICA (continuacion)",h/2,n,{align:"center"}),d.setFont(void 0,"normal"),n+=5,d.setFontSize(6.5))}),n>m-20&&(y(),d.addPage(),n=10,d.setFontSize(8),d.setTextColor(80,80,80),d.setFont(void 0,"bold"),d.text("ESTRUCTURA JERARQUICA (continuacion)",h/2,n,{align:"center"}),d.setFont(void 0,"normal"),n+=5,d.setFontSize(6.5))})})})})}),u=n+2,d.setDrawColor(150,150,150),d.setLineWidth(.2),d.line(g+30,u,h-g-30,u),u+=3}this.mostrarProgresoPDF(10,"Organizando repuestos por categoras...");const C={};let T="area",q="rea";e&&"object"==typeof e&&(e.subSistema&&!e.seccion?(T="seccion",q="Seccin"):e.sistemaEquipo&&!e.subSistema?(T="subSistema",q="Sub-Sistema"):e.subArea&&!e.sistemaEquipo?(T="sistemaEquipo",q="Sistema/Equipo"):e.areaGeneral&&!e.subArea&&(T="subArea",q="Sub-rea")),A.forEach(e=>{let t=e[T]||e.area||"Sin Clasificar";"sistemaEquipo"!==T||t||(t=e.equipo||"Sin Clasificar"),C[t]||(C[t]=[]),C[t].push(e)}),a&&e&&"object"==typeof e||(u=46);let P=0;const L=A.length;for(const[e,t]of Object.entries(C).sort()){f(12);const a=10+P/L*80;this.mostrarProgresoPDF(a,`Procesando: ${e} (${P}/${L})`),d.setFontSize(11),d.setTextColor(255,255,255),d.setFillColor(59,130,246),d.rect(g,u-4,h-2*g,8,"F"),d.text(p(`${e} (${t.length})`),g+2,u+1),u+=10;for(const e of t){if(P++,P%5==0){const e=10+P/L*80;this.mostrarProgresoPDF(e,`Procesando repuesto ${P} de ${L}...`)}const t=34;f(t),d.setFillColor(248,248,248),d.rect(g,u,h-2*g,t,"F");let a=g+2,n=0;try{const i=await w(e),{width:s,height:r,aspectRatio:o,originalWidth:l,originalHeight:c}=await x(i),p=u+(t-r)/2;d.addImage(i,"JPEG",a,p,s,r),n=s}catch(r){n=b}a+=(n||b)+3,d.setFontSize(9),d.setTextColor(0,0,0),d.setFont(void 0,"bold");const i=p((e.nombre||"Sin nombre").substring(0,40));d.text(i,a,u+7),d.setFont(void 0,"normal"),d.setFontSize(7),d.setTextColor(80,80,80);let s=u+12;const o=[];if(e.codSAP&&o.push(p(`SAP: ${e.codSAP}`)),e.codProv&&o.push(p(`Prov: ${e.codProv}`)),o.push(p(`${e.tipo||"N/A"} | ${e.equipo||"N/A"}`)),e.datosTecnicos){e.datosTecnicos.split("\n").slice(0,2).forEach(e=>{e.trim()&&o.push(p(`${e.trim().substring(0,45)}`))})}o.forEach(e=>{d.text(e,a,s),s+=3.5});const l=h-g-35,c=0===e.cantidad?[220,38,38]:e.cantidad<=(e.minimo||5)?[245,158,11]:[16,185,129];if(d.setTextColor(...c),d.setFont(void 0,"bold"),d.setFontSize(8),d.text(`Stock: ${e.cantidad}/${e.minimo||5}`,l,u+14),d.setFont(void 0,"normal"),d.setFontSize(7),e.ultimoConteo){d.setTextColor(100,100,100);const t=new Date(e.ultimoConteo),a=t.toLocaleDateString("es-ES"),n=t.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});d.text(`Conteo: ${a} ${n}`,l,u+20)}else d.setTextColor(220,38,38),d.text("Sin conteo",l,u+20);e.precio&&(d.setTextColor(59,130,246),d.setFontSize(7),d.text(`$${e.precio.toFixed(2)}`,l,u+26)),u+=t+1}u+=3}this.mostrarProgresoPDF(95,"Generando archivo PDF..."),y();const B=new Date,N=String(B.getDate()).padStart(2,"0"),z=String(B.getMonth()+1).padStart(2,"0"),j=B.getFullYear(),D=`Inventario${o&&"Inventario Completo"!==o?`_${o.replace(/[^a-zA-Z0-9]/g,"_").substring(0,30)}`:""}_${N}-${z}-${j}.pdf`;await new Promise(e=>setTimeout(e,300)),d.save(D),this.mostrarProgresoPDF(100,"PDF generado exitosamente!"),setTimeout(()=>{this.cerrarModal(),c.showToast(` PDF descargado: ${D} (${d.internal.getNumberOfPages()} pginas)`,"success",5e3)},1500)}catch(s){this.cerrarModal(),c.showToast(" Error al generar PDF: "+s.message,"error")}else c.showToast(" Error: Librera jsPDF no cargada","error")},async exportarRespaldoCompleto(){if(window.JSZip)if(n.isFileSystemMode&&n.directoryHandle)try{c.showToast(" Creando respaldo completo... Esto puede tardar","info",5e3);const t=new JSZip,a={version:"5.3.2",fecha:(new Date).toISOString(),totalRepuestos:c.repuestos.length,repuestos:c.repuestos};if(t.file("repuestos.json",JSON.stringify(a,null,2)),o&&o.initialized)try{const e=await o.getMaps(),a=await o.getAreas(),n={version:"5.3.2",fecha:(new Date).toISOString(),mapas:e,areas:a};t.file("mapas.json",JSON.stringify(n,null,2))}catch(e){}let i=0;if(n.imagesFolder)for await(const e of n.imagesFolder.values())"file"===e.kind&&i++;const s=`\nRESPALDO COMPLETO DEL INVENTARIO (ZIP)\n=======================================\n\n Fecha de creacin: ${(new Date).toLocaleString("es-ES")}\n Versin: 5.3.2\n Total de repuestos: ${c.repuestos.length}\n  Total de imgenes: ${i}\n\nCONTENIDO DEL ZIP:\n------------------\n1. repuestos.json - Datos completos de todos los repuestos\n2. mapas.json - Configuracin de mapas y reas marcadas\n3. imagenes/ - Carpeta con todas las fotos de repuestos\n4. README.txt - Este archivo de instrucciones\n\nUBICACIN DEL RESPALDO:\n-----------------------\nEste archivo ZIP se guarda automticamente en:\n INVENTARIO_STORAGE/backups/zip/Respaldo_Completo_YYYY-MM-DD.zip\n\n IMPORTANTE: Los backups se organizan en carpetas separadas:\n    backups/automaticos/ - Backups JSON automticos (cada vez que guardas)\n    backups/zip/ - Respaldos ZIP completos (con todas las imgenes)\n    backups/mapas/ - Backups especficos de mapas\n    backups/zonas/ - Backups especficos de zonas\n\nINSTRUCCIONES PARA RESTAURAR:\n------------------------------\n1. En la aplicacin v5.3.2 o superior, ve a:\n   Configuracin > Gestin de Backups > Cargar Respaldo Completo\n2. El sistema buscar automticamente en: INVENTARIO_STORAGE/backups/zip/\n3. Selecciona el respaldo ZIP que deseas restaurar\n4. Listo! Todos tus datos estarn restaurados\n\nMIGRACIN ENTRE VERSIONES:\n---------------------------\nEste respaldo es compatible con:\n- v5.3.0  v5.3.2\n- v5.3.2  Versiones futuras\n\nPara migrar a otra versin:\n1. Descarga el ZIP al navegador usando el botn "Descargar ZIP"\n2. Instala la nueva versin del inventario\n3. Selecciona la carpeta INVENTARIO_STORAGE\n4. Ve a "Cargar Respaldo Completo" y selecciona este ZIP\n5. O copia este archivo a: INVENTARIO_STORAGE/backups/zip/\n\nDIFERENCIAS ENTRE TIPOS DE BACKUP:\n-----------------------------------\n Backup Automtico (JSON): ~150-200KB\n   - Se crea automticamente al guardar cambios\n   - Incluye: repuestos, mapas, reas, estadsticas\n   - NO incluye imgenes (solo referencias)\n   - Ubicacin: backups/automaticos/\n   - Rotacin: Se mantienen los ltimos 5\n\n Respaldo Completo (ZIP): Variable (depende de imgenes)\n   - Se crea manualmente desde "Exportar Respaldo Completo"\n   - Incluye: repuestos, mapas, reas, TODAS LAS IMGENES\n   - Ideal para migracin o respaldo externo\n   - Ubicacin: backups/zip/\n   - Rotacin: Se mantienen los ltimos 5\n\nRECOMENDACIONES:\n----------------\n Los backups automticos JSON son suficientes para uso diario\n Crea respaldos ZIP completos semanalmente o antes de actualizar\n Descarga los ZIP importantes a tu PC para respaldo externo\n Los archivos ZIP pueden ser muy grandes si tienes muchas imgenes\n\nSOPORTE TCNICO:\n----------------\nPara ms informacin, consulta la documentacin en:\nDOCUMENTACION/GUIA_RAPIDA.md\n\n Inventario Visual PRO - Sistema de Gestin de Repuestos v5.3.2\n      `.trim();if(t.file("README.txt",s),n.imagesFolder){const a=t.folder("imagenes");for await(const t of n.imagesFolder.values())if("file"===t.kind)try{const e=await t.getFile();a.file(e.name,e)}catch(e){}}const r=await t.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}}),l=`Respaldo_Completo_${(new Date).toISOString().split("T")[0]}.zip`,d=(r.size/1048576).toFixed(2),p=await n.directoryHandle.getDirectoryHandle("backups",{create:!0}),u=await p.getDirectoryHandle("zip",{create:!0}),m=[];for await(const e of u.values())if("file"===e.kind&&e.name.endsWith(".zip")){const t=await e.getFile();m.push({name:e.name,timestamp:t.lastModified})}for(m.sort((e,t)=>e.timestamp-t.timestamp);m.length>=5;){const e=m.shift();await u.removeEntry(e.name)}const h=await u.getFileHandle(l,{create:!0}),g=await h.createWritable();await g.write(r),await g.close();const b=`\n        <div style="text-align: center; padding: 20px;">\n          <div style="font-size: 3rem; margin-bottom: 16px;"></div>\n          <h3 style="color: var(--success); margin-bottom: 16px;">Respaldo Completo Creado</h3>\n          \n          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin: 20px 0; text-align: left;">\n            <div style="margin-bottom: 12px;">\n              <strong style="color: var(--text-primary);"> Archivo:</strong>\n              <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 6px; font-family: monospace; font-size: 0.9rem; color: var(--primary); word-break: break-all;">\n                ${l}\n              </div>\n            </div>\n            \n            <div style="margin-bottom: 12px;">\n              <strong style="color: var(--text-primary);"> Ruta:</strong>\n              <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 6px; font-family: monospace; font-size: 0.85rem; color: var(--success); word-break: break-all;">\n                ${`INVENTARIO_STORAGE/backups/zip/${l}`}\n              </div>\n            </div>\n            \n            <div style="margin-bottom: 12px;">\n              <strong style="color: var(--text-primary);"> Tamao:</strong>\n              <div style="color: var(--text-secondary); margin-top: 4px;">\n                ${d} MB\n              </div>\n            </div>\n            \n            <div style="margin-bottom: 12px;">\n              <strong style="color: var(--text-primary);"> Contenido:</strong>\n              <div style="color: var(--text-secondary); margin-top: 4px;">\n                 ${c.repuestos.length} repuestos<br>\n                 ${i} imgenes<br>\n                 Mapas y reas\n              </div>\n            </div>\n          </div>\n          \n          <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 6px; margin: 16px 0; border-left: 4px solid var(--primary);">\n            <div style="font-size: 0.85rem; color: var(--text-secondary);">\n               <strong>Para migrar a otra versin:</strong><br>\n              1. Copia toda la carpeta <code>INVENTARIO_STORAGE/backups/</code><br>\n              2. Pgala en la nueva versin<br>\n              3. Usa "Cargar Respaldo Completo" para restaurar\n            </div>\n          </div>\n          \n          <div style="display: grid; gap: 10px;">\n            <button onclick="configuracion.descargarUltimoZip('${l}')" class="btn btn-success" style="width: 100%; padding: 12px;">\n               Descargar ZIP al Navegador (Downloads)\n            </button>\n            <button onclick="configuracion.cerrarModal()" class="btn btn-secondary" style="width: 100%; padding: 12px;">\n              Cerrar\n            </button>\n          </div>\n        </div>\n      `;this.mostrarModal(b)}catch(e){c.showToast(" Error: "+e.message,"error")}else c.showToast(" Primero debes seleccionar una carpeta de trabajo","warning");else c.showToast(" Error: Librera JSZip no cargada","error")},async cargarRespaldoCompleto(){if(n.isFileSystemMode&&n.directoryHandle)try{const e=await n.directoryHandle.getDirectoryHandle("backups",{create:!0}),t=await e.getDirectoryHandle("zip",{create:!0}),a=[];for await(const n of t.values())if("file"===n.kind&&n.name.endsWith(".zip")){const e=await n.getFile();a.push({name:n.name,handle:n,file:e,timestamp:e.lastModified,fecha:new Date(e.lastModified).toLocaleString("es-ES"),size:(e.size/1048576).toFixed(2)+" MB"})}if(0===a.length)return void c.showToast(" No hay respaldos ZIP disponibles en backups/zip/","warning",4e3);a.sort((e,t)=>t.timestamp-e.timestamp);let i=`\n        <div style="max-height: 500px; overflow-y: auto;">\n          <h3 style="margin: 0 0 16px 0; color: var(--primary);">\n             Seleccionar Respaldo ZIP (${a.length})\n          </h3>\n          <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">\n            Ubicacin: <code>INVENTARIO_STORAGE/backups/zip/</code>\n          </p>\n      `;a.forEach((e,t)=>{i+=`\n          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid ${0===t?"var(--success)":"var(--primary)"}; cursor: pointer;" onclick="configuracion.restaurarRespaldoCompletoPorIndice(${t})">\n            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">\n              <div style="flex: 1;">\n                <strong style="color: var(--text-primary);">${e.name}</strong>\n                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">\n                   ${e.fecha}\n                </div>\n              </div>\n              <span style="background: ${0===t?"var(--success)":"var(--primary)"}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; white-space: nowrap;">\n                ${0===t?" Ms Reciente":`#${t+1}`}\n              </span>\n            </div>\n            \n            <div style="display: flex; gap: 20px; font-size: 0.85rem; color: var(--text-secondary);">\n              <div>\n                <strong> Tamao:</strong> ${e.size}\n              </div>\n            </div>\n            \n            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">\n              <button onclick="event.stopPropagation(); configuracion.restaurarRespaldoCompletoPorIndice(${t})" \n                      class="btn ${0===t?"btn-success":"btn-primary"}" \n                      style="width: 100%; padding: 10px; font-size: 0.9rem;">\n                 Cargar Este Respaldo\n              </button>\n            </div>\n          </div>\n        `}),i+='\n        </div>\n        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">\n          <button onclick="configuracion.cerrarModal()" \n                  class="btn btn-secondary" \n                  style="width: 100%; padding: 12px;">\n            Cancelar\n          </button>\n        </div>\n      ',this.mostrarModal(i),this._respaldosCache=a}catch(e){c.showToast(" Error al buscar respaldos: "+e.message,"error")}else c.showToast(" Primero debes seleccionar una carpeta de trabajo","warning")},_respaldosCache:[],async restaurarRespaldoCompletoPorIndice(e){const t=this._respaldosCache[e];if(t)if(window.JSZip)try{c.showToast(" Cargando respaldo completo...","info",3e3);const e=await JSZip.loadAsync(t.file),i=e.file("repuestos.json");if(i){const e=JSON.parse(await i.async("text"));if(!confirm(` CARGAR RESPALDO COMPLETO\n\n Archivo: ${t.name}\n Fecha del respaldo: ${new Date(e.fecha).toLocaleString("es-ES")}\n Repuestos: ${e.totalRepuestos}\n Versin: ${e.version}\n\n Esto reemplazar todos los datos actuales.\n\nContinuar?`))return;c.repuestos=e.repuestos||[],await c.saveData()}const s=e.file("mapas.json");if(s&&o){JSON.parse(await s.async("text"))}if(n.imagesFolder){const t=e.folder("imagenes");if(t){let e=0;for(const[i,s]of Object.entries(t.files))if(!s.dir)try{const t=await s.async("blob"),a=await n.imagesFolder.getFileHandle(i.split("/").pop(),{create:!0}),r=await a.createWritable();await r.write(t),await r.close(),e++}catch(a){}}}await c.render(),c.renderFilters(),c.updateAutocompleteData(),this.cerrarModal(),c.showToast(" Respaldo completo cargado correctamente","success",4e3)}catch(a){c.showToast(" Error: "+a.message,"error")}else c.showToast(" Error: Librera JSZip no cargada","error")},async exportarAppCompleta(){if(window.JSZip)try{c.showToast(" Creando paquete portable completo... Esto puede tardar","info",1e4);const t=new JSZip,a="5.3.4",i=new Date,s=i.getFullYear(),r=String(i.getMonth()+1).padStart(2,"0"),o=String(i.getDate()).padStart(2,"0"),l=String(i.getHours()).padStart(2,"0"),d=String(i.getMinutes()).padStart(2,"0"),p=`${s}-${r}-${o}_${l}-${d}-${String(i.getSeconds()).padStart(2,"0")}`,u=`InventarioPortable_v${a}_${p}.zip`,m=document.documentElement.outerHTML;if(t.file(`inventario_v${a}.html`,"<!DOCTYPE html>\n"+m),n.isFileSystemMode&&n.directoryHandle){const e=t.folder("INVENTARIO_STORAGE"),a=async(e,t)=>{for await(const i of e.values())if("file"===i.kind)try{const e=await i.getFile();t.file(i.name,e)}catch(n){}else if("directory"===i.kind){const e=t.folder(i.name);await a(i,e)}};await a(n.directoryHandle,e)}const h=`\n\n                                                                \n          INVENTARIO PORTABLE v${a}                         \n            Sistema de Gestin de Repuestos                    \n                                                                \n\n\n Fecha de exportacin: ${i.toLocaleString("es-ES")}\n Paquete: Aplicacin completa con todos los datos\n\n\n\n CONTENIDO DEL PAQUETE:\n\n\n1. inventario_v${a}.html\n    Aplicacin principal (archivo nico)\n    Abre con cualquier navegador moderno\n\n2. INVENTARIO_STORAGE/\n    Todos tus datos y configuraciones\n    Backups automticos\n    Imgenes de repuestos\n    Mapas y configuraciones\n\n\n\n INSTRUCCIONES DE INSTALACIN EN OTRO PC:\n\n\nPASO 1: Extraer el ZIP\n    Descomprime este ZIP en cualquier carpeta de tu PC\n    Ejemplo: C:\\MisAplicaciones\\Inventario\\\n    MANTN JUNTOS el HTML y la carpeta INVENTARIO_STORAGE\n\nPASO 2: Abrir la aplicacin\n    Doble clic en: inventario_v${a}.html\n    Se abrir en tu navegador predeterminado\n\nPASO 3: Conectar la carpeta de datos (IMPORTANTE)\n    En la pantalla inicial, click en " Seleccionar Carpeta"\n    Selecciona la carpeta: INVENTARIO_STORAGE\n    TODAS las imgenes, mapas y datos se cargarn automticamente!\n\n NOTA CRTICA: \n   Sin conectar la carpeta INVENTARIO_STORAGE no vers:\n    Imgenes de repuestos\n    Imgenes en marcadores del mapa\n    Backups guardados\n   \n   Siempre selecciona la carpeta primero antes de usar la app.\n\n\n\n VENTAJAS DE ESTE PAQUETE:\n\n\n No requiere instalacin\n Funciona sin internet\n Porttil entre PCs\n Incluye TODOS tus datos\n Backups incluidos\n Imgenes incluidas\n Compatible Windows/Mac/Linux\n\n\n\n REQUISITOS:\n\n\n Navegador moderno (Chrome 86+, Edge 86+, Opera 72+)\n JavaScript habilitado\n File System Access API (automtico en navegadores modernos)\n\n\n\n ESTRUCTURA DE ARCHIVOS:\n\n\nInventarioPortable_v${a}_${p}.zip\n README.txt (este archivo)\n inventario_v${a}.html (aplicacin)\n INVENTARIO_STORAGE/\n     backups/\n        automaticos/  (backups JSON)\n        zip/          (respaldos completos)\n        mapas/        (backups de mapas)\n        zonas/        (backups de reas)\n     imagenes/         (fotos de repuestos)\n\n\n\n MIGRACIN ENTRE VERSIONES:\n\n\nPara actualizar a una versin futura:\n1. Guarda tu carpeta INVENTARIO_STORAGE\n2. Descarga la nueva versin HTML\n3. Abre la nueva versin\n4. Selecciona tu carpeta INVENTARIO_STORAGE existente\n5. Todos tus datos estarn disponibles!\n\n\n\n SOPORTE Y DOCUMENTACIN:\n\n\nDentro de la aplicacin:\n Click en  Configuracin\n Seccin "Ayuda y Documentacin"\n Guas rpidas disponibles\n\n\n\n 2025 Inventario Visual PRO v${a}\nSistema de Gestin de Repuestos con Mapas Visuales\n\n      `.trim();t.file("README.txt",h);const g=await t.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}},e=>{e.percent.toFixed(0)}),b=(g.size/1048576).toFixed(2);if(n.isFileSystemMode&&n.directoryHandle)try{const e=await n.directoryHandle.getDirectoryHandle("backups",{create:!0}),t=await e.getDirectoryHandle("app_portable",{create:!0}),a=await t.getFileHandle(u,{create:!0}),i=await a.createWritable();await i.write(g),await i.close();const s=`\n            <div class="modal-content" style="max-width: 500px;">\n              <h3 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">\n                 <span>App Portable Exportada</span>\n              </h3>\n              \n              <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #28a745;">\n                <p style="margin: 0 0 10px 0; font-weight: bold; color: #155724;"> Paquete Completo Guardado:</p>\n                <div style="background: white; padding: 10px; border-radius: 6px; margin-top: 10px;">\n                  <div style="font-size: 16px; font-weight: bold; color: #2196F3; margin-bottom: 5px;">\n                    ${u}\n                  </div>\n                  <div style="font-size: 13px; color: #666;">\n                    Tamao: ${b} MB\n                  </div>\n                  <div style="font-size: 12px; color: #888; margin-top: 5px;">\n                     INVENTARIO_STORAGE/backups/app_portable/\n                  </div>\n                </div>\n              </div>\n              \n              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">\n                <p style="margin: 0 0 10px 0; font-weight: bold; color: #495057;"> Contenido incluido:</p>\n                <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 14px;">\n                  <li> Aplicacin HTML completa</li>\n                  <li> Todos tus datos y repuestos</li>\n                  <li> Todas las imgenes</li>\n                  <li> Backups automticos</li>\n                  <li> Mapas y configuraciones</li>\n                  <li> README con instrucciones</li>\n                </ul>\n              </div>\n              \n              <div style="background: #e7f3ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196F3;">\n                <p style="margin: 0; font-size: 13px; color: #0d47a1;">\n                   <strong>En otro PC:</strong> Simplemente extrae el ZIP y abre el archivo HTML. \n                  Luego selecciona la carpeta INVENTARIO_STORAGE y tendrs todo funcionando.\n                </p>\n              </div>\n              \n              <div style="display: grid; gap: 10px;">\n                <button onclick="configuracion.cerrarModal()" class="btn btn-primary" style="width: 100%; padding: 12px;">\n                  Entendido\n                </button>\n              </div>\n            </div>\n          `;this.mostrarModal(s),c.showToast(" App portable guardada en backups/app_portable/","success",5e3)}catch(e){c.showToast(" Error al guardar en backups: "+e.message,"error")}else{const e=URL.createObjectURL(g),t=document.createElement("a");t.href=e,t.download=u,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e),c.showToast(` App portable descargada: ${u}`,"success",5e3)}}catch(e){c.showToast(" Error: "+e.message,"error")}else c.showToast(" Error: Librera JSZip no cargada","error")},exportarExcel(){try{c.exportExcel()}catch(e){c.showToast(" Error al exportar Excel: "+e.message,"error")}},exportarHTMLConDatosEmbebidos(){c.showToast(" Funcin no implementada an. Esta funcin permitir exportar un HTML standalone con todos los datos embebidos (sin necesidad de FileSystem) ideal para usar en mviles sin conexin.","info",5e3)}};(async()=>{if("enabled"===localStorage.getItem("fsDirectory")&&await c.connectWorkspace(!0,!1),n.isConnected){c.showBrowserWarning(),void 0!==u&&setTimeout(()=>{u.renderStorageUI(),u.loadICloudPathConfig()},100),c.setupEvents(),c.setupDelegatedEvents(),c.setupPhotoInputs(),c.applyViewModeStyles(),c.updateViewModeInfo(),c.renderFilters();const e=localStorage.getItem("autocompleteData");if(e)try{c.autocompleteData=JSON.parse(e)}catch(t){c.updateAutocompleteData()}else c.updateAutocompleteData();c.setupAutocomplete();const a=document.getElementById("equipo");a&&a.addEventListener("blur",()=>{const e=a.value.trim();e&&c.cargarSistemasPorEquipo(e)})}else await c.init();if(document.getElementById("okr")&&d.init(),void 0!==p&&(p.init(),void 0!==u&&(u.backupManager=p)),document.getElementById("mapCanvas"))try{l.init()}catch(a){}if(!c.visualV2){const e=document.getElementById("jerarquiaVisualV2Container");if(window.visualTreeV2Module&&e)try{c.visualV2=window.visualTreeV2Module.create(c),c.visualV2.mount(e),c.visualV2.render()}catch(a){}}if(n.isFileSystemMode){await c.cleanBase64ImagesFromLocalStorage(),u.actualizarEstadoUI();localStorage.getItem("fsFolderName"),c.repuestos.filter(e=>e.multimedia&&e.multimedia.length>0),c.repuestos.filter(e=>!e.multimedia||0===e.multimedia.length);const e=localStorage.getItem("inventarioData");if(e){(new Blob([e]).size/1048576).toFixed(2);const t=JSON.parse(e);let a=0;t.forEach(e=>{e.multimedia&&e.multimedia.length>0&&e.multimedia.forEach(e=>{e.url&&e.url.startsWith("data:image")&&a++})})}const t=document.createElement("div");t.style.cssText="\n      position: fixed;\n      bottom: 100px;\n      right: 30px;\n      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);\n      color: white;\n      padding: 15px 25px;\n      border-radius: 12px;\n      box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n      z-index: 9998;\n      font-size: 14px;\n      animation: slideIn 0.3s ease-out;\n    ",t.innerHTML=' Modo Carpeta conectado<br><small style="opacity: 0.9;"> Capacidad ilimitada activa</small>',document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOut 0.3s ease-in",setTimeout(()=>t.remove(),300)},3e3)}const e=document.getElementById("loadingIndicator");e&&(e.style.opacity="0",e.style.transition="opacity 0.3s ease-out",setTimeout(()=>e.remove(),300))})(),document.addEventListener("click",e=>{e.target.closest('[onclick*="toggleDropdown"]')||e.target.closest(".dropdown-item")||document.querySelectorAll('[id$="Dropdown"]').forEach(e=>{e.style.display="none"})}),c.testCampana=function(){const e=document.getElementById("notificationBell"),t=document.getElementById("notificationPanel");e&&t&&e.addEventListener("click",function(){t.classList.contains("active")?t.classList.remove("active"):t.classList.add("active")})},c.testNotificationBell=function(){const e=document.getElementById("notificationBell"),t=document.getElementById("notificationPanel");e&&e.addEventListener("click",()=>{t&&t.classList.toggle("active")}),this.addNotification&&this.addNotification(" Prueba de notificacin","info")},c.demoNotifications=function(){setTimeout(()=>{this.showToast(" Sistema de notificaciones activado - Revisa la campana ","info")},500),setTimeout(()=>{this.showToast(" Notificaciones ahora se guardan permanentemente","success")},1500),setTimeout(()=>{this.showToast(" Indicador rojo aparece con notificaciones sin leer","warning")},2500),setTimeout(()=>{this.showToast(" Click en la campana abre el panel completo","error")},3500),setTimeout(()=>{this.showToast(" Historial persistente con fecha y hora","info")},4500),setTimeout(()=>{},6e3)},c.demoNotificationTypes=function(){const e=[{msg:" Informacin general del sistema",type:"info"},{msg:" Operacin completada exitosamente",type:"success"},{msg:" Advertencia importante para el usuario",type:"warning"},{msg:" Error crtico que necesita atencin",type:"error"},{msg:" Mantenimiento programado prximamente",type:"info"},{msg:" Backup automtico completado",type:"success"}];e.forEach((e,t)=>{setTimeout(()=>{this.showToast(e.msg,e.type)},800*t)}),setTimeout(()=>{},800*e.length+1e3)},c.getActiveJerarquiaContainer=function(){return document.getElementById("jerarquiaTreeContainer")},c.changeJerarquiaPalette=function(){const e=document.getElementById("jerarquiaPaletteSelect"),t=document.getElementById("jerarquiaTreeContainer");if(!e||!t)return;const a=e.value;"visual-v2"!==a?(t.classList.remove("palette-8","palette-9","palette-visual"),"original"!==a&&t.classList.add(a),"palette-visual"===a?(t.style.setProperty("min-height","600px"),t.style.setProperty("height","auto"),t.style.setProperty("overflow","visible"),t.style.setProperty("padding","40px"),t.style.setProperty("background","#1e2229")):(t.style.removeProperty("min-height"),t.style.removeProperty("height"),t.style.removeProperty("overflow"),t.style.removeProperty("padding"),t.style.removeProperty("background")),localStorage.setItem("jerarquiaPalettePreference","palette-visual"),this.renderJerarquiaTree()):this.changeJerarquiaPaletteByTab("visual-v2")},c.expandirTodoJerarquia=function(){const e=document.querySelectorAll(".tree-children"),t=document.querySelectorAll(".node-toggle");e.forEach(e=>{e.style.display="block"}),t.forEach(e=>{e.textContent="",e.classList.remove("collapsed"),e.classList.add("expanded")}),document.querySelectorAll(".node-content[data-node-id]").forEach(e=>{const t=e.getAttribute("data-node-id"),a=this.getLegacyIdFromNodeContent(e);t&&this.saveNodeExpandState(t,!0,a)})},c.contraerTodoJerarquia=function(){const e=document.querySelectorAll(".tree-children"),t=document.querySelectorAll(".node-toggle");e.forEach((e,t)=>{t>0&&(e.style.display="none")}),t.forEach((e,t)=>{t>0&&(e.textContent="",e.classList.remove("expanded"),e.classList.add("collapsed"))}),document.querySelectorAll(".node-content[data-node-id]").forEach((e,t)=>{const a=e.getAttribute("data-node-id"),n=this.getLegacyIdFromNodeContent(e);a&&this.saveNodeExpandState(a,0===t,n)})},c.jerarquiaSearchState={index:[],matches:[],selectedIndex:-1,debounceHandle:null,lastQuery:"",isFilterActive:!1,activeMatch:null},c.initJerarquiaSearch=function(){const e=document.getElementById("jerarquiaTreeSearchInput"),t=document.getElementById("jerarquiaSearchSuggestions");e&&t&&(this._jerarquiaSearchInitialized||(this._jerarquiaSearchInitialized=!0,e.addEventListener("input",e=>{const t=e.target.value||"";clearTimeout(this.jerarquiaSearchState.debounceHandle),t.trim()?this.jerarquiaSearchState.debounceHandle=setTimeout(()=>{this.performJerarquiaSearch(t)},250):this.clearJerarquiaSearch()}),e.addEventListener("keydown",e=>{this.handleJerarquiaSearchKeydown(e)}),e.addEventListener("focus",()=>{const t=e.value||"";t.trim()&&this.performJerarquiaSearch(t)}),this._jerarquiaSearchOutsideHandler=a=>{t.contains(a.target)||a.target===e||t.classList.remove("active")},document.addEventListener("click",this._jerarquiaSearchOutsideHandler)))},c.updateJerarquiaSearchStatus=function(e="",t=""){const a=document.getElementById("jerarquiaSearchStatus");a&&(a.textContent=e,a.classList.remove("success","warning"),e&&t&&a.classList.add(t))},c.collapseJerarquiaTree=function(){const e=this.getActiveJerarquiaContainer();e&&((e.querySelectorAll(".tree-children")||[]).forEach(e=>{e.style.display="none"}),(e.querySelectorAll(".node-toggle")||[]).forEach(e=>{e.classList.remove("expanded"),e.classList.add("collapsed"),e.textContent=""}))},c.resetJerarquiaTreeView=function(){const e=this.getActiveJerarquiaContainer();e&&((e.querySelectorAll(".tree-children")||[]).forEach(e=>{e.style.display="block"}),(e.querySelectorAll(".node-toggle")||[]).forEach(e=>{e.classList.remove("collapsed"),e.classList.add("expanded"),e.textContent=""}))},c.buildJerarquiaSearchIndex=function(){var e,t;const a=[],n=this.jerarquiaAnidada;if(!n)return void(this.jerarquiaSearchState.index=a);const i=(null==(e=n.empresa)?void 0:e.nombre)||"Empresa",s=(null==(t=n.empresa)?void 0:t.id)||"";n.empresa&&a.push({id:s,nombre:i,nivel:"Empresa",path:i,indices:[]});const r=(e,t,n,i)=>{a.push({id:(null==e?void 0:e.id)||"",nombre:(null==e?void 0:e.nombre)||"",nivel:t,path:n,indices:[...i]})};(Array.isArray(n.areas)?n.areas:[]).forEach((e,t)=>{const a=(null==e?void 0:e.nombre)||"rea",n=`${i} > ${a}`;r(e,"rea",n,[t]);(Array.isArray(null==e?void 0:e.subAreas)?e.subAreas:[]).forEach((e,a)=>{const i=(null==e?void 0:e.nombre)||"Sub-rea",s=`${n} > ${i}`;r(e,"Sub-rea",s,[t,a]);(Array.isArray(null==e?void 0:e.sistemas)?e.sistemas:[]).forEach((e,n)=>{const i=(null==e?void 0:e.nombre)||"Sistema",o=`${s} > ${i}`;r(e,"Sistema",o,[t,a,n]);(Array.isArray(null==e?void 0:e.subSistemas)?e.subSistemas:[]).forEach((e,i)=>{const s=(null==e?void 0:e.nombre)||"Sub-Sistema",l=`${o} > ${s}`;r(e,"Sub-Sistema",l,[t,a,n,i]);(Array.isArray(null==e?void 0:e.secciones)?e.secciones:[]).forEach((e,s)=>{const o=(null==e?void 0:e.nombre)||"Seccin",d=`${l} > ${o}`;r(e,"Seccin",d,[t,a,n,i,s]);(Array.isArray(null==e?void 0:e.subSecciones)?e.subSecciones:[]).forEach((e,o)=>{const l=(null==e?void 0:e.nombre)||"Sub-Seccin";r(e,"Sub-Seccin",`${d} > ${l}`,[t,a,n,i,s,o])})})})})})}),this.jerarquiaSearchState.index=a},c.performJerarquiaSearch=function(e){if(!document.getElementById("jerarquiaSearchSuggestions"))return;const t=(e||"").trim();if(this.jerarquiaSearchState.lastQuery=t,!t)return void this.clearJerarquiaSearch();const a=t.toLowerCase(),n=this.jerarquiaSearchState.index.filter(e=>{const t=e.id&&e.id.toLowerCase().includes(a),n=e.nombre&&e.nombre.toLowerCase().includes(a);return t||n});this.jerarquiaSearchState.matches=n,this.jerarquiaSearchState.selectedIndex=n.length?0:-1,this.jerarquiaSearchState.isFilterActive=!1,this.jerarquiaSearchState.activeMatch=null,0===n.length?this.updateJerarquiaSearchStatus("No se encontraron resultados","warning"):this.updateJerarquiaSearchStatus(`${n.length} resultado(s)`),this.renderJerarquiaSuggestions(n,t),this.highlightJerarquiaMatches(t)},c.renderJerarquiaSuggestions=function(e,t){const a=document.getElementById("jerarquiaSearchSuggestions");if(!a)return;if(!e||0===e.length)return a.innerHTML='<div class="jerarquia-suggestion-item" style="opacity: 0.6;">No se encontraron resultados</div>',void a.classList.add("active");const n=(e="")=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),i=(e="")=>{if(!t.trim())return n(e);const a=new RegExp(`(${((e="")=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"))(t.trim())})`,"gi");return e.split(a).map((e,t)=>t%2==1?`<mark class="jerarquia-match">${n(e)}</mark>`:n(e)).join("")},s=e.slice(0,12);this.jerarquiaSearchState.selectedIndex>s.length-1&&(this.jerarquiaSearchState.selectedIndex=s.length?s.length-1:-1),a.innerHTML=s.map((e,t)=>`\n      <div class="jerarquia-suggestion-item ${t===this.jerarquiaSearchState.selectedIndex?"selected":""}"\n           data-suggestion-index="${t}"\n           onclick="app.handleJerarquiaSuggestionClick(${t})">\n        <div class="jerarquia-suggestion-main">\n          <span class="jerarquia-suggestion-id">${i(e.id||"")}</span>\n          <span>${i(e.nombre||"Sin nombre")}</span>\n        </div>\n        <div class="jerarquia-suggestion-meta">\n          <span>${i(e.nivel||"")}</span>\n          <span></span>\n          <span class="jerarquia-suggestion-path">${i(e.path||"")}</span>\n        </div>\n      </div>\n    `).join(""),a.classList.add("active"),this.updateJerarquiaSuggestionSelection()},c.updateJerarquiaSuggestionSelection=function(){const e=document.getElementById("jerarquiaSearchSuggestions");if(!e)return;e.querySelectorAll(".jerarquia-suggestion-item").forEach((e,t)=>{e.classList.toggle("selected",t===this.jerarquiaSearchState.selectedIndex),t===this.jerarquiaSearchState.selectedIndex&&e.scrollIntoView({block:"nearest"})})},c.handleJerarquiaSuggestionClick=function(e){const t=document.getElementById("jerarquiaSearchSuggestions");t&&t.classList.remove("active");const a=this.jerarquiaSearchState.matches[e];a&&(this.jerarquiaSearchState.selectedIndex=e,this.focusJerarquiaSearchResult(a))},c.handleJerarquiaSearchKeydown=function(e){const t=document.getElementById("jerarquiaSearchSuggestions"),a=this.jerarquiaSearchState.matches.length;if("Enter"===e.key){if(t&&t.classList.contains("active")&&a>0){e.preventDefault();const t=this.jerarquiaSearchState.selectedIndex>=0?this.jerarquiaSearchState.selectedIndex:0;this.handleJerarquiaSuggestionClick(t)}return}if(!t||!t.classList.contains("active")||0===a)return void("Escape"===e.key&&(null==t||t.classList.remove("active")));const n=Math.min(a,12);"ArrowDown"===e.key?(e.preventDefault(),this.jerarquiaSearchState.selectedIndex<0?this.jerarquiaSearchState.selectedIndex=0:this.jerarquiaSearchState.selectedIndex=Math.min(this.jerarquiaSearchState.selectedIndex+1,n-1),this.updateJerarquiaSuggestionSelection()):"ArrowUp"===e.key?(e.preventDefault(),this.jerarquiaSearchState.selectedIndex<=0?this.jerarquiaSearchState.selectedIndex=0:this.jerarquiaSearchState.selectedIndex=Math.max(this.jerarquiaSearchState.selectedIndex-1,0),this.updateJerarquiaSuggestionSelection()):"Escape"===e.key&&t.classList.remove("active")},c.highlightJerarquiaMatches=function(e){const t=(e||"").trim().toLowerCase();if(this.clearJerarquiaSearchHighlights(),!t)return;const a=this.getActiveJerarquiaContainer();a&&a.querySelectorAll(".node-content").forEach(e=>{var a,n;`${(null==(a=e.querySelector(".node-id"))?void 0:a.textContent)||""} ${(null==(n=e.querySelector(".node-name"))?void 0:n.textContent)||""}`.toLowerCase().includes(t)&&e.classList.add("search-match")})},c.clearJerarquiaSearchHighlights=function(){const e=this.getActiveJerarquiaContainer();e&&e.querySelectorAll(".node-content").forEach(e=>{e.classList.remove("search-match","search-highlight")})},c.focusJerarquiaSearchResult=function(e){if(!e)return;const t=this.getActiveJerarquiaContainer();if(!t)return;const a=Array.isArray(e.indices)&&e.indices.length>0;a?(this.collapseJerarquiaTree(),this.expandJerarquiaPath(e.indices),this.jerarquiaSearchState.isFilterActive=!0):(this.resetJerarquiaTreeView(),this.jerarquiaSearchState.isFilterActive=!1),this.jerarquiaSearchState.activeMatch=e;const n=document.getElementById("jerarquiaTreeSearchInput");n&&(n.value=e.nombre||e.id||""),this.clearJerarquiaSearchHighlights(),this.highlightJerarquiaMatches(this.jerarquiaSearchState.lastQuery),a?this.updateJerarquiaSearchStatus(" Filtrado activo","success"):this.updateJerarquiaSearchStatus("Empresa seleccionada","success");let i=null;if(Array.isArray(e.indices)&&e.indices.length){const a=`.tree-node[data-node-index="${e.indices.join(",")}"] > .node-content`;i=t.querySelector(a)}i||(i=Array.from(t.querySelectorAll(".node-content")).find(t=>{var a,n,i,s;const r=null==(n=null==(a=t.querySelector(".node-id"))?void 0:a.textContent)?void 0:n.trim().toLowerCase(),o=null==(s=null==(i=t.querySelector(".node-name"))?void 0:i.textContent)?void 0:s.trim().toLowerCase();return e.id&&r===e.id.toLowerCase()||e.nombre&&o===e.nombre.toLowerCase()})||null),i&&(i.classList.add("search-highlight"),setTimeout(()=>{i.scrollIntoView({behavior:"smooth",block:"center"})},100))},c.expandJerarquiaPath=function(e){const t=this.getActiveJerarquiaContainer();if(!t)return;if(!Array.isArray(e)||0===e.length)return;const a=t.querySelector(".tree-container > .tree-node > .tree-children");a&&(a.style.display="block");const n=e=>{if(!e)return;const t=e.querySelector(":scope > .tree-children");t&&(t.style.display="block");const a=e.querySelector(":scope > .node-content .node-toggle");a&&(a.classList.remove("collapsed"),a.classList.add("expanded"),a.textContent="")},i=[];e.forEach(e=>{var a;i.push(e);const s=`.tree-node[data-node-index="${i.join(",")}"]`,r=t.querySelector(s);r&&(n(null==(a=r.parentElement)?void 0:a.closest(".tree-node")),n(r))})},c.clearJerarquiaSearch=function(e={}){const t=document.getElementById("jerarquiaSearchSuggestions"),a=document.getElementById("jerarquiaTreeSearchInput");a&&!e.preserveInput&&(a.value=""),t&&(t.innerHTML="",t.classList.remove("active")),this.jerarquiaSearchState.matches=[],this.jerarquiaSearchState.selectedIndex=-1,this.jerarquiaSearchState.lastQuery="",this.jerarquiaSearchState.isFilterActive=!1,this.jerarquiaSearchState.activeMatch=null,this.clearJerarquiaSearchHighlights(),this.resetJerarquiaTreeView(),this.updateJerarquiaSearchStatus("")},window.app=c,window.okrModule=d,window.mapStorage=o,window.mapController=l;let m=100;function h(e){m=Math.max(50,Math.min(150,e));const t=m/100;document.body.style.zoom=t;const a=document.getElementById("zoomLevel");a&&(a.textContent=`${m}%`),localStorage.setItem("appZoom",m)}let g=[],b=[];const v=50;function y(e,t){const a={action:e,data:JSON.parse(JSON.stringify(t)),timestamp:Date.now()};g.push(a),g.length>v&&g.shift(),b=[]}function f(e,t){switch(e.action){case"add":if("undo"===t){const t=c.repuestos.findIndex(t=>t.id===e.data.id);-1!==t&&c.repuestos.splice(t,1)}else c.repuestos.push(e.data);break;case"edit":if("undo"===t){const t=c.repuestos.findIndex(t=>t.id===e.data.original.id);-1!==t&&(c.repuestos[t]=e.data.original)}else{const t=c.repuestos.findIndex(t=>t.id===e.data.edited.id);-1!==t&&(c.repuestos[t]=e.data.edited)}break;case"delete":if("undo"===t)c.repuestos.push(e.data);else{const t=c.repuestos.findIndex(t=>t.id===e.data.id);-1!==t&&c.repuestos.splice(t,1)}}c.render(),c.saveData()}function x(e,t="info"){if(window.app&&"function"==typeof c.showToast)return void c.showToast(e,t);const a=t?`[${t.toUpperCase()}]`:"";("error"===t?console.error:"warning"===t?console.warn:console.log)(`${a} ${e}`)}const S=localStorage.getItem("appZoom");function w(){const e=document.getElementById("screenResolution");if(e){const t=window.innerWidth,a=window.innerHeight,n=(t/a).toFixed(2);e.innerHTML=`${t}${a}<br><small style="font-size: 0.5rem;">${n}:1</small>`}}S&&setTimeout(()=>{h(parseInt(S))},100),document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&("+"===e.key||"="===e.key?(e.preventDefault(),h(m+10)):"-"===e.key||"_"===e.key?(e.preventDefault(),h(m-10)):"0"===e.key?(e.preventDefault(),h(100)):"z"===e.key||"Z"===e.key?(e.preventDefault(),function(){if(0===g.length)return void x("No hay acciones para deshacer","info");const e=g.pop();b.push(e),f(e,"undo"),x(`Deshecho: ${e.action}`,"success")}()):"y"!==e.key&&"Y"!==e.key||(e.preventDefault(),function(){if(0===b.length)return void x("No hay acciones para rehacer","info");const e=b.pop();g.push(e),f(e,"redo"),x(`Rehecho: ${e.action}`,"success")}()))}),w(),window.addEventListener("resize",w);
