<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Diagn√≥stico Firebase - Repuestos</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
    .ok { color: green; }
    .error { color: red; }
    .warning { color: orange; }
    button { padding: 10px 20px; margin: 5px; }
    pre { background: #f5f5f5; padding: 10px; overflow: auto; max-height: 400px; }
  </style>
</head>
<body>
  <h1>üî• Diagn√≥stico Firebase - Sistema de Repuestos</h1>
  
  <div class="section">
    <h2>1. Verificaci√≥n de Firebase</h2>
    <button onclick="checkFirebase()">Verificar Firebase</button>
    <pre id="firebaseStatus"></pre>
  </div>
  
  <div class="section">
    <h2>2. Verificaci√≥n de Autenticaci√≥n</h2>
    <button onclick="checkAuth()">Verificar Auth</button>
    <pre id="authStatus"></pre>
  </div>
  
  <div class="section">
    <h2>3. Contar Repuestos en Firestore</h2>
    <button onclick="countFirestore()">Contar en Firestore</button>
    <pre id="firestoreCount"></pre>
  </div>
  
  <div class="section">
    <h2>4. Contar Repuestos en LocalStorage</h2>
    <button onclick="countLocalStorage()">Contar en LocalStorage</button>
    <pre id="localStorageCount"></pre>
  </div>
  
  <div class="section">
    <h2>5. Crear Repuesto de Prueba</h2>
    <button onclick="createTestRepuesto()">Crear Repuesto TEST</button>
    <pre id="testResult"></pre>
  </div>
  
  <div class="section">
    <h2>6. Verificar Permisos Firestore</h2>
    <button onclick="checkPermissions()">Verificar Permisos</button>
    <pre id="permissionsStatus"></pre>
  </div>
  
  <div class="section">
    <h2>7. Exportar Logs Completos</h2>
    <button onclick="exportLogs()">Exportar Logs</button>
    <pre id="logsExport"></pre>
  </div>

  <script>
    function log(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      const timestamp = new Date().toISOString();
      const className = type === 'ok' ? 'ok' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
      el.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
    }

    async function checkFirebase() {
      const el = document.getElementById('firebaseStatus');
      el.innerHTML = '';
      
      try {
        log('firebaseStatus', 'üîç Verificando Firebase...');
        
        if (!window.firebase) {
          log('firebaseStatus', '‚ùå window.firebase NO est√° definido', 'error');
          return;
        }
        log('firebaseStatus', '‚úÖ window.firebase existe', 'ok');
        
        if (!window.FirebaseApp) {
          log('firebaseStatus', '‚ùå window.FirebaseApp NO est√° definido', 'error');
          return;
        }
        log('firebaseStatus', '‚úÖ window.FirebaseApp existe', 'ok');
        
        if (!window.FirebaseApp.db) {
          log('firebaseStatus', '‚ùå window.FirebaseApp.db NO est√° definido', 'error');
          return;
        }
        log('firebaseStatus', '‚úÖ window.FirebaseApp.db existe (Firestore)', 'ok');
        
        if (!window.FirebaseApp.COLLECTIONS) {
          log('firebaseStatus', '‚ùå window.FirebaseApp.COLLECTIONS NO est√° definido', 'error');
          return;
        }
        log('firebaseStatus', '‚úÖ COLLECTIONS existe', 'ok');
        log('firebaseStatus', `   REPUESTOS: ${window.FirebaseApp.COLLECTIONS.REPUESTOS}`, 'ok');
        
        if (!window.firebaseStorageAdapter) {
          log('firebaseStatus', '‚ùå window.firebaseStorageAdapter NO est√° definido', 'error');
          return;
        }
        log('firebaseStatus', '‚úÖ firebaseStorageAdapter existe', 'ok');
        
        if (!window.firebaseService) {
          log('firebaseStatus', '‚ùå window.firebaseService NO est√° definido', 'error');
          return;
        }
        log('firebaseStatus', '‚úÖ firebaseService existe', 'ok');
        
        log('firebaseStatus', '\n‚úÖ TODOS LOS CHECKS PASARON', 'ok');
        
      } catch (error) {
        log('firebaseStatus', `‚ùå ERROR: ${error.message}`, 'error');
        log('firebaseStatus', error.stack, 'error');
      }
    }

    async function checkAuth() {
      const el = document.getElementById('authStatus');
      el.innerHTML = '';
      
      try {
        log('authStatus', 'üîç Verificando autenticaci√≥n...');
        
        if (!window.firebaseService) {
          log('authStatus', '‚ùå firebaseService no disponible', 'error');
          return;
        }
        
        const isAuth = window.firebaseService.isAuthenticated();
        if (!isAuth) {
          log('authStatus', '‚ùå Usuario NO AUTENTICADO', 'error');
          return;
        }
        log('authStatus', '‚úÖ Usuario autenticado', 'ok');
        
        const user = window.firebaseService.getCurrentUser();
        if (!user) {
          log('authStatus', '‚ö†Ô∏è getCurrentUser() retorn√≥ null', 'warning');
          return;
        }
        
        log('authStatus', `‚úÖ User ID: ${user.uid}`, 'ok');
        log('authStatus', `‚úÖ Email: ${user.email}`, 'ok');
        log('authStatus', `‚úÖ Display Name: ${user.displayName || 'N/A'}`, 'ok');
        
      } catch (error) {
        log('authStatus', `‚ùå ERROR: ${error.message}`, 'error');
      }
    }

    async function countFirestore() {
      const el = document.getElementById('firestoreCount');
      el.innerHTML = '';
      
      try {
        log('firestoreCount', 'üîç Contando repuestos en Firestore...');
        
        if (!window.firebaseStorageAdapter) {
          log('firestoreCount', '‚ùå firebaseStorageAdapter no disponible', 'error');
          return;
        }
        
        const repuestos = await window.firebaseStorageAdapter.cargarRepuestos();
        
        if (!repuestos) {
          log('firestoreCount', '‚ö†Ô∏è cargarRepuestos() retorn√≥ null/undefined', 'warning');
          return;
        }
        
        log('firestoreCount', `‚úÖ Total en Firestore: ${repuestos.length}`, 'ok');
        
        if (repuestos.length > 0) {
          log('firestoreCount', `\nüìã √öltimos 5 repuestos:`, 'ok');
          repuestos.slice(0, 5).forEach((r, i) => {
            log('firestoreCount', `  ${i+1}. ID: ${r.id} | Nombre: ${r.nombre}`, 'ok');
          });
        }
        
      } catch (error) {
        log('firestoreCount', `‚ùå ERROR: ${error.message}`, 'error');
        log('firestoreCount', error.stack, 'error');
      }
    }

    async function countLocalStorage() {
      const el = document.getElementById('localStorageCount');
      el.innerHTML = '';
      
      try {
        log('localStorageCount', 'üîç Contando repuestos en LocalStorage...');
        
        const data = localStorage.getItem('inventarioData');
        if (!data) {
          log('localStorageCount', '‚ö†Ô∏è No hay datos en localStorage', 'warning');
          return;
        }
        
        const repuestos = JSON.parse(data);
        log('localStorageCount', `‚úÖ Total en LocalStorage: ${repuestos.length}`, 'ok');
        
        if (repuestos.length > 0) {
          log('localStorageCount', `\nüìã √öltimos 5 repuestos:`, 'ok');
          repuestos.slice(0, 5).forEach((r, i) => {
            log('localStorageCount', `  ${i+1}. ID: ${r.id} | Nombre: ${r.nombre}`, 'ok');
          });
        }
        
      } catch (error) {
        log('localStorageCount', `‚ùå ERROR: ${error.message}`, 'error');
      }
    }

    async function createTestRepuesto() {
      const el = document.getElementById('testResult');
      el.innerHTML = '';
      
      try {
        log('testResult', 'üî• Creando repuesto de prueba...');
        
        // Crear datos de prueba
        const testData = {
          id: crypto.randomUUID(),
          nombre: `TEST_DIAGNOSTICO_${Date.now()}`,
          SAP: 'TEST001',
          stock: 1,
          stockMinimo: 0,
          ubicaciones: [],
          multimedia: [],
          createdAt: new Date().toISOString()
        };
        
        log('testResult', `üì¶ Repuesto creado: ${testData.id}`, 'ok');
        
        // Intentar guardar en Firestore
        if (!window.firebaseStorageAdapter) {
          log('testResult', '‚ùå firebaseStorageAdapter no disponible', 'error');
          return;
        }
        
        if (!window.firebaseService?.isAuthenticated()) {
          log('testResult', '‚ùå Usuario no autenticado', 'error');
          return;
        }
        
        log('testResult', 'üî• Guardando en Firestore...', 'ok');
        const result = await window.firebaseStorageAdapter.guardarRepuestos([testData]);
        
        if (!result) {
          log('testResult', '‚ùå guardarRepuestos() retorn√≥ false', 'error');
          log('testResult', '‚ö†Ô∏è REVISAR LOGS DE CONSOLA para detalles', 'warning');
          return;
        }
        
        log('testResult', '‚úÖ Guardado en Firestore exitosamente', 'ok');
        
        // Esperar propagaci√≥n
        log('testResult', '‚è±Ô∏è Esperando 1 segundo...', 'ok');
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Verificar que se guard√≥
        log('testResult', 'üîç Verificando en Firestore...', 'ok');
        const repuestos = await window.firebaseStorageAdapter.cargarRepuestos();
        
        const found = repuestos.find(r => r.id === testData.id);
        if (found) {
          log('testResult', '‚úÖ REPUESTO ENCONTRADO EN FIRESTORE!', 'ok');
          log('testResult', JSON.stringify(found, null, 2), 'ok');
        } else {
          log('testResult', '‚ùå REPUESTO NO ENCONTRADO EN FIRESTORE', 'error');
          log('testResult', '‚ö†Ô∏è Esto indica que batch.commit() est√° fallando silenciosamente', 'warning');
        }
        
      } catch (error) {
        log('testResult', `‚ùå ERROR: ${error.message}`, 'error');
        log('testResult', error.stack, 'error');
      }
    }

    async function checkPermissions() {
      const el = document.getElementById('permissionsStatus');
      el.innerHTML = '';
      
      try {
        log('permissionsStatus', 'üîç Verificando permisos de Firestore...');
        
        if (!window.FirebaseApp?.db) {
          log('permissionsStatus', '‚ùå Firestore DB no disponible', 'error');
          return;
        }
        
        const collectionName = window.FirebaseApp.COLLECTIONS?.REPUESTOS || 'repuestos';
        log('permissionsStatus', `üìù Colecci√≥n: ${collectionName}`, 'ok');
        
        // Intentar leer
        log('permissionsStatus', 'üîç Intentando READ...', 'ok');
        try {
          const snapshot = await window.FirebaseApp.db.collection(collectionName).limit(1).get();
          log('permissionsStatus', `‚úÖ READ OK (${snapshot.size} docs)`, 'ok');
        } catch (readError) {
          log('permissionsStatus', `‚ùå READ FAILED: ${readError.message}`, 'error');
        }
        
        // Intentar escribir un documento de prueba
        log('permissionsStatus', 'üîç Intentando WRITE...', 'ok');
        const testDocId = `test_${Date.now()}`;
        try {
          await window.FirebaseApp.db.collection(collectionName).doc(testDocId).set({
            test: true,
            timestamp: new Date().toISOString()
          });
          log('permissionsStatus', '‚úÖ WRITE OK', 'ok');
          
          // Limpiar
          await window.FirebaseApp.db.collection(collectionName).doc(testDocId).delete();
          log('permissionsStatus', '‚úÖ DELETE OK (cleanup)', 'ok');
          
        } catch (writeError) {
          log('permissionsStatus', `‚ùå WRITE FAILED: ${writeError.message}`, 'error');
          log('permissionsStatus', '‚ö†Ô∏è Esto indica problema de permisos en Firestore', 'warning');
          log('permissionsStatus', '‚ö†Ô∏è Revisar firestore.rules', 'warning');
        }
        
      } catch (error) {
        log('permissionsStatus', `‚ùå ERROR: ${error.message}`, 'error');
        log('permissionsStatus', error.stack, 'error');
      }
    }

    function exportLogs() {
      const el = document.getElementById('logsExport');
      el.innerHTML = '';
      
      try {
        log('logsExport', 'üìã Exportando logs...');
        
        const sections = [
          'firebaseStatus',
          'authStatus',
          'firestoreCount',
          'localStorageCount',
          'testResult',
          'permissionsStatus'
        ];
        
        let fullLog = '=== DIAGN√ìSTICO FIREBASE REPUESTOS ===\n';
        fullLog += `Timestamp: ${new Date().toISOString()}\n\n`;
        
        sections.forEach(sectionId => {
          const sectionEl = document.getElementById(sectionId);
          if (sectionEl && sectionEl.textContent.trim()) {
            fullLog += `\n=== ${sectionId.toUpperCase()} ===\n`;
            fullLog += sectionEl.textContent + '\n';
          }
        });
        
        log('logsExport', '‚úÖ Logs exportados', 'ok');
        log('logsExport', '\n' + fullLog, 'ok');
        
        // Copiar al clipboard
        navigator.clipboard.writeText(fullLog).then(() => {
          log('logsExport', '‚úÖ Logs copiados al portapapeles', 'ok');
        }).catch(() => {
          log('logsExport', '‚ö†Ô∏è No se pudo copiar al portapapeles', 'warning');
        });
        
      } catch (error) {
        log('logsExport', `‚ùå ERROR: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>
