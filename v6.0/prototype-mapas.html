<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prototipo - Estructura Tab Mapas v6.0</title>
  <!--
    ========================================
    PROTOTIPO TAB MAPAS - SISTEMA DE SINCRONIZACI√ìN
    ========================================
    
    CARACTER√çSTICAS PRINCIPALES:
    1. Jerarqu√≠a Completa como componente principal
    2. B√∫squeda global en tiempo real con filtrado inteligente
    3. Indicadores visuales sobrios: üó∫Ô∏è (mapa), üì¶ (√°rea), üìç(n) (marcadores)
    4. Sistema de sincronizaci√≥n bidireccional
    
    SISTEMA DE SINCRONIZACI√ìN:
    
    A. EVENTOS EMITIDOS (Prototype ‚Üí App Principal):
       - Evento: 'hierarchy-sync' (CustomEvent)
       - PostMessage: { source: 'prototype-mapas', action: 'node-selected', data: {...} }
       - Trigger: Click en cualquier nodo de la jerarqu√≠a
       - Datos: nodeName, mapId, level, hasMap, timestamp
    
    B. EVENTOS RECIBIDOS (App Principal ‚Üí Prototype):
       - PostMessage con { source: 'app-principal', action: 'navigate-to-node', data: {...} }
       - Acci√≥n autom√°tica: scroll + selecci√≥n + resaltado de rama completa
    
    C. FUNCIONALIDAD CLICK EN NODO:
       1. Limpia selecciones previas
       2. Resalta nodo seleccionado
       3. Resalta rama completa (todos los padres)
       4. Actualiza canvas del mapa (si tiene mapId)
       5. Emite eventos de sincronizaci√≥n
       6. Muestra notificaci√≥n visual temporal
    
    D. B√öSQUEDA GLOBAL:
       - Input: #globalSearch
       - Funci√≥n: filterHierarchy(term)
       - Comportamiento: Filtra nodos, resalta coincidencias, expande ramas, oculta no-coincidentes
    
    INTEGRACI√ìN CON APP PRINCIPAL:
    
    // Desde la app principal, navegar a un nodo:
    const iframe = document.getElementById('prototype-iframe');
    iframe.contentWindow.postMessage({
      source: 'app-principal',
      action: 'navigate-to-node',
      data: { nodeName: 'Eviscerado' }
    }, '*');
    
    // Escuchar eventos del prototype:
    window.addEventListener('message', (event) => {
      if (event.data.source === 'prototype-mapas') {
        console.log('Nodo seleccionado:', event.data.data.nodeName);
        // Sincronizar tabs de Inventario/Jerarqu√≠a/Mapas
      }
    });
    
    ========================================
  -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-app: #1a1d23;
      --bg-primary: #1e2229;
      --bg-secondary: #252a33;
      --bg-tertiary: #2d333d;
      --bg-elevated: #3a4049;
      --border-color: #2d333d;
      --border-light: #3a4049;
      --text-primary: #e6e9ef;
      --text-secondary: #b8bec8;
      --text-muted: #8a909a;
      --primary: #5b8bb4;
      --primary-light: #7ba5c8;
      --success: #5b9b7a;
      --warning: #b8925a;
      --danger: #b86b6b;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.25);
      
      /* Variables minimalistas */
      --spacing-xs: 4px;
      --spacing-sm: 6px;
      --spacing-md: 8px;
      --spacing-lg: 10px;
      --font-xs: 0.65rem;
      --font-sm: 0.7rem;
      --font-md: 0.75rem;
      --font-lg: 0.8rem;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-app);
      color: var(--text-primary);
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }

    /* PANEL DE CONTROL FLOTANTE */
    #controlPanel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 8px;
      width: 48px;
      height: 48px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      z-index: 1000;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    #controlPanel.expanded {
      width: 320px;
      height: auto;
      max-height: 85vh;
      padding: 20px;
      overflow-y: auto;
      cursor: default;
    }

    #controlPanel.collapsed {
      transform: translateX(calc(100% + 20px));
    }

    .control-toggle {
      font-size: 24px;
      text-align: center;
      line-height: 32px;
      transition: transform 0.3s;
      user-select: none;
    }

    #controlPanel.expanded .control-toggle {
      display: none;
    }

    .control-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      display: none;
    }

    #controlPanel.expanded .control-section {
      display: block;
    }

    .control-section:last-child {
      border-bottom: none;
    }

    .control-section h3 {
      font-size: 0.9rem;
      color: var(--primary-light);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .control-group {
      margin-bottom: 12px;
    }

    .control-group label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .control-group input[type="range"],
    .control-group select {
      width: 100%;
      padding: 6px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.75rem;
    }

    .control-group input[type="checkbox"] {
      margin-right: 8px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      font-size: 0.75rem;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .checkbox-label:hover {
      background: var(--bg-primary);
    }

    .value-display {
      display: inline-block;
      background: var(--bg-primary);
      padding: 2px 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.7rem;
      color: var(--primary-light);
      margin-left: 8px;
    }

    .preset-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }

    .preset-btn {
      padding: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .preset-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* LAYOUT PRINCIPAL */
    .map-shell {
      display: grid;
      grid-template-columns: 500px 1fr;
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 8px;
      gap: 8px;
      box-sizing: border-box;
    }

    .map-panel {
      background: var(--bg-secondary);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .map-panel-header {
      display: none; /* Ocultar header para ahorrar espacio */
    }

    .map-panel-header h2 {
      font-size: 1.1rem;
      margin: 0 0 4px 0;
      color: var(--text-primary);
    }

    .map-panel-header p {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin: 0;
    }

    /* TABS DEL PANEL */
    .panel-tabs {
      display: flex;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
      overflow-x: auto;
      scrollbar-width: thin;
    }

    .panel-tab {
      flex: 1;
      min-height: var(--tab-height);
      padding: 10px var(--tab-padding);
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: var(--tab-font-size);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      overflow: hidden;
    }

    .panel-tab-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      transition: font-size 0.2s;
    }

    .panel-tab-icon {
      display: none; /* Ocultar iconos */
    }

    .panel-tab:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }

    .panel-tab.active {
      color: white;
      border-bottom-color: var(--primary-light);
      background: linear-gradient(135deg, rgba(91, 139, 180, 0.35), rgba(91, 139, 180, 0.25));
      box-shadow: 0 3px 10px rgba(91, 139, 180, 0.25);
      font-weight: 700;
    }

    .panel-tab-badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      padding: 2px var(--badge-padding);
      border-radius: 10px;
      font-size: var(--tab-badge-font-size);
      font-weight: 700;
      margin-left: 4px;
      min-width: 18px;
      text-align: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .panel-tab.active .panel-tab-badge {
      background: var(--primary);
      color: white;
    }

    /* Ocultar badges en paneles estrechos */
    .panel-narrow .panel-tab-badge,
    .panel-compact .panel-tab-badge {
      display: none;
    }

    /* Responsive tabs adaptativo por ancho del panel */
    .panel-narrow .panel-tab-text {
      font-size: 9px;
      letter-spacing: 0.3px;
    }

    .panel-compact .panel-tab-text {
      font-size: 10px;
      letter-spacing: 0.4px;
    }

    .panel-standard .panel-tab-text {
      font-size: 11px;
      letter-spacing: 0.5px;
    }

    .panel-wide .panel-tab-text {
      font-size: 12px;
      letter-spacing: 0.6px;
    }

    .panel-extra-wide .panel-tab-text {
      font-size: 13px;
      letter-spacing: 0.7px;
    }

    /* CONTENIDO DE TABS */
    .panel-tab-content {
      display: none;
      flex: 1;
      overflow: hidden;
      min-height: 0;
      position: relative;
    }

    .panel-tab-content.active {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* SIDEBAR DE SUBSECCIONES (izquierda del contenido) */
    .subsections-sidebar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 35px;
      background: rgba(26, 29, 35, 0.98);
      backdrop-filter: blur(10px);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
      padding: 10px 2px;
      gap: 4px;
      overflow: hidden;
      z-index: 100;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
    }

    .subsection-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding: 10px 4px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      flex: 0.6;
      min-height: 60px;
    }

    .subsection-icon {
      display: none;
    }

    .subsection-label {
      writing-mode: vertical-lr;
      transform: rotate(180deg);
      letter-spacing: 1.5px;
      white-space: nowrap;
      text-align: center;
    }

    .subsection-item.active {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.15));
      color: #60a5fa;
      border: 2px solid var(--primary);
      font-weight: 700;
    }

    .subsection-pin {
      display: none;
    }

    /* Contenedor del contenido de la tab */
    .tab-content-wrapper {
      display: flex;
      flex-direction: column;
      min-width: 0;
      overflow: hidden;
      margin-left: 35px;
    }

    /* √Årea fija (bot√≥n y stats) */
    .tab-fixed-header {
      flex-shrink: 0;
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    /* √Årea con scroll */
    .tab-scroll-content {
      flex: 1;
      overflow-y: scroll;
      overflow-x: hidden;
      padding: 10px;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Scrollbar personalizado para el contenido de tabs */
    .tab-scroll-content::-webkit-scrollbar {
      width: 5px;
    }

    .tab-scroll-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.03);
    }

    .tab-scroll-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .tab-scroll-content::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    .map-panel-scroll {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: var(--panel-padding);
      display: flex;
      flex-direction: column;
      gap: var(--section-gap);
    }

    .map-section {
      background: linear-gradient(135deg, rgba(30, 34, 41, 0.9) 0%, rgba(37, 42, 51, 0.85) 100%);
      border-radius: var(--border-radius);
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(91, 139, 180, 0.1);
      border: 1px solid rgba(91, 139, 180, 0.08);
      transition: all 0.2s ease;
    }

    .map-section:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(91, 139, 180, 0.15);
      border-color: rgba(91, 139, 180, 0.12);
    }

    .map-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      cursor: pointer;
      user-select: none;
    }

    .map-section-header h3 {
      font-size: 0.72rem;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .collapse-icon {
      font-size: 0.75rem;
      color: var(--primary-light);
      transition: transform 0.2s ease;
      opacity: 0.7;
    }

    .map-section-header:hover .collapse-icon {
      opacity: 1;
      transform: scale(1.1);
    }

    .map-section.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .map-section.collapsed .section-content {
      display: none;
    }
    
    .section-content {
      font-size: 0.7rem;
      line-height: 1.4;
    }

    /* LISTA JER√ÅRQUICA DE √ÅREAS */
    .area-tree {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .area-tree::-webkit-scrollbar {
      width: 5px;
    }

    .area-tree::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 3px;
    }

    .area-tree::-webkit-scrollbar-thumb {
      background: rgba(91, 139, 180, 0.25);
      border-radius: 3px;
    }

    .area-tree::-webkit-scrollbar-thumb:hover {
      background: rgba(91, 139, 180, 0.4);
    }

    .hierarchy-node {
      background: transparent;
      border-left: 1px solid rgba(100, 100, 100, 0.15);
      border-radius: 0;
      overflow: hidden;
      margin: 1px 0;
    }

    .hierarchy-node.highlighted {
      background: rgba(59, 130, 246, 0.05);
      border-left: 2px solid var(--primary);
    }

    .node-header {
      padding: var(--node-padding);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
      font-size: var(--node-font-size);
      border-radius: 3px;
    }

    .node-header:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .node-header.selected {
      background: rgba(59, 130, 246, 0.12);
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.3);
    }

    .node-header.search-match {
      background: rgba(34, 197, 94, 0.15);
      box-shadow: inset 0 0 0 1px rgba(34, 197, 94, 0.3);
    }

    .node-toggle {
      font-size: 0.7rem;
      width: 12px;
      font-family: monospace;
      color: var(--text-muted);
    }

    .node-badge {
      background: linear-gradient(135deg, rgba(91, 139, 180, 0.15) 0%, rgba(91, 139, 180, 0.1) 100%);
      color: rgba(91, 139, 180, 0.9);
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 0.6rem;
      font-weight: 500;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      border: 1px solid rgba(91, 139, 180, 0.15);
      letter-spacing: 0.2px;
    }

    .node-indicators {
      display: flex;
      align-items: center;
      gap: 3px;
      opacity: 0.7;
    }

    .node-indicator {
      font-size: 0.65rem;
      transition: opacity 0.2s;
    }

    .node-header:hover .node-indicator {
      opacity: 1;
    }

    .node-label {
      flex: 1;
      color: var(--text-secondary);
    }

    .node-count {
      font-size: 0.65rem;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 3px;
    }

    .node-children {
      padding-left: var(--hierarchy-indent);
    }

    .node-children.collapsed {
      display: none;
    }

    /* ANIMACIONES */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* √ÅREA INDIVIDUAL */
    .area-item {
      background: rgba(255, 255, 255, 0.02);
      border-left: 2px solid var(--primary);
      padding: var(--node-padding);
      margin: 2px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background 0.15s;
      font-size: var(--node-font-size);
    }

    .area-item:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .area-badge {
      background: rgba(59, 130, 246, 0.3);
      color: #60a5fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.65rem;
      font-weight: 700;
      font-family: monospace;
    }

    /* CATEGOR√çAS DE MARCADORES */
    .category-group {
      margin: 4px 0;
      border-left: 1px solid rgba(255, 255, 255, 0.05);
    }

    .category-header {
      padding: var(--marker-padding);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: var(--marker-font-size);
      color: var(--text-muted);
      transition: background 0.15s;
    }

    .category-header:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .category-toggle {
      font-size: 0.7rem;
      width: 10px;
      font-family: monospace;
    }

    .category-markers {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .category-markers.collapsed {
      display: none;
    }

    /* MARCADOR DE REPUESTO */
    .marker-item {
      padding: var(--marker-padding);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
      font-size: var(--marker-font-size);
      color: var(--text-muted);
      position: relative;
    }

    .marker-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .marker-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .correlativo-badge {
      background: #222;
      color: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: var(--badge-font-size);
      font-weight: 600;
      font-family: monospace;
      flex-shrink: 0;
    }

    .correlativo-compact {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: var(--badge-font-size);
      font-weight: 600;
      font-family: monospace;
      flex-shrink: 0;
      cursor: help;
    }

    /* CANVAS WORKSPACE */
    .map-workspace {
      background: var(--bg-secondary);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      height: 100%;
      width: 100%;
      border: 1px solid var(--border-color);
    }

    .map-toolbar {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-light);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-shrink: 0;
      width: 100%;
    }

    .toolbar-section {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toolbar-btn {
      padding: 6px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toolbar-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .map-canvas-stage {
      flex: 1;
      background: #0f1419;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .canvas-placeholder {
      text-align: center;
      color: var(--text-muted);
    }

    .canvas-placeholder h3 {
      font-size: 1.5rem;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .canvas-placeholder p {
      font-size: 0.85rem;
    }

    /* SCROLLBAR PERSONALIZADO */
    .map-panel-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .map-panel-scroll::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 4px;
    }

    .map-panel-scroll::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 4px;
    }

    .map-panel-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    /* BUSCADOR Y FILTROS */
    .search-container {
      margin-bottom: 8px;
    }

    .search-input {
      width: 100%;
      padding: 5px 8px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 0.7rem;
    }

    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
    }

    .filter-chip {
      padding: 3px 6px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      color: var(--text-secondary);
      font-size: 0.6rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-chip:hover,
    .filter-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* LOG TIMELINE */
    .log-timeline {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .log-item {
      display: flex;
      gap: 8px;
      padding: 8px;
      background: var(--bg-primary);
      border-radius: 6px;
      border-left: 3px solid var(--border-color);
      transition: all 0.2s;
    }

    .log-item:hover {
      background: rgba(59, 130, 246, 0.05);
      transform: translateX(2px);
    }

    .log-item.log-success {
      border-left-color: var(--success);
    }

    .log-item.log-marker {
      border-left-color: var(--primary);
    }

    .log-item.log-edit {
      border-left-color: var(--warning);
    }

    .log-item.log-delete {
      border-left-color: var(--danger);
    }

    .log-item.log-warning {
      border-left-color: #f59e0b;
    }

    .log-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 4px;
    }

    .log-item.log-success .log-icon {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .log-item.log-marker .log-icon {
      background: rgba(59, 130, 246, 0.15);
      color: var(--primary);
    }

    .log-item.log-edit .log-icon {
      background: rgba(251, 191, 36, 0.15);
      color: var(--warning);
    }

    .log-item.log-delete .log-icon {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    .log-item.log-warning .log-icon {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .log-content {
      flex: 1;
      min-width: 0;
    }

    .log-message {
      font-size: 0.7rem;
      color: var(--text-primary);
      line-height: 1.4;
      margin-bottom: 2px;
    }

    .log-message strong {
      color: var(--primary-light);
      font-weight: 600;
    }

    .log-time {
      font-size: 0.6rem;
      color: var(--text-muted);
    }

    /* BADGE DE JERARQU√çA */
    .jerarquia-badge {
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .jerarquia-info strong {
      display: block;
      font-size: 0.8rem;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .jerarquia-info span {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .jerarquia-btn {
      padding: 6px 12px;
      background: var(--primary);
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 0.7rem;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .jerarquia-btn:hover {
      opacity: 0.8;
    }

    /* BOTONES DE ACCI√ìN */
    .action-buttons {
      display: flex;
      gap: 4px;
    }

    .action-btn {
      flex: 1;
      padding: 5px 4px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 0.65rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    /* STATS */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      flex-shrink: 0;
    }

    .stat-card {
      background: var(--bg-primary);
      padding: 6px;
      border-radius: 4px;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .stat-value {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary-light);
      line-height: 1;
    }

    .stat-label {
      font-size: 0.55rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-top: 2px;
    }

    /* ===== MEJORAS UX/UI ADICIONALES ===== */
    
    /* Animaci√≥n suave para elementos que aparecen */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .map-section, .map-card, .stat-card {
      animation: fadeInUp 0.3s ease-out;
    }

    /* Scroll suave en area-tree */
    .area-tree {
      scroll-behavior: smooth;
    }

    .area-tree::-webkit-scrollbar {
      width: 5px;
    }

    .area-tree::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 3px;
    }

    .area-tree::-webkit-scrollbar-thumb {
      background: rgba(91, 139, 180, 0.25);
      border-radius: 3px;
      transition: background 0.2s;
    }

    .area-tree::-webkit-scrollbar-thumb:hover {
      background: rgba(91, 139, 180, 0.45);
    }

    /* Mejorar √°rea items */
    .area-item {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 4px;
    }

    .area-item:hover {
      background: rgba(91, 139, 180, 0.06) !important;
      transform: translateX(3px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    /* Mejorar map-section-header interactividad */
    .map-section-header {
      transition: all 0.2s ease;
      border-radius: 4px;
      margin: -4px;
      padding: 4px;
    }

    .map-section-header:hover {
      background: rgba(91, 139, 180, 0.05);
    }

    /* Focus visible para accesibilidad */
    button:focus-visible, input:focus-visible {
      outline: 2px solid var(--primary-light);
      outline-offset: 2px;
    }

    /* Mejorar jerarqu√≠a visual de nodos seg√∫n nivel */
    .hierarchy-node .hierarchy-node {
      margin-left: 8px;
      border-left: 1px solid rgba(91, 139, 180, 0.15);
      padding-left: 6px;
    }

    /* Tooltip hover effect para badges */
    .panel-tab-badge:hover {
      transform: scale(1.1);
      background: rgba(91, 139, 180, 0.4);
    }

    /* Loading state para contenedores vac√≠os */
    .section-content:empty::after {
      content: "Cargando...";
      display: block;
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 0.7rem;
      font-style: italic;
    }

    /* Separadores sutiles entre secciones */
    .map-section + .map-section {
      position: relative;
    }

    .map-section + .map-section::before {
      content: '';
      position: absolute;
      top: -3px;
      left: 10%;
      right: 10%;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(91, 139, 180, 0.1), transparent);
    }

    /* Mejorar legibilidad de textos peque√±os */
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
</head>
<body>
  <!-- PANEL DE CONTROL -->
  <div id="controlPanel">
    <div class="control-toggle" onclick="toggleControlPanel(event)">‚öôÔ∏è</div>
    
    <div class="control-section">
      <h3>üé® Dise√±o General</h3>
      
      <div class="control-group">
        <label>Ancho del panel lateral</label>
        <input type="range" id="panelWidth" min="240" max="600" value="500" step="10" oninput="document.getElementById('panelWidthValue').textContent = this.value + 'px'">
        <span class="value-display" id="panelWidthValue">500px</span>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 8px;">
          <button class="preset-btn" onclick="setPanelWidth(280)" style="padding: 4px; font-size: 0.65rem;">Compacto</button>
          <button class="preset-btn" onclick="setPanelWidth(320)" style="padding: 4px; font-size: 0.65rem;">Est√°ndar</button>
          <button class="preset-btn" onclick="setPanelWidth(450)" style="padding: 4px; font-size: 0.65rem;">Ancho</button>
        </div>
      </div>

      <div class="control-group">
        <label>Padding del panel</label>
        <input type="range" id="panelPadding" min="4" max="20" value="6" step="2" oninput="document.getElementById('panelPaddingValue').textContent = this.value + 'px'">
        <span class="value-display" id="panelPaddingValue">6px</span>
      </div>

      <div class="control-group">
        <label>Gap entre secciones</label>
        <input type="range" id="sectionGap" min="2" max="20" value="6" step="2" oninput="document.getElementById('sectionGapValue').textContent = this.value + 'px'">
        <span class="value-display" id="sectionGapValue">6px</span>
      </div>

      <div class="control-group">
        <label>Padding de secciones</label>
        <input type="range" id="sectionPadding" min="6" max="24" value="8" step="2" oninput="document.getElementById('sectionPaddingValue').textContent = this.value + 'px'">
        <span class="value-display" id="sectionPaddingValue">8px</span>
      </div>

      <div class="control-group">
        <label>Border radius (redondeo)</label>
        <input type="range" id="borderRadius" min="4" max="16" value="4" step="2" oninput="document.getElementById('borderRadiusValue').textContent = this.value + 'px'">
        <span class="value-display" id="borderRadiusValue">4px</span>
      </div>

      <div class="control-group">
        <label>Altura del header del panel</label>
        <input type="range" id="headerHeight" min="40" max="80" value="50" step="5" oninput="document.getElementById('headerHeightValue').textContent = this.value + 'px'">
        <span class="value-display" id="headerHeightValue">50px</span>
      </div>

      <div class="control-group">
        <label>Altura de las pesta√±as</label>
        <input type="range" id="tabHeight" min="32" max="56" value="36" step="2" oninput="document.getElementById('tabHeightValue').textContent = this.value + 'px'">
        <span class="value-display" id="tabHeightValue">36px</span>
      </div>

      <div class="control-group">
        <label>Tama√±o fuente pesta√±as</label>
        <input type="range" id="tabFontSize" min="9" max="14" value="10" step="0.5" oninput="document.getElementById('tabFontSizeValue').textContent = this.value + 'px'">
        <span class="value-display" id="tabFontSizeValue">10px</span>
      </div>

      <div class="control-group">
        <label>Padding pesta√±as (horizontal)</label>
        <input type="range" id="tabPadding" min="4" max="16" value="6" step="2" oninput="document.getElementById('tabPaddingValue').textContent = this.value + 'px'">
        <span class="value-display" id="tabPaddingValue">6px</span>
      </div>

      <div class="control-group">
        <label>Tama√±o badges en pesta√±as</label>
        <input type="range" id="tabBadgeFontSize" min="8" max="12" value="9" step="0.5" oninput="document.getElementById('tabBadgeFontSizeValue').textContent = this.value + 'px'">
        <span class="value-display" id="tabBadgeFontSizeValue">10px</span>
      </div>

      <div class="control-group">
        <label>Gap del layout principal</label>
        <input type="range" id="layoutGap" min="4" max="20" value="6" step="2" oninput="document.getElementById('layoutGapValue').textContent = this.value + 'px'">
        <span class="value-display" id="layoutGapValue">6px</span>
      </div>

      <div class="control-group">
        <label class="checkbox-label">
          <input type="checkbox" id="showTabBadges" checked>
          Mostrar badges en pesta√±as (contadores)
        </label>
      </div>

      <div class="control-group">
        <label class="checkbox-label">
          <input type="checkbox" id="showShadows" checked>
          Mostrar sombras (depth)
        </label>
      </div>

      <div class="control-group">
        <label class="checkbox-label">
          <input type="checkbox" id="compactMode">
          Modo ultra-compacto (reduce todo)
        </label>
      </div>

      <button class="preset-btn" onclick="updateLayout()" style="width: 100%; margin-top: 12px; padding: 8px; background: var(--primary); color: white; font-weight: 600;">‚úì Aplicar cambios</button>
    </div>

    <div class="control-section">
      <h3>üìê Jerarqu√≠a</h3>
      
      <div class="control-group">
        <label>Indentaci√≥n por nivel</label>
        <input type="range" id="hierarchyIndent" min="8" max="32" value="12" step="2" oninput="updateLayout()">
        <span class="value-display" id="hierarchyIndentValue">12px</span>
      </div>

      <div class="control-group">
        <label>Tama√±o fuente nodos</label>
        <input type="range" id="nodeFontSize" min="10" max="16" value="11" step="1" oninput="updateLayout()">
        <span class="value-display" id="nodeFontSizeValue">11px</span>
      </div>

      <div class="control-group">
        <label>Padding nodos</label>
        <input type="range" id="nodePadding" min="4" max="12" value="5" step="1" oninput="updateLayout()">
        <span class="value-display" id="nodePaddingValue">5px</span>
      </div>
    </div>

    <div class="control-section">
      <h3>üéØ Marcadores</h3>
      
      <div class="control-group">
        <label>Tama√±o fuente marcadores</label>
        <input type="range" id="markerFontSize" min="9" max="14" value="10" step="0.5" oninput="updateLayout()">
        <span class="value-display" id="markerFontSizeValue">10px</span>
      </div>

      <div class="control-group">
        <label>Padding marcadores</label>
        <input type="range" id="markerPadding" min="3" max="10" value="4" step="1" oninput="updateLayout()">
        <span class="value-display" id="markerPaddingValue">4px</span>
      </div>

      <div class="control-group">
        <label>Tama√±o badges correlativos</label>
        <input type="range" id="badgeFontSize" min="8" max="12" value="9" step="0.5" oninput="updateLayout()">
        <span class="value-display" id="badgeFontSizeValue">9px</span>
      </div>

      <div class="control-group">
        <label class="checkbox-label">
          <input type="checkbox" id="showCorrelatives" checked onchange="updateLayout()">
          Mostrar correlativos individuales (#1, #2, #3...)
        </label>
      </div>

      <div class="control-group">
        <label class="checkbox-label">
          <input type="checkbox" id="useCompactBadge" onchange="updateLayout()">
          Usar badge compacto (x8 en lugar de #1-#8)
        </label>
      </div>
    </div>

    <div class="control-section">
      <h3>üìè T√≠tulos</h3>
      
      <div class="control-group">
        <label>Tama√±o t√≠tulos de secci√≥n</label>
        <input type="range" id="sectionTitleSize" min="10" max="16" value="11" step="1" oninput="updateLayout()">
        <span class="value-display" id="sectionTitleSizeValue">11px</span>
      </div>
    </div>

    <div class="control-section">
      <h3>üé≠ Presets</h3>
      <div class="preset-buttons">
        <button class="preset-btn" onclick="applyPreset('compact')">Compacto</button>
        <button class="preset-btn" onclick="applyPreset('comfortable')">C√≥modo</button>
        <button class="preset-btn" onclick="applyPreset('spacious')">Espacioso</button>
        <button class="preset-btn" onclick="applyPreset('minimal')">Minimalista</button>
        <button class="preset-btn" onclick="applyPreset('ultraMinimal')" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.12)); font-weight: 600;">Ultra Minimal</button>
      </div>
    </div>

    <div class="control-section">
      <h3>üîÑ Sistema de Sincronizaci√≥n</h3>
      <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px; line-height: 1.4;">
        Prueba el sistema de sincronizaci√≥n bidireccional con la app principal
      </div>
      <div class="preset-buttons">
        <button class="preset-btn" onclick="demoSync('Eviscerado')" style="background: rgba(34, 197, 94, 0.15);">
          üéØ Demo: Navegar a "Eviscerado"
        </button>
        <button class="preset-btn" onclick="demoSync('Grader')" style="background: rgba(34, 197, 94, 0.15);">
          üéØ Demo: Navegar a "Grader"
        </button>
        <button class="preset-btn" onclick="showSyncInfo()" style="background: rgba(59, 130, 246, 0.15);">
          üìñ Info Sistema
        </button>
      </div>
      <div id="sync-log" style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.65rem; max-height: 120px; overflow-y: auto; display: none;">
        <div style="color: var(--text-muted); margin-bottom: 4px;">Log de eventos:</div>
        <div id="sync-log-content"></div>
      </div>
    </div>

    <div class="control-section">
      <h3>üñºÔ∏è Layout Canvas</h3>
      
      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:lime;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Ancho workspace <span class="value-display" id="workspaceWidthValue">auto</span></label>
        <input type="range" id="workspaceWidth" min="300" max="2000" value="0" step="50" oninput="document.getElementById('workspaceWidthValue').textContent = this.value > 0 ? this.value + 'px' : 'auto'; updateWorkspaceLayout()">
        <div style="display: flex; gap: 4px; margin-top: 4px;">
          <button class="preset-btn" onclick="setWorkspaceWidth(0)" style="font-size: 0.65rem; padding: 4px;">Auto (1fr)</button>
          <button class="preset-btn" onclick="setWorkspaceWidth(800)" style="font-size: 0.65rem; padding: 4px;">800px</button>
          <button class="preset-btn" onclick="setWorkspaceWidth(1200)" style="font-size: 0.65rem; padding: 4px;">1200px</button>
        </div>
      </div>

      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:red;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Gap entre paneles <span class="value-display" id="shellGapValue">0px</span></label>
        <input type="range" id="shellGap" min="0" max="50" value="0" step="2" oninput="document.getElementById('shellGapValue').textContent = this.value + 'px'; updateWorkspaceLayout()">
      </div>

      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:red;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Padding shell <span class="value-display" id="shellPaddingValue">0px</span></label>
        <input type="range" id="shellPadding" min="0" max="50" value="0" step="2" oninput="document.getElementById('shellPaddingValue').textContent = this.value + 'px'; updateWorkspaceLayout()">
      </div>

      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:yellow;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Ancho map-toolbar <span class="value-display" id="toolbarWidthValue">100%</span></label>
        <input type="range" id="toolbarWidth" min="300" max="2000" value="0" step="50" oninput="document.getElementById('toolbarWidthValue').textContent = this.value > 0 ? this.value + 'px' : '100%'; updateWorkspaceLayout()">
      </div>

      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:cyan;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Ancho map-canvas-stage <span class="value-display" id="canvasWidthValue">100%</span></label>
        <input type="range" id="canvasWidth" min="300" max="2000" value="0" step="50" oninput="document.getElementById('canvasWidthValue').textContent = this.value > 0 ? this.value + 'px' : '100%'; updateWorkspaceLayout()">
      </div>

      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:lime;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Max-width workspace <span class="value-display" id="workspaceMaxWidthValue">none</span></label>
        <input type="range" id="workspaceMaxWidth" min="0" max="2000" value="0" step="50" oninput="document.getElementById('workspaceMaxWidthValue').textContent = this.value > 0 ? this.value + 'px' : 'none'; updateWorkspaceLayout()">
      </div>

      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:lime;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Min-width workspace <span class="value-display" id="workspaceMinWidthValue">0</span></label>
        <input type="range" id="workspaceMinWidth" min="0" max="1000" value="0" step="50" oninput="document.getElementById('workspaceMinWidthValue').textContent = this.value + 'px'; updateWorkspaceLayout()">
      </div>

      <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 12px 0;">
      <div style="font-size: 0.7rem; color: var(--primary-light); margin-bottom: 8px;">üîµ Panel lateral (azul)</div>

      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:magenta;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Ancho panel-tab-content <span class="value-display" id="tabContentWidthValue">500px</span></label>
        <input type="range" id="tabContentWidth" min="300" max="1000" value="500" step="10" oninput="document.getElementById('tabContentWidthValue').textContent = this.value > 0 ? this.value + 'px' : '100%'; updateWorkspaceLayout()">
      </div>

      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:orange;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Ancho tab-content-wrapper <span class="value-display" id="contentWrapperWidthValue">500px</span></label>
        <input type="range" id="contentWrapperWidth" min="300" max="1000" value="500" step="10" oninput="document.getElementById('contentWrapperWidthValue').textContent = this.value > 0 ? this.value + 'px' : '100%'; updateWorkspaceLayout()">
      </div>

      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:purple;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Ancho tab-scroll-content <span class="value-display" id="scrollContentWidthValue">470px</span></label>
        <input type="range" id="scrollContentWidth" min="300" max="1000" value="470" step="10" oninput="document.getElementById('scrollContentWidthValue').textContent = this.value > 0 ? this.value + 'px' : '100%'; updateWorkspaceLayout()">
      </div>

      <div class="control-group">
        <label><span style="display:inline-block;width:12px;height:12px;background:blue;border:1px solid #000;margin-right:6px;vertical-align:middle;"></span>Max-width panel <span class="value-display" id="panelMaxWidthValue">500px</span></label>
        <input type="range" id="panelMaxWidth" min="0" max="1000" value="500" step="10" oninput="document.getElementById('panelMaxWidthValue').textContent = this.value > 0 ? this.value + 'px' : 'none'; updateWorkspaceLayout()">
      </div>

      <div class="control-group">
        <label class="checkbox-label">
          <input type="checkbox" id="workspaceBorderRadius" onchange="updateWorkspaceLayout()">
          Border radius en paneles
        </label>
      </div>

      <div class="control-group">
        <label class="checkbox-label">
          <input type="checkbox" id="workspaceShadows" onchange="updateWorkspaceLayout()">
          Sombras en paneles
        </label>
      </div>

      <div class="control-group">
        <label class="checkbox-label">
          <input type="checkbox" id="debugBorders" onchange="updateWorkspaceLayout()">
          üêõ Debug: Mostrar bordes de contenedores
        </label>
      </div>

      <button class="preset-btn" onclick="updateWorkspaceLayout()" style="width: 100%; margin-top: 12px; padding: 8px; background: var(--primary); color: white; font-weight: 600;">‚úì Aplicar cambios</button>

      <div style="margin-top: 12px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-size: 0.65rem; color: var(--text-secondary);">
        üí° Tip: Activa "Debug" para ver los l√≠mites de cada contenedor
      </div>
    </div>

    <div class="control-section">
      <h3>üíæ Exportar</h3>
      <button class="preset-btn" onclick="exportCSS()" style="width: 100%">
        Copiar CSS al portapapeles
      </button>
    </div>
  </div>

  <!-- LAYOUT PRINCIPAL -->
  <div class="map-shell">
    <!-- PANEL LATERAL -->
    <aside class="map-panel">
      <div class="map-panel-header">
        <h2>Mapas de planta</h2>
        <p>Gestiona mapas, zonas y jerarqu√≠as</p>
      </div>

      <!-- TABS DE NAVEGACI√ìN -->
      <div class="panel-tabs">
        <button class="panel-tab active" onclick="switchPanelTab('mapas')">
          <span class="panel-tab-text">Mapas</span>
          <span class="panel-tab-badge">-</span>
        </button>
        <button class="panel-tab" onclick="switchPanelTab('logs')">
          <span class="panel-tab-text">Logs</span>
        </button>
      </div>

      <!-- CONTENIDO: MAPAS -->
      <div id="tabMapas" class="panel-tab-content active">
        <!-- Sidebar de subsecciones -->
        <nav class="subsections-sidebar" id="subsectionsSidebar">
          <button class="subsection-item active" onclick="scrollToSection('jerarquia-completa')">
            <span class="subsection-icon">J</span>
            <span class="subsection-label">Jerarqu√≠a Completa</span>
          </button>
          <button class="subsection-item" onclick="scrollToSection('mapas-creados')">
            <span class="subsection-icon">M</span>
            <span class="subsection-label">Mapas Creados</span>
          </button>
          <button class="subsection-item" onclick="scrollToSection('pendientes')">
            <span class="subsection-icon">P</span>
            <span class="subsection-label">Pendientes</span>
          </button>
          <button class="subsection-item" onclick="scrollToSection('estadisticas')">
            <span class="subsection-icon">E</span>
            <span class="subsection-label">Estad√≠sticas</span>
          </button>
        </nav>

        <!-- Contenedor del contenido -->
        <div class="tab-content-wrapper">
          <!-- √Årea fija -->
          <div class="tab-fixed-header">
            <!-- Buscador global -->
            <div class="search-container">
              <input type="text" id="globalSearch" class="search-input" placeholder="üîé Buscar en jerarqu√≠a..." oninput="filterHierarchy(this.value)">
            </div>

            <!-- Stats generales -->
            <div class="stats-row" style="margin-top: 6px;">
              <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Mapas</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">√Åreas</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Marcadores</div>
              </div>
            </div>
          </div>

          <!-- √Årea con scroll -->
          <div class="tab-scroll-content">

        <!-- 1. JERARQU√çA COMPLETA - SECCI√ìN PRINCIPAL -->
        <section class="map-section" id="section-jerarquia-completa">
          <div class="map-section-header" onclick="toggleSection(this)">
            <h3><span class="collapse-icon">‚ñº</span> üè¢ Jerarqu√≠a Completa</h3>
          </div>
          <div class="section-content">
            <div style="font-size: 0.6rem; color: var(--text-muted); margin-bottom: 8px; padding: 6px 8px; background: rgba(59, 130, 246, 0.05); border-radius: 4px; border-left: 2px solid var(--primary);">
              üí° <strong>Indicadores:</strong> üó∫Ô∏è Mapa asignado ‚Ä¢ üì¶ √Årea creada ‚Ä¢ üìç Marcadores (numerados)
            </div>
            <div id="hierarchy-tree-container" class="area-tree">
              <!-- La jerarqu√≠a completa se cargar√° din√°micamente aqu√≠ -->
            </div>
          </div>
        </section>

        <!-- 2. MAPAS CREADOS - LISTA COMPACTA -->
        <section class="map-section" id="section-mapas-creados">
          <div class="map-section-header" onclick="toggleSection(this)">
            <h3><span class="collapse-icon">‚ñº</span> üó∫Ô∏è Mapas Creados (<span id="mapasCount">0</span>)</h3>
          </div>
          <div class="section-content">
            <!-- Los mapas se cargar√°n din√°micamente desde mapas.json -->
          </div>
        </section>

        <!-- 3. PENDIENTES - ELEMENTOS SIN ASIGNAR -->
        <section class="map-section" id="section-pendientes">
          <div class="map-section-header" onclick="toggleSection(this)">
            <h3><span class="collapse-icon">‚ñº</span> ‚ö†Ô∏è Pendientes</h3>
          </div>
          <div class="section-content">
            <div style="font-size: 0.62rem; color: var(--text-muted); padding: 12px; text-align: center;">
              Elementos sin mapa o √°rea asignada
            </div>
          </div>
        </section>

        <!-- 4. ESTAD√çSTICAS - RESUMEN VISUAL -->
        <section class="map-section" id="section-estadisticas">
          <div class="map-section-header" onclick="toggleSection(this)">
            <h3><span class="collapse-icon">‚ñº</span> üìä Estad√≠sticas</h3>
          </div>
          <div class="section-content">
            <div id="stats-details-container">
              <!-- Estad√≠sticas detalladas se cargar√°n aqu√≠ -->
            </div>
          </div>
        </section>

        </div> <!-- Fin tab-scroll-content -->
        </div> <!-- Fin tab-content-wrapper -->
      </div> <!-- Fin tabMapas -->

      <!-- CONTENIDO: √ÅREAS (OCULTO - NO SE USA) -->
      <div id="tabAreas" class="panel-tab-content">
        <!-- Sidebar de subsecciones -->
        <nav class="subsections-sidebar" id="subsectionsSidebarAreas">
          <button class="subsection-item active" onclick="scrollToSection('areas-todas')">
            <span class="subsection-icon">A</span>
            <span class="subsection-label">Todas</span>
          </button>
          <button class="subsection-item" onclick="scrollToSection('areas-jerarquia')">
            <span class="subsection-icon">J</span>
            <span class="subsection-label">Jerarqu√≠a</span>
          </button>
          <button class="subsection-pin" onclick="toggleSubsectionPin()">
            ‚ñ∏ Anclar
          </button>
        </nav>

        <!-- Contenedor del contenido -->
        <div class="tab-content-wrapper">
          <!-- √Årea fija -->
          <div class="tab-fixed-header">
            <!-- Bot√≥n nueva √°rea -->
            <button class="action-btn" style="width: 100%; padding: 5px 8px; font-size: 0.65rem; background: var(--success); color: white; border-color: var(--success);">
              + Crear nueva √°rea
            </button>

            <!-- Stats generales -->
            <div class="stats-row" style="margin-top: 6px;">
              <div class="stat-card">
                <div class="stat-value">37</div>
                <div class="stat-label">Total √°reas</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">30</div>
                <div class="stat-label">Con equipos</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">7</div>
                <div class="stat-label">Vac√≠as</div>
              </div>
            </div>

            <!-- Buscador -->
            <div class="search-container" style="margin-top: 8px;">
              <input type="text" class="search-input" placeholder="üîé Buscar √°rea...">
            </div>
          </div>

          <!-- √Årea con scroll -->
          <div class="tab-scroll-content">

            <!-- Secci√≥n: Todas las √°reas -->
            <section class="map-section" id="section-areas-todas">
              <div class="map-section-header" onclick="toggleSection(this)">
                <h3><span class="collapse-icon">‚ñº</span> üì¶ √Åreas creadas (37)</h3>
              </div>
              <div class="section-content">
                <div id="areas-list-container">
                  <!-- Las √°reas se cargar√°n din√°micamente aqu√≠ -->
                  <p style="color: var(--text-muted); font-size: 0.7rem; text-align: center; padding: 20px;">
                    Cargando √°reas...
                  </p>
                </div>
              </div>
            </section>

            <!-- Secci√≥n: Vista jer√°rquica -->
            <section class="map-section" id="section-areas-jerarquia">
              <div class="map-section-header" onclick="toggleSection(this)">
                <h3><span class="collapse-icon">‚ñº</span> üè¢ Vista jer√°rquica</h3>
              </div>
              <div class="section-content">
                <div style="font-size: 0.65rem; color: var(--text-muted); margin-bottom: 6px; padding: 4px; background: rgba(59, 130, 246, 0.05); border-radius: 3px;">
                  Estructura completa de √°reas organizadas por jerarqu√≠a
                </div>

                <div class="area-tree">
                  <!-- El √°rbol se cargar√° din√°micamente aqu√≠ -->
                  <p style="color: var(--text-muted); font-size: 0.7rem; text-align: center; padding: 20px;">
                    Cargando jerarqu√≠a...
                  </p>
                </div>
              </div>
            </section>

          </div> <!-- Fin tab-scroll-content -->
        </div> <!-- Fin tab-content-wrapper -->
      </div>

      <!-- CONTENIDO: LOGS -->
      <div id="tabLogs" class="panel-tab-content">
        <!-- √Årea fija superior: Filtros -->
        <div class="tab-fixed-header">
          <section class="map-section" style="margin: 0;">
            <div class="map-section-header" onclick="toggleSection(this)">
              <h3><span class="collapse-icon">‚ñº</span> Filtrar por Tipo</h3>
            </div>
            <div class="section-content">
              <div class="filter-chips">
                <span class="filter-chip active" onclick="filterLogs('all')">Todos</span>
                <span class="filter-chip" onclick="filterLogs('success')">Creaci√≥n</span>
                <span class="filter-chip" onclick="filterLogs('edit')">Edici√≥n</span>
                <span class="filter-chip" onclick="filterLogs('delete')">Eliminaci√≥n</span>
                <span class="filter-chip" onclick="filterLogs('marker')">Marcadores</span>
                <span class="filter-chip" onclick="filterLogs('warning')">Jerarqu√≠a</span>
              </div>
            </div>
          </section>
        </div>

        <!-- √Årea con scroll: Actividad Reciente (ocupa todo el espacio) -->
        <div class="tab-scroll-content" style="flex: 1; overflow-y: auto;">
          <div class="log-timeline">
            <div class="log-item log-success">
              <div class="log-icon">‚úì</div>
              <div class="log-content">
                <div class="log-message">√Årea creada: <strong>"Grader Principal"</strong></div>
                <div class="log-time">Hace 5 minutos</div>
              </div>
            </div>
            <div class="log-item log-marker">
              <div class="log-icon">üìç</div>
              <div class="log-content">
                <div class="log-message">Marcador agregado: <strong>"PARADA EMERGENCIA"</strong></div>
                <div class="log-time">Hace 12 minutos</div>
              </div>
            </div>
            <div class="log-item log-edit">
              <div class="log-icon">‚úèÔ∏è</div>
              <div class="log-content">
                <div class="log-message">√Årea editada: <strong>"Cinta Transversal"</strong></div>
                <div class="log-time">Hace 1 hora</div>
              </div>
            </div>
            <div class="log-item log-delete">
              <div class="log-icon">‚úó</div>
              <div class="log-content">
                <div class="log-message">√Årea eliminada: <strong>"Zona Temporal"</strong></div>
                <div class="log-time">Hace 2 horas</div>
              </div>
            </div>
            <div class="log-item log-success">
              <div class="log-icon">‚úì</div>
              <div class="log-content">
                <div class="log-message">Mapa creado: <strong>"Plano Oficinas"</strong></div>
                <div class="log-time">Hace 3 horas</div>
              </div>
            </div>
            <div class="log-item log-marker">
              <div class="log-icon">üìç</div>
              <div class="log-content">
                <div class="log-message">Marcador movido: <strong>"MOTOR TRIF√ÅSICO"</strong></div>
                <div class="log-time">Hace 4 horas</div>
              </div>
            </div>
            <div class="log-item log-warning">
              <div class="log-icon">‚ö†Ô∏è</div>
              <div class="log-content">
                <div class="log-message">Jerarqu√≠a modificada: <strong>"Planta Grader"</strong></div>
                <div class="log-time">Hace 5 horas</div>
              </div>
            </div>
            <div class="log-item log-success">
              <div class="log-icon">üíæ</div>
              <div class="log-content">
                <div class="log-message">Backup autom√°tico completado</div>
                <div class="log-time">Hace 6 horas</div>
              </div>
            </div>
          </div>
        </div>

        <!-- √Årea fija inferior: Controles -->
        <div style="padding: 8px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
          <div style="display: flex; gap: 6px; align-items: center;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.7rem; color: var(--text-secondary); cursor: pointer;">
              <input type="checkbox" id="autoRefreshLogs" checked style="cursor: pointer;">
              Actualizar logs
            </label>
            <button class="action-btn" onclick="refreshLogs()" style="flex: 1; padding: 5px 8px; font-size: 0.65rem;">
              üîÑ Refrescar ahora
            </button>
          </div>
        </div>
      </div>
    </aside>

    <!-- WORKSPACE CANVAS -->
    <div class="map-workspace">
      <div class="map-toolbar">
        <div class="toolbar-section">
          <button class="toolbar-btn">+ Zoom</button>
          <button class="toolbar-btn">- Zoom</button>
          <button class="toolbar-btn">Reset</button>
        </div>
        <div class="toolbar-section">
          <span style="font-size: 0.8rem; color: var(--text-secondary)">100% | Mapa General</span>
        </div>
        <div class="toolbar-section">
          <button class="toolbar-btn">Nombres</button>
          <button class="toolbar-btn">Puntos</button>
          <button class="toolbar-btn">Rejilla</button>
          <button class="toolbar-btn">Minimap</button>
        </div>
      </div>

      <div class="map-canvas-stage">
        <div class="canvas-placeholder">
          <h3>üó∫Ô∏è Canvas del Mapa</h3>
          <p>Aqu√≠ se renderizar√° el mapa con √°reas y marcadores</p>
          <p style="margin-top: 8px; font-size: 0.75rem; color: var(--text-muted)">
            Usa el panel de control ‚Üí para ajustar el dise√±o del panel lateral
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables CSS din√°micas
    function updateLayout() {
      const root = document.documentElement;
      
      // Obtener valores
      const panelWidth = document.getElementById('panelWidth').value;
      const panelPadding = document.getElementById('panelPadding').value;
      const sectionGap = document.getElementById('sectionGap').value;
      const sectionPadding = document.getElementById('sectionPadding').value;
      const hierarchyIndent = document.getElementById('hierarchyIndent').value;
      const nodeFontSize = document.getElementById('nodeFontSize').value;
      const nodePadding = document.getElementById('nodePadding').value;
      const markerFontSize = document.getElementById('markerFontSize').value;
      const markerPadding = document.getElementById('markerPadding').value;
      const badgeFontSize = document.getElementById('badgeFontSize').value;
      const sectionTitleSize = document.getElementById('sectionTitleSize').value;
      const borderRadius = document.getElementById('borderRadius').value;
      const headerHeight = document.getElementById('headerHeight').value;
      const tabHeight = document.getElementById('tabHeight').value;
      const tabFontSize = document.getElementById('tabFontSize').value;
      const tabPadding = document.getElementById('tabPadding').value;
      const tabBadgeFontSize = document.getElementById('tabBadgeFontSize').value;
      const layoutGap = document.getElementById('layoutGap').value;
      const showCorrelatives = document.getElementById('showCorrelatives').checked;
      const useCompactBadge = document.getElementById('useCompactBadge').checked;
      const showShadows = document.getElementById('showShadows').checked;
      const showTabBadges = document.getElementById('showTabBadges').checked;
      const compactMode = document.getElementById('compactMode').checked;
      
      // Calcular valores adaptativos seg√∫n ancho del panel
      const panelWidthNum = parseInt(panelWidth);
      let adaptiveTabFontSize, adaptiveTabPadding, adaptiveBadgePadding, adaptiveTabBadgeFontSize;
      let panelSizeClass;
      
      if (panelWidthNum <= 280) {
        // Panel muy estrecho
        adaptiveTabFontSize = 9;
        adaptiveTabPadding = Math.max(4, parseInt(tabPadding) - 4);
        adaptiveBadgePadding = 3;
        adaptiveTabBadgeFontSize = Math.max(8, parseFloat(tabBadgeFontSize) - 1.5);
        panelSizeClass = 'panel-narrow';
      } else if (panelWidthNum <= 320) {
        // Panel compacto
        adaptiveTabFontSize = 10;
        adaptiveTabPadding = Math.max(5, parseInt(tabPadding) - 2);
        adaptiveBadgePadding = 4;
        adaptiveTabBadgeFontSize = Math.max(9, parseFloat(tabBadgeFontSize) - 1);
        panelSizeClass = 'panel-compact';
      } else if (panelWidthNum <= 380) {
        // Panel est√°ndar
        adaptiveTabFontSize = 11;
        adaptiveTabPadding = tabPadding;
        adaptiveBadgePadding = 5;
        adaptiveTabBadgeFontSize = tabBadgeFontSize;
        panelSizeClass = 'panel-standard';
      } else if (panelWidthNum <= 480) {
        // Panel ancho
        adaptiveTabFontSize = 12;
        adaptiveTabPadding = parseInt(tabPadding) + 2;
        adaptiveBadgePadding = 6;
        adaptiveTabBadgeFontSize = parseFloat(tabBadgeFontSize) + 0.5;
        panelSizeClass = 'panel-wide';
      } else {
        // Panel muy ancho
        adaptiveTabFontSize = 13;
        adaptiveTabPadding = parseInt(tabPadding) + 4;
        adaptiveBadgePadding = 7;
        adaptiveTabBadgeFontSize = parseFloat(tabBadgeFontSize) + 1;
        panelSizeClass = 'panel-extra-wide';
      }
      
      // Aplicar clase de tama√±o al panel
      const mapPanel = document.querySelector('.map-panel');
      if (mapPanel) {
        mapPanel.className = 'map-panel ' + panelSizeClass;
      }
      
      // Mostrar/ocultar badges seg√∫n preferencia del usuario y ancho del panel
      document.querySelectorAll('.panel-tab-badge').forEach(badge => {
        if (!showTabBadges || panelWidthNum <= 320) {
          badge.style.display = 'none';
        } else {
          badge.style.display = 'inline-block';
        }
      });
      
      // Modo compacto override
      if (compactMode) {
        root.style.setProperty('--panel-width', '280px');
        root.style.setProperty('--panel-padding', '4px');
        root.style.setProperty('--section-gap', '4px');
        root.style.setProperty('--section-padding', '8px');
        root.style.setProperty('--hierarchy-indent', '10px');
        root.style.setProperty('--node-font-size', '10px');
        root.style.setProperty('--node-padding', '3px');
        root.style.setProperty('--marker-font-size', '9px');
        root.style.setProperty('--marker-padding', '3px');
        root.style.setProperty('--badge-font-size', '8px');
        root.style.setProperty('--section-title-size', '10px');
        root.style.setProperty('--border-radius', '6px');
        root.style.setProperty('--header-height', '45px');
        root.style.setProperty('--tab-height', '34px');
        root.style.setProperty('--tab-font-size', '9px');
        root.style.setProperty('--tab-padding', '4px');
        root.style.setProperty('--tab-badge-font-size', '8px');
        root.style.setProperty('--badge-padding', '3px');
        root.style.setProperty('--layout-gap', '4px');
        
        // Aplicar clase de tama√±o compacto
        const mapPanel = document.querySelector('.map-panel');
        if (mapPanel) {
          mapPanel.className = 'map-panel panel-narrow';
        }
      } else {
        // Aplicar valores normales (con adaptaci√≥n seg√∫n ancho)
        root.style.setProperty('--panel-width', panelWidth + 'px');
        root.style.setProperty('--panel-padding', panelPadding + 'px');
        root.style.setProperty('--section-gap', sectionGap + 'px');
        root.style.setProperty('--section-padding', sectionPadding + 'px');
        root.style.setProperty('--hierarchy-indent', hierarchyIndent + 'px');
        root.style.setProperty('--node-font-size', nodeFontSize + 'px');
        root.style.setProperty('--node-padding', nodePadding + 'px');
        root.style.setProperty('--marker-font-size', markerFontSize + 'px');
        root.style.setProperty('--marker-padding', markerPadding + 'px');
        root.style.setProperty('--badge-font-size', badgeFontSize + 'px');
        root.style.setProperty('--section-title-size', sectionTitleSize + 'px');
        root.style.setProperty('--border-radius', borderRadius + 'px');
        root.style.setProperty('--header-height', headerHeight + 'px');
        root.style.setProperty('--tab-height', tabHeight + 'px');
        root.style.setProperty('--tab-font-size', adaptiveTabFontSize + 'px');
        root.style.setProperty('--tab-padding', adaptiveTabPadding + 'px');
        root.style.setProperty('--tab-badge-font-size', adaptiveTabBadgeFontSize + 'px');
        root.style.setProperty('--badge-padding', adaptiveBadgePadding + 'px');
        root.style.setProperty('--layout-gap', layoutGap + 'px');
      }
      
      // Sombras
      const shadowValue = showShadows ? 'var(--shadow-md)' : 'none';
      const sectionShadowValue = showShadows ? 'var(--shadow-sm)' : 'none';
      root.style.setProperty('--panel-shadow', shadowValue);
      root.style.setProperty('--section-shadow', sectionShadowValue);
      
      // Actualizar displays
      document.getElementById('panelWidthValue').textContent = (compactMode ? '280' : panelWidth) + 'px';
      document.getElementById('panelPaddingValue').textContent = (compactMode ? '4' : panelPadding) + 'px';
      document.getElementById('sectionGapValue').textContent = (compactMode ? '4' : sectionGap) + 'px';
      document.getElementById('sectionPaddingValue').textContent = (compactMode ? '8' : sectionPadding) + 'px';
      document.getElementById('hierarchyIndentValue').textContent = (compactMode ? '10' : hierarchyIndent) + 'px';
      document.getElementById('nodeFontSizeValue').textContent = (compactMode ? '10' : nodeFontSize) + 'px';
      document.getElementById('nodePaddingValue').textContent = (compactMode ? '3' : nodePadding) + 'px';
      document.getElementById('markerFontSizeValue').textContent = (compactMode ? '9' : markerFontSize) + 'px';
      document.getElementById('markerPaddingValue').textContent = (compactMode ? '3' : markerPadding) + 'px';
      document.getElementById('badgeFontSizeValue').textContent = (compactMode ? '8' : badgeFontSize) + 'px';
      document.getElementById('sectionTitleSizeValue').textContent = (compactMode ? '10' : sectionTitleSize) + 'px';
      document.getElementById('borderRadiusValue').textContent = (compactMode ? '6' : borderRadius) + 'px';
      document.getElementById('headerHeightValue').textContent = (compactMode ? '45' : headerHeight) + 'px';
      document.getElementById('tabHeightValue').textContent = (compactMode ? '34' : tabHeight) + 'px';
      document.getElementById('tabFontSizeValue').textContent = (compactMode ? '9' : adaptiveTabFontSize) + 'px';
      document.getElementById('tabPaddingValue').textContent = (compactMode ? '4' : adaptiveTabPadding) + 'px';
      document.getElementById('tabBadgeFontSizeValue').textContent = (compactMode ? '8' : adaptiveTabBadgeFontSize) + 'px';
      document.getElementById('layoutGapValue').textContent = (compactMode ? '4' : layoutGap) + 'px';
      
      // Mostrar/ocultar correlativos
      document.querySelectorAll('.correlativo-badge').forEach(badge => {
        if (useCompactBadge) {
          badge.style.display = 'none';
        } else {
          badge.style.display = showCorrelatives ? 'inline-block' : 'none';
        }
      });

      document.querySelectorAll('.correlativo-compact').forEach(badge => {
        badge.style.display = useCompactBadge ? 'inline-block' : 'none';
      });
      
      // Recalcular expansi√≥n del sidebar despu√©s de cambiar el ancho del panel
      document.querySelectorAll('.subsections-sidebar').forEach(sidebar => {
        if (sidebar.classList.contains('pinned') || sidebar.matches(':hover')) {
          updatePanelWidth(sidebar);
        }
      });
    }

    // Quick set panel width
    function setPanelWidth(width) {
      document.getElementById('panelWidth').value = width;
      updateLayout();
    }

    // Presets
    function applyPreset(preset) {
      const presets = {
        compact: {
          panelWidth: 300,
          panelPadding: 6,
          sectionGap: 6,
          sectionPadding: 10,
          hierarchyIndent: 12,
          nodeFontSize: 11,
          nodePadding: 4,
          markerFontSize: 10,
          markerPadding: 4,
          badgeFontSize: 9,
          sectionTitleSize: 11,
          borderRadius: 8,
          headerHeight: 55,
          tabHeight: 40,
          tabFontSize: 10.5,
          tabPadding: 7,
          tabBadgeFontSize: 9.5,
          layoutGap: 6
        },
        comfortable: {
          panelWidth: 360,
          panelPadding: 8,
          sectionGap: 8,
          sectionPadding: 12,
          hierarchyIndent: 16,
          nodeFontSize: 12,
          nodePadding: 6,
          markerFontSize: 11,
          markerPadding: 5,
          badgeFontSize: 10,
          sectionTitleSize: 12,
          borderRadius: 8,
          headerHeight: 60,
          tabHeight: 42,
          tabFontSize: 11,
          tabPadding: 8,
          tabBadgeFontSize: 10,
          layoutGap: 8
        },
        spacious: {
          panelWidth: 450,
          panelPadding: 12,
          sectionGap: 12,
          sectionPadding: 16,
          hierarchyIndent: 20,
          nodeFontSize: 13,
          nodePadding: 8,
          markerFontSize: 12,
          markerPadding: 6,
          badgeFontSize: 11,
          sectionTitleSize: 13,
          borderRadius: 12,
          headerHeight: 70,
          tabHeight: 48,
          tabFontSize: 12,
          tabPadding: 12,
          tabBadgeFontSize: 11,
          layoutGap: 12
        },
        minimal: {
          panelWidth: 280,
          panelPadding: 4,
          sectionGap: 4,
          sectionPadding: 8,
          hierarchyIndent: 10,
          nodeFontSize: 10,
          nodePadding: 3,
          markerFontSize: 9,
          markerPadding: 3,
          badgeFontSize: 8,
          sectionTitleSize: 10,
          borderRadius: 6,
          headerHeight: 45,
          tabHeight: 34,
          tabFontSize: 9.5,
          tabPadding: 6,
          tabBadgeFontSize: 8.5,
          layoutGap: 4
        },
        ultraMinimal: {
          panelWidth: 320,
          panelPadding: 4,
          sectionGap: 2,
          sectionPadding: 6,
          hierarchyIndent: 8,
          nodeFontSize: 10,
          nodePadding: 4,
          markerFontSize: 9,
          markerPadding: 3,
          badgeFontSize: 8,
          sectionTitleSize: 10,
          borderRadius: 4,
          headerHeight: 40,
          tabHeight: 32,
          tabFontSize: 10,
          tabPadding: 5,
          tabBadgeFontSize: 9,
          layoutGap: 4
        }
      };

      const config = presets[preset];
      if (!config) return;

      // Desactivar modo compacto
      document.getElementById('compactMode').checked = false;

      Object.keys(config).forEach(key => {
        const input = document.getElementById(key);
        if (input) {
          input.value = config[key];
        }
      });

      updateLayout();
    }

    // Export CSS
    function exportCSS() {
      const root = document.documentElement;
      const css = `
/* Variables CSS personalizadas - Tab Mapas */
:root {
  --panel-width: ${root.style.getPropertyValue('--panel-width')};
  --panel-padding: ${root.style.getPropertyValue('--panel-padding')};
  --section-gap: ${root.style.getPropertyValue('--section-gap')};
  --section-padding: ${root.style.getPropertyValue('--section-padding')};
  --hierarchy-indent: ${root.style.getPropertyValue('--hierarchy-indent')};
  --node-font-size: ${root.style.getPropertyValue('--node-font-size')};
  --node-padding: ${root.style.getPropertyValue('--node-padding')};
  --marker-font-size: ${root.style.getPropertyValue('--marker-font-size')};
  --marker-padding: ${root.style.getPropertyValue('--marker-padding')};
  --badge-font-size: ${root.style.getPropertyValue('--badge-font-size')};
  --section-title-size: ${root.style.getPropertyValue('--section-title-size')};
  --border-radius: ${root.style.getPropertyValue('--border-radius')};
  --header-height: ${root.style.getPropertyValue('--header-height')};
  --tab-height: ${root.style.getPropertyValue('--tab-height')};
  --tab-font-size: ${root.style.getPropertyValue('--tab-font-size')};
  --tab-padding: ${root.style.getPropertyValue('--tab-padding')};
  --tab-badge-font-size: ${root.style.getPropertyValue('--tab-badge-font-size')};
  --badge-padding: ${root.style.getPropertyValue('--badge-padding')};
  --layout-gap: ${root.style.getPropertyValue('--layout-gap')};
  --panel-shadow: ${root.style.getPropertyValue('--panel-shadow')};
  --section-shadow: ${root.style.getPropertyValue('--section-shadow')};
}
      `.trim();

      navigator.clipboard.writeText(css).then(() => {
        alert('‚úÖ CSS copiado al portapapeles!\n\nPuedes pegarlo en el archivo index.html');
      }).catch(() => {
        alert('‚ùå Error al copiar. Por favor, copia manualmente:\n\n' + css);
      });
    }

    // Workspace layout controls
    function updateWorkspaceLayout() {
      const shell = document.querySelector('.map-shell');
      const workspace = document.querySelector('.map-workspace');
      const panel = document.querySelector('.map-panel');
      const toolbar = document.querySelector('.map-toolbar');
      const canvas = document.querySelector('.map-canvas-stage');
      const tabContent = document.querySelector('.panel-tab-content');
      const contentWrapper = document.querySelector('.tab-content-wrapper');
      const scrollContent = document.querySelector('.tab-scroll-content');
      
      const workspaceWidth = document.getElementById('workspaceWidth').value;
      const shellGap = document.getElementById('shellGap').value;
      const shellPadding = document.getElementById('shellPadding').value;
      const toolbarWidth = document.getElementById('toolbarWidth').value;
      const canvasWidth = document.getElementById('canvasWidth').value;
      const workspaceMaxWidth = document.getElementById('workspaceMaxWidth').value;
      const workspaceMinWidth = document.getElementById('workspaceMinWidth').value;
      const tabContentWidth = document.getElementById('tabContentWidth').value;
      const contentWrapperWidth = document.getElementById('contentWrapperWidth').value;
      const scrollContentWidth = document.getElementById('scrollContentWidth').value;
      const panelMaxWidth = document.getElementById('panelMaxWidth').value;
      const hasBorderRadius = document.getElementById('workspaceBorderRadius').checked;
      const hasShadows = document.getElementById('workspaceShadows').checked;
      const debugBorders = document.getElementById('debugBorders').checked;
      
      // Actualizar grid
      if (workspaceWidth == 0) {
        shell.style.gridTemplateColumns = '500px 1fr';
        document.getElementById('workspaceWidthValue').textContent = 'auto (1fr)';
      } else {
        shell.style.gridTemplateColumns = `500px ${workspaceWidth}px`;
        document.getElementById('workspaceWidthValue').textContent = workspaceWidth + 'px';
      }
      
      shell.style.gap = shellGap + 'px';
      shell.style.padding = shellPadding + 'px';
      document.getElementById('shellGapValue').textContent = shellGap + 'px';
      document.getElementById('shellPaddingValue').textContent = shellPadding + 'px';
      
      // Workspace max/min width
      if (workspace) {
        if (workspaceMaxWidth == 0) {
          workspace.style.maxWidth = 'none';
          document.getElementById('workspaceMaxWidthValue').textContent = 'none';
        } else {
          workspace.style.maxWidth = workspaceMaxWidth + 'px';
          document.getElementById('workspaceMaxWidthValue').textContent = workspaceMaxWidth + 'px';
        }
        
        workspace.style.minWidth = workspaceMinWidth + 'px';
        document.getElementById('workspaceMinWidthValue').textContent = workspaceMinWidth + 'px';
      }
      
      // Panel max-width
      if (panel) {
        if (panelMaxWidth == 0) {
          panel.style.maxWidth = 'none';
          document.getElementById('panelMaxWidthValue').textContent = 'none';
        } else {
          panel.style.maxWidth = panelMaxWidth + 'px';
          document.getElementById('panelMaxWidthValue').textContent = panelMaxWidth + 'px';
        }
      }
      
      // Toolbar width
      if (toolbar) {
        if (toolbarWidth == 0) {
          toolbar.style.width = '100%';
          document.getElementById('toolbarWidthValue').textContent = '100%';
        } else {
          toolbar.style.width = toolbarWidth + 'px';
          document.getElementById('toolbarWidthValue').textContent = toolbarWidth + 'px';
        }
      }
      
      // Canvas width
      if (canvas) {
        if (canvasWidth == 0) {
          canvas.style.width = '100%';
          document.getElementById('canvasWidthValue').textContent = '100%';
        } else {
          canvas.style.width = canvasWidth + 'px';
          document.getElementById('canvasWidthValue').textContent = canvasWidth + 'px';
        }
      }
      
      // Panel tab-content width
      if (tabContent) {
        if (tabContentWidth == 0) {
          tabContent.style.width = '100%';
          document.getElementById('tabContentWidthValue').textContent = '100%';
        } else {
          tabContent.style.width = tabContentWidth + 'px';
          document.getElementById('tabContentWidthValue').textContent = tabContentWidth + 'px';
        }
      }
      
      // Content wrapper width
      if (contentWrapper) {
        if (contentWrapperWidth == 0) {
          contentWrapper.style.width = '100%';
          document.getElementById('contentWrapperWidthValue').textContent = '100%';
        } else {
          contentWrapper.style.width = contentWrapperWidth + 'px';
          document.getElementById('contentWrapperWidthValue').textContent = contentWrapperWidth + 'px';
        }
      }
      
      // Scroll content width
      if (scrollContent) {
        if (scrollContentWidth == 0) {
          scrollContent.style.width = '100%';
          document.getElementById('scrollContentWidthValue').textContent = '100%';
        } else {
          scrollContent.style.width = scrollContentWidth + 'px';
          document.getElementById('scrollContentWidthValue').textContent = scrollContentWidth + 'px';
        }
      }
      
      // Border radius
      const radius = hasBorderRadius ? '8px' : '0';
      if (workspace) workspace.style.borderRadius = radius;
      if (panel) panel.style.borderRadius = radius;
      
      // Sombras
      const shadow = hasShadows ? '0 2px 8px rgba(0, 0, 0, 0.15)' : 'none';
      if (workspace) workspace.style.boxShadow = shadow;
      if (panel) panel.style.boxShadow = shadow;
      
      // Debug borders
      if (debugBorders) {
        if (shell) shell.style.outline = '3px solid red';
        if (workspace) workspace.style.outline = '3px solid lime';
        if (panel) panel.style.outline = '3px solid blue';
        if (toolbar) toolbar.style.outline = '2px solid yellow';
        if (canvas) canvas.style.outline = '2px solid cyan';
        if (tabContent) tabContent.style.outline = '2px solid magenta';
        if (contentWrapper) contentWrapper.style.outline = '2px solid orange';
        if (scrollContent) scrollContent.style.outline = '2px solid purple';
      } else {
        if (shell) shell.style.outline = 'none';
        if (workspace) workspace.style.outline = 'none';
        if (panel) panel.style.outline = 'none';
        if (toolbar) toolbar.style.outline = 'none';
        if (canvas) canvas.style.outline = 'none';
        if (tabContent) tabContent.style.outline = 'none';
        if (contentWrapper) contentWrapper.style.outline = 'none';
        if (scrollContent) scrollContent.style.outline = 'none';
      }
    }

    function setWorkspaceWidth(width) {
      document.getElementById('workspaceWidth').value = width;
      updateWorkspaceLayout();
    }

    // Toggle control panel
    function toggleControlPanel(event) {
      event.stopPropagation();
      const panel = document.getElementById('controlPanel');
      panel.classList.toggle('expanded');
    }

    // Cerrar panel al hacer click fuera
    document.addEventListener('click', function(event) {
      const panel = document.getElementById('controlPanel');
      if (panel.classList.contains('expanded') && !panel.contains(event.target)) {
        panel.classList.remove('expanded');
      }
    });

    // Toggle section
    function toggleSection(header) {
      header.closest('.map-section').classList.toggle('collapsed');
    }

    // Toggle node
    function toggleNode(header) {
      const children = header.nextElementSibling;
      const toggle = header.querySelector('.node-toggle');
      if (children && children.classList.contains('node-children')) {
        children.classList.toggle('collapsed');
        toggle.textContent = children.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
      }
    }

    // Toggle category
    function toggleCategory(header) {
      const markers = header.nextElementSibling;
      const toggle = header.querySelector('.category-toggle');
      if (markers && markers.classList.contains('category-markers')) {
        markers.classList.toggle('collapsed');
        toggle.textContent = markers.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
      }
    }

    // Focus area
    function focusArea(item) {
      document.querySelectorAll('.area-item').forEach(a => a.style.background = '');
      item.style.background = 'rgba(59, 130, 246, 0.2)';
    }

    // Switch panel tabs (mantener compatibilidad con tabs horizontales ocultos)
    function switchPanelTab(tabName) {
      // Remover active de todos los tabs horizontales
      document.querySelectorAll('.panel-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Ocultar todos los contenidos
      document.querySelectorAll('.panel-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Activar tab clickeado
      event.target.classList.add('active');
      
      // Mostrar contenido correspondiente
      const contentMap = {
        'mapas': 'tabMapas',
        'logs': 'tabLogs'
      };
      
      const contentId = contentMap[tabName];
      if (contentId) {
        document.getElementById(contentId).classList.add('active');
        
        // Si es la pesta√±a de Mapas, restablecer vista a "Mapas creados"
        if (tabName === 'mapas') {
          // Simular click en la primera subsecci√≥n
          const firstSubsection = document.querySelector('.subsection-item');
          if (firstSubsection) {
            // Resetear todas las secciones primero
            const sectionMap = {
              'jerarquia-completa': 'section-jerarquia-completa',
              'mapas-creados': 'section-mapas-creados',
              'pendientes': 'section-pendientes',
              'estadisticas': 'section-estadisticas'
            };
            
            // Ocultar todas
            Object.values(sectionMap).forEach(id => {
              const section = document.getElementById(id);
              if (section) {
                section.style.display = 'none';
              }
            });
            
            // Mostrar solo "Jerarqu√≠a Completa"
            const jerarquiaCompleta = document.getElementById('section-jerarquia-completa');
            if (jerarquiaCompleta) {
              jerarquiaCompleta.style.display = 'block';
            }
            
            // Actualizar subsecci√≥n activa
            document.querySelectorAll('.subsection-item').forEach(item => {
              item.classList.remove('active');
            });
            firstSubsection.classList.add('active');
          }
        }
      }
    }

    // Filtrar y mostrar solo la subsecci√≥n seleccionada
    function scrollToSection(sectionId) {
      console.log('üîÑ Cambiando a subsecci√≥n:', sectionId);
      
      const sectionMap = {
        // Secciones de Mapas
        'jerarquia-completa': 'section-jerarquia-completa',
        'mapas-creados': 'section-mapas-creados',
        'pendientes': 'section-pendientes',
        'estadisticas': 'section-estadisticas',
        // Secciones de √Åreas (obsoletas pero mantenidas por compatibilidad)
        'areas-todas': 'section-areas-todas',
        'areas-jerarquia': 'section-areas-jerarquia'
      };
      
      const targetId = sectionMap[sectionId];
      console.log('Target ID:', targetId);
      
      // Ocultar todas las secciones
      Object.values(sectionMap).forEach(id => {
        const section = document.getElementById(id);
        if (section && !section.classList.contains('persistent-section')) {
          section.style.display = 'none';
          console.log('Ocultando:', id);
        }
      });
      
      // Mostrar solo la secci√≥n seleccionada
      const targetSection = document.getElementById(targetId);
      if (targetSection) {
        targetSection.style.display = 'block';
        targetSection.classList.remove('collapsed');
        // IMPORTANTE: Expandir la secci√≥n (quitar clase collapsed)
        console.log('‚úÖ Mostrando y expandiendo:', targetId);
      } else {
        console.error('‚ùå No se encontr√≥ la secci√≥n:', targetId);
      }
      
      // Actualizar subsecci√≥n activa
      document.querySelectorAll('.subsection-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    // Toggle pin del sidebar de subsecciones (obsoleto - texto vertical)
    function toggleSubsectionPin() {
      // No hace nada, mantenido por compatibilidad
    }

    // Actualizar ancho del panel (obsoleto - texto vertical)
    function updatePanelWidth(sidebar) {
      // No hace nada, mantenido por compatibilidad
    }

    // Inicializar estado de subsecciones al cargar
    function initializeSubsections() {
      const sectionMap = {
        // Secciones de Mapas
        'jerarquia-completa': 'section-jerarquia-completa',
        'mapas-creados': 'section-mapas-creados',
        'pendientes': 'section-pendientes',
        'estadisticas': 'section-estadisticas',
        // Secciones de √Åreas (obsoletas)
        'areas-todas': 'section-areas-todas',
        'areas-jerarquia': 'section-areas-jerarquia'
      };
      
      // Mostrar secci√≥n inicial, pero mantener visibles las persistentes
      Object.entries(sectionMap).forEach(([key, id], index) => {
        const section = document.getElementById(id);
        if (section) {
          const isPersistent = section.classList.contains('persistent-section');
          const isFirstOfMapas = key === 'jerarquia-completa';
          const isFirstOfAreas = key === 'areas-todas';
          
          // Mostrar primera secci√≥n de cada tab o las persistentes
          section.style.display = isFirstOfMapas || isFirstOfAreas || isPersistent ? 'block' : 'none';
          
          if (isPersistent) {
            section.classList.remove('collapsed');
          }
        }
      });
    }

    // Inicializar
    // Aplicar preset ultraMinimal autom√°ticamente
    applyPreset('ultraMinimal');
    initializeSubsections();

    // ===== CARGA DE DATOS REALES (EMBEBIDOS) =====
    // NOTA: Para usar con servidor Vite, cambiar a fetch('./INVENTARIO_STORAGE/xxx.json')
    
    // Datos embebidos directamente (sin necesidad de servidor)
    const EMBEDDED_MAPAS = [{"id":1760411932641,"name":"Planta Principal","imagePath":"imagenes/mapas/map_1760411932641.png","width":9362,"height":6623,"createdAt":"2025-10-14T03:18:52.886Z","updatedAt":"2025-11-15T00:21:05.263Z","jerarquiaPath":[{"id":"AQ-IN","nivel":"empresa"},{"id":"PCHO","nivel":"area"}],"allowFreeLevel":false,"mapLevel":"area"},{"id":1763209400991,"name":"Recinto Aquachile Antarfood","imagePath":"imagenes/mapas/map_1763209400991.png","width":18725,"height":13245,"createdAt":"2025-11-15T12:23:21.221Z","updatedAt":"2025-11-15T12:23:38.348Z","jerarquiaPath":[{"id":"AQ-IN","nivel":"empresa"}],"allowFreeLevel":false,"mapLevel":"empresa"}];
    
    const EMBEDDED_ZONAS_COUNT = 37; // Total de zonas en zonas.json
    
    let mapasData = EMBEDDED_MAPAS;
    let zonasData = []; // Se cargar√≠a aqu√≠ si fuera necesario
    let inventarioData = [];

    function loadRealData() {
      try {
        // Usar datos embebidos
        mapasData = EMBEDDED_MAPAS;
        
        // Simular zonas (solo contador para no sobrecargar el HTML)
        zonasData = Array(EMBEDDED_ZONAS_COUNT).fill(null).map((_, i) => ({
          id: i,
          mapId: 1760411932641,
          equipos: i < 30 ? ['equipo1'] : [] // Simular algunas con equipos
        }));
        
        console.log('‚úÖ Datos cargados (embebidos)');
        console.log('Mapas:', mapasData.length);
        console.log('Zonas:', zonasData.length);

        // Renderizar datos
        renderHierarchyTree(); // Primero renderizar jerarqu√≠a (componente principal)
        renderMapasTab();
        renderAreasTab();
        updateStats();

      } catch (error) {
        console.error('‚ùå Error cargando datos:', error);
        console.error('Detalles del error:', error.message);
        
        // Mostrar error en UI
        const contentArea = document.querySelector('.panel-tab-content.active .section-content');
        if (contentArea) {
          contentArea.innerHTML = `
            <div style="padding: 20px; text-align: center; color: var(--danger);">
              <p style="font-size: 1.2rem; margin-bottom: 10px;">‚ö†Ô∏è Error al cargar datos</p>
              <p style="font-size: 0.8rem; color: var(--text-secondary);">${error.message}</p>
              <button onclick="loadRealData()" style="margin-top: 15px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                üîÑ Reintentar
              </button>
            </div>
          `;
        }
      }
    }

    function renderMapasTab() {
      // Construir jerarqu√≠a desde datos reales
      const jerarquiaCompleta = buildHierarchyFromData();
      
      // Actualizar contador en el header
      const mapasCountEl = document.getElementById('mapasCount');
      if (mapasCountEl) {
        mapasCountEl.textContent = mapasData.length;
      }
      
      // Actualizar secci√≥n de mapas creados
      const mapasSection = document.querySelector('.map-section .section-content');
      if (mapasSection && mapasData.length > 0) {
        mapasSection.innerHTML = mapasData.map(mapa => `
          <div class="area-item" style="padding: 5px 6px; margin-bottom: 3px; border-left: 2px solid var(--primary); display: flex; align-items: center; justify-content: space-between; gap: 6px;">
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${mapa.name}
              </div>
              <div style="font-size: 0.6rem; color: var(--text-muted);">
                ${mapa.mapLevel} ‚Ä¢ ${zonasData.filter(z => z.mapId === mapa.id).length} zonas ‚Ä¢ ${mapa.jerarquiaPath.map(j => j.id).join(' > ')}
              </div>
            </div>
            <div style="display: flex; gap: 3px; flex-shrink: 0;">
              <button class="action-btn" style="padding: 2px 6px; font-size: 0.6rem; background: var(--primary); color: white; border-color: var(--primary);">Ver</button>
              <button class="action-btn" style="padding: 2px 6px; font-size: 0.6rem;">Editar</button>
              <button class="action-btn" style="padding: 2px 5px; font-size: 0.6rem;">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');
      }
    }

    function renderAreasTab() {
      const container = document.getElementById('areas-list-container');
      if (!container) return;

      // Generar tarjetas de √°reas compactas (m√°ximo 2 l√≠neas por √°rea)
      const areasHtml = zonasData.slice(0, 10).map((zona, index) => {
        const tieneEquipos = zona.equipos && zona.equipos.length > 0;
        const numEquipos = tieneEquipos ? zona.equipos.length : 0;
        const nivel = `N${Math.min(index % 4 + 1, 4)}`;
        const mapaName = zona.mapId === 1760411932641 ? 'Planta Principal' : 'Sin asignar';
        
        return `
          <div class="map-card" style="margin-bottom: 4px; padding: 6px 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <span class="node-badge" style="font-size: 0.55rem; padding: 1px 4px;">${nivel}</span>
                <span style="font-size: 0.7rem; color: var(--text-primary); font-weight: 500;">√Årea ${index + 1}</span>
                <span style="font-size: 0.6rem; color: var(--text-muted);">‚Ä¢ ${tieneEquipos ? `${numEquipos} eq.` : 'Vac√≠a'}</span>
              </div>
              <div style="display: flex; gap: 4px;">
                <button class="action-btn" style="font-size: 0.6rem; padding: 2px 6px;">Ver</button>
                <button class="action-btn" style="font-size: 0.6rem; padding: 2px 6px;">Editar</button>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.62rem; color: var(--text-secondary);">
              <span>Mapa: <span style="color: var(--primary-light);">${mapaName}</span></span>
              <span style="color: var(--text-muted); font-family: monospace; font-size: 0.58rem;">ID: ${zona.id}</span>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = areasHtml || '<p style="color: var(--text-muted); font-size: 0.65rem; text-align: center; padding: 15px;">No hay √°reas disponibles</p>';
      
      console.log('‚úÖ √Åreas renderizadas en subsecci√≥n de Mapas');
    }

    function buildHierarchyFromData() {
      // Construir estructura jer√°rquica desde zonas
      const hierarchy = {};
      
      zonasData.forEach(zona => {
        const jer = zona.jerarquia;
        if (!jer) return;
        
        // Procesar cada nivel de jerarqu√≠a
        let currentLevel = hierarchy;
        for (let i = 1; i <= 7; i++) {
          const nivelKey = `nivel${i}`;
          const nivelValue = jer[nivelKey];
          
          if (nivelValue) {
            if (!currentLevel[nivelValue]) {
              currentLevel[nivelValue] = {
                name: nivelValue,
                nivel: i,
                children: {},
                zonas: [],
                mapId: zona.mapId
              };
            }
            currentLevel[nivelValue].zonas.push(zona);
            currentLevel = currentLevel[nivelValue].children;
          }
        }
      });
      
      return hierarchy;
    }

    // ===== FUNCIONES JERARQU√çA COMPLETA =====
    
    function renderHierarchyTree() {
      const container = document.getElementById('hierarchy-tree-container');
      if (!container) return;

      // Construir jerarqu√≠a desde zonasData
      // Para este prototipo, crearemos una jerarqu√≠a est√°tica basada en los datos
      const hierarchy = {
        name: 'Planta Principal',
        nivel: 1,
        mapId: 1760411932641,
        children: [
          {
            name: 'Eviscerado',
            nivel: 2,
            mapId: 1760411932641,
            areas: 15,
            marcadores: 42,
            children: [
              {
                name: 'Grader',
                nivel: 3,
                areas: 6,
                marcadores: 18,
                children: [
                  { name: 'Pocket 1-4', nivel: 4, marcadores: 5 },
                  { name: 'Cinta Z', nivel: 4, marcadores: 3 },
                  { name: 'Cinta Acel. 1', nivel: 4, marcadores: 4 },
                  { name: 'Cinta Acel. 2', nivel: 4, marcadores: 3 },
                  { name: 'Cinta Larga', nivel: 4, marcadores: 3 }
                ]
              },
              {
                name: 'Marel',
                nivel: 3,
                areas: 3,
                marcadores: 8,
                children: [
                  { name: 'Cinta Azul', nivel: 4, marcadores: 8 }
                ]
              }
            ]
          },
          {
            name: 'Filete',
            nivel: 2,
            areas: 8,
            marcadores: 24
          },
          {
            name: 'Congelado',
            nivel: 2,
            areas: 5,
            marcadores: 15
          }
        ]
      };

      container.innerHTML = renderHierarchyNode(hierarchy, 0);
    }

    function renderHierarchyNode(node, depth) {
      const hasMap = node.mapId;
      const hasAreas = node.areas > 0;
      const hasMarcadores = node.marcadores > 0;
      const hasChildren = node.children && node.children.length > 0;
      
      // Estilos condicionales sobrios
      const isHighlighted = hasMap || hasAreas || hasMarcadores;
      const opacity = isHighlighted ? '1' : '0.6';
      const paddingLeft = depth * 14;
      const fontWeight = hasMap ? '600' : '400';
      
      // Indicadores discretos
      let indicatorsHtml = '<span class="node-indicators">';
      if (hasMap) indicatorsHtml += '<span class="node-indicator" title="Mapa asignado">üó∫Ô∏è</span>';
      if (hasAreas) indicatorsHtml += '<span class="node-indicator" title="√Åreas creadas">üì¶</span>';
      if (hasMarcadores) indicatorsHtml += `<span class="node-indicator" title="${node.marcadores} marcadores">üìç<sub style="font-size: 0.55rem;">${node.marcadores}</sub></span>`;
      indicatorsHtml += '</span>';
      
      // Data attributes para sincronizaci√≥n
      const dataAttrs = `data-node-name="${node.name}" data-node-level="${node.nivel}" data-map-id="${node.mapId || ''}" data-has-map="${hasMap}" data-depth="${depth}"`;
      
      let html = `
        <div class="hierarchy-node" ${dataAttrs} style="opacity: ${opacity};">
          <div class="node-header" style="padding: 4px 8px; padding-left: ${paddingLeft + 8}px;" onclick="onHierarchyNodeClick(this)">
            ${hasChildren ? '<span class="node-toggle" onclick="toggleNode(this.parentElement.parentElement); event.stopPropagation();">‚ñº</span>' : '<span style="display: inline-block; width: 12px;"></span>'}
            <span class="node-badge">N${node.nivel}</span>
            ${indicatorsHtml}
            <span class="node-label" style="font-weight: ${fontWeight};">${node.name}</span>
          </div>
          ${hasChildren ? `<div class="node-children">${node.children.map(child => renderHierarchyNode(child, depth + 1)).join('')}</div>` : ''}
        </div>
      `;
      
      return html;
    }

    function filterHierarchy(searchTerm) {
      const container = document.getElementById('hierarchy-tree-container');
      if (!container) return;

      const term = searchTerm.toLowerCase().trim();
      
      // Si no hay t√©rmino, mostrar todo y limpiar resaltados
      if (!term) {
        container.querySelectorAll('.hierarchy-node').forEach(node => {
          node.style.display = 'block';
          node.classList.remove('highlighted');
          const header = node.querySelector('.node-header');
          if (header) {
            header.style.backgroundColor = '';
            header.classList.remove('search-match');
          }
        });
        return;
      }

      // Primero, limpiar todos los resaltados
      container.querySelectorAll('.hierarchy-node').forEach(node => {
        node.classList.remove('highlighted');
        const header = node.querySelector('.node-header');
        if (header) {
          header.classList.remove('search-match');
        }
      });

      // Filtrar y resaltar nodos
      const allNodes = container.querySelectorAll('.hierarchy-node');
      const matchingNodes = [];
      
      allNodes.forEach(node => {
        const nodeName = node.getAttribute('data-node-name').toLowerCase();
        const matches = nodeName.includes(term);
        
        if (matches) {
          matchingNodes.push(node);
          // Nodo coincide: mostrar y resaltar
          node.style.display = 'block';
          node.classList.add('highlighted');
          const header = node.querySelector('.node-header');
          if (header) {
            header.classList.add('search-match');
          }
          
          // Mostrar y resaltar todos los padres (rama completa)
          let parent = node.parentElement;
          while (parent && parent !== container) {
            if (parent.classList.contains('node-children')) {
              parent.style.display = 'block';
              // Expandir si est√° colapsado
              if (parent.classList.contains('collapsed')) {
                parent.classList.remove('collapsed');
                const toggle = parent.previousElementSibling?.querySelector('.node-toggle');
                if (toggle) toggle.textContent = '‚ñº';
              }
              // Resaltar el nodo padre
              const parentNode = parent.parentElement;
              if (parentNode && parentNode.classList.contains('hierarchy-node')) {
                parentNode.style.display = 'block';
                parentNode.classList.add('highlighted');
              }
            }
            parent = parent.parentElement;
          }
          
          // Expandir y mostrar hijos si los tiene
          const children = node.querySelector(':scope > .node-children');
          if (children) {
            children.style.display = 'block';
            if (children.classList.contains('collapsed')) {
              children.classList.remove('collapsed');
              const toggle = node.querySelector(':scope > .node-header .node-toggle');
              if (toggle) toggle.textContent = '‚ñº';
            }
          }
        } else {
          // Nodo no coincide: ocultar por defecto (se mostrar√° si es padre/hijo de coincidencia)
          node.style.display = 'none';
        }
      });
      
      console.log(`üîç B√∫squeda: "${term}" - ${matchingNodes.length} coincidencias`);
    }

    function onHierarchyNodeClick(headerElement) {
      const nodeElement = headerElement.parentElement;
      const nodeName = nodeElement.getAttribute('data-node-name');
      const mapId = nodeElement.getAttribute('data-map-id');
      const hasMap = nodeElement.getAttribute('data-has-map') === 'true';
      const level = nodeElement.getAttribute('data-node-level');
      
      console.log('üéØ Click en nodo:', { nodeName, mapId, hasMap, level });
      
      // 1. LIMPIAR SELECCIONES PREVIAS
      document.querySelectorAll('.node-header').forEach(header => {
        header.classList.remove('selected');
      });
      document.querySelectorAll('.hierarchy-node').forEach(node => {
        node.classList.remove('highlighted');
      });
      
      // 2. RESALTAR NODO SELECCIONADO
      headerElement.classList.add('selected');
      
      // 3. RESALTAR RAMA COMPLETA (PADRES)
      let currentNode = nodeElement;
      while (currentNode) {
        if (currentNode.classList.contains('hierarchy-node')) {
          currentNode.classList.add('highlighted');
          // Expandir padres si est√°n colapsados
          const children = currentNode.querySelector(':scope > .node-children');
          if (children && children.classList.contains('collapsed')) {
            children.classList.remove('collapsed');
            const toggle = currentNode.querySelector(':scope > .node-header .node-toggle');
            if (toggle) toggle.textContent = '‚ñº';
          }
        }
        currentNode = currentNode.parentElement?.parentElement;
      }
      
      // 4. ACTUALIZAR CANVAS DEL MAPA (si tiene mapa asignado)
      if (hasMap && mapId) {
        updateMapCanvas(mapId);
      }
      
      // 5. EMITIR EVENTO PARA SINCRONIZACI√ìN CON APP PRINCIPAL
      const syncData = {
        source: 'prototype-mapas',
        action: 'node-selected',
        data: {
          nodeName,
          mapId,
          level,
          hasMap,
          timestamp: new Date().toISOString()
        }
      };
      
      // Emitir evento personalizado
      window.dispatchEvent(new CustomEvent('hierarchy-sync', { detail: syncData }));
      
      // Comunicaci√≥n con iframe padre (si existe)
      if (window.parent !== window) {
        window.parent.postMessage(syncData, '*');
      }
      
      // Log para debugging
      console.log('üì° Evento de sincronizaci√≥n emitido:', syncData);
      
      // Mostrar notificaci√≥n visual temporal
      showSyncNotification(nodeName, hasMap);
    }
    
    function updateMapCanvas(mapId) {
      console.log('üó∫Ô∏è Actualizando canvas del mapa:', mapId);
      
      // Buscar el mapa en los datos
      const mapa = mapasData.find(m => m.id == mapId);
      if (!mapa) {
        console.warn('‚ö†Ô∏è Mapa no encontrado:', mapId);
        return;
      }
      
      // Aqu√≠ se implementar√≠a la l√≥gica para actualizar el canvas
      // Por ahora, solo mostramos la informaci√≥n en consola
      console.log('üìç Mapa encontrado:', {
        nombre: mapa.name,
        nivel: mapa.mapLevel,
        dimensiones: `${mapa.width}x${mapa.height}`,
        ruta: mapa.jerarquiaPath.map(p => p.id).join(' > ')
      });
      
      // TODO: Implementar renderizado en canvas real
      // const canvas = document.getElementById('map-canvas');
      // if (canvas) {
      //   renderMapOnCanvas(canvas, mapa);
      // }
    }
    
    function showSyncNotification(nodeName, hasMap) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-size: 0.85rem;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
      `;
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 1.2rem;">${hasMap ? 'üó∫Ô∏è' : 'üìç'}</span>
          <div>
            <div style="font-weight: 600;">${nodeName}</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">${hasMap ? 'Mapa cargado' : 'Nodo seleccionado'}</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }
    
    // Listener para eventos de sincronizaci√≥n desde la app principal
    window.addEventListener('message', (event) => {
      // Validar origen si es necesario
      if (event.data && event.data.source === 'app-principal') {
        console.log('üì® Mensaje recibido de app principal:', event.data);
        handleExternalSync(event.data);
      }
    });
    
    window.addEventListener('hierarchy-sync', (event) => {
      console.log('üîÑ Evento de sincronizaci√≥n interno:', event.detail);
    });
    
    function handleExternalSync(data) {
      if (data.action === 'navigate-to-node') {
        const nodeName = data.data.nodeName;
        const nodeElement = document.querySelector(`[data-node-name="${nodeName}"]`);
        if (nodeElement) {
          const header = nodeElement.querySelector('.node-header');
          if (header) {
            header.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => onHierarchyNodeClick(header), 300);
          }
        }
      }
    }

    function updateStats() {
      // Actualizar estad√≠sticas en el header
      const statsRow = document.querySelector('.stats-row');
      if (statsRow) {
        const totalMapas = mapasData.length;
        const totalZonas = zonasData.length;
        const totalMarcadores = zonasData.reduce((sum, zona) => sum + (zona.equipos?.length || 0), 0);
        
        statsRow.innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${totalMapas}</div>
            <div class="stat-label">Mapas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${totalZonas}</div>
            <div class="stat-label">√Åreas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${totalMarcadores}</div>
            <div class="stat-label">Marcadores</div>
          </div>
        `;
      }
      
      // Actualizar badges en tabs
      updateTabBadges();
    }

    function updateTabBadges() {
      const tabsData = {
        'mapas': mapasData.length
      };
      
      // Actualizar badges en tabs horizontales
      Object.entries(tabsData).forEach(([tabName, count]) => {
        const tab = document.querySelector(`[onclick="switchPanelTab('${tabName}')"]`);
        if (tab) {
          const badge = tab.querySelector('.panel-tab-badge');
          if (badge) badge.textContent = count;
        }
      });
    }

    // Funciones de logs
    function refreshLogs() {
      console.log('üîÑ Refrescando logs...');
      // Aqu√≠ se recargar√≠an los logs desde el servidor
    }

    function filterLogs(type) {
      // Remover active de todos los chips
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      
      // Activar chip seleccionado
      event.target.classList.add('active');
      
      // Filtrar logs seg√∫n tipo
      const logItems = document.querySelectorAll('.log-item');
      logItems.forEach(item => {
        if (type === 'all') {
          item.style.display = 'flex';
        } else {
          const shouldShow = item.classList.contains(`log-${type}`);
          item.style.display = shouldShow ? 'flex' : 'none';
        }
      });
      
      console.log('üîç Filtrando logs por:', type);
    }

    // ===== FUNCIONES DEMO SINCRONIZACI√ìN =====
    
    function demoSync(nodeName) {
      // Mostrar log
      const logContainer = document.getElementById('sync-log');
      const logContent = document.getElementById('sync-log-content');
      logContainer.style.display = 'block';
      
      const timestamp = new Date().toLocaleTimeString();
      logContent.innerHTML += `<div style="color: var(--success); margin: 2px 0;">
        [${timestamp}] üéØ Navegando a: "${nodeName}"
      </div>`;
      logContent.scrollTop = logContent.scrollHeight;
      
      // Simular navegaci√≥n
      const nodeElement = document.querySelector(`[data-node-name="${nodeName}"]`);
      if (nodeElement) {
        const header = nodeElement.querySelector('.node-header');
        if (header) {
          // Scroll suave
          header.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Destacar temporalmente
          header.style.background = 'rgba(34, 197, 94, 0.3)';
          setTimeout(() => {
            header.style.background = '';
            onHierarchyNodeClick(header);
            
            logContent.innerHTML += `<div style="color: var(--primary-light); margin: 2px 0;">
              [${new Date().toLocaleTimeString()}] ‚úÖ Nodo seleccionado y sincronizado
            </div>`;
            logContent.scrollTop = logContent.scrollHeight;
          }, 800);
        }
      } else {
        logContent.innerHTML += `<div style="color: var(--danger); margin: 2px 0;">
          [${timestamp}] ‚ùå Nodo no encontrado
        </div>`;
      }
    }
    
    function showSyncInfo() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        animation: fadeIn 0.2s ease-out;
      `;
      
      modal.innerHTML = `
        <div style="
          background: var(--bg-secondary);
          border: 1px solid var(--border-light);
          border-radius: 12px;
          padding: 24px;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        ">
          <h2 style="color: var(--primary-light); margin-bottom: 16px; font-size: 1.2rem;">
            üîÑ Sistema de Sincronizaci√≥n Bidireccional
          </h2>
          
          <div style="color: var(--text-secondary); line-height: 1.6; font-size: 0.85rem;">
            <h3 style="color: var(--text-primary); font-size: 1rem; margin: 16px 0 8px;">
              üì§ Eventos Emitidos (Prototype ‚Üí App)
            </h3>
            <ul style="margin-left: 20px;">
              <li><strong>CustomEvent:</strong> 'hierarchy-sync'</li>
              <li><strong>PostMessage:</strong> { source: 'prototype-mapas', action: 'node-selected' }</li>
              <li><strong>Trigger:</strong> Click en cualquier nodo</li>
              <li><strong>Datos:</strong> nodeName, mapId, level, hasMap, timestamp</li>
            </ul>
            
            <h3 style="color: var(--text-primary); font-size: 1rem; margin: 16px 0 8px;">
              üì• Eventos Recibidos (App ‚Üí Prototype)
            </h3>
            <ul style="margin-left: 20px;">
              <li><strong>PostMessage:</strong> { source: 'app-principal', action: 'navigate-to-node' }</li>
              <li><strong>Acci√≥n:</strong> Scroll suave + selecci√≥n + resaltado de rama</li>
            </ul>
            
            <h3 style="color: var(--text-primary); font-size: 1rem; margin: 16px 0 8px;">
              ‚ö° Funcionalidades
            </h3>
            <ul style="margin-left: 20px;">
              <li>üéØ Resaltado de nodo y rama completa</li>
              <li>üó∫Ô∏è Actualizaci√≥n autom√°tica del canvas</li>
              <li>üîç B√∫squeda global con filtrado inteligente</li>
              <li>üìç Indicadores visuales sobrios (mapa/√°rea/marcadores)</li>
              <li>üîî Notificaciones visuales temporales</li>
            </ul>
            
            <h3 style="color: var(--text-primary); font-size: 1rem; margin: 16px 0 8px;">
              üíª Ejemplo de Integraci√≥n
            </h3>
            <pre style="
              background: rgba(0,0,0,0.3);
              padding: 12px;
              border-radius: 6px;
              overflow-x: auto;
              font-size: 0.75rem;
              color: #a5d6ff;
            ">// Desde la app principal:
window.postMessage({
  source: 'app-principal',
  action: 'navigate-to-node',
  data: { nodeName: 'Eviscerado' }
}, '*');

// Escuchar eventos:
window.addEventListener('message', (e) => {
  if (e.data.source === 'prototype-mapas') {
    console.log('Nodo:', e.data.data.nodeName);
  }
});</pre>
          </div>
          
          <button onclick="this.parentElement.parentElement.remove()" style="
            margin-top: 20px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            width: 100%;
          ">
            Cerrar
          </button>
        </div>
      `;
      
      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
      
      document.body.appendChild(modal);
    }

    // Cargar datos al iniciar
    loadRealData();
    
    // Aplicar layout inicial con los valores por defecto
    updateWorkspaceLayout();
  </script>
</body>
</html>
