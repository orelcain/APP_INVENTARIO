rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function para verificar si el usuario est谩 autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function para obtener el rol del usuario desde Firestore
    // NOTA: Para usuarios con nick, el rol se obtiene de forma diferente
    function getUserRole() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.role;
    }
    
    // Helper function para verificar si es admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Helper function para verificar si es usuario regular
    function isUsuario() {
      return isAuthenticated() && getUserRole() == 'usuario';
    }
    
    // Helper function para verificar si tiene al menos rol de lectura
    function hasReadAccess() {
      return isAuthenticated();
    }
    
    //  v6.045 - Helper para verificar si solo se actualizan campos de presencia
    function isPresenceUpdate() {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['presence', 'lastLogin']);
    }
    
    // Colecci贸n de usuarios - Cualquier autenticado puede actualizar presencia
    // Los permisos de rol se verifican en el c贸digo de la app
    match /usuarios/{userId} {
      allow read: if isAuthenticated();
      //  v6.045 - Cualquier usuario autenticado puede actualizar presencia de cualquier doc
      // La seguridad real est谩 en el c贸digo (solo puede actualizar su propio doc)
      allow update: if isAuthenticated();
      allow create, delete: if isAuthenticated(); // Admin verificado en c贸digo
    }
    
    // Usuarios personalizados (custom_users)
    match /custom_users/{username} {
      allow read: if true; // P煤blico para login
      allow update: if isAuthenticated();
      allow create, delete: if isAuthenticated();
    }
    
    // Historial de acciones de usuarios
    match /user_actions/{actionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }
    
    // Repuestos - Cualquier autenticado puede leer, escribir verificado en c贸digo
    match /repuestos/{repuestoId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Mapas
    match /mapas/{mapaId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Zonas
    match /zonas/{zonaId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Presupuestos
    match /presupuestos/{presupuestoId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Jerarqu铆a
    match /jerarquia/{jerarquiaId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Metadata
    match /metadata/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Historial de actividad (Activity Log)
    match /activityLog/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }
  }
}
