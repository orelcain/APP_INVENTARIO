<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sistema de Inventario Visual PRO - Arquitectura Modular Portable">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“¦</text></svg>">
  <title>Inventario Visual PRO v6.0</title>
  
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="./manifest.json">
  
  <!-- CSS Modular - Todo embebido, sin CDN -->
  <link rel="stylesheet" href="./styles/variables.css">
  <link rel="stylesheet" href="./styles/main.css">
  <link rel="stylesheet" href="./styles/components.css">
  <link rel="stylesheet" href="./styles/inline-refactor.css">
  
  <!-- Preload de mÃ³dulos crÃ­ticos -->
  <link rel="modulepreload" href="./app/core/EventBus.js">
  <link rel="modulepreload" href="./app/core/StateManager.js">
  <link rel="modulepreload" href="./app/utils/validation.js">
  <link rel="modulepreload" href="./app/utils/errorHandler.js">
</head>
<body>
  <!-- ============================================
       CONTENEDOR PRINCIPAL
       ============================================ -->
  <div id="app">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <h1>ğŸ“¦ Inventario Visual PRO</h1>
        <span class="version-badge">v6.0</span>
        <div class="header-actions">
          <button id="connectionStatus" class="btn btn-secondary btn-sm">
            <span id="connectionIcon">ğŸ”Œ</span>
            <span id="connectionText">Desconectado</span>
          </button>
        </div>
      </div>
    </header>

    <!-- NavegaciÃ³n por pestaÃ±as -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="inventario">
        ğŸ“¦ Inventario
      </button>
      <button class="nav-tab" data-tab="conteo">
        âœ… Conteo
      </button>
      <button class="nav-tab" data-tab="jerarquia">
        ğŸŒ³ JerarquÃ­a
      </button>
      <button class="nav-tab" data-tab="mapa">
        ğŸ—ºï¸ Mapa
      </button>
      <button class="nav-tab" data-tab="stats">
        ğŸ“Š Stats
      </button>
      <button class="nav-tab" data-tab="config">
        âš™ï¸ Config
      </button>
    </nav>

    <!-- Contenido dinÃ¡mico -->
    <main class="main-content">
      <div id="inventarioTab" class="tab-content active">
        <div class="toolbar">
          <button class="btn btn-primary" id="btnAgregar">
            â• Agregar Repuesto
          </button>
          <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="ğŸ” Buscar por nombre, cÃ³digo SAP, Ã¡rea, equipo..."
            aria-label="Buscar repuestos"
          >
          <div class="filter-group">
            <select id="filterArea" class="form-control" aria-label="Filtrar por Ã¡rea">
              <option value="">Todas las Ãreas</option>
            </select>
            <select id="filterEquipo" class="form-control" aria-label="Filtrar por equipo">
              <option value="">Todos los Equipos</option>
            </select>
            <select id="filterEstado" class="form-control" aria-label="Filtrar por estado de stock">
              <option value="todos">ğŸ” Ver Todos</option>
              <option value="ok">âœ… Stock OK</option>
              <option value="bajo">âš ï¸ Stock Bajo</option>
              <option value="sin">âŒ Sin Stock</option>
            </select>
          </div>
        </div>

        <!-- Grid de tarjetas -->
        <div id="cardsGrid" class="cards-grid">
          <!-- Las tarjetas se generan dinÃ¡micamente -->
        </div>

        <!-- PaginaciÃ³n -->
        <div id="pagination" class="pagination">
          <!-- Se genera dinÃ¡micamente -->
        </div>
      </div>

      <div id="conteoTab" class="tab-content">
        <h2>Sistema de Conteo</h2>
        <p>Funcionalidad de conteo aquÃ­...</p>
      </div>

      <div id="jerarquiaTab" class="tab-content">
        <h2>Vista de JerarquÃ­a</h2>
        <p>Ãrbol jerÃ¡rquico aquÃ­...</p>
      </div>

      <div id="mapaTab" class="tab-content">
        <h2>Mapa Interactivo</h2>
        <p>Mapa aquÃ­...</p>
      </div>

      <div id="statsTab" class="tab-content">
        <h2>EstadÃ­sticas</h2>
        <p>GrÃ¡ficos y stats aquÃ­...</p>
      </div>

      <div id="configTab" class="tab-content">
        <h2>ConfiguraciÃ³n</h2>
        <div class="config-section">
          <h3>FileSystem API</h3>
          <button id="btnConectar" class="btn btn-primary">
            ğŸ“ Elegir Carpeta de Trabajo
          </button>
          <p class="text-muted">
            Selecciona la carpeta INVENTARIO_STORAGE para comenzar
          </p>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal (template) -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Modal</h2>
        <button class="modal-close" id="modalClose">Ã—</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Contenido dinÃ¡mico -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="modalCancel">Cancelar</button>
        <button class="btn btn-primary" id="modalConfirm">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Toast (notificaciones) -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="loading-spinner hidden">
    <div class="spinner"></div>
    <p>Cargando...</p>
  </div>

  <!-- ============================================
       JAVASCRIPT - MÃ“DULOS ES6
       ============================================ -->
  
  <!-- LibrerÃ­as de terceros embebidas (se cargarÃ¡n bajo demanda) -->
  <script>
    // ConfiguraciÃ³n global
    window.APP_CONFIG = {
      version: '6.0.0',
      debug: false, // Cambiar a true para debugging
      storageFolder: 'INVENTARIO_STORAGE',
      maxFileSize: 10 * 1024 * 1024, // 10MB
      itemsPerPage: 21,
      autoSaveInterval: 30000 // 30 segundos
    };
  </script>

  <!-- MÃ³dulo principal - ES6 Modules -->
  <script type="module">
    // ============================================
    // IMPORTACIONES
    // ============================================
    
    // Core
    import eventBus, { Events } from './app/core/EventBus.js';
    import stateManager from './app/core/StateManager.js';
    
    // Utilidades
    import { 
      validateRepuesto, 
      sanitizeObject 
    } from './app/utils/validation.js';
    
    import { 
      handleError, 
      InventarioError, 
      ErrorTypes,
      setupGlobalErrorHandlers 
    } from './app/utils/errorHandler.js';
    
    import {
      debounce,
      groupBy,
      sortBy,
      paginate,
      search,
      isMobile
    } from './app/utils/helpers.js';
    
    import {
      formatCurrency,
      formatDate,
      formatStockStatus,
      formatNumber
    } from './app/utils/formatters.js';

    // ============================================
    // INICIALIZACIÃ“N
    // ============================================
    
    // Setup de manejadores globales de errores
    setupGlobalErrorHandlers();
    
    // Habilitar debug si estÃ¡ configurado
    if (window.APP_CONFIG.debug) {
      eventBus.enableDebug();
      stateManager.enableDebug();
      console.log('ğŸ› Modo debug activado');
    }

    // ============================================
    // CLASE PRINCIPAL DE LA APLICACIÃ“N
    // ============================================
    
    class InventarioApp {
      constructor() {
        this.initialized = false;
        this.elements = {};
      }

      async init() {
        try {
          console.log('ğŸš€ Inicializando Inventario Visual PRO v6.0...');
          
          // 1. Cachear elementos del DOM
          this.cacheElements();
          
          // 2. Registrar event listeners
          this.registerEventListeners();
          
          // 3. Suscribirse a eventos globales
          this.subscribeToEvents();
          
          // 4. Cargar estado guardado (si existe)
          this.loadSavedState();
          
          // 5. Detectar dispositivo y aplicar ajustes
          this.detectDevice();
          
          // 6. Intentar restaurar sesiÃ³n FileSystem
          await this.restoreFileSystemSession();
          
          // 7. Marcar como inicializado
          this.initialized = true;
          
          console.log('âœ… AplicaciÃ³n inicializada correctamente');
          eventBus.emit(Events.APP_READY);
          
          this.showToast('Â¡Bienvenido a Inventario Visual PRO v6.0!', 'success');
          
        } catch (error) {
          handleError(error, {
            customMessage: 'Error al inicializar la aplicaciÃ³n'
          });
        }
      }

      cacheElements() {
        // NavegaciÃ³n
        this.elements.navTabs = document.querySelectorAll('.nav-tab');
        this.elements.tabContents = document.querySelectorAll('.tab-content');
        
        // Botones principales
        this.elements.btnAgregar = document.getElementById('btnAgregar');
        this.elements.btnConectar = document.getElementById('btnConectar');
        
        // BÃºsqueda y filtros
        this.elements.searchInput = document.getElementById('searchInput');
        this.elements.filterArea = document.getElementById('filterArea');
        this.elements.filterEquipo = document.getElementById('filterEquipo');
        this.elements.filterEstado = document.getElementById('filterEstado');
        
        // Contenedores
        this.elements.cardsGrid = document.getElementById('cardsGrid');
        this.elements.pagination = document.getElementById('pagination');
        
        // Modal
        this.elements.modal = document.getElementById('modal');
        this.elements.modalTitle = document.getElementById('modalTitle');
        this.elements.modalBody = document.getElementById('modalBody');
        this.elements.modalClose = document.getElementById('modalClose');
        
        // Toast
        this.elements.toastContainer = document.getElementById('toastContainer');
        
        // Loading
        this.elements.loadingSpinner = document.getElementById('loadingSpinner');
        
        // Status
        this.elements.connectionStatus = document.getElementById('connectionStatus');
        this.elements.connectionIcon = document.getElementById('connectionIcon');
        this.elements.connectionText = document.getElementById('connectionText');
      }

      registerEventListeners() {
        // NavegaciÃ³n por pestaÃ±as
        this.elements.navTabs.forEach(tab => {
          tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
        });
        
        // BÃºsqueda con debounce
        const debouncedSearch = debounce((query) => {
          this.handleSearch(query);
        }, 300);
        
        this.elements.searchInput?.addEventListener('input', (e) => {
          debouncedSearch(e.target.value);
        });
        
        // Filtros
        this.elements.filterArea?.addEventListener('change', (e) => {
          this.handleFilterChange('area', e.target.value);
        });
        
        this.elements.filterEquipo?.addEventListener('change', (e) => {
          this.handleFilterChange('equipo', e.target.value);
        });
        
        this.elements.filterEstado?.addEventListener('change', (e) => {
          this.handleFilterChange('estado', e.target.value);
        });
        
        // Botones
        this.elements.btnAgregar?.addEventListener('click', () => {
          this.openAddModal();
        });
        
        this.elements.btnConectar?.addEventListener('click', () => {
          this.connectFileSystem();
        });
        
        // Modal
        this.elements.modalClose?.addEventListener('click', () => {
          this.closeModal();
        });
        
        // Cerrar modal al hacer click fuera
        this.elements.modal?.addEventListener('click', (e) => {
          if (e.target === this.elements.modal) {
            this.closeModal();
          }
        });
      }

      subscribeToEvents() {
        // Suscribirse a eventos del sistema
        eventBus.on(Events.REPUESTOS_LOADED, (repuestos) => {
          console.log('ğŸ“¦ Repuestos cargados:', repuestos.length);
          this.renderCards();
        });
        
        eventBus.on(Events.FILTERS_CHANGED, (filters) => {
          console.log('ğŸ” Filtros actualizados:', filters);
          this.applyFilters();
        });
        
        eventBus.on(Events.STORAGE_CONNECTED, () => {
          this.updateConnectionStatus(true);
        });
        
        eventBus.on(Events.STORAGE_DISCONNECTED, () => {
          this.updateConnectionStatus(false);
        });
        
        // Suscribirse a cambios de estado
        stateManager.subscribe((state, prevState, changedKeys) => {
          if (changedKeys.includes('repuestos')) {
            this.renderCards();
          }
        });
      }

      loadSavedState() {
        // Intentar restaurar estado desde localStorage
        const restored = stateManager.restore('inventarioState');
        if (restored) {
          console.log('ğŸ’¾ Estado restaurado desde localStorage');
        }
      }

      detectDevice() {
        const mobile = isMobile();
        stateManager.setState({ 
          isMobile: mobile,
          viewMode: mobile ? 'mobile' : 'desktop'
        });
        
        if (mobile) {
          document.body.classList.add('mobile-device');
        }
      }

      async restoreFileSystemSession() {
        // Esta funcionalidad se implementarÃ¡ cuando migremos el mÃ³dulo storage.js
        console.log('ğŸ”Œ Intentando restaurar sesiÃ³n FileSystem...');
        // TODO: Implementar con fsManager
      }

      switchTab(tabName) {
        // Desactivar todas las pestaÃ±as
        this.elements.navTabs.forEach(tab => tab.classList.remove('active'));
        this.elements.tabContents.forEach(content => content.classList.remove('active'));
        
        // Activar pestaÃ±a seleccionada
        const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
        const selectedContent = document.getElementById(`${tabName}Tab`);
        
        selectedTab?.classList.add('active');
        selectedContent?.classList.add('active');
        
        // Actualizar estado
        stateManager.setState({ currentTab: tabName });
        
        // Emitir evento
        eventBus.emit(Events.TAB_CHANGED, tabName);
      }

      handleSearch(query) {
        stateManager.setState({
          filters: {
            ...stateManager.getState('filters'),
            search: query
          }
        });
      }

      handleFilterChange(filterType, value) {
        stateManager.setState({
          filters: {
            ...stateManager.getState('filters'),
            [filterType]: value
          }
        });
      }

      applyFilters() {
        const { repuestos, filters } = stateManager.getState();
        
        let filtered = [...repuestos];
        
        // Aplicar bÃºsqueda
        if (filters.search) {
          filtered = search(filtered, filters.search, ['nombre', 'codSAP', 'area', 'equipo']);
        }
        
        // Aplicar filtro de Ã¡rea
        if (filters.area) {
          filtered = filtered.filter(r => r.area === filters.area);
        }
        
        // Aplicar filtro de equipo
        if (filters.equipo) {
          filtered = filtered.filter(r => r.equipo === filters.equipo);
        }
        
        // Aplicar filtro de estado
        if (filters.estado && filters.estado !== 'todos') {
          filtered = filtered.filter(r => {
            const status = formatStockStatus(r.cantidad, r.minimo);
            if (filters.estado === 'ok') return status.color === 'green';
            if (filters.estado === 'bajo') return status.color === 'yellow';
            if (filters.estado === 'sin') return status.color === 'red';
            return true;
          });
        }
        
        stateManager.setState({ filteredRepuestos: filtered });
      }

      renderCards() {
        const { filteredRepuestos, currentPage, itemsPerPage } = stateManager.getState();
        
        if (!this.elements.cardsGrid) return;
        
        // Paginar
        const perPage = itemsPerPage === 'auto' ? 21 : itemsPerPage;
        const paginated = paginate(filteredRepuestos, currentPage, perPage);
        
        // Limpiar grid
        this.elements.cardsGrid.innerHTML = '';
        
        // Renderizar tarjetas
        if (paginated.data.length === 0) {
          this.elements.cardsGrid.innerHTML = `
            <div class="empty-state">
              <p>ğŸ“¦ No se encontraron repuestos</p>
            </div>
          `;
          return;
        }
        
        paginated.data.forEach(repuesto => {
          const card = this.createCard(repuesto);
          this.elements.cardsGrid.appendChild(card);
        });
        
        // Renderizar paginaciÃ³n
        this.renderPagination(paginated);
      }

      createCard(repuesto) {
        const card = document.createElement('div');
        card.className = 'repuesto-card';
        
        const status = formatStockStatus(repuesto.cantidad, repuesto.minimo);
        
        card.innerHTML = `
          <div class="card-image" style="background: #1e293b;">
            ${repuesto.multimedia && repuesto.multimedia.length > 0 
              ? `<img src="${repuesto.multimedia[0]}" alt="${repuesto.nombre}" loading="lazy">` 
              : '<div class="no-image">ğŸ“¦ Sin imagen</div>'}
          </div>
          <div class="card-content">
            <h3>${repuesto.nombre}</h3>
            <p class="text-muted">SAP: ${repuesto.codSAP}</p>
            <div class="info-row">
              <span>ğŸ“ ${repuesto.area}</span>
              <span>âš™ï¸ ${repuesto.equipo}</span>
            </div>
            <div class="info-row">
              <span class="stock-status status-${status.color}">
                ${status.icon} ${status.text}
              </span>
              <span><strong>${repuesto.cantidad || 0}</strong> / min: ${repuesto.minimo || 0}</span>
            </div>
            ${repuesto.precio ? `<p class="precio">${formatCurrency(repuesto.precio)}</p>` : ''}
          </div>
          <div class="card-footer">
            <button class="btn btn-sm btn-primary" onclick="app.editRepuesto('${repuesto.id}')">
              âœï¸ Editar
            </button>
            <button class="btn btn-sm btn-danger" onclick="app.deleteRepuesto('${repuesto.id}')">
              ğŸ—‘ï¸ Eliminar
            </button>
          </div>
        `;
        
        return card;
      }

      renderPagination(paginationData) {
        if (!this.elements.pagination) return;
        
        const { page, totalPages, hasNext, hasPrev } = paginationData;
        
        this.elements.pagination.innerHTML = `
          <button 
            class="btn btn-secondary" 
            ${!hasPrev ? 'disabled' : ''}
            onclick="app.changePage(${page - 1})">
            â† Anterior
          </button>
          <span>PÃ¡gina ${page} de ${totalPages}</span>
          <button 
            class="btn btn-secondary" 
            ${!hasNext ? 'disabled' : ''}
            onclick="app.changePage(${page + 1})">
            Siguiente â†’
          </button>
        `;
      }

      changePage(page) {
        stateManager.setState({ currentPage: page });
        this.renderCards();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      openAddModal() {
        this.showToast('Funcionalidad de agregar prÃ³ximamente', 'info');
      }

      editRepuesto(id) {
        this.showToast(`Editar repuesto ${id} - PrÃ³ximamente`, 'info');
      }

      deleteRepuesto(id) {
        this.showToast(`Eliminar repuesto ${id} - PrÃ³ximamente`, 'info');
      }

      async connectFileSystem() {
        try {
          this.showToast('Conectando con FileSystem API...', 'info');
          // TODO: Implementar con fsManager cuando se migre
          
          // Por ahora, simular conexiÃ³n
          setTimeout(() => {
            this.updateConnectionStatus(true);
            this.showToast('âœ… Conectado correctamente', 'success');
            eventBus.emit(Events.STORAGE_CONNECTED);
            
            // Cargar datos de prueba
            this.loadMockData();
          }, 1000);
          
        } catch (error) {
          handleError(error, {
            customMessage: 'Error al conectar con el sistema de archivos'
          });
        }
      }

      loadMockData() {
        // Datos de prueba para demostraciÃ³n
        const mockRepuestos = [
          {
            id: '1',
            nombre: 'Rodamiento SKF 6205',
            codSAP: 'RDM-001',
            area: 'Planta 1',
            equipo: 'Grader',
            tipo: 'Rodamiento',
            cantidad: 5,
            minimo: 10,
            precio: 15000,
            multimedia: []
          },
          {
            id: '2',
            nombre: 'Filtro de Aire',
            codSAP: 'FLT-002',
            area: 'Planta 2',
            equipo: 'Compresor',
            tipo: 'Filtro',
            cantidad: 0,
            minimo: 5,
            precio: 8500,
            multimedia: []
          },
          {
            id: '3',
            nombre: 'Correa Transportadora',
            codSAP: 'CRT-003',
            area: 'Planta 1',
            equipo: 'Transportador',
            tipo: 'Correa',
            cantidad: 15,
            minimo: 5,
            precio: 45000,
            multimedia: []
          }
        ];
        
        stateManager.setState({ 
          repuestos: mockRepuestos,
          filteredRepuestos: mockRepuestos
        });
        
        eventBus.emit(Events.REPUESTOS_LOADED, mockRepuestos);
      }

      updateConnectionStatus(connected) {
        if (!this.elements.connectionIcon || !this.elements.connectionText) return;
        
        if (connected) {
          this.elements.connectionIcon.textContent = 'âœ…';
          this.elements.connectionText.textContent = 'Conectado';
          this.elements.connectionStatus?.classList.add('connected');
        } else {
          this.elements.connectionIcon.textContent = 'ğŸ”Œ';
          this.elements.connectionText.textContent = 'Desconectado';
          this.elements.connectionStatus?.classList.remove('connected');
        }
      }

      openModal(title, content) {
        if (!this.elements.modal) return;
        
        this.elements.modalTitle.textContent = title;
        this.elements.modalBody.innerHTML = content;
        this.elements.modal.style.display = 'flex';
        
        eventBus.emit(Events.MODAL_OPENED, title);
      }

      closeModal() {
        if (!this.elements.modal) return;
        
        this.elements.modal.style.display = 'none';
        eventBus.emit(Events.MODAL_CLOSED);
      }

      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        
        this.elements.toastContainer?.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 5000);
      }

      showLoading(show = true) {
        if (this.elements.loadingSpinner) {
          this.elements.loadingSpinner.style.display = show ? 'flex' : 'none';
        }
      }
    }

    // ============================================
    // INICIAR APLICACIÃ“N
    // ============================================
    
    const app = new InventarioApp();
    
    // Exponer app globalmente para debugging
    window.app = app;
    
    // Iniciar cuando el DOM estÃ© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => app.init());
    } else {
      app.init();
    }

    // Log de bienvenida
    console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘   ğŸ“¦ INVENTARIO VISUAL PRO v6.0                             â•‘
â•‘   Arquitectura Modular Portable                             â•‘
â•‘                                                              â•‘
â•‘   âœ… ES6 Modules                                            â•‘
â•‘   âœ… Sin dependencias externas                              â•‘
â•‘   âœ… 100% Offline                                           â•‘
â•‘   âœ… ValidaciÃ³n robusta                                     â•‘
â•‘   âœ… Manejo de errores                                      â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `);
  </script>

  <!-- Service Worker para PWA (opcional) -->
  <script>
    if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('âœ… Service Worker registrado:', reg.scope))
          .catch(err => console.log('âŒ Service Worker error:', err));
      });
    }
  </script>
</body>
</html>
